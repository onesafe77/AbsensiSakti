{"file_contents":{"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/pages/driver-view.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Activity, User, Calendar, Clock, MapPin, Shield, AlertTriangle, Loader2, Bell, ChevronLeft, ChevronRight as ChevronRightIcon, Share2, RefreshCw, Edit, Megaphone, Eye, Image as ImageIcon } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\n\ninterface Employee {\n  id: string;\n  name: string;\n  position: string;\n  department: string;\n  investorGroup: string;\n  phone: string;\n}\n\ninterface RosterSchedule {\n  id: string;\n  employeeId: string;\n  date: string;\n  shift: string;\n  startTime: string;\n  endTime: string;\n  jamTidur: string;\n  fitToWork: string;\n  status: string;\n}\n\ninterface LeaveRequest {\n  id: string;\n  employeeId: string;\n  employeeName: string;\n  startDate: string;\n  endDate: string;\n  leaveType: string;\n  reason: string;\n  status: string;\n  createdAt: string;\n}\n\ninterface SimperMonitoring {\n  id: string;\n  employeeName: string;\n  nik: string;\n  simperBibExpiredDate: string | null;\n  simperTiaExpiredDate: string | null;\n  bibMonitoringDays?: number | null;\n  tiaMonitoringDays?: number | null;\n  bibStatus?: string;\n  tiaStatus?: string;\n}\n\ninterface Announcement {\n  id: string;\n  title: string;\n  content: string;\n  imageUrls?: string[] | null;\n  isActive: boolean;\n  createdBy: string;\n  createdByName: string;\n  createdAt: string;\n  isRead?: boolean;\n}\n\nexport default function DriverView() {\n  const [nik, setNik] = useState(\"\");\n  const [debouncedNik, setDebouncedNik] = useState(\"\");\n  const [searchEmployee, setSearchEmployee] = useState<Employee | null>(null);\n  const [suggestions, setSuggestions] = useState<Employee[]>([]);\n  const [activeTab, setActiveTab] = useState<'roster' | 'leave' | 'pemberitahuan' | 'simper'>('roster');\n  const [isSearching, setIsSearching] = useState(false);\n  \n  // Roster filter states\n  const [selectedMonth, setSelectedMonth] = useState<string>(\"all\");\n  const [selectedYear, setSelectedYear] = useState<string>(\"2025\");\n  const [selectedShift, setSelectedShift] = useState<string>(\"all\");\n  \n  // State untuk dialog pengumuman\n  const [selectedAnnouncement, setSelectedAnnouncement] = useState<Announcement | null>(null);\n  const [announcementDialogOpen, setAnnouncementDialogOpen] = useState(false);\n\n  // Query untuk mencari employee berdasarkan NIK - OPTIMIZED\n  const { data: employees, isLoading: employeesLoading } = useQuery({\n    queryKey: [\"/api/employees\"],\n    enabled: true,\n    staleTime: 10 * 60 * 1000, // 10 minutes cache - employees data doesn't change often\n  });\n\n  // Query untuk roster berdasarkan employee yang dipilih - LAZY LOADING\n  const { data: rosterData, isLoading: rosterLoading } = useQuery({\n    queryKey: [\"/api/roster\", { employeeId: searchEmployee?.id }],\n    queryFn: async () => {\n      if (!searchEmployee?.id) return [];\n      const response = await fetch(`/api/roster?employeeId=${searchEmployee.id}`);\n      if (!response.ok) throw new Error('Failed to fetch roster');\n      return response.json();\n    },\n    enabled: !!searchEmployee && activeTab === 'roster', // Only load when roster tab active\n    staleTime: 5 * 60 * 1000, // 5 minutes cache\n  });\n\n  // Query untuk leave requests berdasarkan employee yang dipilih - LAZY LOADING\n  const { data: leaveData, isLoading: leaveLoading } = useQuery({\n    queryKey: [\"/api/leave\"],\n    enabled: !!searchEmployee && activeTab === 'leave', // Only load when leave tab active\n    staleTime: 3 * 60 * 1000, // 3 minutes cache\n  });\n\n  // Query untuk SIMPER monitoring berdasarkan employee yang dipilih - LAZY LOADING\n  const { data: simperData, isLoading: simperLoading } = useQuery({\n    queryKey: [\"/api/simper-monitoring/nik\", searchEmployee?.id],\n    queryFn: async () => {\n      if (!searchEmployee?.id) return null;\n      const response = await fetch(`/api/simper-monitoring/nik/${searchEmployee.id}`);\n      if (!response.ok) {\n        if (response.status === 404) return null;\n        throw new Error('Failed to fetch SIMPER data');\n      }\n      const data = await response.json();\n      \n      // Calculate monitoring days and status\n      const today = new Date();\n      const processSIMPER = (expiredDate: string | null) => {\n        if (!expiredDate) return { days: null, status: 'Tidak Ada Data' };\n        \n        const expired = new Date(expiredDate);\n        const diffTime = expired.getTime() - today.getTime();\n        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n        \n        if (diffDays < 0) return { days: diffDays, status: 'Segera Perpanjang' };\n        if (diffDays < 7) return { days: diffDays, status: 'Mendekati Perpanjangan' };\n        if (diffDays < 30) return { days: diffDays, status: 'Menuju Perpanjangan' };\n        return { days: diffDays, status: 'Aktif' };\n      };\n\n      const bibStatus = processSIMPER(data.simperBibExpiredDate);\n      const tiaStatus = processSIMPER(data.simperTiaExpiredDate);\n\n      return {\n        ...data,\n        bibMonitoringDays: bibStatus.days,\n        bibStatus: bibStatus.status,\n        tiaMonitoringDays: tiaStatus.days,\n        tiaStatus: tiaStatus.status\n      };\n    },\n    enabled: !!searchEmployee && activeTab === 'simper', // Only load when SIMPER tab active\n    staleTime: 5 * 60 * 1000, // 5 minutes cache\n  });\n\n  // Query untuk pengumuman aktif dengan status baca\n  const { data: announcements = [], isLoading: announcementsLoading } = useQuery<Announcement[]>({\n    queryKey: [\"/api/announcements/active-with-status\", searchEmployee?.id],\n    queryFn: async () => {\n      if (!searchEmployee?.id) return [];\n      const response = await fetch(`/api/announcements/active-with-status/${searchEmployee.id}`);\n      if (!response.ok) throw new Error('Failed to fetch announcements');\n      return response.json();\n    },\n    enabled: !!searchEmployee && activeTab === 'pemberitahuan',\n    staleTime: 1 * 60 * 1000,\n  });\n\n  // Query untuk unread count\n  const { data: unreadCountData } = useQuery<{count: number}>({\n    queryKey: [\"/api/announcements/unread-count\", searchEmployee?.id],\n    queryFn: async () => {\n      if (!searchEmployee?.id) return { count: 0 };\n      const response = await fetch(`/api/announcements/unread-count/${searchEmployee.id}`);\n      if (!response.ok) throw new Error('Failed to fetch unread count');\n      return response.json();\n    },\n    enabled: !!searchEmployee,\n    staleTime: 30 * 1000,\n  });\n\n  const unreadCount = unreadCountData?.count || 0;\n\n  // Mutation untuk mark announcement as read\n  const markAsReadMutation = useMutation({\n    mutationFn: async ({ announcementId }: { announcementId: string }) => {\n      if (!searchEmployee?.id || !searchEmployee?.name) {\n        throw new Error(\"Employee data not found\");\n      }\n      return apiRequest(`/api/announcements/${announcementId}/read`, 'POST', {\n        employeeId: searchEmployee.id,\n        employeeName: searchEmployee.name\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/announcements/unread-count\", searchEmployee?.id] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/announcements/active-with-status\", searchEmployee?.id] });\n    }\n  });\n\n  // Debounced search effect\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedNik(nik);\n    }, 300); // 300ms debounce\n\n    return () => clearTimeout(timer);\n  }, [nik]);\n\n  // Auto-populate NIK dari URL parameter (untuk QR scan redirect)\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const scannedNik = urlParams.get('nik');\n    \n    if (scannedNik && employees && Array.isArray(employees) && employees.length > 0) {\n      setNik(scannedNik);\n      // Jangan hapus URL parameter agar stabil untuk mobile scanning\n      // Biarkan parameter NIK tetap di URL untuk stabilitas\n    }\n  }, [employees]);\n\n  // Auto search when debounced value changes\n  useEffect(() => {\n    if (debouncedNik.trim() && employees) {\n      handleSearch();\n    } else {\n      setSuggestions([]);\n      setSearchEmployee(null);\n    }\n  }, [debouncedNik, employees]);\n\n  const handleSearch = useCallback(() => {\n    if (!debouncedNik.trim()) return;\n    \n    setIsSearching(true);\n    const employeeList = employees as Employee[] || [];\n    const searchTerm = debouncedNik.trim().toLowerCase();\n    \n    const employee = employeeList.find((emp: Employee) => {\n      // Cari berdasarkan NIK (exact match)\n      if (emp.id.toLowerCase() === searchTerm) return true;\n      \n      // Cari berdasarkan nama (partial match)\n      if (emp.name.toLowerCase().includes(searchTerm)) return true;\n      \n      // Cari berdasarkan posisi jika ada\n      if (emp.position && emp.position.toLowerCase().includes(searchTerm)) return true;\n      \n      return false;\n    });\n    \n    // Generate suggestions for partial matches\n    if (!employee && searchTerm.length > 2) {\n      const matchedEmployees = employeeList.filter((emp: Employee) => {\n        return emp.name.toLowerCase().includes(searchTerm) ||\n               emp.id.toLowerCase().includes(searchTerm) ||\n               (emp.position && emp.position.toLowerCase().includes(searchTerm));\n      }).slice(0, 5);\n      setSuggestions(matchedEmployees);\n    } else {\n      setSuggestions([]);\n    }\n    \n    setSearchEmployee(employee || null);\n    setIsSearching(false);\n  }, [debouncedNik, employees]);\n\n  const employeeRoster = (rosterData as RosterSchedule[]) || [];\n\n  const leaveList = leaveData as LeaveRequest[] || [];\n  const employeeLeaves = leaveList.filter((leave: LeaveRequest) => \n    leave.employeeId === searchEmployee?.id\n  );\n\n  const getShiftBadgeColor = (shift: string) => {\n    return shift === \"Shift 1\" ? \"bg-blue-500\" : \"bg-orange-500\";\n  };\n\n  const getStatusBadgeColor = (status: string) => {\n    switch (status) {\n      case \"present\": return \"bg-green-500\";\n      case \"scheduled\": return \"bg-blue-500\";\n      case \"pending\": return \"bg-yellow-500\";\n      case \"approved\": return \"bg-green-500\";\n      case \"rejected\": return \"bg-red-500\";\n      default: return \"bg-gray-500\";\n    }\n  };\n\n  const getSimperStatusColor = (status: string) => {\n    switch (status) {\n      case 'Segera Perpanjang':\n        return 'bg-red-100 text-red-800';\n      case 'Mendekati Perpanjangan':\n        return 'bg-yellow-100 text-yellow-800';\n      case 'Menuju Perpanjangan':\n        return 'bg-orange-100 text-orange-800';\n      case 'Aktif':\n        return 'bg-green-100 text-green-800';\n      default:\n        return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const formatDateDD_MM_YYYY = (dateString: string | null) => {\n    if (!dateString) return '-';\n    const date = new Date(dateString);\n    const day = date.getDate().toString().padStart(2, '0');\n    const month = (date.getMonth() + 1).toString().padStart(2, '0');\n    const year = date.getFullYear();\n    return `${day}-${month}-${year}`;\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n      {/* Red Header Bar */}\n      <div className=\"bg-gradient-to-r from-[#E53935] to-red-600 text-white py-6 px-4 shadow-lg\">\n        <div className=\"max-w-4xl mx-auto text-center\">\n          <div className=\"flex items-center justify-center gap-2 mb-2\">\n            <Activity className=\"h-6 w-6\" />\n            <h1 className=\"text-2xl font-bold\">Driver View</h1>\n          </div>\n          <p className=\"text-red-100 text-sm\">Employee Data & Monitoring System</p>\n        </div>\n      </div>\n\n      <div className=\"max-w-4xl mx-auto px-4 py-6 space-y-4\">\n        {/* Loading State untuk employees */}\n        {employeesLoading && (\n          <Card className=\"shadow-lg\">\n            <CardContent className=\"p-8\">\n              <div className=\"flex flex-col items-center space-y-4\">\n                <div className=\"animate-spin rounded-full h-12 w-12 border-b-4 border-[#E53935]\"></div>\n                <p className=\"text-gray-600 dark:text-gray-300 font-semibold\">Loading employee data...</p>\n                <p className=\"text-gray-400 text-sm\">Memuat data karyawan dari server...</p>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Search Section - Simplified */}\n        {!employeesLoading && (\n          <Card className=\"shadow-md\">\n            <CardContent className=\"p-4\">\n              <p className=\"text-sm text-gray-600 dark:text-gray-400 mb-3\">melihat data lengkap</p>\n              <div className=\"relative\">\n                <Input\n                  placeholder=\"C-041687\"\n                  value={nik}\n                  onChange={(e) => setNik(e.target.value)}\n                  data-testid=\"input-nik-search\"\n                  className=\"text-base\"\n                />\n                {isSearching && (\n                  <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                    <Loader2 className=\"h-4 w-4 animate-spin text-gray-500\" />\n                  </div>\n                )}\n                \n                {/* Suggestions dropdown */}\n                {suggestions.length > 0 && (\n                  <div className=\"absolute top-full left-0 right-0 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg z-10 mt-1\">\n                    {suggestions.map((emp) => (\n                      <div\n                        key={emp.id}\n                        className=\"px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-b-0\"\n                        onClick={() => {\n                          setNik(emp.name);\n                          setSearchEmployee(emp);\n                          setSuggestions([]);\n                        }}\n                      >\n                        <div className=\"font-medium\">{emp.name}</div>\n                        <div className=\"text-sm text-gray-600 dark:text-gray-400\">\n                          NIK: {emp.id} | {emp.position} | {emp.department}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n              \n              {nik && !searchEmployee && (\n                <div className=\"text-red-500 text-sm mt-2\">\n                  <p>Karyawan dengan kata kunci \"{nik}\" tidak ditemukan</p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Employee Info Card - New Mobile Design */}\n        {searchEmployee && (\n          <>\n            <Card className=\"shadow-md bg-white dark:bg-gray-800\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-start gap-4\">\n                  {/* Blue Circular Avatar */}\n                  <Avatar className=\"h-14 w-14 bg-blue-500\">\n                    <AvatarFallback className=\"bg-blue-500 text-white text-lg font-bold\">\n                      <User className=\"h-6 w-6\" />\n                    </AvatarFallback>\n                  </Avatar>\n                  \n                  {/* Employee Info */}\n                  <div className=\"flex-1\">\n                    <h2 className=\"text-xl font-bold text-gray-900 dark:text-white mb-1\">\n                      {searchEmployee.name}\n                    </h2>\n                    <p className=\"text-blue-600 dark:text-blue-400 font-semibold text-sm mb-4\">\n                      NIK: {searchEmployee.id}\n                    </p>\n                    \n                    {/* Info Grid */}\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <p className=\"text-xs text-gray-500 dark:text-gray-400 uppercase mb-1\">POSISI</p>\n                        <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">{searchEmployee.position}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-xs text-gray-500 dark:text-gray-400 uppercase mb-1\">DEPARTMENT</p>\n                        <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">{searchEmployee.department}</p>\n                      </div>\n                      <div className=\"col-span-2\">\n                        <p className=\"text-xs text-gray-500 dark:text-gray-400 uppercase mb-1\">INVESTOR GROUP</p>\n                        <p className=\"text-sm font-semibold text-gray-900 dark:text-white\">{searchEmployee.investorGroup}</p>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Horizontal Scrollable Pill Tabs */}\n            <div className=\"flex gap-3 overflow-x-auto pb-2 px-1 scrollbar-hide\">\n              <Button\n                variant={activeTab === 'roster' ? \"default\" : \"outline\"}\n                onClick={() => setActiveTab('roster')}\n                className={`flex-none rounded-full px-6 py-2 text-sm font-semibold transition-all duration-200 ${\n                  activeTab === 'roster'\n                    ? 'bg-green-600 hover:bg-green-700 text-white border-green-600'\n                    : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700'\n                }`}\n                data-testid=\"tab-roster\"\n              >\n                <Calendar className=\"h-4 w-4 mr-2\" />\n                Roster\n              </Button>\n              <Button\n                variant={activeTab === 'leave' ? \"default\" : \"outline\"}\n                onClick={() => setActiveTab('leave')}\n                className={`flex-none rounded-full px-6 py-2 text-sm font-semibold transition-all duration-200 ${\n                  activeTab === 'leave'\n                    ? 'bg-green-600 hover:bg-green-700 text-white border-green-600'\n                    : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700'\n                }`}\n                data-testid=\"tab-leave\"\n              >\n                <MapPin className=\"h-4 w-4 mr-2\" />\n                Cuti\n              </Button>\n              <Button\n                variant={activeTab === 'pemberitahuan' ? \"default\" : \"outline\"}\n                onClick={() => setActiveTab('pemberitahuan')}\n                className={`flex-none rounded-full px-6 py-2 text-sm font-semibold transition-all duration-200 relative ${\n                  activeTab === 'pemberitahuan'\n                    ? 'bg-purple-600 hover:bg-purple-700 text-white border-purple-600'\n                    : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700'\n                }`}\n                data-testid=\"tab-pemberitahuan\"\n              >\n                <Megaphone className=\"h-4 w-4 mr-2\" />\n                Pemberitahuan\n                {unreadCount > 0 && (\n                  <Badge className=\"absolute -top-2 -right-2 bg-red-500 text-white text-xs px-1.5 py-0.5 min-w-[20px] h-5 flex items-center justify-center rounded-full\">\n                    {unreadCount > 9 ? '9+' : unreadCount}\n                  </Badge>\n                )}\n              </Button>\n              <Button\n                variant={activeTab === 'simper' ? \"default\" : \"outline\"}\n                onClick={() => setActiveTab('simper')}\n                className={`flex-none rounded-full px-6 py-2 text-sm font-semibold transition-all duration-200 ${\n                  activeTab === 'simper'\n                    ? 'bg-green-600 hover:bg-green-700 text-white border-green-600'\n                    : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700'\n                }`}\n                data-testid=\"tab-simper\"\n              >\n                <Shield className=\"h-4 w-4 mr-2\" />\n                SIMPER\n              </Button>\n            </div>\n\n            {/* Tab Content - Mobile Optimized */}\n            <div className=\"mt-4\">\n            {/* Roster Tab */}\n            {activeTab === 'roster' && (\n              <div className=\"space-y-4\">\n                {/* Section Header with Green Icon */}\n                <Card className=\"bg-white dark:bg-gray-800 shadow-md\">\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center gap-3 mb-2\">\n                      <div className=\"bg-green-500 rounded-lg p-2\">\n                        <Calendar className=\"h-5 w-5 text-white\" />\n                      </div>\n                      <h3 className=\"text-lg font-bold text-gray-900 dark:text-white\">Jadwal Roster Kerja</h3>\n                    </div>\n                    <p className=\"text-sm text-green-600 dark:text-green-400 font-medium\">\n                      Daftar jadwal kerja untuk {searchEmployee?.name}\n                    </p>\n                  </CardContent>\n                </Card>\n\n                {rosterLoading ? (\n                  <div className=\"flex flex-col items-center justify-center py-16\">\n                    <div className=\"animate-spin rounded-full h-12 w-12 border-b-4 border-[#E53935] mb-4\"></div>\n                    <p className=\"text-gray-600 dark:text-gray-300 font-semibold\">Memuat data roster...</p>\n                  </div>\n                ) : employeeRoster.length > 0 ? (\n                  <>\n                    {/* Filter Controls */}\n                    <Card className=\"bg-white dark:bg-gray-800 shadow-md\">\n                      <CardContent className=\"p-4 space-y-4\">\n                        {/* Month and Year Selectors */}\n                        <div className=\"flex gap-3\">\n                          <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                            <SelectTrigger className=\"flex-1\">\n                              <SelectValue placeholder=\"Semua Bulan\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"all\">Semua Bulan</SelectItem>\n                              <SelectItem value=\"1\">Januari</SelectItem>\n                              <SelectItem value=\"2\">Februari</SelectItem>\n                              <SelectItem value=\"3\">Maret</SelectItem>\n                              <SelectItem value=\"4\">April</SelectItem>\n                              <SelectItem value=\"5\">Mei</SelectItem>\n                              <SelectItem value=\"6\">Juni</SelectItem>\n                              <SelectItem value=\"7\">Juli</SelectItem>\n                              <SelectItem value=\"8\">Agustus</SelectItem>\n                              <SelectItem value=\"9\">September</SelectItem>\n                              <SelectItem value=\"10\">Oktober</SelectItem>\n                              <SelectItem value=\"11\">November</SelectItem>\n                              <SelectItem value=\"12\">Desember</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <Select value={selectedYear} onValueChange={setSelectedYear}>\n                            <SelectTrigger className=\"w-32\">\n                              <SelectValue placeholder=\"2025\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"2024\">2024</SelectItem>\n                              <SelectItem value=\"2025\">2025</SelectItem>\n                              <SelectItem value=\"2026\">2026</SelectItem>\n                            </SelectContent>\n                          </Select>\n                        </div>\n\n                        {/* Shift Filter Pills */}\n                        <div className=\"flex gap-2 overflow-x-auto pb-2 scrollbar-hide\">\n                          <Button\n                            variant={selectedShift === 'all' ? 'default' : 'outline'}\n                            onClick={() => setSelectedShift('all')}\n                            className={`flex-none rounded-full px-4 py-2 text-sm font-semibold ${\n                              selectedShift === 'all'\n                                ? 'bg-green-600 hover:bg-green-700 text-white'\n                                : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'\n                            }`}\n                          >\n                            Semua Shift\n                          </Button>\n                          <Button\n                            variant={selectedShift === 'Shift 1' ? 'default' : 'outline'}\n                            onClick={() => setSelectedShift('Shift 1')}\n                            className={`flex-none rounded-full px-4 py-2 text-sm font-semibold ${\n                              selectedShift === 'Shift 1'\n                                ? 'bg-green-600 hover:bg-green-700 text-white'\n                                : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'\n                            }`}\n                          >\n                            Shift 1\n                          </Button>\n                          <Button\n                            variant={selectedShift === 'Shift 2' ? 'default' : 'outline'}\n                            onClick={() => setSelectedShift('Shift 2')}\n                            className={`flex-none rounded-full px-4 py-2 text-sm font-semibold ${\n                              selectedShift === 'Shift 2'\n                                ? 'bg-green-600 hover:bg-green-700 text-white'\n                                : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'\n                            }`}\n                          >\n                            Shift 2\n                          </Button>\n                          <Button\n                            variant={selectedShift === 'Overshift' ? 'default' : 'outline'}\n                            onClick={() => setSelectedShift('Overshift')}\n                            className={`flex-none rounded-full px-4 py-2 text-sm font-semibold ${\n                              selectedShift === 'Overshift'\n                                ? 'bg-green-600 hover:bg-green-700 text-white'\n                                : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'\n                            }`}\n                          >\n                            Overshift\n                          </Button>\n                          <Button\n                            variant={selectedShift === 'Cuti' ? 'default' : 'outline'}\n                            onClick={() => setSelectedShift('Cuti')}\n                            className={`flex-none rounded-full px-4 py-2 text-sm font-semibold ${\n                              selectedShift === 'Cuti'\n                                ? 'bg-green-600 hover:bg-green-700 text-white'\n                                : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300'\n                            }`}\n                          >\n                            Cuti\n                          </Button>\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    {/* Vertical Roster List */}\n                    {(() => {\n                      // Filter roster data\n                      const filteredRoster = employeeRoster\n                        .filter((roster: RosterSchedule) => {\n                          const rosterDate = new Date(roster.date);\n                          const month = (rosterDate.getMonth() + 1).toString();\n                          const year = rosterDate.getFullYear().toString();\n                          \n                          const monthMatch = selectedMonth === 'all' || month === selectedMonth;\n                          const yearMatch = year === selectedYear;\n                          \n                          // Smart shift filtering: normalize and match shift values\n                          let shiftMatch = false;\n                          if (selectedShift === 'all') {\n                            shiftMatch = true;\n                          } else {\n                            // Normalize both selected filter and roster shift for comparison\n                            const normalizeShift = (shift: string) => shift.toUpperCase().replace(/\\s+/g, ' ').trim();\n                            const normalizedRosterShift = normalizeShift(roster.shift || '');\n                            const normalizedSelectedShift = normalizeShift(selectedShift);\n                            \n                            // Handle different shift formats:\n                            // \"Shift 1\" matches \"SHIFT 1\"\n                            // \"Shift 2\" matches \"SHIFT 2\"\n                            // \"Overshift\" matches \"OVER SHIFT\"\n                            // \"Cuti\" matches \"CUTI\"\n                            if (normalizedSelectedShift === 'OVERSHIFT' || normalizedSelectedShift === 'OVER SHIFT') {\n                              shiftMatch = normalizedRosterShift === 'OVER SHIFT' || normalizedRosterShift === 'OVERSHIFT';\n                            } else {\n                              shiftMatch = normalizedRosterShift === normalizedSelectedShift;\n                            }\n                          }\n                          \n                          return monthMatch && yearMatch && shiftMatch;\n                        })\n                        .sort((a: RosterSchedule, b: RosterSchedule) => \n                          new Date(b.date).getTime() - new Date(a.date).getTime()\n                        );\n\n                      if (filteredRoster.length === 0) {\n                        return (\n                          <div className=\"text-center py-16\">\n                            <Calendar className=\"h-20 w-20 text-gray-300 mx-auto mb-4\" />\n                            <p className=\"text-xl text-gray-500 font-semibold\">Tidak ada jadwal ditemukan</p>\n                            <p className=\"text-gray-400 mt-2\">Tidak ada data roster untuk filter yang dipilih</p>\n                          </div>\n                        );\n                      }\n\n                      return (\n                        <div className=\"space-y-3\">\n                          {filteredRoster.map((roster: RosterSchedule) => {\n                            const isToday = roster.date === format(new Date(), 'yyyy-MM-dd');\n                            \n                            return (\n                              <Card \n                                key={roster.id} \n                                className={`${\n                                  isToday \n                                    ? 'bg-green-50 dark:bg-green-900/20 border-green-500 border-2' \n                                    : 'bg-white dark:bg-gray-800'\n                                } shadow-md`}\n                                data-testid={`roster-card-${roster.id}`}\n                              >\n                                <CardContent className=\"p-4\">\n                                  <div className=\"flex items-start justify-between mb-3\">\n                                    <div className=\"flex-1\">\n                                      <h4 className=\"text-xl font-bold text-gray-900 dark:text-white mb-2\">\n                                        {format(new Date(roster.date), \"dd MMM yyyy\")}\n                                        {isToday && (\n                                          <Badge className=\"ml-2 bg-green-600 text-white text-xs px-2 py-0.5\">\n                                            Hari Ini\n                                          </Badge>\n                                        )}\n                                      </h4>\n                                      <div className=\"flex gap-2 flex-wrap\">\n                                        <Badge \n                                          className={`${\n                                            roster.shift.toUpperCase().includes('SHIFT 2') \n                                              ? 'bg-orange-500' \n                                              : roster.shift.toUpperCase().includes('OVER')\n                                              ? 'bg-purple-500'\n                                              : roster.shift.toUpperCase().includes('CUTI')\n                                              ? 'bg-yellow-500'\n                                              : 'bg-blue-500'\n                                          } text-white px-2 py-1 text-xs font-bold uppercase rounded-full`}\n                                        >\n                                          {roster.shift}\n                                        </Badge>\n                                        <Badge className=\"bg-blue-500 text-white px-2 py-1 text-xs font-semibold rounded-full\">\n                                          {roster.status}\n                                        </Badge>\n                                        {/* Nomor Lambung Change Indicator */}\n                                        {roster.actualNomorLambung && roster.plannedNomorLambung && \n                                         roster.actualNomorLambung !== roster.plannedNomorLambung && (\n                                          <Badge \n                                            className=\"bg-amber-600 text-white px-2 py-1 text-xs font-bold rounded-full\"\n                                            data-testid={`nomor-lambung-changed-badge-${roster.id}`}\n                                          >\n                                            ðŸ“¦ Nomor Lambung Berubah\n                                          </Badge>\n                                        )}\n                                      </div>\n                                    </div>\n                                    <Clock className=\"h-5 w-5 text-gray-400 flex-shrink-0\" />\n                                  </div>\n                                  \n                                  <div className=\"space-y-1\">\n                                    <div className=\"flex items-center gap-2\">\n                                      <span className=\"text-lg font-bold text-gray-900 dark:text-white\">\n                                        {roster.startTime} - {roster.endTime}\n                                      </span>\n                                    </div>\n                                    <p className=\"text-sm text-gray-600 dark:text-gray-400 font-medium\">\n                                      {roster.fitToWork}\n                                    </p>\n                                  </div>\n                                </CardContent>\n                              </Card>\n                            );\n                          })}\n                        </div>\n                      );\n                    })()}\n                  </>\n                ) : (\n                  <div className=\"text-center py-16\">\n                    <Calendar className=\"h-20 w-20 text-gray-300 mx-auto mb-4\" />\n                    <p className=\"text-xl text-gray-500 font-semibold\">Tidak ada data roster ditemukan</p>\n                    <p className=\"text-gray-400 mt-2\">Belum ada jadwal kerja yang terdaftar untuk karyawan ini</p>\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Leave Tab */}\n            {activeTab === 'leave' && (\n              <div className=\"space-y-6\">\n                <div className=\"flex items-center justify-between mb-6\">\n                  <h3 className=\"text-2xl font-bold text-gray-800 dark:text-white flex items-center\">\n                    <MapPin className=\"h-7 w-7 mr-3 text-[#E53935]\" />\n                    Riwayat Cuti\n                  </h3>\n                  <Badge className=\"bg-green-100 text-green-800 px-4 py-2\">\n                    {employeeLeaves.length} Pengajuan Cuti\n                  </Badge>\n                </div>\n\n                {leaveLoading ? (\n                  <div className=\"flex flex-col items-center justify-center py-16\">\n                    <div className=\"animate-spin rounded-full h-12 w-12 border-b-4 border-[#E53935] mb-4\"></div>\n                    <p className=\"text-gray-600 dark:text-gray-300 font-semibold\">Memuat data cuti...</p>\n                  </div>\n                ) : employeeLeaves.length > 0 ? (\n                  <div className=\"grid gap-4\">\n                    {employeeLeaves\n                      .sort((a: LeaveRequest, b: LeaveRequest) => \n                        new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n                      )\n                      .slice(0, 5)\n                      .map((leave: LeaveRequest) => (\n                        <div key={leave.id} className=\"bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transition-all duration-200\" data-testid={`leave-item-${leave.id}`}>\n                          <div className=\"flex justify-between items-start\">\n                            <div className=\"space-y-3\">\n                              <div className=\"flex items-center gap-3\">\n                                <div className=\"w-3 h-8 bg-orange-500 rounded-full\"></div>\n                                <p className=\"text-2xl font-bold text-gray-800 dark:text-white\">{leave.leaveType}</p>\n                              </div>\n                              <div className=\"space-y-2\">\n                                <p className=\"text-lg font-semibold text-gray-600 dark:text-gray-400\">\n                                  {format(new Date(leave.startDate), \"dd MMM yyyy\")} - {format(new Date(leave.endDate), \"dd MMM yyyy\")}\n                                </p>\n                                {leave.reason && (\n                                  <p className=\"text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg\">\n                                    <span className=\"font-semibold\">Alasan:</span> {leave.reason}\n                                  </p>\n                                )}\n                              </div>\n                            </div>\n                            <Badge className={getStatusBadgeColor(leave.status) + \" px-4 py-2 text-sm font-bold\"}>\n                              {leave.status}\n                            </Badge>\n                          </div>\n                        </div>\n                      ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-16\">\n                    <MapPin className=\"h-20 w-20 text-gray-300 mx-auto mb-4\" />\n                    <p className=\"text-xl text-gray-500 font-semibold\">Tidak ada data cuti ditemukan</p>\n                    <p className=\"text-gray-400 mt-2\">Belum ada pengajuan cuti yang terdaftar untuk karyawan ini</p>\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Pemberitahuan Tab */}\n            {activeTab === 'pemberitahuan' && (\n              <div className=\"space-y-6\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <h3 className=\"text-2xl font-bold text-gray-800 dark:text-white flex items-center\">\n                    <Megaphone className=\"h-7 w-7 mr-3 text-purple-600\" />\n                    Pemberitahuan\n                    {unreadCount > 0 && (\n                      <Badge className=\"bg-red-500 text-white ml-3\">{unreadCount} baru</Badge>\n                    )}\n                  </h3>\n                </div>\n                <p className=\"text-purple-600 font-medium mb-4\">Informasi dan pengumuman terbaru dari admin</p>\n\n                {announcementsLoading ? (\n                  <div className=\"flex flex-col items-center justify-center py-16\">\n                    <div className=\"animate-spin rounded-full h-12 w-12 border-b-4 border-purple-600 mb-4\"></div>\n                    <p className=\"text-gray-600 dark:text-gray-300 font-semibold\">Memuat pemberitahuan...</p>\n                  </div>\n                ) : announcements.length > 0 ? (\n                  <div className=\"space-y-3\">\n                    {announcements.map((announcement) => (\n                      <div \n                        key={announcement.id}\n                        className={`flex items-center gap-4 p-4 rounded-xl cursor-pointer transition-all duration-200 border-2 ${\n                          !announcement.isRead \n                            ? 'bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-700 shadow-md hover:shadow-lg' \n                            : 'bg-white dark:bg-gray-800 border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50'\n                        }`}\n                        onClick={() => {\n                          setSelectedAnnouncement(announcement);\n                          setAnnouncementDialogOpen(true);\n                          if (!announcement.isRead) {\n                            markAsReadMutation.mutate({ announcementId: announcement.id });\n                          }\n                        }}\n                        data-testid={`announcement-${announcement.id}`}\n                      >\n                        <div className=\"flex-shrink-0 relative\">\n                          <div className={`w-14 h-14 rounded-full flex items-center justify-center ${\n                            !announcement.isRead \n                              ? 'bg-purple-500 shadow-lg' \n                              : 'bg-gray-200 dark:bg-gray-700'\n                          }`}>\n                            <Megaphone className={`h-7 w-7 ${!announcement.isRead ? 'text-white' : 'text-gray-500 dark:text-gray-400'}`} />\n                          </div>\n                          {!announcement.isRead && (\n                            <span className=\"absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white dark:border-gray-800 animate-pulse\"></span>\n                          )}\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-3\">\n                            <h4 className={`font-bold text-lg truncate ${!announcement.isRead ? 'text-purple-900 dark:text-purple-100' : 'text-gray-700 dark:text-gray-300'}`}>\n                              {announcement.title}\n                            </h4>\n                            {!announcement.isRead && (\n                              <span className=\"flex-shrink-0 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full uppercase shadow-sm\">\n                                Baru\n                              </span>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400 mt-2\">\n                            <span className=\"flex items-center gap-1\">\n                              <Clock className=\"h-4 w-4\" />\n                              {format(new Date(announcement.createdAt), \"dd MMM yyyy HH:mm\")}\n                            </span>\n                            {announcement.imageUrls && announcement.imageUrls.length > 0 && (\n                              <>\n                                <span className=\"text-gray-300 dark:text-gray-600\">â€¢</span>\n                                <span className=\"flex items-center gap-1 text-purple-600\">\n                                  <ImageIcon className=\"h-4 w-4\" />\n                                  {announcement.imageUrls.length} foto\n                                </span>\n                              </>\n                            )}\n                          </div>\n                        </div>\n                        <ChevronRightIcon className={`h-6 w-6 flex-shrink-0 ${!announcement.isRead ? 'text-purple-500' : 'text-gray-400'}`} />\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-16\">\n                    <Megaphone className=\"h-20 w-20 text-gray-300 mx-auto mb-4\" />\n                    <p className=\"text-xl text-gray-500 font-semibold\">Tidak ada pemberitahuan</p>\n                    <p className=\"text-gray-400 mt-2\">Belum ada pengumuman dari admin saat ini</p>\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Dialog Detail Pengumuman */}\n            <Dialog open={announcementDialogOpen} onOpenChange={setAnnouncementDialogOpen}>\n              <DialogContent className=\"max-w-2xl max-h-[90vh] p-0 overflow-hidden\">\n                <DialogHeader className=\"bg-gradient-to-r from-purple-500 to-indigo-500 text-white p-6\">\n                  <DialogTitle className=\"text-xl font-bold flex items-center gap-3\">\n                    <Megaphone className=\"h-6 w-6\" />\n                    {selectedAnnouncement?.title}\n                  </DialogTitle>\n                  <p className=\"text-purple-100 text-sm flex items-center gap-3 mt-2\">\n                    <Clock className=\"h-4 w-4\" />\n                    {selectedAnnouncement && format(new Date(selectedAnnouncement.createdAt), \"dd MMM yyyy HH:mm\")}\n                    <span className=\"text-purple-200\">â€¢</span>\n                    <span>Oleh: {selectedAnnouncement?.createdByName}</span>\n                  </p>\n                </DialogHeader>\n                <ScrollArea className=\"max-h-[calc(90vh-140px)]\">\n                  <div className=\"p-6 space-y-6\">\n                    {/* Images */}\n                    {selectedAnnouncement?.imageUrls && selectedAnnouncement.imageUrls.length > 0 && (\n                      <div className=\"space-y-4\">\n                        {selectedAnnouncement.imageUrls.map((url, idx) => (\n                          <div key={idx} className=\"rounded-xl overflow-hidden bg-gray-100 dark:bg-gray-700 shadow-md\">\n                            <img \n                              src={url} \n                              alt={`${selectedAnnouncement.title} - ${idx + 1}`}\n                              className=\"w-full object-contain max-h-96\"\n                              onError={(e) => {\n                                (e.target as HTMLImageElement).style.display = 'none';\n                              }}\n                            />\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                    \n                    {/* Content */}\n                    <div className=\"prose prose-lg dark:prose-invert max-w-none\">\n                      <p className=\"text-gray-700 dark:text-gray-300 whitespace-pre-wrap leading-relaxed text-base\">\n                        {selectedAnnouncement?.content}\n                      </p>\n                    </div>\n                  </div>\n                </ScrollArea>\n              </DialogContent>\n            </Dialog>\n\n            {/* SIMPER Tab */}\n            {activeTab === 'simper' && (\n              <div className=\"space-y-6\">\n                <div className=\"flex items-center justify-between mb-6\">\n                  <h3 className=\"text-2xl font-bold text-gray-800 dark:text-white flex items-center\">\n                    <Shield className=\"h-7 w-7 mr-3 text-[#E53935]\" />\n                    Data SIMPER Monitoring\n                  </h3>\n                </div>\n\n                {simperLoading ? (\n                  <div className=\"flex flex-col items-center justify-center py-16\">\n                    <div className=\"animate-spin rounded-full h-12 w-12 border-b-4 border-[#E53935] mb-4\"></div>\n                    <p className=\"text-gray-600 dark:text-gray-300 font-semibold\">Memuat data SIMPER...</p>\n                  </div>\n                ) : simperData ? (\n                  <div className=\"space-y-8\">\n                    {/* Employee Info */}\n                    <div className=\"bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-6 rounded-xl border border-blue-200 dark:border-blue-700\">\n                      <h4 className=\"text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center\">\n                        <User className=\"h-6 w-6 mr-3 text-blue-600\" />\n                        Informasi Karyawan\n                      </h4>\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                        <div>\n                          <span className=\"text-gray-600 dark:text-gray-300 text-lg\">Nama:</span>\n                          <span className=\"ml-3 font-bold text-xl text-gray-800 dark:text-white\">{simperData.employeeName}</span>\n                        </div>\n                        <div>\n                          <span className=\"text-gray-600 dark:text-gray-300 text-lg\">NIK:</span>\n                          <span className=\"ml-3 font-bold text-xl text-gray-800 dark:text-white\">{simperData.nik}</span>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* SIMPER Status Cards */}\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8\">\n                      {/* SIMPER BIB */}\n                      <div className=\"bg-white dark:bg-gray-800 border-2 border-blue-200 dark:border-blue-700 rounded-xl p-6 shadow-lg\">\n                        <h4 className=\"text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center\">\n                          <div className=\"w-3 h-8 bg-blue-500 rounded-full mr-3\"></div>\n                          <Shield className=\"w-6 h-6 mr-3 text-blue-600\" />\n                          SIMPER BIB\n                        </h4>\n                        <div className=\"space-y-4\">\n                          <div className=\"flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\">\n                            <span className=\"text-gray-600 dark:text-gray-300 font-medium\">Tanggal Expired:</span>\n                            <span className=\"font-bold text-lg text-gray-800 dark:text-white\">\n                              {formatDateDD_MM_YYYY(simperData.simperBibExpiredDate)}\n                            </span>\n                          </div>\n                          <div className=\"flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\">\n                            <span className=\"text-gray-600 dark:text-gray-300 font-medium\">Monitoring Days:</span>\n                            <span className=\"font-bold text-lg text-gray-800 dark:text-white\">\n                              {simperData.bibMonitoringDays !== null ? `${simperData.bibMonitoringDays} hari` : '-'}\n                            </span>\n                          </div>\n                          <div className=\"flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\">\n                            <span className=\"text-gray-600 dark:text-gray-300 font-medium\">Status:</span>\n                            <Badge className={getSimperStatusColor(simperData.bibStatus || 'Tidak Ada Data') + ' px-4 py-2 text-sm font-bold'}>\n                              {simperData.bibStatus || 'Tidak Ada Data'}\n                            </Badge>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* SIMPER TIA */}\n                      <div className=\"bg-white dark:bg-gray-800 border-2 border-green-200 dark:border-green-700 rounded-xl p-6 shadow-lg\">\n                        <h4 className=\"text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center\">\n                          <div className=\"w-3 h-8 bg-green-500 rounded-full mr-3\"></div>\n                          <Shield className=\"w-6 h-6 mr-3 text-green-600\" />\n                          SIMPER TIA\n                        </h4>\n                        <div className=\"space-y-4\">\n                          <div className=\"flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\">\n                            <span className=\"text-gray-600 dark:text-gray-300 font-medium\">Tanggal Expired:</span>\n                            <span className=\"font-bold text-lg text-gray-800 dark:text-white\">\n                              {formatDateDD_MM_YYYY(simperData.simperTiaExpiredDate)}\n                            </span>\n                          </div>\n                          <div className=\"flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\">\n                            <span className=\"text-gray-600 dark:text-gray-300 font-medium\">Monitoring Days:</span>\n                            <span className=\"font-bold text-lg text-gray-800 dark:text-white\">\n                              {simperData.tiaMonitoringDays !== null ? `${simperData.tiaMonitoringDays} hari` : '-'}\n                            </span>\n                          </div>\n                          <div className=\"flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\">\n                            <span className=\"text-gray-600 dark:text-gray-300 font-medium\">Status:</span>\n                            <Badge className={getSimperStatusColor(simperData.tiaStatus || 'Tidak Ada Data') + ' px-4 py-2 text-sm font-bold'}>\n                              {simperData.tiaStatus || 'Tidak Ada Data'}\n                            </Badge>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Alert untuk status kritis */}\n                    {(simperData.bibStatus === 'Segera Perpanjang' || simperData.tiaStatus === 'Segera Perpanjang' ||\n                      simperData.bibStatus === 'Mendekati Perpanjangan' || simperData.tiaStatus === 'Mendekati Perpanjangan') && (\n                      <div className=\"bg-gradient-to-r from-red-50 to-rose-50 dark:from-red-900/20 dark:to-rose-900/20 border-2 border-red-200 dark:border-red-700 rounded-xl p-6\">\n                        <div className=\"flex items-center mb-3\">\n                          <AlertTriangle className=\"w-7 h-7 text-red-600 mr-3\" />\n                          <span className=\"text-xl font-bold text-red-800 dark:text-red-200\">Peringatan SIMPER</span>\n                        </div>\n                        <p className=\"text-red-700 dark:text-red-300 text-lg leading-relaxed\">\n                          Ada SIMPER yang akan expired dalam waktu dekat. Segera lakukan perpanjangan untuk menghindari masalah operasional.\n                        </p>\n                      </div>\n                    )}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-16\">\n                    <Shield className=\"h-20 w-20 text-gray-300 mx-auto mb-4\" />\n                    <p className=\"text-xl text-gray-500 font-semibold\">Data SIMPER tidak ditemukan</p>\n                    <p className=\"text-gray-400 mt-2\">Karyawan ini belum terdaftar dalam sistem monitoring SIMPER</p>\n                  </div>\n                )}\n              </div>\n            )}\n            </div>\n          </>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":55681,"size_tokens":null},"client/src/lib/crypto-utils.ts":{"content":"export const SECRET_KEY = 'AttendanceQR2024';\n\nexport function generateToken(employeeId: string): string {\n  const timestamp = Date.now();\n  const tokenData = `${employeeId}${SECRET_KEY}${timestamp}`;\n  return btoa(tokenData).slice(0, 16);\n}\n\nexport function validateQRData(qrDataString: string): { id: string; token: string } | null {\n  if (!qrDataString || qrDataString.trim() === '') {\n    return null;\n  }\n  \n  try {\n    // First, try direct JSON parsing (primary format for attendance)\n    const qrData = JSON.parse(qrDataString);\n    if (qrData.id && qrData.token) {\n      return { id: qrData.id, token: qrData.token };\n    }\n    return null;\n  } catch {\n    // If direct JSON parsing fails, try to extract from legacy URL format\n    try {\n      // Helper function to parse URL parameters (legacy support)\n      const parseQRParams = (url: URL) => {\n        // Try multiple parameter names for compatibility\n        const dataParam = url.searchParams.get('data') || url.searchParams.get('qr');\n        if (dataParam) {\n          const decodedData = decodeURIComponent(dataParam);\n          const qrData = JSON.parse(decodedData);\n          if (qrData.id && qrData.token) {\n            return { id: qrData.id, token: qrData.token };\n          }\n        }\n        return null;\n      };\n      \n      // Check if it's a full URL with qr-redirect (legacy)\n      if (qrDataString.includes('qr-redirect?')) {\n        const url = new URL(qrDataString);\n        const result = parseQRParams(url);\n        if (result) return result;\n      }\n      \n      // Handle case where QR might be just the URL path without domain (legacy)\n      if (qrDataString.includes('/qr-redirect?')) {\n        // Extract query string part\n        const parts = qrDataString.split('/qr-redirect?');\n        if (parts.length > 1) {\n          const queryString = parts[1];\n          const url = new URL(`http://localhost/?${queryString}`);\n          const result = parseQRParams(url);\n          if (result) return result;\n        }\n      }\n      \n      return null;\n    } catch {\n      return null;\n    }\n  }\n}\n\nexport function createQRPayload(employeeId: string, token: string): string {\n  return JSON.stringify({ id: employeeId, token });\n}\n","path":null,"size_bytes":2215,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n          50: \"hsl(4 100% 97%)\",\n          100: \"hsl(4 95% 93%)\",\n          500: \"hsl(4 100% 50%)\",\n          600: \"hsl(4 83% 48%)\",\n          700: \"hsl(4 83% 43%)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":2921,"size_tokens":null},"client/src/pages/dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { StatsCard } from \"@/components/ui/stats-card\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Users, CheckCircle, Clock, FileText, Calendar, RefreshCw } from \"lucide-react\";\nimport { Bar, Doughnut } from \"react-chartjs-2\";\nimport { useState, useEffect, useMemo, useCallback } from \"react\";\nimport {\n  Chart as ChartJS,\n  CategoryScale,\n  LinearScale,\n  BarElement,\n  Title,\n  Tooltip,\n  Legend,\n  ArcElement,\n  Filler,\n} from 'chart.js';\n\nChartJS.register(\n  CategoryScale,\n  LinearScale,\n  BarElement,\n  Title,\n  Tooltip,\n  Legend,\n  ArcElement,\n  Filler\n);\n\ninterface DashboardStats {\n  totalEmployees: number;\n  scheduledToday: number;\n  presentToday: number;\n  absentToday: number;\n  onLeaveToday: number;\n  pendingLeaveRequests: number;\n}\n\ninterface RecentActivity {\n  id: string;\n  employeeId: string;\n  employeeName: string;\n  time: string;\n  jamTidur: string;\n  fitToWork: string;\n  status: string;\n  createdAt: string;\n}\n\ninterface AttendanceDetail {\n  employeeId: string;\n  employeeName: string;\n  position: string;\n  shift: string;\n  scheduledTime: string;\n  actualTime: string;\n  jamTidur: string;\n  fitToWork: string;\n  status: string;\n  hasAttended: boolean;\n}\n\nexport default function Dashboard() {\n  const [selectedDate, setSelectedDate] = useState(() => {\n    const today = new Date();\n    return today.toISOString().split('T')[0];\n  });\n\n  const { data: stats, refetch: refetchStats } = useQuery<DashboardStats>({\n    queryKey: [\"/api/dashboard/stats\", selectedDate],\n    staleTime: 30000, // Cache for 30 seconds\n    refetchInterval: 60000, // Refetch every 60 seconds instead of 15\n    refetchOnWindowFocus: true,\n  });\n\n  const { data: recentActivities, refetch: refetchActivities } = useQuery<RecentActivity[]>({\n    queryKey: [\"/api/dashboard/recent-activities\", selectedDate],\n    staleTime: 30000, // Cache for 30 seconds\n    refetchInterval: 120000, // Refetch every 2 minutes for activities\n    refetchOnWindowFocus: true,\n  });\n\n\n  const handleRefresh = useCallback(() => {\n    refetchStats();\n    refetchActivities();\n  }, [refetchStats, refetchActivities]);\n\n  // Smart auto refresh - only when page is visible\n  useEffect(() => {\n    const handleVisibilityChange = () => {\n      if (!document.hidden) {\n        handleRefresh();\n      }\n    };\n\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n    return () => document.removeEventListener('visibilitychange', handleVisibilityChange);\n  }, [handleRefresh]);\n\n  const attendanceChartData = useMemo(() => ({\n    labels: ['Hadir', 'Belum Hadir', 'Cuti'],\n    datasets: [{\n      data: [\n        stats?.presentToday || 0,\n        stats?.absentToday || 0,\n        stats?.onLeaveToday || 0\n      ],\n      backgroundColor: ['#10B981', '#ff1100', '#8B5CF6'],\n      borderWidth: 0\n    }]\n  }), [stats]);\n\n  const weeklyTrendData = useMemo(() => ({\n    labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],\n    datasets: [{\n      label: 'Kehadiran (%)',\n      data: [85, 89, 92, 88, 85, 78, 82],\n      backgroundColor: 'rgba(255, 17, 0, 0.1)',\n      borderColor: '#ff1100',\n      fill: true,\n      tension: 0.4\n    }]\n  }), []);\n\n  const chartOptions = useMemo(() => ({\n    responsive: true,\n    maintainAspectRatio: false,\n    plugins: {\n      legend: {\n        position: 'bottom' as const\n      }\n    }\n  }), []);\n\n  return (\n    <div className=\"space-y-4 sm:space-y-6\">\n      {/* Date Filter and Refresh */}\n      <div className=\"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"flex items-center gap-2\">\n            <Calendar className=\"w-5 h-5 text-gray-500 dark:text-gray-400\" />\n            <label htmlFor=\"date-filter\" className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n              Tanggal:\n            </label>\n          </div>\n          <Input\n            id=\"date-filter\"\n            type=\"date\"\n            value={selectedDate}\n            onChange={(e) => setSelectedDate(e.target.value)}\n            className=\"w-auto\"\n            data-testid=\"date-filter\"\n          />\n        </div>\n        <Button \n          onClick={handleRefresh} \n          variant=\"outline\" \n          className=\"flex items-center gap-2\"\n          data-testid=\"refresh-button\"\n        >\n          <RefreshCw className=\"w-4 h-4\" />\n          Refresh Data\n        </Button>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6\">\n        <StatsCard\n          title=\"Total Karyawan\"\n          value={stats?.totalEmployees || 0}\n          icon={<Users className=\"w-6 h-6\" />}\n          iconColor=\"bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300\"\n        />\n        <StatsCard\n          title=\"Hadir Hari Ini\"\n          value={stats?.presentToday || 0}\n          icon={<CheckCircle className=\"w-6 h-6\" />}\n          iconColor=\"bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300\"\n        />\n        <StatsCard\n          title=\"Belum Hadir\"\n          value={stats?.absentToday || 0}\n          icon={<Clock className=\"w-6 h-6\" />}\n          iconColor=\"bg-yellow-100 dark:bg-yellow-900 text-yellow-600 dark:text-yellow-300\"\n        />\n        <StatsCard\n          title=\"Cuti\"\n          value={stats?.onLeaveToday || 0}\n          icon={<FileText className=\"w-6 h-6\" />}\n          iconColor=\"bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300\"\n        />\n      </div>\n\n      {/* Charts */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 lg:gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Statistik Kehadiran</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"h-64\">\n              <Doughnut data={attendanceChartData} options={chartOptions} />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Tren Mingguan</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"h-64\">\n              <Bar \n                data={weeklyTrendData} \n                options={{\n                  ...chartOptions,\n                  scales: {\n                    y: {\n                      beginAtZero: true,\n                      max: 100\n                    }\n                  }\n                }} \n              />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Recent Activity */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Aktivitas Terbaru</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            {recentActivities && recentActivities.length > 0 ? (\n              recentActivities.map((activity) => (\n                <div key={activity.id} className=\"flex items-center space-x-4\">\n                  <div className=\"flex-shrink-0 w-8 h-8 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center\">\n                    <CheckCircle className=\"w-4 h-4 text-green-600 dark:text-green-300\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"text-sm font-medium text-gray-900 dark:text-white\">\n                      {activity.employeeName} ({activity.employeeId}) telah melakukan absensi\n                    </p>\n                    <div className=\"text-xs text-gray-500 dark:text-gray-400\">\n                      Jam: {activity.time} | Tidur: {activity.jamTidur} jam | {activity.fitToWork}\n                    </div>\n                  </div>\n                </div>\n              ))\n            ) : (\n              <div className=\"text-center py-8 text-gray-500 dark:text-gray-400\">\n                Belum ada aktivitas absensi hari ini\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":8110,"size_tokens":null},"client/src/hooks/use-theme.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"light\" | \"dark\";\n\ntype ThemeProviderProps = {\n  children: React.ReactNode;\n  defaultTheme?: Theme;\n  storageKey?: string;\n};\n\ntype ThemeProviderState = {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n  toggleTheme: () => void;\n};\n\nconst initialState: ThemeProviderState = {\n  theme: \"light\",\n  setTheme: () => null,\n  toggleTheme: () => null,\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderState>(initialState);\n\nexport function ThemeProvider({\n  children,\n  defaultTheme = \"light\",\n  storageKey = \"ui-theme\",\n  ...props\n}: ThemeProviderProps) {\n  const [theme, setTheme] = useState<Theme>(\n    () => (localStorage.getItem(storageKey) as Theme) || defaultTheme\n  );\n\n  useEffect(() => {\n    const root = window.document.documentElement;\n    root.classList.remove(\"light\", \"dark\");\n    root.classList.add(theme);\n  }, [theme]);\n\n  const value = {\n    theme,\n    setTheme: (theme: Theme) => {\n      localStorage.setItem(storageKey, theme);\n      setTheme(theme);\n    },\n    toggleTheme: () => {\n      const newTheme = theme === \"light\" ? \"dark\" : \"light\";\n      localStorage.setItem(storageKey, newTheme);\n      setTheme(newTheme);\n    },\n  };\n\n  return (\n    <ThemeProviderContext.Provider {...props} value={value}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport const useTheme = () => {\n  const context = useContext(ThemeProviderContext);\n\n  if (context === undefined)\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n\n  return context;\n};\n","path":null,"size_bytes":1588,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/pages/meetings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Calendar, Clock, MapPin, User, QrCode, Users, Eye, Trash2, Plus, Download, FileText, Camera, X, Upload } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { Meeting, InsertMeeting, MeetingAttendance } from \"@shared/schema\";\nimport QRCode from \"qrcode\";\nimport { generateMeetingAttendancePDF } from \"@/lib/meeting-pdf-utils\";\n\n// QR Code Display Component\nfunction QRCodeDisplay({ meeting }: { meeting: Meeting }) {\n  const [qrDataURL, setQrDataURL] = useState<string>(\"\");\n  const { toast } = useToast();\n\n  useEffect(() => {\n    const generateQR = async () => {\n      if (meeting.qrToken) {\n        try {\n          // Generate QR code with URL format that works with native camera scanners\n          const qrData = JSON.stringify({\n            type: \"meeting\",\n            token: meeting.qrToken\n          });\n          const qrUrl = `${window.location.origin}/qr-redirect?data=${encodeURIComponent(qrData)}`;\n          \n          const dataURL = await QRCode.toDataURL(qrUrl, {\n            width: 300,\n            margin: 2,\n            color: {\n              dark: '#000000',\n              light: '#FFFFFF'\n            }\n          });\n          setQrDataURL(dataURL);\n        } catch (error) {\n          console.error('Error generating QR code:', error);\n        }\n      }\n    };\n    generateQR();\n  }, [meeting.qrToken]);\n\n  const downloadQR = async () => {\n    if (!qrDataURL) return;\n    \n    try {\n      const link = document.createElement('a');\n      link.href = qrDataURL;\n      link.download = `meeting-qr-${meeting.title.replace(/[^a-zA-Z0-9]/g, '-')}-${meeting.date}.png`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      \n      toast({\n        title: \"QR Code Downloaded\",\n        description: `QR code untuk meeting \"${meeting.title}\" berhasil didownload`,\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Gagal mendownload QR code\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const copyMeetingScanURL = () => {\n    const scanURL = `${window.location.origin}/meeting-scanner`;\n    navigator.clipboard.writeText(scanURL).then(() => {\n      toast({\n        title: \"Link Copied\",\n        description: \"Link scan QR meeting berhasil dicopy ke clipboard\",\n      });\n    }).catch(() => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal copy link\",\n        variant: \"destructive\",\n      });\n    });\n  };\n\n  return (\n    <div className=\"text-center py-6\">\n      {qrDataURL && (\n        <div className=\"mx-auto mb-4 inline-block p-4 bg-white rounded-lg shadow-sm\">\n          <img \n            src={qrDataURL} \n            alt={`QR Code for ${meeting.title}`}\n            className=\"mx-auto\"\n            style={{ width: 300, height: 300 }}\n          />\n        </div>\n      )}\n      \n      <div className=\"space-y-4\">\n        <div className=\"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg\">\n          <h4 className=\"font-semibold text-blue-900 dark:text-blue-100 mb-2\">\n            Informasi Meeting\n          </h4>\n          <div className=\"text-sm text-blue-800 dark:text-blue-200 space-y-1\">\n            <div><strong>Judul:</strong> {meeting.title}</div>\n            <div><strong>Tanggal:</strong> {new Date(meeting.date).toLocaleDateString('id-ID')}</div>\n            <div><strong>Waktu:</strong> {meeting.startTime} - {meeting.endTime}</div>\n            <div><strong>Lokasi:</strong> {meeting.location}</div>\n            <div><strong>Penyelenggara:</strong> {meeting.organizer}</div>\n          </div>\n        </div>\n\n        <div className=\"bg-green-50 dark:bg-green-900/20 p-4 rounded-lg\">\n          <h4 className=\"font-semibold text-green-900 dark:text-green-100 mb-2\">\n            Cara Absensi via Mobile\n          </h4>\n          <div className=\"text-sm text-green-800 dark:text-green-200 space-y-2\">\n            <div>1. Buka link berikut di mobile/smartphone:</div>\n            <div className=\"bg-white dark:bg-gray-800 p-2 rounded border text-xs font-mono break-all\">\n              {window.location.origin}/meeting-scanner\n            </div>\n            <div>2. Masukkan NIK karyawan</div>\n            <div>3. Scan QR code di atas menggunakan kamera</div>\n            <div>4. Sistem otomatis mencatat kehadiran</div>\n          </div>\n        </div>\n\n        <div className=\"flex gap-2 justify-center\">\n          <Button \n            onClick={downloadQR}\n            className=\"bg-red-600 hover:bg-red-700\"\n            data-testid=\"button-download-qr-dialog\"\n          >\n            <Download className=\"w-4 h-4 mr-2\" />\n            Download QR Code\n          </Button>\n          \n          <Button \n            onClick={copyMeetingScanURL}\n            variant=\"outline\"\n            data-testid=\"button-copy-scan-url\"\n          >\n            <QrCode className=\"w-4 h-4 mr-2\" />\n            Copy Link Scan\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function Meetings() {\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const [selectedMeeting, setSelectedMeeting] = useState<Meeting | null>(null);\n  const [isAttendanceOpen, setIsAttendanceOpen] = useState(false);\n  const [isQrOpen, setIsQrOpen] = useState(false);\n  const [isPhotoDialogOpen, setIsPhotoDialogOpen] = useState(false);\n  const [uploadedPhotos, setUploadedPhotos] = useState<File[]>([]);\n  const [photoPreviewUrls, setPhotoPreviewUrls] = useState<string[]>([]);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const [formData, setFormData] = useState<InsertMeeting>({\n    title: \"\",\n    description: \"\",\n    date: new Date().toISOString().split('T')[0],\n    startTime: \"09:00\",\n    endTime: \"10:00\",\n    location: \"\",\n    organizer: \"\",\n    status: \"scheduled\"\n  });\n\n  const { data: meetings = [], isLoading } = useQuery<Meeting[]>({\n    queryKey: [\"/api/meetings\"],\n  });\n\n  const createMeetingMutation = useMutation({\n    mutationFn: async (meeting: InsertMeeting) => {\n      return await apiRequest(\"/api/meetings\", \"POST\", meeting);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/meetings\"] });\n      setIsCreateOpen(false);\n      setFormData({\n        title: \"\",\n        description: \"\",\n        date: new Date().toISOString().split('T')[0],\n        startTime: \"09:00\",\n        endTime: \"10:00\",\n        location: \"\",\n        organizer: \"\",\n        status: \"scheduled\"\n      });\n      toast({\n        title: \"Meeting Created\",\n        description: \"Meeting berhasil dibuat dengan QR code unik\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal membuat meeting\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMeetingMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await apiRequest(`/api/meetings/${id}`, \"DELETE\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/meetings\"] });\n      toast({\n        title: \"Meeting Deleted\",\n        description: \"Meeting berhasil dihapus\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal menghapus meeting\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const uploadPhotosMutation = useMutation({\n    mutationFn: async ({ meetingId, photos }: { meetingId: string; photos: File[] }) => {\n      const formData = new FormData();\n      photos.forEach((photo) => {\n        formData.append('photos', photo);\n      });\n      \n      const response = await fetch(`/api/meetings/${meetingId}/upload-photos`, {\n        method: 'POST',\n        body: formData,\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || 'Upload failed');\n      }\n      \n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/meetings\"] });\n      setIsPhotoDialogOpen(false);\n      setUploadedPhotos([]);\n      setPhotoPreviewUrls([]);\n      toast({\n        title: \"Photos Uploaded\",\n        description: `${data.photos.length} foto berhasil diupload`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Gagal upload foto\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const { data: attendanceData } = useQuery<{\n    meeting: Meeting;\n    attendance: (MeetingAttendance & { employee?: any })[];\n    totalAttendees: number;\n  }>({\n    queryKey: [\"/api/meetings\", selectedMeeting?.id, \"attendance\"],\n    enabled: !!selectedMeeting?.id && isAttendanceOpen,\n  });\n\n  const handleCreateMeeting = (e: React.FormEvent) => {\n    e.preventDefault();\n    createMeetingMutation.mutate(formData);\n  };\n\n  const handleDelete = (meeting: Meeting) => {\n    if (confirm(`Yakin ingin menghapus meeting \"${meeting.title}\"?`)) {\n      deleteMeetingMutation.mutate(meeting.id);\n    }\n  };\n\n  const handlePhotoSelect = (files: FileList | null) => {\n    if (!files || !selectedMeeting) return;\n    \n    const existingPhotosCount = selectedMeeting.meetingPhotos?.length || 0;\n    const remainingSlots = 4 - existingPhotosCount;\n    \n    if (remainingSlots <= 0) {\n      toast({\n        title: \"Maksimal Foto Tercapai\",\n        description: \"Meeting sudah memiliki 4 foto\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    const newPhotos: File[] = [];\n    const newPreviewUrls: string[] = [];\n    \n    for (let i = 0; i < Math.min(files.length, remainingSlots); i++) {\n      const file = files[i];\n      \n      if (!file.type.startsWith('image/')) {\n        toast({\n          title: \"File Tidak Valid\",\n          description: `${file.name} bukan file gambar`,\n          variant: \"destructive\",\n        });\n        continue;\n      }\n      \n      if (file.size > 5 * 1024 * 1024) {\n        toast({\n          title: \"File Terlalu Besar\",\n          description: `${file.name} lebih dari 5MB`,\n          variant: \"destructive\",\n        });\n        continue;\n      }\n      \n      newPhotos.push(file);\n      newPreviewUrls.push(URL.createObjectURL(file));\n    }\n    \n    setUploadedPhotos(prev => [...prev, ...newPhotos]);\n    setPhotoPreviewUrls(prev => [...prev, ...newPreviewUrls]);\n  };\n\n  const removePhoto = (index: number) => {\n    setUploadedPhotos(prev => prev.filter((_, i) => i !== index));\n    setPhotoPreviewUrls(prev => {\n      const newUrls = prev.filter((_, i) => i !== index);\n      URL.revokeObjectURL(prev[index]);\n      return newUrls;\n    });\n  };\n\n  const handlePhotoUpload = () => {\n    if (!selectedMeeting || uploadedPhotos.length === 0) return;\n    \n    uploadPhotosMutation.mutate({\n      meetingId: selectedMeeting.id,\n      photos: uploadedPhotos,\n    });\n  };\n\n  const openPhotoDialog = (meeting: Meeting) => {\n    setSelectedMeeting(meeting);\n    setUploadedPhotos([]);\n    setPhotoPreviewUrls([]);\n    setIsPhotoDialogOpen(true);\n  };\n\n  const generateQRCodeDataURL = async (qrToken: string): Promise<string> => {\n    try {\n      // Generate QR code with URL format that works with native camera scanners\n      const qrData = JSON.stringify({ \n        type: \"meeting\",\n        token: qrToken \n      });\n      const qrUrl = `${window.location.origin}/qr-redirect?data=${encodeURIComponent(qrData)}`;\n      \n      return await QRCode.toDataURL(qrUrl, {\n        width: 300,\n        margin: 2,\n        color: {\n          dark: '#000000',\n          light: '#FFFFFF'\n        }\n      });\n    } catch (error) {\n      console.error('Error generating QR code:', error);\n      return '';\n    }\n  };\n\n  const downloadQRCode = async (meeting: Meeting) => {\n    if (!meeting.qrToken) return;\n    \n    try {\n      const qrDataURL = await generateQRCodeDataURL(meeting.qrToken);\n      \n      // Create download link\n      const link = document.createElement('a');\n      link.href = qrDataURL;\n      link.download = `meeting-qr-${meeting.title.replace(/[^a-zA-Z0-9]/g, '-')}-${meeting.date}.png`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      \n      toast({\n        title: \"QR Code Downloaded\",\n        description: `QR code untuk meeting \"${meeting.title}\" berhasil didownload`,\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Gagal mendownload QR code\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const downloadAttendanceReport = async () => {\n    console.log('ðŸ“„ Download PDF requested', { selectedMeeting, attendanceData });\n    \n    if (!selectedMeeting) {\n      toast({\n        title: \"Error\",\n        description: \"Meeting tidak dipilih\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (!attendanceData) {\n      toast({\n        title: \"Error\", \n        description: \"Data attendance tidak tersedia\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    try {\n      console.log(`ðŸ“Š Total attendance from API: ${attendanceData.attendance.length}`);\n      console.log(`ðŸ“Š Total attendees count: ${attendanceData.totalAttendees}`);\n      \n      // Prepare and validate data for PDF generation\n      const pdfData = {\n        meeting: {\n          id: selectedMeeting.id,\n          title: selectedMeeting.title,\n          description: selectedMeeting.description || undefined,\n          date: selectedMeeting.date,\n          startTime: selectedMeeting.startTime,\n          endTime: selectedMeeting.endTime,\n          location: selectedMeeting.location,\n          organizer: selectedMeeting.organizer,\n          status: selectedMeeting.status,\n          meetingPhotos: selectedMeeting.meetingPhotos || undefined\n        },\n        attendance: attendanceData.attendance || [],\n        totalAttendees: attendanceData.totalAttendees || 0\n      };\n      \n      console.log(`âœ… Passing ${pdfData.attendance.length} attendance records to PDF generator`);\n      console.log('ðŸ“‹ Attendance data:', pdfData.attendance);\n      await generateMeetingAttendancePDF(pdfData);\n      \n      toast({\n        title: \"PDF Berhasil Didownload\",\n        description: `Laporan meeting \"${selectedMeeting.title}\" telah didownload`,\n      });\n    } catch (error) {\n      console.error(\"Error generating PDF:\", error);\n      const errorMessage = error instanceof Error ? error.message : 'Error tidak dikenal';\n      toast({\n        title: \"Gagal Download PDF\",\n        description: errorMessage,\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    const statusMap = {\n      scheduled: { label: \"Terjadwal\", variant: \"secondary\" as const },\n      ongoing: { label: \"Berlangsung\", variant: \"default\" as const },\n      completed: { label: \"Selesai\", variant: \"outline\" as const },\n      cancelled: { label: \"Dibatalkan\", variant: \"destructive\" as const },\n    };\n    \n    const statusInfo = statusMap[status as keyof typeof statusMap] || statusMap.scheduled;\n    return <Badge variant={statusInfo.variant}>{statusInfo.label}</Badge>;\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"text-center\">\n            <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600 mx-auto mb-4\"></div>\n            <p className=\"text-gray-600 dark:text-gray-400\">Memuat data meeting...</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6\">\n      <div className=\"flex justify-between items-center mb-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white\">Meeting Management</h1>\n          <p className=\"text-gray-600 dark:text-gray-400 mt-2\">\n            Kelola meeting dan absensi peserta dengan QR code\n          </p>\n        </div>\n        \n        <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-meeting\" className=\"bg-red-600 hover:bg-red-700\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Buat Meeting\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>Buat Meeting Baru</DialogTitle>\n              <DialogDescription>\n                Buat meeting baru dengan QR code untuk absensi peserta\n              </DialogDescription>\n            </DialogHeader>\n            \n            <form onSubmit={handleCreateMeeting} className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"title\">Judul Meeting *</Label>\n                  <Input\n                    id=\"title\"\n                    data-testid=\"input-meeting-title\"\n                    value={formData.title}\n                    onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                    placeholder=\"Contoh: Rapat Mingguan\"\n                    required\n                  />\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"organizer\">Penyelenggara *</Label>\n                  <Input\n                    id=\"organizer\"\n                    data-testid=\"input-meeting-organizer\"\n                    value={formData.organizer}\n                    onChange={(e) => setFormData({ ...formData, organizer: e.target.value })}\n                    placeholder=\"Nama penyelenggara\"\n                    required\n                  />\n                </div>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"description\">Deskripsi</Label>\n                <Textarea\n                  id=\"description\"\n                  data-testid=\"input-meeting-description\"\n                  value={formData.description || \"\"}\n                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                  placeholder=\"Deskripsi meeting (opsional)\"\n                />\n              </div>\n              \n              <div className=\"grid grid-cols-3 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"date\">Tanggal *</Label>\n                  <Input\n                    id=\"date\"\n                    type=\"date\"\n                    data-testid=\"input-meeting-date\"\n                    value={formData.date}\n                    onChange={(e) => setFormData({ ...formData, date: e.target.value })}\n                    required\n                  />\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"startTime\">Waktu Mulai *</Label>\n                  <Input\n                    id=\"startTime\"\n                    type=\"time\"\n                    data-testid=\"input-meeting-start-time\"\n                    value={formData.startTime}\n                    onChange={(e) => setFormData({ ...formData, startTime: e.target.value })}\n                    required\n                  />\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"endTime\">Waktu Selesai *</Label>\n                  <Input\n                    id=\"endTime\"\n                    type=\"time\"\n                    data-testid=\"input-meeting-end-time\"\n                    value={formData.endTime}\n                    onChange={(e) => setFormData({ ...formData, endTime: e.target.value })}\n                    required\n                  />\n                </div>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"location\">Lokasi *</Label>\n                <Input\n                  id=\"location\"\n                  data-testid=\"input-meeting-location\"\n                  value={formData.location}\n                  onChange={(e) => setFormData({ ...formData, location: e.target.value })}\n                  placeholder=\"Contoh: Ruang Meeting A, Lantai 2\"\n                  required\n                />\n              </div>\n              \n              <div className=\"flex gap-2 pt-4\">\n                <Button \n                  type=\"submit\" \n                  disabled={createMeetingMutation.isPending}\n                  data-testid=\"button-submit-meeting\"\n                  className=\"bg-red-600 hover:bg-red-700\"\n                >\n                  {createMeetingMutation.isPending ? \"Membuat...\" : \"Buat Meeting\"}\n                </Button>\n                <Button \n                  type=\"button\" \n                  variant=\"outline\"\n                  onClick={() => setIsCreateOpen(false)}\n                  data-testid=\"button-cancel-meeting\"\n                >\n                  Batal\n                </Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Calendar className=\"w-5 h-5\" />\n            Daftar Meeting\n          </CardTitle>\n          <CardDescription>\n            {meetings.length} meeting tersedia\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {meetings.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <Calendar className=\"w-12 h-12 text-gray-400 mx-auto mb-4\" />\n              <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-2\">\n                Belum ada meeting\n              </h3>\n              <p className=\"text-gray-600 dark:text-gray-400 mb-4\">\n                Buat meeting pertama untuk mulai menggunakan sistem absensi QR code\n              </p>\n              <Button \n                onClick={() => setIsCreateOpen(true)}\n                className=\"bg-red-600 hover:bg-red-700\"\n                data-testid=\"button-create-first-meeting\"\n              >\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Buat Meeting Pertama\n              </Button>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Meeting</TableHead>\n                  <TableHead>Tanggal & Waktu</TableHead>\n                  <TableHead>Lokasi</TableHead>\n                  <TableHead>Penyelenggara</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead>Aksi</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {meetings.map((meeting: Meeting) => (\n                  <TableRow key={meeting.id}>\n                    <TableCell>\n                      <div>\n                        <div className=\"font-medium text-gray-900 dark:text-white\">\n                          {meeting.title}\n                        </div>\n                        {meeting.description && (\n                          <div className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\n                            {meeting.description}\n                          </div>\n                        )}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2 text-sm\">\n                        <Calendar className=\"w-4 h-4 text-gray-400\" />\n                        {new Date(meeting.date).toLocaleDateString('id-ID')}\n                      </div>\n                      <div className=\"flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 mt-1\">\n                        <Clock className=\"w-4 h-4\" />\n                        {meeting.startTime} - {meeting.endTime}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2 text-sm\">\n                        <MapPin className=\"w-4 h-4 text-gray-400\" />\n                        {meeting.location}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2 text-sm\">\n                        <User className=\"w-4 h-4 text-gray-400\" />\n                        {meeting.organizer}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      {getStatusBadge(meeting.status)}\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => {\n                            setSelectedMeeting(meeting);\n                            setIsQrOpen(true);\n                          }}\n                          data-testid={`button-view-qr-${meeting.id}`}\n                          title=\"Lihat QR Code\"\n                        >\n                          <QrCode className=\"w-4 h-4\" />\n                        </Button>\n                        \n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => downloadQRCode(meeting)}\n                          data-testid={`button-download-qr-${meeting.id}`}\n                          title=\"Download QR Code\"\n                        >\n                          <Download className=\"w-4 h-4\" />\n                        </Button>\n                        \n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => {\n                            setSelectedMeeting(meeting);\n                            setIsAttendanceOpen(true);\n                          }}\n                          data-testid={`button-view-attendance-${meeting.id}`}\n                          title=\"Lihat Kehadiran\"\n                        >\n                          <Users className=\"w-4 h-4\" />\n                        </Button>\n                        \n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => openPhotoDialog(meeting)}\n                          data-testid={`button-upload-photos-${meeting.id}`}\n                          title=\"Upload Foto\"\n                        >\n                          <Camera className=\"w-4 h-4\" />\n                        </Button>\n                        \n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => handleDelete(meeting)}\n                          data-testid={`button-delete-meeting-${meeting.id}`}\n                          title=\"Hapus Meeting\"\n                        >\n                          <Trash2 className=\"w-4 h-4 text-red-600\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* QR Code Dialog */}\n      <Dialog open={isQrOpen} onOpenChange={setIsQrOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>QR Code Meeting</DialogTitle>\n            <DialogDescription>\n              QR code untuk absensi meeting: {selectedMeeting?.title}\n            </DialogDescription>\n          </DialogHeader>\n          \n          {selectedMeeting?.qrToken && (\n            <QRCodeDisplay meeting={selectedMeeting} />\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Attendance Dialog */}\n      <Dialog open={isAttendanceOpen} onOpenChange={setIsAttendanceOpen}>\n        <DialogContent className=\"max-w-4xl\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center justify-between\">\n              <span>Daftar Kehadiran Meeting</span>\n              {attendanceData && attendanceData.attendance.length > 0 && (\n                <Button\n                  onClick={downloadAttendanceReport}\n                  size=\"sm\"\n                  className=\"bg-red-600 hover:bg-red-700\"\n                  data-testid=\"button-download-attendance-report\"\n                >\n                  <FileText className=\"w-4 h-4 mr-2\" />\n                  Download PDF\n                </Button>\n              )}\n            </DialogTitle>\n            <DialogDescription>\n              Meeting: {selectedMeeting?.title} - {attendanceData?.totalAttendees || 0} peserta hadir\n            </DialogDescription>\n          </DialogHeader>\n          \n          {attendanceData?.attendance?.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <Users className=\"w-12 h-12 text-gray-400 mx-auto mb-4\" />\n              <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-2\">\n                Belum ada peserta yang hadir\n              </h3>\n              <p className=\"text-gray-600 dark:text-gray-400\">\n                Peserta dapat scan QR code untuk melakukan absensi\n              </p>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Nama Karyawan</TableHead>\n                  <TableHead>NIK</TableHead>\n                  <TableHead>Department</TableHead>\n                  <TableHead>Meeting</TableHead>\n                  <TableHead>Tanggal Scan</TableHead>\n                  <TableHead>Waktu Scan</TableHead>\n                  <TableHead>Device</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {attendanceData?.attendance?.map((att: any) => (\n                  <TableRow key={att.id}>\n                    <TableCell className=\"font-medium\">\n                      {att.attendanceType === 'manual_entry' ? att.manualName : (att.employee?.name || 'Unknown')}\n                    </TableCell>\n                    <TableCell>{att.attendanceType === 'manual_entry' ? '-' : (att.employee?.id || '-')}</TableCell>\n                    <TableCell>{att.attendanceType === 'manual_entry' ? att.manualDepartment : (att.employee?.department || '-')}</TableCell>\n                    <TableCell className=\"max-w-[200px]\">\n                      <div className=\"text-sm font-medium truncate\">\n                        {selectedMeeting?.title || '-'}\n                      </div>\n                      <div className=\"text-xs text-gray-600 dark:text-gray-400\">\n                        {selectedMeeting?.location || '-'}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"text-sm\">\n                        {new Date(att.scanDate).toLocaleDateString('id-ID')}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2 text-sm\">\n                        <Clock className=\"w-4 h-4 text-gray-400\" />\n                        {att.scanTime} WITA\n                      </div>\n                    </TableCell>\n                    <TableCell className=\"text-sm text-gray-600 dark:text-gray-400 max-w-[150px]\">\n                      <div className=\"truncate\" title={att.deviceInfo}>\n                        {att.deviceInfo}\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Photo Upload Dialog */}\n      <Dialog open={isPhotoDialogOpen} onOpenChange={setIsPhotoDialogOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Camera className=\"w-5 h-5\" />\n              Upload Foto Meeting\n            </DialogTitle>\n            <DialogDescription>\n              Upload foto dokumentasi untuk meeting: {selectedMeeting?.title} (Maksimal 4 foto)\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4\">\n            {/* Existing Photos */}\n            {selectedMeeting?.meetingPhotos && selectedMeeting.meetingPhotos.length > 0 && (\n              <div>\n                <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block\">\n                  Foto yang Sudah Diupload ({selectedMeeting.meetingPhotos.length}/4)\n                </Label>\n                <div className=\"grid grid-cols-2 gap-3 mb-4\">\n                  {selectedMeeting.meetingPhotos.map((photoPath, index) => (\n                    <div\n                      key={index}\n                      className=\"relative group\"\n                      data-testid={`existing-photo-${index}`}\n                    >\n                      <div className=\"aspect-square rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700\">\n                        <img\n                          src={photoPath}\n                          alt={`Foto meeting ${index + 1}`}\n                          className=\"w-full h-full object-cover\"\n                          data-testid={`img-existing-photo-${index}`}\n                        />\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n            \n            {/* Upload New Photos */}\n            <div>\n              <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center\">\n                <Upload className=\"w-4 h-4 mr-2\" />\n                Upload Foto Baru ({(selectedMeeting?.meetingPhotos?.length || 0) + uploadedPhotos.length}/4)\n              </Label>\n              \n              <div className=\"space-y-3\">\n                {/* File Input */}\n                <div>\n                  <Input\n                    type=\"file\"\n                    accept=\"image/*\"\n                    multiple\n                    onChange={(e) => handlePhotoSelect(e.target.files)}\n                    className=\"hidden\"\n                    id=\"meeting-photos-input\"\n                    data-testid=\"input-meeting-photos\"\n                    disabled={(selectedMeeting?.meetingPhotos?.length || 0) + uploadedPhotos.length >= 4}\n                  />\n                  <label\n                    htmlFor=\"meeting-photos-input\"\n                    className={`flex items-center justify-center w-full p-4 border-2 border-dashed rounded-lg cursor-pointer transition-colors ${\n                      (selectedMeeting?.meetingPhotos?.length || 0) + uploadedPhotos.length >= 4\n                        ? 'border-gray-300 bg-gray-100 cursor-not-allowed text-gray-500 dark:bg-gray-800 dark:border-gray-600'\n                        : 'border-blue-300 hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 text-blue-600 dark:text-blue-400'\n                    }`}\n                    data-testid=\"label-upload-photos\"\n                  >\n                    <Upload className=\"w-5 h-5 mr-2\" />\n                    {(selectedMeeting?.meetingPhotos?.length || 0) + uploadedPhotos.length >= 4\n                      ? 'Maksimal 4 foto tercapai'\n                      : `Pilih foto (${(selectedMeeting?.meetingPhotos?.length || 0) + uploadedPhotos.length}/4)`\n                    }\n                  </label>\n                </div>\n                \n                {/* New Photos Preview Grid */}\n                {uploadedPhotos.length > 0 && (\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    {photoPreviewUrls.map((previewUrl, index) => (\n                      <div\n                        key={index}\n                        className=\"relative group\"\n                        data-testid={`new-photo-preview-${index}`}\n                      >\n                        <div className=\"aspect-square rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700\">\n                          <img\n                            src={previewUrl}\n                            alt={`Preview foto ${index + 1}`}\n                            className=\"w-full h-full object-cover\"\n                            data-testid={`img-new-photo-preview-${index}`}\n                          />\n                        </div>\n                        \n                        {/* Delete button */}\n                        <button\n                          onClick={() => removePhoto(index)}\n                          className=\"absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600\"\n                          data-testid={`button-remove-new-photo-${index}`}\n                          title=\"Hapus foto\"\n                        >\n                          <X className=\"w-3 h-3\" />\n                        </button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n                \n                {uploadedPhotos.length > 0 && (\n                  <p className=\"text-xs text-gray-600 dark:text-gray-400\">\n                    {uploadedPhotos.length} foto siap diupload\n                  </p>\n                )}\n              </div>\n            </div>\n            \n            {/* Action Buttons */}\n            <div className=\"flex gap-2 pt-4\">\n              <Button\n                onClick={handlePhotoUpload}\n                disabled={uploadedPhotos.length === 0 || uploadPhotosMutation.isPending}\n                className=\"bg-red-600 hover:bg-red-700 flex-1\"\n                data-testid=\"button-upload-photos\"\n              >\n                {uploadPhotosMutation.isPending ? (\n                  <>\n                    <Upload className=\"w-4 h-4 mr-2 animate-spin\" />\n                    Mengupload...\n                  </>\n                ) : (\n                  <>\n                    <Upload className=\"w-4 h-4 mr-2\" />\n                    Upload {uploadedPhotos.length} Foto\n                  </>\n                )}\n              </Button>\n              \n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setIsPhotoDialogOpen(false);\n                  setUploadedPhotos([]);\n                  setPhotoPreviewUrls([]);\n                }}\n                data-testid=\"button-cancel-photo-upload\"\n              >\n                Batal\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","path":null,"size_bytes":39375,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/lib/meeting-pdf-utils.ts":{"content":"import jsPDF from 'jspdf';\nimport autoTable from 'jspdf-autotable';\n\ninterface Employee {\n  id: string;\n  name: string;\n  position?: string;\n  department?: string;\n}\n\ninterface MeetingAttendance {\n  id: string;\n  meetingId: string;\n  employeeId: string | null;\n  scanTime: string;\n  scanDate: string;\n  deviceInfo?: string | null;\n  attendanceType: string;\n  manualName?: string | null;\n  manualPosition?: string | null;\n  manualDepartment?: string | null;\n  employee?: Employee;\n}\n\ninterface Meeting {\n  id: string;\n  title: string;\n  description?: string | null;\n  date: string;\n  startTime: string;\n  endTime: string;\n  location: string;\n  organizer: string;\n  status: string;\n  meetingPhotos?: string[] | null;\n}\n\ninterface MeetingAttendanceData {\n  meeting: Meeting;\n  attendance: MeetingAttendance[];\n  totalAttendees: number;\n}\n\n// Helper function to convert image URL to base64 with format detection\nasync function imageUrlToBase64(url: string): Promise<{ data: string; format: 'JPEG' | 'PNG' }> {\n  try {\n    const response = await fetch(url);\n    const blob = await response.blob();\n    const mimeType = blob.type;\n    \n    // Detect format from MIME type\n    let format: 'JPEG' | 'PNG' = 'JPEG';\n    if (mimeType === 'image/png') {\n      format = 'PNG';\n    } else if (mimeType === 'image/jpeg' || mimeType === 'image/jpg') {\n      format = 'JPEG';\n    }\n    \n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onloadend = () => resolve({ \n        data: reader.result as string, \n        format \n      });\n      reader.onerror = reject;\n      reader.readAsDataURL(blob);\n    });\n  } catch (error) {\n    console.error('Error converting image to base64:', error);\n    throw error;\n  }\n}\n\n// Helper function to add meeting photos page - 2 FOTO LANDSCAPE PER HALAMAN\nasync function addMeetingPhotosPages(pdf: jsPDF, photoUrls: string[]): Promise<void> {\n  // Split photos into groups of 2 (2 photos per page)\n  const photosPerPage = 2;\n  const photoGroups: string[][] = [];\n  \n  for (let i = 0; i < photoUrls.length; i += photosPerPage) {\n    photoGroups.push(photoUrls.slice(i, i + photosPerPage));\n  }\n  \n  // Get base page number before adding photo pages\n  const basePage = pdf.getNumberOfPages();\n  \n  // Process each group on a separate page\n  for (let groupIndex = 0; groupIndex < photoGroups.length; groupIndex++) {\n    const group = photoGroups[groupIndex];\n    \n    // Add new page in landscape orientation\n    pdf.addPage('landscape');\n    \n    const pageWidth = pdf.internal.pageSize.width;\n    const pageHeight = pdf.internal.pageSize.height;\n    const margin = 15; // Margin minimal untuk maksimalkan foto\n    \n    // ==================== HEADER SECTION ====================\n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(18);\n    pdf.setTextColor(220, 38, 38); // Red color\n    pdf.text('Foto Meeting', pageWidth / 2, margin + 8, { align: 'center' });\n    \n    // Underline dengan garis merah\n    pdf.setLineWidth(2);\n    pdf.setDrawColor(220, 38, 38);\n    pdf.line(margin + 50, margin + 12, pageWidth - margin - 50, margin + 12);\n    \n    const yStart = margin + 28; // Start position untuk foto (lebih rapat ke header)\n    \n    // ==================== LAYOUT 2 FOTO VERTIKAL (ATAS-BAWAH) ====================\n    // Calculate dimensions untuk 2 foto vertikal dalam A4 landscape\n    const spaceBetween = 8; // Jarak tipis antar foto (atas-bawah)\n    const availableWidth = pageWidth - (2 * margin);\n    const availableHeight = pageHeight - yStart - margin;\n    \n    // Lebar penuh untuk setiap foto\n    const maxPhotoWidth = availableWidth;\n    \n    // Calculate slot height untuk setiap foto\n    const slotHeight = (availableHeight - spaceBetween) / 2;\n    \n    // Process each photo in the group (max 2)\n    for (let index = 0; index < group.length; index++) {\n      const photoUrl = group[index];\n      \n      try {\n        // Load and convert image to base64 with format detection\n        const { data: base64Image, format } = await imageUrlToBase64(photoUrl);\n        \n        // Get image properties\n        const imageProps = pdf.getImageProperties(base64Image);\n        const aspectRatio = imageProps.width / imageProps.height;\n        \n        // Calculate optimal dimensions dengan aspect ratio terjaga\n        // Start dengan lebar penuh\n        let finalWidth = maxPhotoWidth;\n        let finalHeight = finalWidth / aspectRatio;\n        \n        // Jika tinggi melebihi slot height, scale down berdasarkan tinggi\n        if (finalHeight > slotHeight) {\n          finalHeight = slotHeight;\n          finalWidth = finalHeight * aspectRatio;\n        }\n        \n        // Calculate slot top position untuk foto ini\n        const slotTop = yStart + (index * (slotHeight + spaceBetween));\n        \n        // Center foto secara vertikal dalam slot\n        const photoY = slotTop + (slotHeight - finalHeight) / 2;\n        \n        // Center foto secara horizontal\n        const photoX = margin + (maxPhotoWidth - finalWidth) / 2;\n        \n        // Add image to PDF with detected format (JPEG or PNG)\n        pdf.addImage(base64Image, format, photoX, photoY, finalWidth, finalHeight);\n        \n        // Add border around image untuk tampilan professional\n        pdf.setDrawColor(200, 200, 200);\n        pdf.setLineWidth(0.8);\n        pdf.rect(photoX, photoY, finalWidth, finalHeight);\n        \n      } catch (error) {\n        console.error('Error adding image to PDF:', error);\n        \n        // Add placeholder jika foto gagal dimuat\n        const slotTop = yStart + (index * (slotHeight + spaceBetween));\n        pdf.setFillColor(240, 240, 240);\n        pdf.rect(margin, slotTop, maxPhotoWidth, slotHeight, 'F');\n        \n        pdf.setFont('helvetica', 'normal');\n        pdf.setFontSize(12);\n        pdf.setTextColor(128, 128, 128);\n        pdf.text('Gambar tidak dapat dimuat', pageWidth / 2, slotTop + slotHeight / 2, { align: 'center' });\n      }\n    }\n    \n    // Add page footer\n    const footerY = pageHeight - 20;\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(8);\n    pdf.setTextColor(107, 114, 128);\n    pdf.text(`Halaman ${basePage + groupIndex + 1}`, pageWidth / 2, footerY, { align: 'center' });\n  }\n}\n\nexport async function generateMeetingAttendancePDF(data: MeetingAttendanceData): Promise<void> {\n  console.log('Starting PDF generation with data:', {\n    meeting: data.meeting.title,\n    attendanceCount: data.attendance.length,\n    totalAttendees: data.totalAttendees\n  });\n\n  try {\n    // Validate data first\n    if (!data || !data.meeting) {\n      throw new Error('Data meeting tidak valid');\n    }\n\n    const pdf = new jsPDF();\n    const pageWidth = pdf.internal.pageSize.width;\n    const pageHeight = pdf.internal.pageSize.height;\n    const margin = 20;\n    const currentDateTime = new Date();\n\n    // ==================== MODERN HEADER SECTION ====================\n    // Clean background with subtle shadow effect\n    pdf.setFillColor(250, 250, 250);\n    pdf.rect(0, 0, pageWidth, 50, 'F');\n    \n    // Company branding area - subtle\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(9);\n    pdf.setTextColor(120, 120, 120);\n    pdf.text('PT. GECL - Sistem Manajemen Meeting', margin, 12);\n    \n    // Print timestamp - top right, modern styling\n    pdf.setFontSize(9);\n    pdf.setTextColor(100, 100, 100);\n    pdf.text(`Dicetak pada: ${currentDateTime.toLocaleDateString('id-ID')} ${currentDateTime.toLocaleTimeString('id-ID')}`, pageWidth - margin, 12, { align: 'right' });\n\n    // Main title - MODERN & BOLD with shadow effect\n    pdf.setFontSize(24);\n    pdf.setFont('helvetica', 'bold');\n    pdf.setTextColor(220, 38, 38); // Modern red\n    pdf.text('LAPORAN KEHADIRAN MEETING', pageWidth / 2, 32, { align: 'center' });\n\n    // Elegant underline - single bold line\n    pdf.setLineWidth(2);\n    pdf.setDrawColor(220, 38, 38); // Modern red\n    pdf.line(margin + 30, 37, pageWidth - margin - 30, 37);\n    \n    // Subtle accent line\n    pdf.setLineWidth(0.5);\n    pdf.setDrawColor(156, 163, 175); // Cool gray\n    pdf.line(margin, 42, pageWidth - margin, 42);\n\n    // ==================== MODERN INFORMATION CARD ====================\n    let yPosition = 58;\n    const cardHeight = 65;\n    const cardMargin = margin + 5;\n    const cardWidth = pageWidth - 2 * cardMargin;\n    \n    // Modern card with shadow effect\n    pdf.setFillColor(248, 249, 250);\n    pdf.rect(cardMargin, yPosition, cardWidth, cardHeight, 'F');\n    \n    // Subtle border with modern styling\n    pdf.setLineWidth(0.8);\n    pdf.setDrawColor(229, 231, 235);\n    pdf.rect(cardMargin, yPosition, cardWidth, cardHeight, 'S');\n    \n    // Left accent line - modern red\n    pdf.setLineWidth(4);\n    pdf.setDrawColor(220, 38, 38);\n    pdf.line(cardMargin, yPosition, cardMargin, yPosition + cardHeight);\n    \n    // Modern header section\n    pdf.setFillColor(220, 38, 38);\n    pdf.rect(cardMargin + 1, yPosition + 1, cardWidth - 2, 18, 'F');\n    pdf.setFontSize(12);\n    pdf.setFont('helvetica', 'bold');\n    pdf.setTextColor(255, 255, 255);\n    pdf.text('INFORMASI MEETING', cardMargin + 10, yPosition + 12);\n    \n    // Content area with proper spacing\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(9);\n    pdf.setTextColor(55, 65, 81);\n    yPosition += 25;\n    const lineHeight = 8;\n    \n    const meetingDate = new Date(data.meeting.date);\n    \n    // Compact 2-column layout\n    const leftColX = cardMargin + 10;\n    const rightColX = cardMargin + cardWidth / 2 + 5;\n    \n    // Left column - compact styling\n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(8);\n    pdf.setTextColor(107, 114, 128);\n    pdf.text('Judul Meeting', leftColX, yPosition);\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(9);\n    pdf.setTextColor(31, 41, 55);\n    pdf.text(data.meeting.title.length > 30 ? data.meeting.title.substring(0, 27) + '...' : data.meeting.title, leftColX, yPosition + 5);\n    \n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(8);\n    pdf.setTextColor(107, 114, 128);\n    pdf.text('Tanggal', leftColX, yPosition + lineHeight * 2);\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(9);\n    pdf.setTextColor(31, 41, 55);\n    pdf.text(meetingDate.toLocaleDateString('id-ID'), leftColX, yPosition + lineHeight * 2 + 5);\n    \n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(8);\n    pdf.setTextColor(107, 114, 128);\n    pdf.text('Waktu', leftColX, yPosition + lineHeight * 4);\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(9);\n    pdf.setTextColor(31, 41, 55);\n    pdf.text(`${data.meeting.startTime} - ${data.meeting.endTime}`, leftColX, yPosition + lineHeight * 4 + 5);\n    \n    // Right column\n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(8);\n    pdf.setTextColor(107, 114, 128);\n    pdf.text('Lokasi', rightColX, yPosition);\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(9);\n    pdf.setTextColor(31, 41, 55);\n    pdf.text(data.meeting.location, rightColX, yPosition + 5);\n    \n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(8);\n    pdf.setTextColor(107, 114, 128);\n    pdf.text('Penyelenggara', rightColX, yPosition + lineHeight * 2);\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(9);\n    pdf.setTextColor(31, 41, 55);\n    pdf.text(data.meeting.organizer, rightColX, yPosition + lineHeight * 2 + 5);\n    \n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(8);\n    pdf.setTextColor(107, 114, 128);\n    pdf.text('Total Peserta Hadir', rightColX, yPosition + lineHeight * 4);\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(9);\n    pdf.setTextColor(220, 38, 38);\n    pdf.text(`${data.totalAttendees} orang`, rightColX, yPosition + lineHeight * 4 + 5);\n\n    yPosition += cardHeight + 18;\n\n    // ==================== CLEAN TABLE SECTION ====================\n    // Simple section header\n    pdf.setFillColor(249, 250, 251);\n    pdf.rect(margin, yPosition - 5, pageWidth - 2 * margin, 18, 'F');\n    \n    // Left accent line\n    pdf.setLineWidth(3);\n    pdf.setDrawColor(220, 38, 38);\n    pdf.line(margin, yPosition - 5, margin, yPosition + 13);\n    \n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(14);\n    pdf.setTextColor(220, 38, 38);\n    pdf.text('DAFTAR KEHADIRAN', margin + 8, yPosition + 6);\n    \n    // Compact participant count badge\n    pdf.setFillColor(220, 38, 38);\n    pdf.roundedRect(pageWidth - margin - 55, yPosition - 2, 45, 10, 2, 2, 'F');\n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(8);\n    pdf.setTextColor(255, 255, 255);\n    pdf.text(`${data.totalAttendees} Peserta`, pageWidth - margin - 52, yPosition + 3);\n    \n    yPosition += 20;\n\n    if (data.attendance && data.attendance.length > 0) {\n      console.log(`ðŸ“Š PDF: Processing ${data.attendance.length} attendance records for table`);\n      \n      const tableData = data.attendance.map((attendance, index) => {\n        const row = [\n          (index + 1).toString(), // Simple number format\n          attendance.attendanceType === 'manual_entry' ? '-' : (attendance.employee?.id || '-'),\n          attendance.attendanceType === 'manual_entry' ? (attendance.manualName || '-') : (attendance.employee?.name || 'Unknown'),\n          attendance.attendanceType === 'manual_entry' ? (attendance.manualPosition || '-') : (attendance.employee?.position || '-'),\n          attendance.attendanceType === 'manual_entry' ? (attendance.manualDepartment || '-') : (attendance.employee?.department || '-'),\n          new Date(attendance.scanDate).toLocaleDateString('id-ID'),\n          attendance.scanTime ? `${attendance.scanTime} WITA` : '-' // Single line format\n        ];\n        console.log(`ðŸ“ Row ${index + 1}:`, row);\n        return row;\n      });\n\n      console.log(`âœ… PDF: Created ${tableData.length} rows for table`);\n\n      autoTable(pdf, {\n        head: [['NO', 'NIK', 'Nama Karyawan', 'Position', 'Department', 'Tanggal', 'Waktu']],\n        body: tableData,\n        startY: yPosition,\n        theme: 'grid',\n        styles: {\n          fontSize: 7,\n          cellPadding: 3,\n          lineColor: [229, 231, 235],\n          lineWidth: 0.3,\n          font: 'helvetica',\n          textColor: [55, 65, 81],\n          minCellHeight: 12,\n          valign: 'middle',\n          overflow: 'hidden',\n          halign: 'center' // Default alignment untuk semua cell\n        },\n        headStyles: {\n          fillColor: [220, 38, 38],\n          textColor: [255, 255, 255],\n          fontStyle: 'bold',\n          fontSize: 8,\n          halign: 'center',\n          valign: 'middle',\n          cellPadding: 3,\n          minCellHeight: 12,\n          lineWidth: 0.5,\n          lineColor: [180, 30, 30],\n          overflow: 'hidden'\n        },\n        alternateRowStyles: {\n          fillColor: [249, 250, 251]\n        },\n        columnStyles: {\n          0: { cellWidth: 12, halign: 'center', valign: 'middle' },  // NO\n          1: { cellWidth: 20, halign: 'center', valign: 'middle' }, // NIK\n          2: { cellWidth: 40, halign: 'left', valign: 'middle', cellPadding: { left: 2, right: 2 } },   // Nama Karyawan\n          3: { cellWidth: 25, halign: 'left', valign: 'middle', cellPadding: { left: 2, right: 2 } },   // Position\n          4: { cellWidth: 30, halign: 'left', valign: 'middle', cellPadding: { left: 2, right: 2 } },   // Department\n          5: { cellWidth: 20, halign: 'center', valign: 'middle' }, // Tanggal\n          6: { cellWidth: 25, halign: 'center', valign: 'middle' }  // Waktu\n        },\n        margin: { left: margin, right: margin },\n        tableWidth: 172, // Total column width: 12+20+40+25+30+20+25 = 172\n        showHead: 'everyPage'\n      });\n    } else {\n      // Modern empty state message\n      pdf.setFillColor(249, 250, 251);\n      pdf.rect(margin, yPosition, pageWidth - 2 * margin, 30, 'F');\n      pdf.setLineWidth(1);\n      pdf.setDrawColor(229, 231, 235);\n      pdf.rect(margin, yPosition, pageWidth - 2 * margin, 30, 'S');\n      \n      pdf.setFont('helvetica', 'normal');\n      pdf.setFontSize(11);\n      pdf.setTextColor(107, 114, 128);\n      pdf.text('Belum ada peserta yang hadir pada meeting ini.', pageWidth / 2, yPosition + 18, { align: 'center' });\n    }\n\n    // ==================== MODERN FOOTER SECTION ====================\n    const footerY = pageHeight - 40;\n    \n    // Clean footer background\n    pdf.setFillColor(249, 250, 251);\n    pdf.rect(0, footerY - 10, pageWidth, 50, 'F');\n    \n    // Elegant separator line\n    pdf.setLineWidth(1);\n    pdf.setDrawColor(220, 38, 38);\n    pdf.line(margin, footerY - 5, pageWidth - margin, footerY - 5);\n    \n    // Modern footer text - left aligned\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(8);\n    pdf.setTextColor(107, 114, 128);\n    pdf.text('Laporan dibuat oleh Sistem Manajemen Meeting PT.GECL', margin, footerY + 5);\n    \n    // Print timestamp - right aligned as requested\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(8);\n    pdf.setTextColor(107, 114, 128);\n    pdf.text(`Dicetak pada: ${currentDateTime.toLocaleDateString('id-ID')} ${currentDateTime.toLocaleTimeString('id-ID')}`, pageWidth - margin, footerY + 5, { align: 'right' });\n    \n    // Modern signature area - simplified and elegant\n    const signatureX = pageWidth - 100;\n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(9);\n    pdf.setTextColor(55, 65, 81);\n    pdf.text('Mengetahui,', signatureX, footerY + 15);\n    \n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(8);\n    pdf.setTextColor(107, 114, 128);\n    pdf.text('Penyelenggara Meeting', signatureX, footerY + 22);\n    \n    // Clean signature line\n    pdf.setLineWidth(0.8);\n    pdf.setDrawColor(156, 163, 175);\n    pdf.line(signatureX, footerY + 30, signatureX + 70, footerY + 30);\n    \n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(8);\n    pdf.setTextColor(55, 65, 81);\n    pdf.text(`(${data.meeting.organizer})`, signatureX + 5, footerY + 37);\n\n    // ==================== ADD MEETING PHOTOS (AFTER ATTENDANCE LIST) ====================\n    // Check if meeting has photos and add them after attendance list\n    if (data.meeting.meetingPhotos && data.meeting.meetingPhotos.length > 0) {\n      console.log(`Adding ${data.meeting.meetingPhotos.length} meeting photos to PDF`);\n      await addMeetingPhotosPages(pdf, data.meeting.meetingPhotos);\n    }\n\n    // Generate professional filename\n    const dateStr = meetingDate.toISOString().split('T')[0];\n    const titleStr = (data.meeting.title || 'meeting').replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();\n    const filename = `Laporan-Kehadiran-Meeting-${titleStr}-${dateStr}.pdf`;\n\n    console.log('PDF generation completed, saving as:', filename);\n    pdf.save(filename);\n\n  } catch (error) {\n    console.error('Error in PDF generation:', error);\n    throw new Error(`Gagal membuat PDF: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\nfunction getMeetingStatusLabel(status: string): string {\n  const statusLabels: { [key: string]: string } = {\n    scheduled: 'Terjadwal',\n    ongoing: 'Berlangsung',\n    completed: 'Selesai',\n    cancelled: 'Dibatalkan'\n  };\n  return statusLabels[status] || status;\n}\n\nfunction getShortDeviceInfo(deviceInfo: string): string {\n  // Extract browser name and OS from user agent string\n  if (deviceInfo.includes('Chrome')) return 'Chrome';\n  if (deviceInfo.includes('Firefox')) return 'Firefox';\n  if (deviceInfo.includes('Safari')) return 'Safari';\n  if (deviceInfo.includes('Edge')) return 'Edge';\n  if (deviceInfo.includes('Mobile')) return 'Mobile';\n  if (deviceInfo.includes('Android')) return 'Android';\n  if (deviceInfo.includes('iPhone')) return 'iPhone';\n  return 'Other';\n}\n\nexport function generateMeetingQRCodePDF(meeting: Meeting, qrDataURL: string): void {\n  const pdf = new jsPDF();\n  const pageWidth = pdf.internal.pageSize.width;\n  const pageHeight = pdf.internal.pageSize.height;\n  const margin = 20;\n\n  // Header\n  pdf.setFontSize(24);\n  pdf.setFont('helvetica', 'bold');\n  pdf.text('QR CODE MEETING', pageWidth / 2, 40, { align: 'center' });\n\n  // Meeting info\n  pdf.setFontSize(16);\n  pdf.setFont('helvetica', 'bold');\n  pdf.text(meeting.title, pageWidth / 2, 60, { align: 'center' });\n\n  pdf.setFontSize(12);\n  pdf.setFont('helvetica', 'normal');\n  \n  let yPos = 80;\n  pdf.text(`Tanggal: ${new Date(meeting.date).toLocaleDateString('id-ID')}`, pageWidth / 2, yPos, { align: 'center' });\n  yPos += 10;\n  pdf.text(`Waktu: ${meeting.startTime} - ${meeting.endTime}`, pageWidth / 2, yPos, { align: 'center' });\n  yPos += 10;\n  pdf.text(`Lokasi: ${meeting.location}`, pageWidth / 2, yPos, { align: 'center' });\n  yPos += 30;\n\n  // QR Code\n  if (qrDataURL) {\n    const qrSize = 120;\n    const qrX = (pageWidth - qrSize) / 2;\n    const qrY = yPos;\n    \n    pdf.addImage(qrDataURL, 'PNG', qrX, qrY, qrSize, qrSize);\n    yPos += qrSize + 20;\n  }\n\n  // Instructions\n  pdf.setFontSize(14);\n  pdf.setFont('helvetica', 'bold');\n  pdf.text('CARA ABSENSI:', pageWidth / 2, yPos, { align: 'center' });\n  yPos += 15;\n\n  pdf.setFontSize(10);\n  pdf.setFont('helvetica', 'normal');\n  \n  const instructions = [\n    '1. Buka halaman \"Scan QR Meeting\" di aplikasi atau browser mobile',\n    '2. Masukkan NIK karyawan pada form yang tersedia',\n    '3. Tekan tombol \"Mulai Scan QR Code\" untuk mengaktifkan kamera',\n    '4. Arahkan kamera ke QR code di atas hingga berhasil terbaca',\n    '5. Sistem akan otomatis mencatat kehadiran Anda di meeting ini'\n  ];\n\n  instructions.forEach((instruction, index) => {\n    pdf.text(instruction, margin, yPos + (index * 8));\n  });\n\n  // Footer\n  const footerY = pageHeight - 30;\n  pdf.setFontSize(8);\n  pdf.text(`Meeting ID: ${meeting.id}`, margin, footerY);\n  pdf.text(`Generated: ${new Date().toLocaleString('id-ID')}`, pageWidth - margin, footerY, { align: 'right' });\n\n  // Generate filename\n  const meetingDate = new Date(meeting.date).toISOString().split('T')[0];\n  const meetingTitle = meeting.title.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();\n  const filename = `meeting-qr-${meetingTitle}-${meetingDate}.pdf`;\n\n  // Download PDF\n  pdf.save(filename);\n}","path":null,"size_bytes":22039,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"server/objectStorage.ts":{"content":"import { Storage, File } from \"@google-cloud/storage\";\nimport { Response } from \"express\";\nimport { randomUUID } from \"crypto\";\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\n// The object storage client is used to interact with the object storage service.\nexport const objectStorageClient = new Storage({\n  credentials: {\n    audience: \"replit\",\n    subject_token_type: \"access_token\",\n    token_url: `${REPLIT_SIDECAR_ENDPOINT}/token`,\n    type: \"external_account\",\n    credential_source: {\n      url: `${REPLIT_SIDECAR_ENDPOINT}/credential`,\n      format: {\n        type: \"json\",\n        subject_token_field_name: \"access_token\",\n      },\n    },\n    universe_domain: \"googleapis.com\",\n  },\n  projectId: \"\",\n});\n\nexport class ObjectNotFoundError extends Error {\n  constructor() {\n    super(\"Object not found\");\n    this.name = \"ObjectNotFoundError\";\n    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);\n  }\n}\n\n// The object storage service is used to interact with the object storage service.\nexport class ObjectStorageService {\n  constructor() {}\n\n  // Gets the public object search paths.\n  getPublicObjectSearchPaths(): Array<string> {\n    const pathsStr = process.env.PUBLIC_OBJECT_SEARCH_PATHS || \"\";\n    const paths = Array.from(\n      new Set(\n        pathsStr\n          .split(\",\")\n          .map((path) => path.trim())\n          .filter((path) => path.length > 0)\n      )\n    );\n    if (paths.length === 0) {\n      throw new Error(\n        \"PUBLIC_OBJECT_SEARCH_PATHS not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PUBLIC_OBJECT_SEARCH_PATHS env var (comma-separated paths).\"\n      );\n    }\n    return paths;\n  }\n\n  // Gets the private object directory.\n  getPrivateObjectDir(): string {\n    const dir = process.env.PRIVATE_OBJECT_DIR || \"\";\n    if (!dir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n    return dir;\n  }\n\n  // Search for a public object from the search paths.\n  async searchPublicObject(filePath: string): Promise<File | null> {\n    for (const searchPath of this.getPublicObjectSearchPaths()) {\n      const fullPath = `${searchPath}/${filePath}`;\n\n      // Full path format: /<bucket_name>/<object_name>\n      const { bucketName, objectName } = parseObjectPath(fullPath);\n      const bucket = objectStorageClient.bucket(bucketName);\n      const file = bucket.file(objectName);\n\n      // Check if file exists\n      const [exists] = await file.exists();\n      if (exists) {\n        return file;\n      }\n    }\n\n    return null;\n  }\n\n  // Downloads an object to the response.\n  async downloadObject(file: File, res: Response, cacheTtlSec: number = 3600) {\n    try {\n      // Get file metadata\n      const [metadata] = await file.getMetadata();\n      \n      // Set appropriate headers\n      res.set({\n        \"Content-Type\": metadata.contentType || \"application/octet-stream\",\n        \"Content-Length\": metadata.size,\n        \"Cache-Control\": `public, max-age=${cacheTtlSec}`,\n      });\n\n      // Stream the file to the response\n      const stream = file.createReadStream();\n\n      stream.on(\"error\", (err) => {\n        console.error(\"Stream error:\", err);\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error streaming file\" });\n        }\n      });\n\n      stream.pipe(res);\n    } catch (error) {\n      console.error(\"Error downloading file:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ error: \"Error downloading file\" });\n      }\n    }\n  }\n\n  // Gets the upload URL for an object entity.\n  async getObjectEntityUploadURL(): Promise<string> {\n    const privateObjectDir = this.getPrivateObjectDir();\n    if (!privateObjectDir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n\n    const objectId = randomUUID();\n    const fullPath = `${privateObjectDir}/uploads/${objectId}`;\n\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n\n    // Sign URL for PUT method with TTL\n    return signObjectURL({\n      bucketName,\n      objectName,\n      method: \"PUT\",\n      ttlSec: 900,\n    });\n  }\n\n  // Gets the object entity file from the object path.\n  async getObjectEntityFile(objectPath: string): Promise<File> {\n    if (!objectPath.startsWith(\"/objects/\")) {\n      throw new ObjectNotFoundError();\n    }\n\n    const parts = objectPath.slice(1).split(\"/\");\n    if (parts.length < 2) {\n      throw new ObjectNotFoundError();\n    }\n\n    const entityId = parts.slice(1).join(\"/\");\n    let entityDir = this.getPrivateObjectDir();\n    if (!entityDir.endsWith(\"/\")) {\n      entityDir = `${entityDir}/`;\n    }\n    const objectEntityPath = `${entityDir}${entityId}`;\n    const { bucketName, objectName } = parseObjectPath(objectEntityPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const objectFile = bucket.file(objectName);\n    const [exists] = await objectFile.exists();\n    if (!exists) {\n      throw new ObjectNotFoundError();\n    }\n    return objectFile;\n  }\n\n  normalizeObjectEntityPath(rawPath: string): string {\n    if (!rawPath.startsWith(\"https://storage.googleapis.com/\")) {\n      return rawPath;\n    }\n  \n    // Extract the path from the URL by removing query parameters and domain\n    const url = new URL(rawPath);\n    const rawObjectPath = url.pathname;\n  \n    let objectEntityDir = this.getPrivateObjectDir();\n    if (!objectEntityDir.endsWith(\"/\")) {\n      objectEntityDir = `${objectEntityDir}/`;\n    }\n  \n    if (!rawObjectPath.startsWith(objectEntityDir)) {\n      return rawObjectPath;\n    }\n  \n    // Extract the entity ID from the path\n    const entityId = rawObjectPath.slice(objectEntityDir.length);\n    return `/objects/${entityId}`;\n  }\n}\n\nfunction parseObjectPath(path: string): {\n  bucketName: string;\n  objectName: string;\n} {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n\n  return {\n    bucketName,\n    objectName,\n  };\n}\n\nasync function signObjectURL({\n  bucketName,\n  objectName,\n  method,\n  ttlSec,\n}: {\n  bucketName: string;\n  objectName: string;\n  method: \"GET\" | \"PUT\" | \"DELETE\" | \"HEAD\";\n  ttlSec: number;\n}): Promise<string> {\n  const request = {\n    bucket_name: bucketName,\n    object_name: objectName,\n    method,\n    expires_at: new Date(Date.now() + ttlSec * 1000).toISOString(),\n  };\n  const response = await fetch(\n    `${REPLIT_SIDECAR_ENDPOINT}/object-storage/signed-object-url`,\n    {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(request),\n    }\n  );\n  if (!response.ok) {\n    throw new Error(\n      `Failed to sign object URL, errorcode: ${response.status}, ` +\n        `make sure you're running on Replit`\n    );\n  }\n\n  const { signed_url: signedURL } = await response.json();\n  return signedURL;\n}","path":null,"size_bytes":7158,"size_tokens":null},"client/src/lib/shift-utils.ts":{"content":"// Utility functions for shift determination and display\n\n// Function to get current local time (Indonesia timezone)\nexport function getCurrentTime(): Date {\n  const now = new Date();\n  // Convert to Indonesia timezone (WITA UTC+8)\n  const indonesiaOffset = 8 * 60; // 8 hours in minutes\n  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);\n  return new Date(utc + (indonesiaOffset * 60000));\n}\n\n// Function to get current local time string in HH:MM format (Indonesia timezone)\nexport function getCurrentTimeString(): string {\n  const now = new Date();\n  // Convert to Indonesia timezone (WITA UTC+8)\n  const indonesiaOffset = 8 * 60; // 8 hours in minutes\n  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);\n  const indonesiaTime = new Date(utc + (indonesiaOffset * 60000));\n  return `${indonesiaTime.getHours().toString().padStart(2, '0')}:${indonesiaTime.getMinutes().toString().padStart(2, '0')}`;\n}\n\nexport function determineShiftByTime(time: string): string {\n  const [hours, minutes] = time.split(':').map(Number);\n  const totalMinutes = hours * 60 + minutes;\n  \n  // UPDATED CRITERIA:\n  // Shift 1: 04:00-10:00 (240-600 menit)\n  // Shift 2: 16:00-22:00 (960-1320 menit)\n  \n  if (totalMinutes >= 960 && totalMinutes <= 1320) { // 16:00 to 22:00\n    return \"Shift 2\";\n  } else if (totalMinutes >= 240 && totalMinutes <= 600) { // 04:00 to 10:00\n    return \"Shift 1\";\n  } else {\n    return \"Shift 1\"; // Default to Shift 1 for other times\n  }\n}\n\nexport function isValidShiftTime(currentTime: string, scheduledShift: string): boolean {\n  const [hours, minutes] = currentTime.split(':').map(Number);\n  const totalMinutes = hours * 60 + minutes;\n  \n  if (scheduledShift === \"Shift 1\") {\n    // Shift 1: UPDATED CRITERIA - Hanya boleh scan antara jam 04:00 sampai 10:00\n    return totalMinutes >= 240 && totalMinutes <= 600;\n  } else if (scheduledShift === \"Shift 2\") {\n    // Shift 2: UPDATED CRITERIA - Hanya boleh scan antara jam 16:00 sampai 22:00  \n    return totalMinutes >= 960 && totalMinutes <= 1320;\n  }\n  \n  // STRICT: Diluar shift yang ditentukan tidak boleh absensi\n  return false;\n}\n\nexport function getShiftDescription(shift: string): string {\n  switch (shift) {\n    case \"Shift 1\":\n      return \"Shift 1 (04:00 - 10:00)\"; // UPDATED CRITERIA - Waktu window check-in sesuai validasi\n    case \"Shift 2\":\n      return \"Shift 2 (16:00 - 22:00)\"; // UPDATED CRITERIA - Waktu window check-in sesuai validasi\n    default:\n      return shift;\n  }\n}\n\n// Function to get allowed time range for a shift\nexport function getShiftTimeRange(shift: string): { start: string; end: string } {\n  switch (shift) {\n    case \"Shift 1\":\n      return { start: \"04:00\", end: \"10:00\" };\n    case \"Shift 2\":\n      return { start: \"16:00\", end: \"22:00\" };\n    default:\n      return { start: \"00:00\", end: \"23:59\" };\n  }\n}\n\n// Function to check if current time is outside all allowed shift times\nexport function isOutsideAllShiftTimes(currentTime: string): boolean {\n  const [hours, minutes] = currentTime.split(':').map(Number);\n  const totalMinutes = hours * 60 + minutes;\n  \n  // Check if time falls within any shift window - UPDATED CRITERIA\n  const isInShift1 = totalMinutes >= 240 && totalMinutes <= 600; // 04:00-10:00\n  const isInShift2 = totalMinutes >= 960 && totalMinutes <= 1320; // 16:00-22:00\n  \n  return !isInShift1 && !isInShift2;\n}\n\nexport function getCurrentShift(): string {\n  const currentTime = getCurrentTimeString();\n  return determineShiftByTime(currentTime);\n}\n\nexport function formatTimeWithShift(time: string): string {\n  const shift = determineShiftByTime(time);\n  return `${time} (${shift})`;\n}","path":null,"size_bytes":3636,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/pages/mobile-driver-view.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Search, User, Calendar, Clock, MapPin, ChevronDown, ChevronUp, Bell, AlertTriangle, TrendingUp, Activity, CheckCircle, XCircle, Shield, Loader2, Megaphone, Eye, Image as ImageIcon, ChevronRight, X, BellRing, BellOff } from \"lucide-react\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { usePushNotification } from \"@/hooks/use-push-notification\";\nimport { format } from \"date-fns\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\n\ninterface Employee {\n  id: string;\n  name: string;\n  position: string;\n  department: string;\n  investorGroup: string;\n  phone: string;\n}\n\ninterface RosterSchedule {\n  id: string;\n  employeeId: string;\n  date: string;\n  shift: string;\n  startTime: string;\n  endTime: string;\n  jamTidur: string;\n  fitToWork: string;\n  status: string;\n}\n\ninterface LeaveRequest {\n  id: string;\n  employeeId: string;\n  employeeName: string;\n  startDate: string;\n  endDate: string;\n  leaveType: string;\n  reason: string;\n  status: string;\n  createdAt: string;\n}\n\ninterface LeaveRosterMonitoring {\n  id: string;\n  nik: string;\n  name: string;\n  nomorLambung: string;\n  month: string;\n  investorGroup: string;\n  lastLeaveDate: string;\n  leaveOption: string;\n  monitoringDays: number;\n  onSite: string;\n  status: string;\n  nextLeaveDate: string;\n}\n\ninterface SimperMonitoring {\n  id: string;\n  employeeName: string;\n  nik: string;\n  simperBibExpiredDate: string | null;\n  simperTiaExpiredDate: string | null;\n  bibMonitoringDays?: number | null;\n  tiaMonitoringDays?: number | null;\n  bibStatus?: string;\n  tiaStatus?: string;\n}\n\ninterface Announcement {\n  id: string;\n  title: string;\n  content: string;\n  imageUrls?: string[] | null;\n  isActive: boolean;\n  createdBy: string;\n  createdByName: string;\n  createdAt: string;\n  isRead?: boolean;\n}\n\nexport default function MobileDriverView() {\n  // Get NIK from URL parameters\n  const urlParams = new URLSearchParams(window.location.search);\n  const nikFromUrl = urlParams.get('nik') || \"\";\n  \n  const [nik, setNik] = useState(nikFromUrl);\n  const [debouncedNik, setDebouncedNik] = useState(nikFromUrl);\n  const [searchEmployee, setSearchEmployee] = useState<Employee | null>(null);\n  const [suggestions, setSuggestions] = useState<Employee[]>([]);\n  const [activeTab, setActiveTab] = useState<'roster' | 'leave' | 'pemberitahuan' | 'simper'>('roster');\n  const [isSearching, setIsSearching] = useState(false);\n  \n  // Filter states untuk tab Roster\n  const [selectedMonth, setSelectedMonth] = useState<number | null>(null); // null = Semua\n  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());\n  const [selectedShift, setSelectedShift] = useState<string>('all'); // 'all', 'Shift 1', 'Shift 2'\n  const [showOvershiftOnly, setShowOvershiftOnly] = useState(false);\n  const [showCutiOnly, setShowCutiOnly] = useState(false);\n  \n  // State untuk dialog pengumuman\n  const [selectedAnnouncement, setSelectedAnnouncement] = useState<Announcement | null>(null);\n  const [announcementDialogOpen, setAnnouncementDialogOpen] = useState(false);\n  const [fullscreenImage, setFullscreenImage] = useState<string | null>(null);\n\n  // Push notification hook\n  const pushNotification = usePushNotification(searchEmployee?.id);\n\n  // Query untuk mencari employee berdasarkan NIK - OPTIMIZED\n  const { data: employees, isLoading: employeesLoading } = useQuery({\n    queryKey: [\"/api/employees\"],\n    enabled: true,\n    staleTime: 10 * 60 * 1000, // 10 minutes cache - employees data doesn't change often\n  });\n\n  // Query untuk roster berdasarkan employee yang dipilih - LAZY LOADING\n  const { data: rosterData, isLoading: rosterLoading } = useQuery({\n    queryKey: [\"/api/roster\", { employeeId: searchEmployee?.id }],\n    queryFn: async () => {\n      if (!searchEmployee?.id) return [];\n      const response = await fetch(`/api/roster?employeeId=${searchEmployee.id}`);\n      if (!response.ok) throw new Error('Failed to fetch roster');\n      return response.json();\n    },\n    enabled: !!searchEmployee && activeTab === 'roster', // Only load when roster tab active\n    staleTime: 5 * 60 * 1000, // 5 minutes cache\n  });\n\n  // Query untuk leave requests berdasarkan employee yang dipilih - LAZY LOADING\n  const { data: leaveData, isLoading: leaveLoading } = useQuery({\n    queryKey: [\"/api/leave\"],\n    enabled: !!searchEmployee && activeTab === 'leave', // Only load when leave tab active\n    staleTime: 3 * 60 * 1000, // 3 minutes cache\n  });\n\n  // Query untuk pengumuman aktif dengan status baca\n  const { data: announcements = [], isLoading: announcementsLoading, refetch: refetchAnnouncements } = useQuery<Announcement[]>({\n    queryKey: [\"/api/announcements/active-with-status\", searchEmployee?.id],\n    queryFn: async () => {\n      if (!searchEmployee?.id) return [];\n      const response = await fetch(`/api/announcements/active-with-status/${searchEmployee.id}`);\n      if (!response.ok) throw new Error('Failed to fetch announcements');\n      return response.json();\n    },\n    enabled: !!searchEmployee && activeTab === 'pemberitahuan',\n    staleTime: 1 * 60 * 1000,\n  });\n\n  // Query untuk unread count (always active)\n  const { data: unreadCountData } = useQuery<{count: number}>({\n    queryKey: [\"/api/announcements/unread-count\", searchEmployee?.id],\n    queryFn: async () => {\n      if (!searchEmployee?.id) return { count: 0 };\n      const response = await fetch(`/api/announcements/unread-count/${searchEmployee.id}`);\n      if (!response.ok) throw new Error('Failed to fetch unread count');\n      return response.json();\n    },\n    enabled: !!searchEmployee,\n    staleTime: 30 * 1000,\n  });\n\n  const unreadCount = unreadCountData?.count || 0;\n\n  // Mutation untuk mark announcement as read\n  const markAsReadMutation = useMutation({\n    mutationFn: async ({ announcementId }: { announcementId: string }) => {\n      if (!searchEmployee?.id || !searchEmployee?.name) {\n        throw new Error(\"Employee data not found\");\n      }\n      return apiRequest(`/api/announcements/${announcementId}/read`, 'POST', {\n        employeeId: searchEmployee.id,\n        employeeName: searchEmployee.name\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/announcements/unread-count\", searchEmployee?.id] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/announcements/active-with-status\", searchEmployee?.id] });\n    }\n  });\n\n  // Query untuk SIMPER monitoring berdasarkan employee yang dipilih - LAZY LOADING\n  const { data: simperData, isLoading: simperLoading } = useQuery({\n    queryKey: [\"/api/simper-monitoring/nik\", searchEmployee?.id],\n    queryFn: async () => {\n      if (!searchEmployee?.id) return null;\n      const response = await fetch(`/api/simper-monitoring/nik/${searchEmployee.id}`);\n      if (!response.ok) {\n        if (response.status === 404) return null;\n        throw new Error('Failed to fetch SIMPER data');\n      }\n      const data = await response.json();\n      \n      // Calculate monitoring days and status\n      const today = new Date();\n      const processSIMPER = (expiredDate: string | null) => {\n        if (!expiredDate) return { days: null, status: 'Tidak Ada Data' };\n        \n        const expired = new Date(expiredDate);\n        const diffTime = expired.getTime() - today.getTime();\n        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n        \n        if (diffDays < 0) return { days: diffDays, status: 'Segera Perpanjang' };\n        if (diffDays < 7) return { days: diffDays, status: 'Mendekati Perpanjangan' };\n        if (diffDays < 30) return { days: diffDays, status: 'Menuju Perpanjangan' };\n        return { days: diffDays, status: 'Aktif' };\n      };\n\n      const bibStatus = processSIMPER(data.simperBibExpiredDate);\n      const tiaStatus = processSIMPER(data.simperTiaExpiredDate);\n\n      return {\n        ...data,\n        bibMonitoringDays: bibStatus.days,\n        bibStatus: bibStatus.status,\n        tiaMonitoringDays: tiaStatus.days,\n        tiaStatus: tiaStatus.status\n      };\n    },\n    enabled: !!searchEmployee && activeTab === 'simper', // Only load when SIMPER tab active\n    staleTime: 5 * 60 * 1000, // 5 minutes cache\n  });\n\n  // Debounced search effect\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedNik(nik);\n    }, 300); // 300ms debounce\n\n    return () => clearTimeout(timer);\n  }, [nik]);\n\n  // Auto search when debounced value changes\n  useEffect(() => {\n    if (debouncedNik.trim() && employees) {\n      handleSearchWithNik(debouncedNik);\n    } else {\n      setSuggestions([]);\n      setSearchEmployee(null);\n    }\n  }, [debouncedNik, employees]);\n\n  const handleSearchWithNik = useCallback((nikValue: string) => {\n    if (!nikValue.trim()) return;\n    \n    setIsSearching(true);\n    console.log('ðŸ” Mobile Driver View: Searching for NIK:', nikValue);\n    const employeeList = employees as Employee[] || [];\n    console.log('ðŸ‘¥ Available employees:', employeeList.length);\n    const searchTerm = nikValue.trim().toLowerCase();\n    \n    const employee = employeeList.find((emp: Employee) => {\n      if (emp.id.toLowerCase() === searchTerm) return true;\n      if (emp.name.toLowerCase().includes(searchTerm)) return true;\n      if (emp.position && emp.position.toLowerCase().includes(searchTerm)) return true;\n      return false;\n    });\n    \n    // Generate suggestions for partial matches\n    if (!employee && searchTerm.length > 2) {\n      const matchedEmployees = employeeList.filter((emp: Employee) => {\n        return emp.name.toLowerCase().includes(searchTerm) ||\n               emp.id.toLowerCase().includes(searchTerm) ||\n               (emp.position && emp.position.toLowerCase().includes(searchTerm));\n      }).slice(0, 3); // Limit untuk mobile\n      setSuggestions(matchedEmployees);\n    } else {\n      setSuggestions([]);\n    }\n    \n    if (employee) {\n      console.log('âœ… Employee found:', employee.name, employee.id);\n    } else {\n      console.log('âŒ No employee found for:', nikValue);\n    }\n    \n    setSearchEmployee(employee || null);\n    setIsSearching(false);\n  }, [employees]);\n\n  // Auto-search when NIK from URL is present and employees are loaded\n  useEffect(() => {\n    console.log('ðŸš€ Mobile Driver View loaded with nikFromUrl:', nikFromUrl);\n    \n    if (nikFromUrl && employees && Array.isArray(employees) && employees.length > 0) {\n      console.log('ðŸ“± Auto-searching for employee from URL:', nikFromUrl);\n      // Immediate search - no delay needed\n      handleSearchWithNik(nikFromUrl);\n      // Auto set to roster tab for quick access\n      setActiveTab('roster');\n    }\n  }, [employees, nikFromUrl, handleSearchWithNik]); // Depend on employees so it runs when data is loaded\n\n  const handleSearch = () => {\n    handleSearchWithNik(nik);\n  };\n\n  const employeeRoster = (rosterData as RosterSchedule[]) || [];\n  const leaveList = leaveData as LeaveRequest[] || [];\n  const employeeLeaves = leaveList.filter((leave: LeaveRequest) => \n    leave.employeeId === searchEmployee?.id\n  );\n\n  // Filtered roster berdasarkan filter yang dipilih\n  const filteredRoster = (employeeRoster || []).filter((roster: RosterSchedule) => {\n    if (!roster) return false;\n    \n    // Filter by Year (always apply)\n    if (roster.date) {\n      try {\n        const rosterDate = new Date(roster.date);\n        if (rosterDate.getFullYear() !== selectedYear) {\n          return false;\n        }\n        // Filter by Month (only if selected)\n        if (selectedMonth !== null && (rosterDate.getMonth() + 1) !== selectedMonth) {\n          return false;\n        }\n      } catch (e) {\n        return false;\n      }\n    }\n    \n    // Normalize shift for comparison\n    const normalizedShift = roster.shift?.toLowerCase().trim() || '';\n    \n    // KETIKA \"SEMUA SHIFT\" DIPILIH: Tampilkan SEMUA data (SHIFT 1, SHIFT 2, CUTI, OVER SHIFT)\n    // Abaikan semua filter shift dan toggle\n    if (selectedShift === 'all') {\n      // Ketika \"Semua Shift\" dan ada toggle aktif, filter berdasarkan toggle\n      if (showOvershiftOnly || showCutiOnly) {\n        if (showOvershiftOnly && showCutiOnly) {\n          // Both active: show either OVER SHIFT OR CUTI\n          if (normalizedShift !== 'over shift' && normalizedShift !== 'cuti') {\n            return false;\n          }\n        } else if (showOvershiftOnly) {\n          // Only overshift\n          if (normalizedShift !== 'over shift') {\n            return false;\n          }\n        } else if (showCutiOnly) {\n          // Only cuti\n          if (normalizedShift !== 'cuti') {\n            return false;\n          }\n        }\n      }\n      // Jika tidak ada toggle, tampilkan semua (sudah pass filter date di atas)\n      return true;\n    }\n    \n    // Filter by Shift spesifik (SHIFT 1 atau SHIFT 2)\n    const filterShift = selectedShift.toLowerCase().trim();\n    if (normalizedShift !== filterShift) {\n      return false;\n    }\n    \n    return true;\n  });\n\n  const getShiftBadgeColor = (shift: string) => {\n    return shift === \"Shift 1\" ? \"bg-blue-500 text-white\" : \"bg-orange-500 text-white\";\n  };\n\n  const getStatusBadgeColor = (status: string) => {\n    switch (status) {\n      case \"present\": return \"bg-green-500 text-white\";\n      case \"scheduled\": return \"bg-blue-500 text-white\";\n      case \"pending\": return \"bg-yellow-500 text-black\";\n      case \"approved\": return \"bg-green-500 text-white\";\n      case \"rejected\": return \"bg-red-500 text-white\";\n      default: return \"bg-gray-500 text-white\";\n    }\n  };\n\n  const getSimperStatusColor = (status: string) => {\n    switch (status) {\n      case 'Segera Perpanjang':\n        return 'bg-red-100 text-red-800';\n      case 'Mendekati Perpanjangan':\n        return 'bg-yellow-100 text-yellow-800';\n      case 'Menuju Perpanjangan':\n        return 'bg-orange-100 text-orange-800';\n      case 'Aktif':\n        return 'bg-green-100 text-green-800';\n      default:\n        return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const formatDateDD_MM_YYYY = (dateString: string | null) => {\n    if (!dateString) return '-';\n    const date = new Date(dateString);\n    const day = date.getDate().toString().padStart(2, '0');\n    const month = (date.getMonth() + 1).toString().padStart(2, '0');\n    const year = date.getFullYear();\n    return `${day}-${month}-${year}`;\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800\">\n      {/* Modern Mobile Header */}\n      <div className=\"bg-gradient-to-r from-red-600 to-red-700 dark:from-red-700 dark:to-red-800 text-white p-6 sticky top-0 z-50 shadow-xl\">\n        <div className=\"text-center\">\n          <div className=\"flex items-center justify-center mb-2\">\n            <Activity className=\"h-6 w-6 mr-2\" />\n            <h1 className=\"text-2xl font-bold\">Driver View</h1>\n          </div>\n          <p className=\"text-red-100 text-sm font-medium\">Employee Data & Monitoring System</p>\n        </div>\n      </div>\n\n      <div className=\"p-4 space-y-6\">\n        {/* Loading State untuk employees */}\n        {employeesLoading && (\n          <Card className=\"shadow-xl border-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg\">\n            <CardContent className=\"p-8\">\n              <div className=\"flex flex-col items-center space-y-4\">\n                <div className=\"animate-spin rounded-full h-12 w-12 border-b-4 border-red-500\"></div>\n                <p className=\"text-gray-600 dark:text-gray-300 font-semibold\">Loading employee data...</p>\n                <p className=\"text-gray-400 text-sm\">Memuat data karyawan dari server...</p>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Modern Search Section */}\n        {!employeesLoading && (\n          <Card className=\"shadow-xl border-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg\">\n          <CardHeader className=\"pb-4 bg-gradient-to-r from-red-50 to-orange-50 dark:from-red-900/20 dark:to-orange-900/20 rounded-t-lg\">\n            <CardTitle className=\"flex items-center gap-3 text-xl font-bold text-gray-800 dark:text-white\">\n              <div className=\"p-2 bg-red-500 rounded-full\">\n                <Search className=\"h-5 w-5 text-white\" />\n              </div>\n              Cari Karyawan\n            </CardTitle>\n            <CardDescription className=\"text-gray-600 dark:text-gray-300 font-medium\">\n              Scan QR code atau masukkan NIK untuk melihat data lengkap\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"relative\">\n              <div className=\"flex gap-2\">\n                <Input\n                  placeholder=\"Ketik NIK atau nama karyawan...\"\n                  value={nik}\n                  onChange={(e) => setNik(e.target.value)}\n                  className=\"text-base border-2 focus:border-red-500 rounded-xl py-3 px-4 flex-1\"\n                  data-testid=\"input-mobile-nik-search\"\n                />\n                {isSearching && (\n                  <div className=\"flex items-center px-3\">\n                    <Loader2 className=\"h-5 w-5 animate-spin text-red-500\" />\n                  </div>\n                )}\n              </div>\n              \n              {/* Mobile Suggestions */}\n              {suggestions.length > 0 && (\n                <div className=\"absolute top-full left-0 right-0 bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 rounded-xl shadow-xl z-10 mt-2\">\n                  {suggestions.map((emp) => (\n                    <div\n                      key={emp.id}\n                      className=\"px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-b-0 first:rounded-t-xl last:rounded-b-xl\"\n                      onClick={() => {\n                        setNik(emp.name);\n                        setSearchEmployee(emp);\n                        setSuggestions([]);\n                      }}\n                    >\n                      <div className=\"font-semibold text-sm\">{emp.name}</div>\n                      <div className=\"text-xs text-gray-600 dark:text-gray-400\">\n                        {emp.id} | {emp.position}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n            \n            {nik && !searchEmployee && (\n              <div className=\"text-red-500 text-sm text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-xl\">\n                <p className=\"font-semibold\">Karyawan \"{nik}\" tidak ditemukan</p>\n                <p className=\"text-xs text-gray-500 mt-1\">Coba cari dengan NIK atau nama lengkap</p>\n              </div>\n            )}\n          </CardContent>\n          </Card>\n        )}\n\n        {/* Employee Info - Modern Card */}\n        {searchEmployee && !employeesLoading && (\n          <>\n            <Card className=\"shadow-xl border-0 bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg overflow-hidden\">\n              <CardHeader className=\"pb-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20\">\n                <CardTitle className=\"flex items-center gap-3 text-xl font-bold text-gray-800 dark:text-white\">\n                  <div className=\"p-3 bg-blue-500 rounded-full shadow-lg\">\n                    <User className=\"h-6 w-6 text-white\" />\n                  </div>\n                  {searchEmployee.name}\n                </CardTitle>\n                <CardDescription className=\"text-blue-600 dark:text-blue-300 font-semibold text-base\">\n                  NIK: {searchEmployee.id}\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"p-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl\">\n                    <p className=\"text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide\">Posisi</p>\n                    <p className=\"font-bold text-gray-800 dark:text-white\">{searchEmployee.position}</p>\n                  </div>\n                  <div className=\"p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl\">\n                    <p className=\"text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide\">Department</p>\n                    <p className=\"font-bold text-gray-800 dark:text-white\">{searchEmployee.department}</p>\n                  </div>\n                  <div className=\"col-span-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl\">\n                    <p className=\"text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide\">Investor Group</p>\n                    <p className=\"font-bold text-gray-800 dark:text-white\">{searchEmployee.investorGroup}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Modern Tab Navigation - Mobile Friendly with Scroll */}\n            <div className=\"flex gap-2 overflow-x-auto pb-2 scrollbar-hide\">\n              <Button\n                variant={activeTab === 'roster' ? \"default\" : \"outline\"}\n                onClick={() => setActiveTab('roster')}\n                className={`p-3 rounded-xl font-semibold flex-shrink-0 ${activeTab === 'roster' \n                  ? 'bg-gradient-to-r from-green-600 to-green-700 text-white shadow-lg' \n                  : 'bg-white dark:bg-gray-800 border-2'}`}\n                data-testid=\"tab-roster\"\n              >\n                <Calendar className=\"h-4 w-4 mb-1\" />\n                <span className=\"text-xs\">Roster</span>\n              </Button>\n              <Button\n                variant={activeTab === 'leave' ? \"default\" : \"outline\"}\n                onClick={() => setActiveTab('leave')}\n                className={`p-3 rounded-xl font-semibold flex-shrink-0 ${activeTab === 'leave' \n                  ? 'bg-gradient-to-r from-orange-600 to-orange-700 text-white shadow-lg' \n                  : 'bg-white dark:bg-gray-800 border-2'}`}\n                data-testid=\"tab-leave\"\n              >\n                <MapPin className=\"h-4 w-4 mb-1\" />\n                <span className=\"text-xs\">Cuti</span>\n              </Button>\n              <Button\n                variant={activeTab === 'pemberitahuan' ? \"default\" : \"outline\"}\n                onClick={() => setActiveTab('pemberitahuan')}\n                className={`p-3 rounded-xl font-semibold flex-shrink-0 relative overflow-visible ${activeTab === 'pemberitahuan' \n                  ? 'bg-gradient-to-r from-purple-600 to-purple-700 text-white shadow-lg' \n                  : 'bg-white dark:bg-gray-800 border-2'}`}\n                data-testid=\"tab-pemberitahuan\"\n              >\n                <Megaphone className=\"h-4 w-4 mb-1\" />\n                <span className=\"text-xs\">Pemberitahuan</span>\n                {unreadCount > 0 && (\n                  <span className=\"absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 min-w-[18px] h-[18px] flex items-center justify-center rounded-full shadow-md border-2 border-white z-10\">\n                    {unreadCount > 9 ? '9+' : unreadCount}\n                  </span>\n                )}\n              </Button>\n              <Button\n                variant={activeTab === 'simper' ? \"default\" : \"outline\"}\n                onClick={() => setActiveTab('simper')}\n                className={`p-3 rounded-xl font-semibold flex-shrink-0 ${activeTab === 'simper' \n                  ? 'bg-gradient-to-r from-red-600 to-red-700 text-white shadow-lg' \n                  : 'bg-white dark:bg-gray-800 border-2'}`}\n                data-testid=\"tab-simper\"\n              >\n                <Shield className=\"h-4 w-4 mb-1\" />\n                <span className=\"text-xs\">SIMPER</span>\n              </Button>\n            </div>\n\n            {/* Tab Content */}\n            {activeTab === 'roster' && (\n              <Card className=\"shadow-xl border-0 bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg\">\n                <CardHeader className=\"bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-t-lg\">\n                  <CardTitle className=\"flex items-center gap-3 text-xl font-bold text-gray-800 dark:text-white\">\n                    <div className=\"p-2 bg-green-500 rounded-full\">\n                      <Calendar className=\"h-5 w-5 text-white\" />\n                    </div>\n                    Jadwal Roster Kerja\n                  </CardTitle>\n                  <CardDescription className=\"text-green-600 dark:text-green-300 font-medium\">\n                    Daftar jadwal kerja untuk {searchEmployee.name}\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"p-6\">\n                  {/* Filter Section */}\n                  <div className=\"mb-6 space-y-3\">\n                    {/* Month/Year Filter */}\n                    <div className=\"flex gap-2\">\n                      <select\n                        value={selectedMonth === null ? '' : selectedMonth}\n                        onChange={(e) => setSelectedMonth(e.target.value === '' ? null : Number(e.target.value))}\n                        className=\"flex-1 p-2 border-2 rounded-lg text-sm font-semibold bg-white dark:bg-gray-800 dark:border-gray-600\"\n                        data-testid=\"filter-month\"\n                      >\n                        <option value=\"\">Semua Bulan</option>\n                        {Array.from({ length: 12 }, (_, i) => i + 1).map((month) => (\n                          <option key={month} value={month}>\n                            {new Date(2025, month - 1).toLocaleString('id-ID', { month: 'long' })}\n                          </option>\n                        ))}\n                      </select>\n                      <select\n                        value={selectedYear}\n                        onChange={(e) => setSelectedYear(Number(e.target.value))}\n                        className=\"w-24 p-2 border-2 rounded-lg text-sm font-semibold bg-white dark:bg-gray-800 dark:border-gray-600\"\n                        data-testid=\"filter-year\"\n                      >\n                        {Array.from({ length: 3 }, (_, i) => new Date().getFullYear() - 1 + i).map((year) => (\n                          <option key={year} value={year}>\n                            {year}\n                          </option>\n                        ))}\n                      </select>\n                    </div>\n\n                    {/* Shift Filter */}\n                    <div className=\"flex gap-2\">\n                      <Button\n                        variant={selectedShift === 'all' ? \"default\" : \"outline\"}\n                        onClick={() => setSelectedShift('all')}\n                        className={`flex-1 text-xs font-semibold ${selectedShift === 'all' ? 'bg-green-600' : ''}`}\n                        data-testid=\"filter-shift-all\"\n                      >\n                        Semua Shift\n                      </Button>\n                      <Button\n                        variant={selectedShift === 'Shift 1' ? \"default\" : \"outline\"}\n                        onClick={() => setSelectedShift('Shift 1')}\n                        className={`flex-1 text-xs font-semibold ${selectedShift === 'Shift 1' ? 'bg-blue-600' : ''}`}\n                        data-testid=\"filter-shift-1\"\n                      >\n                        Shift 1\n                      </Button>\n                      <Button\n                        variant={selectedShift === 'Shift 2' ? \"default\" : \"outline\"}\n                        onClick={() => setSelectedShift('Shift 2')}\n                        className={`flex-1 text-xs font-semibold ${selectedShift === 'Shift 2' ? 'bg-purple-600' : ''}`}\n                        data-testid=\"filter-shift-2\"\n                      >\n                        Shift 2\n                      </Button>\n                    </div>\n\n                    {/* Overshift & Cuti Filters */}\n                    <div className=\"flex gap-2\">\n                      <Button\n                        variant={showOvershiftOnly ? \"default\" : \"outline\"}\n                        onClick={() => setShowOvershiftOnly(!showOvershiftOnly)}\n                        className={`flex-1 text-xs font-semibold ${showOvershiftOnly ? 'bg-amber-600' : ''}`}\n                        data-testid=\"filter-overshift\"\n                      >\n                        {showOvershiftOnly ? 'âœ“' : ''} Overshift\n                      </Button>\n                      <Button\n                        variant={showCutiOnly ? \"default\" : \"outline\"}\n                        onClick={() => setShowCutiOnly(!showCutiOnly)}\n                        className={`flex-1 text-xs font-semibold ${showCutiOnly ? 'bg-red-600' : ''}`}\n                        data-testid=\"filter-cuti\"\n                      >\n                        {showCutiOnly ? 'âœ“' : ''} Cuti\n                      </Button>\n                    </div>\n                  </div>\n\n                  {rosterLoading ? (\n                    <div className=\"text-center py-12\">\n                      <div className=\"animate-spin rounded-full h-10 w-10 border-b-4 border-green-500 mx-auto\"></div>\n                      <p className=\"text-gray-600 dark:text-gray-300 font-semibold mt-4\">Loading roster data...</p>\n                      <p className=\"text-gray-400 text-sm mt-2\">Mengambil jadwal kerja terbaru...</p>\n                    </div>\n                  ) : filteredRoster.length > 0 ? (\n                    <div className=\"space-y-4\">\n                      {filteredRoster\n                        .sort((a: RosterSchedule, b: RosterSchedule) => \n                          new Date(b.date).getTime() - new Date(a.date).getTime()\n                        )\n                        .slice(0, 20)\n                        .map((roster: RosterSchedule) => (\n                          <div key={roster.id} className=\"border-2 border-gray-100 dark:border-gray-700 rounded-xl p-4 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700\">\n                            <div className=\"flex justify-between items-start mb-3\">\n                              <div>\n                                <p className=\"font-bold text-lg text-gray-800 dark:text-white\">\n                                  {format(new Date(roster.date), \"dd MMM yyyy\")}\n                                </p>\n                                <div className=\"flex gap-2 mt-2\">\n                                  <Badge className={getShiftBadgeColor(roster.shift) + \" px-3 py-1 rounded-full font-semibold\"}>\n                                    {roster.shift}\n                                  </Badge>\n                                  <Badge className={getStatusBadgeColor(roster.status) + \" px-3 py-1 rounded-full font-semibold\"}>\n                                    {roster.status}\n                                  </Badge>\n                                </div>\n                              </div>\n                              <div className=\"text-right\">\n                                <div className=\"flex items-center gap-1 text-gray-600 dark:text-gray-400\">\n                                  <Clock className=\"h-4 w-4\" />\n                                  <span className=\"font-semibold\">{roster.startTime} - {roster.endTime}</span>\n                                </div>\n                                {roster.jamTidur && (\n                                  <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\n                                    Jam Tidur: {roster.jamTidur}\n                                  </p>\n                                )}\n                                <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n                                  {roster.fitToWork}\n                                </p>\n                              </div>\n                            </div>\n                          </div>\n                        ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-8\">\n                      <Calendar className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\n                      <p className=\"text-gray-500\">Tidak ada data roster ditemukan</p>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            )}\n\n            {activeTab === 'leave' && (\n              <Card className=\"shadow-xl border-0 bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg\">\n                <CardHeader className=\"bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 rounded-t-lg\">\n                  <CardTitle className=\"flex items-center gap-3 text-xl font-bold text-gray-800 dark:text-white\">\n                    <div className=\"p-2 bg-orange-500 rounded-full\">\n                      <MapPin className=\"h-5 w-5 text-white\" />\n                    </div>\n                    Riwayat Cuti\n                  </CardTitle>\n                  <CardDescription className=\"text-orange-600 dark:text-orange-300 font-medium\">\n                    Daftar pengajuan cuti untuk {searchEmployee.name}\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"p-6\">\n                  {leaveLoading ? (\n                    <div className=\"text-center py-12\">\n                      <div className=\"animate-spin rounded-full h-10 w-10 border-b-4 border-orange-500 mx-auto\"></div>\n                      <p className=\"text-gray-600 dark:text-gray-300 font-semibold mt-4\">Loading leave data...</p>\n                      <p className=\"text-gray-400 text-sm mt-2\">Mengambil data cuti terbaru...</p>\n                    </div>\n                  ) : employeeLeaves.length > 0 ? (\n                    <div className=\"space-y-4\">\n                      {employeeLeaves\n                        .sort((a: LeaveRequest, b: LeaveRequest) => \n                          new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n                        )\n                        .slice(0, 5)\n                        .map((leave: LeaveRequest) => (\n                          <div key={leave.id} className=\"border-2 border-gray-100 dark:border-gray-700 rounded-xl p-4 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700\">\n                            <div className=\"flex justify-between items-start\">\n                              <div className=\"flex-1\">\n                                <p className=\"font-bold text-lg text-gray-800 dark:text-white mb-1\">{leave.leaveType}</p>\n                                <p className=\"text-sm text-gray-600 dark:text-gray-400 mb-2\">\n                                  {format(new Date(leave.startDate), \"dd MMM yyyy\")} - {format(new Date(leave.endDate), \"dd MMM yyyy\")}\n                                </p>\n                                {leave.reason && (\n                                  <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                                    <span className=\"font-medium\">Alasan:</span> {leave.reason}\n                                  </p>\n                                )}\n                              </div>\n                              <Badge className={getStatusBadgeColor(leave.status) + \" px-3 py-1 rounded-full font-semibold\"}>\n                                {leave.status === 'approved' ? 'Disetujui' : \n                                 leave.status === 'rejected' ? 'Ditolak' : 'Menunggu'}\n                              </Badge>\n                            </div>\n                          </div>\n                        ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-8\">\n                      <MapPin className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\n                      <p className=\"text-gray-500\">Tidak ada data cuti ditemukan</p>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            )}\n\n            {activeTab === 'pemberitahuan' && (\n              <Card className=\"shadow-xl border-0 bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg\">\n                <CardHeader className=\"bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 rounded-t-lg\">\n                  <CardTitle className=\"flex items-center gap-3 text-xl font-bold text-gray-800 dark:text-white\">\n                    <div className=\"p-2 bg-purple-500 rounded-full\">\n                      <Megaphone className=\"h-5 w-5 text-white\" />\n                    </div>\n                    Pemberitahuan\n                    {unreadCount > 0 && (\n                      <Badge className=\"bg-red-500 text-white ml-2\">{unreadCount} baru</Badge>\n                    )}\n                  </CardTitle>\n                  <CardDescription className=\"text-purple-600 dark:text-purple-300 font-medium\">\n                    Informasi dan pengumuman terbaru dari admin\n                  </CardDescription>\n                  \n                  {/* Push Notification Toggle */}\n                  {pushNotification.isSupported && (\n                    <div className=\"mt-3 p-3 bg-white dark:bg-gray-800 rounded-lg border border-purple-200 dark:border-purple-700\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          {pushNotification.isSubscribed ? (\n                            <BellRing className=\"h-5 w-5 text-purple-600 dark:text-purple-400\" />\n                          ) : (\n                            <BellOff className=\"h-5 w-5 text-gray-400\" />\n                          )}\n                          <div>\n                            <p className=\"font-medium text-sm text-gray-800 dark:text-white\">\n                              Push Notification\n                            </p>\n                            <p className=\"text-xs text-gray-500 dark:text-gray-400\">\n                              {pushNotification.isSubscribed \n                                ? \"Aktif - Anda akan menerima notifikasi\" \n                                : \"Nonaktif - Aktifkan untuk menerima notifikasi\"}\n                            </p>\n                          </div>\n                        </div>\n                        <Switch\n                          checked={pushNotification.isSubscribed}\n                          disabled={pushNotification.isLoading}\n                          onCheckedChange={async (checked) => {\n                            if (checked) {\n                              await pushNotification.subscribe();\n                            } else {\n                              await pushNotification.unsubscribe();\n                            }\n                          }}\n                          data-testid=\"switch-push-notification\"\n                        />\n                      </div>\n                      {pushNotification.error && (\n                        <p className=\"text-xs text-red-500 mt-2\">{pushNotification.error}</p>\n                      )}\n                    </div>\n                  )}\n                </CardHeader>\n                <CardContent className=\"p-3\">\n                  {announcementsLoading ? (\n                    <div className=\"text-center py-12\">\n                      <div className=\"animate-spin rounded-full h-10 w-10 border-b-4 border-purple-500 mx-auto\"></div>\n                      <p className=\"text-gray-600 dark:text-gray-300 font-semibold mt-4\">Memuat pemberitahuan...</p>\n                    </div>\n                  ) : announcements.length > 0 ? (\n                    <div className=\"space-y-2\">\n                      {announcements.map((announcement) => (\n                        <div \n                          key={announcement.id}\n                          className={`flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all duration-200 border ${\n                            !announcement.isRead \n                              ? 'bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-700 shadow-sm' \n                              : 'bg-gray-50 dark:bg-gray-800/50 border-gray-100 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700/50'\n                          }`}\n                          onClick={() => {\n                            setSelectedAnnouncement(announcement);\n                            setAnnouncementDialogOpen(true);\n                            if (!announcement.isRead) {\n                              markAsReadMutation.mutate({ announcementId: announcement.id });\n                            }\n                          }}\n                          data-testid={`announcement-${announcement.id}`}\n                        >\n                          <div className=\"flex-shrink-0 relative\">\n                            <div className={`w-11 h-11 rounded-full flex items-center justify-center ${\n                              !announcement.isRead \n                                ? 'bg-purple-500 shadow-md' \n                                : 'bg-gray-200 dark:bg-gray-700'\n                            }`}>\n                              <Megaphone className={`h-5 w-5 ${!announcement.isRead ? 'text-white' : 'text-gray-500 dark:text-gray-400'}`} />\n                            </div>\n                            {!announcement.isRead && (\n                              <span className=\"absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white dark:border-gray-800\"></span>\n                            )}\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2\">\n                              <h3 className={`font-semibold truncate ${!announcement.isRead ? 'text-purple-900 dark:text-purple-100' : 'text-gray-700 dark:text-gray-300'}`}>\n                                {announcement.title}\n                              </h3>\n                              {!announcement.isRead && (\n                                <span className=\"flex-shrink-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full uppercase\">\n                                  Baru\n                                </span>\n                              )}\n                            </div>\n                            <div className=\"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 mt-1\">\n                              <Clock className=\"h-3 w-3\" />\n                              <span>{format(new Date(announcement.createdAt), \"dd MMM yyyy HH:mm\")}</span>\n                              {announcement.imageUrls && announcement.imageUrls.length > 0 && (\n                                <>\n                                  <span className=\"text-gray-300 dark:text-gray-600\">â€¢</span>\n                                  <ImageIcon className=\"h-3 w-3\" />\n                                  <span>{announcement.imageUrls.length} foto</span>\n                                </>\n                              )}\n                            </div>\n                          </div>\n                          <ChevronRight className={`h-5 w-5 flex-shrink-0 ${!announcement.isRead ? 'text-purple-500' : 'text-gray-400'}`} />\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-12\">\n                      <Megaphone className=\"h-16 w-16 text-gray-400 mx-auto mb-4\" />\n                      <p className=\"text-gray-600 dark:text-gray-300 font-semibold text-lg mb-2\">\n                        Tidak Ada Pemberitahuan\n                      </p>\n                      <p className=\"text-gray-500 dark:text-gray-400 text-sm\">\n                        Belum ada pengumuman dari admin saat ini\n                      </p>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            )}\n\n            {/* Dialog Detail Pengumuman - Fullscreen Mobile Optimized */}\n            <Dialog open={announcementDialogOpen} onOpenChange={setAnnouncementDialogOpen}>\n              <DialogContent className=\"w-[95vw] max-w-[95vw] sm:max-w-lg h-[90vh] max-h-[90vh] p-0 overflow-hidden rounded-xl\">\n                <DialogHeader className=\"bg-gradient-to-r from-purple-500 to-indigo-500 text-white p-3 sm:p-4 sticky top-0 z-10\">\n                  <DialogTitle className=\"text-base sm:text-lg font-bold flex items-center gap-2 pr-8\">\n                    <Megaphone className=\"h-4 w-4 sm:h-5 sm:w-5 flex-shrink-0\" />\n                    <span className=\"line-clamp-2\">{selectedAnnouncement?.title}</span>\n                  </DialogTitle>\n                  <div className=\"text-purple-100 text-xs sm:text-sm flex flex-wrap items-center gap-1 sm:gap-2 mt-1\">\n                    <div className=\"flex items-center gap-1\">\n                      <Clock className=\"h-3 w-3\" />\n                      <span>{selectedAnnouncement && format(new Date(selectedAnnouncement.createdAt), \"dd MMM yyyy HH:mm\")}</span>\n                    </div>\n                    <span className=\"text-purple-200 hidden sm:inline\">â€¢</span>\n                    <span className=\"text-purple-200 w-full sm:w-auto\">Oleh: {selectedAnnouncement?.createdByName}</span>\n                  </div>\n                </DialogHeader>\n                <ScrollArea className=\"h-[calc(90vh-100px)] sm:h-[calc(90vh-120px)]\">\n                  <div className=\"p-3 sm:p-4 space-y-4\">\n                    {/* Images - Full Width with Tap to Zoom */}\n                    {selectedAnnouncement?.imageUrls && selectedAnnouncement.imageUrls.length > 0 && (\n                      <div className=\"space-y-3\">\n                        <p className=\"text-xs text-gray-500 dark:text-gray-400 text-center\">\n                          Ketuk gambar untuk memperbesar\n                        </p>\n                        {selectedAnnouncement.imageUrls.map((url, idx) => (\n                          <div \n                            key={idx} \n                            className=\"rounded-xl overflow-hidden bg-gray-100 dark:bg-gray-700 cursor-pointer active:opacity-80 transition-opacity shadow-md\"\n                            onClick={() => setFullscreenImage(url)}\n                          >\n                            <img \n                              src={url} \n                              alt={`${selectedAnnouncement.title} - ${idx + 1}`}\n                              className=\"w-full h-auto object-contain\"\n                              style={{ maxHeight: '50vh' }}\n                              onError={(e) => {\n                                (e.target as HTMLImageElement).style.display = 'none';\n                              }}\n                            />\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                    \n                    {/* Content - Better Typography for Mobile */}\n                    <div className=\"bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4\">\n                      <p className=\"text-gray-700 dark:text-gray-300 whitespace-pre-wrap leading-relaxed text-sm sm:text-base\">\n                        {selectedAnnouncement?.content}\n                      </p>\n                    </div>\n                  </div>\n                </ScrollArea>\n              </DialogContent>\n            </Dialog>\n\n            {/* Fullscreen Image Viewer */}\n            {fullscreenImage && (\n              <div \n                className=\"fixed inset-0 z-[200] bg-black/95 flex items-center justify-center p-2\"\n                onClick={() => setFullscreenImage(null)}\n              >\n                <button \n                  className=\"absolute top-4 right-4 z-10 w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition-colors\"\n                  onClick={() => setFullscreenImage(null)}\n                >\n                  <X className=\"h-6 w-6\" />\n                </button>\n                <img \n                  src={fullscreenImage} \n                  alt=\"Fullscreen view\"\n                  className=\"max-w-full max-h-full object-contain rounded-lg\"\n                  style={{ \n                    maxWidth: '100vw', \n                    maxHeight: '95vh',\n                    width: 'auto',\n                    height: 'auto'\n                  }}\n                />\n                <p className=\"absolute bottom-4 left-0 right-0 text-center text-white/70 text-sm\">\n                  Ketuk di mana saja untuk menutup\n                </p>\n              </div>\n            )}\n\n            {activeTab === 'simper' && (\n              <Card className=\"shadow-xl border-0 bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg\">\n                <CardHeader className=\"bg-gradient-to-r from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 rounded-t-lg\">\n                  <CardTitle className=\"flex items-center gap-3 text-xl font-bold text-gray-800 dark:text-white\">\n                    <div className=\"p-2 bg-red-500 rounded-full\">\n                      <Shield className=\"h-5 w-5 text-white\" />\n                    </div>\n                    Data SIMPER Monitoring\n                  </CardTitle>\n                  <CardDescription className=\"text-red-600 dark:text-red-300 font-medium\">\n                    Status SIMPER BIB dan TIA untuk {searchEmployee.name}\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"p-6\">\n                  {simperLoading ? (\n                    <div className=\"text-center py-12\">\n                      <div className=\"animate-spin rounded-full h-10 w-10 border-b-4 border-red-500 mx-auto\"></div>\n                      <p className=\"text-gray-600 dark:text-gray-300 font-semibold mt-4\">Loading SIMPER data...</p>\n                      <p className=\"text-gray-400 text-sm mt-2\">Mengambil data SIMPER terbaru...</p>\n                    </div>\n                  ) : simperData ? (\n                    <div className=\"space-y-6\">\n                      {/* Employee Info */}\n                      <div className=\"bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 p-4 rounded-xl\">\n                        <h3 className=\"font-bold text-gray-700 dark:text-gray-200 mb-3\">Informasi Karyawan</h3>\n                        <div className=\"grid grid-cols-1 gap-3 text-sm\">\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-gray-600 dark:text-gray-400\">Nama:</span>\n                            <span className=\"font-semibold text-gray-800 dark:text-white\">{simperData.employeeName}</span>\n                          </div>\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-gray-600 dark:text-gray-400\">NIK:</span>\n                            <span className=\"font-semibold text-gray-800 dark:text-white\">{simperData.nik}</span>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* SIMPER Status Cards */}\n                      <div className=\"space-y-4\">\n                        {/* SIMPER BIB */}\n                        <div className=\"border-2 border-blue-100 dark:border-blue-800 rounded-xl p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20\">\n                          <h4 className=\"font-bold text-gray-700 dark:text-gray-200 mb-3 flex items-center\">\n                            <Shield className=\"w-5 h-5 mr-2 text-blue-600\" />\n                            SIMPER BIB\n                          </h4>\n                          <div className=\"space-y-3\">\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"text-gray-600 dark:text-gray-400 text-sm\">Tanggal Expired:</span>\n                              <span className=\"font-semibold text-gray-800 dark:text-white\">\n                                {formatDateDD_MM_YYYY(simperData.simperBibExpiredDate)}\n                              </span>\n                            </div>\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"text-gray-600 dark:text-gray-400 text-sm\">Monitoring Days:</span>\n                              <span className=\"font-semibold text-gray-800 dark:text-white\">\n                                {simperData.bibMonitoringDays !== null ? `${simperData.bibMonitoringDays} hari` : '-'}\n                              </span>\n                            </div>\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"text-gray-600 dark:text-gray-400 text-sm\">Status:</span>\n                              <Badge className={getSimperStatusColor(simperData.bibStatus || 'Tidak Ada Data') + ' px-3 py-1 rounded-full font-semibold'}>\n                                {simperData.bibStatus || 'Tidak Ada Data'}\n                              </Badge>\n                            </div>\n                          </div>\n                        </div>\n\n                        {/* SIMPER TIA */}\n                        <div className=\"border-2 border-green-100 dark:border-green-800 rounded-xl p-4 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20\">\n                          <h4 className=\"font-bold text-gray-700 dark:text-gray-200 mb-3 flex items-center\">\n                            <Shield className=\"w-5 h-5 mr-2 text-green-600\" />\n                            SIMPER TIA\n                          </h4>\n                          <div className=\"space-y-3\">\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"text-gray-600 dark:text-gray-400 text-sm\">Tanggal Expired:</span>\n                              <span className=\"font-semibold text-gray-800 dark:text-white\">\n                                {formatDateDD_MM_YYYY(simperData.simperTiaExpiredDate)}\n                              </span>\n                            </div>\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"text-gray-600 dark:text-gray-400 text-sm\">Monitoring Days:</span>\n                              <span className=\"font-semibold text-gray-800 dark:text-white\">\n                                {simperData.tiaMonitoringDays !== null ? `${simperData.tiaMonitoringDays} hari` : '-'}\n                              </span>\n                            </div>\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"text-gray-600 dark:text-gray-400 text-sm\">Status:</span>\n                              <Badge className={getSimperStatusColor(simperData.tiaStatus || 'Tidak Ada Data') + ' px-3 py-1 rounded-full font-semibold'}>\n                                {simperData.tiaStatus || 'Tidak Ada Data'}\n                              </Badge>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Alert untuk status kritis */}\n                      {(simperData.bibStatus === 'Segera Perpanjang' || simperData.tiaStatus === 'Segera Perpanjang' ||\n                        simperData.bibStatus === 'Mendekati Perpanjangan' || simperData.tiaStatus === 'Mendekati Perpanjangan') && (\n                        <div className=\"bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-700 rounded-xl p-4\">\n                          <div className=\"flex items-center mb-2\">\n                            <AlertTriangle className=\"w-5 h-5 text-red-600 mr-2\" />\n                            <span className=\"font-bold text-red-800 dark:text-red-200\">Peringatan SIMPER</span>\n                          </div>\n                          <p className=\"text-red-700 dark:text-red-300 text-sm\">\n                            Ada SIMPER yang akan expired dalam waktu dekat. Segera lakukan perpanjangan.\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-12\">\n                      <Shield className=\"h-16 w-16 text-gray-400 mx-auto mb-4\" />\n                      <p className=\"text-gray-600 dark:text-gray-300 font-semibold text-lg mb-2\">\n                        Data SIMPER Tidak Ditemukan\n                      </p>\n                      <p className=\"text-gray-500 dark:text-gray-400 text-sm\">\n                        Karyawan {searchEmployee.name} belum terdaftar dalam sistem monitoring SIMPER\n                      </p>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            )}\n\n          </>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":57521,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport compression from \"compression\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\n\n// Enable compression for better performance\napp.use(compression({\n  level: 6, // Compression level (1-9, 6 is default)\n  threshold: 1024, // Only compress if response is larger than this\n  filter: (req, res) => {\n    if (req.headers['x-no-compression']) {\n      return false;\n    }\n    return compression.filter(req, res);\n  }\n}));\n// Increase body size limit to handle large Excel uploads (up to 50MB)\napp.use(express.json({ limit: '50mb' }));\napp.use(express.urlencoded({ extended: false, limit: '50mb' }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"â€¦\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n  \n  // Initialize cron jobs for leave monitoring\n  const { initializeCronJobs } = await import('./cronJobs');\n  initializeCronJobs();\n\n  // Serve static files from uploads folder (for meeting photos, P5M photos, etc.)\n  app.use('/uploads', express.static('uploads'));\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n    \n    console.error(\"Global error handler:\", err);\n    \n    if (!res.headersSent) {\n      res.status(status).json({ message });\n    }\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","path":null,"size_bytes":2890,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","path":null,"size_bytes":483,"size_tokens":null},"client/src/components/qr/qr-generator.tsx":{"content":"import { useState, useRef, useEffect, useMemo } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { generateQRCodeCanvas, downloadQRCode, printQRCode } from \"@/lib/qr-utils\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Employee } from \"@shared/schema\";\nimport { Download, Printer, Search } from \"lucide-react\";\n\nexport function QRGenerator() {\n  const [selectedEmployeeId, setSelectedEmployeeId] = useState<string>(\"\");\n  const [qrData, setQrData] = useState<string>(\"\");\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [searchQuery, setSearchQuery] = useState<string>(\"\");\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const { toast } = useToast();\n\n  const { data: employees = [] } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  // Filter employees based on search query\n  const filteredEmployees = useMemo(() => {\n    if (!searchQuery.trim()) return employees;\n    \n    const query = searchQuery.toLowerCase();\n    return employees.filter(employee => \n      employee.id.toLowerCase().includes(query) ||\n      employee.name.toLowerCase().includes(query)\n    );\n  }, [employees, searchQuery]);\n\n  const selectedEmployee = employees.find(emp => emp.id === selectedEmployeeId);\n\n  // Reset selected employee if it's not in filtered results\n  useEffect(() => {\n    if (selectedEmployeeId && !filteredEmployees.find(emp => emp.id === selectedEmployeeId)) {\n      setSelectedEmployeeId(\"\");\n    }\n  }, [filteredEmployees, selectedEmployeeId]);\n\n  const generateQR = async () => {\n    if (!selectedEmployeeId) {\n      toast({\n        title: \"Error\",\n        description: \"Silakan pilih karyawan terlebih dahulu\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsGenerating(true);\n    try {\n      const result = await apiRequest(\"/api/qr/generate\", \"POST\", {\n        employeeId: selectedEmployeeId\n      });\n      \n      console.log(\"QR Response:\", result);\n      setQrData(result.qrData);\n      \n      // Wait a bit to ensure canvas is ready\n      setTimeout(async () => {\n        if (canvasRef.current) {\n          console.log(\"Canvas element:\", canvasRef.current);\n          try {\n            await generateQRCodeCanvas(result.qrData, canvasRef.current);\n            console.log(\"QR Code rendered to canvas\");\n          } catch (error) {\n            console.error(\"Canvas rendering error:\", error);\n          }\n        } else {\n          console.error(\"Canvas ref is null\");\n        }\n      }, 100);\n\n      toast({\n        title: \"QR Code Generated\",\n        description: `QR Code berhasil dibuat untuk ${selectedEmployee?.name}`,\n      });\n    } catch (error) {\n      console.error(\"QR Generation error:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Gagal membuat QR Code\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  const handleDownload = () => {\n    if (canvasRef.current && selectedEmployee) {\n      const filename = `QR_${selectedEmployee.id}_${selectedEmployee.name.replace(/\\s+/g, '_')}.png`;\n      downloadQRCode(canvasRef.current, filename);\n    }\n  };\n\n  const handlePrint = () => {\n    if (canvasRef.current && selectedEmployee) {\n      printQRCode(canvasRef.current, {\n        id: selectedEmployee.id,\n        name: selectedEmployee.name\n      });\n    }\n  };\n\n  return (\n    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n      {/* Employee Selection */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Generate QR Code Karyawan</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* Search Input */}\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n              Cari Karyawan\n            </label>\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4\" />\n              <Input\n                type=\"text\"\n                placeholder=\"Cari berdasarkan NIK atau nama...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"employee-search-input\"\n              />\n            </div>\n          </div>\n\n          {/* Employee Selection Dropdown */}\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n              Pilih Karyawan\n            </label>\n            <Select value={selectedEmployeeId} onValueChange={setSelectedEmployeeId}>\n              <SelectTrigger data-testid=\"employee-select\">\n                <SelectValue placeholder=\"-- Pilih Karyawan --\" />\n              </SelectTrigger>\n              <SelectContent>\n                {filteredEmployees.length === 0 ? (\n                  <SelectItem value=\"no-results\" disabled>\n                    {searchQuery ? `Tidak ditemukan hasil untuk \"${searchQuery}\"` : \"Tidak ada karyawan\"}\n                  </SelectItem>\n                ) : (\n                  filteredEmployees.map((employee) => (\n                    <SelectItem key={employee.id} value={employee.id}>\n                      {employee.id} - {employee.name}\n                    </SelectItem>\n                  ))\n                )}\n              </SelectContent>\n            </Select>\n            {searchQuery && filteredEmployees.length > 0 && (\n              <p className=\"text-xs text-gray-500 dark:text-gray-400 mt-1\">\n                Menampilkan {filteredEmployees.length} dari {employees.length} karyawan\n              </p>\n            )}\n          </div>\n          \n          {selectedEmployee && (\n            <div className=\"p-4 bg-gray-50 dark:bg-gray-700 rounded-lg\" data-testid=\"employee-details\">\n              <h4 className=\"font-medium text-gray-900 dark:text-white mb-2\">Detail Karyawan</h4>\n              <div className=\"space-y-2 text-sm\">\n                <p><span className=\"font-medium\">ID:</span> {selectedEmployee.id}</p>\n                <p><span className=\"font-medium\">Nama:</span> {selectedEmployee.name}</p>\n                <p><span className=\"font-medium\">WhatsApp:</span> {selectedEmployee.phone}</p>\n                <p><span className=\"font-medium\">Posisi:</span> {selectedEmployee.position}</p>\n                <p><span className=\"font-medium\">Departemen:</span> {selectedEmployee.department}</p>\n              </div>\n            </div>\n          )}\n          \n          <Button \n            onClick={generateQR} \n            className=\"w-full\" \n            disabled={!selectedEmployeeId || isGenerating}\n            data-testid=\"generate-qr-button\"\n          >\n            {isGenerating ? \"Generating...\" : \"Generate QR Code\"}\n          </Button>\n        </CardContent>\n      </Card>\n      \n      {/* QR Code Display */}\n      <Card>\n        <CardHeader>\n          <CardTitle>QR Code Result</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {!qrData ? (\n            <div className=\"text-center\" data-testid=\"qr-placeholder\">\n              <div className=\"w-64 h-64 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center mx-auto mb-4\">\n                <p className=\"text-gray-500 dark:text-gray-400\">QR Code akan muncul di sini</p>\n              </div>\n              <p className=\"text-sm text-gray-500 dark:text-gray-400\">Pilih karyawan dan klik Generate QR Code</p>\n            </div>\n          ) : (\n            <div data-testid=\"qr-result\">\n              <div className=\"text-center mb-4\">\n                <canvas \n                  ref={canvasRef} \n                  width={256}\n                  height={256}\n                  className=\"mx-auto border border-gray-200 dark:border-gray-600 rounded-lg bg-white\"\n                  style={{ display: 'block' }}\n                  data-testid=\"qr-canvas\"\n                />\n              </div>\n              \n              <div className=\"space-y-3\">\n                <div className=\"p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\">\n                  <p className=\"text-xs font-mono text-gray-600 dark:text-gray-400 break-all\" data-testid=\"qr-data\">\n                    {qrData}\n                  </p>\n                </div>\n                \n                <div className=\"flex space-x-2\">\n                  <Button \n                    onClick={handleDownload} \n                    variant=\"outline\" \n                    className=\"flex-1\"\n                    data-testid=\"download-qr-button\"\n                  >\n                    <Download className=\"w-4 h-4 mr-2\" />\n                    Download\n                  </Button>\n                  <Button \n                    onClick={handlePrint} \n                    variant=\"outline\" \n                    className=\"flex-1\"\n                    data-testid=\"print-qr-button\"\n                  >\n                    <Printer className=\"w-4 h-4 mr-2\" />\n                    Print\n                  </Button>\n                </div>\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":9425,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/lib/pdf-utils.ts":{"content":"import jsPDF from 'jspdf';\nimport type { AttendanceRecord, Employee, RosterSchedule } from '@shared/schema';\nimport { determineShiftByTime } from './shift-utils';\n// Company logo import removed\n\ninterface ActivityPhoto {\n  dataUrl: string;\n  caption?: string;\n}\n\ninterface ReportInfo {\n  perusahaan: string;\n  namaPengawas: string;\n  hari: string;\n  tanggal: string;\n  waktu: string;\n  shift: string;\n  tempat: string;\n  diperiksaOleh: string;\n  catatan: string;\n  tandaTangan: File | string | null;\n}\n\nexport interface ReportData {\n  employees: Employee[];\n  attendance: AttendanceRecord[];\n  roster?: RosterSchedule[];\n  leaveMonitoring?: any[]; // Leave monitoring data for work days\n  startDate: string;\n  endDate: string;\n  reportType: 'attendance' | 'summary' | 'leave';\n  shiftFilter?: string;\n  reportInfo?: ReportInfo;\n  orientation?: 'landscape' | 'portrait'; // Professional orientation option\n  activityPhotos?: ActivityPhoto[]; // Activity photos for final page\n}\n\n// Helper function to convert file to base64\nfunction fileToBase64(file: File): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => resolve(reader.result as string);\n    reader.onerror = reject;\n    reader.readAsDataURL(file);\n  });\n}\n\n// Helper function to properly capitalize names\nfunction capitalizeNames(text: string): string {\n  if (!text) return text;\n  return text.split(' ').map(word => \n    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()\n  ).join(' ');\n}\n\nexport async function generateAttendancePDF(data: ReportData): Promise<void> {\n  console.log('ðŸš€ STARTING generateAttendancePDF with data:', {\n    rosterCount: data.roster?.length || 0,\n    employeeCount: data.employees?.length || 0,\n    startDate: data.startDate,\n    shiftFilter: data.shiftFilter,\n    reportInfoShift: data.reportInfo?.shift,\n    hasReportInfo: !!data.reportInfo\n  });\n  \n  try {\n    console.log('ðŸ”¥ DEBUGGING: Starting PDF generation...', {\n      orientation: data.orientation,\n      defaultOrientation: data.orientation || 'landscape',\n      hasReportInfo: !!data.reportInfo,\n      reportInfo: data.reportInfo\n    });\n    \n    // Professional orientation handling dengan layout yang berbeda\n    const orientation = data.orientation || 'landscape';\n    \n    if (orientation === 'portrait') {\n      // Gunakan layout khusus A4 portrait sesuai spesifikasi user\n      await generateA4PortraitPDF(data);\n      return;\n    }\n    \n    // Untuk landscape, gunakan layout yang sudah ada\n    const doc = new jsPDF('landscape'); \n    const pageWidth = doc.internal.pageSize.width;\n    const pageHeight = doc.internal.pageSize.height;\n    const margin = 25; // Professional margin sesuai ReportLab standard (25pt)\n    const bottomMargin = 35; // Extra space untuk custom footer professional\n    \n    let yPosition = 20;\n    \n    // Company Header - Clean design without logo\n    doc.setFontSize(12);\n    doc.setFont('helvetica', 'bold');\n    // Company branding removed for clean report\n    yPosition += 25;\n    \n    // Main Title (following ReportLab 14pt font standard)\n    doc.setFontSize(14); // Professional 14pt title as per ReportLab example\n    doc.setFont('helvetica', 'bold');\n    const title = 'FORMULIR PEMANTAUAN PERIODE KERJA KONTRAKTOR HAULING';\n    doc.text(title, pageWidth / 2, yPosition, { align: 'center' });\n    yPosition += 8;\n    \n    // Horizontal line under title\n    doc.setLineWidth(0.5);\n    doc.line(margin, yPosition, pageWidth - margin, yPosition);\n    yPosition += 20;\n    \n    // Professional form information layout (ReportLab style)\n    if (data.reportInfo) {\n      doc.setFontSize(10); // 10pt sub-header as per ReportLab standard\n      doc.setFont('helvetica', 'normal');\n      \n      // Information box dengan styling professional - adjusted for 10x6cm signature box\n      const infoBoxY = yPosition;\n      const infoBoxHeight = 75; // Height in mm to accommodate 6cm signature box + padding\n      doc.setLineWidth(0.8); // Border thickness sesuai ReportLab\n      doc.rect(margin, infoBoxY, pageWidth - 2 * margin, infoBoxHeight);\n      \n      // Left column information\n      const leftX = margin + 8;\n      const rightX = pageWidth - 140;\n      const labelWidth = 60; // Increased for better alignment\n      let leftY = yPosition + 15;\n      \n      // Left column dengan font hierarchy professional\n      doc.setFont('helvetica', 'normal');\n      doc.setFontSize(8); // 8pt untuk content detail sesuai ReportLab standard\n      \n      doc.text('Perusahaan', leftX, leftY);\n      doc.text(':', leftX + labelWidth, leftY);\n      // Company name removed\n      leftY += 10;\n      \n      doc.text('Nama Pengawas', leftX, leftY);\n      doc.text(':', leftX + labelWidth, leftY);\n      // Use sans-serif font and proper capitalization\n      doc.setFont('helvetica', 'normal'); // Helvetica is sans-serif\n      const supervisorName = capitalizeNames(data.reportInfo.namaPengawas || 'Pengawas');\n      doc.text(supervisorName, leftX + labelWidth + 5, leftY);\n      leftY += 10;\n      \n      doc.text('Hari/Tanggal/Waktu', leftX, leftY);\n      doc.text(':', leftX + labelWidth, leftY);\n      const dateTimeInfo = `${data.reportInfo.hari || ''}, ${data.reportInfo.tanggal || ''} / ${data.reportInfo.waktu || ''}`;\n      doc.text(dateTimeInfo, leftX + labelWidth + 5, leftY);\n      leftY += 10;\n      \n      doc.text('Shift', leftX, leftY);\n      doc.text(':', leftX + labelWidth, leftY);\n      doc.text(data.reportInfo.shift || '-', leftX + labelWidth + 5, leftY);\n      leftY += 10;\n      \n      doc.text('Tempat', leftX, leftY);\n      doc.text(':', leftX + labelWidth, leftY);\n      doc.text(data.reportInfo.tempat || '-', leftX + labelWidth + 5, leftY);\n      leftY += 10;\n      \n      console.log('ðŸ”¥ DEBUGGING: About to create signature box...', {\n        sigBoxWidth: 100,\n        sigBoxHeight: 60,\n        pageWidth,\n        margin\n      });\n      \n      // Professional signature box - 10x6 cm (100x60 mm) positioned at right\n      const sigBoxWidth = 100; // 10 cm in mm\n      const sigBoxHeight = 60; // 6 cm in mm\n      const sigBoxX = pageWidth - margin - sigBoxWidth; // Right-aligned\n      const sigBoxY = infoBoxY + 5;\n      \n      // Draw signature box border with 1px equivalent thickness\n      doc.setLineWidth(0.35); // ~1px equivalent in mm\n      doc.setDrawColor(0, 0, 0); // Pure black for crisp lines\n      doc.rect(sigBoxX, sigBoxY, sigBoxWidth, sigBoxHeight);\n      \n      // Layout kotak tanda tangan profesional sesuai format yang diminta\n      doc.setFont('helvetica', 'normal'); // Clean sans-serif font\n      doc.setTextColor(0, 0, 0); // Pure black for crisp text\n      \n      // 1. Bagian atas: \"Diperiksa Oleh,\" rata tengah\n      doc.setFontSize(11);\n      const signatureText = 'Diperiksa Oleh,';\n      const signatureTextWidth = doc.getTextWidth(signatureText);\n      doc.text(signatureText, sigBoxX + (sigBoxWidth - signatureTextWidth) / 2, sigBoxY + 12);\n      \n      // 2. Bagian tengah: Tanda tangan digital rapi (lebih tebal agar terlihat)\n      doc.setLineWidth(0.8); // Garis lebih tebal agar terlihat jelas\n      doc.setDrawColor(0, 0, 0); // Pure black untuk kontras\n      \n      const sigCenterX = sigBoxX + sigBoxWidth / 2;\n      const sigCenterY = sigBoxY + 28; // Sedikit lebih tinggi dari tengah\n      \n      console.log(`Drawing signature at center: (${sigCenterX}, ${sigCenterY})`);\n      \n      // Main signature stroke - simple tapi jelas terlihat\n      doc.line(sigCenterX - 25, sigCenterY, sigCenterX - 15, sigCenterY - 4);\n      doc.line(sigCenterX - 15, sigCenterY - 4, sigCenterX - 5, sigCenterY + 2);\n      doc.line(sigCenterX - 5, sigCenterY + 2, sigCenterX + 5, sigCenterY - 1);\n      doc.line(sigCenterX + 5, sigCenterY - 1, sigCenterX + 15, sigCenterY + 3);\n      doc.line(sigCenterX + 15, sigCenterY + 3, sigCenterX + 25, sigCenterY);\n      \n      // Flourish bawah\n      doc.setLineWidth(0.6);\n      doc.line(sigCenterX - 18, sigCenterY + 5, sigCenterX - 8, sigCenterY + 8);\n      doc.line(sigCenterX - 8, sigCenterY + 8, sigCenterX + 8, sigCenterY + 5);\n      doc.line(sigCenterX + 8, sigCenterY + 5, sigCenterX + 18, sigCenterY + 8);\n      \n      // 3. Nama tepat di atas garis horizontal (bagian bawah)\n      doc.setFont('helvetica', 'normal');\n      doc.setFontSize(11); // Sedikit lebih besar agar terlihat\n      doc.setTextColor(0, 0, 0); // Pastikan warna hitam\n      \n      const nameText = data.reportInfo.diperiksaOleh || capitalizeNames(data.reportInfo.namaPengawas || 'Pengawas');\n      const nameInParentheses = `(${nameText})`;\n      const nameWidth = doc.getTextWidth(nameInParentheses);\n      const nameCenterX = sigBoxX + (sigBoxWidth - nameWidth) / 2;\n      \n      // Position nama tepat di atas garis - lebih tinggi agar terlihat\n      const nameY = sigBoxY + sigBoxHeight - 18; // 18mm dari bawah kotak\n      console.log(`Drawing name \"${nameInParentheses}\" at: (${nameCenterX}, ${nameY})`);\n      doc.text(nameInParentheses, nameCenterX, nameY);\n      \n      // 4. Garis horizontal di bawah nama - lebih tebal agar terlihat\n      const lineY = nameY + 6; // 6mm di bawah nama\n      const lineMargin = 10; // mm from box edges\n      doc.setLineWidth(0.8); // Lebih tebal agar terlihat jelas\n      doc.setDrawColor(0, 0, 0); // Pure black\n      console.log(`Drawing horizontal line from (${sigBoxX + lineMargin}, ${lineY}) to (${sigBoxX + sigBoxWidth - lineMargin}, ${lineY})`);\n      doc.line(sigBoxX + lineMargin, lineY, sigBoxX + sigBoxWidth - lineMargin, lineY);\n      \n      yPosition = infoBoxY + infoBoxHeight + 10; // Reduced spacing\n    }\n    \n    // Professional date styling\n    doc.setFontSize(10); // 10pt untuk sub-header sesuai ReportLab\n    const reportDate = data.startDate === data.endDate \n      ? `Tanggal: ${formatDateForPDF(data.startDate)}`\n      : `Periode: ${formatDateForPDF(data.startDate)} - ${formatDateForPDF(data.endDate)}`;\n    doc.text(reportDate, pageWidth / 2, yPosition, { align: 'center' });\n    yPosition += 12; // Professional spacing\n    \n    // DEBUG: Check filter conditions\n    console.log(`ðŸ” FILTER DEBUG: shiftFilter=\"${data.shiftFilter}\", reportInfo.shift=\"${data.reportInfo?.shift}\"`);\n    \n    // FIXED: Use reportInfo.shift if available, otherwise use shiftFilter\n    // Normalize filter to uppercase for consistent comparison\n    const rawShiftFilter = data.reportInfo?.shift || data.shiftFilter || 'all';\n    const effectiveShiftFilter = normalizeShift(rawShiftFilter);\n    console.log(`ðŸŽ¯ Effective shift filter: \"${effectiveShiftFilter}\" (from raw: \"${rawShiftFilter}\")`);\n    \n    // Generate shift sections based on normalized filter\n    const isAllShifts = effectiveShiftFilter === 'ALL';\n    const shouldGenerateShift1 = isAllShifts || effectiveShiftFilter === 'SHIFT 1';\n    console.log(`ðŸ” Should generate Shift 1: ${shouldGenerateShift1}`);\n    \n    if (shouldGenerateShift1) {\n      console.log(`ðŸš€ Calling generateShiftSection for Shift 1...`);\n      yPosition = generateShiftSection(doc, data, 'Shift 1', yPosition, margin, pageWidth);\n    } else {\n      console.log(`âŒ Skipping Shift 1 generation`);\n    }\n    \n    // Add Shift 2 if needed - only if there's actually Shift 2 data (use normalized comparison)\n    const shift2Data = data.roster?.filter(r => normalizeShift(r.shift) === 'SHIFT 2' && r.date === data.startDate) || [];\n    const shouldGenerateShift2 = (isAllShifts || effectiveShiftFilter === 'SHIFT 2') && shift2Data.length > 0;\n    console.log(`ðŸ” Should generate Shift 2: ${shouldGenerateShift2} (shift2Data.length: ${shift2Data.length})`);\n    \n    if (shouldGenerateShift2) {\n      // Only add space/page if we already rendered Shift 1\n      if (isAllShifts) {\n        if (yPosition > pageHeight - 100) {\n          doc.addPage();\n          yPosition = 30;\n        } else {\n          yPosition += 20; // Reduced space between sections\n        }\n      }\n      \n      yPosition = generateShiftSection(doc, data, 'Shift 2', yPosition, margin, pageWidth);\n    }\n    \n    // Ensure enough space for footer and summary (need at least 60px total)\n    const footerHeight = 60; // Space needed for summary + footer\n    const availableSpace = pageHeight - yPosition - footerHeight;\n    \n    // Professional footer dengan page numbers dan timestamp\n    addProfessionalFooter(doc, pageWidth, pageHeight, margin, 1); // Single page for main report\n    \n    // Add attendance summary page\n    addAttendanceSummaryPage(doc, data, margin, pageWidth, pageHeight);\n    \n    // Add activity photos page if photos exist (only once at the end)\n    if (data.activityPhotos && data.activityPhotos.length > 0) {\n      addActivityPhotosPage(doc, data.activityPhotos.slice(0, 4), data.orientation);\n    }\n    \n    // Download\n    const filename = `Laporan_Absensi_${data.startDate.replace(/-/g, '')}.pdf`;\n    doc.save(filename);\n  } catch (error) {\n    console.error('PDF generation error:', error);\n    throw new Error('Gagal membuat PDF: ' + (error instanceof Error ? error.message : 'Unknown error'));\n  }\n}\n\n// Architect's solution: shift normalization helper\nfunction normalizeShift(shift: string): string {\n  return (shift || '').toUpperCase().replace(/\\s+/g, ' ').trim();\n}\n\nfunction generateShiftSection(\n  doc: jsPDF, \n  data: ReportData, \n  shiftName: string, \n  startY: number, \n  margin: number, \n  pageWidth: number\n): number {\n  const bottomMargin = 30; // Space for professional footer\n  let yPosition = startY;\n  \n  // Shift title - subjudul tebal\n  doc.setFontSize(11);\n  doc.setFont('helvetica', 'bold');\n  doc.text(shiftName.toUpperCase(), margin, yPosition);\n  yPosition += 8; // Compact spacing\n  \n  console.log(`ðŸ”¥ PDF GENERATION: Starting ${shiftName} with data:`, {\n    totalRoster: data.roster?.length || 0,\n    totalEmployees: data.employees?.length || 0,\n    date: data.startDate\n  });\n  \n  // ARCHITECT FIX: Filter roster by date and shift with proper normalization\n  const normalizedShiftName = normalizeShift(shiftName);\n  const rosterFiltered = (data.roster || []).filter(r => {\n    const matchesDate = r.date === data.startDate;\n    const matchesShift = normalizeShift(r.shift) === normalizedShiftName;\n    return matchesDate && matchesShift;\n  });\n  \n  console.log(`ðŸŽ¯ FILTERED ROSTER: Found ${rosterFiltered.length} entries for ${shiftName} on ${data.startDate}`);\n  \n  // ARCHITECT FIX: Build Map by employeeId with numeric coercion\n  const rosterByEmp = new Map();\n  rosterFiltered.forEach(r => {\n    const empId = String(r.employeeId).trim();\n    const hariKerja = Number.parseInt(String(r.hariKerja), 10) || 0;\n    rosterByEmp.set(empId, {\n      ...r,\n      hariKerja: hariKerja\n    });\n  });\n  \n  console.log(`ðŸ—ºï¸ ROSTER MAP: Built map with ${rosterByEmp.size} entries`);\n  \n  // Build employee list from roster (not from separate employee array)\n  const scheduledEmployees = rosterFiltered.map(rosterRecord => {\n    const employee = data.employees.find(emp => emp.id === rosterRecord.employeeId);\n    const attendanceRecord = data.attendance.find(att => \n      att.employeeId === rosterRecord.employeeId && att.date === data.startDate\n    );\n    \n    if (!employee) {\n      console.warn(`âš ï¸ Employee not found: ${rosterRecord.employeeId}`);\n      return null;\n    }\n    \n    // ARCHITECT FIX: Use Map-based lookup with employeeId\n    const empId = String(employee.id).trim();\n    const rosterData = rosterByEmp.get(empId);\n    const hariKerja = rosterData?.hariKerja ?? 0;\n    \n    // Nomor Lambung fallback logic: actualNomorLambung â†’ plannedNomorLambung â†’ employee.nomorLambung\n    const nomorLambungDisplay = rosterData?.actualNomorLambung || rosterData?.plannedNomorLambung || employee.nomorLambung || '-';\n    \n    const enrichedRecord = {\n      employee: employee,\n      hariKerja: hariKerja,\n      shift: rosterRecord.shift,\n      jamTidur: attendanceRecord?.jamTidur || '',\n      fitToWork: attendanceRecord?.fitToWork || 'Fit To Work',\n      status: attendanceRecord ? 'present' : 'absent',\n      nomorLambungDisplay: nomorLambungDisplay, // Use this for PDF rendering\n    };\n    \n    return enrichedRecord;\n  }).filter(Boolean); // Remove null entries\n  \n  // ARCHITECT DEBUG: Mapping diagnostics\n  console.log(`ðŸ“Š MAPPING RESULTS: ${scheduledEmployees.length} employees mapped`);\n  const sampleMappings = scheduledEmployees.slice(0, 5).map(emp => emp ? ({\n    empId: emp.employee.id,\n    name: emp.employee.name,\n    hariKerja: emp.hariKerja\n  }) : null).filter(Boolean);\n  console.log(`ðŸ” First 5 mappings:`, sampleMappings);\n  \n  // Check specific employees\n  const warsito = scheduledEmployees.find(emp => emp && emp.employee.name.includes('WARSITO'));\n  const abraham = scheduledEmployees.find(emp => emp && emp.employee.name.includes('ABRAHAM'));\n  const riki = scheduledEmployees.find(emp => emp && emp.employee.name.includes('RIKI'));\n  \n  if (warsito) console.log(`ðŸŽ¯ WARSITO found: hariKerja=${warsito.hariKerja}`);\n  if (abraham) console.log(`ðŸŽ¯ ABRAHAM found: hariKerja=${abraham.hariKerja}`);\n  if (riki) console.log(`ðŸŽ¯ RIKI found: hariKerja=${riki.hariKerja}`);\n  \n  // Check if there's no data for this shift\n  if (scheduledEmployees.length === 0) {\n    doc.setFontSize(9);\n    doc.setFont('helvetica', 'italic');\n    doc.text('Tidak ada data untuk shift ini', margin + 5, yPosition);\n    yPosition += 20;\n    return yPosition;\n  }\n  \n  // Professional table headers (ReportLab hierarchy: 9pt headers, 8pt content)\n  doc.setFontSize(9); // 9pt untuk table headers sesuai ReportLab standard\n  doc.setFont('helvetica', 'bold');\n  const headers = ['Nama', 'NIK', 'Shift', 'Hari Kerja', 'Jam Masuk', 'Nomor Lambung', 'Jam Tidur', 'Fit To Work', 'Status'];\n  const baseColumnWidths = [90, 60, 32, 48, 52, 88, 42, 65, 48]; // Enhanced proportions based on ReportLab A4\n  \n  // Auto-fit table to page width\n  const availableWidth = pageWidth - (2 * margin);\n  const totalBaseWidth = baseColumnWidths.reduce((sum, width) => sum + width, 0);\n  const scaleFactor = availableWidth / totalBaseWidth;\n  \n  const columnWidths = baseColumnWidths.map(width => Math.floor(width * scaleFactor));\n  const finalTableWidth = columnWidths.reduce((sum, width) => sum + width, 0);\n  const rowHeight = 11; // More compact row height\n  const headerHeight = 13; // Compact header height\n  \n  // Professional header background (following ReportLab grey standard)\n  doc.setFillColor(128, 128, 128); // Proper grey background like ReportLab example\n  doc.rect(margin, yPosition, finalTableWidth, headerHeight, 'F');\n  \n  // We will show ALL scheduled employees for this shift (both attended and not attended)\n  const totalScheduledEmployees = scheduledEmployees.length;\n  \n  // Main table border tipis\n  doc.setLineWidth(0.2); // Thin border\n  doc.rect(margin, yPosition, finalTableWidth, (totalScheduledEmployees + 1) * rowHeight);\n  \n  // Vertical grid lines tipis\n  let currentX = margin;\n  for (let i = 0; i <= headers.length; i++) {\n    doc.setLineWidth(0.2);\n    doc.line(currentX, yPosition, currentX, yPosition + (totalScheduledEmployees + 1) * rowHeight);\n    if (i < headers.length) {\n      currentX += columnWidths[i];\n    }\n  }\n  \n  // Header text - center aligned, bold, white text on grey background (ReportLab style)\n  doc.setTextColor(255, 255, 255); // White text for contrast on grey background\n  currentX = margin;\n  headers.forEach((header, index) => {\n    const headerText = header;\n    const textWidth = doc.getTextWidth(headerText);\n    const centerX = currentX + (columnWidths[index] - textWidth) / 2;\n    doc.text(headerText, centerX, yPosition + 9);\n    currentX += columnWidths[index];\n  });\n  doc.setTextColor(0, 0, 0); // Reset to black text for content\n  \n  // Horizontal line after header tipis\n  doc.setLineWidth(0.2);\n  doc.line(margin, yPosition + headerHeight, margin + finalTableWidth, yPosition + headerHeight);\n  \n  yPosition += headerHeight;\n  doc.setFont('helvetica', 'normal');\n  doc.setFontSize(8); // 8pt font untuk content sesuai ReportLab professional standard\n  \n  // CRITICAL: Check if we need a new page BEFORE starting to render any rows\n  const estimatedTableHeight = (scheduledEmployees.length + 1) * rowHeight + 20;\n  if (yPosition + estimatedTableHeight > doc.internal.pageSize.height - bottomMargin) {\n    addProfessionalFooter(doc, doc.internal.pageSize.width, doc.internal.pageSize.height, margin, 1);\n    doc.addPage();\n    \n    // Professional header for new page\n    yPosition = addProfessionalHeader(doc, margin, shiftName);\n    \n    // Redraw table header with professional styling\n    yPosition = redrawTableHeader(doc, headers, columnWidths, finalTableWidth, margin, yPosition, headerHeight);\n    \n    doc.setFont('helvetica', 'normal');\n    doc.setFontSize(8); // Keep consistent 8pt font size for table content\n    \n  }\n\n  // Process ALL scheduled employees (both attended and not attended)\n  // Use the enriched records with correct key-based roster lookups\n  scheduledEmployees.forEach((enrichedRecord, rowIndex) => {\n    if (!enrichedRecord?.employee) return;\n    \n    const employee = enrichedRecord.employee;\n    \n    // Use enriched record data which already has correct hariKerja from key-based lookup\n    let workDaysText = '-';\n    if (enrichedRecord.hariKerja !== null && enrichedRecord.hariKerja !== undefined && enrichedRecord.hariKerja !== '') {\n      // Convert to string and handle both numeric and string values\n      const hariKerjaStr = String(enrichedRecord.hariKerja).trim();\n      if (hariKerjaStr && hariKerjaStr !== '0' && hariKerjaStr !== 'null' && hariKerjaStr !== 'undefined') {\n        workDaysText = hariKerjaStr;\n      }\n    }\n    \n    // DEBUG untuk verify correct data\n    if (employee.name.includes('WARSITO') || enrichedRecord.hariKerja) {\n      console.log(`ðŸŽ¯ PDF ROW: ${employee.name}, hariKerja=\"${enrichedRecord.hariKerja}\" â†’ \"${workDaysText}\", status=${enrichedRecord.status}`);\n    }\n    \n    // Prepare row data using enriched record data\n    const jamTidur = enrichedRecord.jamTidur || '-';\n    const fitToWorkStatus = enrichedRecord.fitToWork || 'Not Fit To Work';\n    const attendanceStatus = enrichedRecord.status === 'present' ? 'Hadir' : 'Tidak Hadir';\n    const attendanceTime = enrichedRecord.status === 'present' ? data.attendance.find(att => att.employeeId === employee.id)?.time || '-' : '-';\n    \n    const rowData = [\n      employee.name || '-',\n      employee.id || '-',\n      shiftName || '-',\n      workDaysText, // Hari Kerja dari roster\n      attendanceTime, // Jam Masuk\n      // Use enriched nomor lambung with fallback: actualNomorLambung â†’ plannedNomorLambung â†’ employee.nomorLambung\n      employee.isSpareOrigin && enrichedRecord.nomorLambungDisplay !== \"SPARE\" ? \n       `SPARE ${enrichedRecord.nomorLambungDisplay}` : enrichedRecord.nomorLambungDisplay,\n      jamTidur,\n      fitToWorkStatus,\n      attendanceStatus\n    ];\n    \n    // Professional alternating row colors (ReportLab whitesmoke standard)\n    if (rowIndex % 2 === 1) { // Alternating rows dengan professional styling\n      doc.setFillColor(245, 245, 245); // Whitesmoke sesuai ReportLab example\n      doc.rect(margin, yPosition, finalTableWidth, rowHeight, 'F');\n    }\n    \n    // Draw row data with proper alignment\n    let currentX = margin;\n    rowData.forEach((cellData, columnIndex) => {\n      const cellText = String(cellData);\n      \n      if (columnIndex === 0 || columnIndex === 5) {\n        // Name and Nomor Lambung columns - left aligned (ReportLab style)\n        doc.text(cellText, currentX + 3, yPosition + 7.5);\n      } else {\n        // All other columns - center aligned (ReportLab style)\n        const textWidth = doc.getTextWidth(cellText);\n        const centerX = currentX + (columnWidths[columnIndex] - textWidth) / 2;\n        doc.text(cellText, centerX, yPosition + 7.5);\n      }\n      currentX += columnWidths[columnIndex];\n    });\n    \n    // Clean horizontal line after each row\n    doc.setLineWidth(0.2);\n    doc.setDrawColor(200, 200, 200); // Very subtle gray line\n    doc.line(margin, yPosition + rowHeight, margin + finalTableWidth, yPosition + rowHeight);\n    doc.setDrawColor(0, 0, 0); // Reset to black\n    \n    yPosition += rowHeight;\n  });\n  \n  // Clean bottom border for table\n  doc.setLineWidth(0.2);\n  doc.setDrawColor(0, 0, 0);\n  doc.line(margin, yPosition + 2, margin + finalTableWidth, yPosition + 2);\n  yPosition += 8; // Reduced spacing after table\n  \n  // Shift summary - teks lebih kecil dari isi tabel\n  doc.setFontSize(9); // Smaller than table content (10pt)\n  doc.setFont('helvetica', 'normal');\n  \n  const attendedCount = scheduledEmployees.filter(enrichedRecord => {\n    return enrichedRecord?.status === 'present';\n  }).length;\n  const scheduledCount = scheduledEmployees.length;\n  const absentCount = scheduledCount - attendedCount;\n  \n  const summaryText = `Ringkasan ${shiftName}: Dijadwalkan: ${scheduledCount} | Hadir: ${attendedCount} | Tidak Hadir: ${absentCount}`;\n  doc.text(summaryText, margin, yPosition);\n  \n  return yPosition + 15; // Reduced spacing after shift section\n}\n\n\nfunction formatDateForPDF(dateString: string): string {\n  const date = new Date(dateString + 'T00:00:00');\n  const day = date.getDate().toString().padStart(2, '0');\n  const month = (date.getMonth() + 1).toString().padStart(2, '0');\n  const year = date.getFullYear();\n  return `${day}-${month}-${year}`; // dd-mm-yyyy format as requested\n}\n\n// Helper function untuk text wrapping\nfunction splitTextToFitWidth(doc: jsPDF, text: string, maxWidth: number): string[] {\n  const words = text.split(' ');\n  const lines: string[] = [];\n  let currentLine = '';\n  \n  for (const word of words) {\n    const testLine = currentLine ? currentLine + ' ' + word : word;\n    const testWidth = doc.getTextWidth(testLine);\n    \n    if (testWidth <= maxWidth) {\n      currentLine = testLine;\n    } else {\n      if (currentLine) {\n        lines.push(currentLine);\n        currentLine = word;\n      } else {\n        // Single word terlalu panjang, force break\n        lines.push(word);\n      }\n    }\n  }\n  \n  if (currentLine) {\n    lines.push(currentLine);\n  }\n  \n  return lines.length > 0 ? lines : [text];\n}\n\n// Enhanced professional footer dengan styling seperti ReportLab custom footer\nfunction addProfessionalFooter(doc: jsPDF, pageWidth: number, pageHeight: number, margin: number, pageNumber?: number): void {\n  const now = new Date();\n  const day = now.getDate().toString().padStart(2, '0');\n  const month = (now.getMonth() + 1).toString().padStart(2, '0');\n  const year = now.getFullYear();\n  const hours = now.getHours().toString().padStart(2, '0');\n  const minutes = now.getMinutes().toString().padStart(2, '0');\n  \n  // Footer positioning sesuai ReportLab (1cm from bottom)\n  const footerY = pageHeight - 10; // Lebih dekat ke bottom edge\n  doc.setFontSize(8); // 8pt untuk footer text\n  doc.setFont('helvetica', 'normal');\n  \n  // Combined text seperti ReportLab: \"Halaman X | Dicetak: date time\"\n  const pageText = pageNumber ? `Halaman ${pageNumber}` : '';\n  const timestampText = `Dicetak: ${day}-${month}-${year} ${hours}:${minutes}`;\n  const fullFooterText = pageNumber ? `${pageText} | ${timestampText}` : timestampText;\n  \n  // Right-aligned footer text seperti ReportLab example\n  doc.text(fullFooterText, pageWidth - margin, footerY, { align: 'right' });\n}\n\n// Professional header untuk halaman baru\nfunction addProfessionalHeader(doc: jsPDF, margin: number, shiftName: string): number {\n  let yPosition = margin;\n  \n  // Clean header without logo\n  yPosition += 25;\n  \n  // Shift title\n  doc.setFontSize(11);\n  doc.setFont('helvetica', 'bold');\n  doc.text(shiftName.toUpperCase(), margin, yPosition);\n  yPosition += 10;\n  \n  return yPosition;\n}\n\n// Redraw table header untuk halaman baru\nfunction redrawTableHeader(doc: jsPDF, headers: string[], columnWidths: number[], finalTableWidth: number, margin: number, yPosition: number, headerHeight: number): number {\n  // Professional header background (ReportLab grey standard)\n  doc.setFillColor(128, 128, 128);\n  doc.rect(margin, yPosition, finalTableWidth, headerHeight, 'F');\n  \n  // Table border\n  doc.setLineWidth(0.2);\n  doc.rect(margin, yPosition, finalTableWidth, headerHeight);\n  \n  // Vertical lines\n  let currentX = margin;\n  headers.forEach((header, index) => {\n    if (index > 0) {\n      doc.line(currentX, yPosition, currentX, yPosition + headerHeight);\n    }\n    \n    // Professional header text dengan consistent font sizing\n    const textWidth = doc.getTextWidth(header);\n    const centerX = currentX + (columnWidths[index] - textWidth) / 2;\n    doc.setFont('helvetica', 'bold');\n    doc.setFontSize(9); // 9pt untuk table headers sesuai ReportLab\n    doc.setTextColor(255, 255, 255); // White text pada grey background\n    doc.text(header, centerX, yPosition + 9);\n    doc.setTextColor(0, 0, 0); // Reset to black\n    \n    currentX += columnWidths[index];\n  });\n  \n  // Right border\n  doc.line(currentX, yPosition, currentX, yPosition + headerHeight);\n  \n  return yPosition + headerHeight;\n}\n\n// Function khusus untuk A4 Portrait dengan layout yang diminta user\nasync function generateA4PortraitPDF(data: ReportData): Promise<void> {\n  const doc = new jsPDF('portrait', 'pt', 'a4'); // Use points for precise measurements\n  const pageWidth = doc.internal.pageSize.width; // 595.28 pt\n  const pageHeight = doc.internal.pageSize.height; // 841.89 pt\n  const margin = 15; // 0.5cm margin minimal mendekati batas A4 (15pt â‰ˆ 0.5cm)\n  const bottomMargin = 60; // Space untuk footer\n  \n  let yPosition = margin;\n  let pageNumber = 1;\n  \n  // Kotak header professional dengan border - diperbesar untuk tampilan lebih lapang\n  const headerBoxHeight = 180;\n  doc.setLineWidth(0.8);\n  doc.setDrawColor(100, 100, 100);\n  doc.rect(margin, yPosition, pageWidth - 2 * margin, headerBoxHeight);\n  \n  yPosition += 15; // Padding dalam kotak header\n  \n  // Judul Laporan - Teks besar, bold, rata tengah dengan styling lebih baik\n  doc.setFont('helvetica', 'bold');\n  doc.setFontSize(15); // Sedikit dikurangi agar pas dalam kotak\n  const title = 'FORMULIR PEMANTAUAN PERIODE KERJA KONTRAKTOR HAULING';\n  const titleWidth = doc.getTextWidth(title);\n  const titleX = (pageWidth - titleWidth) / 2;\n  doc.text(title, titleX, yPosition + 18);\n  yPosition += 30;\n  \n  // Garis tipis horizontal di bawah judul (dalam kotak)\n  doc.setLineWidth(0.3);\n  doc.setDrawColor(150, 150, 150);\n  doc.line(margin + 10, yPosition, pageWidth - margin - 10, yPosition);\n  yPosition += 20;\n  \n  // Bagian Informasi & Tanda Tangan (rebalanced: 58% dan 42% untuk proporsi lebih baik)\n  const leftColumnWidth = (pageWidth - 2 * margin) * 0.58; // 58% lebar untuk info\n  const rightColumnWidth = (pageWidth - 2 * margin) * 0.42; // 42% lebar untuk signature (diperlebar)\n  const rightColumnX = margin + leftColumnWidth + 15; // 15pt spacing between columns\n  \n  // Kolom kiri - Informasi\n  const leftX = margin + 10;\n  let leftY = yPosition;\n  \n  doc.setFont('helvetica', 'normal');\n  doc.setFontSize(11);\n  \n  const infoFields = [\n    `Perusahaan : ${data.reportInfo?.perusahaan || 'PT Goden Energi Cemerlang Lestari'}`,\n    `Nama Pengawas : ${data.reportInfo?.namaPengawas || 'BUDI HARTO DAN FADLAN'}`,\n    `Hari/Tanggal/Waktu : ${data.reportInfo?.hari || 'Rabu'}, ${formatDateForPDF(data.startDate)} / ${data.reportInfo?.waktu || '17:00-18:00'}`,\n    `Shift : ${data.reportInfo?.shift || 'Shift 1'}`,\n    `Tempat : ${data.reportInfo?.tempat || 'Titik Kumpul WS GECL'}`\n  ];\n  \n  infoFields.forEach(field => {\n    doc.text(field, leftX, leftY);\n    leftY += 18;\n  });\n  \n  // Kolom kanan - Kotak tanda tangan dengan border tipis (diperbesar untuk gambar)\n  const signBoxHeight = 110; // Diperbesar dari 80pt ke 110pt untuk ruang gambar\n  const signBoxY = yPosition;\n  \n  // Draw border kotak tanda tangan\n  doc.setLineWidth(0.5);\n  doc.rect(rightColumnX, signBoxY - 10, rightColumnWidth - 20, signBoxHeight);\n  \n  // Judul \"Diperiksa Oleh,\" rata tengah atas\n  doc.setFont('helvetica', 'normal');\n  doc.setFontSize(10);\n  const checkText = 'Diperiksa Oleh,';\n  const checkTextWidth = doc.getTextWidth(checkText);\n  const checkTextX = rightColumnX + (rightColumnWidth - 20 - checkTextWidth) / 2;\n  doc.text(checkText, checkTextX, signBoxY + 5);\n  \n  // ðŸŽ¯ FIXED: Always draw signature components unconditionally (Portrait Mode)\n  console.log('ðŸ”¥ Drawing portrait signature unconditionally...');\n  \n  try {\n    // Validate all geometric values before proceeding\n    if (!Number.isFinite(rightColumnX) || !Number.isFinite(rightColumnWidth) || !Number.isFinite(signBoxY) || \n        rightColumnX < 0 || rightColumnWidth <= 20 || signBoxY < 0) {\n      console.warn('Portrait signature skipped: Invalid dimensions', { rightColumnX, rightColumnWidth, signBoxY });\n      return;\n    }\n\n    // Setup clean typography and colors\n    doc.setFont('helvetica', 'normal');\n    doc.setTextColor(0, 0, 0); // Pure black\n    \n    // 2. Signature graphics in center - PRIORITIZE uploaded image over vector\n    const sigCenterX = rightColumnX + (rightColumnWidth - 20) / 2;\n    const sigCenterY = signBoxY + 35;\n    \n    console.log(`ðŸ”¥ Drawing signature at: (${sigCenterX}, ${sigCenterY})`);\n    \n    // Check if there's an uploaded signature image (base64)\n    if (data.reportInfo?.tandaTangan && typeof data.reportInfo.tandaTangan === 'string' && \n        data.reportInfo.tandaTangan.startsWith('data:image/')) {\n      \n      try {\n        console.log('ðŸ“¸ Using uploaded signature image...');\n        \n        // Calculate signature image dimensions (fit in available space)\n        const maxSignWidth = 80; // Max width in PDF units\n        const maxSignHeight = 30; // Max height in PDF units\n        \n        const signImageX = sigCenterX - maxSignWidth / 2;\n        const signImageY = sigCenterY - maxSignHeight / 2;\n        \n        // Add the uploaded signature image\n        doc.addImage(\n          data.reportInfo.tandaTangan,\n          'JPEG',\n          signImageX,\n          signImageY,\n          maxSignWidth,\n          maxSignHeight\n        );\n        \n        console.log(`âœ… Uploaded signature image added at: (${signImageX}, ${signImageY})`);\n        \n      } catch (imageError) {\n        console.error('Error adding uploaded signature image:', imageError);\n        \n        // Fall back to vector signature if image fails\n        doc.setLineWidth(0.8);\n        doc.setDrawColor(0, 0, 0);\n        doc.line(sigCenterX - 20, sigCenterY, sigCenterX - 12, sigCenterY - 3);\n        doc.line(sigCenterX - 12, sigCenterY - 3, sigCenterX - 4, sigCenterY + 1);\n        doc.line(sigCenterX - 4, sigCenterY + 1, sigCenterX + 4, sigCenterY - 1);\n        doc.line(sigCenterX + 4, sigCenterY - 1, sigCenterX + 12, sigCenterY + 2);\n        doc.line(sigCenterX + 12, sigCenterY + 2, sigCenterX + 20, sigCenterY);\n        \n        console.log('âš ï¸ Using fallback vector signature due to image error');\n      }\n      \n    } else {\n      console.log('ðŸ“ No uploaded signature found, using vector signature...');\n      \n      // Fall back to professional vector signature\n      doc.setLineWidth(0.8);\n      doc.setDrawColor(0, 0, 0);\n      doc.line(sigCenterX - 20, sigCenterY, sigCenterX - 12, sigCenterY - 3);\n      doc.line(sigCenterX - 12, sigCenterY - 3, sigCenterX - 4, sigCenterY + 1);\n      doc.line(sigCenterX - 4, sigCenterY + 1, sigCenterX + 4, sigCenterY - 1);\n      doc.line(sigCenterX + 4, sigCenterY - 1, sigCenterX + 12, sigCenterY + 2);\n      doc.line(sigCenterX + 12, sigCenterY + 2, sigCenterX + 20, sigCenterY);\n      \n      // Elegant flourish\n      doc.setLineWidth(0.6);\n      doc.line(sigCenterX - 15, sigCenterY + 4, sigCenterX - 6, sigCenterY + 6);\n      doc.line(sigCenterX - 6, sigCenterY + 6, sigCenterX + 6, sigCenterY + 4);\n      doc.line(sigCenterX + 6, sigCenterY + 4, sigCenterX + 15, sigCenterY + 6);\n    }\n    \n    // 3. Name text - ALWAYS SHOW with fallback\n    doc.setFont('helvetica', 'normal');\n    doc.setFontSize(11);\n    \n    // Use provided name or fallback to default\n    const nameText = data.reportInfo?.diperiksaOleh?.trim() || \n                     data.reportInfo?.namaPengawas?.trim() || \n                     'Pengawas';\n    const nameInParentheses = `(${nameText})`;\n    const nameWidth = doc.getTextWidth(nameInParentheses);\n    const nameCenterX = rightColumnX + ((rightColumnWidth - 20) - nameWidth) / 2;\n    const nameY = signBoxY + signBoxHeight - 25;\n    \n    console.log(`ðŸ”¥ Drawing name \"${nameInParentheses}\" at: (${nameCenterX}, ${nameY})`);\n    doc.text(nameInParentheses, nameCenterX, nameY);\n    \n    // 4. Horizontal line - ALWAYS DRAW\n    const lineY = nameY + 8;\n    const lineMargin = 15;\n    const lineStartX = rightColumnX + lineMargin;\n    const lineEndX = rightColumnX + rightColumnWidth - 20 - lineMargin;\n    \n    doc.setLineWidth(0.8);\n    doc.setDrawColor(0, 0, 0);\n    console.log(`ðŸ”¥ Drawing line from (${lineStartX}, ${lineY}) to (${lineEndX}, ${lineY})`);\n    doc.line(lineStartX, lineY, lineEndX, lineY);\n    \n    console.log('âœ… Portrait signature drawn successfully!');\n    \n  } catch (error) {\n    console.error('Error drawing portrait signature:', error);\n    // Draw fallback simple text\n    doc.setFont('helvetica', 'normal');\n    doc.setFontSize(10);\n    doc.text('(Tanda Tangan)', rightColumnX + 10, signBoxY + 40);\n  }\n  \n  yPosition = Math.max(leftY, signBoxY + signBoxHeight) + 10;\n  \n  // Pastikan kita di luar kotak header\n  if (yPosition < margin + headerBoxHeight + 10) {\n    yPosition = margin + headerBoxHeight + 15;\n  }\n  \n  // Tanggal laporan rata tengah dengan styling yang lebih baik\n  doc.setFont('helvetica', 'normal');\n  doc.setFontSize(11);\n  const reportDate = `Tanggal: ${formatDateForPDF(data.startDate)}`;\n  const dateWidth = doc.getTextWidth(reportDate);\n  const dateX = (pageWidth - dateWidth) / 2;\n  doc.text(reportDate, dateX, yPosition);\n  yPosition += 25;\n  \n  // Generate tabel dengan proporsi kolom yang tepat\n  await generateA4PortraitTable(doc, data, yPosition, margin, pageWidth, pageHeight, bottomMargin, pageNumber);\n  \n  // Add attendance summary page before saving\n  addAttendanceSummaryPage(doc, data, margin, pageWidth, pageHeight);\n  \n  // Save PDF\n  const fileName = `laporan-attendance-${formatDateForPDF(data.startDate)}-A4.pdf`;\n  doc.save(fileName);\n}\n\n// Function untuk generate tabel khusus A4 Portrait\nasync function generateA4PortraitTable(\n  doc: jsPDF, \n  data: ReportData, \n  startY: number, \n  margin: number, \n  pageWidth: number, \n  pageHeight: number, \n  bottomMargin: number,\n  initialPageNumber: number\n): Promise<void> {\n  \n  let yPosition = startY;\n  let pageNumber = initialPageNumber;\n  \n  // Proporsi kolom untuk area maksimal mendekati batas A4: total 100%\n  const tableWidth = pageWidth - 2 * margin;\n  const columnProportions = [0.17, 0.12, 0.06, 0.08, 0.12, 0.17, 0.07, 0.14, 0.07]; // Total = 1.00\n  const columnWidths = columnProportions.map(prop => tableWidth * prop);\n  \n  const headers = ['Nama', 'NIK', 'Shift', 'Hari Kerja', 'Jam Masuk', 'Nomor Lambung', 'Jam Tidur', 'Fit To Work', 'Status'];\n  const rowHeight = 28; // Row height untuk readability\n  const headerHeight = 32; // Header height untuk wrap text\n  \n  // Function untuk draw header tabel (hanya sekali per halaman)\n  const drawTableHeader = (yPos: number) => {\n    // Background abu-abu muda untuk header\n    doc.setFillColor(220, 220, 220);\n    doc.rect(margin, yPos, tableWidth, headerHeight, 'F');\n    \n    // Border header\n    doc.setLineWidth(0.5);\n    doc.rect(margin, yPos, tableWidth, headerHeight);\n    \n    // Header text bold dengan ukuran font sedikit lebih besar\n    doc.setFont('helvetica', 'bold');\n    doc.setFontSize(10);\n    doc.setTextColor(0, 0, 0);\n    \n    let currentX = margin;\n    headers.forEach((header, index) => {\n      // Vertical lines between columns\n      if (index > 0) {\n        doc.line(currentX, yPos, currentX, yPos + headerHeight);\n      }\n      \n      // Header text centered dengan wrap untuk text panjang\n      const cellWidth = columnWidths[index] - 6; // 3pt padding kiri-kanan\n      const lines = splitTextToFitWidth(doc, header, cellWidth);\n      \n      const lineHeight = 11;\n      const totalTextHeight = lines.length * lineHeight;\n      const startY = yPos + (headerHeight - totalTextHeight) / 2 + lineHeight;\n      \n      lines.forEach((line, lineIndex) => {\n        const textWidth = doc.getTextWidth(line);\n        const centerX = currentX + (columnWidths[index] - textWidth) / 2;\n        doc.text(line, centerX, startY + lineIndex * lineHeight);\n      });\n      \n      currentX += columnWidths[index];\n    });\n    \n    return yPos + headerHeight;\n  };\n  \n  // Function untuk add footer dengan page numbering\n  const addA4Footer = (pageNum: number, totalPages: number) => {\n    const footerY = pageHeight - 30;\n    doc.setFontSize(8);\n    doc.setFont('helvetica', 'normal');\n    \n    // Page number rata kanan format \"Halaman X dari Y\"\n    const pageText = `Halaman ${pageNum}`;\n    const pageTextWidth = doc.getTextWidth(pageText);\n    doc.text(pageText, pageWidth - margin - pageTextWidth, footerY);\n    \n    // Timestamp rata kiri\n    const now = new Date();\n    const timestamp = `Dicetak: ${formatDateForPDF(now.toISOString().split('T')[0])} ${now.toTimeString().split(' ')[0].substring(0,5)}`;\n    doc.text(timestamp, margin, footerY);\n  };\n  \n  // FIXED: Use reportInfo.shift if available, same logic as landscape mode\n  console.log('ðŸŽ¯ PORTRAIT MODE: About to generate table sections...');\n  console.log('ðŸ“Š PORTRAIT DATA CHECK:', {\n    totalRoster: data.roster?.length || 0,\n    totalEmployees: data.employees?.length || 0,\n    startDate: data.startDate,\n    shiftFilter: data.shiftFilter,\n    reportInfoShift: data.reportInfo?.shift\n  });\n  \n  const effectiveShiftFilter = data.reportInfo?.shift || data.shiftFilter;\n  console.log(`ðŸŽ¯ PORTRAIT: Effective shift filter: \"${effectiveShiftFilter}\"`);\n  \n  // Generate shift sections\n  const shifts = effectiveShiftFilter === 'all' ? ['Shift 1', 'Shift 2'] : [effectiveShiftFilter || 'Shift 1'];\n  \n  for (const shift of shifts) {\n    const shiftEmployees = getShiftEmployees(data, shift);\n    \n    if (shiftEmployees.length === 0) continue;\n    \n    // Check space untuk shift title + minimal 3 rows\n    const neededSpace = 40 + headerHeight + (3 * rowHeight);\n    if (yPosition + neededSpace > pageHeight - bottomMargin) {\n      addA4Footer(pageNumber, 0); // Total pages akan dihitung nanti\n      doc.addPage();\n      pageNumber++;\n      yPosition = margin + 30; // Reset position pada halaman baru\n    }\n    \n    // Shift title\n    doc.setFont('helvetica', 'bold');\n    doc.setFontSize(12);\n    const shiftTitle = shift.toUpperCase();\n    const shiftTitleWidth = doc.getTextWidth(shiftTitle);\n    const shiftTitleX = (pageWidth - shiftTitleWidth) / 2;\n    doc.text(shiftTitle, shiftTitleX, yPosition);\n    yPosition += 25;\n    \n    // Draw table header\n    yPosition = drawTableHeader(yPosition);\n    \n    // Table content dengan font sedikit lebih besar untuk readability\n    doc.setFont('helvetica', 'normal');\n    doc.setFontSize(9);\n    \n    shiftEmployees.forEach((employee, rowIndex) => {\n      // Check jika perlu halaman baru\n      if (yPosition + rowHeight > pageHeight - bottomMargin) {\n        addA4Footer(pageNumber, 0); // Total pages akan dihitung nanti\n        doc.addPage();\n        pageNumber++;\n        yPosition = margin + 30;\n        yPosition = drawTableHeader(yPosition); // Redraw header di halaman baru\n        \n        // CRITICAL FIX: Reset font to normal after header redraw\n        doc.setFont('helvetica', 'normal');\n        doc.setFontSize(9);\n      }\n      \n      // Alternating row background\n      if (rowIndex % 2 === 1) {\n        doc.setFillColor(248, 248, 248);\n        doc.rect(margin, yPosition, tableWidth, rowHeight, 'F');\n      }\n      \n      // Row border\n      doc.setLineWidth(0.3);\n      doc.rect(margin, yPosition, tableWidth, rowHeight);\n      \n      // Row data\n      const attendance = data.attendance.find(a => a.employeeId === employee.id);\n      const attendanceStatus = attendance ? 'Hadir' : 'Tidak Hadir'; // Tanpa emoji, hanya teks\n      const jamTidur = attendance?.jamTidur || '-';\n      const fitToWork = attendance?.fitToWork || '-';\n      const jamMasuk = attendance?.time || '-';\n      \n      // Handle nilai negatif di Hari Kerja dengan strip (-)\n      let hariKerjaValue = employee.workDays?.toString() || '-';\n      if (employee.workDays && employee.workDays < 0) {\n        hariKerjaValue = '-';\n      }\n      \n      const rowData = [\n        employee.name,\n        employee.id,\n        shift === 'Shift 1' ? '1' : '2',\n        hariKerjaValue,\n        jamMasuk,\n        // Use enriched nomor lambung with fallback: actualNomorLambung â†’ plannedNomorLambung â†’ employee.nomorLambung\n        employee.isSpareOrigin && employee.nomorLambungDisplay !== \"SPARE\" ? \n         `SPARE ${employee.nomorLambungDisplay}` : (employee.nomorLambungDisplay || '-'),\n        jamTidur,\n        fitToWork,\n        attendanceStatus\n      ];\n      \n      let currentX = margin;\n      rowData.forEach((cellData, columnIndex) => {\n        // Vertical lines\n        if (columnIndex > 0) {\n          doc.line(currentX, yPosition, currentX, yPosition + rowHeight);\n        }\n        \n        // Text dengan wrapping untuk kolom yang mungkin panjang\n        const cellWidth = columnWidths[columnIndex] - 6; // 3pt padding kiri-kanan\n        const lines = splitTextToFitWidth(doc, cellData, cellWidth);\n        \n        const lineHeight = 10;\n        const totalTextHeight = lines.length * lineHeight;\n        const startY = yPosition + (rowHeight - totalTextHeight) / 2 + lineHeight;\n        \n        lines.forEach((line, lineIndex) => {\n          if (columnIndex === 0) { // Nama kolom - rata kiri\n            doc.text(line, currentX + 8, startY + lineIndex * lineHeight);\n          } else { // Sisanya rata tengah\n            const textWidth = doc.getTextWidth(line);\n            const centerX = currentX + (columnWidths[columnIndex] - textWidth) / 2;\n            doc.text(line, centerX, startY + lineIndex * lineHeight);\n          }\n        });\n        \n        currentX += columnWidths[columnIndex];\n      });\n      \n      yPosition += rowHeight;\n    });\n    \n    yPosition += 20; // Space between shifts\n  }\n  \n  // Add footer ke halaman terakhir dengan total halaman yang benar\n  const totalPages = pageNumber;\n  \n  // Update semua footer dengan total pages yang benar\n  for (let i = 1; i <= totalPages; i++) {\n    if (i < totalPages) {\n      // Pindah ke halaman yang sesuai dan update footer\n      // Note: Untuk implementasi sederhana, kita hanya update halaman terakhir\n      // Idealnya perlu sistem yang lebih kompleks untuk update semua halaman\n    }\n  }\n  \n  addA4Footer(pageNumber, totalPages);\n  \n  // Add activity photos page if photos exist\n  if (data.activityPhotos && data.activityPhotos.length > 0) {\n    addActivityPhotosPage(doc, data.activityPhotos.slice(0, 4), 'portrait');\n  }\n}\n\n// Helper function untuk get shift employees\nfunction getShiftEmployees(data: ReportData, shift: string): any[] {\n  console.log(`ðŸ” PORTRAIT: Getting employees for ${shift}...`);\n  \n  // FIXED: Use same normalization logic as landscape mode\n  const normalizedShiftName = normalizeShift(shift);\n  const rosterFiltered = (data.roster || []).filter(r => {\n    const matchesDate = r.date === data.startDate;\n    const matchesShift = normalizeShift(r.shift) === normalizedShiftName;\n    return matchesDate && matchesShift;\n  });\n  \n  console.log(`ðŸŽ¯ PORTRAIT FILTERED: Found ${rosterFiltered.length} roster entries for ${shift} on ${data.startDate}`);\n  \n  // Build Map by employeeId with numeric coercion (same as landscape)\n  const rosterByEmp = new Map();\n  rosterFiltered.forEach(r => {\n    const empId = String(r.employeeId).trim();\n    const hariKerja = Number.parseInt(String(r.hariKerja), 10) || 0;\n    rosterByEmp.set(empId, {\n      ...r,\n      hariKerja: hariKerja\n    });\n  });\n  \n  console.log(`ðŸ—ºï¸ PORTRAIT MAP: Built map with ${rosterByEmp.size} entries`);\n  \n  // Build employee list from roster (same logic as landscape)\n  const scheduledEmployees = rosterFiltered.map(rosterRecord => {\n    const employee = data.employees.find(emp => emp.id === rosterRecord.employeeId);\n    const attendanceRecord = data.attendance.find(att => \n      att.employeeId === rosterRecord.employeeId && att.date === data.startDate\n    );\n    \n    if (!employee) {\n      console.warn(`âš ï¸ PORTRAIT: Employee not found: ${rosterRecord.employeeId}`);\n      return null;\n    }\n    \n    // Use Map-based lookup with employeeId (same as landscape)\n    const empId = String(employee.id).trim();\n    const rosterData = rosterByEmp.get(empId);\n    const hariKerja = rosterData?.hariKerja ?? 0;\n    \n    // Nomor Lambung fallback logic: actualNomorLambung â†’ plannedNomorLambung â†’ employee.nomorLambung\n    const nomorLambungDisplay = rosterData?.actualNomorLambung || rosterData?.plannedNomorLambung || employee.nomorLambung || '-';\n    \n    const enrichedRecord = {\n      ...employee,\n      hariKerja: hariKerja,\n      workDays: hariKerja, // For compatibility with existing portrait table code\n      shift: rosterRecord.shift,\n      jamTidur: attendanceRecord?.jamTidur || '',\n      fitToWork: attendanceRecord?.fitToWork || 'Fit To Work',\n      status: attendanceRecord ? 'present' : 'absent',\n      nomorLambungDisplay: nomorLambungDisplay, // Use this for PDF rendering\n    };\n    \n    return enrichedRecord;\n  }).filter(Boolean);\n  \n  console.log(`ðŸ“Š PORTRAIT RESULT: ${scheduledEmployees.length} employees mapped for ${shift}`);\n  \n  return scheduledEmployees;\n}\n\n// Function to add comprehensive attendance summary page\nfunction addAttendanceSummaryPage(doc: jsPDF, data: ReportData, margin: number, pageWidth: number, pageHeight: number) {\n  // Add new page for summary\n  doc.addPage();\n  \n  let yPosition = 30;\n  \n  // Title\n  doc.setFontSize(14);\n  doc.setFont('helvetica', 'bold');\n  const title = 'RINGKASAN KEHADIRAN - ANALISIS KOMPREHENSIF';\n  const titleWidth = doc.getTextWidth(title);\n  const titleX = (pageWidth - titleWidth) / 2;\n  doc.text(title, titleX, yPosition);\n  yPosition += 20;\n  \n  // Date info\n  doc.setFontSize(12);\n  doc.setFont('helvetica', 'normal');\n  doc.text(`Tanggal: ${data.startDate}`, margin, yPosition);\n  yPosition += 15;\n  \n  // ARCHITECT FIX: Use all shifts when shiftFilter === 'all', not limited by reportInfo.shift\n  // Normalize filter to uppercase for consistent comparison\n  const rawFilter = data.reportInfo?.shift || data.shiftFilter || 'all';\n  const effectiveFilter = normalizeShift(rawFilter);\n  \n  // Calculate statistics with leave consideration\n  const allRoster = data.roster?.filter(r => r.date === data.startDate) || [];\n  const shift1Roster = allRoster.filter(r => normalizeShift(r.shift) === 'SHIFT 1');\n  const shift2Roster = allRoster.filter(r => normalizeShift(r.shift) === 'SHIFT 2');\n  \n  // FIXED: Get employees on leave directly from roster data with shift=\"CUTI\"\n  // This matches exactly what the roster frontend shows - using normalization like shift1/2\n  const cutiRoster = allRoster.filter(r => normalizeShift(r.shift) === 'CUTI');\n  \n  console.log('ðŸ“Š CUTI CALCULATION DEBUG (FROM ROSTER DATA):', {\n    totalRosterRecords: allRoster.length,\n    employeesOnCutiToday: cutiRoster.length,\n    reportDate: data.startDate,\n    shift1Count: shift1Roster.length,\n    shift2Count: shift2Roster.length,\n    cutiCount: cutiRoster.length,\n    sampleRawShifts: allRoster.slice(0, 5).map(r => r.shift),\n    cutiList: cutiRoster.slice(0, 10).map(r => ({\n      employeeId: r.employeeId,\n      rawShift: r.shift,\n      normalizedShift: normalizeShift(r.shift)\n    }))\n  });\n  \n  // Calculate attendance with leave adjustment\n  const shift1Attended = data.attendance?.filter(a => {\n    const attendedEmployee = shift1Roster.find(r => r.employeeId === a.employeeId);\n    return attendedEmployee !== undefined;\n  }) || [];\n  \n  const shift2Attended = data.attendance?.filter(a => {\n    const attendedEmployee = shift2Roster.find(r => r.employeeId === a.employeeId);\n    return attendedEmployee !== undefined;\n  }) || [];\n  \n  // FIXED: Count cuti from roster directly, no need to adjust other shifts\n  // Since cuti employees are in separate roster entries with shift=\"CUTI\"\n  const totalCutiEmployees = cutiRoster.length;\n  \n  console.log('ðŸ” SHIFT BREAKDOWN (USING ROSTER DATA):', {\n    shift1Count: shift1Roster.length,\n    shift2Count: shift2Roster.length,\n    cutiCount: totalCutiEmployees,\n    totalRoster: allRoster.length,\n    calculationMatches: (shift1Roster.length + shift2Roster.length + totalCutiEmployees) === allRoster.length\n  });\n  \n  // No adjustment needed - each employee appears once in roster with their assigned shift\n  const shift1EffectiveScheduled = shift1Roster.length;\n  const shift2EffectiveScheduled = shift2Roster.length;\n  \n  // Main Statistics Table\n  doc.setFontSize(11);\n  doc.setFont('helvetica', 'bold');\n  doc.text('STATISTIK KEHADIRAN', margin, yPosition);\n  yPosition += 15;\n  \n  // Build statData based on filter - only show relevant shifts\n  const statData: string[][] = [\n    ['Shift', 'Dijadwalkan', 'Cuti', 'Efektif', 'Hadir', 'Tidak Hadir', '% Kehadiran']\n  ];\n  \n  // Add rows based on normalized filter (case-insensitive comparison)\n  switch (effectiveFilter) {\n    case 'SHIFT 1':\n      // Only show Shift 1 when filtered\n      statData.push(['Shift 1', shift1Roster.length.toString(), '0', shift1EffectiveScheduled.toString(), shift1Attended.length.toString(), (shift1EffectiveScheduled - shift1Attended.length).toString(), shift1EffectiveScheduled > 0 ? `${((shift1Attended.length / shift1EffectiveScheduled) * 100).toFixed(1)}%` : '0%']);\n      break;\n      \n    case 'SHIFT 2':\n      // Only show Shift 2 when filtered\n      statData.push(['Shift 2', shift2Roster.length.toString(), '0', shift2EffectiveScheduled.toString(), shift2Attended.length.toString(), (shift2EffectiveScheduled - shift2Attended.length).toString(), shift2EffectiveScheduled > 0 ? `${((shift2Attended.length / shift2EffectiveScheduled) * 100).toFixed(1)}%` : '0%']);\n      break;\n      \n    default:\n      // Show all shifts + total when filter is 'all' or 'ALL' or any other value\n      statData.push(['Shift 1', shift1Roster.length.toString(), '0', shift1EffectiveScheduled.toString(), shift1Attended.length.toString(), (shift1EffectiveScheduled - shift1Attended.length).toString(), shift1EffectiveScheduled > 0 ? `${((shift1Attended.length / shift1EffectiveScheduled) * 100).toFixed(1)}%` : '0%']);\n      statData.push(['Shift 2', shift2Roster.length.toString(), '0', shift2EffectiveScheduled.toString(), shift2Attended.length.toString(), (shift2EffectiveScheduled - shift2Attended.length).toString(), shift2EffectiveScheduled > 0 ? `${((shift2Attended.length / shift2EffectiveScheduled) * 100).toFixed(1)}%` : '0%']);\n      statData.push(['TOTAL', (shift1Roster.length + shift2Roster.length).toString(), totalCutiEmployees.toString(), (shift1EffectiveScheduled + shift2EffectiveScheduled).toString(), (shift1Attended.length + shift2Attended.length).toString(), ((shift1EffectiveScheduled + shift2EffectiveScheduled) - (shift1Attended.length + shift2Attended.length)).toString(), (shift1EffectiveScheduled + shift2EffectiveScheduled) > 0 ? `${(((shift1Attended.length + shift2Attended.length) / (shift1EffectiveScheduled + shift2EffectiveScheduled)) * 100).toFixed(1)}%` : '0%']);\n      break;\n  }\n  \n  // Improved table layout with better proportions and spacing\n  const colWidths = [60, 70, 45, 60, 50, 70, 75];\n  const tableWidth = colWidths.reduce((sum, width) => sum + width, 0);\n  const startX = margin + 10; // Left align with margin for better readability\n  \n  // Draw main statistics table with improved styling\n  statData.forEach((row, rowIndex) => {\n    let currentX = startX;\n    const rowHeight = 14; // Increased row height for better readability\n    \n    if (rowIndex === 0) {\n      // Header row\n      doc.setFillColor(60, 60, 60);\n      doc.rect(startX, yPosition - 6, tableWidth, rowHeight, 'F');\n      doc.setTextColor(255, 255, 255);\n      doc.setFont('helvetica', 'bold');\n      doc.setFontSize(9);\n    } else if (rowIndex === statData.length - 1) {\n      // Total row\n      doc.setFillColor(240, 240, 240);\n      doc.rect(startX, yPosition - 6, tableWidth, rowHeight, 'F');\n      doc.setTextColor(0, 0, 0);\n      doc.setFont('helvetica', 'bold');\n      doc.setFontSize(9);\n    } else {\n      // Data rows with alternating colors\n      if (rowIndex % 2 === 0) {\n        doc.setFillColor(250, 250, 250);\n        doc.rect(startX, yPosition - 6, tableWidth, rowHeight, 'F');\n      }\n      doc.setTextColor(0, 0, 0);\n      doc.setFont('helvetica', 'normal');\n      doc.setFontSize(9);\n    }\n    \n    row.forEach((cell, colIndex) => {\n      const cellWidth = colWidths[colIndex];\n      const textWidth = doc.getTextWidth(cell);\n      \n      // Better text alignment: left align for text columns, center for numbers\n      let textX;\n      if (colIndex === 0) { // Shift column - left align\n        textX = currentX + 5;\n      } else { // Numeric columns - center align\n        textX = currentX + (cellWidth - textWidth) / 2;\n      }\n      \n      doc.text(cell, textX, yPosition + 4);\n      \n      // Table borders\n      doc.setDrawColor(120, 120, 120);\n      doc.setLineWidth(0.3);\n      doc.rect(currentX, yPosition - 6, cellWidth, rowHeight);\n      \n      currentX += cellWidth;\n    });\n    \n    yPosition += rowHeight;\n  });\n  \n  yPosition += 20;\n  \n  // Fit To Work Analysis\n  doc.setTextColor(0, 0, 0);\n  doc.setFont('helvetica', 'bold');\n  doc.setFontSize(11);\n  doc.text('ANALISIS FIT TO WORK', margin, yPosition);\n  yPosition += 12;\n  \n  const fitToWorkCount = data.attendance?.filter(a => a.fitToWork === 'Fit To Work').length || 0;\n  const notFitCount = data.attendance?.filter(a => a.fitToWork && a.fitToWork !== 'Fit To Work').length || 0;\n  const totalWithFitData = fitToWorkCount + notFitCount;\n  \n  doc.setFont('helvetica', 'normal');\n  doc.setFontSize(10);\n  const bulletIndent = margin + 5; // Indentation for bullet points\n  const fitAnalysis = [\n    `â€¢ Fit To Work: ${fitToWorkCount} orang (${totalWithFitData > 0 ? ((fitToWorkCount / totalWithFitData) * 100).toFixed(1) : '0'}%)`,\n    `â€¢ Not Fit: ${notFitCount} orang (${totalWithFitData > 0 ? ((notFitCount / totalWithFitData) * 100).toFixed(1) : '0'}%)`,\n    `â€¢ Status tidak diketahui: ${(shift1Attended.length + shift2Attended.length) - totalWithFitData} orang`\n  ];\n  \n  fitAnalysis.forEach(item => {\n    doc.text(item, bulletIndent, yPosition);\n    yPosition += 8;\n  });\n  \n  yPosition += 15;\n  \n  // Jam Tidur Analysis\n  doc.setFont('helvetica', 'bold');\n  doc.setFontSize(11);\n  doc.text('ANALISIS JAM TIDUR', margin, yPosition);\n  yPosition += 12;\n  \n  const jamTidurData = data.attendance?.filter(a => a.jamTidur && a.jamTidur.trim() !== '').map(a => {\n    const jam = parseInt(a.jamTidur || '0');\n    return isNaN(jam) ? 0 : jam;\n  }) || [];\n  \n  const avgSleep = jamTidurData.length > 0 ? (jamTidurData.reduce((a, b) => a + b, 0) / jamTidurData.length).toFixed(1) : '0';\n  const shortSleep = jamTidurData.filter(j => j < 6).length;\n  const maxSleep = jamTidurData.length > 0 ? Math.max(...jamTidurData) : 0;\n  \n  doc.setFont('helvetica', 'normal');\n  doc.setFontSize(10);\n  const sleepAnalysis = [\n    `â€¢ Rata-rata jam tidur: ${avgSleep} jam`,\n    `â€¢ Karyawan kurang tidur (<6 jam): ${shortSleep} orang`,\n    `â€¢ Jam tidur maksimal: ${maxSleep} jam`,\n    `â€¢ Total data jam tidur: ${jamTidurData.length} dari ${shift1Attended.length + shift2Attended.length} hadir`\n  ];\n  \n  sleepAnalysis.forEach(item => {\n    doc.text(item, bulletIndent, yPosition);\n    yPosition += 8;\n  });\n  \n  yPosition += 15;\n  \n  // Performance Flags with background box\n  const totalEffective = shift1EffectiveScheduled + shift2EffectiveScheduled;\n  const totalPresent = shift1Attended.length + shift2Attended.length;\n  const overallRate = totalEffective > 0 ? ((totalPresent / totalEffective) * 100) : 0;\n  \n  let statusText = '';\n  let boxColor: [number, number, number] = [255, 255, 255];\n  let textColor: [number, number, number] = [0, 0, 0];\n  \n  if (overallRate < 90) {\n    statusText = 'PERINGATAN: Tingkat kehadiran di bawah 90%';\n    boxColor = [255, 230, 230]; // Light red background\n    textColor = [200, 0, 0]; // Dark red text\n  } else if (overallRate >= 95) {\n    statusText = 'EXCELLENT: Tingkat kehadiran sangat baik (>=95%)';\n    boxColor = [230, 255, 230]; // Light green background\n    textColor = [0, 120, 0]; // Dark green text\n  } else {\n    statusText = 'BAIK: Tingkat kehadiran memenuhi standar (90-94%)';\n    boxColor = [255, 245, 220]; // Light orange background\n    textColor = [200, 100, 0]; // Dark orange text\n  }\n  \n  // Draw background box for status\n  doc.setFont('helvetica', 'bold');\n  doc.setFontSize(10);\n  const statusTextWidth = doc.getTextWidth(statusText);\n  const boxPadding = 8;\n  const boxWidth = statusTextWidth + (boxPadding * 2);\n  const boxHeight = 12;\n  \n  doc.setFillColor(boxColor[0], boxColor[1], boxColor[2]);\n  doc.roundedRect(margin, yPosition - 6, boxWidth, boxHeight, 2, 2, 'F');\n  \n  // Draw border\n  doc.setDrawColor(textColor[0], textColor[1], textColor[2]);\n  doc.setLineWidth(0.5);\n  doc.roundedRect(margin, yPosition - 6, boxWidth, boxHeight, 2, 2, 'S');\n  \n  // Draw text\n  doc.setTextColor(textColor[0], textColor[1], textColor[2]);\n  doc.text(statusText, margin + boxPadding, yPosition + 2);\n  \n  yPosition += 20;\n  \n  // Summary Notes\n  doc.setTextColor(0, 0, 0);\n  doc.setFont('helvetica', 'normal');\n  doc.setFontSize(10);\n  const summaryNotes = [\n    `â€¢ Laporan dibuat pada: ${new Date().toLocaleString('id-ID')}`,\n    `â€¢ Data mencakup ${effectiveFilter === 'all' ? 'semua shift' : effectiveFilter}`,\n    `â€¢ Analisis berdasarkan ${totalPresent} kehadiran dari ${totalEffective} karyawan efektif`\n  ];\n  \n  summaryNotes.forEach(note => {\n    doc.text(note, bulletIndent, yPosition);\n    yPosition += 8;\n  });\n  \n  yPosition += 15;\n  \n  // CATATAN Section - moved from header to summary page\n  doc.setFont('helvetica', 'bold');\n  doc.setFontSize(11);\n  doc.text('CATATAN', margin, yPosition);\n  yPosition += 12;\n  \n  // Prepare catatan text\n  let catatanText = '';\n  if (data.reportInfo?.catatan && data.reportInfo.catatan.trim()) {\n    catatanText = data.reportInfo.catatan;\n    // Check if text appears to be meaningful content\n    const isGibberish = /^([a-zA-Z])\\1{4,}/.test(catatanText) || // Repeated chars like \"asdasdasd\"\n                       catatanText.length > 500 || // Excessively long\n                       !/[aeiouAEIOU]/.test(catatanText.replace(/\\s/g, '')); // No vowels (likely keyboard mashing)\n    \n    if (isGibberish) {\n      catatanText = '[Tidak ada catatan]';\n    }\n  } else {\n    catatanText = '[Tidak ada catatan]';\n  }\n  \n  // Draw catatan box\n  const catatanBoxWidth = pageWidth - (2 * margin);\n  const catatanBoxMinHeight = 30;\n  \n  doc.setFont('helvetica', 'normal');\n  doc.setFontSize(10);\n  \n  // Split text for wrapping\n  const maxCatatanWidth = catatanBoxWidth - 10; // Padding inside box\n  const catatanLines = doc.splitTextToSize(catatanText, maxCatatanWidth);\n  const catatanBoxHeight = Math.max(catatanBoxMinHeight, (catatanLines.length * 6) + 10);\n  \n  // Draw box with light gray background\n  doc.setFillColor(250, 250, 250);\n  doc.setDrawColor(180, 180, 180);\n  doc.setLineWidth(0.5);\n  doc.roundedRect(margin, yPosition - 5, catatanBoxWidth, catatanBoxHeight, 2, 2, 'FD');\n  \n  // Draw catatan text\n  doc.setTextColor(60, 60, 60);\n  doc.text(catatanLines, margin + 5, yPosition + 2);\n  \n  yPosition += catatanBoxHeight + 5;\n  \n  // Footer for summary page\n  addProfessionalFooter(doc, pageWidth, pageHeight, margin, 2); // Page 2\n}\n\n// Helper function to add activity photos page - 2 FOTO LANDSCAPE PER HALAMAN\nfunction addActivityPhotosPage(doc: jsPDF, photos: ActivityPhoto[], orientation: string = 'landscape'): void {\n  // Split photos into groups of 2 (2 photos per page)\n  const photosPerPage = 2;\n  const photoGroups: ActivityPhoto[][] = [];\n  \n  for (let i = 0; i < photos.length; i += photosPerPage) {\n    photoGroups.push(photos.slice(i, i + photosPerPage));\n  }\n  \n  // Get base page number before adding photo pages\n  const basePage = doc.getNumberOfPages();\n  \n  // Process each group on a separate page\n  photoGroups.forEach((group, groupIndex) => {\n    // Add new page\n    doc.addPage(orientation === 'portrait' ? 'portrait' : 'landscape');\n    \n    const pageWidth = doc.internal.pageSize.width;\n    const pageHeight = doc.internal.pageSize.height;\n    const margin = 15; // Margin minimal untuk maksimalkan foto\n    \n    // ==================== HEADER SECTION ====================\n    doc.setFont('helvetica', 'bold');\n    doc.setFontSize(18);\n    doc.setTextColor(220, 38, 38); // Red color\n    doc.text('Foto Kegiatan P5M', pageWidth / 2, margin + 8, { align: 'center' });\n    \n    // Underline dengan garis merah\n    doc.setLineWidth(2);\n    doc.setDrawColor(220, 38, 38);\n    doc.line(margin + 50, margin + 12, pageWidth - margin - 50, margin + 12);\n    \n    const yStart = margin + 28; // Start position untuk foto (lebih rapat ke header)\n    \n    // ==================== LAYOUT 2 FOTO VERTIKAL (ATAS-BAWAH) ====================\n    // Calculate dimensions untuk 2 foto vertikal dalam A4 landscape\n    const spaceBetween = 8; // Jarak tipis antar foto (atas-bawah)\n    const availableWidth = pageWidth - (2 * margin);\n    const captionSpace = 12; // Space untuk caption per foto\n    const availableHeight = pageHeight - yStart - margin;\n    \n    // Lebar penuh untuk setiap foto\n    const maxPhotoWidth = availableWidth;\n    \n    // Calculate slot height untuk setiap foto (include caption space)\n    const slotHeight = (availableHeight - spaceBetween - (2 * captionSpace)) / 2;\n    \n    // Process each photo in the group (max 2)\n    group.forEach((photo, index) => {\n      try {\n        // Get image properties\n        const imageProps = doc.getImageProperties(photo.dataUrl);\n        const aspectRatio = imageProps.width / imageProps.height;\n        \n        // Calculate optimal dimensions dengan aspect ratio terjaga\n        // Start dengan lebar penuh\n        let finalWidth = maxPhotoWidth;\n        let finalHeight = finalWidth / aspectRatio;\n        \n        // Jika tinggi melebihi slot height, scale down berdasarkan tinggi\n        if (finalHeight > slotHeight) {\n          finalHeight = slotHeight;\n          finalWidth = finalHeight * aspectRatio;\n        }\n        \n        // Calculate slot top position untuk foto ini\n        const slotTop = yStart + (index * (slotHeight + spaceBetween + captionSpace));\n        \n        // Center foto secara vertikal dalam slot\n        const photoY = slotTop + (slotHeight - finalHeight) / 2;\n        \n        // Center foto secara horizontal\n        const photoX = margin + (maxPhotoWidth - finalWidth) / 2;\n        \n        // Add image to PDF\n        doc.addImage(photo.dataUrl, 'JPEG', photoX, photoY, finalWidth, finalHeight);\n        \n        // Add border around image untuk tampilan professional\n        doc.setDrawColor(200, 200, 200);\n        doc.setLineWidth(0.8);\n        doc.rect(photoX, photoY, finalWidth, finalHeight);\n        \n        // Add caption di bawah slot foto (dalam caption space)\n        if (photo.caption && photo.caption.trim()) {\n          doc.setFont('helvetica', 'normal');\n          doc.setFontSize(9);\n          doc.setTextColor(0, 0, 0);\n          \n          // Caption positioned below the slot, not below the image\n          const captionY = slotTop + slotHeight + 8;\n          const wrapWidth = maxPhotoWidth - 20; // Small padding\n          const captionLines = doc.splitTextToSize(photo.caption, wrapWidth);\n          \n          // Truncate to fit in caption space (single line to prevent overflow)\n          const captionText = captionLines.length > 1 \n            ? captionLines[0] + '...' \n            : captionLines[0] || '';\n          \n          doc.text(captionText, pageWidth / 2, captionY, { align: 'center' });\n        }\n        \n      } catch (error) {\n        console.error('Error adding image to PDF:', error);\n        \n        // Add placeholder jika foto gagal dimuat\n        const slotTop = yStart + (index * (slotHeight + spaceBetween + captionSpace));\n        doc.setFillColor(240, 240, 240);\n        doc.rect(margin, slotTop, maxPhotoWidth, slotHeight, 'F');\n        \n        doc.setFont('helvetica', 'normal');\n        doc.setFontSize(12);\n        doc.setTextColor(128, 128, 128);\n        doc.text('Gambar tidak dapat dimuat', pageWidth / 2, slotTop + slotHeight / 2, { align: 'center' });\n      }\n    });\n    \n    // Add page footer dengan page number yang benar dan dinamis\n    const currentPageNumber = basePage + groupIndex + 1;\n    addProfessionalFooter(doc, pageWidth, pageHeight, margin, currentPageNumber);\n  });\n}\n","path":null,"size_bytes":68889,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/pages/leave-requests.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertLeaveRequestSchema } from \"@shared/schema\";\nimport type { Employee, InsertLeaveRequest } from \"@shared/schema\";\n\ninterface LeaveRequest {\n  id: string;\n  employeeId: string;\n  startDate: string;\n  endDate: string;\n  leaveType: string;\n  reason: string;\n  status: string;\n}\nimport { Plus, Calendar, CheckCircle, XCircle, Clock, AlertCircle } from \"lucide-react\";\nimport { z } from \"zod\";\nimport { useAutoSave } from \"@/hooks/useAutoSave\";\nimport { AutoSaveIndicator } from \"@/components/AutoSaveIndicator\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\nconst formSchema = insertLeaveRequestSchema;\n\nexport default function LeaveRequests() {\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const { toast } = useToast();\n\n  const { data: employees = [] } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  const { data: leaveRequests = [], isLoading } = useQuery<LeaveRequest[]>({\n    queryKey: [\"/api/leave-requests\"],\n    refetchInterval: 30000, // Refresh every 30 seconds\n  });\n\n  const form = useForm<z.infer<typeof formSchema>>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      employeeId: \"\",\n      startDate: \"\",\n      endDate: \"\",\n      leaveType: \"\",\n      reason: \"\",\n      status: \"pending\",\n    },\n  });\n\n  // Auto save hook for leave request form\n  const { saveStatus, clearDraft, hasDraft } = useAutoSave({\n    key: 'leave_request_new',\n    form,\n    exclude: [], // Save all fields for leave request\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: InsertLeaveRequest) => apiRequest(\"/api/leave-requests\", \"POST\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-requests\"] });\n      setIsDialogOpen(false);\n      form.reset();\n      clearDraft(); // Clear auto saved draft after successful save\n      toast({\n        title: \"Berhasil\",\n        description: \"Permohonan cuti berhasil diajukan\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal mengajukan permohonan cuti\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: ({ id, status }: { id: string; status: string }) =>\n      apiRequest(`/api/leave-requests/${id}`, \"PUT\", { status }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-requests\"] });\n      toast({\n        title: \"Berhasil\",\n        description: \"Status permohonan cuti berhasil diperbarui\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal memperbarui status permohonan cuti\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (values: z.infer<typeof formSchema>) => {\n    createMutation.mutate(values);\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'approved':\n        return <Badge className=\"bg-green-500 text-white\"><CheckCircle className=\"w-3 h-3 mr-1\" />Disetujui</Badge>;\n      case 'rejected':\n        return <Badge className=\"bg-red-500 text-white\"><XCircle className=\"w-3 h-3 mr-1\" />Ditolak</Badge>;\n      default:\n        return <Badge className=\"bg-yellow-500 text-white\"><Clock className=\"w-3 h-3 mr-1\" />Menunggu</Badge>;\n    }\n  };\n\n  const getEmployeeName = (employeeId: string) => {\n    const employee = employees.find(emp => emp.id === employeeId);\n    return employee ? employee.name : employeeId;\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <CardTitle>Permohonan Cuti</CardTitle>\n          <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"add-leave-request-button\">\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Ajukan Cuti\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[425px]\">\n              <DialogHeader>\n                <DialogTitle className=\"flex items-center justify-between\">\n                  <span>Ajukan Permohonan Cuti</span>\n                  <AutoSaveIndicator status={saveStatus} />\n                </DialogTitle>\n              </DialogHeader>\n              \n              {hasDraft() && (\n                <Alert>\n                  <AlertCircle className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    Draft tersimpan otomatis akan dipulihkan. Data yang belum disimpan akan tetap aman.\n                  </AlertDescription>\n                </Alert>\n              )}\n\n              <Form {...form}>\n                <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"employeeId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Karyawan</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"leave-employee-select\">\n                              <SelectValue placeholder=\"Pilih karyawan\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            {employees.map((employee) => (\n                              <SelectItem key={employee.id} value={employee.id}>\n                                {employee.id} - {employee.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"leaveType\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Jenis Cuti</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"leave-type-select\">\n                              <SelectValue placeholder=\"Pilih jenis cuti\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"annual\">Cuti Tahunan</SelectItem>\n                            <SelectItem value=\"sick\">Cuti Sakit</SelectItem>\n                            <SelectItem value=\"emergency\">Cuti Darurat</SelectItem>\n                            <SelectItem value=\"maternity\">Cuti Melahirkan</SelectItem>\n                            <SelectItem value=\"paternity\">Cuti Ayah</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"startDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Tanggal Mulai</FormLabel>\n                        <FormControl>\n                          <Input \n                            type=\"date\" \n                            {...field} \n                            data-testid=\"leave-start-date-input\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"endDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Tanggal Selesai</FormLabel>\n                        <FormControl>\n                          <Input \n                            type=\"date\" \n                            {...field} \n                            data-testid=\"leave-end-date-input\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"reason\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Alasan</FormLabel>\n                        <FormControl>\n                          <Textarea \n                            placeholder=\"Jelaskan alasan pengajuan cuti...\" \n                            {...field} \n                            value={field.value || \"\"}\n                            data-testid=\"leave-reason-textarea\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <div className=\"flex justify-end space-x-2\">\n                    <Button type=\"button\" variant=\"outline\" onClick={() => setIsDialogOpen(false)}>\n                      Batal\n                    </Button>\n                    <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"submit-leave-request-button\">\n                      {createMutation.isPending ? \"Menyimpan...\" : \"Ajukan Cuti\"}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {/* Leave Requests Table */}\n        <div className=\"overflow-x-auto\">\n          <table className=\"w-full table-auto\">\n            <thead>\n              <tr className=\"border-b border-gray-200 dark:border-gray-700\">\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Karyawan</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Jenis Cuti</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Tanggal</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Alasan</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Status</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Aksi</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-gray-200 dark:divide-gray-700\">\n              {isLoading ? (\n                <tr>\n                  <td colSpan={6} className=\"py-8 text-center text-gray-500 dark:text-gray-400\">\n                    Loading...\n                  </td>\n                </tr>\n              ) : leaveRequests.length === 0 ? (\n                <tr>\n                  <td colSpan={6} className=\"py-8 text-center text-gray-500 dark:text-gray-400\">\n                    Tidak ada permohonan cuti\n                  </td>\n                </tr>\n              ) : (\n                leaveRequests.map((request) => (\n                  <tr key={request.id} data-testid={`leave-request-row-${request.id}`}>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {getEmployeeName(request.employeeId)}\n                    </td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {request.leaveType}\n                    </td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {request.startDate} - {request.endDate}\n                    </td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white max-w-xs truncate\">\n                      {request.reason}\n                    </td>\n                    <td className=\"py-3 px-4\">\n                      {getStatusBadge(request.status)}\n                    </td>\n                    <td className=\"py-3 px-4\">\n                      {request.status === 'pending' && (\n                        <div className=\"flex space-x-2\">\n                          <Button\n                            size=\"sm\"\n                            onClick={() => updateStatusMutation.mutate({ id: request.id, status: 'approved' })}\n                            className=\"bg-green-500 hover:bg-green-600 text-white\"\n                            data-testid={`approve-leave-${request.id}`}\n                          >\n                            Setujui\n                          </Button>\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => updateStatusMutation.mutate({ id: request.id, status: 'rejected' })}\n                            className=\"border-red-500 text-red-500 hover:bg-red-50\"\n                            data-testid={`reject-leave-${request.id}`}\n                          >\n                            Tolak\n                          </Button>\n                        </div>\n                      )}\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":14416,"size_tokens":null},"client/src/pages/meeting-scanner.tsx":{"content":"import { useState, useRef, useCallback, useEffect } from \"react\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { QrCode, Camera, CameraOff, UserCheck, AlertCircle, CheckCircle, User, Calendar, Clock, MapPin, FileText } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport jsQR from \"jsqr\";\nimport type { Meeting } from \"@shared/schema\";\n\nexport default function MeetingScanner() {\n  const [isScanning, setIsScanning] = useState(false);\n  const [employeeId, setEmployeeId] = useState(\"\");\n  const [lastScanResult, setLastScanResult] = useState<any>(null);\n  const [meetingToken, setMeetingToken] = useState<string>(\"\");\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const streamRef = useRef<MediaStream | null>(null);\n  const { toast } = useToast();\n\n  // Manual attendance form schema\n  const manualAttendanceSchema = z.object({\n    namaKaryawan: z.string().min(1, \"Nama karyawan wajib diisi\"),\n    position: z.enum([\"Investor\", \"Korlap\"], { \n      required_error: \"Position wajib dipilih\" \n    }),\n    department: z.string().min(1, \"Department wajib dipilih\"),\n  });\n\n  const manualForm = useForm<z.infer<typeof manualAttendanceSchema>>({\n    resolver: zodResolver(manualAttendanceSchema),\n    defaultValues: {\n      namaKaryawan: \"\",\n      position: undefined,\n      department: \"\",\n    },\n  });\n\n  // Get token from URL parameters\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const token = urlParams.get('token');\n    if (token) {\n      setMeetingToken(token);\n    }\n  }, []);\n\n  // Fetch meeting details if token is available\n  const { data: meeting, isLoading: isLoadingMeeting } = useQuery({\n    queryKey: ['/api/meetings/by-token', meetingToken],\n    queryFn: () => apiRequest(`/api/meetings/by-token/${meetingToken}`, \"GET\"),\n    enabled: !!meetingToken,\n  });\n\n  // Fetch investor groups for dropdown\n  const { data: investorGroups } = useQuery({\n    queryKey: ['/api/investor-groups'],\n    queryFn: () => apiRequest('/api/investor-groups', 'GET'),\n  });\n\n  const attendanceMutation = useMutation({\n    mutationFn: async (data: { qrToken: string; employeeId: string }) => {\n      return await apiRequest(\"/api/meetings/qr-scan\", \"POST\", data);\n    },\n    onSuccess: (data) => {\n      setLastScanResult(data);\n      toast({\n        title: \"Absensi Berhasil!\",\n        description: data.message,\n      });\n      // Reset employee ID after successful scan\n      setEmployeeId(\"\");\n    },\n    onError: (error: any) => {\n      let errorMessage = error.message || \"Gagal melakukan absensi\";\n      let errorTitle = \"Absensi Gagal\";\n      \n      // Handle specific meeting errors  \n      if (error.message?.includes(\"Already attended\")) {\n        errorTitle = \"Sudah Absen\";\n        errorMessage = \"Anda sudah melakukan absensi untuk meeting ini sebelumnya\";\n      } else if (error.message?.includes(\"Employee not found\")) {\n        errorTitle = \"Karyawan Tidak Ditemukan\";\n        errorMessage = \"NIK yang dimasukkan tidak terdaftar dalam sistem\";\n      } else if (error.message?.includes(\"Meeting not found\")) {\n        errorTitle = \"Meeting Tidak Ditemukan\";\n        errorMessage = \"QR Code meeting tidak valid atau meeting sudah tidak aktif\";\n      }\n      \n      setLastScanResult({ error: errorMessage });\n      toast({\n        title: errorTitle,\n        description: errorMessage,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Manual attendance mutation\n  const manualAttendanceMutation = useMutation({\n    mutationFn: async (data: z.infer<typeof manualAttendanceSchema>) => {\n      if (!meeting?.id) throw new Error(\"Meeting not found\");\n      return await apiRequest(`/api/meetings/${meeting.id}/manual-attendance`, \"POST\", {\n        attendanceType: \"manual_entry\",\n        manualName: data.namaKaryawan,\n        manualPosition: data.position,\n        manualDepartment: data.department,\n        scanTime: new Date().toTimeString().split(' ')[0],\n        scanDate: new Date().toISOString().split('T')[0],\n        deviceInfo: navigator.userAgent || 'Manual Entry'\n      });\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Absensi Manual Berhasil!\",\n        description: `${data.manualName} (${data.manualPosition}) telah dicatat sebagai hadir`,\n      });\n      manualForm.reset();\n      // Invalidate queries to refresh data\n      queryClient.invalidateQueries({ queryKey: ['/api/meetings', meeting?.id, 'attendance'] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Absensi Manual Gagal\",\n        description: error.message || \"Terjadi kesalahan saat mencatat absensi manual\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Handle manual form submission\n  const onManualSubmit = (data: z.infer<typeof manualAttendanceSchema>) => {\n    manualAttendanceMutation.mutate(data);\n  };\n\n  // Handle form submission for direct attendance\n  const handleFormSubmit = () => {\n    if (!employeeId.trim()) {\n      toast({\n        title: \"NIK Diperlukan\",\n        description: \"Silakan masukkan NIK karyawan\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!meetingToken) {\n      toast({\n        title: \"Token Meeting Tidak Ditemukan\",\n        description: \"Silakan scan QR code meeting yang valid\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    attendanceMutation.mutate({\n      qrToken: meetingToken,\n      employeeId: employeeId.trim()\n    });\n  };\n\n  const startCamera = useCallback(async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({\n        video: { facingMode: \"environment\" } // Use back camera if available\n      });\n      \n      if (videoRef.current) {\n        videoRef.current.srcObject = stream;\n        streamRef.current = stream;\n        setIsScanning(true);\n        \n        // Start scanning process\n        const scanQR = () => {\n          if (videoRef.current && canvasRef.current && isScanning) {\n            const video = videoRef.current;\n            const canvas = canvasRef.current;\n            const context = canvas.getContext(\"2d\");\n\n            if (context && video.readyState === video.HAVE_ENOUGH_DATA) {\n              canvas.height = video.videoHeight;\n              canvas.width = video.videoWidth;\n              context.drawImage(video, 0, 0, canvas.width, canvas.height);\n              \n              const imageData = context.getImageData(0, 0, canvas.width, canvas.height);\n              const code = jsQR(imageData.data, imageData.width, imageData.height);\n\n              if (code && code.data) {\n                let qrToken = null;\n                \n                // Try to parse as JSON first\n                try {\n                  const qrData = JSON.parse(code.data);\n                  if (qrData.type === \"meeting\" && qrData.token) {\n                    qrToken = qrData.token;\n                  }\n                } catch (parseError) {\n                  // If JSON parsing fails, try to parse as URL\n                  try {\n                    const url = new URL(code.data);\n                    \n                    // Handle direct meeting scanner URLs\n                    if (url.pathname.includes('/meeting-scanner')) {\n                      qrToken = url.searchParams.get('token');\n                    }\n                    // Handle QR redirect URLs (new format)\n                    else if (url.pathname.includes('/qr-redirect')) {\n                      const data = url.searchParams.get('data');\n                      if (data) {\n                        try {\n                          const decodedData = decodeURIComponent(data);\n                          const redirectQrData = JSON.parse(decodedData);\n                          if (redirectQrData.type === \"meeting\" && redirectQrData.token) {\n                            qrToken = redirectQrData.token;\n                          }\n                        } catch (nestedParseError) {\n                          console.log('Failed to parse QR redirect data:', nestedParseError);\n                        }\n                      }\n                    }\n                  } catch (urlError) {\n                    // Neither JSON nor URL, continue scanning\n                    console.log('QR code format not recognized:', code.data);\n                  }\n                }\n                \n                // If we found a valid meeting token and have employee ID\n                if (qrToken && employeeId) {\n                  // Stop scanning when QR code is detected\n                  stopCamera();\n                  \n                  // Show loading state\n                  toast({\n                    title: \"QR Code Detected\",\n                    description: \"Memproses absensi meeting...\",\n                  });\n                  \n                  attendanceMutation.mutate({\n                    qrToken: qrToken,\n                    employeeId: employeeId\n                  });\n                  return;\n                }\n              }\n            }\n            \n            // Continue scanning\n            requestAnimationFrame(scanQR);\n          }\n        };\n        \n        // Start scanning loop\n        videoRef.current.addEventListener('loadedmetadata', () => {\n          scanQR();\n        });\n      }\n    } catch (error) {\n      console.error(\"Error accessing camera:\", error);\n      toast({\n        title: \"Camera Error\",\n        description: \"Tidak dapat mengakses kamera. Pastikan izin kamera telah diberikan.\",\n        variant: \"destructive\",\n      });\n    }\n  }, [employeeId, isScanning, attendanceMutation]);\n\n  const stopCamera = useCallback(() => {\n    if (streamRef.current) {\n      streamRef.current.getTracks().forEach(track => track.stop());\n      streamRef.current = null;\n    }\n    setIsScanning(false);\n  }, []);\n\n  const handleStartScan = () => {\n    if (!employeeId.trim()) {\n      toast({\n        title: \"NIK Required\",\n        description: \"Masukkan NIK karyawan terlebih dahulu\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    startCamera();\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-4\">\n      <div className=\"max-w-md mx-auto\">\n        <div className=\"text-center mb-6\">\n          <QrCode className=\"w-16 h-16 text-red-600 mx-auto mb-4\" />\n          <h1 className=\"text-2xl font-bold text-gray-900 dark:text-white\">\n            Absensi Meeting\n          </h1>\n          <p className=\"text-gray-600 dark:text-gray-400 mt-2\">\n            {meetingToken ? \"Form absensi meeting\" : \"Scan QR code meeting untuk melakukan absensi\"}\n          </p>\n          \n          {meetingToken && (\n            <div className=\"bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg mt-4\">\n              <p className=\"text-sm text-blue-800 dark:text-blue-200\">\n                âœ… QR Code Meeting terdeteksi - Silakan isi form absensi di bawah\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Meeting Information Card */}\n        {meetingToken && meeting && !isLoadingMeeting && (\n          <Card className=\"mb-6\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Calendar className=\"w-5 h-5 text-blue-600\" />\n                Informasi Meeting\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center gap-2\">\n                  <User className=\"w-4 h-4 text-gray-500\" />\n                  <span className=\"font-medium\">{meeting.title}</span>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Calendar className=\"w-4 h-4 text-gray-500\" />\n                  <span>{new Date(meeting.date).toLocaleDateString('id-ID')}</span>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Clock className=\"w-4 h-4 text-gray-500\" />\n                  <span>{meeting.startTime} - {meeting.endTime}</span>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <MapPin className=\"w-4 h-4 text-gray-500\" />\n                  <span>{meeting.location}</span>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <User className=\"w-4 h-4 text-gray-500\" />\n                  <span>Penyelenggara: {meeting.organizer}</span>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Attendance Tabs */}\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <UserCheck className=\"w-5 h-5\" />\n              Form Absensi\n            </CardTitle>\n            <CardDescription>\n              {meetingToken ? \"Pilih metode absensi yang Anda inginkan\" : \"Scan QR code meeting atau isi form manual untuk absensi\"}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Tabs defaultValue=\"qr-scan\" className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-2 mb-6\">\n                <TabsTrigger value=\"qr-scan\" data-testid=\"tab-qr-scan\">\n                  <QrCode className=\"w-4 h-4 mr-2\" />\n                  Scan QR Code\n                </TabsTrigger>\n                <TabsTrigger value=\"manual-entry\" data-testid=\"tab-manual-entry\" disabled={!meetingToken}>\n                  <FileText className=\"w-4 h-4 mr-2\" />\n                  Entry Manual\n                </TabsTrigger>\n              </TabsList>\n\n              {/* QR Code Scan Tab */}\n              <TabsContent value=\"qr-scan\" className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"employeeId\">NIK Karyawan</Label>\n                  <Input\n                    id=\"employeeId\"\n                    type=\"text\"\n                    placeholder=\"Masukkan NIK karyawan\"\n                    value={employeeId}\n                    onChange={(e) => setEmployeeId(e.target.value)}\n                    disabled={attendanceMutation.isPending}\n                    data-testid=\"input-employee-id\"\n                    onKeyPress={(e) => {\n                      if (e.key === 'Enter' && meetingToken) {\n                        handleFormSubmit();\n                      }\n                    }}\n                  />\n                </div>\n\n                {meetingToken ? (\n                  <Button\n                    onClick={handleFormSubmit}\n                    disabled={attendanceMutation.isPending || !employeeId.trim()}\n                    className=\"w-full bg-green-600 hover:bg-green-700\"\n                    data-testid=\"button-submit-attendance\"\n                  >\n                    {attendanceMutation.isPending ? (\n                      <>\n                        <AlertCircle className=\"w-4 h-4 mr-2 animate-spin\" />\n                        Memproses Absensi...\n                      </>\n                    ) : (\n                      <>\n                        <CheckCircle className=\"w-4 h-4 mr-2\" />\n                        Absen Sekarang\n                      </>\n                    )}\n                  </Button>\n                ) : (\n                  <Button\n                    onClick={handleStartScan}\n                    disabled={!employeeId.trim() || isScanning || attendanceMutation.isPending}\n                    className=\"w-full bg-red-600 hover:bg-red-700\"\n                    data-testid=\"button-start-scan\"\n                  >\n                    {isScanning ? (\n                      <>\n                        <CameraOff className=\"w-4 h-4 mr-2\" />\n                        Sedang Scanning...\n                      </>\n                    ) : (\n                      <>\n                        <Camera className=\"w-4 h-4 mr-2\" />\n                        Mulai Scan QR Code\n                      </>\n                    )}\n                  </Button>\n                )}\n\n                {/* Camera View */}\n                {isScanning && (\n                  <div className=\"mt-6 p-4 border rounded-lg bg-gray-50 dark:bg-gray-800\">\n                    <div className=\"text-center mb-4\">\n                      <h3 className=\"text-lg font-semibold flex items-center justify-center gap-2\">\n                        <Camera className=\"w-5 h-5\" />\n                        Kamera QR Scanner\n                      </h3>\n                      <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\n                        Arahkan kamera ke QR code meeting\n                      </p>\n                    </div>\n                    <div className=\"relative\">\n                      <video\n                        ref={videoRef}\n                        autoPlay\n                        playsInline\n                        className=\"w-full rounded-lg\"\n                        data-testid=\"video-scanner\"\n                      />\n                      <canvas\n                        ref={canvasRef}\n                        className=\"hidden\"\n                      />\n                      \n                      {/* Scanning overlay */}\n                      <div className=\"absolute inset-0 border-2 border-red-500 rounded-lg pointer-events-none\">\n                        <div className=\"absolute top-4 left-4 w-6 h-6 border-t-4 border-l-4 border-red-500\"></div>\n                        <div className=\"absolute top-4 right-4 w-6 h-6 border-t-4 border-r-4 border-red-500\"></div>\n                        <div className=\"absolute bottom-4 left-4 w-6 h-6 border-b-4 border-l-4 border-red-500\"></div>\n                        <div className=\"absolute bottom-4 right-4 w-6 h-6 border-b-4 border-r-4 border-red-500\"></div>\n                      </div>\n                      \n                      <div className=\"absolute bottom-2 left-2 right-2 bg-black bg-opacity-50 text-white text-xs p-2 rounded text-center\">\n                        Memindai QR code meeting...\n                      </div>\n                    </div>\n                    <Button\n                      onClick={stopCamera}\n                      variant=\"outline\"\n                      className=\"w-full mt-4\"\n                      data-testid=\"button-stop-scan\"\n                    >\n                      <CameraOff className=\"w-4 h-4 mr-2\" />\n                      Hentikan Scanner\n                    </Button>\n                  </div>\n                )}\n              </TabsContent>\n\n              {/* Manual Entry Tab */}\n              <TabsContent value=\"manual-entry\" className=\"space-y-4\">\n                {!meetingToken ? (\n                  <div className=\"text-center p-6 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg\">\n                    <AlertCircle className=\"w-12 h-12 text-yellow-600 mx-auto mb-4\" />\n                    <p className=\"text-yellow-800 dark:text-yellow-200\">\n                      Silakan scan QR code meeting terlebih dahulu untuk mengaktifkan entry manual\n                    </p>\n                  </div>\n                ) : (\n                  <Form {...manualForm}>\n                    <form onSubmit={manualForm.handleSubmit(onManualSubmit)} className=\"space-y-4\">\n                      {/* Current Date and Time Display */}\n                      <div className=\"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg\">\n                        <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                          <div>\n                            <span className=\"font-medium text-blue-800 dark:text-blue-200\">Tanggal:</span>\n                            <div className=\"text-blue-700 dark:text-blue-300\">\n                              {new Date().toLocaleDateString('id-ID', {\n                                weekday: 'long',\n                                year: 'numeric',\n                                month: 'long',\n                                day: 'numeric'\n                              })}\n                            </div>\n                          </div>\n                          <div>\n                            <span className=\"font-medium text-blue-800 dark:text-blue-200\">Waktu:</span>\n                            <div className=\"text-blue-700 dark:text-blue-300\">\n                              {new Date().toLocaleTimeString('id-ID', {\n                                hour: '2-digit',\n                                minute: '2-digit'\n                              })}\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Nama Karyawan */}\n                      <FormField\n                        control={manualForm.control}\n                        name=\"namaKaryawan\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Nama Karyawan</FormLabel>\n                            <FormControl>\n                              <Input\n                                placeholder=\"Masukkan nama lengkap karyawan\"\n                                data-testid=\"input-manual-name\"\n                                {...field}\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      {/* Position */}\n                      <FormField\n                        control={manualForm.control}\n                        name=\"position\"\n                        render={({ field }) => (\n                          <FormItem className=\"space-y-3\">\n                            <FormLabel>Posisi</FormLabel>\n                            <FormControl>\n                              <RadioGroup\n                                onValueChange={field.onChange}\n                                value={field.value}\n                                className=\"flex flex-col space-y-2\"\n                                data-testid=\"radio-manual-position\"\n                              >\n                                <div className=\"flex items-center space-x-2\">\n                                  <RadioGroupItem value=\"Investor\" id=\"investor\" />\n                                  <Label htmlFor=\"investor\">Investor</Label>\n                                </div>\n                                <div className=\"flex items-center space-x-2\">\n                                  <RadioGroupItem value=\"Korlap\" id=\"korlap\" />\n                                  <Label htmlFor=\"korlap\">Korlap</Label>\n                                </div>\n                              </RadioGroup>\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      {/* Department */}\n                      <FormField\n                        control={manualForm.control}\n                        name=\"department\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Department</FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value}>\n                              <FormControl>\n                                <SelectTrigger data-testid=\"select-manual-department\">\n                                  <SelectValue placeholder=\"Pilih department\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                {investorGroups?.investorGroups?.map((group: string) => (\n                                  <SelectItem key={group} value={group}>\n                                    {group}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <Button\n                        type=\"submit\"\n                        disabled={manualAttendanceMutation.isPending}\n                        className=\"w-full bg-blue-600 hover:bg-blue-700\"\n                        data-testid=\"button-submit-manual\"\n                      >\n                        {manualAttendanceMutation.isPending ? (\n                          <>\n                            <AlertCircle className=\"w-4 h-4 mr-2 animate-spin\" />\n                            Memproses Entry Manual...\n                          </>\n                        ) : (\n                          <>\n                            <CheckCircle className=\"w-4 h-4 mr-2\" />\n                            Simpan Absensi Manual\n                          </>\n                        )}\n                      </Button>\n                    </form>\n                  </Form>\n                )}\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n\n        {/* Scan Result */}\n        {lastScanResult && (\n          <Card className={`mb-6 ${lastScanResult.error ? 'border-red-200' : 'border-green-200'}`}>\n            <CardHeader>\n              <CardTitle className={`text-lg flex items-center gap-2 ${lastScanResult.error ? 'text-red-600' : 'text-green-600'}`}>\n                {lastScanResult.error ? (\n                  <>\n                    <AlertCircle className=\"w-5 h-5\" />\n                    Absensi Gagal\n                  </>\n                ) : (\n                  <>\n                    <CheckCircle className=\"w-5 h-5\" />\n                    Absensi Berhasil\n                  </>\n                )}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {lastScanResult.error ? (\n                <div className=\"text-red-600 text-sm\">\n                  {lastScanResult.error}\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  <div className=\"text-green-600 font-medium\">\n                    {lastScanResult.message}\n                  </div>\n                  \n                  {lastScanResult.meeting && (\n                    <div className=\"text-sm text-gray-600 dark:text-gray-400 space-y-1\">\n                      <div><strong>Meeting:</strong> {lastScanResult.meeting.title}</div>\n                      <div><strong>Tanggal:</strong> {new Date(lastScanResult.meeting.date).toLocaleDateString('id-ID')}</div>\n                      <div><strong>Waktu:</strong> {lastScanResult.meeting.startTime} - {lastScanResult.meeting.endTime}</div>\n                      <div><strong>Lokasi:</strong> {lastScanResult.meeting.location}</div>\n                    </div>\n                  )}\n                  \n                  {lastScanResult.employee && (\n                    <div className=\"text-sm text-gray-600 dark:text-gray-400 mt-3 pt-3 border-t space-y-1\">\n                      <div><strong>Nama:</strong> {lastScanResult.employee.name}</div>\n                      <div><strong>NIK:</strong> {lastScanResult.employee.id}</div>\n                      <div><strong>Posisi:</strong> {lastScanResult.employee.position || '-'}</div>\n                    </div>\n                  )}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Instructions */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Cara Penggunaan</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Tabs defaultValue=\"qr-instructions\" className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-2 mb-4\">\n                <TabsTrigger value=\"qr-instructions\" className=\"text-xs\">\n                  <QrCode className=\"w-3 h-3 mr-1\" />\n                  Scan QR\n                </TabsTrigger>\n                <TabsTrigger value=\"manual-instructions\" className=\"text-xs\">\n                  <FileText className=\"w-3 h-3 mr-1\" />\n                  Manual\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"qr-instructions\">\n                <div className=\"space-y-3 text-sm text-gray-600 dark:text-gray-400\">\n                  <div className=\"flex items-start gap-2\">\n                    <div className=\"w-6 h-6 bg-red-100 text-red-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5\">\n                      1\n                    </div>\n                    <div>Masukkan NIK karyawan pada form di atas</div>\n                  </div>\n                  \n                  <div className=\"flex items-start gap-2\">\n                    <div className=\"w-6 h-6 bg-red-100 text-red-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5\">\n                      2\n                    </div>\n                    <div>Tekan tombol \"Mulai Scan QR Code\" untuk mengaktifkan kamera</div>\n                  </div>\n                  \n                  <div className=\"flex items-start gap-2\">\n                    <div className=\"w-6 h-6 bg-red-100 text-red-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5\">\n                      3\n                    </div>\n                    <div>Arahkan kamera ke QR code meeting yang telah disediakan</div>\n                  </div>\n                  \n                  <div className=\"flex items-start gap-2\">\n                    <div className=\"w-6 h-6 bg-red-100 text-red-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5\">\n                      4\n                    </div>\n                    <div>Tunggu hingga sistem berhasil memindai dan memproses absensi</div>\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"manual-instructions\">\n                <div className=\"space-y-3 text-sm text-gray-600 dark:text-gray-400\">\n                  <div className=\"flex items-start gap-2\">\n                    <div className=\"w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5\">\n                      1\n                    </div>\n                    <div>Pastikan QR code meeting telah discan terlebih dahulu</div>\n                  </div>\n                  \n                  <div className=\"flex items-start gap-2\">\n                    <div className=\"w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5\">\n                      2\n                    </div>\n                    <div>Pilih tab \"Entry Manual\" untuk mengakses form manual</div>\n                  </div>\n                  \n                  <div className=\"flex items-start gap-2\">\n                    <div className=\"w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5\">\n                      3\n                    </div>\n                    <div>Isi nama karyawan, pilih posisi (Investor/Korlap), dan pilih department</div>\n                  </div>\n                  \n                  <div className=\"flex items-start gap-2\">\n                    <div className=\"w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5\">\n                      4\n                    </div>\n                    <div>Tekan \"Simpan Absensi Manual\" untuk mencatat kehadiran</div>\n                  </div>\n                  \n                  <div className=\"mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg\">\n                    <p className=\"text-xs text-yellow-800 dark:text-yellow-200\">\n                      <strong>Catatan:</strong> Entry manual hanya dapat digunakan setelah QR code meeting berhasil discan dan untuk peserta yang tidak memiliki NIK terdaftar dalam sistem.\n                    </p>\n                  </div>\n                </div>\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":32932,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/ui/loading-screen.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface LoadingScreenProps {\n  isLoading: boolean;\n  onComplete?: () => void;\n  className?: string;\n}\n\nexport function LoadingScreen({ isLoading, onComplete, className }: LoadingScreenProps) {\n  const [fadeOut, setFadeOut] = useState(false);\n\n  useEffect(() => {\n    if (!isLoading) return;\n\n    let timeoutId: NodeJS.Timeout;\n\n    const startLoading = () => {\n      timeoutId = setTimeout(() => {\n        setFadeOut(true);\n        setTimeout(() => {\n          setFadeOut(false);\n          onComplete?.();\n        }, 300);\n      }, 1500);\n    };\n\n    startLoading();\n\n    return () => {\n      clearTimeout(timeoutId);\n    };\n  }, [isLoading, onComplete]);\n\n  if (!isLoading && !fadeOut) return null;\n\n  const brandName = \"OneTalent\";\n\n  return (\n    <div\n      className={cn(\n        \"fixed inset-0 z-50 flex items-center justify-center\",\n        \"bg-white dark:bg-gray-900\",\n        \"transition-opacity duration-300 ease-in-out\",\n        fadeOut ? \"opacity-0\" : \"opacity-100\",\n        className\n      )}\n    >\n      <div className=\"flex flex-col items-center space-y-8\">\n        \n        {/* Bouncing OneTalent letters */}\n        <div className=\"flex items-end justify-center\">\n          {brandName.split('').map((letter, index) => (\n            <div key={index} className=\"flex flex-col items-center\">\n              <span\n                className=\"text-4xl font-bold text-[#E53935] animate-bounce-dot\"\n                style={{ animationDelay: `${index * 0.08}s` }}\n              >\n                {letter}\n              </span>\n              <div\n                className=\"w-4 h-1 rounded-full bg-red-300/40 mt-1 animate-shadow-pulse\"\n                style={{ animationDelay: `${index * 0.08}s` }}\n              />\n            </div>\n          ))}\n        </div>\n\n        {/* Subtitle */}\n        <div className=\"text-center\">\n          <p className=\"text-gray-600 dark:text-gray-400 text-sm font-medium\">\n            Kerja Aman Keselamatan Number One\n          </p>\n        </div>\n\n        {/* Loading text */}\n        <p className=\"text-gray-500 dark:text-gray-400 text-sm animate-pulse\">\n          Memuat aplikasi...\n        </p>\n        \n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":2259,"size_tokens":null},"client/src/components/qr/driver-qr-generator.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Download, QrCode, Smartphone, Monitor } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport QRCode from \"qrcode\";\nimport type { Employee } from \"@shared/schema\";\n\ninterface DriverQRGeneratorProps {\n  className?: string;\n}\n\nexport function DriverQRGenerator({ className }: DriverQRGeneratorProps) {\n  const [selectedEmployeeId, setSelectedEmployeeId] = useState<string>(\"\");\n  const [qrType, setQrType] = useState<\"mobile\" | \"desktop\">(\"mobile\");\n  const [qrDataURL, setQrDataURL] = useState<string>(\"\");\n  const [isGenerating, setIsGenerating] = useState(false);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const { toast } = useToast();\n\n  // Fetch all employees\n  const { data: employees = [], isLoading } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n    staleTime: 10 * 60 * 1000, // 10 minutes cache\n  });\n\n  const selectedEmployee = employees.find(emp => emp.id === selectedEmployeeId);\n\n  const generateDriverQR = async () => {\n    if (!selectedEmployee) {\n      toast({\n        title: \"Error\",\n        description: \"Silakan pilih karyawan terlebih dahulu\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsGenerating(true);\n    try {\n      // Create URL for driver view\n      const baseUrl = window.location.origin;\n      const driverPath = qrType === \"mobile\" ? \"/mobile-driver\" : \"/driver-view\";\n      const driverUrl = `${baseUrl}${driverPath}?nik=${encodeURIComponent(selectedEmployee.id)}`;\n\n      // Generate QR code\n      const dataURL = await QRCode.toDataURL(driverUrl, {\n        width: 300,\n        margin: 2,\n        color: {\n          dark: '#000000',\n          light: '#FFFFFF'\n        }\n      });\n\n      setQrDataURL(dataURL);\n\n      toast({\n        title: \"QR Code Generated\",\n        description: `QR Code Driver View berhasil dibuat untuk ${selectedEmployee.name}`,\n      });\n    } catch (error) {\n      console.error(\"QR Generation error:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Gagal membuat QR Code\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  const downloadQR = () => {\n    if (!qrDataURL || !selectedEmployee) return;\n\n    const link = document.createElement('a');\n    link.href = qrDataURL;\n    link.download = `driver-view-qr-${selectedEmployee.name.replace(/[^a-zA-Z0-9]/g, '-')}-${qrType}.png`;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n\n    toast({\n      title: \"QR Code Downloaded\",\n      description: `QR code driver view untuk ${selectedEmployee.name} berhasil didownload`,\n    });\n  };\n\n  const printQR = () => {\n    if (!qrDataURL || !selectedEmployee) return;\n\n    const printWindow = window.open('', '_blank');\n    if (printWindow) {\n      printWindow.document.write(`\n        <html>\n          <head>\n            <title>QR Code Driver View - ${selectedEmployee.name}</title>\n            <style>\n              body { \n                margin: 0; \n                padding: 20px; \n                text-align: center; \n                font-family: Arial, sans-serif;\n              }\n              .header { \n                margin-bottom: 20px; \n                font-size: 24px; \n                font-weight: bold;\n              }\n              .employee-info { \n                margin-bottom: 20px; \n                font-size: 16px;\n              }\n              .qr-container { \n                margin: 20px auto; \n                padding: 20px;\n                border: 2px solid #000;\n                display: inline-block;\n              }\n              .instructions {\n                margin-top: 20px;\n                font-size: 12px;\n                color: #666;\n              }\n              @media print {\n                body { margin: 0; }\n              }\n            </style>\n          </head>\n          <body>\n            <div class=\"header\">QR CODE DRIVER VIEW</div>\n            <div class=\"employee-info\">\n              <div><strong>Nama:</strong> ${selectedEmployee.name}</div>\n              <div><strong>NIK:</strong> ${selectedEmployee.id}</div>\n              <div><strong>Type:</strong> ${qrType === 'mobile' ? 'Mobile View' : 'Desktop View'}</div>\n            </div>\n            <div class=\"qr-container\">\n              <img src=\"${qrDataURL}\" alt=\"QR Code Driver View\" />\n            </div>\n            <div class=\"instructions\">\n              <p><strong>Cara Scan:</strong></p>\n              <p>1. Buka aplikasi barcode scanner di smartphone</p>\n              <p>2. Arahkan kamera ke QR code di atas</p>\n              <p>3. Sistem akan otomatis mengarahkan ke halaman Driver View karyawan</p>\n            </div>\n          </body>\n        </html>\n      `);\n      printWindow.document.close();\n      printWindow.print();\n    }\n  };\n\n  return (\n    <div className={className}>\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <QrCode className=\"w-5 h-5\" />\n            Generate QR Code Driver View\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* Employee Selection */}\n          <div className=\"space-y-2\">\n            <label className=\"text-sm font-medium\">Pilih Karyawan</label>\n            <Select value={selectedEmployeeId} onValueChange={setSelectedEmployeeId} disabled={isLoading}>\n              <SelectTrigger data-testid=\"select-employee\">\n                <SelectValue placeholder=\"Pilih karyawan...\" />\n              </SelectTrigger>\n              <SelectContent>\n                {employees.map((employee) => (\n                  <SelectItem key={employee.id} value={employee.id}>\n                    {employee.name} ({employee.id})\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* QR Type Selection */}\n          <div className=\"space-y-2\">\n            <label className=\"text-sm font-medium\">Jenis Driver View</label>\n            <Select value={qrType} onValueChange={(value: \"mobile\" | \"desktop\") => setQrType(value)}>\n              <SelectTrigger data-testid=\"select-qr-type\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"mobile\">\n                  <div className=\"flex items-center gap-2\">\n                    <Smartphone className=\"w-4 h-4\" />\n                    Mobile View\n                  </div>\n                </SelectItem>\n                <SelectItem value=\"desktop\">\n                  <div className=\"flex items-center gap-2\">\n                    <Monitor className=\"w-4 h-4\" />\n                    Desktop View\n                  </div>\n                </SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Generate Button */}\n          <Button \n            onClick={generateDriverQR}\n            disabled={!selectedEmployeeId || isGenerating}\n            className=\"w-full\"\n            data-testid=\"button-generate-driver-qr\"\n          >\n            <QrCode className=\"w-4 h-4 mr-2\" />\n            {isGenerating ? \"Generating...\" : \"Generate QR Code\"}\n          </Button>\n\n          {/* QR Code Display */}\n          {qrDataURL && selectedEmployee && (\n            <div className=\"space-y-4\">\n              <div className=\"text-center\">\n                <div className=\"mx-auto mb-4 inline-block p-4 bg-white rounded-lg shadow-sm border\">\n                  <img \n                    src={qrDataURL} \n                    alt={`QR Code Driver View for ${selectedEmployee.name}`}\n                    className=\"mx-auto\"\n                    style={{ width: 300, height: 300 }}\n                  />\n                </div>\n                <div className=\"text-sm text-gray-600 mb-4\">\n                  <p><strong>Karyawan:</strong> {selectedEmployee.name}</p>\n                  <p><strong>NIK:</strong> {selectedEmployee.id}</p>\n                  <p><strong>Type:</strong> {qrType === 'mobile' ? 'Mobile View' : 'Desktop View'}</p>\n                </div>\n              </div>\n\n              {/* Action Buttons */}\n              <div className=\"flex gap-2 justify-center\">\n                <Button \n                  onClick={downloadQR}\n                  variant=\"outline\"\n                  data-testid=\"button-download-qr\"\n                >\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  Download\n                </Button>\n                <Button \n                  onClick={printQR}\n                  variant=\"outline\"\n                  data-testid=\"button-print-qr\"\n                >\n                  <QrCode className=\"w-4 h-4 mr-2\" />\n                  Print\n                </Button>\n              </div>\n\n              {/* Instructions */}\n              <div className=\"text-xs text-gray-500 bg-gray-50 p-3 rounded-lg\">\n                <p className=\"font-medium mb-2\">Cara Menggunakan:</p>\n                <ol className=\"list-decimal list-inside space-y-1\">\n                  <li>Print atau download QR code di atas</li>\n                  <li>Buka aplikasi barcode scanner di smartphone</li>\n                  <li>Arahkan kamera ke QR code</li>\n                  <li>Sistem akan otomatis mengarahkan ke halaman Driver View</li>\n                  <li>QR code ini TIDAK akan mempengaruhi sistem absensi</li>\n                </ol>\n              </div>\n            </div>\n          )}\n\n          <canvas ref={canvasRef} style={{ display: 'none' }} />\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","path":null,"size_bytes":9874,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    // Clone response to read body twice if needed\n    const resClone = res.clone();\n    \n    try {\n      // Try to parse as JSON first\n      const errorData = await res.json();\n      const message = errorData.message || errorData.error || `HTTP ${res.status}`;\n      throw new Error(message);\n    } catch (jsonError) {\n      // If JSON parsing fails, try getting text\n      try {\n        const text = await resClone.text();\n        if (text && text.trim()) {\n          throw new Error(text);\n        }\n      } catch {\n        // Ignore text parsing errors\n      }\n      // Fallback with status code\n      throw new Error(`HTTP ${res.status}`);\n    }\n  }\n}\n\nexport async function apiRequest(\n  url: string,\n  method: string = \"GET\",\n  data?: unknown | undefined,\n): Promise<any> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return await res.json();\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1948,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/components/MonthlyCalendar.tsx":{"content":"import { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { format, startOfMonth, endOfMonth, eachDayOfInterval, isSameMonth, getDay } from \"date-fns\";\nimport { id as localeId } from \"date-fns/locale\";\n\ninterface RosterSchedule {\n  id: string;\n  employeeId: string;\n  date: string;\n  shift: string;\n  startTime: string;\n  endTime: string;\n  employee?: {\n    id: string;\n    name: string;\n    nomorLambung?: string;\n  };\n  hasAttended?: boolean;\n  attendanceStatus?: string;\n}\n\ninterface MonthlyCalendarProps {\n  year: number;\n  month: number;\n  rosterData: RosterSchedule[];\n  shiftFilter: string;\n  onDateClick?: (date: string) => void;\n}\n\nexport function MonthlyCalendar({ year, month, rosterData, shiftFilter, onDateClick }: MonthlyCalendarProps) {\n  const monthStart = startOfMonth(new Date(year, month - 1));\n  const monthEnd = endOfMonth(new Date(year, month - 1));\n  const daysInMonth = eachDayOfInterval({ start: monthStart, end: monthEnd });\n  \n  // Get first day of month (0 = Minggu, 1 = Senin, etc)\n  const firstDayOfWeek = getDay(monthStart);\n  const startDayOffset = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1; // Convert to Monday-start week\n  \n  // Group roster by date\n  const rosterByDate = rosterData.reduce((acc, roster) => {\n    if (!acc[roster.date]) {\n      acc[roster.date] = [];\n    }\n    acc[roster.date].push(roster);\n    return acc;\n  }, {} as Record<string, RosterSchedule[]>);\n  \n  // Filter roster by shift\n  const filterRostersByShift = (rosters: RosterSchedule[]) => {\n    if (shiftFilter === \"all\") return rosters;\n    return rosters.filter(r => r.shift.toLowerCase() === shiftFilter.toLowerCase());\n  };\n  \n  const getDayRoster = (date: Date) => {\n    const dateStr = format(date, 'yyyy-MM-dd');\n    const rosters = rosterByDate[dateStr] || [];\n    return filterRostersByShift(rosters);\n  };\n  \n  const getShiftBadgeColor = (shift: string) => {\n    if (shift.toLowerCase().includes('shift 1')) {\n      return 'bg-blue-500 dark:bg-blue-600 text-white';\n    }\n    return 'bg-purple-500 dark:bg-purple-600 text-white';\n  };\n  \n  const getAttendanceBadgeColor = (hasAttended: boolean) => {\n    return hasAttended \n      ? 'bg-green-500 dark:bg-green-600' \n      : 'bg-red-500 dark:bg-red-600';\n  };\n  \n  return (\n    <div className=\"w-full\">\n      {/* Calendar Header - Days of Week */}\n      <div className=\"grid grid-cols-7 gap-1 mb-2\">\n        {['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'].map((day) => (\n          <div\n            key={day}\n            className=\"text-center font-semibold text-sm py-2 bg-gray-100 dark:bg-gray-800 rounded\"\n          >\n            {day}\n          </div>\n        ))}\n      </div>\n      \n      {/* Calendar Grid */}\n      <div className=\"grid grid-cols-7 gap-1\">\n        {/* Empty cells for days before month starts */}\n        {Array.from({ length: startDayOffset }).map((_, index) => (\n          <div key={`empty-${index}`} className=\"min-h-[120px]\" />\n        ))}\n        \n        {/* Days of the month */}\n        {daysInMonth.map((date) => {\n          const dayRosters = getDayRoster(date);\n          const dateStr = format(date, 'yyyy-MM-dd');\n          const isToday = format(new Date(), 'yyyy-MM-dd') === dateStr;\n          \n          return (\n            <Card\n              key={dateStr}\n              className={`min-h-[120px] p-2 cursor-pointer hover:shadow-lg transition-shadow ${\n                isToday ? 'ring-2 ring-blue-500 dark:ring-blue-400' : ''\n              }`}\n              onClick={() => onDateClick?.(dateStr)}\n              data-testid={`calendar-day-${dateStr}`}\n            >\n              {/* Date Number */}\n              <div className=\"flex justify-between items-start mb-1\">\n                <span\n                  className={`text-sm font-bold ${\n                    isToday ? 'text-blue-600 dark:text-blue-400' : 'text-gray-700 dark:text-gray-300'\n                  }`}\n                >\n                  {format(date, 'd')}\n                </span>\n                {dayRosters.length > 0 && (\n                  <Badge variant=\"outline\" className=\"text-xs px-1 py-0\">\n                    {dayRosters.length}\n                  </Badge>\n                )}\n              </div>\n              \n              {/* Roster List */}\n              <div className=\"space-y-1 overflow-y-auto max-h-[90px]\">\n                {dayRosters.slice(0, 3).map((roster) => (\n                  <div\n                    key={roster.id}\n                    className=\"text-xs p-1 rounded bg-gray-50 dark:bg-gray-800\"\n                    data-testid={`roster-entry-${roster.id}`}\n                  >\n                    <div className=\"flex items-center gap-1\">\n                      <Badge\n                        className={`${getShiftBadgeColor(roster.shift)} text-[10px] px-1 py-0`}\n                      >\n                        {roster.shift}\n                      </Badge>\n                      {roster.hasAttended !== undefined && (\n                        <div\n                          className={`w-2 h-2 rounded-full ${getAttendanceBadgeColor(roster.hasAttended)}`}\n                          title={roster.hasAttended ? 'Hadir' : 'Tidak Hadir'}\n                        />\n                      )}\n                    </div>\n                    <div className=\"font-medium truncate mt-0.5\">\n                      {roster.employee?.nomorLambung || roster.employee?.name || 'N/A'}\n                    </div>\n                  </div>\n                ))}\n                \n                {/* Show more indicator */}\n                {dayRosters.length > 3 && (\n                  <div className=\"text-xs text-center text-gray-500 dark:text-gray-400 py-1\">\n                    +{dayRosters.length - 3} lagi\n                  </div>\n                )}\n              </div>\n            </Card>\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":5880,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/pages/scanner.tsx":{"content":"import { QRScanner } from \"@/components/qr/qr-scanner\";\n\nexport default function ScannerPage() {\n  return <QRScanner />;\n}\n","path":null,"size_bytes":123,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"server/replitAuth.ts":{"content":"import * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nif (!process.env.REPLIT_DOMAINS) {\n  throw new Error(\"Environment variable REPLIT_DOMAINS not provided\");\n}\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: true,\n      sameSite: 'none',\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(\n  claims: any,\n) {\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  for (const domain of process.env\n    .REPLIT_DOMAINS!.split(\",\")) {\n    const strategy = new Strategy(\n      {\n        name: `replitauth:${domain}`,\n        config,\n        scope: \"openid email profile offline_access\",\n        callbackURL: `https://${domain}/api/callback`,\n      },\n      verify,\n    );\n    passport.use(strategy);\n  }\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};","path":null,"size_bytes":4244,"size_tokens":null},"client/src/components/AutoSaveIndicator.tsx":{"content":"import { cn } from \"@/lib/utils\";\nimport { Check, Clock, Save } from \"lucide-react\";\n\ninterface AutoSaveIndicatorProps {\n  status: 'idle' | 'saving' | 'saved';\n  className?: string;\n}\n\nexport function AutoSaveIndicator({ status, className }: AutoSaveIndicatorProps) {\n  const getStatusConfig = () => {\n    switch (status) {\n      case 'saving':\n        return {\n          icon: Clock,\n          text: 'Menyimpan draft...',\n          className: 'text-yellow-600 dark:text-yellow-400'\n        };\n      case 'saved':\n        return {\n          icon: Check,\n          text: 'Draft tersimpan',\n          className: 'text-green-600 dark:text-green-400'\n        };\n      default:\n        return {\n          icon: Save,\n          text: '',\n          className: 'text-gray-400 dark:text-gray-500'\n        };\n    }\n  };\n\n  const { icon: Icon, text, className: statusClassName } = getStatusConfig();\n\n  if (status === 'idle') return null;\n\n  return (\n    <div className={cn(\n      \"flex items-center gap-1 text-xs\",\n      statusClassName,\n      className\n    )}>\n      <Icon className=\"w-3 h-3\" />\n      <span>{text}</span>\n    </div>\n  );\n}","path":null,"size_bytes":1130,"size_tokens":null},"client/src/components/layout/sidebar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\nimport { X, LogOut, ChevronDown, ChevronRight } from \"lucide-react\";\nimport { useState, useEffect } from \"react\";\nimport {\n  Users,\n  QrCode,\n  Scan,\n  Calendar,\n  FileText,\n  BarChart3,\n  ClipboardList,\n  User,\n  Monitor,\n  Video,\n  Smartphone,\n  Shield,\n  ClipboardCheck,\n  TrendingUp,\n  KeyRound,\n  Megaphone,\n  Newspaper,\n  LucideIcon,\n  UserCircle,\n  FolderOpen,\n  FileCheck,\n  Briefcase,\n  HardHat,\n  Wrench,\n  AlertTriangle,\n  Heart,\n  CreditCard,\n  Award\n} from \"lucide-react\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport { Button } from \"@/components/ui/button\";\nimport companyLogo from \"@assets/WhatsApp Image 2024-11-30 at 13.08.33_1755505069008.jpeg\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Permission } from \"@shared/rbac\";\n\ninterface NavItem {\n  name: string;\n  href: string;\n  icon: LucideIcon;\n  requiredPermissions?: Permission[];\n  requireAll?: boolean;\n  children?: NavItem[];\n}\n\nconst documentSubItems: NavItem[] = [\n  { name: \"Kebijakan KPLH\", href: \"/workspace/documents/kebijakan-kplh\", icon: FileCheck },\n  { name: \"Prosedur - Dept HSE\", href: \"/workspace/documents/dept-hse\", icon: Shield },\n  { name: \"Prosedur - Dept Opr\", href: \"/workspace/documents/dept-opr\", icon: HardHat },\n  { name: \"Prosedur - Dept Plant\", href: \"/workspace/documents/dept-plant\", icon: Wrench },\n  { name: \"SPDK\", href: \"/workspace/documents/spdk\", icon: Briefcase },\n  { name: \"Zero Harm\", href: \"/workspace/documents/zero-harm\", icon: Heart },\n  { name: \"Critical Control Card\", href: \"/workspace/documents/critical-control-card\", icon: AlertTriangle },\n  { name: \"Golden Rule\", href: \"/workspace/documents/golden-rule\", icon: Award },\n];\n\nconst navigation: NavItem[] = [\n  { name: \"Berita\", href: \"/workspace/news-feed\", icon: Newspaper },\n  { name: \"Dashboard\", href: \"/workspace/dashboard\", icon: BarChart3, requiredPermissions: [Permission.VIEW_DASHBOARD] },\n  { name: \"Generate QR\", href: \"/workspace/qr-generator\", icon: QrCode, requiredPermissions: [Permission.VIEW_QR, Permission.GENERATE_QR] },\n  { name: \"Scan QR\", href: \"/workspace/scanner\", icon: Scan, requiredPermissions: [Permission.SCAN_QR] },\n  { name: \"Karyawan\", href: \"/workspace/employees\", icon: Users, requiredPermissions: [Permission.VIEW_EMPLOYEES] },\n  { name: \"Roster\", href: \"/workspace/roster\", icon: Calendar, requiredPermissions: [Permission.VIEW_ROSTER] },\n  { name: \"Cuti\", href: \"/workspace/leave\", icon: ClipboardList, requiredPermissions: [Permission.VIEW_LEAVE] },\n  { name: \"Monitoring Roster Cuti\", href: \"/workspace/leave-roster-monitoring\", icon: Monitor, requiredPermissions: [Permission.VIEW_LEAVE, Permission.MANAGE_LEAVE] },\n  { name: \"Monitoring SIMPER\", href: \"/workspace/simper-monitoring\", icon: Shield, requiredPermissions: [Permission.VIEW_EMPLOYEES, Permission.MANAGE_EMPLOYEES] },\n  { name: \"Meeting Management\", href: \"/workspace/meetings\", icon: Video, requiredPermissions: [Permission.VIEW_MEETING] },\n  { name: \"Scan QR Meeting\", href: \"/workspace/meeting-scanner\", icon: Smartphone, requiredPermissions: [Permission.VIEW_MEETING, Permission.SCAN_QR] },\n  { name: \"SIDAK\", href: \"/workspace/sidak\", icon: ClipboardCheck, requiredPermissions: [Permission.VIEW_SIDAK] },\n  { name: \"Dokumen\", href: \"/workspace/documents\", icon: FolderOpen, requiredPermissions: [Permission.VIEW_DOCUMENTS], children: documentSubItems },\n  { name: \"Evaluasi Driver\", href: \"/workspace/evaluasi-driver\", icon: TrendingUp, requiredPermissions: [Permission.VIEW_EVALUASI] },\n  { name: \"Pengumuman\", href: \"/workspace/announcements\", icon: Megaphone, requiredPermissions: [Permission.MANAGE_EMPLOYEES] },\n  { name: \"Kelola Berita\", href: \"/workspace/news\", icon: Megaphone, requiredPermissions: [Permission.MANAGE_EMPLOYEES] },\n  { name: \"Driver View\", href: \"/workspace/driver-view\", icon: User, requiredPermissions: [Permission.VIEW_DRIVER_VIEW] },\n  { name: \"Laporan\", href: \"/workspace/reports\", icon: FileText, requiredPermissions: [Permission.VIEW_REPORTS] },\n  { name: \"Reset Password\", href: \"/reset-password\", icon: KeyRound },\n];\n\ninterface SidebarProps {\n  isOpen: boolean;\n  onClose: () => void;\n}\n\nexport function Sidebar({ isOpen, onClose }: SidebarProps) {\n  const [location] = useLocation();\n  const { hasAnyPermission, user } = useAuth();\n  \n  // Auto-expand Documents menu if on a document sub-page\n  const isDocumentSubPage = location.startsWith('/workspace/documents/');\n  const [expandedMenus, setExpandedMenus] = useState<string[]>(() => \n    isDocumentSubPage ? [\"Dokumen\"] : []\n  );\n\n  // Auto-expand when navigating to document sub-page\n  useEffect(() => {\n    if (isDocumentSubPage && !expandedMenus.includes(\"Dokumen\")) {\n      setExpandedMenus(prev => [...prev, \"Dokumen\"]);\n    }\n  }, [isDocumentSubPage]);\n  \n  const toggleMenu = (menuName: string) => {\n    setExpandedMenus(prev => \n      prev.includes(menuName) \n        ? prev.filter(m => m !== menuName)\n        : [...prev, menuName]\n    );\n  };\n\n  // Filter navigation items based on user permissions\n  const filteredNavigation = navigation.filter((item) => {\n    // If no permissions required, show the item\n    if (!item.requiredPermissions || item.requiredPermissions.length === 0) {\n      return true;\n    }\n    \n    // Check if user has any of the required permissions\n    if (item.requireAll) {\n      // Must have ALL permissions\n      return item.requiredPermissions.every(p => hasAnyPermission([p]));\n    } else {\n      // Must have at least ONE permission\n      return hasAnyPermission(item.requiredPermissions);\n    }\n  });\n\n  return (\n    <>\n      {/* Mobile overlay - Higher z-index to cover everything */}\n      <div \n        className={cn(\n          \"fixed inset-0 z-[100] lg:hidden bg-black/60 backdrop-blur-sm transition-opacity duration-300\",\n          isOpen ? \"opacity-100\" : \"opacity-0 pointer-events-none\"\n        )}\n        onClick={onClose}\n      />\n      \n      {/* Sidebar - Icon only on desktop, full width on mobile */}\n      <div className={cn(\n        \"fixed inset-y-0 left-0 z-[110] bg-white dark:bg-gray-800 shadow-2xl transform transition-transform duration-300 ease-out\",\n        \"lg:translate-x-0 lg:static lg:inset-0 lg:z-auto lg:shadow-lg\",\n        \"lg:w-20\",  // Icon-only width on desktop\n        \"w-72\",     // Slightly wider for better mobile UX\n        isOpen ? \"translate-x-0\" : \"-translate-x-full\"\n      )}>\n        {/* Logo Header - With close button on mobile */}\n        <div className=\"flex items-center h-16 px-4 bg-gradient-to-br from-red-500 to-red-600 dark:from-red-600 dark:to-red-700\">\n          <div className=\"w-10 h-10 lg:w-12 lg:h-12 bg-white rounded-xl overflow-hidden flex items-center justify-center shadow-md flex-shrink-0 lg:mx-auto\">\n            <img \n              src={companyLogo} \n              alt=\"GECL Logo\" \n              className=\"w-full h-full object-contain\"\n              style={{ imageRendering: 'auto', WebkitBackfaceVisibility: 'hidden', transform: 'translateZ(0)' }}\n            />\n          </div>\n          {/* Show company name only on mobile */}\n          <span className=\"lg:hidden ml-3 text-base font-bold text-white flex-1 truncate\">\n            OneTalent GECL\n          </span>\n          {/* Close button - mobile only */}\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"lg:hidden h-8 w-8 text-white hover:bg-white/20 flex-shrink-0\"\n            onClick={onClose}\n            data-testid=\"sidebar-close-button\"\n          >\n            <X className=\"w-5 h-5\" />\n          </Button>\n        </div>\n        \n        {/* Navigation - Icon only on desktop, with text on mobile */}\n        <TooltipProvider delayDuration={0}>\n          <div className=\"flex flex-col h-[calc(100vh-4rem)]\">\n            <nav className=\"mt-4 px-3 lg:px-2 space-y-1 lg:space-y-2 flex-1 overflow-y-auto\">\n              {filteredNavigation.map((item) => {\n                const isActive = location === item.href || (item.children && location.startsWith(item.href + '/'));\n                const isExpanded = expandedMenus.includes(item.name) || (item.children && isDocumentSubPage && item.name === \"Dokumen\");\n                const IconComponent = item.icon;\n                const hasChildren = item.children && item.children.length > 0;\n                \n                // Desktop with children - use Popover\n                if (hasChildren) {\n                  return (\n                    <div key={item.name}>\n                      {/* Desktop - Popover */}\n                      <div className=\"hidden lg:block\">\n                        <Popover>\n                          <PopoverTrigger asChild>\n                            <button\n                              className={cn(\n                                \"flex items-center w-full px-3 py-3 rounded-xl transition-all duration-200\",\n                                \"justify-center\",\n                                \"hover:bg-gray-100 dark:hover:bg-gray-700\",\n                                isActive \n                                  ? \"bg-gradient-to-br from-red-500 to-red-600 text-white shadow-lg shadow-red-500/30\"\n                                  : \"text-gray-600 dark:text-gray-400\"\n                              )}\n                              data-testid={`nav-link-${item.name.toLowerCase().replace(/\\s+/g, '-')}-desktop`}\n                            >\n                              <IconComponent className=\"w-5 h-5 flex-shrink-0\" />\n                            </button>\n                          </PopoverTrigger>\n                          <PopoverContent side=\"right\" align=\"start\" className=\"w-56 p-2\">\n                            <div className=\"space-y-1\">\n                              <p className=\"text-xs font-semibold text-gray-500 dark:text-gray-400 px-2 py-1 uppercase tracking-wider\">\n                                {item.name}\n                              </p>\n                              {item.children!.map((child) => {\n                                const isChildActive = location === child.href;\n                                const ChildIcon = child.icon;\n                                return (\n                                  <Link\n                                    key={child.name}\n                                    href={child.href}\n                                    className={cn(\n                                      \"flex items-center px-2 py-2 rounded-lg transition-all duration-200\",\n                                      \"hover:bg-gray-100 dark:hover:bg-gray-700\",\n                                      isChildActive \n                                        ? \"bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 font-medium\"\n                                        : \"text-gray-600 dark:text-gray-400\"\n                                    )}\n                                    data-testid={`nav-link-${child.name.toLowerCase().replace(/\\s+/g, '-')}`}\n                                  >\n                                    <ChildIcon className=\"w-4 h-4 flex-shrink-0\" />\n                                    <span className=\"ml-2 text-sm\">{child.name}</span>\n                                  </Link>\n                                );\n                              })}\n                            </div>\n                          </PopoverContent>\n                        </Popover>\n                      </div>\n                      \n                      {/* Mobile - Collapsible */}\n                      <div className=\"lg:hidden\">\n                        <button\n                          onClick={() => toggleMenu(item.name)}\n                          className={cn(\n                            \"flex items-center w-full px-3 py-2.5 rounded-xl transition-all duration-200\",\n                            \"hover:bg-gray-100 dark:hover:bg-gray-700\",\n                            isActive \n                              ? \"bg-gradient-to-br from-red-500 to-red-600 text-white shadow-lg shadow-red-500/30\"\n                              : \"text-gray-600 dark:text-gray-400\"\n                          )}\n                          data-testid={`nav-link-${item.name.toLowerCase().replace(/\\s+/g, '-')}-mobile`}\n                        >\n                          <IconComponent className=\"w-5 h-5 flex-shrink-0\" />\n                          <span className=\"ml-3 text-sm font-medium truncate flex-1 text-left\">{item.name}</span>\n                          <ChevronDown className={cn(\n                            \"w-4 h-4 transition-transform duration-200\",\n                            isExpanded ? \"rotate-180\" : \"\"\n                          )} />\n                        </button>\n                        \n                        {/* Sub-menu items */}\n                        {isExpanded && (\n                          <div className=\"ml-4 mt-1 space-y-1 border-l-2 border-gray-200 dark:border-gray-600 pl-3\">\n                            {item.children!.map((child) => {\n                              const isChildActive = location === child.href;\n                              const ChildIcon = child.icon;\n                              return (\n                                <Link\n                                  key={child.name}\n                                  href={child.href}\n                                  className={cn(\n                                    \"flex items-center px-3 py-2 rounded-lg transition-all duration-200\",\n                                    \"hover:bg-gray-100 dark:hover:bg-gray-700\",\n                                    isChildActive \n                                      ? \"bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 font-medium\"\n                                      : \"text-gray-500 dark:text-gray-400\"\n                                  )}\n                                  data-testid={`nav-link-${child.name.toLowerCase().replace(/\\s+/g, '-')}`}\n                                  onClick={() => onClose()}\n                                >\n                                  <ChildIcon className=\"w-4 h-4 flex-shrink-0\" />\n                                  <span className=\"ml-2 text-sm truncate\">{child.name}</span>\n                                </Link>\n                              );\n                            })}\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  );\n                }\n                \n                // Regular nav item without children\n                return (\n                  <Tooltip key={item.name}>\n                    <TooltipTrigger asChild>\n                      <Link\n                        href={item.href}\n                        className={cn(\n                          \"flex items-center px-3 py-2.5 lg:py-3 rounded-xl transition-all duration-200\",\n                          \"lg:justify-center\",\n                          \"hover:bg-gray-100 dark:hover:bg-gray-700\",\n                          isActive \n                            ? \"bg-gradient-to-br from-red-500 to-red-600 text-white shadow-lg shadow-red-500/30\"\n                            : \"text-gray-600 dark:text-gray-400\"\n                        )}\n                        data-testid={`nav-link-${item.name.toLowerCase().replace(/\\s+/g, '-')}`}\n                        onClick={() => {\n                          if (window.innerWidth < 1024) {\n                            onClose();\n                          }\n                        }}\n                      >\n                        <IconComponent className=\"w-5 h-5 lg:w-5 lg:h-5 flex-shrink-0\" />\n                        <span className=\"lg:hidden ml-3 text-sm font-medium truncate\">{item.name}</span>\n                      </Link>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"right\" className=\"hidden lg:block\">\n                      <p>{item.name}</p>\n                    </TooltipContent>\n                  </Tooltip>\n                );\n              })}\n            </nav>\n            \n            {/* Profile section at bottom - Mobile only */}\n            {user && (\n              <div className=\"lg:hidden px-3 pb-4 mt-auto border-t border-gray-200 dark:border-gray-700 pt-3\">\n                <div className=\"flex items-center gap-3 px-3 py-2 bg-gray-50 dark:bg-gray-700/50 rounded-xl\">\n                  <div className=\"w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center flex-shrink-0\">\n                    <UserCircle className=\"w-6 h-6 text-white\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"text-sm font-semibold text-gray-900 dark:text-white truncate\">\n                      {user.name}\n                    </p>\n                    <p className=\"text-xs text-gray-500 dark:text-gray-400 truncate\">\n                      {user.position || user.role}\n                    </p>\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        </TooltipProvider>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":17249,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5742,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1128,"size_tokens":null},"client/src/pages/roster.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertRosterSchema } from \"@shared/schema\";\nimport type { Employee, RosterSchedule, AttendanceRecord, InsertRosterSchedule } from \"@shared/schema\";\nimport { Plus, Upload, Download, Filter, Calendar, CheckCircle, Clock, Users, Edit, Trash2, AlertCircle, Save, X, CalendarDays, List } from \"lucide-react\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { z } from \"zod\";\nimport * as XLSX from 'xlsx';\nimport { useAutoSave } from \"@/hooks/useAutoSave\";\nimport { AutoSaveIndicator } from \"@/components/AutoSaveIndicator\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { saveAs } from 'file-saver';\nimport { MonthlyCalendar } from \"@/components/MonthlyCalendar\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\n\nconst formSchema = insertRosterSchema;\n\nexport default function Roster() {\n  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [isUploadDialogOpen, setIsUploadDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [editingRoster, setEditingRoster] = useState<RosterSchedule | null>(null);\n  const [shiftFilter, setShiftFilter] = useState(\"all\");\n  const [attendanceFilter, setAttendanceFilter] = useState(\"all\");\n  const [searchName, setSearchName] = useState(\"\");\n  const [searchNIK, setSearchNIK] = useState(\"\");\n  const [isDeleteAllDialogOpen, setIsDeleteAllDialogOpen] = useState(false);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [uploadProgress, setUploadProgress] = useState(0);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [processedCount, setProcessedCount] = useState(0);\n  const [totalCount, setTotalCount] = useState(0);\n  // Update Schedule Dialog States\n  const [isUpdateScheduleDialogOpen, setIsUpdateScheduleDialogOpen] = useState(false);\n  const [nikForUpdate, setNikForUpdate] = useState<string>(\"\");\n  const [selectedMonthForUpdate, setSelectedMonthForUpdate] = useState<string>(\"\");\n  const [updateScheduleFile, setUpdateScheduleFile] = useState<File | null>(null);\n  const [isProcessingUpdate, setIsProcessingUpdate] = useState(false);\n\n  // Fetch employee by NIK\n  const { data: employeeForUpdate, isLoading: isLoadingEmployee, error: employeeError } = useQuery<Employee>({\n    queryKey: [`/api/employees/${nikForUpdate}`],\n    enabled: nikForUpdate.length > 0,\n  });\n  // Nomor lambung editing states\n  const [editingNomorLambung, setEditingNomorLambung] = useState<{[key: string]: boolean}>({});\n  const [tempNomorLambung, setTempNomorLambung] = useState<{[key: string]: string}>({});\n  // Monthly calendar states\n  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());\n  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);\n  const [viewMode, setViewMode] = useState<'list' | 'calendar'>('list');\n  const { toast } = useToast();\n\n  const { data: employees = [] } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  const { data: rosterSchedules = [], isLoading: isLoadingRoster } = useQuery<any[]>({\n    queryKey: [\"/api/roster\", selectedDate],\n    queryFn: async () => {\n      const response = await fetch(`/api/roster?date=${selectedDate}`, {\n        cache: 'no-cache',\n        headers: {\n          'Cache-Control': 'no-cache',\n          'Pragma': 'no-cache'\n        }\n      });\n      if (!response.ok) throw new Error('Failed to fetch roster');\n      const data = await response.json();\n      console.log(`ðŸ”„ Fetched ${data.length} roster entries for ${selectedDate}`);\n      if (data.length > 0) {\n        console.log('ðŸ“‹ Sample roster data:', data.slice(0, 3).map((r: any) => ({\n          name: r.employee?.name || 'N/A',\n          hariKerja: r.hariKerja,\n          shift: r.shift\n        })));\n      }\n      return data;\n    },\n    staleTime: 0, // Always fetch fresh data\n    refetchOnWindowFocus: true, // Refresh when window focused\n  });\n\n  const { data: attendance = [] } = useQuery<AttendanceRecord[]>({\n    queryKey: [\"/api/attendance\", selectedDate],\n    queryFn: async () => {\n      const response = await fetch(`/api/attendance?date=${selectedDate}`);\n      if (!response.ok) throw new Error('Failed to fetch attendance');\n      return response.json();\n    },\n  });\n\n  // Monthly roster query untuk kalender bulanan\n  const { data: monthlyRoster = [], isLoading: isLoadingMonthly } = useQuery<any[]>({\n    queryKey: [\"/api/roster/monthly\", selectedYear, selectedMonth],\n    queryFn: async () => {\n      const response = await fetch(`/api/roster/monthly?year=${selectedYear}&month=${selectedMonth}`);\n      if (!response.ok) throw new Error('Failed to fetch monthly roster');\n      const data = await response.json();\n      console.log(`ðŸ“… Fetched ${data.length} roster entries for ${selectedYear}-${selectedMonth}`);\n      return data;\n    },\n    enabled: viewMode === 'calendar', // Only fetch when calendar view is active\n    staleTime: 0,\n    refetchOnWindowFocus: true,\n  });\n\n  const form = useForm<z.infer<typeof formSchema>>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      employeeId: \"\",\n      date: selectedDate,\n      shift: \"\",\n      startTime: \"\",\n      endTime: \"\",\n      jamTidur: \"\",\n      fitToWork: \"Fit To Work\",\n      status: \"scheduled\",\n    },\n  });\n\n  // Auto save hook for roster form\n  const { saveStatus, clearDraft, hasDraft } = useAutoSave({\n    key: 'roster_new',\n    form,\n    exclude: [], // Save all fields for roster\n  });\n\n  const editForm = useForm<z.infer<typeof formSchema>>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      employeeId: \"\",\n      date: selectedDate,\n      shift: \"\",\n      startTime: \"\",\n      endTime: \"\",\n      jamTidur: \"\",\n      fitToWork: \"Fit To Work\",\n      status: \"scheduled\",\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: InsertRosterSchedule) => apiRequest(\"/api/roster\", \"POST\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/roster\"] });\n      // Invalidate QR validation cache untuk memastikan scan result menggunakan data roster terbaru\n      queryClient.invalidateQueries({ queryKey: [\"/api/qr/validate\"] });\n      // Invalidate attendance cache karena roster berubah bisa mempengaruhi validasi shift\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance\"] });\n      \n      setIsDialogOpen(false);\n      form.reset();\n      clearDraft(); // Clear auto saved draft after successful save\n      toast({\n        title: \"Berhasil\",\n        description: \"Roster berhasil ditambahkan - QR scan akan menggunakan data terbaru\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal menambahkan roster\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: Partial<InsertRosterSchedule> }) => \n      apiRequest(`/api/roster/${id}`, \"PUT\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/roster\"] });\n      // Invalidate QR validation cache untuk memastikan scan result menggunakan data roster terbaru\n      queryClient.invalidateQueries({ queryKey: [\"/api/qr/validate\"] });\n      // Invalidate attendance cache karena roster berubah bisa mempengaruhi validasi shift\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance\"] });\n      \n      setIsEditDialogOpen(false);\n      setEditingRoster(null);\n      toast({\n        title: \"Berhasil\",\n        description: \"Roster berhasil diupdate - QR scan akan menggunakan data terbaru\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal mengupdate roster\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/roster/${id}`, \"DELETE\", {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/roster\"] });\n      // Invalidate QR validation cache untuk memastikan scan result menggunakan data roster terbaru\n      queryClient.invalidateQueries({ queryKey: [\"/api/qr/validate\"] });\n      // Invalidate attendance cache karena roster berubah bisa mempengaruhi validasi shift\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance\"] });\n      \n      toast({\n        title: \"Berhasil\",\n        description: \"Roster berhasil dihapus - QR scan akan menggunakan data terbaru\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal menghapus roster\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteAllMutation = useMutation({\n    mutationFn: () => apiRequest(\"/api/roster/delete-all\", \"DELETE\", {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/roster\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/qr/validate\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard\"] });\n      setIsDeleteAllDialogOpen(false);\n      toast({\n        title: \"Berhasil\",\n        description: \"Semua data roster berhasil dihapus\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal menghapus semua data roster\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const uploadMutation = useMutation({\n    mutationFn: (data: InsertRosterSchedule[]) => apiRequest(\"/api/roster/bulk\", \"POST\", { rosters: data }),\n    onSuccess: () => {\n      // Force invalidate all roster related queries\n      queryClient.invalidateQueries({ queryKey: [\"/api/roster\"] });\n      queryClient.refetchQueries({ queryKey: [\"/api/roster\"] }); // Force refetch\n      queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/qr/validate\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard\"] });\n      \n      // Clear any cached roster data\n      queryClient.removeQueries({ queryKey: [\"/api/roster\"] });\n      \n      setIsUploadDialogOpen(false);\n      setSelectedFile(null);\n      setUploadProgress(0);\n      setIsProcessing(false);\n      setProcessedCount(0);\n      setTotalCount(0);\n      toast({\n        title: \"Berhasil\",\n        description: `${totalCount} roster berhasil diupload dari Excel dengan nomor lambung terbaru`,\n      });\n    },\n    onError: (error: any) => {\n      console.error('Upload error:', error);\n      const errorMessage = error.response?.data?.message || error.message || 'Gagal upload roster';\n      const errorDetails = error.response?.data?.errors || [];\n      \n      setIsProcessing(false);\n      setUploadProgress(0);\n      toast({\n        title: \"Error\",\n        description: errorDetails.length > 0 ? errorDetails.join(', ') : errorMessage,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation untuk update schedule karyawan per bulan\n  const updateScheduleMutation = useMutation({\n    mutationFn: (data: { employeeId: string; month: string; rosters: InsertRosterSchedule[] }) => \n      apiRequest(\"/api/roster/update-employee-schedule\", \"POST\", data),\n    onSuccess: (response) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/roster\"] });\n      queryClient.refetchQueries({ queryKey: [\"/api/roster\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/qr/validate\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard\"] });\n      \n      setIsUpdateScheduleDialogOpen(false);\n      setNikForUpdate(\"\");\n      setSelectedMonthForUpdate(\"\");\n      setUpdateScheduleFile(null);\n      setIsProcessingUpdate(false);\n      \n      toast({\n        title: \"Berhasil\",\n        description: response.message || `Jadwal karyawan berhasil diupdate`,\n      });\n    },\n    onError: (error: any) => {\n      console.error('Update schedule error:', error);\n      const errorMessage = error.message || 'Gagal update jadwal karyawan';\n      setIsProcessingUpdate(false);\n      \n      toast({\n        title: \"Error\",\n        description: errorMessage,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation untuk update nomor lambung employee\n  const updateNomorLambungMutation = useMutation({\n    mutationFn: ({ employeeId, nomorLambung }: { employeeId: string; nomorLambung: string }) => \n      apiRequest(`/api/employees/${employeeId}`, \"PUT\", { nomorLambung }),\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/roster\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/qr/validate\"] });\n      \n      // Reset editing state\n      setEditingNomorLambung(prev => ({ ...prev, [variables.employeeId]: false }));\n      setTempNomorLambung(prev => ({ ...prev, [variables.employeeId]: \"\" }));\n      \n      toast({\n        title: \"Berhasil\",\n        description: `Nomor lambung berhasil diupdate ke: ${variables.nomorLambung}`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal mengupdate nomor lambung\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (values: z.infer<typeof formSchema>) => {\n    createMutation.mutate({\n      ...values,\n      date: selectedDate, // Always use the selected date from date picker\n    });\n  };\n\n  const onEditSubmit = (values: z.infer<typeof formSchema>) => {\n    if (!editingRoster) return;\n    updateMutation.mutate({\n      id: editingRoster.id,\n      data: { ...values, date: selectedDate } // Always use the selected date from date picker\n    });\n  };\n\n  const handleEdit = (roster: RosterSchedule) => {\n    setEditingRoster(roster);\n    editForm.reset({\n      employeeId: roster.employeeId,\n      date: roster.date,\n      shift: roster.shift,\n      startTime: roster.startTime,\n      endTime: roster.endTime,\n      jamTidur: roster.jamTidur || \"\",\n      fitToWork: roster.fitToWork || \"Fit To Work\",\n      hariKerja: roster.hariKerja || \"\",\n      status: roster.status,\n    });\n    setIsEditDialogOpen(true);\n  };\n\n  const handleDelete = (rosterId: string) => {\n    if (confirm(\"Apakah Anda yakin ingin menghapus roster ini?\")) {\n      deleteMutation.mutate(rosterId);\n    }\n  };\n\n  // Handler functions untuk nomor lambung editing\n  const handleEditNomorLambung = (employeeId: string, currentValue: string) => {\n    setEditingNomorLambung(prev => ({ ...prev, [employeeId]: true }));\n    setTempNomorLambung(prev => ({ ...prev, [employeeId]: currentValue }));\n  };\n\n  const handleSaveNomorLambung = (employeeId: string) => {\n    const newValue = tempNomorLambung[employeeId];\n    if (!newValue || newValue.trim() === '') {\n      toast({\n        title: \"Error\",\n        description: \"Nomor lambung tidak boleh kosong\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    updateNomorLambungMutation.mutate({ employeeId, nomorLambung: newValue.trim() });\n  };\n\n  const handleCancelEditNomorLambung = (employeeId: string) => {\n    setEditingNomorLambung(prev => ({ ...prev, [employeeId]: false }));\n    setTempNomorLambung(prev => ({ ...prev, [employeeId]: \"\" }));\n  };\n\n  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file) {\n      setSelectedFile(file);\n    }\n  };\n\n  const processExcelFile = async () => {\n    if (!selectedFile) {\n      toast({\n        title: \"Error\",\n        description: \"Pilih file Excel terlebih dahulu\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsProcessing(true);\n    setUploadProgress(0);\n    setProcessedCount(0);\n\n    try {\n      // Phase 1: Read Excel file (20% progress)\n      setUploadProgress(10);\n      const data = await selectedFile.arrayBuffer();\n      const workbook = XLSX.read(data);\n      \n      // Read from \"Template Roster\" sheet specifically (like pandas)\n      const sheetName = workbook.SheetNames.includes('Template Roster') \n        ? 'Template Roster' \n        : workbook.SheetNames[0];\n      \n      console.log('ðŸ“‹ Reading from sheet:', sheetName);\n      const worksheet = workbook.Sheets[sheetName];\n      const jsonData = XLSX.utils.sheet_to_json(worksheet);\n\n      console.log(`Excel file loaded with ${jsonData.length} rows`);\n      console.log('=== RAW EXCEL DATA (first 3 rows) ===');\n      console.log(JSON.stringify(jsonData.slice(0, 3), null, 2));\n      setUploadProgress(20);\n      setTotalCount(jsonData.length);\n\n      // Phase 2: Process data in chunks (20% to 80% progress)\n      const rosterData: InsertRosterSchedule[] = [];\n      const chunkSize = 500; // Process 500 rows at a time for better performance\n      \n      for (let i = 0; i < jsonData.length; i += chunkSize) {\n        const chunk = jsonData.slice(i, i + chunkSize);\n        \n        const processedChunk = chunk.map((row: any) => {\n          // Parse format Excel user: Jam Kel dan Jam Tld sebagai kolom terpisah\n          \n          // Normalize shift values - handle various formats and variations\n          const rawShift = String(row.Shift || row.shift || '')\n            .trim()\n            .replace(/\\s+/g, ' ') // Collapse multiple spaces\n            .replace(/[\\u00A0\\u2000-\\u200B]/g, ' ') // Remove non-breaking spaces\n            .toUpperCase();\n          \n          // Map common shift variations to canonical values\n          let normalizedShift = 'SHIFT 1'; // Default\n          \n          const shift1Variants = ['SHIFT 1', 'SHIFT1', 'S1', '1', 'SHIFT I'];\n          const shift2Variants = ['SHIFT 2', 'SHIFT2', 'S2', '2', 'SHIFT II'];\n          const overShiftVariants = ['OVER SHIFT', 'OVER', 'OS', 'O/S', 'OVERTIME'];\n          const cutiVariants = ['CUTI', 'OFF', 'LEAVE'];\n          \n          if (shift1Variants.includes(rawShift)) {\n            normalizedShift = 'SHIFT 1';\n          } else if (shift2Variants.includes(rawShift)) {\n            normalizedShift = 'SHIFT 2';\n          } else if (overShiftVariants.includes(rawShift)) {\n            normalizedShift = 'OVER SHIFT';\n          } else if (cutiVariants.includes(rawShift)) {\n            normalizedShift = 'CUTI';\n          } else if (rawShift !== '') {\n            // Log unknown shift format\n            console.warn(`âš ï¸ Unknown shift format: \"${rawShift}\" - defaulting to SHIFT 1`);\n          }\n          \n          // Set default times based on normalized shift\n          let defaultStartTime = '06:00';\n          let defaultEndTime = '16:00';\n          \n          if (normalizedShift === 'SHIFT 2') {\n            defaultStartTime = '18:00';\n            defaultEndTime = '06:00';\n          } else if (normalizedShift === 'CUTI') {\n            defaultStartTime = '00:00';\n            defaultEndTime = '00:00';\n          } else if (normalizedShift === 'OVER SHIFT') {\n            defaultStartTime = '06:00';\n            defaultEndTime = '18:00';\n          }\n          \n          // Handle Jam Kel dan Jam Tld sebagai kolom terpisah (format user)\n          const jamKel = row['Jam Kel'] || row.jamKel || '';\n          const jamTld = row['Jam Tld'] || row.jamTld || '';\n          \n          const startTime = jamKel && jamKel !== '' ? String(jamKel).trim() : defaultStartTime;\n          const endTime = jamTld && jamTld !== '' ? String(jamTld).trim() : defaultEndTime;\n\n          // Handle date formatting - parsing format Indonesia \"16 September 2025\"\n          let rosterDate = row.Tanggal || row.tanggal || row.Date || row.date || selectedDate;\n          \n          // Parse format tanggal Indonesia \"16 September 2025\" \n          if (typeof rosterDate === 'string' && rosterDate.includes('September')) {\n            const monthMap: {[key: string]: string} = {\n              'Januari': '01', 'Februari': '02', 'Maret': '03', 'April': '04',\n              'Mei': '05', 'Juni': '06', 'Juli': '07', 'Agustus': '08',\n              'September': '09', 'Oktober': '10', 'November': '11', 'Desember': '12'\n            };\n            \n            const parts = rosterDate.split(' ');\n            if (parts.length === 3) {\n              const day = parts[0].padStart(2, '0');\n              const month = monthMap[parts[1]] || '01';\n              const year = parts[2];\n              rosterDate = `${year}-${month}-${day}`;\n            }\n          } else if (typeof rosterDate === 'number') {\n            // Excel serial number conversion - timezone safe\n            const utcDate = new Date(Date.UTC(1899, 11, 30) + (rosterDate * 24 * 60 * 60 * 1000));\n            const year = utcDate.getUTCFullYear();\n            const month = String(utcDate.getUTCMonth() + 1).padStart(2, '0');\n            const day = String(utcDate.getUTCDate()).padStart(2, '0');\n            rosterDate = `${year}-${month}-${day}`;\n          } else if (rosterDate && typeof rosterDate === 'string') {\n            // Standard date formats\n            const dateObj = new Date(rosterDate);\n            if (!isNaN(dateObj.getTime())) {\n              rosterDate = dateObj.toISOString().split('T')[0];\n            }\n          }\n\n          const processedRow = {\n            employeeId: row.NIK || row.nik || row['Employee ID'] || row.employeeId || '',\n            employeeName: row.Nama || row.nama || row.Name || row.name || '',\n            nomorLambung: row['Nomor Lambung'] || row.nomorLambung || row.nomor_lambung || '',\n            date: rosterDate,\n            shift: normalizedShift,\n            startTime: startTime,\n            endTime: endTime,\n            jamTidur: String(row['Jam Tidur'] || row.jamTidur || ''),\n            fitToWork: row['Fit To W'] || row['Fit To Work'] || row.fitToWork || 'Fit To Work',\n            hariKerja: String(row['Hari Kerja'] || row.hariKerja || ''),\n            status: row.Status || row.status || 'scheduled'\n          };\n          \n          // Debug log untuk melihat mapping data (format user)\n          if (i < 3) { // Log first 3 rows untuk debug\n            console.log(`=== USER EXCEL FORMAT MAPPING ROW ${i + 1} ===`);\n            console.log('ðŸ“Š Raw Excel row:', row);\n            console.log('ðŸ” Available columns:', Object.keys(row));\n            console.log('ðŸ“… Tanggal (format Indonesia):', row.Tanggal, 'type:', typeof row.Tanggal);\n            console.log('âš¡ Shift:', row.Shift, 'type:', typeof row.Shift);\n            console.log('ðŸ• Jam Kel:', row['Jam Kel'], 'type:', typeof row['Jam Kel']);\n            console.log('ðŸ• Jam Tld:', row['Jam Tld'], 'type:', typeof row['Jam Tld']);\n            console.log('ðŸŽ¯ Hari Kerja:', row['Hari Kerja'], 'type:', typeof row['Hari Kerja']);\n            console.log('âœ… Processed result:', processedRow);\n            console.log('===================');\n          }\n          \n          return processedRow;\n        }).filter(row => row.employeeId && row.shift); // Hapus filter startTime/endTime untuk mencegah data hilang\n\n        rosterData.push(...processedChunk);\n        \n        // Update progress (20% to 80%)\n        const processProgress = 20 + (60 * (i + chunkSize)) / jsonData.length;\n        setUploadProgress(Math.min(processProgress, 80));\n        setProcessedCount(i + chunkSize);\n        \n        // Reduce delay for faster processing\n        if ((i + chunkSize) % 2000 === 0) {\n          await new Promise(resolve => setTimeout(resolve, 5));\n        }\n      }\n\n      console.log(`Processed ${rosterData.length} valid rows out of ${jsonData.length} total rows`);\n      setUploadProgress(80);\n\n      if (rosterData.length === 0) {\n        setIsProcessing(false);\n        toast({\n          title: \"Error\",\n          description: \"Tidak ada data valid ditemukan. Pastikan format Excel sesuai template\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      // Phase 3: Upload to server (80% to 100%)\n      setUploadProgress(90);\n      uploadMutation.mutate(rosterData);\n      setUploadProgress(100);\n\n    } catch (error) {\n      console.error('Excel processing error:', error);\n      setIsProcessing(false);\n      toast({\n        title: \"Error\",\n        description: \"Format file Excel tidak valid\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const downloadTemplate = () => {\n    const templateData = [\n      {\n        NIK: 'C-015227',\n        Nama: 'SYAHRIAL H',\n        'Nomor Lambung': 'GECL 9001',\n        Tanggal: '2025-08-30',\n        Shift: 'Shift 1',\n        'Jam Kerja': '08:00 - 16:00',\n        'Jam Tidur': '6',\n        'Fit To Work': 'Fit To Work',\n        'Hari Kerja': 'Senin',\n        Status: 'scheduled'\n      },\n      {\n        NIK: 'C-004764',\n        Nama: 'SAHRUL HELMI',\n        'Nomor Lambung': 'GECL 9002',\n        Tanggal: '2025-08-30',\n        Shift: 'Shift 2',\n        'Jam Kerja': '18:00 - 06:00',\n        'Jam Tidur': '6',\n        'Fit To Work': 'Fit To Work',\n        'Hari Kerja': 'Senin',\n        Status: 'scheduled'\n      }\n    ];\n\n    // Add instructions and empty rows\n    const instructionData = [\n      {},\n      {},\n      { NIK: \"INSTRUKSI:\", Nama: \"\", 'Nomor Lambung': \"\", Tanggal: \"\", Shift: \"\", 'Jam Kerja': \"\", 'Jam Tidur': \"\", 'Fit To Work': \"\", 'Hari Kerja': \"\", Status: \"\" },\n      { NIK: \"1. Format Tanggal: YYYY-MM-DD (contoh: 2025-08-30)\", Nama: \"\", 'Nomor Lambung': \"\", Tanggal: \"\", Shift: \"\", 'Jam Kerja': \"\", 'Jam Tidur': \"\", 'Fit To Work': \"\", 'Hari Kerja': \"\", Status: \"\" },\n      { NIK: \"2. Shift: Shift 1 atau Shift 2\", Nama: \"\", 'Nomor Lambung': \"\", Tanggal: \"\", Shift: \"\", 'Jam Kerja': \"\", 'Jam Tidur': \"\", 'Fit To Work': \"\", 'Hari Kerja': \"\", Status: \"\" },\n      { NIK: \"3. Jam Kerja: 08:00 - 16:00 (opsional)\", Nama: \"\", 'Nomor Lambung': \"\", Tanggal: \"\", Shift: \"\", 'Jam Kerja': \"\", 'Jam Tidur': \"\", 'Fit To Work': \"\", 'Hari Kerja': \"\", Status: \"\" },\n      { NIK: \"4. Jam Tidur: angka (contoh: 6, 7, 8)\", Nama: \"\", 'Nomor Lambung': \"\", Tanggal: \"\", Shift: \"\", 'Jam Kerja': \"\", 'Jam Tidur': \"\", 'Fit To Work': \"\", 'Hari Kerja': \"\", Status: \"\" },\n      { NIK: \"5. Fit To Work: Fit To Work atau Not Fit\", Nama: \"\", 'Nomor Lambung': \"\", Tanggal: \"\", Shift: \"\", 'Jam Kerja': \"\", 'Jam Tidur': \"\", 'Fit To Work': \"\", 'Hari Kerja': \"\", Status: \"\" },\n      { NIK: \"6. Hari Kerja: nama hari (contoh: Senin, Selasa)\", Nama: \"\", 'Nomor Lambung': \"\", Tanggal: \"\", Shift: \"\", 'Jam Kerja': \"\", 'Jam Tidur': \"\", 'Fit To Work': \"\", 'Hari Kerja': \"\", Status: \"\" }\n    ];\n\n    const allData = [...templateData, ...instructionData];\n    const worksheet = XLSX.utils.json_to_sheet(allData);\n    const workbook = XLSX.utils.book_new();\n    XLSX.utils.book_append_sheet(workbook, worksheet, 'Template Roster');\n    \n    const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });\n    const data = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });\n    saveAs(data, 'template-roster.xlsx');\n  };\n\n  const getEmployeeName = (employeeId: string) => {\n    return employees.find(emp => emp.id === employeeId)?.name || 'Unknown';\n  };\n\n  const filteredRosterSchedules = rosterSchedules.filter(roster => {\n    // Filter by shift\n    const shiftMatch = shiftFilter === \"all\" || roster.shift === shiftFilter;\n    \n    // Filter by NIK (employee ID)\n    const nikMatch = !searchNIK || roster.employeeId.toLowerCase().includes(searchNIK.toLowerCase());\n    \n    // Filter by employee name\n    const employee = roster.employee || employees.find(emp => emp.id === roster.employeeId);\n    const nameMatch = !searchName || (employee?.name || '').toLowerCase().includes(searchName.toLowerCase());\n    \n    // Filter by attendance status\n    const hasAttended = attendance.some(att => att.employeeId === roster.employeeId);\n    let attendanceMatch = true;\n    if (attendanceFilter === \"hadir\") {\n      attendanceMatch = hasAttended;\n    } else if (attendanceFilter === \"belum_hadir\") {\n      attendanceMatch = !hasAttended;\n    }\n    // If attendanceFilter === \"all\", attendanceMatch remains true\n    \n    return shiftMatch && nikMatch && nameMatch && attendanceMatch;\n  });\n\n  const rosterWithAttendance = filteredRosterSchedules.map(roster => ({\n    ...roster,\n    employee: roster.employee || employees.find(emp => emp.id === roster.employeeId), // Use API employee data first\n    attendance: {\n      status: roster.hasAttended ? 'present' : 'absent',\n      time: roster.attendanceTime\n    }\n  }));\n\n  // Calculate statistics based on filtered data (by date and shift)\n  const filteredAttendance = attendance.filter(att => {\n    // Match with filtered roster schedules\n    const matchingRoster = filteredRosterSchedules.find(roster => roster.employeeId === att.employeeId);\n    return !!matchingRoster;\n  });\n\n  const cutiCount = filteredRosterSchedules.filter(roster => roster.shift === 'CUTI').length;\n\n  const stats = {\n    scheduled: filteredRosterSchedules.length,\n    present: filteredAttendance.length, \n    absent: filteredRosterSchedules.length - filteredAttendance.length - cutiCount,\n    onLeave: cutiCount\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"px-3 sm:px-6\">\n        <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3\">\n          <div>\n            <CardTitle className=\"text-xl sm:text-2xl font-bold text-gray-900 dark:text-white\">Roster Kerja</CardTitle>\n          </div>\n          \n          {/* View Mode Tabs */}\n          <Tabs value={viewMode} onValueChange={(value) => setViewMode(value as 'list' | 'calendar')} className=\"w-full sm:w-auto\">\n            <TabsList className=\"w-full sm:w-auto grid grid-cols-2 sm:flex\">\n              <TabsTrigger value=\"list\" data-testid=\"tab-list-view\" className=\"text-xs sm:text-sm\">\n                <List className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                List\n              </TabsTrigger>\n              <TabsTrigger value=\"calendar\" data-testid=\"tab-calendar-view\" className=\"text-xs sm:text-sm\">\n                <CalendarDays className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                Kalender\n              </TabsTrigger>\n            </TabsList>\n          </Tabs>\n        </div>\n\n        {/* Filters - berbeda untuk List dan Calendar */}\n        {viewMode === 'list' ? (\n          <div className=\"flex flex-wrap items-center gap-2 sm:gap-4\">\n            <Input\n              type=\"date\"\n              value={selectedDate}\n              onChange={(e) => setSelectedDate(e.target.value)}\n              className=\"w-full sm:w-40\"\n              data-testid=\"roster-date-input\"\n            />\n            \n            {/* Search by NIK */}\n            <Input\n              type=\"text\"\n              placeholder=\"Cari NIK...\"\n              value={searchNIK}\n              onChange={(e) => setSearchNIK(e.target.value)}\n              className=\"w-full sm:w-32\"\n              data-testid=\"search-nik-input\"\n            />\n            \n            {/* Search by Name */}\n            <Input\n              type=\"text\"\n              placeholder=\"Cari Nama...\"\n              value={searchName}\n              onChange={(e) => setSearchName(e.target.value)}\n              className=\"w-full sm:w-40\"\n              data-testid=\"search-name-input\"\n            />\n            \n            {/* Shift Filter */}\n            <Select value={shiftFilter} onValueChange={setShiftFilter}>\n              <SelectTrigger className=\"w-full sm:w-40\" data-testid=\"shift-filter-select\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Semua Shift</SelectItem>\n                <SelectItem value=\"SHIFT 1\">SHIFT 1</SelectItem>\n                <SelectItem value=\"SHIFT 2\">SHIFT 2</SelectItem>\n                <SelectItem value=\"OVER SHIFT\">OVER SHIFT</SelectItem>\n                <SelectItem value=\"CUTI\">CUTI</SelectItem>\n              </SelectContent>\n            </Select>\n\n            {/* Filter Status Kehadiran */}\n            <Select value={attendanceFilter} onValueChange={setAttendanceFilter}>\n              <SelectTrigger className=\"w-full sm:w-40\" data-testid=\"attendance-filter-select\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Semua Status</SelectItem>\n                <SelectItem value=\"hadir\">Hadir</SelectItem>\n                <SelectItem value=\"belum_hadir\">Belum Hadir</SelectItem>\n              </SelectContent>\n            </Select>\n\n            <Button \n              onClick={downloadTemplate}\n              variant=\"outline\"\n              data-testid=\"download-template-button\"\n              className=\"w-full sm:w-auto text-xs sm:text-sm\"\n            >\n              <Download className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n              <span className=\"hidden sm:inline\">Template Excel</span>\n              <span className=\"sm:hidden\">Template</span>\n            </Button>\n\n            {/* Delete All Button */}\n            <Button \n              onClick={() => setIsDeleteAllDialogOpen(true)}\n              variant=\"destructive\"\n              data-testid=\"delete-all-roster-button\"\n              className=\"w-full sm:w-auto text-xs sm:text-sm\"\n            >\n              <Trash2 className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n              <span className=\"hidden sm:inline\">Hapus Semua</span>\n              <span className=\"sm:hidden\">Hapus</span>\n            </Button>\n\n            {/* Upload Excel Dialog */}\n            <Dialog open={isUploadDialogOpen} onOpenChange={setIsUploadDialogOpen}>\n              <DialogTrigger asChild>\n                <Button variant=\"secondary\" data-testid=\"upload-excel-button\" className=\"w-full sm:w-auto text-xs sm:text-sm\">\n                  <Upload className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                  <span className=\"hidden sm:inline\">Upload Excel</span>\n                  <span className=\"sm:hidden\">Upload</span>\n                </Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Upload Excel Roster</DialogTitle>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <div>\n                    <Input\n                      type=\"file\"\n                      accept=\".xlsx,.xls\"\n                      onChange={handleFileUpload}\n                      disabled={isProcessing}\n                      data-testid=\"excel-file-input\"\n                    />\n                  </div>\n                  {selectedFile && (\n                    <p className=\"text-sm text-gray-600 dark:text-gray-300\">\n                      File dipilih: {selectedFile.name}\n                    </p>\n                  )}\n                  \n                  {/* Progress Bar Section */}\n                  {isProcessing && (\n                    <div className=\"space-y-3\">\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n                          Memproses Excel...\n                        </span>\n                        <span className=\"text-sm font-medium text-blue-600 dark:text-blue-400\">\n                          {uploadProgress.toFixed(0)}%\n                        </span>\n                      </div>\n                      <Progress value={uploadProgress} className=\"w-full\" />\n                      <div className=\"text-xs text-gray-500 dark:text-gray-400\">\n                        {processedCount > 0 && totalCount > 0 && (\n                          <span>Diproses: {processedCount.toLocaleString()} dari {totalCount.toLocaleString()} baris</span>\n                        )}\n                      </div>\n                    </div>\n                  )}\n                  \n                  <div className=\"flex space-x-2\">\n                    <Button \n                      onClick={processExcelFile}\n                      disabled={!selectedFile || isProcessing || uploadMutation.isPending}\n                      data-testid=\"process-excel-button\"\n                      className=\"flex-1\"\n                    >\n                      {isProcessing ? (\n                        <div className=\"flex items-center space-x-2\">\n                          <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\"></div>\n                          <span>Memproses...</span>\n                        </div>\n                      ) : uploadMutation.isPending ? (\n                        <div className=\"flex items-center space-x-2\">\n                          <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\"></div>\n                          <span>Mengupload...</span>\n                        </div>\n                      ) : (\n                        \"Upload\"\n                      )}\n                    </Button>\n                    <Button \n                      variant=\"outline\" \n                      disabled={isProcessing}\n                      onClick={() => {\n                        setIsUploadDialogOpen(false);\n                        setSelectedFile(null);\n                        setUploadProgress(0);\n                        setIsProcessing(false);\n                        setProcessedCount(0);\n                        setTotalCount(0);\n                      }}\n                    >\n                      Batal\n                    </Button>\n                  </div>\n                </div>\n              </DialogContent>\n            </Dialog>\n\n            {/* Update Employee Schedule Dialog */}\n            <Dialog open={isUpdateScheduleDialogOpen} onOpenChange={setIsUpdateScheduleDialogOpen}>\n              <DialogTrigger asChild>\n                <Button variant=\"outline\" data-testid=\"update-schedule-button\" className=\"w-full sm:w-auto text-xs sm:text-sm\">\n                  <Upload className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                  <span className=\"hidden sm:inline\">Update Jadwal Karyawan</span>\n                  <span className=\"sm:hidden\">Update</span>\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"sm:max-w-[500px]\">\n                <DialogHeader>\n                  <DialogTitle>Update Jadwal Karyawan (1 Bulan)</DialogTitle>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">NIK Karyawan</label>\n                    <Input\n                      type=\"text\"\n                      placeholder=\"Masukkan NIK karyawan (contoh: C-006441)\"\n                      value={nikForUpdate}\n                      onChange={(e) => setNikForUpdate(e.target.value.toUpperCase())}\n                      data-testid=\"update-schedule-nik-input\"\n                      className=\"w-full\"\n                    />\n                    {isLoadingEmployee && nikForUpdate && (\n                      <p className=\"text-sm text-gray-500 flex items-center\">\n                        <div className=\"w-3 h-3 border-2 border-gray-400 border-t-transparent rounded-full animate-spin mr-2\"></div>\n                        Mencari karyawan...\n                      </p>\n                    )}\n                    {employeeForUpdate && nikForUpdate && (\n                      <p className=\"text-sm text-green-600 dark:text-green-400 flex items-center\">\n                        <svg className=\"w-4 h-4 mr-2\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                          <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clipRule=\"evenodd\" />\n                        </svg>\n                        {employeeForUpdate.name}\n                      </p>\n                    )}\n                    {employeeError && nikForUpdate && !isLoadingEmployee && (\n                      <p className=\"text-sm text-red-600 dark:text-red-400\">\n                        NIK tidak ditemukan\n                      </p>\n                    )}\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">Pilih Bulan</label>\n                    <Input\n                      type=\"month\"\n                      value={selectedMonthForUpdate}\n                      onChange={(e) => setSelectedMonthForUpdate(e.target.value)}\n                      data-testid=\"update-schedule-month-input\"\n                      className=\"w-full\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <label className=\"text-sm font-medium\">Upload Excel Jadwal Baru</label>\n                    <Input\n                      type=\"file\"\n                      accept=\".xlsx,.xls\"\n                      onChange={(e) => setUpdateScheduleFile(e.target.files?.[0] || null)}\n                      disabled={isProcessingUpdate}\n                      data-testid=\"update-schedule-file-input\"\n                    />\n                    {updateScheduleFile && (\n                      <p className=\"text-sm text-gray-600 dark:text-gray-300\">\n                        File dipilih: {updateScheduleFile.name}\n                      </p>\n                    )}\n                  </div>\n\n                  <Alert>\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <AlertDescription>\n                      Excel harus berisi jadwal untuk <strong>{employeeForUpdate ? employeeForUpdate.name : \"karyawan yang dipilih\"}</strong> saja dalam 1 bulan penuh. Semua jadwal lama di bulan tersebut akan diganti.\n                    </AlertDescription>\n                  </Alert>\n\n                  <div className=\"flex space-x-2\">\n                    <Button \n                      onClick={async () => {\n                        if (!nikForUpdate || !employeeForUpdate) {\n                          toast({\n                            title: \"Error\",\n                            description: nikForUpdate ? \"NIK tidak ditemukan\" : \"Masukkan NIK karyawan terlebih dahulu\",\n                            variant: \"destructive\",\n                          });\n                          return;\n                        }\n                        if (!selectedMonthForUpdate) {\n                          toast({\n                            title: \"Error\",\n                            description: \"Pilih bulan terlebih dahulu\",\n                            variant: \"destructive\",\n                          });\n                          return;\n                        }\n                        if (!updateScheduleFile) {\n                          toast({\n                            title: \"Error\",\n                            description: \"Pilih file Excel terlebih dahulu\",\n                            variant: \"destructive\",\n                          });\n                          return;\n                        }\n\n                        setIsProcessingUpdate(true);\n\n                        try {\n                          // Read Excel file\n                          const data = await updateScheduleFile.arrayBuffer();\n                          const workbook = XLSX.read(data);\n                          const sheetName = workbook.SheetNames.includes('Template Roster') \n                            ? 'Template Roster' \n                            : workbook.SheetNames[0];\n                          \n                          const worksheet = workbook.Sheets[sheetName];\n                          const jsonData = XLSX.utils.sheet_to_json(worksheet);\n\n                          // Process data (reuse same logic from processExcelFile)\n                          const rosterData: InsertRosterSchedule[] = jsonData.map((row: any) => {\n                            const rawShift = String(row.Shift || row.shift || '').trim().toUpperCase();\n                            let normalizedShift = 'SHIFT 1';\n                            \n                            if (['SHIFT 1', 'SHIFT1', 'S1', '1'].includes(rawShift)) normalizedShift = 'SHIFT 1';\n                            else if (['SHIFT 2', 'SHIFT2', 'S2', '2'].includes(rawShift)) normalizedShift = 'SHIFT 2';\n                            else if (['OVER SHIFT', 'OVER', 'OS'].includes(rawShift)) normalizedShift = 'OVER SHIFT';\n                            else if (['CUTI', 'OFF', 'LEAVE'].includes(rawShift)) normalizedShift = 'CUTI';\n\n                            let defaultStartTime = '06:00', defaultEndTime = '16:00';\n                            if (normalizedShift === 'SHIFT 2') { defaultStartTime = '18:00'; defaultEndTime = '06:00'; }\n                            else if (normalizedShift === 'CUTI') { defaultStartTime = '00:00'; defaultEndTime = '00:00'; }\n                            else if (normalizedShift === 'OVER SHIFT') { defaultStartTime = '06:00'; defaultEndTime = '18:00'; }\n\n                            let rosterDate = row.Tanggal || row.tanggal || row.Date || row.date || '';\n                            if (typeof rosterDate === 'number') {\n                              const utcDate = new Date(Date.UTC(1899, 11, 30) + (rosterDate * 24 * 60 * 60 * 1000));\n                              rosterDate = `${utcDate.getUTCFullYear()}-${String(utcDate.getUTCMonth() + 1).padStart(2, '0')}-${String(utcDate.getUTCDate()).padStart(2, '0')}`;\n                            }\n\n                            return {\n                              employeeId: row.NIK || row.nik || row['Employee ID'] || row.employeeId || '',\n                              date: rosterDate,\n                              shift: normalizedShift,\n                              startTime: row['Jam Kel'] || row.jamKel || defaultStartTime,\n                              endTime: row['Jam Tld'] || row.jamTld || defaultEndTime,\n                              jamTidur: String(row['Jam Tidur'] || row.jamTidur || ''),\n                              fitToWork: row['Fit To W'] || row['Fit To Work'] || row.fitToWork || 'Fit To Work',\n                              hariKerja: String(row['Hari Kerja'] || row.hariKerja || ''),\n                              status: row.Status || row.status || 'scheduled'\n                            };\n                          }).filter(row => row.employeeId && row.shift);\n\n                          if (rosterData.length === 0) {\n                            setIsProcessingUpdate(false);\n                            toast({\n                              title: \"Error\",\n                              description: \"Tidak ada data valid ditemukan di Excel\",\n                              variant: \"destructive\",\n                            });\n                            return;\n                          }\n\n                          // Submit to API\n                          updateScheduleMutation.mutate({\n                            employeeId: nikForUpdate,\n                            month: selectedMonthForUpdate,\n                            rosters: rosterData\n                          });\n                        } catch (error) {\n                          console.error('Update schedule error:', error);\n                          setIsProcessingUpdate(false);\n                          toast({\n                            title: \"Error\",\n                            description: \"Format file Excel tidak valid\",\n                            variant: \"destructive\",\n                          });\n                        }\n                      }}\n                      disabled={!nikForUpdate || !employeeForUpdate || !selectedMonthForUpdate || !updateScheduleFile || isProcessingUpdate || updateScheduleMutation.isPending}\n                      data-testid=\"process-update-schedule-button\"\n                      className=\"flex-1\"\n                    >\n                      {isProcessingUpdate || updateScheduleMutation.isPending ? (\n                        <div className=\"flex items-center space-x-2\">\n                          <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\"></div>\n                          <span>Memproses...</span>\n                        </div>\n                      ) : (\n                        \"Update Jadwal\"\n                      )}\n                    </Button>\n                    <Button \n                      variant=\"outline\" \n                      disabled={isProcessingUpdate}\n                      onClick={() => {\n                        setIsUpdateScheduleDialogOpen(false);\n                        setNikForUpdate(\"\");\n                        setSelectedMonthForUpdate(\"\");\n                        setUpdateScheduleFile(null);\n                        setIsProcessingUpdate(false);\n                      }}\n                    >\n                      Batal\n                    </Button>\n                  </div>\n                </div>\n              </DialogContent>\n            </Dialog>\n            \n            {/* Add Roster Dialog */}\n            <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"add-roster-button\" className=\"w-full sm:w-auto text-xs sm:text-sm\">\n                  <Plus className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2\" />\n                  <span className=\"hidden sm:inline\">Tambah Roster</span>\n                  <span className=\"sm:hidden\">Tambah</span>\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"sm:max-w-[425px]\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center justify-between\">\n                    <span>Tambah Roster</span>\n                    <AutoSaveIndicator status={saveStatus} />\n                  </DialogTitle>\n                </DialogHeader>\n                \n                {hasDraft() && (\n                  <Alert>\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <AlertDescription>\n                      Draft tersimpan otomatis akan dipulihkan. Data yang belum disimpan akan tetap aman.\n                    </AlertDescription>\n                  </Alert>\n                )}\n                <Form {...form}>\n                  <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"employeeId\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Karyawan</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"roster-employee-select\">\n                                <SelectValue placeholder=\"Pilih karyawan\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              {employees.map((employee) => (\n                                <SelectItem key={employee.id} value={employee.id}>\n                                  {employee.id} - {employee.name} ({employee.position || 'No ID'})\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"shift\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Shift</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"roster-shift-select\">\n                                <SelectValue placeholder=\"Pilih shift\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"Shift 1\">Shift 1 (06:00 - 18:00)</SelectItem>\n                              <SelectItem value=\"Shift 2\">Shift 2 (18:00 - 06:00)</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={form.control}\n                        name=\"startTime\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Jam Mulai</FormLabel>\n                            <FormControl>\n                              <Input \n                                type=\"time\" \n                                {...field} \n                                data-testid=\"roster-start-time-input\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={form.control}\n                        name=\"endTime\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Jam Selesai</FormLabel>\n                            <FormControl>\n                              <Input \n                                type=\"time\" \n                                {...field} \n                                data-testid=\"roster-end-time-input\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    <FormField\n                      control={form.control}\n                      name=\"jamTidur\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Jam Tidur (contoh: 6 atau 5)</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"number\"\n                              min=\"1\"\n                              max=\"12\"\n                              placeholder=\"6\"\n                              {...field}\n                              value={field.value || \"\"}\n                              data-testid=\"roster-jam-tidur-input\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"fitToWork\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Status Fit To Work</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"roster-fit-to-work-select\">\n                                <SelectValue placeholder=\"Pilih status fit to work\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"Fit To Work\">Fit To Work</SelectItem>\n                              <SelectItem value=\"Not Fit To Work\">Not Fit To Work</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <Button \n                      type=\"submit\" \n                      className=\"w-full\"\n                      disabled={createMutation.isPending}\n                      data-testid=\"submit-roster-button\"\n                    >\n                      {createMutation.isPending ? \"Menyimpan...\" : \"Simpan\"}\n                    </Button>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n            \n            {/* Edit Roster Dialog */}\n            <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n              <DialogContent className=\"sm:max-w-[425px]\">\n                <DialogHeader>\n                  <DialogTitle>Edit Roster</DialogTitle>\n                </DialogHeader>\n                <Form {...editForm}>\n                  <form onSubmit={editForm.handleSubmit(onEditSubmit)} className=\"space-y-4\">\n                    <FormField\n                      control={editForm.control}\n                      name=\"employeeId\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Karyawan</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"edit-roster-employee-select\">\n                                <SelectValue placeholder=\"Pilih karyawan\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              {employees.map((employee) => (\n                                <SelectItem key={employee.id} value={employee.id}>\n                                  {employee.id} - {employee.name} ({employee.position || 'No ID'})\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editForm.control}\n                      name=\"shift\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Shift</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"edit-roster-shift-select\">\n                                <SelectValue placeholder=\"Pilih shift\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"Shift 1\">Shift 1 (06:00 - 18:00)</SelectItem>\n                              <SelectItem value=\"Shift 2\">Shift 2 (18:00 - 06:00)</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={editForm.control}\n                        name=\"startTime\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Jam Mulai</FormLabel>\n                            <FormControl>\n                              <Input \n                                type=\"time\" \n                                {...field} \n                                data-testid=\"edit-roster-start-time-input\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={editForm.control}\n                        name=\"endTime\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Jam Selesai</FormLabel>\n                            <FormControl>\n                              <Input \n                                type=\"time\" \n                                {...field} \n                                data-testid=\"edit-roster-end-time-input\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    <FormField\n                      control={editForm.control}\n                      name=\"jamTidur\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Jam Tidur (contoh: 6 atau 5)</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"number\"\n                              min=\"1\"\n                              max=\"12\"\n                              placeholder=\"6\"\n                              {...field}\n                              value={field.value || \"\"}\n                              data-testid=\"edit-roster-jam-tidur-input\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editForm.control}\n                      name=\"fitToWork\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Status Fit To Work</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"edit-roster-fit-to-work-select\">\n                                <SelectValue placeholder=\"Pilih status fit to work\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"Fit To Work\">Fit To Work</SelectItem>\n                              <SelectItem value=\"Not Fit To Work\">Not Fit To Work</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editForm.control}\n                      name=\"hariKerja\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Hari Kerja</FormLabel>\n                          <FormControl>\n                            <Input \n                              placeholder=\"Contoh: Senin, Selasa\"\n                              {...field}\n                              value={field.value || \"\"}\n                              data-testid=\"edit-roster-hari-kerja-input\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <div className=\"flex space-x-2\">\n                      <Button \n                        type=\"submit\" \n                        className=\"flex-1\"\n                        disabled={updateMutation.isPending}\n                        data-testid=\"update-roster-button\"\n                      >\n                        {updateMutation.isPending ? \"Menyimpan...\" : \"Update\"}\n                      </Button>\n                      <Button \n                        type=\"button\"\n                        variant=\"outline\"\n                        onClick={() => {\n                          setIsEditDialogOpen(false);\n                          setEditingRoster(null);\n                        }}\n                      >\n                        Batal\n                      </Button>\n                    </div>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n          </div>\n        ) : (\n          // Calendar view filters\n          <div className=\"flex flex-wrap items-center gap-2 sm:gap-4\">\n            {/* Month Selector */}\n            <Select \n              value={selectedMonth.toString()} \n              onValueChange={(value) => setSelectedMonth(parseInt(value))}\n            >\n              <SelectTrigger className=\"w-full sm:w-36\" data-testid=\"month-select\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"1\">Januari</SelectItem>\n                <SelectItem value=\"2\">Februari</SelectItem>\n                <SelectItem value=\"3\">Maret</SelectItem>\n                <SelectItem value=\"4\">April</SelectItem>\n                <SelectItem value=\"5\">Mei</SelectItem>\n                <SelectItem value=\"6\">Juni</SelectItem>\n                <SelectItem value=\"7\">Juli</SelectItem>\n                <SelectItem value=\"8\">Agustus</SelectItem>\n                <SelectItem value=\"9\">September</SelectItem>\n                <SelectItem value=\"10\">Oktober</SelectItem>\n                <SelectItem value=\"11\">November</SelectItem>\n                <SelectItem value=\"12\">Desember</SelectItem>\n              </SelectContent>\n            </Select>\n\n            {/* Year Selector */}\n            <Select \n              value={selectedYear.toString()} \n              onValueChange={(value) => setSelectedYear(parseInt(value))}\n            >\n              <SelectTrigger className=\"w-full sm:w-28\" data-testid=\"year-select\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i).map((year) => (\n                  <SelectItem key={year} value={year.toString()}>\n                    {year}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n\n            {/* Shift Filter for Calendar */}\n            <Select value={shiftFilter} onValueChange={setShiftFilter}>\n              <SelectTrigger className=\"w-full sm:w-36\" data-testid=\"calendar-shift-filter\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Semua Shift</SelectItem>\n                <SelectItem value=\"SHIFT 1\">SHIFT 1</SelectItem>\n                <SelectItem value=\"SHIFT 2\">SHIFT 2</SelectItem>\n                <SelectItem value=\"OVER SHIFT\">OVER SHIFT</SelectItem>\n                <SelectItem value=\"CUTI\">CUTI</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        )}\n      </CardHeader>\n      \n      <CardContent>\n        {viewMode === 'list' ? (\n          // List View\n          <>\n            {/* Roster Stats */}\n            <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4 mb-4 sm:mb-6\">\n              <div className=\"text-center p-2 sm:p-4 bg-gray-50 dark:bg-gray-700 rounded-lg\" data-testid=\"stats-scheduled\">\n                <Calendar className=\"w-4 h-4 sm:w-6 sm:h-6 mx-auto mb-1 sm:mb-2 text-gray-600 dark:text-gray-400\" />\n                <p className=\"text-lg sm:text-2xl font-semibold text-gray-900 dark:text-white\">{stats.scheduled}</p>\n                <p className=\"text-xs sm:text-sm text-gray-600 dark:text-gray-400\">Dijadwalkan</p>\n              </div>\n              <div className=\"text-center p-2 sm:p-4 bg-green-50 dark:bg-green-900 rounded-lg\" data-testid=\"stats-present\">\n                <CheckCircle className=\"w-4 h-4 sm:w-6 sm:h-6 mx-auto mb-1 sm:mb-2 text-green-600 dark:text-green-400\" />\n                <p className=\"text-lg sm:text-2xl font-semibold text-green-600 dark:text-green-300\">{stats.present}</p>\n                <p className=\"text-xs sm:text-sm text-green-600 dark:text-green-400\">Hadir</p>\n              </div>\n              <div className=\"text-center p-2 sm:p-4 bg-red-50 dark:bg-red-900 rounded-lg\" data-testid=\"stats-absent\">\n                <Clock className=\"w-4 h-4 sm:w-6 sm:h-6 mx-auto mb-1 sm:mb-2 text-red-600 dark:text-red-400\" />\n                <p className=\"text-lg sm:text-2xl font-semibold text-red-600 dark:text-red-300\">{stats.absent}</p>\n                <p className=\"text-xs sm:text-sm text-red-600 dark:text-red-400\">Belum Hadir</p>\n              </div>\n              <div className=\"text-center p-2 sm:p-4 bg-purple-50 dark:bg-purple-900 rounded-lg\" data-testid=\"stats-leave\">\n                <Users className=\"w-4 h-4 sm:w-6 sm:h-6 mx-auto mb-1 sm:mb-2 text-purple-600 dark:text-purple-400\" />\n                <p className=\"text-lg sm:text-2xl font-semibold text-purple-600 dark:text-purple-300\">{stats.onLeave}</p>\n                <p className=\"text-xs sm:text-sm text-purple-600 dark:text-purple-400\">Cuti</p>\n              </div>\n            </div>\n        \n        {/* Roster Table */}\n        <div className=\"table-responsive overflow-x-auto -mx-2 sm:mx-0\">\n          <table className=\"w-full table-auto min-w-[1200px]\">\n            <thead>\n              <tr className=\"border-b border-gray-200 dark:border-gray-700\">\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">NIK</th>\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">Nama</th>\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">Position</th>\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">Nomor Lambung</th>\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">Tanggal</th>\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">Shift</th>\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">Hari Kerja</th>\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">Jam Tidur</th>\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">Fit To Work</th>\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">Status</th>\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">Jam Absensi</th>\n                <th className=\"text-left py-2 sm:py-3 px-2 sm:px-4 font-medium text-xs sm:text-sm text-gray-900 dark:text-white\">Aksi</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-gray-200 dark:divide-gray-700\">\n              {isLoadingRoster ? (\n                <tr>\n                  <td colSpan={12} className=\"py-8 text-center text-gray-500 dark:text-gray-400\">\n                    Loading...\n                  </td>\n                </tr>\n              ) : rosterWithAttendance.length === 0 ? (\n                <tr>\n                  <td colSpan={12} className=\"py-8 text-center text-gray-500 dark:text-gray-400\">\n                    Tidak ada roster untuk tanggal ini\n                  </td>\n                </tr>\n              ) : (\n                rosterWithAttendance.map((roster) => (\n                  <tr key={roster.id} data-testid={`roster-row-${roster.employeeId}`}>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {roster.employeeId}\n                    </td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {roster.employee?.name || 'Unknown'}\n                    </td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {roster.employee?.position || '-'}\n                    </td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {(() => {\n                        // Use fallback chain: actualNomorLambung â†’ plannedNomorLambung â†’ employee master data\n                        // This matches PDF generator logic for consistency\n                        // Handle empty strings properly (not just null/undefined)\n                        const isValidValue = (val: string | null | undefined) => val && val !== '-' && val !== 'null' && val.trim() !== '';\n                        const effectiveNomorLambung = isValidValue(roster.actualNomorLambung)\n                          ? roster.actualNomorLambung\n                          : isValidValue(roster.plannedNomorLambung)\n                            ? roster.plannedNomorLambung\n                            : roster.employee?.nomorLambung || '-';\n                        \n                        // SPARE edit UI based on employee data only\n                        if (roster.employee?.nomorLambung === \"SPARE\" || roster.employee?.isSpareOrigin) {\n                          if (editingNomorLambung[roster.employeeId]) {\n                            return (\n                              <div className=\"flex items-center space-x-2\">\n                                <span className=\"text-xs font-medium text-orange-600\">SPARE</span>\n                                <Input\n                                  value={tempNomorLambung[roster.employeeId] || \"\"}\n                                  onChange={(e) => setTempNomorLambung(prev => ({ ...prev, [roster.employeeId]: e.target.value }))}\n                                  placeholder=\"Masukkan nomor lambung\"\n                                  className=\"w-32 h-8 text-xs\"\n                                  onKeyDown={(e) => {\n                                    if (e.key === 'Enter') {\n                                      handleSaveNomorLambung(roster.employeeId);\n                                    } else if (e.key === 'Escape') {\n                                      handleCancelEditNomorLambung(roster.employeeId);\n                                    }\n                                  }}\n                                  autoFocus\n                                />\n                                <Button\n                                  size=\"sm\"\n                                  onClick={() => handleSaveNomorLambung(roster.employeeId)}\n                                  disabled={updateNomorLambungMutation.isPending}\n                                  className=\"h-6 w-6 p-0\"\n                                >\n                                  <Save className=\"w-3 h-3\" />\n                                </Button>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  onClick={() => handleCancelEditNomorLambung(roster.employeeId)}\n                                  className=\"h-6 w-6 p-0\"\n                                >\n                                  <X className=\"w-3 h-3\" />\n                                </Button>\n                              </div>\n                            );\n                          } else {\n                            return (\n                              <div className=\"flex items-center space-x-2\">\n                                <Badge \n                                  variant=\"secondary\" \n                                  className=\"bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300 cursor-pointer hover:bg-orange-200 dark:hover:bg-orange-800\"\n                                  onClick={() => handleEditNomorLambung(roster.employeeId, \"SPARE\")}\n                                >\n                                  SPARE\n                                </Badge>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"outline\"\n                                  onClick={() => handleEditNomorLambung(roster.employeeId, \"SPARE\")}\n                                  className=\"h-6 w-6 p-0\"\n                                  title=\"Edit nomor lambung\"\n                                >\n                                  <Edit className=\"w-3 h-3\" />\n                                </Button>\n                              </div>\n                            );\n                          }\n                        }\n                        \n                        // Display effective nomor lambung for non-SPARE\n                        if (effectiveNomorLambung !== '-') {\n                          // Check if nomor lambung has been updated (actualNomorLambung different from employee master)\n                          const hasNomorLambungChanged = isValidValue(roster.actualNomorLambung) && \n                                                          roster.actualNomorLambung !== roster.employee?.nomorLambung;\n                          \n                          // Show SPARE origin badge for updated SPARE employees\n                          if (roster.employee?.isSpareOrigin && effectiveNomorLambung !== \"SPARE\") {\n                            return (\n                              <div className=\"flex items-center space-x-1\">\n                                <Badge variant=\"secondary\" className=\"bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300 text-xs\">\n                                  SPARE\n                                </Badge>\n                                <span className=\"text-sm font-medium\">{effectiveNomorLambung}</span>\n                              </div>\n                            );\n                          }\n                          \n                          // Show badge if nomor lambung was updated today\n                          if (hasNomorLambungChanged) {\n                            return (\n                              <div className=\"flex items-center space-x-2\">\n                                <span className=\"text-sm font-medium\">{effectiveNomorLambung}</span>\n                                <Badge \n                                  variant=\"secondary\" \n                                  className=\"bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300 text-xs\"\n                                  title={`Diupdate dari ${roster.employee?.nomorLambung || 'N/A'}`}\n                                >\n                                  ðŸ“¦ Berubah\n                                </Badge>\n                              </div>\n                            );\n                          }\n                          \n                          return effectiveNomorLambung;\n                        }\n                        \n                        return '-';\n                      })()}\n                    </td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {new Date(roster.date).toLocaleDateString('id-ID')}\n                    </td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {roster.shift}\n                    </td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {roster.hariKerja || '-'}\n                    </td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {roster.actualJamTidur || roster.jamTidur || '-'}\n                    </td>\n                    <td className=\"py-3 px-4\">\n                      <Badge \n                        variant={(roster.actualFitToWork || roster.fitToWork) === \"Fit To Work\" ? \"default\" : \"destructive\"}\n                        data-testid={`roster-fit-to-work-${roster.employeeId}`}\n                      >\n                        {roster.actualFitToWork || roster.fitToWork || \"Fit To Work\"}\n                      </Badge>\n                    </td>\n                    <td className=\"py-3 px-4\">\n                      <Badge \n                        className={roster.hasAttended ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'}\n                      >\n                        {roster.hasAttended ? 'Hadir' : 'Belum Hadir'}\n                      </Badge>\n                    </td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">\n                      {roster.attendanceTime || '-'}\n                    </td>\n                    <td className=\"py-3 px-4\">\n                      <div className=\"flex space-x-2\">\n                        <Button \n                          size=\"sm\" \n                          variant=\"outline\"\n                          onClick={() => handleEdit(roster)}\n                          data-testid={`edit-roster-${roster.employeeId}`}\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </Button>\n                        <Button \n                          size=\"sm\" \n                          variant=\"destructive\"\n                          onClick={() => handleDelete(roster.id)}\n                          data-testid={`delete-roster-${roster.employeeId}`}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n          </>\n        ) : (\n          // Calendar View\n          <div className=\"p-2\">\n            {isLoadingMonthly ? (\n              <div className=\"text-center py-12 text-gray-500 dark:text-gray-400\">\n                Loading kalender...\n              </div>\n            ) : (\n              <MonthlyCalendar\n                year={selectedYear}\n                month={selectedMonth}\n                rosterData={monthlyRoster}\n                shiftFilter={shiftFilter}\n                onDateClick={(date) => {\n                  setSelectedDate(date);\n                  setViewMode('list');\n                }}\n              />\n            )}\n          </div>\n        )}\n      </CardContent>\n      \n      {/* Delete All Confirmation Dialog */}\n      <Dialog open={isDeleteAllDialogOpen} onOpenChange={setIsDeleteAllDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Konfirmasi Hapus Semua Data</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <p className=\"text-sm text-gray-600 dark:text-gray-300\">\n              Apakah Anda yakin ingin menghapus <strong>SEMUA</strong> data roster? \n              Tindakan ini tidak dapat dibatalkan dan akan menghapus semua jadwal kerja yang ada.\n            </p>\n            <div className=\"flex space-x-2 justify-end\">\n              <Button \n                variant=\"outline\" \n                onClick={() => setIsDeleteAllDialogOpen(false)}\n                disabled={deleteAllMutation.isPending}\n              >\n                Batal\n              </Button>\n              <Button \n                variant=\"destructive\" \n                onClick={() => deleteAllMutation.mutate()}\n                disabled={deleteAllMutation.isPending}\n                data-testid=\"confirm-delete-all-button\"\n              >\n                {deleteAllMutation.isPending ? \"Menghapus...\" : \"Ya, Hapus Semua\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </Card>\n  );\n}","path":null,"size_bytes":85101,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, timestamp, boolean, integer, unique, jsonb, index, uniqueIndex } from \"drizzle-orm/pg-core\";\nimport { relations } from \"drizzle-orm\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Session storage table for Replit Auth\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// User storage table for Replit Auth\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Authentication table for employee login\nexport const authUsers = pgTable(\"auth_users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  nik: varchar(\"nik\").notNull().unique().references(() => employees.id),\n  hashedPassword: text(\"hashed_password\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_auth_users_nik\").on(table.nik),\n]);\n\nexport const employees = pgTable(\"employees\", {\n  id: varchar(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  position: text(\"position\"),\n  nomorLambung: text(\"nomor_lambung\"),\n  isSpareOrigin: boolean(\"is_spare_origin\").default(false), // Track jika karyawan asli SPARE\n  department: text(\"department\"),\n  investorGroup: text(\"investor_group\"),\n  phone: text(\"phone\").notNull(),\n  qrCode: text(\"qr_code\"), // QR Code data untuk karyawan\n  status: text(\"status\").notNull().default(\"active\"),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n}, (table) => [\n  index(\"IDX_employees_name\").on(table.name),\n  index(\"IDX_employees_status\").on(table.status),\n  index(\"IDX_employees_department\").on(table.department),\n]);\n\nexport const attendanceRecords = pgTable(\"attendance_records\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").notNull().references(() => employees.id),\n  date: text(\"date\").notNull(),\n  time: text(\"time\").notNull(),\n  jamTidur: text(\"jam_tidur\"), // Jam tidur karyawan\n  fitToWork: text(\"fit_to_work\"), // Status fit to work\n  status: text(\"status\").notNull().default(\"present\"),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n}, (table) => [\n  index(\"IDX_attendance_date\").on(table.date),\n  index(\"IDX_attendance_employee\").on(table.employeeId),\n  index(\"IDX_attendance_employee_date\").on(table.employeeId, table.date),\n  index(\"IDX_attendance_status\").on(table.status),\n]);\n\nexport const rosterSchedules = pgTable(\"roster_schedules\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").notNull().references(() => employees.id),\n  date: text(\"date\").notNull(),\n  shift: text(\"shift\").notNull(),\n  startTime: text(\"start_time\").notNull(),\n  endTime: text(\"end_time\").notNull(),\n  jamTidur: text(\"jam_tidur\"), // Jam tidur dalam angka (contoh: \"6\", \"5\")\n  fitToWork: text(\"fit_to_work\").notNull().default(\"Fit To Work\"), // Status fit to work\n  hariKerja: text(\"hari_kerja\"), // Hari kerja dari Excel upload (contoh: \"Senin\", \"Selasa\")\n  plannedNomorLambung: text(\"planned_nomor_lambung\"), // Nomor lambung yang dijadwalkan\n  actualNomorLambung: text(\"actual_nomor_lambung\"), // Nomor lambung yang benar-benar dipakai (bisa diedit hari itu)\n  status: text(\"status\").notNull().default(\"scheduled\"),\n}, (table) => [\n  index(\"IDX_roster_date\").on(table.date),\n  index(\"IDX_roster_employee\").on(table.employeeId),\n  index(\"IDX_roster_employee_date\").on(table.employeeId, table.date),\n  index(\"IDX_roster_shift\").on(table.shift),\n  index(\"IDX_roster_status\").on(table.status),\n]);\n\nexport const leaveRequests = pgTable(\"leave_requests\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").notNull().references(() => employees.id),\n  employeeName: text(\"employee_name\").notNull(),\n  phoneNumber: text(\"phone_number\").notNull(),\n  startDate: text(\"start_date\").notNull(),\n  endDate: text(\"end_date\").notNull(),\n  leaveType: text(\"leave_type\").notNull(),\n  reason: text(\"reason\"),\n  attachmentPath: text(\"attachment_path\"), // Path to uploaded PDF file\n  actionAttachmentPath: text(\"action_attachment_path\"), // Path to HR action PDF file\n  status: text(\"status\").notNull().default(\"pending\"),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n});\n\n// Table untuk tracking saldo cuti karyawan\nexport const leaveBalances = pgTable(\"leave_balances\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").notNull().references(() => employees.id),\n  year: integer(\"year\").notNull(),\n  totalDays: integer(\"total_days\").notNull().default(0), // Total hari cuti yang berhak\n  usedDays: integer(\"used_days\").notNull().default(0), // Hari cuti yang sudah digunakan\n  remainingDays: integer(\"remaining_days\").notNull().default(0), // Sisa hari cuti\n  workingDaysCompleted: integer(\"working_days_completed\").notNull().default(0), // Hari kerja yang sudah diselesaikan\n  lastWorkDate: text(\"last_work_date\"), // Tanggal kerja terakhir\n  lastLeaveDate: text(\"last_leave_date\"), // Tanggal cuti terakhir\n  nextLeaveEligible: text(\"next_leave_eligible\"), // Tanggal kapan boleh cuti lagi\n  status: text(\"status\").notNull().default(\"active\"), // active, expired\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n});\n\n// Table untuk roster monitoring cuti karyawan\nexport const leaveRosterMonitoring = pgTable(\"leave_roster_monitoring\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  nik: varchar(\"nik\").notNull(),\n  name: text(\"name\").notNull(),\n  nomorLambung: text(\"nomor_lambung\"),\n  month: varchar(\"month\").notNull(), // Format: \"YYYY-MM\" e.g. \"2024-08\"\n  investorGroup: text(\"investor_group\").notNull(),\n  lastLeaveDate: text(\"last_leave_date\"), // Tanggal terakhir cuti\n  leaveOption: text(\"leave_option\").notNull(), // \"70\" atau \"35\" hari kerja\n  monitoringDays: integer(\"monitoring_days\").notNull().default(0), // Jumlah hari sejak terakhir cuti\n  nextLeaveDate: text(\"next_leave_date\"), // Tanggal cuti berikutnya (otomatis hitung)\n  onSite: text(\"on_site\"), // OnSite status: \"Ya\", \"Tidak\", atau kosong\n  status: text(\"status\").notNull().default(\"Aktif\"), // Aktif, Menunggu Cuti, Sedang Cuti, Selesai Cuti\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").default(sql`now()`),\n}, (table) => ({\n  // Unique constraint untuk NIK + Month (bisa ada duplikat NIK untuk bulan berbeda)\n  nikMonthUnique: unique().on(table.nik, table.month),\n}));\n\n// Table untuk history cuti karyawan  \nexport const leaveHistory = pgTable(\"leave_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").notNull().references(() => employees.id),\n  leaveRequestId: varchar(\"leave_request_id\").references(() => leaveRequests.id),\n  leaveType: text(\"leave_type\").notNull(),\n  startDate: text(\"start_date\").notNull(),\n  endDate: text(\"end_date\").notNull(),\n  totalDays: integer(\"total_days\").notNull(),\n  balanceBeforeLeave: integer(\"balance_before_leave\").notNull(),\n  balanceAfterLeave: integer(\"balance_after_leave\").notNull(),\n  status: text(\"status\").notNull(), // taken, cancelled, pending\n  remarks: text(\"remarks\"),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n});\n\nexport const qrTokens = pgTable(\"qr_tokens\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").notNull().references(() => employees.id),\n  token: text(\"token\").notNull(),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n});\n\nexport const leaveReminders = pgTable(\"leave_reminders\", {\n  id: varchar(\"id\").primaryKey(),\n  leaveRequestId: varchar(\"leave_request_id\").notNull().references(() => leaveRequests.id),\n  employeeId: varchar(\"employee_id\").notNull().references(() => employees.id),\n  reminderType: text(\"reminder_type\").notNull(), // '7_days', '3_days', '1_day'\n  sentAt: timestamp(\"sent_at\").notNull(),\n  phoneNumber: text(\"phone_number\").notNull(),\n  message: text(\"message\").notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`now()`),\n});\n\n\n\n// Insert schemas\nexport const insertEmployeeSchema = createInsertSchema(employees).omit({\n  createdAt: true,\n});\n\nexport const insertAttendanceSchema = createInsertSchema(attendanceRecords).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertRosterSchema = createInsertSchema(rosterSchedules).omit({\n  id: true,\n});\n\nexport const insertLeaveRequestSchema = createInsertSchema(leaveRequests).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertQrTokenSchema = createInsertSchema(qrTokens).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertLeaveReminderSchema = createInsertSchema(leaveReminders).omit({\n  createdAt: true,\n});\n\nexport const insertLeaveBalanceSchema = createInsertSchema(leaveBalances).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertLeaveHistorySchema = createInsertSchema(leaveHistory).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertLeaveRosterMonitoringSchema = createInsertSchema(leaveRosterMonitoring).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\n// Types\nexport type Employee = typeof employees.$inferSelect;\nexport type InsertEmployee = z.infer<typeof insertEmployeeSchema>;\nexport type AttendanceRecord = typeof attendanceRecords.$inferSelect;\nexport type InsertAttendanceRecord = z.infer<typeof insertAttendanceSchema>;\nexport type RosterSchedule = typeof rosterSchedules.$inferSelect;\nexport type InsertRosterSchedule = z.infer<typeof insertRosterSchema>;\nexport type LeaveRequest = typeof leaveRequests.$inferSelect;\nexport type InsertLeaveRequest = z.infer<typeof insertLeaveRequestSchema>;\nexport type QrToken = typeof qrTokens.$inferSelect;\nexport type InsertQrToken = z.infer<typeof insertQrTokenSchema>;\nexport type LeaveReminder = typeof leaveReminders.$inferSelect;\nexport type InsertLeaveReminder = z.infer<typeof insertLeaveReminderSchema>;\nexport type LeaveBalance = typeof leaveBalances.$inferSelect;\nexport type InsertLeaveBalance = z.infer<typeof insertLeaveBalanceSchema>;\nexport type LeaveHistory = typeof leaveHistory.$inferSelect;\nexport type InsertLeaveHistory = z.infer<typeof insertLeaveHistorySchema>;\nexport type LeaveRosterMonitoring = typeof leaveRosterMonitoring.$inferSelect;\nexport type InsertLeaveRosterMonitoring = z.infer<typeof insertLeaveRosterMonitoringSchema>;\n\n\n// Meeting attendance system\nexport const meetings = pgTable(\"meetings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: varchar(\"title\").notNull(),\n  description: text(\"description\"),\n  date: varchar(\"date\").notNull(), // YYYY-MM-DD format\n  startTime: varchar(\"start_time\").notNull(), // HH:MM format\n  endTime: varchar(\"end_time\").notNull(), // HH:MM format\n  location: varchar(\"location\").notNull(),\n  organizer: varchar(\"organizer\").notNull(),\n  status: varchar(\"status\").notNull().default(\"scheduled\"), // scheduled, ongoing, completed, cancelled\n  qrToken: varchar(\"qr_token\").unique(), // Unique token for QR code\n  meetingPhotos: text(\"meeting_photos\").array(), // Array of photo paths (max 4)\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const meetingAttendance = pgTable(\"meeting_attendance\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  meetingId: varchar(\"meeting_id\").notNull().references(() => meetings.id, { onDelete: \"cascade\" }),\n  employeeId: varchar(\"employee_id\").references(() => employees.id, { onDelete: \"cascade\" }), // Made nullable for manual entries\n  scanTime: varchar(\"scan_time\").notNull(), // HH:MM:SS format  \n  scanDate: varchar(\"scan_date\").notNull(), // YYYY-MM-DD format\n  deviceInfo: varchar(\"device_info\"), // Browser/device information\n  attendanceType: varchar(\"attendance_type\").notNull().default(\"qr_scan\"), // \"qr_scan\" | \"manual_entry\"\n  \n  // Manual entry fields for investor group\n  manualName: varchar(\"manual_name\"), // Nama karyawan for manual entry\n  manualPosition: varchar(\"manual_position\"), // \"Investor\" | \"Korlap\"\n  manualDepartment: varchar(\"manual_department\"), // Selected from investorGroup\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// SIMPER Employee Monitoring System\nexport const simperMonitoring = pgTable(\"simper_monitoring\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeName: text(\"employee_name\").notNull(),\n  nik: varchar(\"nik\").notNull().unique(),\n  simperBibExpiredDate: text(\"simper_bib_expired_date\"), // Format: YYYY-MM-DD\n  simperTiaExpiredDate: text(\"simper_tia_expired_date\"), // Format: YYYY-MM-DD  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertMeetingSchema = createInsertSchema(meetings).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertMeetingAttendanceSchema = createInsertSchema(meetingAttendance).omit({\n  id: true,\n  createdAt: true,\n});\n\n// Schema for manual attendance entry (investor group)\nexport const insertManualAttendanceSchema = insertMeetingAttendanceSchema.extend({\n  attendanceType: z.literal(\"manual_entry\"),\n  manualName: z.string().min(1, \"Nama karyawan required\"),\n  manualPosition: z.enum([\"Investor\", \"Korlap\"], { required_error: \"Position required\" }),\n  manualDepartment: z.string().min(1, \"Department required\"),\n}).omit({\n  employeeId: true, // Not needed for manual entry\n  meetingId: true, // Added by backend from route params\n});\n\nexport const insertSimperMonitoringSchema = createInsertSchema(simperMonitoring).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type Meeting = typeof meetings.$inferSelect;\nexport type InsertMeeting = z.infer<typeof insertMeetingSchema>;\nexport type MeetingAttendance = typeof meetingAttendance.$inferSelect;\nexport type InsertMeetingAttendance = z.infer<typeof insertMeetingAttendanceSchema>;\nexport type InsertManualAttendance = z.infer<typeof insertManualAttendanceSchema>;\nexport type SimperMonitoring = typeof simperMonitoring.$inferSelect;\nexport type InsertSimperMonitoring = z.infer<typeof insertSimperMonitoringSchema>;\n\n// Authentication types\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\n\n\n// ============================================\n// SIDAK FATIGUE (Pengecekan Kelelahan)\n// ============================================\n\nexport const sidakFatigueSessions = pgTable(\"sidak_fatigue_sessions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tanggal: text(\"tanggal\").notNull(), // Format: YYYY-MM-DD\n  shift: text(\"shift\").notNull(), // \"Shift 1\" or \"Shift 2\"\n  waktuMulai: text(\"waktu_mulai\").notNull(), // Format: HH:MM\n  waktuSelesai: text(\"waktu_selesai\").notNull(), // Format: HH:MM\n  lokasi: text(\"lokasi\").notNull(),\n  area: text(\"area\").notNull(),\n  departemen: text(\"departemen\").notNull(),\n  totalSampel: integer(\"total_sampel\").notNull().default(0), // Auto calculated from records\n  createdBy: varchar(\"created_by\"), // NIK of supervisor who created the SIDAK\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_fatigue_sessions_created_by\").on(table.createdBy),\n]);\n\nexport const sidakFatigueRecords = pgTable(\"sidak_fatigue_records\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").notNull().references(() => sidakFatigueSessions.id, { onDelete: \"cascade\" }),\n  employeeId: varchar(\"employee_id\").references(() => employees.id), // Optional, nullable for flexibility\n  ordinal: integer(\"ordinal\").notNull(), // Sequence 1..10, enforces max limit via unique constraint\n  nama: text(\"nama\").notNull(),\n  nik: text(\"nik\").notNull(),\n  jabatan: text(\"jabatan\").notNull(),\n  nomorLambung: text(\"nomor_lambung\"),\n  \n  // Data pengecekan\n  jamTidur: integer(\"jam_tidur\").notNull(), // Jam tidur sebelum bekerja (angka)\n  konsumiObat: boolean(\"konsumsi_obat\").notNull().default(false), // true = Ya/âœ“, false = Tidak/âœ—\n  masalahPribadi: boolean(\"masalah_pribadi\").notNull().default(false), // true = Ya/âœ“, false = Tidak/âœ—\n  \n  // Pemeriksaan (true = Ya/âœ“, false = Tidak/âœ—)\n  pemeriksaanRespon: boolean(\"pemeriksaan_respon\").notNull().default(true),\n  pemeriksaanKonsentrasi: boolean(\"pemeriksaan_konsentrasi\").notNull().default(true),\n  pemeriksaanKesehatan: boolean(\"pemeriksaan_kesehatan\").notNull().default(true),\n  \n  // Rekomendasi (true = Ya/âœ“, false = Tidak/âœ—)\n  karyawanSiapBekerja: boolean(\"karyawan_siap_bekerja\").notNull().default(true),\n  fitUntukBekerja: boolean(\"fit_untuk_bekerja\").notNull().default(true),\n  istirahatDanMonitor: boolean(\"istirahat_dan_monitor\").notNull().default(false),\n  istirahatLebihdariSatuJam: boolean(\"istirahat_lebih_dari_satu_jam\").notNull().default(false),\n  tidakBolehBekerja: boolean(\"tidak_boleh_bekerja\").notNull().default(false),\n  \n  // Tanda tangan karyawan\n  employeeSignature: text(\"employee_signature\"), // Base64 encoded signature image\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_fatigue_records_session\").on(table.sessionId),\n  index(\"IDX_fatigue_records_employee\").on(table.employeeId),\n  uniqueIndex(\"sidak_fatigue_session_ordinal_unique\").on(table.sessionId, table.ordinal),\n]);\n\nexport const sidakFatigueObservers = pgTable(\"sidak_fatigue_observers\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").notNull().references(() => sidakFatigueSessions.id, { onDelete: \"cascade\" }),\n  nama: text(\"nama\").notNull(),\n  nik: text(\"nik\").notNull(),\n  perusahaan: text(\"perusahaan\").notNull(),\n  jabatan: text(\"jabatan\").notNull(),\n  signatureDataUrl: text(\"signature_data_url\").notNull(), // Base64 encoded signature image\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_fatigue_observers_session\").on(table.sessionId),\n]);\n\n\n// ============================================\n// SIDAK ROSTER (Kesesuaian Gilir Kerja)\n// ============================================\n\nexport const sidakRosterSessions = pgTable(\"sidak_roster_sessions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tanggalPelaksanaan: text(\"tanggal_pelaksanaan\").notNull(), // Format: YYYY-MM-DD\n  jamPelaksanaan: text(\"jam_pelaksanaan\").notNull(), // Format: HH:MM\n  shift: text(\"shift\").notNull(), // \"Shift 1\" or \"Shift 2\"\n  perusahaan: text(\"perusahaan\").notNull(),\n  departemen: text(\"departemen\").notNull(),\n  lokasi: text(\"lokasi\").notNull(),\n  totalSampel: integer(\"total_sampel\").notNull().default(0), // Auto calculated from records\n  createdBy: varchar(\"created_by\"), // NIK of supervisor who created the SIDAK\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_roster_sessions_created_by\").on(table.createdBy),\n]);\n\nexport const sidakRosterRecords = pgTable(\"sidak_roster_records\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").notNull().references(() => sidakRosterSessions.id, { onDelete: \"cascade\" }),\n  employeeId: varchar(\"employee_id\").references(() => employees.id), // Optional, nullable for flexibility\n  ordinal: integer(\"ordinal\").notNull(), // Sequence 1..15, enforces max limit via unique constraint\n  nama: text(\"nama\").notNull(),\n  nik: text(\"nik\").notNull(),\n  nomorLambung: text(\"nomor_lambung\"),\n  \n  // Kesesuaian roster\n  rosterSesuai: boolean(\"roster_sesuai\").notNull(), // true = Ya/âœ“, false = Tidak/âœ—\n  keterangan: text(\"keterangan\"), // Optional notes\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_roster_records_session\").on(table.sessionId),\n  index(\"IDX_roster_records_employee\").on(table.employeeId),\n  uniqueIndex(\"sidak_roster_session_ordinal_unique\").on(table.sessionId, table.ordinal),\n]);\n\nexport const sidakRosterObservers = pgTable(\"sidak_roster_observers\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").notNull().references(() => sidakRosterSessions.id, { onDelete: \"cascade\" }),\n  nama: text(\"nama\").notNull(),\n  nik: text(\"nik\").notNull(),\n  perusahaan: text(\"perusahaan\").notNull(),\n  jabatan: text(\"jabatan\").notNull(),\n  signatureDataUrl: text(\"signature_data_url\").notNull(), // Base64 encoded signature image\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_roster_observers_session\").on(table.sessionId),\n]);\n\n\n// ============================================\n// INSERT SCHEMAS & TYPES - SIDAK FATIGUE\n// ============================================\n\nexport const insertSidakFatigueSessionSchema = createInsertSchema(sidakFatigueSessions).omit({\n  id: true,\n  createdAt: true,\n  totalSampel: true, // Auto calculated\n});\n\nexport const insertSidakFatigueRecordSchema = createInsertSchema(sidakFatigueRecords).omit({\n  id: true,\n  ordinal: true, // Auto-generated sequence\n  createdAt: true,\n});\n\nexport const insertSidakFatigueObserverSchema = createInsertSchema(sidakFatigueObservers).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type SidakFatigueSession = typeof sidakFatigueSessions.$inferSelect;\nexport type InsertSidakFatigueSession = z.infer<typeof insertSidakFatigueSessionSchema>;\nexport type SidakFatigueRecord = typeof sidakFatigueRecords.$inferSelect;\nexport type InsertSidakFatigueRecord = z.infer<typeof insertSidakFatigueRecordSchema>;\nexport type SidakFatigueObserver = typeof sidakFatigueObservers.$inferSelect;\nexport type InsertSidakFatigueObserver = z.infer<typeof insertSidakFatigueObserverSchema>;\n\n\n// ============================================\n// INSERT SCHEMAS & TYPES - SIDAK ROSTER\n// ============================================\n\nexport const insertSidakRosterSessionSchema = createInsertSchema(sidakRosterSessions).omit({\n  id: true,\n  createdAt: true,\n  totalSampel: true, // Auto calculated\n});\n\nexport const insertSidakRosterRecordSchema = createInsertSchema(sidakRosterRecords).omit({\n  id: true,\n  ordinal: true, // Auto-generated sequence\n  createdAt: true,\n});\n\nexport const insertSidakRosterObserverSchema = createInsertSchema(sidakRosterObservers).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type SidakRosterSession = typeof sidakRosterSessions.$inferSelect;\nexport type InsertSidakRosterSession = z.infer<typeof insertSidakRosterSessionSchema>;\nexport type SidakRosterRecord = typeof sidakRosterRecords.$inferSelect;\nexport type InsertSidakRosterRecord = z.infer<typeof insertSidakRosterRecordSchema>;\nexport type SidakRosterObserver = typeof sidakRosterObservers.$inferSelect;\nexport type InsertSidakRosterObserver = z.infer<typeof insertSidakRosterObserverSchema>;\n\n\n// ============================================\n// AUTHENTICATION - AUTH USERS\n// ============================================\n\nexport const insertAuthUserSchema = createInsertSchema(authUsers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type AuthUser = typeof authUsers.$inferSelect;\nexport type InsertAuthUser = z.infer<typeof insertAuthUserSchema>;\n\n// Login validation schema\nexport const loginSchema = z.object({\n  nik: z.string().min(1, \"NIK is required\"),\n  password: z.string().min(1, \"Password is required\"),\n});\n\nexport type LoginInput = z.infer<typeof loginSchema>;\n\n// Password reset validation schema\nexport const resetPasswordSchema = z.object({\n  oldPassword: z.string().min(1, \"Old password is required\"),\n  newPassword: z.string().min(8, \"Password must be at least 8 characters\"),\n  confirmPassword: z.string().min(1, \"Please confirm your password\"),\n}).refine((data) => data.newPassword === data.confirmPassword, {\n  message: \"Passwords don't match\",\n  path: [\"confirmPassword\"],\n});\n\nexport type ResetPasswordInput = z.infer<typeof resetPasswordSchema>;\n\n\n// ============================================\n// ANNOUNCEMENTS (Pengumuman untuk Driver)\n// ============================================\n\nexport const announcements = pgTable(\"announcements\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  content: text(\"content\").notNull(),\n  imageUrls: text(\"image_urls\").array(), // Array URL gambar lampiran (multiple images)\n  createdBy: varchar(\"created_by\").notNull(), // NIK admin yang membuat\n  createdByName: text(\"created_by_name\").notNull(), // Nama admin yang membuat\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_announcements_created_at\").on(table.createdAt),\n  index(\"IDX_announcements_is_active\").on(table.isActive),\n]);\n\nexport const announcementReads = pgTable(\"announcement_reads\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  announcementId: varchar(\"announcement_id\").notNull().references(() => announcements.id, { onDelete: \"cascade\" }),\n  employeeId: varchar(\"employee_id\").notNull().references(() => employees.id),\n  employeeName: text(\"employee_name\").notNull(), // Nama driver yang membaca\n  readAt: timestamp(\"read_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_announcement_reads_announcement\").on(table.announcementId),\n  index(\"IDX_announcement_reads_employee\").on(table.employeeId),\n  uniqueIndex(\"announcement_reads_unique\").on(table.announcementId, table.employeeId),\n]);\n\nexport const insertAnnouncementSchema = createInsertSchema(announcements).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertAnnouncementReadSchema = createInsertSchema(announcementReads).omit({\n  id: true,\n  readAt: true,\n});\n\nexport type Announcement = typeof announcements.$inferSelect;\nexport type InsertAnnouncement = z.infer<typeof insertAnnouncementSchema>;\nexport type AnnouncementRead = typeof announcementReads.$inferSelect;\nexport type InsertAnnouncementRead = z.infer<typeof insertAnnouncementReadSchema>;\n\n// ============================================\n// DOCUMENT MANAGEMENT TABLES\n// Dokumen perusahaan: Kebijakan KPLH, Prosedur, SPDK, Zero Harm, Critical Control Card, Golden Rule\n// ============================================\n\nexport const documentCategories = [\n  \"Kebijakan KPLH\",\n  \"Prosedur - Dept HSE\",\n  \"Prosedur - Dept Opr\",\n  \"Prosedur - Dept Plant\",\n  \"SPDK\",\n  \"Zero Harm\",\n  \"Critical Control Card\",\n  \"Golden Rule\",\n] as const;\n\nexport type DocumentCategory = typeof documentCategories[number];\n\nexport const documents = pgTable(\"documents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  category: text(\"category\").notNull(), // One of documentCategories\n  fileName: text(\"file_name\").notNull(), // Original file name\n  filePath: text(\"file_path\").notNull(), // Path to stored PDF file\n  fileSize: integer(\"file_size\"), // File size in bytes\n  uploadedBy: varchar(\"uploaded_by\").notNull(), // NIK admin who uploaded\n  uploadedByName: text(\"uploaded_by_name\").notNull(), // Name of admin who uploaded\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_documents_category\").on(table.category),\n  index(\"IDX_documents_created_at\").on(table.createdAt),\n  index(\"IDX_documents_is_active\").on(table.isActive),\n]);\n\nexport const insertDocumentSchema = createInsertSchema(documents).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type Document = typeof documents.$inferSelect;\nexport type InsertDocument = z.infer<typeof insertDocumentSchema>;\n\n// ============================================\n// NEWS (Berita untuk semua karyawan)\n// ============================================\n\nexport const news = pgTable(\"news\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  content: text(\"content\").notNull(),\n  imageUrl: text(\"image_url\"), // URL gambar berita (legacy, untuk backward compatibility)\n  imageUrls: text(\"image_urls\").array(), // Array URL gambar (multiple images)\n  isImportant: boolean(\"is_important\").notNull().default(false), // Berita penting\n  createdBy: varchar(\"created_by\").notNull(), // NIK admin yang membuat\n  createdByName: text(\"created_by_name\").notNull(), // Nama admin yang membuat\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_news_created_at\").on(table.createdAt),\n  index(\"IDX_news_is_active\").on(table.isActive),\n  index(\"IDX_news_is_important\").on(table.isImportant),\n]);\n\nexport const insertNewsSchema = createInsertSchema(news).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type News = typeof news.$inferSelect;\nexport type InsertNews = z.infer<typeof insertNewsSchema>;\n\n// ============================================\n// PUSH NOTIFICATIONS\n// ============================================\n\nexport const pushSubscriptions = pgTable(\"push_subscriptions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  employeeId: varchar(\"employee_id\").notNull().references(() => employees.id),\n  endpoint: text(\"endpoint\").notNull(),\n  p256dh: text(\"p256dh\").notNull(), // Public key\n  auth: text(\"auth\").notNull(), // Auth secret\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"IDX_push_subscriptions_employee\").on(table.employeeId),\n  index(\"IDX_push_subscriptions_is_active\").on(table.isActive),\n  uniqueIndex(\"push_subscriptions_endpoint_unique\").on(table.endpoint),\n]);\n\nexport const insertPushSubscriptionSchema = createInsertSchema(pushSubscriptions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type PushSubscription = typeof pushSubscriptions.$inferSelect;\nexport type InsertPushSubscription = z.infer<typeof insertPushSubscriptionSchema>;\n\n","path":null,"size_bytes":30553,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/hooks/useAuth.ts":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { type User } from \"@shared/schema\";\n\nexport function useAuth() {\n  const { data: user, isLoading } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n  });\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n  };\n}","path":null,"size_bytes":306,"size_tokens":null},"client/src/pages/leave-roster-monitoring.tsx":{"content":"import React, { useState, useEffect, useMemo, useCallback, memo } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { format, addDays, differenceInDays, parseISO } from \"date-fns\";\nimport { id } from \"date-fns/locale\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { \n  Calendar, \n  Filter, \n  Plus, \n  Trash2, \n  Edit, \n  Download,\n  Upload,\n  Users,\n  Clock,\n  TrendingUp,\n  AlertTriangle\n} from \"lucide-react\";\nimport { Bar, Line } from \"react-chartjs-2\";\nimport {\n  Chart as ChartJS,\n  CategoryScale,\n  LinearScale,\n  BarElement,\n  LineElement,\n  PointElement,\n  Title,\n  Tooltip,\n  Legend,\n  Filler,\n} from \"chart.js\";\nimport * as XLSX from 'xlsx';\n\nChartJS.register(\n  CategoryScale,\n  LinearScale,\n  BarElement,\n  LineElement,\n  PointElement,\n  Title,\n  Tooltip,\n  Legend,\n  Filler\n);\n\ninterface LeaveRosterMonitoring {\n  id: string;\n  nik: string;\n  name: string;\n  nomorLambung: string | null;\n  month?: string; // Optional month field\n  investorGroup: string;\n  lastLeaveDate: string | null;\n  leaveOption: string; // \"70\" atau \"35\"\n  monitoringDays: number;\n  nextLeaveDate: string | null;\n  onSite?: string | null; // Optional onSite field\n  status: string; // Aktif, Menunggu Cuti, Sedang Cuti, Selesai Cuti\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface Employee {\n  id: string;\n  name: string;\n  investorGroup: string | null;\n}\n\nconst statusColors = {\n  \"Aktif\": \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200\",\n  \"Menunggu Cuti\": \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200\",\n  \"Sedang Cuti\": \"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200\",\n  \"Selesai Cuti\": \"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200\"\n};\n\nexport default function LeaveRosterMonitoringPage() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  // States for filters\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n  const [investorGroupFilter, setInvestorGroupFilter] = useState(\"all\");\n  const [leaveOptionFilter, setLeaveOptionFilter] = useState(\"all\");\n  const [dateRangeFilter, setDateRangeFilter] = useState(\"all\");\n  \n  // States for add/edit dialog\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingItem, setEditingItem] = useState<LeaveRosterMonitoring | null>(null);\n  \n  // States for Excel upload\n  const [isUploadDialogOpen, setIsUploadDialogOpen] = useState(false);\n  const [uploadFile, setUploadFile] = useState<File | null>(null);\n  const [uploadProgress, setUploadProgress] = useState(0);\n  const [formData, setFormData] = useState({\n    nik: \"\",\n    name: \"\",\n    nomorLambung: \"\",\n    month: new Date().toISOString().slice(0, 7), // Default: current month\n    investorGroup: \"\",\n    lastLeaveDate: \"\",\n    leaveOption: \"70\", // default 70 hari kerja\n    nextLeaveDate: \"\",\n    onSite: \"\",\n    status: \"Aktif\"\n  });\n\n  // Fetch leave roster monitoring data with optimized caching\n  const { data: monitoringData = [], isLoading, refetch } = useQuery<LeaveRosterMonitoring[]>({\n    queryKey: [\"/api/leave-roster-monitoring\"],\n    staleTime: 120000, // 2 minutes cache\n    refetchInterval: 300000, // Auto-refresh every 5 minutes instead of 30 seconds\n    refetchOnWindowFocus: true, // Only refetch when user returns to tab\n  });\n\n  // Fetch employees for dropdown with longer cache\n  const { data: employees = [] } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n    staleTime: 600000, // 10 minutes cache\n    refetchInterval: false, // Disable auto-refresh, only manual or on focus\n    refetchOnWindowFocus: false, // Employees don't change often\n  });\n\n  // Create monitoring entry\n  const createMutation = useMutation({\n    mutationFn: (data: any) => \n      apiRequest(\"/api/leave-roster-monitoring\", \"POST\", data),\n    onSuccess: () => {\n      toast({\n        title: \"Berhasil\",\n        description: \"Data monitoring roster cuti berhasil ditambahkan\",\n      });\n      setIsDialogOpen(false);\n      resetForm();\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-roster-monitoring\"] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Gagal\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update monitoring entry\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(`/api/leave-roster-monitoring/${id}`, \"PUT\", data),\n    onSuccess: () => {\n      toast({\n        title: \"Berhasil\",\n        description: \"Data monitoring roster cuti berhasil diperbarui\",\n      });\n      setIsDialogOpen(false);\n      resetForm();\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-roster-monitoring\"] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Gagal\", \n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete monitoring entry\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => \n      apiRequest(`/api/leave-roster-monitoring/${id}`, \"DELETE\"),\n    onSuccess: () => {\n      toast({\n        title: \"Berhasil\",\n        description: \"Data monitoring roster cuti berhasil dihapus\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-roster-monitoring\"] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Gagal\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update status automatically\n  const updateStatusMutation = useMutation({\n    mutationFn: () => apiRequest(\"/api/leave-roster-monitoring/update-status\", \"POST\"),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-roster-monitoring\"] });\n    },\n  });\n\n  // Excel upload mutation\n  const uploadExcelMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      \n      const response = await fetch(\"/api/leave-roster-monitoring/upload-excel\", {\n        method: \"POST\",\n        body: formData,\n      });\n      \n      if (!response.ok) {\n        throw new Error(\"Upload failed\");\n      }\n      \n      return response.json();\n    },\n    onSuccess: (result) => {\n      toast({\n        title: \"Upload Berhasil\",\n        description: `${result.success} data berhasil diupload, ${result.errors?.length || 0} error`,\n      });\n      setIsUploadDialogOpen(false);\n      setUploadFile(null);\n      setUploadProgress(0);\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-roster-monitoring\"] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Upload Gagal\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      setUploadProgress(0);\n    },\n  });\n\n  // Clear all data mutation\n  const deleteAllMutation = useMutation({\n    mutationFn: () => apiRequest(\"/api/leave-roster-monitoring/clear-all\", \"DELETE\"),\n    onSuccess: () => {\n      toast({\n        title: \"Berhasil\",\n        description: \"Semua data monitoring roster cuti berhasil dihapus\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-roster-monitoring\"] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Gagal\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Auto-update status every minute\n  useEffect(() => {\n    const interval = setInterval(() => {\n      updateStatusMutation.mutate();\n    }, 60000); // 1 minute\n\n    return () => clearInterval(interval);\n  }, [updateStatusMutation]);\n\n  // Calculate next leave date based on leave option\n  const calculateNextLeaveDate = (lastLeaveDate: string, leaveOption: string) => {\n    if (!lastLeaveDate) return \"\";\n    \n    const workDays = leaveOption === \"70\" ? 70 : 35;\n    const lastDate = parseISO(lastLeaveDate);\n    const nextDate = addDays(lastDate, workDays);\n    return format(nextDate, \"yyyy-MM-dd\");\n  };\n\n  // Calculate monitoring days\n  const calculateMonitoringDays = (lastLeaveDate: string) => {\n    if (!lastLeaveDate) return 0;\n    \n    const lastDate = parseISO(lastLeaveDate);\n    const today = new Date();\n    return differenceInDays(today, lastDate);\n  };\n\n  // Reset form\n  const resetForm = () => {\n    setFormData({\n      nik: \"\",\n      name: \"\",\n      nomorLambung: \"\",\n      month: new Date().toISOString().slice(0, 7), // Default: current month\n      investorGroup: \"\",\n      lastLeaveDate: \"\",\n      leaveOption: \"70\",\n      nextLeaveDate: \"\",\n      onSite: \"\",\n      status: \"Aktif\"\n    });\n    setEditingItem(null);\n  };\n\n  // Handle form submission\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.nik || !formData.name || !formData.investorGroup) {\n      toast({\n        title: \"Error\",\n        description: \"NIK, Nama, dan Investor Group harus diisi\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Calculate monitoring days and auto-determine status\n    const monitoringDays = formData.lastLeaveDate ? \n      calculateMonitoringDays(formData.lastLeaveDate) : 0;\n    \n    const workDaysThreshold = formData.leaveOption === \"70\" ? 70 : 35;\n    let autoStatus = \"Aktif\";\n    \n    // Auto determine status based on monitoring days\n    if (monitoringDays >= workDaysThreshold - 5 && monitoringDays < workDaysThreshold) {\n      autoStatus = \"Menunggu Cuti\";\n    } else if (monitoringDays >= workDaysThreshold) {\n      autoStatus = \"Menunggu Cuti\"; // Ready for leave\n    }\n\n    // Calculate next leave date and monitoring days\n    const processedData = {\n      ...formData,\n      status: autoStatus, // Use auto-calculated status\n      nextLeaveDate: formData.lastLeaveDate ? \n        calculateNextLeaveDate(formData.lastLeaveDate, formData.leaveOption) : undefined,\n      monitoringDays\n    };\n\n    if (editingItem) {\n      updateMutation.mutate({ \n        id: editingItem.id, \n        data: {\n          nik: processedData.nik,\n          name: processedData.name,\n          investorGroup: processedData.investorGroup,\n          lastLeaveDate: processedData.lastLeaveDate,\n          leaveOption: processedData.leaveOption,\n          status: processedData.status,\n          monitoringDays: processedData.monitoringDays,\n          nextLeaveDate: processedData.nextLeaveDate,\n          onSite: processedData.onSite\n        }\n      });\n    } else {\n      createMutation.mutate({\n        nik: processedData.nik,\n        name: processedData.name,\n        investorGroup: processedData.investorGroup,\n        lastLeaveDate: processedData.lastLeaveDate || \"\",\n        leaveOption: processedData.leaveOption,\n        status: processedData.status,\n        monitoringDays: processedData.monitoringDays,\n        nextLeaveDate: processedData.nextLeaveDate || \"\",\n        onSite: processedData.onSite || \"\"\n      });\n    }\n  };\n\n  // Handle edit\n  const handleEdit = (item: LeaveRosterMonitoring) => {\n    setEditingItem(item);\n    setFormData({\n      nik: item.nik,\n      name: item.name,\n      nomorLambung: item.nomorLambung || \"\",\n      month: (item as any).month || new Date().toISOString().slice(0, 7),\n      investorGroup: item.investorGroup,\n      lastLeaveDate: item.lastLeaveDate || \"\",\n      leaveOption: item.leaveOption,\n      nextLeaveDate: item.nextLeaveDate || \"\",\n      onSite: (item as any).onSite || \"\",\n      status: item.status\n    });\n    setIsDialogOpen(true);\n  };\n\n  // Handle employee selection\n  const handleEmployeeSelect = (employeeId: string) => {\n    const employee = employees.find(emp => emp.id === employeeId);\n    if (employee) {\n      setFormData(prev => ({\n        ...prev,\n        nik: employee.id,\n        name: employee.name,\n        investorGroup: employee.investorGroup || \"\"\n      }));\n    }\n  };\n\n  // Handle Excel file upload\n  const handleExcelUpload = () => {\n    if (!uploadFile) {\n      toast({\n        title: \"Error\",\n        description: \"Pilih file Excel terlebih dahulu\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setUploadProgress(25);\n    uploadExcelMutation.mutate(uploadFile);\n  };\n\n  // Download Excel template\n  const downloadTemplate = () => {\n    const currentMonth = new Date().toISOString().slice(0, 7); // \"YYYY-MM\"\n    const templateData = [\n      [\"NIK\", \"Nama\", \"Nomor Lambung\", \"Bulan\", \"Tanggal Terakhir Cuti\", \"Pilihan Cuti\", \"OnSite\", \"Investor Group\"],\n      [\"C-015001\", \"CONTOH NAMA 1\", \"GECL 001\", currentMonth, \"15/01/2024\", \"70\", \"Ya\", \"Bu Resty\"],\n      [\"C-025002\", \"CONTOH NAMA 2\", \"GECL 002\", currentMonth, \"20-02-2024\", \"35\", \"Tidak\", \"Group A\"],\n      [\"C-035003\", \"CONTOH NAMA 3\", \"SPARE\", currentMonth, \"2024-03-10\", \"70\", \"\", \"Group B\"],\n      [\"C-045004\", \"CONTOH NAMA 4\", \"GECL 004\", currentMonth, \"10/03/2024\", \"35\", \"Ya\", \"Group C\"],\n    ];\n\n    // Create Excel workbook\n    const workbook = XLSX.utils.book_new();\n    const worksheet = XLSX.utils.aoa_to_sheet(templateData);\n    \n    // Set column widths\n    const colWidths = [\n      { wch: 12 }, // NIK\n      { wch: 20 }, // Nama\n      { wch: 15 }, // Nomor Lambung\n      { wch: 12 }, // Bulan\n      { wch: 18 }, // Tanggal Terakhir Cuti\n      { wch: 12 }, // Pilihan Cuti\n      { wch: 8 },  // OnSite\n      { wch: 15 }  // Investor Group\n    ];\n    worksheet['!cols'] = colWidths;\n    \n    XLSX.utils.book_append_sheet(workbook, worksheet, \"Template Monitoring\");\n    \n    // Download Excel file\n    XLSX.writeFile(workbook, \"template_monitoring_roster_cuti.xlsx\");\n  };\n\n  // Filter data\n  const filteredData = monitoringData.filter((item) => {\n    const matchesSearch = \n      item.nik.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      item.name.toLowerCase().includes(searchTerm.toLowerCase());\n    \n    const matchesStatus = statusFilter === \"all\" || item.status === statusFilter;\n    const matchesInvestorGroup = investorGroupFilter === \"all\" || item.investorGroup === investorGroupFilter;\n    const matchesLeaveOption = leaveOptionFilter === \"all\" || item.leaveOption === leaveOptionFilter;\n    \n    return matchesSearch && matchesStatus && matchesInvestorGroup && matchesLeaveOption;\n  });\n\n  // Get unique investor groups for filter\n  const investorGroups = Array.from(new Set(monitoringData.map((item) => item.investorGroup)));\n\n  // Dashboard stats\n  const stats = {\n    total: monitoringData.length,\n    aktif: monitoringData.filter((item) => item.status === \"Aktif\").length,\n    menungguCuti: monitoringData.filter((item) => item.status === \"Menunggu Cuti\").length,\n    sedangCuti: monitoringData.filter((item) => item.status === \"Sedang Cuti\").length,\n    selesaiCuti: monitoringData.filter((item) => item.status === \"Selesai Cuti\").length,\n  };\n\n  // Chart data for status distribution\n  const statusChartData = {\n    labels: [\"Aktif\", \"Menunggu Cuti\", \"Sedang Cuti\", \"Selesai Cuti\"],\n    datasets: [\n      {\n        label: \"Jumlah Karyawan\",\n        data: [stats.aktif, stats.menungguCuti, stats.sedangCuti, stats.selesaiCuti],\n        backgroundColor: [\"#10b981\", \"#f59e0b\", \"#3b82f6\", \"#6b7280\"],\n        borderColor: [\"#059669\", \"#d97706\", \"#2563eb\", \"#4b5563\"],\n        borderWidth: 1,\n      },\n    ],\n  };\n\n  // Chart options\n  const chartOptions = {\n    responsive: true,\n    plugins: {\n      legend: {\n        position: \"top\" as const,\n      },\n      title: {\n        display: true,\n        text: \"Distribusi Status Monitoring Cuti\",\n      },\n    },\n  };\n\n  return (\n    <div className=\"container mx-auto p-4 space-y-6\" data-testid=\"leave-roster-monitoring-page\">\n      {/* Header */}\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-gray-900 dark:text-gray-100\">\n            Monitoring Roster Cuti\n          </h1>\n          <p className=\"text-gray-600 dark:text-gray-400\">\n            Sistem monitoring otomatis roster cuti karyawan berdasarkan siklus 70/35 hari kerja\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button \n            onClick={() => setIsDialogOpen(true)}\n            className=\"bg-red-600 hover:bg-red-700\"\n            data-testid=\"button-add-monitoring\"\n          >\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Tambah Monitoring\n          </Button>\n          <Button \n            onClick={() => setIsUploadDialogOpen(true)}\n            variant=\"outline\"\n            className=\"border-red-600 text-red-600 hover:bg-red-50\"\n            data-testid=\"button-upload-excel\"\n          >\n            <Upload className=\"h-4 w-4 mr-2\" />\n            Upload Excel\n          </Button>\n          <Button \n            onClick={downloadTemplate}\n            variant=\"outline\"\n            data-testid=\"button-download-template\"\n          >\n            <Download className=\"h-4 w-4 mr-2\" />\n            Template Sederhana\n          </Button>\n          <Button \n            onClick={() => {\n              if (window.confirm(\"Apakah Anda yakin ingin menghapus SEMUA data monitoring roster cuti? Tindakan ini tidak dapat dibatalkan.\")) {\n                deleteAllMutation.mutate();\n              }\n            }}\n            variant=\"destructive\"\n            disabled={deleteAllMutation.isPending}\n            data-testid=\"button-delete-all\"\n          >\n            <Trash2 className=\"h-4 w-4 mr-2\" />\n            {deleteAllMutation.isPending ? \"Menghapus...\" : \"Hapus Semua Data\"}\n          </Button>\n        </div>\n      </div>\n\n      {/* Dashboard Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Karyawan</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{stats.total}</div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Aktif</CardTitle>\n            <Clock className=\"h-4 w-4 text-green-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\">{stats.aktif}</div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Menunggu Cuti</CardTitle>\n            <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-yellow-600\">{stats.menungguCuti}</div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Sedang Cuti</CardTitle>\n            <Calendar className=\"h-4 w-4 text-blue-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-blue-600\">{stats.sedangCuti}</div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Selesai Cuti</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-gray-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-gray-600\">{stats.selesaiCuti}</div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Chart */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Dashboard Analitik</CardTitle>\n          <CardDescription>\n            Visualisasi distribusi status monitoring cuti karyawan\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"h-64\">\n            <Bar data={statusChartData} options={chartOptions} />\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Filter className=\"h-5 w-5\" />\n            Filter & Pencarian\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n            <div>\n              <Label>Cari NIK/Nama</Label>\n              <Input\n                placeholder=\"Cari NIK atau nama...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                data-testid=\"input-search\"\n              />\n            </div>\n            \n            <div>\n              <Label>Status</Label>\n              <Select value={statusFilter} onValueChange={setStatusFilter}>\n                <SelectTrigger data-testid=\"select-status-filter\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Semua Status</SelectItem>\n                  <SelectItem value=\"Aktif\">Aktif</SelectItem>\n                  <SelectItem value=\"Menunggu Cuti\">Menunggu Cuti</SelectItem>\n                  <SelectItem value=\"Sedang Cuti\">Sedang Cuti</SelectItem>\n                  <SelectItem value=\"Selesai Cuti\">Selesai Cuti</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label>Investor Group</Label>\n              <Select value={investorGroupFilter} onValueChange={setInvestorGroupFilter}>\n                <SelectTrigger data-testid=\"select-investor-group-filter\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Semua Investor Group</SelectItem>\n                  {investorGroups.map((group) => (\n                    <SelectItem key={group} value={group}>\n                      {group}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label>Pilihan Cuti</Label>\n              <Select value={leaveOptionFilter} onValueChange={setLeaveOptionFilter}>\n                <SelectTrigger data-testid=\"select-leave-option-filter\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Semua Pilihan</SelectItem>\n                  <SelectItem value=\"70\">70 Hari Kerja</SelectItem>\n                  <SelectItem value=\"35\">35 Hari Kerja</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"flex items-end\">\n              <Button \n                variant=\"outline\" \n                onClick={() => {\n                  setSearchTerm(\"\");\n                  setStatusFilter(\"all\");\n                  setInvestorGroupFilter(\"all\");\n                  setLeaveOptionFilter(\"all\");\n                }}\n                data-testid=\"button-clear-filters\"\n              >\n                Clear Filters\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Data Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Data Monitoring Roster Cuti</CardTitle>\n          <CardDescription>\n            Total: {filteredData.length} dari {monitoringData.length} karyawan\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600 mx-auto\"></div>\n              <p className=\"mt-2 text-gray-600\">Memuat data...</p>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>NIK</TableHead>\n                    <TableHead>Nama</TableHead>\n                    <TableHead>Nomor Lambung</TableHead>\n                    <TableHead>Bulan</TableHead>\n                    <TableHead>Investor Group</TableHead>\n                    <TableHead>Terakhir Cuti</TableHead>\n                    <TableHead>Pilihan Cuti</TableHead>\n                    <TableHead>Monitoring (Hari)</TableHead>\n                    <TableHead>OnSite</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Aksi</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredData.length === 0 ? (\n                    <TableRow>\n                      <TableCell colSpan={11} className=\"text-center py-8 text-gray-500\">\n                        Tidak ada data monitoring roster cuti\n                      </TableCell>\n                    </TableRow>\n                  ) : (\n                    filteredData.map((item) => {\n                      // Find employee data to get Nomor Lambung\n                      const employee = employees.find(emp => emp.id === item.nik);\n                      return (\n                        <TableRow key={item.id} data-testid={`row-monitoring-${item.nik}`}>\n                          <TableCell className=\"font-medium\">{item.nik}</TableCell>\n                          <TableCell>{item.name}</TableCell>\n                          <TableCell>\n                            {item.nomorLambung || (\n                              <span className=\"text-gray-400\">-</span>\n                            )}\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant=\"secondary\">\n                              {item.month || \"2024-08\"}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>{item.investorGroup}</TableCell>\n                          <TableCell>\n                            {item.lastLeaveDate ? \n                              format(parseISO(item.lastLeaveDate), \"dd/MM/yyyy\") : \n                              \"-\"\n                            }\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant=\"outline\">\n                              {item.leaveOption === \"70\" ? \"70 Hari Kerja\" : \"35 Hari Kerja\"}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>\n                            <span className=\"font-semibold\">\n                              {item.monitoringDays > 0 \n                                ? `${item.monitoringDays} hari lagi menuju cuti`\n                                : item.monitoringDays === 0 \n                                ? \"Hari ini adalah cuti\"\n                                : `${Math.abs(item.monitoringDays)} hari (sudah lewat ${Math.abs(item.monitoringDays)} hari dari cuti)`\n                              }\n                            </span>\n                            <div className=\"text-xs text-gray-500 mt-1\">\n                              Rumus: Terakhir Cuti - Today = {item.monitoringDays}\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            {item.onSite ? (\n                              <Badge variant={item.onSite === \"Ya\" ? \"default\" : \"secondary\"}>\n                                {item.onSite}\n                              </Badge>\n                            ) : (\n                              <span className=\"text-gray-400\">-</span>\n                            )}\n                          </TableCell>\n                          <TableCell>\n                            <Badge className={statusColors[item.status as keyof typeof statusColors]}>\n                              {item.status}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex gap-2\">\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={() => handleEdit(item)}\n                                data-testid={`button-edit-${item.nik}`}\n                              >\n                                <Edit className=\"h-3 w-3\" />\n                              </Button>\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={() => deleteMutation.mutate(item.id)}\n                                className=\"text-red-600 hover:bg-red-50\"\n                                data-testid={`button-delete-${item.nik}`}\n                              >\n                                <Trash2 className=\"h-3 w-3\" />\n                              </Button>\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })\n                  )}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Add/Edit Dialog */}\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>\n              {editingItem ? \"Edit Monitoring Roster Cuti\" : \"Tambah Monitoring Roster Cuti\"}\n            </DialogTitle>\n          </DialogHeader>\n          \n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div>\n              <Label>Pilih Karyawan</Label>\n              <Select value={formData.nik} onValueChange={handleEmployeeSelect}>\n                <SelectTrigger data-testid=\"select-employee\">\n                  <SelectValue placeholder=\"Pilih karyawan...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {employees.map((employee) => (\n                    <SelectItem key={employee.id} value={employee.id}>\n                      {employee.id} - {employee.name} ({employee.investorGroup})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label>NIK</Label>\n              <Input\n                value={formData.nik}\n                onChange={(e) => setFormData(prev => ({ ...prev, nik: e.target.value }))}\n                placeholder=\"NIK karyawan\"\n                required\n                data-testid=\"input-nik\"\n              />\n            </div>\n\n            <div>\n              <Label>Nama</Label>\n              <Input\n                value={formData.name}\n                onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}\n                placeholder=\"Nama karyawan\"\n                required\n                data-testid=\"input-name\"\n              />\n            </div>\n\n            <div>\n              <Label>Nomor Lambung</Label>\n              <Input\n                value={formData.nomorLambung}\n                onChange={(e) => setFormData(prev => ({ ...prev, nomorLambung: e.target.value }))}\n                placeholder=\"Nomor lambung (opsional)\"\n                data-testid=\"input-nomor-lambung\"\n              />\n            </div>\n\n            <div>\n              <Label>Bulan Monitoring</Label>\n              <Input\n                type=\"month\"\n                value={formData.month}\n                onChange={(e) => setFormData(prev => ({ ...prev, month: e.target.value }))}\n                data-testid=\"input-month\"\n              />\n            </div>\n\n            <div>\n              <Label>Investor Group</Label>\n              <Input\n                value={formData.investorGroup}\n                onChange={(e) => setFormData(prev => ({ ...prev, investorGroup: e.target.value }))}\n                placeholder=\"Investor Group\"\n                required\n                data-testid=\"input-investor-group\"\n              />\n            </div>\n\n            <div>\n              <Label>Tanggal Terakhir Cuti</Label>\n              <Input\n                type=\"date\"\n                value={formData.lastLeaveDate}\n                onChange={(e) => setFormData(prev => ({ ...prev, lastLeaveDate: e.target.value }))}\n                data-testid=\"input-last-leave-date\"\n              />\n            </div>\n\n            <div>\n              <Label>Pilihan Cuti</Label>\n              <Select \n                value={formData.leaveOption} \n                onValueChange={(value) => setFormData(prev => ({ ...prev, leaveOption: value }))}\n              >\n                <SelectTrigger data-testid=\"select-leave-option\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"70\">70 Hari Kerja (14 hari cuti)</SelectItem>\n                  <SelectItem value=\"35\">35 Hari Kerja (7 hari cuti)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label>OnSite</Label>\n              <Select \n                value={formData.onSite || \"none\"} \n                onValueChange={(value) => setFormData(prev => ({ ...prev, onSite: value === \"none\" ? \"\" : value }))}\n              >\n                <SelectTrigger data-testid=\"select-onsite\">\n                  <SelectValue placeholder=\"Pilih status OnSite...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"none\">-- Tidak dipilih --</SelectItem>\n                  <SelectItem value=\"Ya\">Ya</SelectItem>\n                  <SelectItem value=\"Tidak\">Tidak</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label>Status (Otomatis berdasarkan monitoring hari)</Label>\n              <div className=\"p-2 bg-gray-50 dark:bg-gray-800 rounded border\">\n                {formData.lastLeaveDate ? (() => {\n                  const monitoringDays = calculateMonitoringDays(formData.lastLeaveDate);\n                  const workDaysThreshold = formData.leaveOption === \"70\" ? 70 : 35;\n                  let status = \"Aktif\";\n                  \n                  if (monitoringDays >= workDaysThreshold - 5 && monitoringDays < workDaysThreshold) {\n                    status = \"Menunggu Cuti\";\n                  } else if (monitoringDays >= workDaysThreshold) {\n                    status = \"Menunggu Cuti\";\n                  }\n                  \n                  return (\n                    <div className=\"text-sm\">\n                      <span className={`px-2 py-1 rounded ${statusColors[status as keyof typeof statusColors]}`}>\n                        {status}\n                      </span>\n                      <span className=\"ml-2 text-gray-600\">\n                        ({monitoringDays} hari dari {workDaysThreshold} hari kerja)\n                      </span>\n                    </div>\n                  );\n                })() : (\n                  <span className=\"text-gray-500 text-sm\">Pilih tanggal terakhir cuti untuk auto status</span>\n                )}\n              </div>\n            </div>\n\n            <div className=\"flex justify-end space-x-2\">\n              <Button \n                type=\"button\" \n                variant=\"outline\" \n                onClick={() => {\n                  setIsDialogOpen(false);\n                  resetForm();\n                }}\n                data-testid=\"button-cancel\"\n              >\n                Batal\n              </Button>\n              <Button \n                type=\"submit\" \n                className=\"bg-red-600 hover:bg-red-700\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-save\"\n              >\n                {createMutation.isPending || updateMutation.isPending ? \"Menyimpan...\" : \n                 editingItem ? \"Update\" : \"Simpan\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Excel Upload Dialog */}\n      <Dialog open={isUploadDialogOpen} onOpenChange={setIsUploadDialogOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Upload Excel Monitoring Roster Cuti</DialogTitle>\n          </DialogHeader>\n          \n          <div className=\"space-y-4\">\n            <div>\n              <Label>File Excel (.xlsx)</Label>\n              <Input\n                type=\"file\"\n                accept=\".xlsx,.xls\"\n                onChange={(e) => {\n                  const file = e.target.files?.[0];\n                  if (file) {\n                    setUploadFile(file);\n                    setUploadProgress(0);\n                  }\n                }}\n                data-testid=\"input-excel-file\"\n              />\n              {uploadFile && (\n                <p className=\"text-sm text-gray-600 mt-1\">\n                  File dipilih: {uploadFile.name}\n                </p>\n              )}\n            </div>\n\n            {uploadProgress > 0 && (\n              <div>\n                <Label>Progress Upload</Label>\n                <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                  <div \n                    className=\"bg-red-600 h-2 rounded-full transition-all duration-300\"\n                    style={{ width: `${uploadProgress}%` }}\n                  />\n                </div>\n                <p className=\"text-sm text-gray-600 mt-1\">{uploadProgress}%</p>\n              </div>\n            )}\n\n            <div className=\"bg-green-50 p-4 rounded-md\">\n              <p className=\"text-sm text-green-800\">\n                <strong>Format Excel dengan Bulan:</strong><br/>\n                â€¢ Kolom 1: <strong>NIK</strong> (wajib)<br/>\n                â€¢ Kolom 2: <strong>Nama</strong> (wajib)<br/>\n                â€¢ Kolom 3: <strong>Tanggal Terakhir Cuti</strong> (opsional, format: dd-mm-yyyy)<br/>\n                â€¢ Kolom 4: <strong>Pilihan Cuti</strong> (opsional, 70 atau 35, default: 70)<br/>\n                â€¢ Kolom 5: <strong>Bulan</strong> (opsional, format: YYYY-MM, default: bulan ini)<br/><br/>\n                \n                ðŸ“… <strong>Fitur Baru - Per Bulan:</strong><br/>\n                âœ“ Setiap NIK bisa ada di berbagai bulan<br/>\n                âœ“ Upload roster per bulan untuk tracking berkala<br/>\n                âœ“ Monitoring hari dan status per periode bulanan<br/><br/>\n                \n                <strong>OTOMATIS DIHITUNG:</strong><br/>\n                âœ“ Investor Group: Berdasarkan range NIK<br/>\n                âœ“ Monitoring Hari: Dari tanggal terakhir cuti<br/>\n                âœ“ Status: Berdasarkan threshold monitoring hari<br/>\n                âœ“ Tanggal Cuti Berikutnya: Auto calculate\n              </p>\n            </div>\n\n            <div className=\"flex justify-end space-x-2\">\n              <Button \n                type=\"button\" \n                variant=\"outline\" \n                onClick={() => {\n                  setIsUploadDialogOpen(false);\n                  setUploadFile(null);\n                  setUploadProgress(0);\n                }}\n                data-testid=\"button-cancel-upload\"\n              >\n                Batal\n              </Button>\n              <Button \n                onClick={handleExcelUpload}\n                className=\"bg-red-600 hover:bg-red-700\"\n                disabled={!uploadFile || uploadExcelMutation.isPending}\n                data-testid=\"button-start-upload\"\n              >\n                {uploadExcelMutation.isPending ? \"Mengupload...\" : \"Upload\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","path":null,"size_bytes":40537,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n:root {\n  --background: hsl(0 0% 100%);\n  --foreground: hsl(222.2 84% 4.9%);\n  --card: hsl(0 0% 100%);\n  --card-foreground: hsl(222.2 84% 4.9%);\n  --popover: hsl(0 0% 100%);\n  --popover-foreground: hsl(222.2 84% 4.9%);\n  --primary: hsl(4 100% 50%);\n  --primary-foreground: hsl(0 0% 100%);\n  --secondary: hsl(4 30% 96%);\n  --secondary-foreground: hsl(222.2 84% 4.9%);\n  --muted: hsl(4 30% 96%);\n  --muted-foreground: hsl(215.4 16.3% 46.9%);\n  --accent: hsl(4 30% 96%);\n  --accent-foreground: hsl(222.2 84% 4.9%);\n  --destructive: hsl(0 84.2% 60.2%);\n  --destructive-foreground: hsl(0 0% 100%);\n  --border: hsl(4 31.8% 91.4%);\n  --input: hsl(4 31.8% 91.4%);\n  --ring: hsl(4 100% 50%);\n  --chart-1: hsl(4 100% 50%);\n  --chart-2: hsl(142.1 76.2% 36.3%);\n  --chart-3: hsl(45.4 93.4% 47.5%);\n  --chart-4: hsl(142.1 70.6% 45.3%);\n  --chart-5: hsl(340.6 75% 50.7%);\n  --sidebar: hsl(0 0% 100%);\n  --sidebar-foreground: hsl(222.2 84% 4.9%);\n  --sidebar-primary: hsl(4 100% 50%);\n  --sidebar-primary-foreground: hsl(0 0% 100%);\n  --sidebar-accent: hsl(4 30% 96%);\n  --sidebar-accent-foreground: hsl(222.2 84% 4.9%);\n  --sidebar-border: hsl(4 31.8% 91.4%);\n  --sidebar-ring: hsl(4 100% 50%);\n  --font-sans: Inter, ui-sans-serif, system-ui;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: 0.5rem;\n}\n\n.dark {\n  --background: hsl(222.2 84% 4.9%);\n  --foreground: hsl(210 40% 98%);\n  --card: hsl(222.2 84% 4.9%);\n  --card-foreground: hsl(210 40% 98%);\n  --popover: hsl(222.2 84% 4.9%);\n  --popover-foreground: hsl(210 40% 98%);\n  --primary: hsl(4 85% 65%);\n  --primary-foreground: hsl(0 0% 100%);\n  --secondary: hsl(4 32.6% 17.5%);\n  --secondary-foreground: hsl(210 40% 98%);\n  --muted: hsl(4 32.6% 17.5%);\n  --muted-foreground: hsl(215 20.2% 65.1%);\n  --accent: hsl(4 32.6% 17.5%);\n  --accent-foreground: hsl(210 40% 98%);\n  --destructive: hsl(0 62.8% 30.6%);\n  --destructive-foreground: hsl(210 40% 98%);\n  --border: hsl(4 32.6% 17.5%);\n  --input: hsl(4 32.6% 17.5%);\n  --ring: hsl(4 76.3% 94.1%);\n  --chart-1: hsl(4 70% 50%);\n  --chart-2: hsl(160 60% 45%);\n  --chart-3: hsl(30 80% 55%);\n  --chart-4: hsl(280 65% 60%);\n  --chart-5: hsl(340 75% 55%);\n  --sidebar: hsl(222.2 84% 4.9%);\n  --sidebar-foreground: hsl(210 40% 98%);\n  --sidebar-primary: hsl(4 85% 65%);\n  --sidebar-primary-foreground: hsl(0 0% 100%);\n  --sidebar-accent: hsl(4 32.6% 17.5%);\n  --sidebar-accent-foreground: hsl(210 40% 98%);\n  --sidebar-border: hsl(4 32.6% 17.5%);\n  --sidebar-ring: hsl(4 85% 65%);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n  \n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n@layer components {\n  .nav-item {\n    @apply text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors;\n  }\n  \n  .nav-item.active {\n    @apply text-primary bg-primary-50 dark:bg-primary-700/20;\n  }\n  \n  .section {\n    @apply hidden;\n  }\n  \n  .section.active {\n    @apply block;\n  }\n  \n  .stats-card {\n    @apply bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 sm:p-6 border border-gray-200 dark:border-gray-700;\n  }\n  \n  .responsive-table-container {\n    @apply overflow-x-auto -mx-4 sm:mx-0 px-4 sm:px-0;\n  }\n  \n  .responsive-table {\n    @apply min-w-full;\n  }\n  \n  .responsive-table th,\n  .responsive-table td {\n    @apply whitespace-nowrap text-sm;\n  }\n  \n  .mobile-card {\n    @apply bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 border border-gray-200 dark:border-gray-700 mb-3;\n  }\n  \n  .mobile-card-header {\n    @apply flex justify-between items-start mb-3;\n  }\n  \n  .mobile-card-title {\n    @apply font-medium text-gray-900 dark:text-white;\n  }\n  \n  .mobile-card-row {\n    @apply flex justify-between py-1.5 text-sm border-b border-gray-100 dark:border-gray-700 last:border-0;\n  }\n  \n  .mobile-card-label {\n    @apply text-gray-500 dark:text-gray-400;\n  }\n  \n  .mobile-card-value {\n    @apply text-gray-900 dark:text-white font-medium text-right;\n  }\n  \n  .touch-action-button {\n    @apply min-h-[44px] min-w-[44px] flex items-center justify-center;\n  }\n  \n  .responsive-grid {\n    @apply grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4;\n  }\n  \n  .responsive-flex {\n    @apply flex flex-col sm:flex-row gap-3 sm:gap-4;\n  }\n  \n  .responsive-header {\n    @apply flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 mb-4;\n  }\n  \n  .responsive-actions {\n    @apply flex flex-wrap gap-2;\n  }\n  \n  .responsive-filter-group {\n    @apply flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto;\n  }\n  \n  .responsive-input {\n    @apply w-full sm:w-auto sm:min-w-[200px];\n  }\n  \n  .responsive-select {\n    @apply w-full sm:w-auto sm:min-w-[150px];\n  }\n  \n  .stats-icon {\n    @apply p-2 rounded-lg;\n  }\n  \n  .status-badge {\n    @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;\n  }\n  \n  .status-present {\n    @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200;\n  }\n  \n  .status-absent {\n    @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200;\n  }\n\n  .login-panel-enter {\n    animation: slideInFromRight 0.5s ease-in-out forwards;\n  }\n\n  .login-panel-exit {\n    animation: slideOutToLeft 0.5s ease-in-out forwards;\n  }\n\n  .reset-panel-enter {\n    animation: slideInFromRight 0.5s ease-in-out forwards;\n  }\n\n  .reset-panel-exit {\n    animation: slideOutToLeft 0.5s ease-in-out forwards;\n  }\n\n  @keyframes slideInFromRight {\n    from {\n      opacity: 0;\n      transform: translateX(100%);\n    }\n    to {\n      opacity: 1;\n      transform: translateX(0);\n    }\n  }\n\n  @keyframes slideOutToLeft {\n    from {\n      opacity: 1;\n      transform: translateX(0);\n    }\n    to {\n      opacity: 0;\n      transform: translateX(-100%);\n    }\n  }\n\n  @keyframes slideInFromLeft {\n    from {\n      opacity: 0;\n      transform: translateX(-100%);\n    }\n    to {\n      opacity: 1;\n      transform: translateX(0);\n    }\n  }\n\n  @keyframes slideOutToRight {\n    from {\n      opacity: 1;\n      transform: translateX(0);\n    }\n    to {\n      opacity: 0;\n      transform: translateX(100%);\n    }\n  }\n  \n  .status-leave {\n    @apply bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200;\n  }\n  \n  .status-pending {\n    @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200;\n  }\n  \n  .scrollbar-hide {\n    -ms-overflow-style: none;\n    scrollbar-width: none;\n  }\n  \n  .scrollbar-hide::-webkit-scrollbar {\n    display: none;\n  }\n\n  /* Bouncing loader animations */\n  @keyframes bounce-dot {\n    0%, 100% {\n      transform: translateY(0);\n    }\n    50% {\n      transform: translateY(-16px);\n    }\n  }\n\n  @keyframes shadow-pulse {\n    0%, 100% {\n      transform: scaleX(1);\n      opacity: 0.5;\n    }\n    50% {\n      transform: scaleX(0.6);\n      opacity: 0.2;\n    }\n  }\n\n  .animate-bounce-dot {\n    animation: bounce-dot 0.6s ease-in-out infinite;\n  }\n\n  .animate-shadow-pulse {\n    animation: shadow-pulse 0.6s ease-in-out infinite;\n  }\n}\n","path":null,"size_bytes":7035,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"server/leaveMonitoringService.ts":{"content":"import { DrizzleStorage } from './storage';\n// Leave monitoring service\nimport { format, differenceInDays, parseISO } from 'date-fns';\nimport { id as localeId } from 'date-fns/locale';\n\nexport interface LeaveReminder {\n  id: string;\n  employeeId: string;\n  employeeName: string;\n  employeePhone: string;\n  leaveStartDate: string;\n  leaveEndDate: string;\n  daysUntil: number;\n  reminderType: '7_days' | '3_days' | '1_day';\n  sent: boolean;\n  sentAt?: string;\n}\n\nexport class LeaveMonitoringService {\n  private storage: DrizzleStorage;\n\n  constructor(storage: DrizzleStorage) {\n    this.storage = storage;\n  }\n\n  async checkUpcomingLeaves(): Promise<LeaveReminder[]> {\n    try {\n      const today = new Date();\n      today.setHours(0, 0, 0, 0);\n\n      // Get all approved leave requests\n      const leaveRequests = await this.storage.getLeaveRequests();\n      const employees = await this.storage.getEmployees();\n      \n      const reminders: LeaveReminder[] = [];\n\n      for (const leave of leaveRequests) {\n        if (leave.status !== 'approved') continue;\n\n        const startDate = parseISO(leave.startDate);\n        const daysUntil = differenceInDays(startDate, today);\n\n        // Check if we need to send reminders (7, 3, or 1 day before)\n        if ([7, 3, 1].includes(daysUntil)) {\n          const employee = employees.find((emp: any) => emp.id === leave.employeeId);\n          if (!employee || !employee.phone) continue;\n\n          const reminderType = `${daysUntil}_days` as '7_days' | '3_days' | '1_day';\n          \n          // Check if reminder already sent\n          const existingReminder = await this.storage.getLeaveReminder(leave.id, reminderType);\n          \n          if (!existingReminder) {\n            reminders.push({\n              id: `${leave.id}_${reminderType}`,\n              employeeId: leave.employeeId,\n              employeeName: employee.name,\n              employeePhone: employee.phone,\n              leaveStartDate: leave.startDate,\n              leaveEndDate: leave.endDate,\n              daysUntil,\n              reminderType,\n              sent: false\n            });\n          }\n        }\n      }\n\n      return reminders;\n    } catch (error) {\n      console.error('Error checking upcoming leaves:', error);\n      return [];\n    }\n  }\n\n  async sendLeaveReminders(): Promise<{ sent: number; failed: number }> {\n    const reminders = await this.checkUpcomingLeaves();\n    let sent = 0;\n    let failed = 0;\n\n    console.log(`Found ${reminders.length} leave reminders to send`);\n\n    for (const reminder of reminders) {\n      try {\n        const formattedStartDate = format(parseISO(reminder.leaveStartDate), 'dd MMMM yyyy', { locale: localeId });\n        const formattedEndDate = format(parseISO(reminder.leaveEndDate), 'dd MMMM yyyy', { locale: localeId });\n        \n        // Message creation for reminder notifications\n        const message = `Pengingat Cuti: ${reminder.employeeName}, cuti Anda akan dimulai ${reminder.daysUntil} hari lagi (${formattedStartDate} - ${formattedEndDate})`;\n\n        // Reminder notification processing\n        const success = false; // Placeholder - integrate with notif.my.id if needed\n        // Send message disabled - placeholder for notif.my.id integration\n        \n        if (success) {\n          // Save reminder record\n          await this.storage.saveLeaveReminder({\n            id: reminder.id,\n            leaveRequestId: reminder.id.split('_')[0],\n            employeeId: reminder.employeeId,\n            reminderType: reminder.reminderType,\n            sentAt: new Date().toISOString(),\n            phoneNumber: reminder.employeePhone,\n            message\n          });\n          sent++;\n          console.log(`Reminder sent to ${reminder.employeeName} (${reminder.daysUntil} days)`);\n        } else {\n          failed++;\n          console.log(`Leave reminder for ${reminder.employeeName} - notification sent`);\n        }\n      } catch (error) {\n        console.error(`Error sending reminder to ${reminder.employeeName}:`, error);\n        failed++;\n      }\n    }\n\n    return { sent, failed };\n  }\n\n  async getLeaveReminderHistory(): Promise<any[]> {\n    return await this.storage.getLeaveReminders();\n  }\n}","path":null,"size_bytes":4193,"size_tokens":null},"client/src/lib/csv-utils.ts":{"content":"import type { AttendanceRecord, Employee, LeaveRequest } from '@shared/schema';\n\nexport function exportAttendanceToCSV(\n  attendance: AttendanceRecord[], \n  employees: Employee[]\n): void {\n  // Only export attendance records that exist (employees who scanned QR code)\n  const actualAttendance = attendance.filter(record => record.status === 'present');\n  \n  const headers = ['No', 'ID Karyawan', 'Nama', 'Nomor Lambung', 'Tanggal', 'Jam Masuk', 'Jam Tidur', 'Fit To Work', 'Status'];\n  \n  const csvData = [\n    headers,\n    ...actualAttendance.map((record, index) => {\n      const employee = employees.find(emp => emp.id === record.employeeId);\n      // Format nomor lambung untuk karyawan asli SPARE yang sudah update\n      const nomorLambung = employee?.isSpareOrigin && employee.nomorLambung !== \"SPARE\" ? \n        `SPARE ${employee.nomorLambung}` : (employee?.nomorLambung || '-');\n      \n      return [\n        (index + 1).toString(),\n        record.employeeId,\n        employee?.name || 'Unknown',\n        nomorLambung,\n        formatDateForCSV(record.date),\n        record.time,\n        record.jamTidur || '-',\n        record.fitToWork || 'Not Set',\n        'Hadir'\n      ];\n    })\n  ];\n  \n  downloadCSV(csvData, `absensi_${new Date().toISOString().split('T')[0]}.csv`);\n}\n\nexport function exportLeaveToCSV(\n  leaveRequests: LeaveRequest[], \n  employees: Employee[]\n): void {\n  const headers = ['No', 'ID Karyawan', 'Nama', 'Tanggal Mulai', 'Tanggal Selesai', 'Jenis Cuti', 'Status', 'Keterangan'];\n  \n  const csvData = [\n    headers,\n    ...leaveRequests.map((request, index) => {\n      const employee = employees.find(emp => emp.id === request.employeeId);\n      return [\n        (index + 1).toString(),\n        request.employeeId,\n        employee?.name || 'Unknown',\n        formatDateForCSV(request.startDate),\n        formatDateForCSV(request.endDate),\n        getLeaveTypeLabel(request.leaveType),\n        getLeaveStatusLabel(request.status),\n        request.reason || ''\n      ];\n    })\n  ];\n  \n  downloadCSV(csvData, `cuti_${new Date().toISOString().split('T')[0]}.csv`);\n}\n\nexport function exportEmployeesToCSV(employees: Employee[]): void {\n  const headers = ['No', 'ID Karyawan', 'Nama', 'No. WhatsApp', 'Position', 'Nomor Lambung', 'Department', 'Investor Group', 'Status'];\n  \n  const csvData = [\n    headers,\n    ...employees.map((employee, index) => {\n      // Format nomor lambung untuk karyawan asli SPARE yang sudah update\n      const nomorLambung = employee.isSpareOrigin && employee.nomorLambung !== \"SPARE\" ? \n        `SPARE ${employee.nomorLambung}` : (employee.nomorLambung || '-');\n      \n      return [\n        (index + 1).toString(),\n        employee.id,\n        employee.name,\n        employee.phone,\n        employee.position || '-',\n        nomorLambung,\n        employee.department || '-',\n        employee.investorGroup || '-',\n        employee.status === 'active' ? 'Aktif' : 'Tidak Aktif'\n      ];\n    })\n  ];\n  \n  downloadCSV(csvData, `karyawan_${new Date().toISOString().split('T')[0]}.csv`);\n}\n\nfunction downloadCSV(data: string[][], filename: string): void {\n  const csvContent = data.map(row => \n    row.map(cell => `\"${cell.toString().replace(/\"/g, '\"\"')}\"`).join(',')\n  ).join('\\n');\n  \n  const BOM = '\\uFEFF'; // UTF-8 BOM for proper Excel encoding\n  const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });\n  const url = window.URL.createObjectURL(blob);\n  \n  const link = document.createElement('a');\n  link.href = url;\n  link.download = filename;\n  link.click();\n  \n  window.URL.revokeObjectURL(url);\n}\n\nfunction formatDateForCSV(dateString: string): string {\n  const date = new Date(dateString + 'T00:00:00');\n  return date.toLocaleDateString('id-ID');\n}\n\nfunction getLeaveTypeLabel(type: string): string {\n  const types: { [key: string]: string } = {\n    'annual': 'Cuti Tahunan',\n    'sick': 'Cuti Sakit',\n    'personal': 'Cuti Pribadi',\n    'maternity': 'Cuti Melahirkan'\n  };\n  return types[type] || type;\n}\n\nfunction getLeaveStatusLabel(status: string): string {\n  const statuses: { [key: string]: string } = {\n    'pending': 'Menunggu',\n    'approved': 'Disetujui',\n    'rejected': 'Ditolak'\n  };\n  return statuses[status] || status;\n}\n\nfunction getShiftLabel(shift: string): string {\n  // Employee no longer has shift field - this function is deprecated\n  return shift || 'Tidak Ada';\n}\n","path":null,"size_bytes":4370,"size_tokens":null},"client/src/pages/leave.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem } from \"@/components/ui/command\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ObjectUploader } from \"@/components/ObjectUploader\";\nimport { PDFViewer } from '@/components/PDFViewer';\nimport type { UploadResult } from \"@uppy/core\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertLeaveRequestSchema } from \"@shared/schema\";\nimport type { Employee, LeaveRequest, InsertLeaveRequest } from \"@shared/schema\";\nimport { \n  CalendarDays, \n  Clock, \n  CheckCircle, \n  XCircle, \n  Eye, \n  User, \n  Phone,\n  Upload,\n  Download,\n  FileSpreadsheet,\n  AlertCircle,\n  Check,\n  ChevronsUpDown,\n  TrendingUp,\n  Users,\n  Calendar,\n  Target,\n  FileText,\n  BarChart3,\n  Building2,\n  Bell,\n  Send,\n  History,\n  MessageSquare,\n  Edit2,\n  Trash2\n} from \"lucide-react\";\nimport { z } from \"zod\";\nimport * as XLSX from \"xlsx\";\nimport { format, parseISO } from \"date-fns\";\nimport { id as localeId } from \"date-fns/locale\";\nimport { cn } from \"@/lib/utils\";\nimport {\n  Chart as ChartJS,\n  CategoryScale,\n  LinearScale,\n  BarElement,\n  Title,\n  Tooltip,\n  Legend,\n  ArcElement,\n  Filler,\n} from 'chart.js';\nimport { Bar, Doughnut } from 'react-chartjs-2';\n\nChartJS.register(\n  CategoryScale,\n  LinearScale,\n  BarElement,\n  Title,\n  Tooltip,\n  Legend,\n  ArcElement,\n  Filler\n);\n\nconst formSchema = insertLeaveRequestSchema.omit({ employeeName: true });\n\n// Types for upload roster\ninterface LeaveRosterData {\n  nik: string;\n  nama: string;\n  leaveType: string;\n  startDate: string;\n  endDate: string;\n  totalDays: number;\n  reason?: string;\n}\n\n// Types for analytics\ninterface LeaveAnalyticsOverview {\n  overview: {\n    totalEmployees: number;\n    totalLeaveRequests: number;\n    pendingRequests: number;\n    approvedRequests: number;\n    totalLeaveDaysTaken: number;\n    averageLeaveDays: number;\n  };\n  topLeaveEmployees: Array<{\n    employeeId: string;\n    employeeName: string;\n    usedDays: number;\n    remainingDays: number;\n    percentage: number;\n  }>;\n  monthlyLeaveData: Array<{\n    month: string;\n    requests: number;\n    totalDays: number;\n  }>;\n  leaveTypeDistribution: Record<string, number>;\n}\n\ninterface DepartmentStats {\n  department: string;\n  totalEmployees: number;\n  totalLeaveDays: number;\n  averageLeaveDays: number;\n  employees: Array<{\n    nik: string;\n    name: string;\n    position: string;\n    usedDays: number;\n    remainingDays: number;\n  }>;\n}\n\n// Types for monitoring\ninterface LeaveReminder {\n  id: string;\n  employeeId: string;\n  employeeName: string;\n  employeePhone: string;\n  leaveStartDate: string;\n  leaveEndDate: string;\n  daysUntil: number;\n  reminderType: '7_days' | '3_days' | '1_day';\n  sent: boolean;\n}\n\ninterface ReminderHistory {\n  id: string;\n  leaveRequestId: string;\n  employeeId: string;\n  reminderType: string;\n  sentAt: string;\n  phoneNumber: string;\n  message: string;\n}\n\n// Helper functions for status styling\nconst getStatusColor = (status: string): string => {\n  switch (status) {\n    case 'approved':\n      return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';\n    case 'rejected':\n      return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';\n    case 'pending':\n      return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';\n    case 'monitoring':\n      return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';\n    default:\n      return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';\n  }\n};\n\nconst getStatusText = (status: string): string => {\n  switch (status) {\n    case 'approved':\n      return 'Disetujui';\n    case 'rejected':\n      return 'Ditolak';\n    case 'pending':\n      return 'Menunggu';\n    case 'monitoring':\n      return 'Monitoring';\n    default:\n      return status;\n  }\n};\n\nexport default function Leave() {\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n  const [uploadedAttachmentPath, setUploadedAttachmentPath] = useState<string>(\"\");\n  const [isUploading, setIsUploading] = useState(false);\n  const [openCombobox, setOpenCombobox] = useState(false);\n  const [employeeSearchValue, setEmployeeSearchValue] = useState(\"\");\n  \n  // Search and filter states\n  const [searchName, setSearchName] = useState(\"\");\n  const [searchNIK, setSearchNIK] = useState(\"\");\n  \n  // HR PDF Upload states\n  const [hrUploadingFiles, setHrUploadingFiles] = useState<{[key: string]: boolean}>({});\n  const [hrUploadedFiles, setHrUploadedFiles] = useState<{[key: string]: string}>({});\n  \n  // PDF Upload states  \n  const [selectedPdfFile, setSelectedPdfFile] = useState<File | null>(null);\n  \n  // Action PDF Upload states\n  const [showActionDialog, setShowActionDialog] = useState(false);\n  const [actionType, setActionType] = useState<'approve' | 'reject' | null>(null);\n  const [actionRequestId, setActionRequestId] = useState<string>('');\n  const [actionPdfFile, setActionPdfFile] = useState<File | null>(null);\n  const [actionPdfUploading, setActionPdfUploading] = useState(false);\n  const [actionPdfPath, setActionPdfPath] = useState<string>('');\n  \n  // Upload Roster States\n  const [file, setFile] = useState<File | null>(null);\n  const [isUploadingRoster, setIsUploadingRoster] = useState(false);\n  const [uploadProgress, setUploadProgress] = useState(0);\n  const [uploadResults, setUploadResults] = useState<{ success: number; errors: string[] } | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  \n  // Analytics States\n  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());\n  \n  // Edit and Delete States\n  const [editingRequest, setEditingRequest] = useState<LeaveRequest | null>(null);\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [requestToDelete, setRequestToDelete] = useState<string | null>(null);\n  \n  const { toast } = useToast();\n\n  const { data: employees = [] } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  const { data: leaveRequests = [], isLoading } = useQuery<LeaveRequest[]>({\n    queryKey: [\"/api/leave\"],\n    refetchInterval: 30000, // Refresh every 30 seconds\n  });\n\n  // Analytics queries\n  const { data: analyticsData, isLoading: loadingAnalytics } = useQuery<LeaveAnalyticsOverview>({\n    queryKey: [\"/api/leave-analytics/overview\", selectedYear],\n    refetchInterval: 60000,\n  });\n\n  const { data: departmentData = [], isLoading: loadingDepartments } = useQuery<DepartmentStats[]>({\n    queryKey: [\"/api/leave-analytics/department\", selectedYear],\n    refetchInterval: 60000,\n  });\n\n  // Monitoring queries\n  const { data: upcomingLeaves = [], isLoading: loadingUpcoming } = useQuery<LeaveReminder[]>({\n    queryKey: [\"/api/leave-monitoring/upcoming\"],\n    refetchInterval: 30000,\n  });\n\n  const { data: reminderHistory = [], isLoading: loadingHistory } = useQuery<ReminderHistory[]>({\n    queryKey: [\"/api/leave-monitoring/history\"],\n    refetchInterval: 60000,\n  });\n\n  // Query for pending leave requests from monitoring\n  const { data: pendingFromMonitoring = [], isLoading: loadingPendingMonitoring } = useQuery({\n    queryKey: [\"/api/leave/pending-from-monitoring\"],\n    refetchInterval: 30000,\n  });\n\n  const form = useForm<z.infer<typeof formSchema>>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      employeeId: \"\",\n      phoneNumber: \"\",\n      startDate: \"\",\n      endDate: \"\",\n      leaveType: \"\",\n      reason: \"\",\n      status: \"pending\",\n    },\n  });\n\n  // Auto-fill nomor WhatsApp berdasarkan employee selection\n  const selectedEmployeeId = form.watch(\"employeeId\");\n  useEffect(() => {\n    if (selectedEmployeeId && employees.length > 0) {\n      const selectedEmployee = employees.find(emp => emp.id === selectedEmployeeId);\n      if (selectedEmployee) {\n        form.setValue(\"phoneNumber\", selectedEmployee.phone || \"\");\n      }\n    }\n  }, [selectedEmployeeId, employees, form]);\n\n  // Fill form when editing request is selected\n  useEffect(() => {\n    if (editingRequest) {\n      form.reset({\n        employeeId: editingRequest.employeeId,\n        phoneNumber: editingRequest.phoneNumber || \"\",\n        startDate: editingRequest.startDate,\n        endDate: editingRequest.endDate,\n        leaveType: editingRequest.leaveType,\n        reason: editingRequest.reason,\n        status: editingRequest.status,\n      });\n      setUploadedAttachmentPath(editingRequest.attachmentPath || \"\");\n    }\n  }, [editingRequest, form]);\n\n  const createMutation = useMutation({\n    mutationFn: (data: InsertLeaveRequest) => apiRequest(\"/api/leave\", \"POST\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave\"] });\n      form.reset();\n      setUploadedAttachmentPath(\"\");\n      setIsUploading(false);\n      toast({\n        title: \"Berhasil\",\n        description: \"Pengajuan cuti berhasil dibuat\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal membuat pengajuan cuti\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: ({ id, status, actionAttachment }: { id: string; status: string; actionAttachment?: string }) =>\n      apiRequest(`/api/leave/${id}`, \"PUT\", { status, actionAttachmentPath: actionAttachment }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave\"] });\n      toast({\n        title: \"Berhasil\",\n        description: \"Status cuti berhasil diperbarui\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal memperbarui status cuti\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation for processing leave from monitoring\n  const processMonitoringMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"/api/leave/process-from-monitoring\", \"POST\", data),\n    onSuccess: (data, variables) => {\n      toast({\n        title: \"Berhasil\",\n        description: variables.action === \"approve\" ? \"Cuti berhasil disetujui\" : \"Cuti berhasil ditolak\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave/pending-from-monitoring\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Gagal\",\n        description: error.message || \"Gagal memproses cuti\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Upload Roster mutation\n  const uploadMutation = useMutation({\n    mutationFn: async (data: LeaveRosterData[]): Promise<{ success: number; errors: string[] }> => {\n      const response = await apiRequest(\"/api/leave-roster/bulk-upload\", \"POST\", { leaveData: data });\n      return response;\n    },\n    onSuccess: (result: { success: number; errors: string[] }) => {\n      setUploadResults(result);\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave\"] });\n      \n      if (result.errors.length === 0) {\n        toast({\n          title: \"Upload Berhasil\",\n          description: `${result.success} data roster cuti berhasil diupload`,\n        });\n      } else {\n        toast({\n          title: \"Upload Selesai dengan Error\",\n          description: `${result.success} berhasil, ${result.errors.length} gagal`,\n          variant: \"destructive\",\n        });\n      }\n    },\n    onError: (error) => {\n      toast({\n        title: \"Upload Gagal\",\n        description: error instanceof Error ? error.message : \"Terjadi kesalahan saat upload\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Send reminders mutation\n  const sendRemindersMutation = useMutation({\n    mutationFn: () => fetch('/api/leave-monitoring/send-reminders', { method: 'POST' }).then(res => res.json()),\n    onSuccess: (data) => {\n      toast({\n        title: \"Pengingat Terkirim\",\n        description: `${data.sent} pengingat berhasil dikirim, ${data.failed} gagal`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-monitoring/upcoming\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave-monitoring/history\"] });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal mengirim pengingat cuti\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Update leave request mutation\n  const updateLeaveMutation = useMutation({\n    mutationFn: (data: { id: string; request: Partial<InsertLeaveRequest> }) => \n      apiRequest(`/api/leave/${data.id}`, \"PUT\", data.request),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave\"] });\n      setEditingRequest(null);\n      toast({\n        title: \"Berhasil\",\n        description: \"Data cuti berhasil diperbarui\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal memperbarui data cuti\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete leave request mutation\n  const deleteLeaveMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/leave/${id}`, \"DELETE\"),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave\"] });\n      setShowDeleteDialog(false);\n      setRequestToDelete(null);\n      toast({\n        title: \"Berhasil\",\n        description: \"Data cuti berhasil dihapus\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal menghapus data cuti\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = async (values: z.infer<typeof formSchema>) => {\n    const selectedEmployee = employees.find(emp => emp.id === values.employeeId);\n    if (!selectedEmployee) {\n      toast({\n        title: \"Error\",\n        description: \"Karyawan tidak ditemukan\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const submitData = {\n      ...values,\n      employeeName: selectedEmployee.name,\n      attachmentPath: uploadedAttachmentPath || undefined\n    };\n    createMutation.mutate(submitData);\n  };\n\n  const handleGetUploadParameters = async () => {\n    try {\n      setIsUploading(true);\n      const response = await apiRequest(\"/api/objects/upload\", \"POST\");\n      \n      const data = response;\n      return {\n        method: 'PUT' as const,\n        url: data.uploadURL,\n      };\n    } catch (error) {\n      setIsUploading(false);\n      toast({\n        title: \"Error\", \n        description: error instanceof Error ? error.message : \"Layanan upload tidak tersedia saat ini\",\n        variant: \"destructive\",\n      });\n      throw error;\n    }\n  };\n\n  const handleUploadComplete = async (result: UploadResult<Record<string, unknown>, Record<string, unknown>>) => {\n    setIsUploading(false);\n    if (result.successful && result.successful.length > 0) {\n      const uploadURL = result.successful[0].uploadURL;\n      if (uploadURL) {\n        try {\n          const normalizeResponse = await apiRequest(\"/api/objects/normalize\", \"POST\", {\n            uploadURL: uploadURL\n          });\n          const normalizeData = normalizeResponse;\n          const normalizedPath = normalizeData.objectPath;\n          setUploadedAttachmentPath(normalizedPath);\n          toast({\n            title: \"Berhasil\",\n            description: \"File PDF berhasil diupload\",\n          });\n        } catch (normalizeError) {\n          setUploadedAttachmentPath(uploadURL);\n          toast({\n            title: \"Berhasil\",\n            description: \"File PDF berhasil diupload\",\n          });\n        }\n      }\n    } else if (result.failed && result.failed.length > 0) {\n      toast({\n        title: \"Error\",\n        description: \"Gagal mengupload file PDF\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // PDF Upload handlers\n  const handlePdfFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file) {\n      // Validate PDF file\n      if (file.type !== 'application/pdf') {\n        toast({\n          title: \"Error\",\n          description: \"Hanya file PDF yang diperbolehkan\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      \n      // Check file size (max 5MB)\n      if (file.size > 5 * 1024 * 1024) {\n        toast({\n          title: \"Error\", \n          description: \"Ukuran file maksimal 5MB\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      \n      setSelectedPdfFile(file);\n    }\n  };\n\n  const handleUploadPdf = async () => {\n    if (!selectedPdfFile) return;\n    \n    setIsUploading(true);\n    const formData = new FormData();\n    formData.append('pdf', selectedPdfFile);\n    \n    try {\n      const response = await fetch('/api/upload-pdf', {\n        method: 'POST',\n        body: formData,\n      });\n      \n      if (!response.ok) {\n        throw new Error('Upload failed');\n      }\n      \n      const result = await response.json();\n      setUploadedAttachmentPath(result.fileName);\n      \n      toast({\n        title: \"Upload berhasil\",\n        description: \"PDF berhasil diupload\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Gagal upload PDF\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  // Action PDF Upload handlers\n  const handleActionPdfFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file) {\n      // Validate PDF file\n      if (file.type !== 'application/pdf') {\n        toast({\n          title: \"Error\",\n          description: \"Hanya file PDF yang diperbolehkan\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      \n      // Check file size (max 5MB)\n      if (file.size > 5 * 1024 * 1024) {\n        toast({\n          title: \"Error\", \n          description: \"Ukuran file maksimal 5MB\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      \n      setActionPdfFile(file);\n    }\n  };\n\n  const handleActionPdfUpload = async () => {\n    if (!actionPdfFile) return;\n    \n    setActionPdfUploading(true);\n    const formData = new FormData();\n    formData.append('pdf', actionPdfFile);\n    \n    try {\n      const response = await fetch('/api/upload-pdf', {\n        method: 'POST',\n        body: formData,\n      });\n      \n      if (!response.ok) {\n        throw new Error('Upload failed');\n      }\n      \n      const result = await response.json();\n      setActionPdfPath(result.fileName);\n      \n      toast({\n        title: \"Upload berhasil\",\n        description: \"PDF berhasil diupload\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Gagal upload PDF\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setActionPdfUploading(false);\n    }\n  };\n\n  const handleActionConfirm = () => {\n    if (actionType === 'approve') {\n      handleApproveWithPdf(actionRequestId, actionPdfPath || undefined);\n    } else if (actionType === 'reject') {\n      handleRejectWithPdf(actionRequestId, actionPdfPath || undefined);\n    }\n  };\n\n  const getEmployeeName = (employeeId: string) => {\n    return employees.find(emp => emp.id === employeeId)?.name || 'Unknown';\n  };\n\n  const getNomorLambung = (employeeId: string) => {\n    return employees.find(emp => emp.id === employeeId)?.nomorLambung || '-';\n  };\n\n  const getLeaveTypeLabel = (type: string) => {\n    const types: { [key: string]: string } = {\n      'annual': 'Cuti Tahunan',\n      'sick': 'Cuti Sakit',\n      'personal': 'Cuti Pribadi',\n      'maternity': 'Cuti Melahirkan'\n    };\n    return types[type] || type;\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'approved':\n        return <Badge className=\"status-present\">Disetujui</Badge>;\n      case 'rejected':\n        return <Badge className=\"status-absent\">Ditolak</Badge>;\n      default:\n        return <Badge className=\"status-pending\">Menunggu</Badge>;\n    }\n  };\n\n  const calculateDays = (startDate: string, endDate: string) => {\n    const start = new Date(startDate);\n    const end = new Date(endDate);\n    const diffTime = Math.abs(end.getTime() - start.getTime());\n    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;\n  };\n\n  const convertToProxyPath = (attachmentPath: string): string => {\n    if (!attachmentPath) return attachmentPath;\n    \n    // Handle local uploaded files (PDF from local uploads/pdf directory)\n    if (attachmentPath.startsWith('/uploads/pdf/') || attachmentPath.includes('/uploads/pdf/')) {\n      const filename = attachmentPath.split('/').pop();\n      return `/api/files/download/${filename}`;\n    }\n    \n    // Handle filename-only paths (from local /api/upload-pdf endpoint)\n    // Check if it's just a filename (no path separators and ends with .pdf)\n    if (!attachmentPath.includes('/') && attachmentPath.endsWith('.pdf')) {\n      return `/api/files/download/${attachmentPath}`;\n    }\n    \n    // Handle object storage files\n    if (attachmentPath.startsWith(\"https://storage.googleapis.com/\")) {\n      const url = new URL(attachmentPath);\n      const pathname = url.pathname;\n      \n      const uploadsIndex = pathname.indexOf(\"/.private/uploads/\");\n      if (uploadsIndex !== -1) {\n        const objectId = pathname.substring(uploadsIndex + \"/.private/uploads/\".length);\n        return `/objects/uploads/${objectId}`;\n      }\n    }\n    \n    return attachmentPath;\n  };\n\n  const filteredLeaveRequests = leaveRequests.filter(request => {\n    // Status filter\n    let statusMatch = false;\n    \n    if (statusFilter === \"all\") {\n      statusMatch = true;\n    } else if (statusFilter === \"overdue\") {\n      // Filter untuk yang lewat satu hari atau lebih menunggu cuti\n      const today = new Date();\n      const startDate = new Date(request.startDate);\n      const daysDiff = Math.floor((today.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));\n      statusMatch = request.status === \"pending\" && daysDiff >= 1;\n    } else {\n      statusMatch = request.status === statusFilter;\n    }\n    \n    // Comprehensive search (case insensitive) - search across multiple fields\n    let searchMatch = true;\n    if (searchName !== \"\") {\n      const searchTerm = searchName.toLowerCase();\n      const employeeName = getEmployeeName(request.employeeId).toLowerCase();\n      const employeeId = request.employeeId.toLowerCase();\n      const leaveType = getLeaveTypeLabel(request.leaveType).toLowerCase();\n      const reason = (request.reason || \"\").toLowerCase();\n      const startDate = new Date(request.startDate).toLocaleDateString('id-ID');\n      const endDate = new Date(request.endDate).toLocaleDateString('id-ID');\n      \n      searchMatch = employeeName.includes(searchTerm) ||\n                   employeeId.includes(searchTerm) ||\n                   leaveType.includes(searchTerm) ||\n                   reason.includes(searchTerm) ||\n                   startDate.includes(searchTerm) ||\n                   endDate.includes(searchTerm);\n    }\n    \n    return statusMatch && searchMatch;\n  });\n\n  const handleApprove = (id: string) => {\n    // Open action dialog for PDF upload\n    setActionType('approve');\n    setActionRequestId(id);\n    setActionPdfFile(null);\n    setActionPdfPath('');\n    setShowActionDialog(true);\n  };\n\n  const handleApproveWithPdf = (id: string, pdfPath?: string) => {\n    // Check if this is a monitoring request (starts with \"monitoring-\")\n    if (id.startsWith(\"monitoring-\")) {\n      // Extract the actual monitoring ID \n      const monitoringId = id.replace(\"monitoring-\", \"\");\n      \n      // Find the monitoring request data\n      const monitoringRequest = Array.isArray(pendingFromMonitoring) ? pendingFromMonitoring.find((req: any) => req.id === id) : undefined;\n      if (monitoringRequest) {\n        processMonitoringMutation.mutate({\n          monitoringId: monitoringId,\n          employeeId: monitoringRequest.employeeId,\n          employeeName: monitoringRequest.employeeName,\n          phoneNumber: monitoringRequest.phoneNumber || \"\",\n          startDate: monitoringRequest.startDate || new Date().toISOString().split('T')[0],\n          endDate: monitoringRequest.endDate || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // Default 7 days\n          leaveType: monitoringRequest.leaveType,\n          reason: monitoringRequest.reason,\n          attachmentPath: pdfPath || monitoringRequest.attachmentPath,\n          action: \"approve\"\n        });\n      }\n    } else {\n      // Regular leave request\n      updateStatusMutation.mutate({ \n        id, \n        status: 'approved',\n        actionAttachment: pdfPath \n      });\n    }\n    setShowActionDialog(false);\n  };\n\n  const handleReject = (id: string) => {\n    // Open action dialog for PDF upload\n    setActionType('reject');\n    setActionRequestId(id);\n    setActionPdfFile(null);\n    setActionPdfPath('');\n    setShowActionDialog(true);\n  };\n\n  const handleRejectWithPdf = (id: string, pdfPath?: string) => {\n    // Check if this is a monitoring request (starts with \"monitoring-\")\n    if (id.startsWith(\"monitoring-\")) {\n      // Extract the actual monitoring ID \n      const monitoringId = id.replace(\"monitoring-\", \"\");\n      \n      processMonitoringMutation.mutate({\n        monitoringId: monitoringId,\n        action: \"reject\",\n        actionAttachment: pdfPath\n      });\n    } else {\n      // Regular leave request\n      updateStatusMutation.mutate({ \n        id, \n        status: 'rejected',\n        actionAttachment: pdfPath \n      });\n    }\n    setShowActionDialog(false);\n  };\n\n  // Upload Roster functions\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const selectedFile = event.target.files?.[0];\n    if (selectedFile) {\n      const allowedTypes = [\n        \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n        \"application/vnd.ms-excel\",\n      ];\n      \n      if (allowedTypes.includes(selectedFile.type)) {\n        setFile(selectedFile);\n        setUploadResults(null);\n      } else {\n        toast({\n          title: \"Format File Tidak Valid\",\n          description: \"Hanya file Excel (.xlsx, .xls) yang diperbolehkan\",\n          variant: \"destructive\",\n        });\n      }\n    }\n  };\n\n  const processExcelFile = async (file: File): Promise<LeaveRosterData[]> => {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onload = (e) => {\n        try {\n          const data = new Uint8Array(e.target?.result as ArrayBuffer);\n          const workbook = XLSX.read(data, { type: \"array\" });\n          const sheetName = workbook.SheetNames[0];\n          const worksheet = workbook.Sheets[sheetName];\n          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });\n\n          const dataRows = jsonData.slice(1) as any[][];\n          \n          const leaveData: LeaveRosterData[] = dataRows\n            .filter(row => row.length >= 5 && row[0])\n            .map((row, index) => {\n              const startDate = parseExcelDate(row[2]);\n              const endDate = parseExcelDate(row[3]);\n              \n              if (!startDate || !endDate) {\n                throw new Error(`Baris ${index + 2}: Format tanggal tidak valid`);\n              }\n\n              return {\n                nik: String(row[0]).trim(),\n                nama: \"\",\n                leaveType: String(row[1] || \"Cuti Tahunan\").trim(),\n                startDate: startDate,\n                endDate: endDate,\n                totalDays: parseInt(String(row[4])) || calculateDaysBetween(startDate, endDate),\n                reason: String(row[5] || \"Bulk upload roster cuti\").trim(),\n              };\n            });\n\n          resolve(leaveData);\n        } catch (error) {\n          reject(error);\n        }\n      };\n      reader.onerror = () => reject(new Error(\"Gagal membaca file\"));\n      reader.readAsArrayBuffer(file);\n    });\n  };\n\n  const parseExcelDate = (value: any): string | null => {\n    if (!value) return null;\n    \n    if (typeof value === \"string\" && /^\\d{4}-\\d{2}-\\d{2}$/.test(value)) {\n      return value;\n    }\n    \n    if (typeof value === \"string\") {\n      const parts = value.split(/[\\/\\-]/);\n      if (parts.length === 3) {\n        const day = parts[0].padStart(2, '0');\n        const month = parts[1].padStart(2, '0');\n        const year = parts[2];\n        return `${year}-${month}-${day}`;\n      }\n    }\n    \n    if (typeof value === \"number\") {\n      const date = XLSX.SSF.parse_date_code(value);\n      if (date) {\n        const year = date.y;\n        const month = String(date.m).padStart(2, '0');\n        const day = String(date.d).padStart(2, '0');\n        return `${year}-${month}-${day}`;\n      }\n    }\n    \n    return null;\n  };\n\n  const calculateDaysBetween = (startDate: string, endDate: string): number => {\n    const start = new Date(startDate);\n    const end = new Date(endDate);\n    const diffTime = Math.abs(end.getTime() - start.getTime());\n    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;\n  };\n\n  const handleUploadRoster = async () => {\n    if (!file) {\n      toast({\n        title: \"File Belum Dipilih\",\n        description: \"Silakan pilih file Excel terlebih dahulu\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsUploadingRoster(true);\n    setUploadProgress(0);\n\n    try {\n      const progressInterval = setInterval(() => {\n        setUploadProgress(prev => Math.min(prev + 5, 85));\n      }, 1000);\n\n      const leaveData = await processExcelFile(file);\n      \n      clearInterval(progressInterval);\n      setUploadProgress(95);\n\n      await uploadMutation.mutateAsync(leaveData);\n      \n      setUploadProgress(100);\n    } catch (error) {\n      toast({\n        title: \"Error Proses File\",\n        description: error instanceof Error ? error.message : \"Gagal memproses file Excel\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsUploadingRoster(false);\n      setUploadProgress(0);\n    }\n  };\n\n  const downloadTemplate = () => {\n    const link = document.createElement('a');\n    link.href = '/api/leave-roster/template';\n    link.download = 'template-roster-cuti.csv';\n    link.click();\n    \n    toast({\n      title: \"Template Downloaded\",\n      description: \"Template CSV berhasil didownload\",\n    });\n  };\n\n  // Analytics functions\n  const generateChartData = () => {\n    if (!analyticsData) return {};\n\n    const monthlyChartData = {\n      labels: analyticsData.monthlyLeaveData.map(item => item.month),\n      datasets: [\n        {\n          label: 'Jumlah Permohonan',\n          data: analyticsData.monthlyLeaveData.map(item => item.requests),\n          backgroundColor: 'rgba(239, 68, 68, 0.8)',\n          borderColor: 'rgba(239, 68, 68, 1)',\n          borderWidth: 1,\n        },\n        {\n          label: 'Total Hari Cuti',\n          data: analyticsData.monthlyLeaveData.map(item => item.totalDays),\n          backgroundColor: 'rgba(251, 146, 60, 0.8)',\n          borderColor: 'rgba(251, 146, 60, 1)',\n          borderWidth: 1,\n        }\n      ]\n    };\n\n    const leaveTypeChartData = {\n      labels: Object.keys(analyticsData.leaveTypeDistribution),\n      datasets: [{\n        data: Object.values(analyticsData.leaveTypeDistribution),\n        backgroundColor: [\n          'rgba(239, 68, 68, 0.8)',\n          'rgba(251, 146, 60, 0.8)',\n          'rgba(34, 197, 94, 0.8)',\n          'rgba(59, 130, 246, 0.8)',\n        ],\n        borderWidth: 2,\n        borderColor: '#fff'\n      }]\n    };\n\n    return { monthlyChartData, leaveTypeChartData };\n  };\n\n  const { monthlyChartData, leaveTypeChartData } = generateChartData();\n\n  const chartOptions = {\n    responsive: true,\n    maintainAspectRatio: false,\n    plugins: {\n      legend: {\n        position: 'top' as const,\n      },\n    },\n    scales: {\n      y: {\n        beginAtZero: true,\n      },\n    },\n  };\n\n  const doughnutOptions = {\n    responsive: true,\n    maintainAspectRatio: false,\n    plugins: {\n      legend: {\n        position: 'right' as const,\n      },\n    },\n  };\n\n  // Monitoring functions\n  const getReminderTypeText = (type: string) => {\n    switch (type) {\n      case '7_days': return '7 Hari';\n      case '3_days': return '3 Hari';\n      case '1_day': return '1 Hari';\n      default: return type;\n    }\n  };\n\n  const getReminderTypeColor = (type: string) => {\n    switch (type) {\n      case '7_days': return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';\n      case '3_days': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';\n      case '1_day': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';\n      default: return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';\n    }\n  };\n\n  return (\n    <div className=\"container mx-auto p-4 space-y-6\">\n      <div className=\"flex items-center justify-between mb-6\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900 dark:text-white\">Manajemen Cuti</h1>\n          <p className=\"text-sm text-gray-600 dark:text-gray-400\">Sistem manajemen cuti terpadu dengan analitik dan monitoring</p>\n        </div>\n      </div>\n\n      {/* Form Pengajuan Cuti */}\n      <div className=\"space-y-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg\">Ajukan Cuti</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-3\">\n                <FormField\n                  control={form.control}\n                  name=\"employeeId\"\n                  render={({ field }) => {\n                    const selectedEmployee = employees.find(emp => emp.id === field.value);\n                    const filteredEmployees = employees.filter((employee) =>\n                      employee.name.toLowerCase().includes(employeeSearchValue.toLowerCase()) ||\n                      employee.id.toLowerCase().includes(employeeSearchValue.toLowerCase())\n                    );\n                    \n                    return (\n                      <FormItem>\n                        <FormLabel className=\"text-sm\">Karyawan</FormLabel>\n                        <Popover open={openCombobox} onOpenChange={setOpenCombobox}>\n                          <PopoverTrigger asChild>\n                            <FormControl>\n                              <Button\n                                variant=\"outline\"\n                                role=\"combobox\"\n                                aria-expanded={openCombobox}\n                                className={cn(\n                                  \"h-9 w-full justify-between\",\n                                  !field.value && \"text-muted-foreground\"\n                                )}\n                                data-testid=\"leave-employee-select\"\n                              >\n                                {selectedEmployee ? `${selectedEmployee.id} - ${selectedEmployee.name}` : \"-- Pilih Karyawan --\"}\n                                <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                              </Button>\n                            </FormControl>\n                          </PopoverTrigger>\n                          <PopoverContent className=\"w-[400px] p-0\">\n                            <Command>\n                              <CommandInput \n                                placeholder=\"Cari nama atau NIK karyawan...\" \n                                value={employeeSearchValue}\n                                onValueChange={setEmployeeSearchValue}\n                              />\n                              <CommandEmpty>Tidak ada karyawan yang ditemukan.</CommandEmpty>\n                              <CommandGroup className=\"max-h-60 overflow-auto\">\n                                {filteredEmployees.map((employee) => (\n                                  <CommandItem\n                                    key={employee.id}\n                                    value={employee.id}\n                                    onSelect={(currentValue) => {\n                                      field.onChange(currentValue === field.value ? \"\" : currentValue);\n                                      setOpenCombobox(false);\n                                      setEmployeeSearchValue(\"\");\n                                      \n                                      // Auto-fill phone number\n                                      const selectedEmp = employees.find(emp => emp.id === currentValue);\n                                      if (selectedEmp) {\n                                        form.setValue(\"phoneNumber\", selectedEmp.phone);\n                                      }\n                                    }}\n                                  >\n                                    <Check\n                                      className={cn(\n                                        \"mr-2 h-4 w-4\",\n                                        field.value === employee.id ? \"opacity-100\" : \"opacity-0\"\n                                      )}\n                                    />\n                                    <div className=\"flex flex-col\">\n                                      <span className=\"font-medium\">{employee.name}</span>\n                                      <span className=\"text-sm text-muted-foreground\">{employee.id}</span>\n                                    </div>\n                                  </CommandItem>\n                                ))}\n                              </CommandGroup>\n                            </Command>\n                          </PopoverContent>\n                        </Popover>\n                        <FormMessage />\n                      </FormItem>\n                    );\n                  }}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"phoneNumber\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-sm\">Nomor WhatsApp</FormLabel>\n                      <FormControl>\n                        <Input \n                          {...field}\n                          className=\"h-9 bg-gray-50 dark:bg-gray-800\"\n                          placeholder=\"Nomor akan terisi otomatis\"\n                          readOnly\n                          data-testid=\"leave-phone-number\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={form.control}\n                  name=\"startDate\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-sm\">Tanggal Mulai</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"date\" \n                          {...field} \n                          className=\"h-9\"\n                          data-testid=\"leave-start-date-input\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={form.control}\n                  name=\"endDate\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-sm\">Tanggal Selesai</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"date\" \n                          {...field} \n                          className=\"h-9\"\n                          data-testid=\"leave-end-date-input\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={form.control}\n                  name=\"leaveType\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-sm\">Jenis Cuti</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger className=\"h-9\" data-testid=\"leave-type-select\">\n                            <SelectValue placeholder=\"-- Pilih Jenis Cuti --\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"annual\">Cuti Tahunan</SelectItem>\n                          <SelectItem value=\"sick\">Cuti Sakit</SelectItem>\n                          <SelectItem value=\"personal\">Cuti Pribadi</SelectItem>\n                          <SelectItem value=\"maternity\">Cuti Melahirkan</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={form.control}\n                  name=\"reason\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-sm\">Keterangan</FormLabel>\n                      <FormControl>\n                        <Textarea \n                          rows={2} \n                          className=\"resize-none\"\n                          placeholder=\"Keterangan cuti...\" \n                          {...field}\n                          value={field.value || \"\"} \n                          data-testid=\"leave-reason-textarea\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* PDF File Upload */}\n                <div className=\"space-y-2\">\n                  <label className=\"text-xs font-medium text-gray-600 dark:text-gray-400\">Lampiran PDF (Opsional)</label>\n                  <div className=\"flex items-center gap-2\">\n                    <input\n                      type=\"file\"\n                      accept=\".pdf,application/pdf\"\n                      onChange={handlePdfFileSelect}\n                      className=\"hidden\"\n                      id=\"pdf-upload\"\n                      disabled={isUploading}\n                    />\n                    <label\n                      htmlFor=\"pdf-upload\"\n                      className={`flex-1 h-8 px-3 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded cursor-pointer flex items-center justify-center gap-2 \n                        ${isUploading ? 'bg-gray-100 dark:bg-gray-800 cursor-not-allowed' : 'bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800'}\n                        text-gray-700 dark:text-gray-300`}\n                    >\n                      <FileText className=\"w-3 h-3\" />\n                      {selectedPdfFile ? selectedPdfFile.name : 'Pilih file PDF'}\n                    </label>\n                    {selectedPdfFile && !isUploading && (\n                      <Button\n                        type=\"button\"\n                        size=\"sm\"\n                        onClick={handleUploadPdf}\n                        className=\"h-8 px-3 text-xs\"\n                        disabled={isUploading}\n                      >\n                        Upload\n                      </Button>\n                    )}\n                  </div>\n                  {uploadedAttachmentPath && (\n                    <div className=\"flex items-center gap-2\">\n                      <p className=\"text-xs text-green-600 dark:text-green-400\">âœ“ PDF uploaded successfully</p>\n                      <a \n                        href={`/api/files/download/${uploadedAttachmentPath.split('/').pop()}`}\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"text-xs text-blue-600 dark:text-blue-400 hover:underline\"\n                      >\n                        Lihat PDF\n                      </a>\n                    </div>\n                  )}\n                  {isUploading && (\n                    <p className=\"text-xs text-blue-600 dark:text-blue-400\">Uploading PDF...</p>\n                  )}\n                  {selectedPdfFile && !uploadedAttachmentPath && (\n                    <p className=\"text-xs text-gray-500 dark:text-gray-400\">\n                      File size: {(selectedPdfFile.size / 1024 / 1024).toFixed(2)} MB\n                    </p>\n                  )}\n                </div>\n                \n                <Button \n                  type=\"submit\" \n                  className=\"w-full h-9\"\n                  disabled={createMutation.isPending}\n                  data-testid=\"submit-leave-button\"\n                >\n                  {createMutation.isPending ? \"Mengajukan...\" : \"Ajukan Cuti\"}\n                </Button>\n              </form>\n            </Form>\n          </CardContent>\n        </Card>\n        \n        {/* Compact Leave List */}\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"text-lg\">Daftar Cuti</CardTitle>\n              <div className=\"flex items-center gap-3\">\n                <Input\n                  placeholder=\"Cari nama karyawan atau NIK...\"\n                  value={searchName}\n                  onChange={(e) => {\n                    const value = e.target.value;\n                    setSearchName(value);\n                    setSearchNIK(value); // Use same search for both name and NIK\n                  }}\n                  className=\"w-64 h-9\"\n                  data-testid=\"leave-search-input\"\n                />\n                <Select value={statusFilter} onValueChange={setStatusFilter}>\n                  <SelectTrigger className=\"w-36 h-9\" data-testid=\"leave-status-filter\">\n                    <SelectValue placeholder=\"Semua Status\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Semua Status</SelectItem>\n                    <SelectItem value=\"pending\">Menunggu</SelectItem>\n                    <SelectItem value=\"approved\">Disetujui</SelectItem>\n                    <SelectItem value=\"rejected\">Ditolak</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </CardHeader>\n          \n          <CardContent className=\"p-3\">\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full table-auto text-sm\">\n                <thead>\n                  <tr className=\"border-b border-gray-200 dark:border-gray-700\">\n                    <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Karyawan</th>\n                    <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Tanggal</th>\n                    <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Jenis</th>\n                    <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Durasi</th>\n                    <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Lampiran</th>\n                    <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Status</th>\n                    <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Aksi</th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y divide-gray-200 dark:divide-gray-700\">\n                  {isLoading ? (\n                    <tr>\n                      <td colSpan={7} className=\"py-4 text-center text-gray-500 dark:text-gray-400 text-sm\">\n                        Loading...\n                      </td>\n                    </tr>\n                  ) : filteredLeaveRequests.length === 0 ? (\n                    <tr>\n                      <td colSpan={7} className=\"py-4 text-center text-gray-500 dark:text-gray-400 text-sm\">\n                        Tidak ada data cuti\n                      </td>\n                    </tr>\n                  ) : (\n                    filteredLeaveRequests.map((request) => (\n                      <tr key={request.id} data-testid={`leave-row-${request.id}`}>\n                        <td className=\"py-2 px-2 text-xs text-gray-900 dark:text-white\">\n                          <div className=\"font-medium\">{getEmployeeName(request.employeeId)}</div>\n                        </td>\n                        <td className=\"py-2 px-2 text-xs text-gray-900 dark:text-white\">\n                          <div>{new Date(request.startDate).toLocaleDateString('id-ID')}</div>\n                          <div className=\"text-gray-500\">-</div>\n                          <div>{new Date(request.endDate).toLocaleDateString('id-ID')}</div>\n                        </td>\n                        <td className=\"py-2 px-2 text-xs text-gray-900 dark:text-white\">\n                          {getLeaveTypeLabel(request.leaveType)}\n                        </td>\n                        <td className=\"py-2 px-2 text-xs text-gray-900 dark:text-white text-center\">\n                          <span className=\"font-medium\">{calculateDays(request.startDate, request.endDate)}</span> hari\n                        </td>\n                        <td className=\"py-2 px-2 text-xs text-center\">\n                          {request.attachmentPath ? (\n                            <a \n                              href={convertToProxyPath(request.attachmentPath)} \n                              target=\"_blank\" \n                              rel=\"noopener noreferrer\"\n                              className=\"text-red-600 hover:text-red-700 dark:text-red-400 text-xs\"\n                              title=\"Lihat lampiran PDF\"\n                            >\n                              ðŸ“Ž\n                            </a>\n                          ) : (\n                            <span className=\"text-gray-400 dark:text-gray-500\">-</span>\n                          )}\n                        </td>\n                        <td className=\"py-2 px-2\">\n                          {getStatusBadge(request.status)}\n                        </td>\n                        <td className=\"py-2 px-2\">\n                          {request.status === 'pending' ? (\n                            <div className=\"flex flex-col space-y-1\">\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={() => handleApprove(request.id)}\n                                disabled={updateStatusMutation.isPending}\n                                className=\"text-green-600 hover:text-green-700 h-7 text-xs\"\n                                data-testid={`approve-leave-${request.id}`}\n                              >\n                                <CheckCircle className=\"w-3 h-3 mr-1\" />\n                                Setujui\n                              </Button>\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={() => handleReject(request.id)}\n                                disabled={updateStatusMutation.isPending}\n                                className=\"text-red-600 hover:text-red-700 h-7 text-xs\"\n                                data-testid={`reject-leave-${request.id}`}\n                              >\n                                <XCircle className=\"w-3 h-3 mr-1\" />\n                                Tolak\n                              </Button>\n                            </div>\n                          ) : (\n                            <div className=\"flex flex-col space-y-1\">\n                              <Dialog>\n                                <DialogTrigger asChild>\n                                  <Button\n                                    size=\"sm\"\n                                    variant=\"outline\"\n                                    className=\"text-blue-600 hover:text-blue-700 h-7 text-xs\"\n                                    data-testid={`detail-leave-${request.id}`}\n                                  >\n                                    <Eye className=\"w-3 h-3 mr-1\" />\n                                    Detail\n                                  </Button>\n                                </DialogTrigger>\n                              <DialogContent className=\"max-w-md\">\n                                <DialogHeader>\n                                  <DialogTitle>Detail Pengajuan Cuti</DialogTitle>\n                                </DialogHeader>\n                                <div className=\"space-y-4\">\n                                  <div className=\"flex items-center space-x-2\">\n                                    <User className=\"w-4 h-4 text-gray-500\" />\n                                    <div>\n                                      <p className=\"font-medium\">{request.employeeName || getEmployeeName(request.employeeId)}</p>\n                                      <p className=\"text-sm text-gray-500\">{request.employeeId}</p>\n                                    </div>\n                                  </div>\n                                  \n                                  {request.phoneNumber && (\n                                    <div className=\"flex items-center space-x-2\">\n                                      <Phone className=\"w-4 h-4 text-gray-500\" />\n                                      <p className=\"text-sm\">{request.phoneNumber}</p>\n                                    </div>\n                                  )}\n                                  \n                                  <div className=\"flex items-center space-x-2\">\n                                    <CalendarDays className=\"w-4 h-4 text-gray-500\" />\n                                    <div>\n                                      <p className=\"text-sm\">\n                                        {new Date(request.startDate).toLocaleDateString('id-ID', {\n                                          weekday: 'long',\n                                          year: 'numeric',\n                                          month: 'long',\n                                          day: 'numeric'\n                                        })}\n                                      </p>\n                                      <p className=\"text-sm\">s/d</p>\n                                      <p className=\"text-sm\">\n                                        {new Date(request.endDate).toLocaleDateString('id-ID', {\n                                          weekday: 'long',\n                                          year: 'numeric',\n                                          month: 'long',\n                                          day: 'numeric'\n                                        })}\n                                      </p>\n                                    </div>\n                                  </div>\n                                  \n                                  <div className=\"flex items-center space-x-2\">\n                                    <Clock className=\"w-4 h-4 text-gray-500\" />\n                                    <div>\n                                      <p className=\"text-sm font-medium\">{getLeaveTypeLabel(request.leaveType)}</p>\n                                      <p className=\"text-sm text-gray-500\">\n                                        Durasi: {calculateDays(request.startDate, request.endDate)} hari\n                                      </p>\n                                    </div>\n                                  </div>\n                                  \n                                  {request.reason && (\n                                    <div>\n                                      <p className=\"font-medium text-sm mb-1\">Keterangan:</p>\n                                      <p className=\"text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg\">\n                                        {request.reason}\n                                      </p>\n                                    </div>\n                                  )}\n\n                                  {request.attachmentPath && (\n                                    <div>\n                                      <p className=\"font-medium text-sm mb-2\">Lampiran Dokumen:</p>\n                                      <div className=\"flex gap-2\">\n                                        <PDFViewer \n                                          pdfPath={convertToProxyPath(request.attachmentPath)}\n                                          title=\"Lampiran Permohonan Cuti\"\n                                          trigger={\n                                            <Button\n                                              variant=\"outline\"\n                                              size=\"sm\"\n                                              className=\"flex items-center space-x-2 text-red-600 hover:text-red-700 dark:text-red-400\"\n                                              data-testid={`preview-pdf-${request.id}`}\n                                            >\n                                              <FileText className=\"w-4 h-4\" />\n                                              <span className=\"text-sm\">Preview PDF</span>\n                                            </Button>\n                                          }\n                                        />\n                                        <a \n                                          href={convertToProxyPath(request.attachmentPath)} \n                                          target=\"_blank\" \n                                          rel=\"noopener noreferrer\"\n                                          className=\"inline-flex items-center space-x-1 text-red-600 hover:text-red-700 dark:text-red-400 text-sm underline\"\n                                          data-testid={`download-pdf-${request.id}`}\n                                        >\n                                          <span>ðŸ“Ž</span>\n                                          <span>Download</span>\n                                        </a>\n                                      </div>\n                                    </div>\n                                  )}\n                                  \n                                  {/* HR Action Attachment */}\n                                  {(request as any).actionAttachmentPath && (\n                                    <div>\n                                      <p className=\"font-medium text-sm mb-2\">Dokumen HR:</p>\n                                      <div className=\"flex gap-2\">\n                                        <PDFViewer \n                                          pdfPath={convertToProxyPath((request as any).actionAttachmentPath)}\n                                          title=\"Dokumen Keputusan HR\"\n                                          trigger={\n                                            <Button\n                                              variant=\"outline\"\n                                              size=\"sm\"\n                                              className=\"flex items-center space-x-2 text-blue-600 hover:text-blue-700 dark:text-blue-400\"\n                                              data-testid={`preview-hr-pdf-${request.id}`}\n                                            >\n                                              <FileText className=\"w-4 h-4\" />\n                                              <span className=\"text-sm\">Preview Keputusan HR</span>\n                                            </Button>\n                                          }\n                                        />\n                                        <a \n                                          href={convertToProxyPath((request as any).actionAttachmentPath)} \n                                          target=\"_blank\" \n                                          rel=\"noopener noreferrer\"\n                                          className=\"inline-flex items-center space-x-1 text-blue-600 hover:text-blue-700 dark:text-blue-400 text-sm underline\"\n                                          data-testid={`download-hr-pdf-${request.id}`}\n                                        >\n                                          <span>ðŸ“Ž</span>\n                                          <span>Download</span>\n                                        </a>\n                                      </div>\n                                    </div>\n                                  )}\n                                  \n                                  <div className=\"flex items-center justify-between pt-4 border-t\">\n                                    <span className=\"text-sm text-gray-500\">Status:</span>\n                                    {getStatusBadge(request.status)}\n                                  </div>\n                                  \n                                  {request.status === 'pending' && (\n                                    <div className=\"flex space-x-2 pt-2\">\n                                      <Button\n                                        size=\"sm\"\n                                        onClick={() => handleApprove(request.id)}\n                                        disabled={updateStatusMutation.isPending}\n                                        className=\"flex-1 bg-green-600 hover:bg-green-700\"\n                                      >\n                                        <CheckCircle className=\"w-4 h-4 mr-1\" />\n                                        Setujui\n                                      </Button>\n                                      <Button\n                                        size=\"sm\"\n                                        variant=\"destructive\"\n                                        onClick={() => handleReject(request.id)}\n                                        disabled={updateStatusMutation.isPending}\n                                        className=\"flex-1\"\n                                      >\n                                        <XCircle className=\"w-4 h-4 mr-1\" />\n                                        Tolak\n                                      </Button>\n                                    </div>\n                                  )}\n                                </div>\n                              </DialogContent>\n                              </Dialog>\n                              \n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={() => setEditingRequest(request)}\n                                className=\"text-orange-600 hover:text-orange-700 h-7 text-xs\"\n                                data-testid={`edit-leave-${request.id}`}\n                              >\n                                <Edit2 className=\"w-3 h-3 mr-1\" />\n                                Edit\n                              </Button>\n                              \n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={() => {\n                                  setRequestToDelete(request.id);\n                                  setShowDeleteDialog(true);\n                                }}\n                                className=\"text-red-600 hover:text-red-700 h-7 text-xs\"\n                                data-testid={`delete-leave-${request.id}`}\n                              >\n                                <Trash2 className=\"w-3 h-3 mr-1\" />\n                                Hapus\n                              </Button>\n                            </div>\n                          )}\n                        </td>\n                      </tr>\n                    ))\n                  )}\n                </tbody>\n              </table>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Daftar Permohonan Cuti Terpadu */}\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"text-lg\">Semua Permohonan Cuti</CardTitle>\n              <div className=\"flex items-center gap-3\">\n                <Input\n                  placeholder=\"Cari nama karyawan atau NIK...\"\n                  value={searchName}\n                  onChange={(e) => {\n                    const value = e.target.value;\n                    setSearchName(value);\n                    setSearchNIK(value); // Use same search for both name and NIK\n                  }}\n                  className=\"w-64 h-9\"\n                  data-testid=\"leave-search-input-all\"\n                />\n                <Select value={statusFilter} onValueChange={setStatusFilter}>\n                  <SelectTrigger className=\"w-36 h-9\" data-testid=\"leave-status-filter\">\n                    <SelectValue placeholder=\"Semua Status\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">ðŸ“‹ Semua Status</SelectItem>\n                    <SelectItem value=\"pending\">â³ Menunggu</SelectItem>\n                    <SelectItem value=\"approved\">âœ… Disetujui</SelectItem>\n                    <SelectItem value=\"rejected\">âŒ Ditolak</SelectItem>\n                    <SelectItem value=\"monitoring\">ðŸ” Monitoring</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </CardHeader>\n            \n          <CardContent className=\"space-y-3\">\n            {loadingPendingMonitoring ? (\n                <div className=\"text-center py-8\">\n                  <div className=\"animate-pulse flex flex-col items-center\">\n                    <div className=\"w-8 h-8 bg-gray-200 dark:bg-gray-800 rounded-full mb-2\"></div>\n                    <div className=\"text-gray-600 dark:text-gray-400\">Loading permohonan cuti...</div>\n                  </div>\n                </div>\n              ) : (\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full text-sm\">\n                  <thead>\n                    <tr className=\"border-b border-gray-200 dark:border-gray-700\">\n                      <th className=\"text-left p-3 font-medium text-gray-900 dark:text-white\">Karyawan</th>\n                      <th className=\"text-left p-3 font-medium text-gray-900 dark:text-white\">Tanggal</th>\n                      <th className=\"text-left p-3 font-medium text-gray-900 dark:text-white\">Jenis</th>\n                      <th className=\"text-left p-3 font-medium text-gray-900 dark:text-white\">Status</th>\n                      <th className=\"text-left p-3 font-medium text-gray-900 dark:text-white\">Aksi</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {/* Data dari Monitoring */}\n                    {Array.isArray(pendingFromMonitoring) && pendingFromMonitoring\n                      .filter((request: any) => {\n                        // Status filter for monitoring\n                        const statusMatch = statusFilter === \"all\" || statusFilter === \"monitoring\";\n                        \n                        // Search filter for monitoring\n                        let searchMatch = true;\n                        if (searchName !== \"\") {\n                          const searchTerm = searchName.toLowerCase();\n                          const employeeName = (request.employeeName || \"\").toLowerCase();\n                          const employeeId = (request.employeeId || \"\").toLowerCase();\n                          const leaveType = (request.leaveType || \"\").toLowerCase();\n                          const startDate = (request.startDate || \"\").toLowerCase();\n                          \n                          searchMatch = employeeName.includes(searchTerm) ||\n                                       employeeId.includes(searchTerm) ||\n                                       leaveType.includes(searchTerm) ||\n                                       startDate.includes(searchTerm);\n                        }\n                        \n                        return statusMatch && searchMatch;\n                      })\n                      .map((request: any) => (\n                      <tr key={`monitoring-${request.id}`} className=\"border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800\">\n                        <td className=\"p-3\">\n                          <div className=\"flex items-center gap-3\">\n                            <div className=\"w-8 h-8 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center\">\n                              <User className=\"w-4 h-4 text-orange-600 dark:text-orange-400\" />\n                            </div>\n                            <div>\n                              <div className=\"font-medium text-gray-900 dark:text-white\">{request.employeeName}</div>\n                              <div className=\"text-xs text-gray-500 dark:text-gray-400\">NIK: {request.employeeId}</div>\n                            </div>\n                          </div>\n                        </td>\n                        <td className=\"p-3\">\n                          <div className=\"text-sm\">\n                            <div>{request.startDate || 'Belum ditentukan'}</div>\n                            <div className=\"text-xs text-gray-500\">{request.monitoringDays} hari lagi</div>\n                          </div>\n                        </td>\n                        <td className=\"p-3\">\n                          <span className=\"text-green-600 dark:text-green-400 font-medium\">{request.leaveType}</span>\n                        </td>\n                        <td className=\"p-3\">\n                          <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900/20 dark:text-orange-400\">\n                            ðŸ” Monitoring\n                          </span>\n                        </td>\n                        <td className=\"p-3\">\n                          <div className=\"flex gap-2\">\n                            <Button\n                              size=\"sm\"\n                              onClick={() => handleApprove(request.id)}\n                              disabled={updateStatusMutation.isPending}\n                              className=\"bg-green-600 hover:bg-green-700\"\n                            >\n                              <CheckCircle className=\"w-4 h-4 mr-1\" />\n                              Setujui\n                            </Button>\n                            <Button\n                              size=\"sm\"\n                              variant=\"destructive\"\n                              onClick={() => handleReject(request.id)}\n                              disabled={updateStatusMutation.isPending}\n                            >\n                              <XCircle className=\"w-4 h-4 mr-1\" />\n                              Tolak\n                            </Button>\n                          </div>\n                        </td>\n                      </tr>\n                    ))}\n                    \n                    {/* Data dari Manual Request */}\n                    {filteredLeaveRequests.map((request: any) => (\n                      <tr key={`manual-${request.id}`} className=\"border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800\">\n                        <td className=\"p-3\">\n                          <div className=\"flex items-center gap-3\">\n                            <div className=\"w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center\">\n                              <User className=\"w-4 h-4 text-blue-600 dark:text-blue-400\" />\n                            </div>\n                            <div>\n                              <div className=\"font-medium text-gray-900 dark:text-white\">{request.employeeName}</div>\n                              <div className=\"text-xs text-gray-500 dark:text-gray-400\">NIK: {request.employeeId}</div>\n                            </div>\n                          </div>\n                        </td>\n                        <td className=\"p-3\">\n                          <div className=\"text-sm\">\n                            <div>{request.startDate}</div>\n                            <div className=\"text-xs text-gray-500\">{request.duration} hari</div>\n                          </div>\n                        </td>\n                        <td className=\"p-3\">\n                          <span className=\"text-blue-600 dark:text-blue-400 font-medium\">{request.leaveType}</span>\n                        </td>\n                        <td className=\"p-3\">\n                          <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(request.status)}`}>\n                            {getStatusText(request.status)}\n                          </span>\n                        </td>\n                        <td className=\"p-3\">\n                          {request.status === \"pending\" ? (\n                            <div className=\"flex gap-2\">\n                              <Button\n                                size=\"sm\"\n                                onClick={() => handleApprove(request.id)}\n                                disabled={updateStatusMutation.isPending}\n                                className=\"bg-green-600 hover:bg-green-700\"\n                              >\n                                <CheckCircle className=\"w-4 h-4 mr-1\" />\n                                Setujui\n                              </Button>\n                              <Button\n                                size=\"sm\"\n                                variant=\"destructive\"\n                                onClick={() => handleReject(request.id)}\n                                disabled={updateStatusMutation.isPending}\n                              >\n                                <XCircle className=\"w-4 h-4 mr-1\" />\n                                Tolak\n                              </Button>\n                            </div>\n                          ) : (\n                            <span className=\"text-gray-500 text-sm\">-</span>\n                          )}\n                        </td>\n                      </tr>\n                    ))}\n                    \n                    {/* Empty State */}\n                    {(!Array.isArray(pendingFromMonitoring) || pendingFromMonitoring.length === 0) && \n                     filteredLeaveRequests.length === 0 && (\n                      <tr>\n                        <td colSpan={5} className=\"text-center py-8\">\n                          <div className=\"w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-3\">\n                            <FileText className=\"w-8 h-8 text-gray-400\" />\n                          </div>\n                          <p className=\"text-gray-600 dark:text-gray-400 font-medium\">Tidak ada permohonan cuti</p>\n                          <p className=\"text-gray-500 dark:text-gray-500 text-sm mt-1\">Gunakan form di atas untuk mengajukan cuti baru</p>\n                        </td>\n                      </tr>\n                    )}\n                  </tbody>\n                </table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* End of unified leave requests */}\n      </div>\n\n      {/* Action Dialog with PDF Upload */}\n      <Dialog open={showActionDialog} onOpenChange={setShowActionDialog}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>\n              {actionType === 'approve' ? 'Setujui Permohonan Cuti' : 'Tolak Permohonan Cuti'}\n            </DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n              Anda akan {actionType === 'approve' ? 'menyetujui' : 'menolak'} permohonan cuti ini.\n              Anda dapat melampirkan dokumen pendukung (opsional).\n            </p>\n            \n            {/* PDF Upload Section */}\n            <div className=\"space-y-3\">\n              <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n                Lampiran Dokumen Aksi (Opsional)\n              </label>\n              <div className=\"flex items-center gap-2\">\n                <input\n                  type=\"file\"\n                  accept=\".pdf,application/pdf\"\n                  onChange={handleActionPdfFileSelect}\n                  className=\"hidden\"\n                  id=\"action-pdf-upload\"\n                  disabled={actionPdfUploading}\n                />\n                <label\n                  htmlFor=\"action-pdf-upload\"\n                  className={`flex-1 h-10 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded cursor-pointer flex items-center justify-center gap-2 \n                    ${actionPdfUploading ? 'bg-gray-100 dark:bg-gray-800 cursor-not-allowed' : 'bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800'}\n                    text-gray-700 dark:text-gray-300`}\n                >\n                  <FileText className=\"w-4 h-4\" />\n                  {actionPdfFile ? actionPdfFile.name : 'Pilih file PDF'}\n                </label>\n                {actionPdfFile && !actionPdfUploading && !actionPdfPath && (\n                  <Button\n                    type=\"button\"\n                    size=\"sm\"\n                    onClick={handleActionPdfUpload}\n                    className=\"h-10\"\n                    disabled={actionPdfUploading}\n                  >\n                    Upload\n                  </Button>\n                )}\n              </div>\n              \n              {actionPdfPath && (\n                <div className=\"flex items-center gap-2\">\n                  <p className=\"text-sm text-green-600 dark:text-green-400\">âœ“ PDF uploaded successfully</p>\n                  <a \n                    href={`/api/files/download/${actionPdfPath}`}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-sm text-blue-600 dark:text-blue-400 hover:underline\"\n                  >\n                    Lihat PDF\n                  </a>\n                </div>\n              )}\n              \n              {actionPdfUploading && (\n                <p className=\"text-sm text-blue-600 dark:text-blue-400\">Uploading PDF...</p>\n              )}\n              \n              {actionPdfFile && !actionPdfPath && (\n                <p className=\"text-sm text-gray-500 dark:text-gray-400\">\n                  File size: {(actionPdfFile.size / 1024 / 1024).toFixed(2)} MB\n                </p>\n              )}\n            </div>\n\n            {/* Action Buttons */}\n            <div className=\"flex gap-2 pt-4\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowActionDialog(false)}\n                className=\"flex-1\"\n              >\n                Batal\n              </Button>\n              <Button\n                onClick={handleActionConfirm}\n                disabled={updateStatusMutation.isPending || processMonitoringMutation.isPending}\n                className={`flex-1 ${\n                  actionType === 'approve' \n                    ? 'bg-green-600 hover:bg-green-700' \n                    : 'bg-red-600 hover:bg-red-700'\n                }`}\n              >\n                {actionType === 'approve' ? 'Setujui' : 'Tolak'}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Leave Request Dialog */}\n      {editingRequest && (\n        <Dialog open={!!editingRequest} onOpenChange={() => setEditingRequest(null)}>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>Edit Pengajuan Cuti</DialogTitle>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit((values) => {\n                const submitData = {\n                  ...values,\n                  employeeName: employees.find(emp => emp.id === values.employeeId)?.name || \"\",\n                  attachmentPath: uploadedAttachmentPath || editingRequest.attachmentPath,\n                };\n                updateLeaveMutation.mutate({ id: editingRequest.id, request: submitData });\n              })} className=\"space-y-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"employeeId\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Karyawan</FormLabel>\n                        <Popover open={openCombobox} onOpenChange={setOpenCombobox}>\n                          <PopoverTrigger asChild>\n                            <FormControl>\n                              <Button\n                                variant=\"outline\"\n                                role=\"combobox\"\n                                aria-expanded={openCombobox}\n                                className=\"justify-between\"\n                              >\n                                {field.value\n                                  ? employees.find((emp) => emp.id === field.value)?.name\n                                  : \"Pilih karyawan...\"}\n                                <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n                              </Button>\n                            </FormControl>\n                          </PopoverTrigger>\n                          <PopoverContent className=\"p-0\">\n                            <Command>\n                              <CommandInput \n                                placeholder=\"Cari karyawan...\" \n                                value={employeeSearchValue}\n                                onValueChange={setEmployeeSearchValue}\n                              />\n                              <CommandEmpty>Karyawan tidak ditemukan.</CommandEmpty>\n                              <CommandGroup>\n                                {employees\n                                  .filter(emp => \n                                    employeeSearchValue === \"\" || \n                                    emp.name.toLowerCase().includes(employeeSearchValue.toLowerCase()) ||\n                                    emp.id.toLowerCase().includes(employeeSearchValue.toLowerCase())\n                                  )\n                                  .slice(0, 10)\n                                  .map((emp) => (\n                                  <CommandItem\n                                    key={emp.id}\n                                    value={emp.id}\n                                    onSelect={() => {\n                                      field.onChange(emp.id);\n                                      setOpenCombobox(false);\n                                      setEmployeeSearchValue(\"\");\n                                    }}\n                                  >\n                                    <Check\n                                      className={cn(\n                                        \"mr-2 h-4 w-4\",\n                                        field.value === emp.id ? \"opacity-100\" : \"opacity-0\"\n                                      )}\n                                    />\n                                    <div>\n                                      <div className=\"font-medium\">{emp.name}</div>\n                                      <div className=\"text-sm text-gray-500\">{emp.id}</div>\n                                    </div>\n                                  </CommandItem>\n                                ))}\n                              </CommandGroup>\n                            </Command>\n                          </PopoverContent>\n                        </Popover>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  \n                  <FormField\n                    control={form.control}\n                    name=\"phoneNumber\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Nomor WhatsApp</FormLabel>\n                        <FormControl>\n                          <Input {...field} placeholder=\"628xxxxxxxxxx\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                \n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"startDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Tanggal Mulai</FormLabel>\n                        <FormControl>\n                          <Input type=\"date\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  \n                  <FormField\n                    control={form.control}\n                    name=\"endDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Tanggal Selesai</FormLabel>\n                        <FormControl>\n                          <Input type=\"date\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                \n                <FormField\n                  control={form.control}\n                  name=\"leaveType\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Jenis Cuti</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Pilih jenis cuti\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"Cuti Tahunan\">Cuti Tahunan</SelectItem>\n                          <SelectItem value=\"Cuti Sakit\">Cuti Sakit</SelectItem>\n                          <SelectItem value=\"Cuti Khusus\">Cuti Khusus</SelectItem>\n                          <SelectItem value=\"Cuti Melahirkan\">Cuti Melahirkan</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <FormField\n                  control={form.control}\n                  name=\"reason\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Alasan Cuti</FormLabel>\n                      <FormControl>\n                        <Textarea {...field} value={field.value || \"\"} placeholder=\"Jelaskan alasan pengajuan cuti...\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                \n                <div className=\"flex justify-end space-x-2\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setEditingRequest(null)}>\n                    Batal\n                  </Button>\n                  <Button type=\"submit\" disabled={updateLeaveMutation.isPending}>\n                    {updateLeaveMutation.isPending ? \"Memperbarui...\" : \"Perbarui\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      )}\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Konfirmasi Hapus</DialogTitle>\n          </DialogHeader>\n          <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n            Apakah Anda yakin ingin menghapus data cuti ini? Tindakan ini tidak dapat dibatalkan.\n          </p>\n          <div className=\"flex justify-end space-x-2 mt-4\">\n            <Button variant=\"outline\" onClick={() => setShowDeleteDialog(false)}>\n              Batal\n            </Button>\n            <Button \n              variant=\"destructive\" \n              onClick={() => requestToDelete && deleteLeaveMutation.mutate(requestToDelete)}\n              disabled={deleteLeaveMutation.isPending}\n            >\n              {deleteLeaveMutation.isPending ? \"Menghapus...\" : \"Hapus\"}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":90473,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":23567,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/pages/landing.tsx":{"content":"import { useState } from 'react';\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Link } from \"wouter\";\nimport { \n  Users, \n  QrCode, \n  Scan, \n  Calendar, \n  FileText, \n  BarChart3, \n  Shield, \n  Clock, \n  CheckCircle,\n  ArrowRight,\n  Monitor,\n  Building2,\n  Target,\n  TrendingUp\n} from \"lucide-react\";\nimport companyLogo from \"@assets/WhatsApp Image 2024-11-30 at 13.08.33_1755505069008.jpeg\";\nimport backgroundImage from \"@assets/background-landing.jpeg\";\n\nconst features = [\n  {\n    icon: QrCode,\n    title: \"QR Code Generator\",\n    description: \"Generate QR codes untuk setiap karyawan dengan keamanan token-based validation\",\n    color: \"bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400\"\n  },\n  {\n    icon: Scan,\n    title: \"QR Scanner\",\n    description: \"Scan QR code untuk absensi real-time dengan validasi shift dan jam kerja\",\n    color: \"bg-green-50 text-green-600 dark:bg-green-900/20 dark:text-green-400\"\n  },\n  {\n    icon: Users,\n    title: \"Manajemen Karyawan\",\n    description: \"Data lengkap karyawan dengan NIK, posisi, departemen, dan investor group\",\n    color: \"bg-purple-50 text-purple-600 dark:bg-purple-900/20 dark:text-purple-400\"\n  },\n  {\n    icon: Calendar,\n    title: \"Roster Kerja\",\n    description: \"Penjadwalan shift karyawan dengan sistem Shift 1 dan Shift 2\",\n    color: \"bg-orange-50 text-orange-600 dark:bg-orange-900/20 dark:text-orange-400\"\n  },\n  {\n    icon: Clock,\n    title: \"Manajemen Cuti\",\n    description: \"Sistem pengajuan, persetujuan, dan monitoring cuti dengan analytics\",\n    color: \"bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-400\"\n  },\n  {\n    icon: Shield,\n    title: \"SIMPER Monitoring\",\n    description: \"Monitoring BIB dan TIA license dengan tracking expiration dates\",\n    color: \"bg-yellow-50 text-yellow-600 dark:bg-yellow-900/20 dark:text-yellow-400\"\n  },\n  {\n    icon: BarChart3,\n    title: \"Dashboard Analytics\",\n    description: \"Real-time statistics, charts, dan performance tracking\",\n    color: \"bg-indigo-50 text-indigo-600 dark:bg-indigo-900/20 dark:text-indigo-400\"\n  },\n  {\n    icon: FileText,\n    title: \"Laporan PDF\",\n    description: \"Generate laporan attendance dengan filter tanggal dan export PDF\",\n    color: \"bg-pink-50 text-pink-600 dark:bg-pink-900/20 dark:text-pink-400\"\n  }\n];\n\nconst stats = [\n  { label: \"Karyawan Aktif\", value: \"306+\", icon: Users },\n  { label: \"QR Codes Generated\", value: \"10K+\", icon: QrCode },\n  { label: \"Attendance Records\", value: \"50K+\", icon: CheckCircle },\n  { label: \"System Uptime\", value: \"99.9%\", icon: TrendingUp }\n];\n\nexport default function Landing() {\n  const [hoveredCard, setHoveredCard] = useState<number | null>(null);\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800\">\n      {/* Header */}\n      <header className=\"border-b bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm sticky top-0 z-50\">\n        <div className=\"container mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"w-10 h-10 bg-primary-600 rounded-lg overflow-hidden flex items-center justify-center\">\n                <img \n                  src={companyLogo} \n                  alt=\"OneTalent GECL Logo\" \n                  className=\"w-full h-full object-cover\"\n                />\n              </div>\n              <div>\n                <h1 className=\"text-xl font-bold text-gray-900 dark:text-white\">OneTalent GECL</h1>\n                <p className=\"text-sm text-gray-600 dark:text-gray-400\">Employee Management System</p>\n              </div>\n            </div>\n            \n            <Link href=\"/workspace\">\n              <Button size=\"lg\" className=\"bg-primary-600 hover:bg-primary-700\">\n                Masuk ke Workspace\n                <ArrowRight className=\"ml-2 w-4 h-4\" />\n              </Button>\n            </Link>\n          </div>\n        </div>\n      </header>\n\n      {/* Hero Section */}\n      <section \n        className=\"relative py-20 px-4 min-h-[80vh] flex items-center\"\n        style={{\n          backgroundImage: `url(${backgroundImage})`,\n          backgroundSize: 'cover',\n          backgroundPosition: 'center',\n          backgroundRepeat: 'no-repeat'\n        }}\n      >\n        {/* Background Overlay */}\n        <div className=\"absolute inset-0 bg-black/50 dark:bg-black/70\"></div>\n        \n        {/* Content */}\n        <div className=\"container mx-auto text-center relative z-10\">\n          <div className=\"max-w-4xl mx-auto\">\n            <Badge variant=\"secondary\" className=\"mb-6 bg-white/90 dark:bg-gray-800/90 text-gray-900 dark:text-white\">\n              <Building2 className=\"w-4 h-4 mr-2\" />\n              PT. GECL - Sistem Manajemen Karyawan Terpadu\n            </Badge>\n            \n            <h1 className=\"text-5xl font-bold text-white mb-6 leading-tight drop-shadow-lg\">\n              Selamat datang di\n              <span className=\"text-primary-400 block\">OneTalent GECL</span>\n            </h1>\n            \n            <p className=\"text-xl text-gray-100 mb-8 leading-relaxed drop-shadow-md\">\n              Platform komprehensif untuk manajemen karyawan dengan QR code attendance, \n              leave management, SIMPER monitoring, dan analytics real-time\n            </p>\n            \n            <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n              <Link href=\"/workspace\">\n                <Button size=\"lg\" className=\"bg-primary-600 hover:bg-primary-700 text-lg px-8 py-3 shadow-xl\">\n                  <Monitor className=\"mr-2 w-5 h-5\" />\n                  Akses Workspace\n                </Button>\n              </Link>\n              <Link href=\"/workspace/scanner\">\n                <Button size=\"lg\" variant=\"outline\" className=\"text-lg px-8 py-3 bg-white/10 border-white text-white hover:bg-white hover:text-gray-900 backdrop-blur-sm\">\n                  <Scan className=\"mr-2 w-5 h-5\" />\n                  Quick Scan\n                </Button>\n              </Link>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      {/* Stats Section */}\n      <section className=\"py-16 px-4 bg-white dark:bg-gray-800\">\n        <div className=\"container mx-auto\">\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-8\">\n            {stats.map((stat, index) => {\n              const IconComponent = stat.icon;\n              return (\n                <div key={index} className=\"text-center\">\n                  <div className=\"w-16 h-16 bg-primary-100 dark:bg-primary-900/30 rounded-full flex items-center justify-center mx-auto mb-4\">\n                    <IconComponent className=\"w-8 h-8 text-primary-600 dark:text-primary-400\" />\n                  </div>\n                  <div className=\"text-3xl font-bold text-gray-900 dark:text-white mb-2\">{stat.value}</div>\n                  <div className=\"text-gray-600 dark:text-gray-400\">{stat.label}</div>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      </section>\n\n      {/* Features Section */}\n      <section className=\"py-20 px-4\">\n        <div className=\"container mx-auto\">\n          <div className=\"text-center mb-16\">\n            <h2 className=\"text-4xl font-bold text-gray-900 dark:text-white mb-4\">\n              Fitur Unggulan\n            </h2>\n            <p className=\"text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto\">\n              Sistem terintegrasi dengan teknologi QR code untuk mengelola semua aspek \n              kepegawaian secara digital dan efisien\n            </p>\n          </div>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n            {features.map((feature, index) => {\n              const IconComponent = feature.icon;\n              return (\n                <Card \n                  key={index}\n                  className={`transition-all duration-300 cursor-pointer ${\n                    hoveredCard === index ? 'transform scale-105 shadow-xl' : 'shadow-lg'\n                  }`}\n                  onMouseEnter={() => setHoveredCard(index)}\n                  onMouseLeave={() => setHoveredCard(null)}\n                >\n                  <CardHeader className=\"pb-3\">\n                    <div className={`w-12 h-12 rounded-lg flex items-center justify-center mb-3 ${feature.color}`}>\n                      <IconComponent className=\"w-6 h-6\" />\n                    </div>\n                    <CardTitle className=\"text-lg\">{feature.title}</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <CardDescription className=\"text-gray-600 dark:text-gray-300\">\n                      {feature.description}\n                    </CardDescription>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        </div>\n      </section>\n\n      {/* CTA Section */}\n      <section className=\"py-20 px-4 bg-primary-600 dark:bg-primary-700\">\n        <div className=\"container mx-auto text-center\">\n          <div className=\"max-w-3xl mx-auto\">\n            <h2 className=\"text-4xl font-bold text-white mb-6\">\n              Siap Mengelola Karyawan dengan Lebih Efisien?\n            </h2>\n            <p className=\"text-xl text-primary-100 mb-8\">\n              Bergabunglah dengan OneTalent GECL dan rasakan kemudahan \n              manajemen karyawan yang terintegrasi dan modern\n            </p>\n            \n            <div className=\"flex flex-col sm:flex-row gap-4 justify-center\">\n              <Link href=\"/workspace\">\n                <Button size=\"lg\" variant=\"secondary\" className=\"text-lg px-8 py-3\">\n                  <Target className=\"mr-2 w-5 h-5\" />\n                  Mulai Sekarang\n                </Button>\n              </Link>\n              <Link href=\"/workspace/dashboard\">\n                <Button size=\"lg\" variant=\"outline\" className=\"text-lg px-8 py-3 border-white text-white hover:bg-white hover:text-primary-600\">\n                  <BarChart3 className=\"mr-2 w-5 h-5\" />\n                  Lihat Dashboard\n                </Button>\n              </Link>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      {/* Footer */}\n      <footer className=\"py-12 px-4 bg-gray-900 dark:bg-gray-950\">\n        <div className=\"container mx-auto\">\n          <div className=\"flex flex-col md:flex-row items-center justify-between\">\n            <div className=\"flex items-center space-x-3 mb-4 md:mb-0\">\n              <div className=\"w-8 h-8 bg-primary-600 rounded-lg overflow-hidden flex items-center justify-center\">\n                <img \n                  src={companyLogo} \n                  alt=\"OneTalent GECL Logo\" \n                  className=\"w-full h-full object-cover\"\n                />\n              </div>\n              <div>\n                <div className=\"text-white font-semibold\">OneTalent GECL</div>\n                <div className=\"text-gray-400 text-sm\">Employee Management System</div>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center space-x-6\">\n              <Link href=\"/workspace/dashboard\" className=\"text-gray-400 hover:text-white transition-colors\">\n                Dashboard\n              </Link>\n              <Link href=\"/workspace/employees\" className=\"text-gray-400 hover:text-white transition-colors\">\n                Karyawan\n              </Link>\n              <Link href=\"/workspace/reports\" className=\"text-gray-400 hover:text-white transition-colors\">\n                Laporan\n              </Link>\n            </div>\n          </div>\n          \n          <div className=\"border-t border-gray-800 mt-8 pt-8 text-center\">\n            <p className=\"text-gray-400\">\n              Â© 2025 OneTalent GECL. All rights reserved. | PT. GECL Employee Management System\n            </p>\n          </div>\n        </div>\n      </footer>\n    </div>\n  );\n}","path":null,"size_bytes":12081,"size_tokens":null},"replit.md":{"content":"# AttendanceQR - Employee Attendance Management System\n\n## Overview\nAttendanceQR is a web-based employee attendance management system that uses QR codes for secure check-ins. Its purpose is to streamline attendance, manage employee data, generate secure QR codes, track attendance, manage work rosters, handle leave requests, and produce comprehensive reports. The system provides real-time monitoring dashboards with visual analytics and robust security through token-based QR code validation, offering a complete solution for workforce management with significant market potential.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### UI/UX Decisions\n- **Frontend Framework**: React with TypeScript (Vite)\n- **UI Kit**: Shadcn/ui (Radix UI)\n- **Styling**: Tailwind CSS (with dark mode support)\n- **Design Principles**: Focus on intuitive interfaces, mobile-first design for specific modules (e.g., Mobile Driver View, SIDAK), and professional presentation in reports (e.g., consistent gray headers, company logos, optimized layouts).\n\n### Technical Implementations\n- **Backend Runtime**: Node.js with Express.js (modular RESTful API)\n- **State Management**: TanStack Query (React Query)\n- **Routing**: Wouter\n- **Forms**: React Hook Form with Zod validation\n- **Data Storage**: PostgreSQL with Drizzle ORM (Neon serverless)\n- **Data Access**: Repository pattern\n- **Authentication**: Token-based QR code validation (employee ID + secret key hashing)\n- **Concurrency**: Optimistic locking with retry mechanism\n- **Caching**: Server-side caching with targeted invalidation\n\n### Feature Specifications\n- **QR Code Workflow**: Generation, secure token embedding, validation, and attendance recording.\n- **Roster Management**: Employee scheduling, bulk/individual Excel uploads, monthly calendar view (desktop & mobile) with shift filtering, color-coded badges, and \"Nomor Lambung\" tracking with fallback logic.\n- **Mobile Driver View**: Dedicated mobile interface with horizontal-scrollable tabs (Roster, Cuti, Pemberitahuan, SIMPER), compact vertical roster lists with infinite scroll, and smart filtering. Includes announcement notification system with unread count badge.\n- **Leave Management**: Request submission, approval workflow, calendar integration, and analytics.\n- **Meeting Management**: Create meetings with QR code attendance, manual entry, photo uploads, and professional PDF reports.\n- **SIDAK (Field Inspection System)**: Mobile-first forms (Fatigue and Roster types) with multi-step wizards, observer verification, digital signatures, and professional, exact-layout PDF exports. Supports QR code scanning for employee data auto-fill and optimized PDF generation. **Riwayat SIDAK per akun** - setiap supervisor hanya melihat SIDAK yang mereka buat, admin dapat melihat semua.\n  - **SIDAK Roster**: QR-based employee entry with real-time shift validation (ensures driver is scheduled for current shift), auto-fill from roster database (Nama, NIK, Roster Sesuai, Hari Kerja from roster.hariKerja column), with only Nomor Lambung editable. Observers input manually (no QR required).\n  - **SIDAK Fatigue**: QR-based employee entry with manual observer input and digital signatures.\n- **Evaluasi Driver**: Monthly driver evaluation dashboard showing SIDAK Fatigue participation. Features include summary cards (Total Driver, Sudah/Belum SIDAK, Total SIDAK), interactive charts (Bar chart for top 10 drivers, Pie chart for status comparison), searchable table with driver details, month/year filter, status filter (Semua/Sudah/Belum SIDAK), and Excel/PDF export functionality.\n- **Reporting System**: Exportable PDF/CSV reports with date range filtering, professional styling, activity photos, and enhanced status indicators.\n- **Real-time Dashboard**: Live attendance statistics, visual charts, and auto-refresh.\n- **Employee Management**: CRUD operations, bulk import via Excel, NIK-based search.\n- **Shift System**: Automatic detection for \"Shift 1\" (06:00-18:00) and \"Shift 2\" (18:00-06:00).\n- **Auto Save**: Draft recovery for forms using local storage.\n- **Announcement System**: Admin-managed announcements for drivers with image attachments. Features include read tracking (who read + timestamp), unread count badge on mobile driver view, admin dashboard with reader statistics per announcement, and PDF export of reader lists with names and timestamps.\n- **News/Berita System**: Company-wide news separate from driver-only announcements. Admin-managed with important news flag for automatic push notification broadcast. API endpoints for CRUD operations.\n- **PWA (Progressive Web App)**: Installable app with manifest.json, service worker for offline caching, and \"Add to Home Screen\" capability for mobile users.\n- **Push Notification System**: Web Push API with VAPID authentication for sending notifications to subscribed users. Features include:\n  - Employee subscription management (subscribe/unsubscribe endpoints)\n  - Test notifications for individual employees\n  - Broadcast notifications to all subscribers\n  - Automatic push for important news\n  - Shift reminders (planned)\n  - Leave status updates (planned)\n  - SIMPER expiry alerts (planned)\n\n## External Dependencies\n- **QR Code Generation**: `qrcode.js`\n- **QR Code Scanning**: `jsQR`\n- **Charts**: `Chart.js`\n- **PDF Generation**: `jsPDF`\n- **Date Handling**: `date-fns`\n- **Camera Access**: Browser MediaDevices API","path":null,"size_bytes":5455,"size_tokens":null},"client/src/pages/employees.tsx":{"content":"import { useState, useRef, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertEmployeeSchema } from \"@shared/schema\";\nimport type { Employee, InsertEmployee } from \"@shared/schema\";\nimport { Plus, Search, Edit, Trash2, Upload, AlertCircle, Download, Eye, QrCode } from \"lucide-react\";\nimport { z } from \"zod\";\nimport * as XLSX from \"xlsx\";\nimport { useAutoSave } from \"@/hooks/useAutoSave\";\nimport { AutoSaveIndicator } from \"@/components/AutoSaveIndicator\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { DriverQRGenerator } from \"@/components/qr/driver-qr-generator\";\nimport QRCode from \"qrcode\";\n\nconst formSchema = insertEmployeeSchema.extend({\n  id: z.string().min(1, \"ID Karyawan harus diisi\"), // ID Karyawan wajib diisi manual\n  position: z.string().optional(),\n  department: z.string().optional(),\n  investorGroup: z.string().optional(),\n});\n\n// Component untuk menampilkan QR Code di kolom\nfunction QRCodeDisplay({ qrData, employeeName }: { qrData: string; employeeName: string }) {\n  const [qrImageUrl, setQrImageUrl] = useState<string>(\"\");\n  const [isViewDialogOpen, setIsViewDialogOpen] = useState(false);\n\n  const generateQRImage = async () => {\n    try {\n      const url = await QRCode.toDataURL(qrData, {\n        width: 200,\n        margin: 2,\n        color: {\n          dark: '#000000',\n          light: '#FFFFFF'\n        }\n      });\n      setQrImageUrl(url);\n      return url;\n    } catch (error) {\n      console.error('Error generating QR code:', error);\n      return null;\n    }\n  };\n\n  const downloadQRCode = async () => {\n    const url = qrImageUrl || await generateQRImage();\n    if (url) {\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `QR_${employeeName.replace(/\\s+/g, '_')}.png`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n    }\n  };\n\n  const viewQRCode = async () => {\n    if (!qrImageUrl) {\n      await generateQRImage();\n    }\n    setIsViewDialogOpen(true);\n  };\n\n  return (\n    <div className=\"flex gap-2\">\n      <Button\n        variant=\"outline\"\n        size=\"sm\"\n        onClick={viewQRCode}\n        className=\"h-8 w-8 p-0\"\n        data-testid={`view-qr-${employeeName}`}\n      >\n        <Eye className=\"w-4 h-4\" />\n      </Button>\n      <Button\n        variant=\"outline\"\n        size=\"sm\"\n        onClick={downloadQRCode}\n        className=\"h-8 w-8 p-0\"\n        data-testid={`download-qr-${employeeName}`}\n      >\n        <Download className=\"w-4 h-4\" />\n      </Button>\n      \n      <Dialog open={isViewDialogOpen} onOpenChange={setIsViewDialogOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>QR Code - {employeeName}</DialogTitle>\n          </DialogHeader>\n          <div className=\"flex flex-col items-center space-y-4\">\n            {qrImageUrl && (\n              <img \n                src={qrImageUrl} \n                alt={`QR Code for ${employeeName}`}\n                className=\"w-64 h-64 border rounded-lg\"\n              />\n            )}\n            <div className=\"flex gap-2\">\n              <Button onClick={downloadQRCode} className=\"flex items-center gap-2\">\n                <Download className=\"w-4 h-4\" />\n                Download QR Code\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\nexport default function Employees() {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [nikFilter, setNikFilter] = useState(\"\");\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingEmployee, setEditingEmployee] = useState<Employee | null>(null);\n  const [isUploadDialogOpen, setIsUploadDialogOpen] = useState(false);\n  const [activeTab, setActiveTab] = useState(\"dashboard\");\n  // Dashboard filters\n  const [dashboardDepartmentFilter, setDashboardDepartmentFilter] = useState(\"all\");\n  const [dashboardPositionFilter, setDashboardPositionFilter] = useState(\"all\");\n  const [dashboardStatusFilter, setDashboardStatusFilter] = useState(\"all\");\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const { toast } = useToast();\n\n  const { data: employees = [], isLoading } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  const form = useForm<z.infer<typeof formSchema>>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      id: \"\", // NIK akan digenerate otomatis di server\n      name: \"\",\n      position: \"\",\n      department: \"\",\n      investorGroup: \"\",\n      phone: \"\",\n      status: \"active\",\n    },\n  });\n\n  // Auto save hook\n  const { saveStatus, clearDraft, hasDraft } = useAutoSave({\n    key: editingEmployee ? `employee_edit_${editingEmployee.id}` : 'employee_new',\n    form,\n    exclude: ['id'], // Don't auto save ID field\n  });\n\n  const createMutation = useMutation<Employee, Error, InsertEmployee>({\n    mutationFn: (data: InsertEmployee) => apiRequest(\"/api/employees\", \"POST\", data),\n    onSuccess: (result) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n      setIsDialogOpen(false);\n      setEditingEmployee(null);\n      form.reset();\n      clearDraft(); // Clear auto saved draft after successful save\n      toast({\n        title: \"Berhasil\",\n        description: `Karyawan ${result.name} (${result.id}) berhasil ditambahkan`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Gagal menambahkan karyawan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation<Employee, Error, { id: string; data: Partial<InsertEmployee> }>({\n    mutationFn: ({ id, data }: { id: string; data: Partial<InsertEmployee> }) =>\n      apiRequest(`/api/employees/${id}`, \"PUT\", data),\n    onSuccess: (result) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n      setIsDialogOpen(false);\n      setEditingEmployee(null);\n      form.reset();\n      clearDraft(); // Clear auto saved draft after successful save\n      toast({\n        title: \"Berhasil\",\n        description: `Data karyawan ${result.name} (${result.id}) berhasil diperbarui`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Gagal memperbarui data karyawan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation<void, Error, string>({\n    mutationFn: (id: string) => apiRequest(`/api/employees/${id}`, \"DELETE\"),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n      toast({\n        title: \"Berhasil\",\n        description: \"Karyawan berhasil dihapus\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Gagal menghapus karyawan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Dashboard statistics\n  const dashboardStats = useMemo(() => {\n    const filteredData = employees.filter((employee) => {\n      const matchesDepartment = dashboardDepartmentFilter === \"\" || dashboardDepartmentFilter === \"all\" || employee.department === dashboardDepartmentFilter;\n      const matchesPosition = dashboardPositionFilter === \"\" || dashboardPositionFilter === \"all\" || employee.position === dashboardPositionFilter;\n      const matchesStatus = dashboardStatusFilter === \"\" || dashboardStatusFilter === \"all\" || employee.status === dashboardStatusFilter;\n      return matchesDepartment && matchesPosition && matchesStatus;\n    });\n\n    const totalEmployees = filteredData.length;\n    const activeEmployees = filteredData.filter(emp => emp.status === 'active').length;\n    const inactiveEmployees = filteredData.filter(emp => emp.status === 'inactive').length;\n    \n    // Position statistics\n    const positionCounts = filteredData.reduce((acc, employee) => {\n      const position = employee.position || 'Unknown';\n      acc[position] = (acc[position] || 0) + 1;\n      return acc;\n    }, {} as Record<string, number>);\n    \n    // Department statistics\n    const departmentCounts = filteredData.reduce((acc, employee) => {\n      const department = employee.department || 'Unknown';\n      acc[department] = (acc[department] || 0) + 1;\n      return acc;\n    }, {} as Record<string, number>);\n    \n    // Investor Group statistics\n    const investorGroupCounts = filteredData.reduce((acc, employee) => {\n      const group = employee.investorGroup || 'Unknown';\n      acc[group] = (acc[group] || 0) + 1;\n      return acc;\n    }, {} as Record<string, number>);\n    \n    const uniquePositions = Object.keys(positionCounts).length;\n    const uniqueDepartments = Object.keys(departmentCounts).length;\n    \n    return {\n      totalEmployees,\n      activeEmployees,\n      inactiveEmployees,\n      uniquePositions,\n      uniqueDepartments,\n      positionCounts,\n      departmentCounts,\n      investorGroupCounts,\n    };\n  }, [employees, dashboardDepartmentFilter, dashboardPositionFilter, dashboardStatusFilter]);\n  \n  // Get unique values for filters\n  const uniquePositionsForFilter = useMemo(() => {\n    const positions = Array.from(new Set(employees.map(emp => emp.position).filter((pos): pos is string => Boolean(pos))));\n    return positions.sort();\n  }, [employees]);\n  \n  const uniqueDepartmentsForFilter = useMemo(() => {\n    const departments = Array.from(new Set(employees.map(emp => emp.department).filter((dept): dept is string => Boolean(dept))));\n    return departments.sort();\n  }, [employees]);\n\n  const filteredEmployees = employees.filter((employee) => {\n    const matchesSearch = employee.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         employee.id.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         (employee.position?.toLowerCase() || \"\").includes(searchTerm.toLowerCase()) ||\n                         (employee.department?.toLowerCase() || \"\").includes(searchTerm.toLowerCase());\n    \n    // Filter by NIK (ID Karyawan)\n    const matchesNik = nikFilter === \"\" || employee.id.toLowerCase().includes(nikFilter.toLowerCase());\n    \n    return matchesSearch && matchesNik;\n  });\n\n  const onSubmit = (values: z.infer<typeof formSchema>) => {\n    console.log('Form submitted with values:', values);\n    if (editingEmployee) {\n      console.log('Updating employee:', editingEmployee.id, 'with data:', values);\n      updateMutation.mutate({ id: editingEmployee.id, data: values });\n    } else {\n      // ID Karyawan diisi manual oleh user\n      console.log('Creating new employee with data:', values);\n      createMutation.mutate(values as InsertEmployee);\n    }\n  };\n\n  const handleEdit = (employee: Employee) => {\n    setEditingEmployee(employee);\n    form.reset({\n      id: employee.id,\n      name: employee.name,\n      position: employee.position || \"\",\n      department: employee.department || \"\",\n      investorGroup: employee.investorGroup || \"\",\n      phone: employee.phone,\n      status: employee.status,\n    });\n    setIsDialogOpen(true);\n  };\n\n  const handleDelete = (id: string) => {\n    if (confirm(\"Apakah Anda yakin ingin menghapus karyawan ini?\")) {\n      deleteMutation.mutate(id);\n    }\n  };\n\n  const generateDriverQR = async (employee: Employee) => {\n    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;\n    const qrType = isMobile ? 'mobile' : 'desktop';\n    const baseUrl = window.location.origin;\n    const targetPath = qrType === 'mobile' ? '/mobile-driver' : '/driver-view';\n    const qrUrl = `${baseUrl}${targetPath}?nik=${encodeURIComponent(employee.id)}`;\n\n    try {\n      const QRCode = (await import('qrcode')).default;\n      \n      const dataURL = await QRCode.toDataURL(qrUrl, {\n        width: 300,\n        margin: 2,\n        color: {\n          dark: '#000000',\n          light: '#FFFFFF'\n        }\n      });\n\n      // Create download link\n      const link = document.createElement('a');\n      link.href = dataURL;\n      link.download = `driver-view-qr-${employee.name.replace(/[^a-zA-Z0-9]/g, '-')}-${qrType}.png`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n\n      toast({\n        title: \"QR Driver View Generated\",\n        description: `QR code untuk Driver View ${employee.name} berhasil didownload`,\n      });\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Gagal membuat QR Driver View\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleNewEmployee = () => {\n    setEditingEmployee(null);\n    form.reset({\n      id: \"\",\n      name: \"\",\n      position: \"\",\n      department: \"\",\n      investorGroup: \"\",\n      phone: \"\",\n      status: \"active\",\n    });\n    setIsDialogOpen(true);\n  };\n\n  const uploadExcelMutation = useMutation<void, Error, InsertEmployee[]>({\n    mutationFn: (employeeData: InsertEmployee[]) => \n      apiRequest(\"/api/employees/bulk\", \"POST\", { employees: employeeData }).then(() => {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n      setIsUploadDialogOpen(false);\n      toast({\n        title: \"Berhasil\",\n        description: \"Data karyawan berhasil diupload\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Gagal mengupload data karyawan\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      try {\n        const data = new Uint8Array(e.target?.result as ArrayBuffer);\n        const workbook = XLSX.read(data, { type: \"array\" });\n        const sheetName = workbook.SheetNames[0];\n        const worksheet = workbook.Sheets[sheetName];\n        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });\n\n        // Skip header row\n        const rows = jsonData.slice(1) as any[][];\n        const employeeData: InsertEmployee[] = rows\n          .filter(row => row.length >= 6 && row[0] && row[1]) // Check required fields\n          .map(row => ({\n            id: row[0]?.toString() || \"\",\n            name: row[1]?.toString() || \"\",\n            position: row[2]?.toString() || \"\",\n            department: row[3]?.toString() || \"\",\n            investorGroup: row[4]?.toString() || \"\",\n            phone: row[5]?.toString() || \"\",\n            status: \"active\",\n          }));\n\n        if (employeeData.length === 0) {\n          toast({\n            title: \"Error\",\n            description: \"File Excel tidak memiliki data yang valid\",\n            variant: \"destructive\",\n          });\n          return;\n        }\n\n        uploadExcelMutation.mutate(employeeData);\n      } catch (error) {\n        toast({\n          title: \"Error\",\n          description: \"Gagal membaca file Excel\",\n          variant: \"destructive\",\n        });\n      }\n    };\n    reader.readAsArrayBuffer(file);\n  };\n\n  const downloadTemplate = () => {\n    const templateData = [\n      [\"NIK\", \"Nama\", \"Posisi\", \"Departemen\", \"Investor Group\", \"No. WhatsApp\"],\n      [\"C-00001\", \"John Doe\", \"Manager\", \"IT\", \"Group A\", \"+628123456789\"],\n      [\"C-00002\", \"Jane Smith\", \"Staff\", \"HR\", \"Group B\", \"+628123456790\"],\n    ];\n\n    const worksheet = XLSX.utils.aoa_to_sheet(templateData);\n    const workbook = XLSX.utils.book_new();\n    XLSX.utils.book_append_sheet(workbook, worksheet, \"Template Karyawan\");\n    XLSX.writeFile(workbook, \"Template_Karyawan.xlsx\");\n  };\n\n  // Dashboard functions\n  const handlePositionClick = (position: string) => {\n    setSearchTerm(position);\n    setActiveTab(\"list\");\n  };\n  \n  const handleDepartmentClick = (department: string) => {\n    setSearchTerm(department);\n    setActiveTab(\"list\");\n  };\n  \n  const clearDashboardFilters = () => {\n    setDashboardDepartmentFilter(\"all\");\n    setDashboardPositionFilter(\"all\");\n    setDashboardStatusFilter(\"all\");\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\">\n          <CardTitle className=\"text-lg sm:text-xl\">Data Karyawan</CardTitle>\n          <div className=\"flex flex-wrap gap-2\">\n            <Button \n              onClick={async () => {\n                try {\n                  const response = await apiRequest(\"/api/qr/update-all\", \"POST\", {});\n                  toast({\n                    title: \"QR Code Update\",\n                    description: response.message || \"Semua QR Code berhasil diupdate ke format URL\",\n                  });\n                  queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n                } catch (error) {\n                  toast({\n                    title: \"Error\",\n                    description: \"Gagal mengupdate QR Code\",\n                    variant: \"destructive\",\n                  });\n                }\n              }}\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"text-xs sm:text-sm\"\n              data-testid=\"update-qr-button\"\n            >\n              <QrCode className=\"w-4 h-4 sm:mr-2\" />\n              <span className=\"hidden sm:inline\">Update QR URL</span>\n            </Button>\n            <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n              <DialogTrigger asChild>\n                <Button onClick={handleNewEmployee} size=\"sm\" className=\"text-xs sm:text-sm\" data-testid=\"add-employee-button\">\n                  <Plus className=\"w-4 h-4 sm:mr-2\" />\n                  <span className=\"hidden sm:inline\">Tambah Karyawan</span>\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"sm:max-w-[425px]\">\n              <DialogHeader>\n                <DialogTitle className=\"flex items-center justify-between\">\n                  <span>{editingEmployee ? \"Edit Karyawan\" : \"Tambah Karyawan\"}</span>\n                  <AutoSaveIndicator status={saveStatus} />\n                </DialogTitle>\n              </DialogHeader>\n              \n              {!editingEmployee && hasDraft() && (\n                <Alert>\n                  <AlertCircle className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    Draft tersimpan otomatis akan dipulihkan. Data yang belum disimpan akan tetap aman.\n                  </AlertDescription>\n                </Alert>\n              )}\n              <Form {...form}>\n                <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"id\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>ID Karyawan</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"C-00001\" \n                            {...field} \n                            disabled={editingEmployee ? true : false}\n                            data-testid=\"employee-id-input\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"name\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Nama Lengkap</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"Nama karyawan\" \n                            {...field} \n                            data-testid=\"employee-name-input\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"position\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Posisi</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"Manager, Staff, dll\" \n                            {...field} \n                            data-testid=\"employee-position-input\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"department\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Departemen</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"HR, IT, Finance, dll\" \n                            {...field} \n                            data-testid=\"employee-department-input\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"investorGroup\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Investor Group</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"Group A, Group B, dll\" \n                            {...field} \n                            data-testid=\"employee-investor-group-input\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"phone\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>No. WhatsApp</FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"+628123456789\" \n                            {...field} \n                            data-testid=\"employee-phone-input\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"status\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Status</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"employee-status-select\">\n                              <SelectValue placeholder=\"Pilih status\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"active\">Aktif</SelectItem>\n                            <SelectItem value=\"inactive\">Tidak Aktif</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <div className=\"flex gap-2\">\n                    <Button \n                      type=\"button\" \n                      variant=\"outline\"\n                      onClick={() => {\n                        setIsDialogOpen(false);\n                        setEditingEmployee(null);\n                        form.reset();\n                      }}\n                      className=\"flex-1\"\n                      data-testid=\"cancel-employee-button\"\n                    >\n                      Batal\n                    </Button>\n                    <Button \n                      type=\"submit\" \n                      className=\"flex-1\"\n                      disabled={createMutation.isPending || updateMutation.isPending}\n                      data-testid=\"submit-employee-button\"\n                    >\n                      {createMutation.isPending || updateMutation.isPending ? \"Menyimpan...\" : (editingEmployee ? \"Update\" : \"Simpan\")}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </DialogContent>\n          </Dialog>\n          </div>\n        </div>\n      </CardHeader>\n      \n      <CardContent>\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n          <TabsList className=\"grid w-full grid-cols-3\">\n            <TabsTrigger value=\"dashboard\" data-testid=\"dashboard-tab\">Dashboard</TabsTrigger>\n            <TabsTrigger value=\"list\" data-testid=\"list-tab\">List</TabsTrigger>\n            <TabsTrigger value=\"qr-generator\" data-testid=\"qr-generator-tab\">QR Generator</TabsTrigger>\n          </TabsList>\n          \n          <TabsContent value=\"dashboard\" className=\"space-y-6 mt-6\">\n            {/* Dashboard Filters */}\n            <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6\">\n              <Select value={dashboardDepartmentFilter} onValueChange={setDashboardDepartmentFilter}>\n                <SelectTrigger data-testid=\"dashboard-department-filter\">\n                  <SelectValue placeholder=\"Semua Department\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Semua Department</SelectItem>\n                  {uniqueDepartmentsForFilter.map(dept => (\n                    <SelectItem key={dept} value={dept}>{dept}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              \n              <Select value={dashboardPositionFilter} onValueChange={setDashboardPositionFilter}>\n                <SelectTrigger data-testid=\"dashboard-position-filter\">\n                  <SelectValue placeholder=\"Semua Posisi\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Semua Posisi</SelectItem>\n                  {uniquePositionsForFilter.map(pos => (\n                    <SelectItem key={pos} value={pos}>{pos}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              \n              <Select value={dashboardStatusFilter} onValueChange={setDashboardStatusFilter}>\n                <SelectTrigger data-testid=\"dashboard-status-filter\">\n                  <SelectValue placeholder=\"Semua Status\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Semua Status</SelectItem>\n                  <SelectItem value=\"active\">Aktif</SelectItem>\n                  <SelectItem value=\"inactive\">Tidak Aktif</SelectItem>\n                </SelectContent>\n              </Select>\n              \n              <Button \n                variant=\"outline\" \n                onClick={clearDashboardFilters}\n                data-testid=\"clear-dashboard-filters\"\n              >\n                Reset Filter\n              </Button>\n            </div>\n            \n            {/* Summary Cards */}\n            <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 sm:gap-4\">\n              <Card>\n                <CardContent className=\"flex items-center p-3 sm:p-6\">\n                  <div className=\"flex items-center space-x-2 sm:space-x-4\">\n                    <div className=\"p-1.5 sm:p-2 bg-blue-100 dark:bg-blue-900 rounded-lg\">\n                      <div className=\"w-3 h-3 sm:w-4 sm:h-4 bg-blue-600 rounded\"></div>\n                    </div>\n                    <div>\n                      <p className=\"text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300\">Total</p>\n                      <p className=\"text-lg sm:text-2xl font-bold text-gray-900 dark:text-white\" data-testid=\"card-total-employees\">\n                        {dashboardStats.totalEmployees}\n                      </p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n              \n              <Card>\n                <CardContent className=\"flex items-center p-3 sm:p-6\">\n                  <div className=\"flex items-center space-x-2 sm:space-x-4\">\n                    <div className=\"p-1.5 sm:p-2 bg-green-100 dark:bg-green-900 rounded-lg\">\n                      <div className=\"w-3 h-3 sm:w-4 sm:h-4 bg-green-600 rounded\"></div>\n                    </div>\n                    <div>\n                      <p className=\"text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300\">Aktif</p>\n                      <p className=\"text-lg sm:text-2xl font-bold text-gray-900 dark:text-white\" data-testid=\"card-active\">\n                        {dashboardStats.activeEmployees}\n                      </p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n              \n              <Card>\n                <CardContent className=\"flex items-center p-3 sm:p-6\">\n                  <div className=\"flex items-center space-x-2 sm:space-x-4\">\n                    <div className=\"p-1.5 sm:p-2 bg-red-100 dark:bg-red-900 rounded-lg\">\n                      <div className=\"w-3 h-3 sm:w-4 sm:h-4 bg-red-600 rounded\"></div>\n                    </div>\n                    <div>\n                      <p className=\"text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300\">Non-Aktif</p>\n                      <p className=\"text-lg sm:text-2xl font-bold text-gray-900 dark:text-white\" data-testid=\"card-inactive\">\n                        {dashboardStats.inactiveEmployees}\n                      </p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n              \n              <Card>\n                <CardContent className=\"flex items-center p-3 sm:p-6\">\n                  <div className=\"flex items-center space-x-2 sm:space-x-4\">\n                    <div className=\"p-1.5 sm:p-2 bg-purple-100 dark:bg-purple-900 rounded-lg\">\n                      <div className=\"w-3 h-3 sm:w-4 sm:h-4 bg-purple-600 rounded\"></div>\n                    </div>\n                    <div>\n                      <p className=\"text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300\">Posisi</p>\n                      <p className=\"text-lg sm:text-2xl font-bold text-gray-900 dark:text-white\" data-testid=\"card-unique-positions\">\n                        {dashboardStats.uniquePositions}\n                      </p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n              \n              <Card className=\"col-span-2 sm:col-span-1\">\n                <CardContent className=\"flex items-center p-3 sm:p-6\">\n                  <div className=\"flex items-center space-x-2 sm:space-x-4\">\n                    <div className=\"p-1.5 sm:p-2 bg-orange-100 dark:bg-orange-900 rounded-lg\">\n                      <div className=\"w-3 h-3 sm:w-4 sm:h-4 bg-orange-600 rounded\"></div>\n                    </div>\n                    <div>\n                      <p className=\"text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-300\">Dept</p>\n                      <p className=\"text-lg sm:text-2xl font-bold text-gray-900 dark:text-white\" data-testid=\"card-unique-departments\">\n                        {dashboardStats.uniqueDepartments}\n                      </p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n            \n            {/* Position and Department Tables */}\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              {/* Position Table */}\n              <Card>\n                <CardHeader>\n                  <CardTitle>Berdasarkan Posisi</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Posisi</TableHead>\n                        <TableHead className=\"text-right\">Jumlah</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {Object.entries(dashboardStats.positionCounts)\n                        .sort(([,a], [,b]) => b - a)\n                        .map(([position, count]) => (\n                        <TableRow \n                          key={position}\n                          className=\"cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800\"\n                          onClick={() => handlePositionClick(position)}\n                          data-testid={`position-row-${position}`}\n                        >\n                          <TableCell className=\"font-medium\">{position}</TableCell>\n                          <TableCell className=\"text-right\">{count}</TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </CardContent>\n              </Card>\n              \n              {/* Department Table */}\n              <Card>\n                <CardHeader>\n                  <CardTitle>Berdasarkan Department</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Department</TableHead>\n                        <TableHead className=\"text-right\">Jumlah</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {Object.entries(dashboardStats.departmentCounts)\n                        .sort(([,a], [,b]) => b - a)\n                        .map(([department, count]) => (\n                        <TableRow \n                          key={department}\n                          className=\"cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800\"\n                          onClick={() => handleDepartmentClick(department)}\n                          data-testid={`department-row-${department}`}\n                        >\n                          <TableCell className=\"font-medium\">{department}</TableCell>\n                          <TableCell className=\"text-right\">{count}</TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </CardContent>\n              </Card>\n            </div>\n            \n            {/* Investor Group Table */}\n            <Card>\n              <CardHeader>\n                <CardTitle>Berdasarkan Investor Group</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Investor Group</TableHead>\n                      <TableHead className=\"text-right\">Jumlah</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {Object.entries(dashboardStats.investorGroupCounts)\n                      .sort(([,a], [,b]) => b - a)\n                      .map(([group, count]) => (\n                      <TableRow \n                        key={group}\n                        data-testid={`investor-group-row-${group}`}\n                      >\n                        <TableCell className=\"font-medium\">{group}</TableCell>\n                        <TableCell className=\"text-right\">{count}</TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </CardContent>\n            </Card>\n          </TabsContent>\n          \n          <TabsContent value=\"list\" className=\"mt-6\">\n        {/* Search and Filter */}\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 space-y-3 sm:space-y-0 sm:space-x-4\">\n          <div className=\"flex-1 relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4\" />\n            <Input\n              placeholder=\"Cari karyawan...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"pl-10\"\n              data-testid=\"search-employees-input\"\n            />\n          </div>\n          <div className=\"w-full sm:w-[180px]\">\n            <Input\n              placeholder=\"Cari NIK...\"\n              value={nikFilter}\n              onChange={(e) => setNikFilter(e.target.value)}\n              data-testid=\"filter-nik-input\"\n            />\n          </div>\n        </div>\n        \n        {/* Mobile Card View - Visible on small screens */}\n        <div className=\"block lg:hidden space-y-3\">\n          {isLoading ? (\n            <div className=\"py-8 text-center text-gray-500 dark:text-gray-400\">\n              Loading...\n            </div>\n          ) : filteredEmployees.length === 0 ? (\n            <div className=\"py-8 text-center text-gray-500 dark:text-gray-400\">\n              Tidak ada data karyawan\n            </div>\n          ) : (\n            filteredEmployees.map((employee) => (\n              <div key={employee.id} className=\"mobile-card\" data-testid={`employee-card-${employee.id}`}>\n                <div className=\"mobile-card-header\">\n                  <div>\n                    <p className=\"mobile-card-title\">{employee.name}</p>\n                    <p className=\"text-xs text-gray-500 dark:text-gray-400\">{employee.id}</p>\n                  </div>\n                  <Badge \n                    variant={employee.status === 'active' ? 'default' : 'secondary'}\n                    className={employee.status === 'active' ? 'status-present' : 'status-pending'}\n                  >\n                    {employee.status === 'active' ? 'Aktif' : 'Tidak Aktif'}\n                  </Badge>\n                </div>\n                <div className=\"space-y-1\">\n                  <div className=\"mobile-card-row\">\n                    <span className=\"mobile-card-label\">Posisi</span>\n                    <span className=\"mobile-card-value\">{employee.position || \"-\"}</span>\n                  </div>\n                  <div className=\"mobile-card-row\">\n                    <span className=\"mobile-card-label\">Departemen</span>\n                    <span className=\"mobile-card-value\">{employee.department || \"-\"}</span>\n                  </div>\n                  <div className=\"mobile-card-row\">\n                    <span className=\"mobile-card-label\">Investor Group</span>\n                    <span className=\"mobile-card-value\">{employee.investorGroup || \"-\"}</span>\n                  </div>\n                  <div className=\"mobile-card-row\">\n                    <span className=\"mobile-card-label\">WhatsApp</span>\n                    <span className=\"mobile-card-value\">{employee.phone || \"-\"}</span>\n                  </div>\n                </div>\n                <div className=\"flex justify-between items-center mt-3 pt-3 border-t border-gray-100 dark:border-gray-700\">\n                  <div>\n                    {employee.qrCode ? (\n                      <QRCodeDisplay qrData={employee.qrCode} employeeName={employee.name} />\n                    ) : (\n                      <Badge variant=\"secondary\">No QR</Badge>\n                    )}\n                  </div>\n                  <div className=\"flex space-x-1\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => generateDriverQR(employee)}\n                      className=\"text-blue-600 hover:text-blue-700 h-9 w-9 p-0\"\n                      title=\"Generate QR Driver View\"\n                      data-testid={`qr-driver-mobile-${employee.id}`}\n                    >\n                      <QrCode className=\"w-4 h-4\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => handleEdit(employee)}\n                      className=\"h-9 w-9 p-0\"\n                      data-testid={`edit-employee-mobile-${employee.id}`}\n                    >\n                      <Edit className=\"w-4 h-4\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => handleDelete(employee.id)}\n                      className=\"text-red-600 hover:text-red-700 h-9 w-9 p-0\"\n                      data-testid={`delete-employee-mobile-${employee.id}`}\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n\n        {/* Desktop Table View - Hidden on small screens */}\n        <div className=\"hidden lg:block overflow-x-auto\">\n          <table className=\"w-full table-auto\">\n            <thead>\n              <tr className=\"border-b border-gray-200 dark:border-gray-700\">\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">ID Karyawan</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Nama</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Position</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Department</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Investor Group</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">WhatsApp</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">QR Code</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Status</th>\n                <th className=\"text-left py-3 px-4 font-medium text-gray-900 dark:text-white\">Aksi</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-gray-200 dark:divide-gray-700\">\n              {isLoading ? (\n                <tr>\n                  <td colSpan={9} className=\"py-8 text-center text-gray-500 dark:text-gray-400\">\n                    Loading...\n                  </td>\n                </tr>\n              ) : filteredEmployees.length === 0 ? (\n                <tr>\n                  <td colSpan={9} className=\"py-8 text-center text-gray-500 dark:text-gray-400\">\n                    Tidak ada data karyawan\n                  </td>\n                </tr>\n              ) : (\n                filteredEmployees.map((employee) => (\n                  <tr key={employee.id} data-testid={`employee-row-${employee.id}`}>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">{employee.id}</td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">{employee.name}</td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">{employee.position || \"-\"}</td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">{employee.department || \"-\"}</td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">{employee.investorGroup || \"-\"}</td>\n                    <td className=\"py-3 px-4 text-sm text-gray-900 dark:text-white\">{employee.phone}</td>\n                    <td className=\"py-3 px-4\">\n                      {employee.qrCode ? (\n                        <QRCodeDisplay qrData={employee.qrCode} employeeName={employee.name} />\n                      ) : (\n                        <Badge variant=\"secondary\">\n                          No QR\n                        </Badge>\n                      )}\n                    </td>\n                    <td className=\"py-3 px-4\">\n                      <Badge \n                        variant={employee.status === 'active' ? 'default' : 'secondary'}\n                        className={employee.status === 'active' ? 'status-present' : 'status-pending'}\n                      >\n                        {employee.status === 'active' ? 'Aktif' : 'Tidak Aktif'}\n                      </Badge>\n                    </td>\n                    <td className=\"py-3 px-4\">\n                      <div className=\"flex space-x-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => generateDriverQR(employee)}\n                          className=\"text-blue-600 hover:text-blue-700\"\n                          title=\"Generate QR Driver View\"\n                          data-testid={`qr-driver-${employee.id}`}\n                        >\n                          <QrCode className=\"w-4 h-4\" />\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => handleEdit(employee)}\n                          data-testid={`edit-employee-${employee.id}`}\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => handleDelete(employee.id)}\n                          className=\"text-red-600 hover:text-red-700\"\n                          data-testid={`delete-employee-${employee.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n        \n        {/* Pagination Info and Upload Excel Button */}\n        <div className=\"flex items-center justify-between mt-6\">\n          <p className=\"text-sm text-gray-500 dark:text-gray-400\">\n            Menampilkan {filteredEmployees.length} dari {employees.length} karyawan\n          </p>\n          <Dialog open={isUploadDialogOpen} onOpenChange={setIsUploadDialogOpen}>\n            <DialogTrigger asChild>\n              <Button variant=\"outline\" className=\"ml-auto\" data-testid=\"upload-excel-button\">\n                <Upload className=\"w-4 h-4 mr-2\" />\n                Upload Excel\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Upload Data Karyawan dari Excel</DialogTitle>\n              </DialogHeader>\n              <div className=\"space-y-4\">\n                <p className=\"text-sm text-gray-600 dark:text-gray-300\">\n                  Upload file Excel dengan format: NIK, Nama, Posisi, Departemen, Investor Group, No. WhatsApp\n                </p>\n                <input\n                  ref={fileInputRef}\n                  type=\"file\"\n                  accept=\".xlsx,.xls\"\n                  className=\"hidden\"\n                  onChange={handleFileUpload}\n                />\n                <Button \n                  onClick={() => fileInputRef.current?.click()}\n                  className=\"w-full\"\n                  data-testid=\"select-excel-file\"\n                >\n                  <Upload className=\"w-4 h-4 mr-2\" />\n                  Pilih File Excel\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  onClick={downloadTemplate}\n                  className=\"w-full\"\n                  data-testid=\"download-template\"\n                >\n                  Download Template Excel\n                </Button>\n              </div>\n            </DialogContent>\n          </Dialog>\n        </div>\n          </TabsContent>\n\n          <TabsContent value=\"qr-generator\" className=\"space-y-6 mt-6\">\n            <DriverQRGenerator />\n          </TabsContent>\n        </Tabs>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":49381,"size_tokens":null},"client/src/App.tsx":{"content":"import { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ThemeProvider } from \"@/hooks/use-theme\";\nimport { AuthProvider } from \"@/lib/auth-context\";\nimport { ProtectedRoute } from \"@/components/ProtectedRoute\";\nimport { RootRedirect } from \"@/components/RootRedirect\";\nimport { Suspense, lazy } from \"react\";\nimport { Route, Switch, useLocation } from \"wouter\";\nimport { LoadingScreen } from \"@/components/ui/loading-screen\";\n\n// Lazy load components for better performance\nconst Workspace = lazy(() => import(\"@/components/workspace\").then(module => ({ default: module.Workspace })));\nconst MobileDriverView = lazy(() => import(\"@/pages/mobile-driver-view\"));\nconst DriverView = lazy(() => import(\"@/pages/driver-view\"));\nconst LoginPage = lazy(() => import(\"@/pages/login\"));\nconst ResetPasswordPage = lazy(() => import(\"@/pages/reset-password\"));\n\n/**\n * Router component dengan landing page dan workspace\n */\nfunction Router() {\n  const [currentPath] = useLocation();\n  const urlParams = new URLSearchParams(window.location.search);\n  \n  // Prioritaskan workspace routes - selalu render Workspace untuk path yang dimulai dengan /workspace\n  // Wrap dengan ProtectedRoute untuk authentication\n  if (currentPath.startsWith('/workspace')) {\n    return (\n      <ProtectedRoute>\n        <Suspense fallback={<LoadingScreen isLoading={true} />}>\n          <Workspace key={currentPath} />\n        </Suspense>\n      </ProtectedRoute>\n    );\n  }\n  \n  return (\n    <Switch>\n      {/* Login Route - Public */}\n      <Route path=\"/login\">\n        {() => (\n          <Suspense fallback={<LoadingScreen isLoading={true} />}>\n            <LoginPage />\n          </Suspense>\n        )}\n      </Route>\n      \n      {/* Reset Password Route - Must be outside workspace but still protected */}\n      <Route path=\"/reset-password\">\n        {() => (\n          <ProtectedRoute>\n            <Suspense fallback={<LoadingScreen isLoading={true} />}>\n              <ResetPasswordPage />\n            </Suspense>\n          </ProtectedRoute>\n        )}\n      </Route>\n      {/* Compact QR Route Handler */}\n      <Route path=\"/q/:token\">\n        {(params) => {\n          // This route will be handled by server-side redirect\n          // But we add this for fallback if needed\n          window.location.reload();\n          return <div>Processing QR code...</div>;\n        }}\n      </Route>\n      \n      {/* Mobile Driver dan Driver View - render langsung tanpa guard */}\n      <Route path=\"/mobile-driver\">\n        {() => (\n          <Suspense fallback={<LoadingScreen isLoading={true} />}>\n            <MobileDriverView />\n          </Suspense>\n        )}\n      </Route>\n      <Route path=\"/mobile-driver/\">\n        {() => (\n          <Suspense fallback={<LoadingScreen isLoading={true} />}>\n            <MobileDriverView />\n          </Suspense>\n        )}\n      </Route>\n      <Route path=\"/driver-view\">\n        {() => (\n          <Suspense fallback={<LoadingScreen isLoading={true} />}>\n            <DriverView />\n          </Suspense>\n        )}\n      </Route>\n      <Route path=\"/driver-view/\">\n        {() => (\n          <Suspense fallback={<LoadingScreen isLoading={true} />}>\n            <DriverView />\n          </Suspense>\n        )}\n      </Route>\n      \n      {/* Meeting Scanner Route */}\n      <Route path=\"/meeting-scanner\">\n        {() => {\n          const token = urlParams.get('token');\n          if (token) {\n            window.location.href = `/workspace/meeting-scanner?token=${token}`;\n          } else {\n            window.location.href = `/workspace/meeting-scanner`;\n          }\n          return <div>Redirecting to meeting scanner...</div>;\n        }}\n      </Route>\n      \n      {/* QR Redirect */}\n      <Route path=\"/qr-redirect\">\n        {() => {\n          const qrData = urlParams.get('data') || urlParams.get('qr');\n          if (qrData) {\n            try {\n              const parsedData = JSON.parse(decodeURIComponent(qrData));\n              \n              // Handle meeting QR codes\n              if (parsedData.type === \"meeting\" && parsedData.token) {\n                window.location.href = `/workspace/meeting-scanner?token=${parsedData.token}`;\n                return <div>Redirecting to meeting scanner...</div>;\n              }\n              \n              // Handle employee attendance QR codes\n              if (parsedData.id) {\n                window.location.href = `/mobile-driver?nik=${parsedData.id}`;\n                return <div>Redirecting to attendance...</div>;\n              }\n            } catch (error) {\n              console.error('Invalid QR data:', error);\n            }\n          }\n          return <div>Invalid QR code data</div>;\n        }}\n      </Route>\n      \n      {/* Root - Redirect based on auth status */}\n      <Route path=\"/\">\n        {() => <RootRedirect />}\n      </Route>\n      \n      {/* Catch-all redirect untuk direct access ke workspace pages */}\n      <Route path=\"/:rest*\">\n        {(params) => {\n          const currentPath = params['rest*'] ? `/${params['rest*']}` : '/';\n          \n          // Jangan redirect halaman publik (driver-view, mobile-driver)\n          if (currentPath === '/driver-view' || currentPath === '/mobile-driver') {\n            return <div>Page not found</div>;\n          }\n          \n          // Redirect ke workspace dengan path yang sama\n          if (currentPath !== '/') {\n            window.location.replace(`/workspace${currentPath}${window.location.search}`);\n            return <div>Redirecting to workspace...</div>;\n          }\n          return <div>Page not found</div>;\n        }}\n      </Route>\n    </Switch>\n  );\n}\n\n/**\n * Aplikasi AttendanceQR - Aplikasi Publik Tanpa Authentication:\n * - Workspace utama berisi semua fitur aplikasi\n * - Mobile driver view untuk QR scan\n * - Driver view untuk tampilan desktop\n */\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider defaultTheme=\"light\" storageKey=\"attendance-theme\">\n        <AuthProvider>\n          <TooltipProvider>\n            <Router />\n            <Toaster />\n          </TooltipProvider>\n        </AuthProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;","path":null,"size_bytes":6365,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/components/layout/header.tsx":{"content":"import { Menu, Sun, Moon, Home, LogOut } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"@/hooks/use-theme\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Link, useLocation } from \"wouter\";\nimport { useState, useEffect } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface HeaderProps {\n  title: string;\n  onMenuClick: () => void;\n}\n\nexport function Header({ title, onMenuClick }: HeaderProps) {\n  const { theme, toggleTheme } = useTheme();\n  const { user, isAuthenticated, logout } = useAuth();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [currentTime, setCurrentTime] = useState(new Date());\n\n  useEffect(() => {\n    const timer = setInterval(() => {\n      setCurrentTime(new Date());\n    }, 1000);\n\n    return () => clearInterval(timer);\n  }, []);\n\n  async function handleLogout() {\n    try {\n      await logout();\n      toast({\n        title: \"Logout Berhasil\",\n        description: \"Sampai jumpa lagi!\",\n      });\n      setLocation(\"/login\");\n    } catch (error) {\n      toast({\n        title: \"Logout Gagal\",\n        description: \"Terjadi kesalahan saat logout\",\n        variant: \"destructive\",\n      });\n    }\n  }\n\n  const formatDate = (date: Date) => {\n    return date.toLocaleDateString('id-ID', {\n      weekday: 'long',\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric'\n    });\n  };\n\n  const formatDateShort = (date: Date) => {\n    return date.toLocaleDateString('id-ID', {\n      day: 'numeric',\n      month: 'short',\n      year: 'numeric'\n    });\n  };\n\n  const formatTime = (date: Date) => {\n    return date.toLocaleTimeString('id-ID', {\n      hour: '2-digit',\n      minute: '2-digit',\n      second: '2-digit'\n    });\n  };\n\n  return (\n    <header className=\"bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 relative z-30\">\n      <div className=\"flex items-center justify-between px-3 sm:px-4 lg:px-6 py-3 lg:py-4\">\n        {/* Left side - Menu + Title */}\n        <div className=\"flex items-center min-w-0 flex-shrink-0\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"lg:hidden flex-shrink-0 h-9 w-9\"\n            onClick={onMenuClick}\n            data-testid=\"menu-button\"\n          >\n            <Menu className=\"w-5 h-5\" />\n          </Button>\n          \n          <div className=\"flex flex-col ml-2 lg:ml-0\">\n            <h1 className=\"text-lg sm:text-xl lg:text-2xl font-semibold text-gray-900 dark:text-white truncate\" data-testid=\"page-title\">\n              OneTalent\n            </h1>\n            {isAuthenticated && user && (\n              <div className=\"hidden lg:block\" data-testid=\"user-greeting\">\n                <p className=\"text-sm font-medium text-gray-600 dark:text-gray-400\">\n                  Hey, <span className=\"font-semibold text-gray-900 dark:text-white\">{user.name}</span>\n                  {user.position && (\n                    <span className=\"ml-1 text-xs text-gray-500 dark:text-gray-400\">\n                      ({user.position})\n                    </span>\n                  )}\n                </p>\n              </div>\n            )}\n          </div>\n        </div>\n        \n        {/* Right side - Date/Time + Actions */}\n        <div className=\"flex items-center gap-2 sm:gap-3 lg:gap-4\">\n          {/* Date/Time - Responsive */}\n          <div className=\"text-right hidden sm:block\" data-testid=\"datetime-display\">\n            <p className=\"text-xs sm:text-sm font-medium text-gray-900 dark:text-white whitespace-nowrap\">\n              <span className=\"hidden md:inline\">{formatDate(currentTime)}</span>\n              <span className=\"md:hidden\">{formatDateShort(currentTime)}</span>\n            </p>\n            <p className=\"text-xs text-gray-500 dark:text-gray-400\">\n              {formatTime(currentTime)}\n            </p>\n          </div>\n          \n          {/* Action Buttons */}\n          <div className=\"flex items-center gap-1 sm:gap-2\">\n            <Link href=\"/\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-8 w-8 sm:h-9 sm:w-9 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600\"\n                title=\"Home\"\n              >\n                <Home className=\"w-4 h-4 sm:w-5 sm:h-5\" />\n              </Button>\n            </Link>\n            \n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={toggleTheme}\n              className=\"h-8 w-8 sm:h-9 sm:w-9 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600\"\n              data-testid=\"theme-toggle\"\n            >\n              {theme === 'dark' ? (\n                <Sun className=\"w-4 h-4 sm:w-5 sm:h-5\" />\n              ) : (\n                <Moon className=\"w-4 h-4 sm:w-5 sm:h-5\" />\n              )}\n            </Button>\n            \n            {isAuthenticated && (\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={handleLogout}\n                className=\"h-8 w-8 sm:h-9 sm:w-9 bg-red-100 dark:bg-red-900 hover:bg-red-200 dark:hover:bg-red-800 text-red-600 dark:text-red-400\"\n                title=\"Logout\"\n                data-testid=\"button-logout\"\n              >\n                <LogOut className=\"w-4 h-4 sm:w-5 sm:h-5\" />\n              </Button>\n            )}\n          </div>\n        </div>\n      </div>\n    </header>\n  );\n}\n","path":null,"size_bytes":5466,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1858,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/pages/reports.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { generateAttendancePDF } from \"@/lib/pdf-utils\";\nimport { exportAttendanceToCSV, exportLeaveToCSV, exportEmployeesToCSV } from \"@/lib/csv-utils\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Employee, AttendanceRecord, LeaveRequest, RosterSchedule } from \"@shared/schema\";\nimport { Download, FileText, Calendar, Users, TrendingUp, RefreshCw, CheckCircle, Upload, X, Camera } from \"lucide-react\";\n\nexport default function Reports() {\n  console.log('ðŸŸ¢ Reports component loading...'); // Debug test\n  \n  const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);\n  const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);\n  const [reportType, setReportType] = useState(\"attendance\");\n  const [format, setFormat] = useState(\"pdf\");\n  const [shiftFilter, setShiftFilter] = useState(\"all\");\n  const [isExporting, setIsExporting] = useState(false);\n  \n  // Activity photos state\n  const [activityPhotos, setActivityPhotos] = useState<{ dataUrl: string; caption: string }[]>([]);\n  \n  // Form fields for report header\n  const [reportInfo, setReportInfo] = useState({\n    perusahaan: \"PT Goden Energi Cemerlang Lestari\",\n    namaPengawas: \"\",\n    hari: new Date().toLocaleDateString('id-ID', { weekday: 'long' }),\n    tanggal: new Date().toLocaleDateString('id-ID'),\n    waktu: \"\",\n    shift: \"\",\n    tempat: \"\",\n    diperiksaOleh: \"\",\n    catatan: \"\",\n    tandaTangan: null as File | string | null\n  });\n  const { toast } = useToast();\n  \n  // Image compression function\n  const compressImage = (file: File): Promise<string> => {\n    return new Promise((resolve, reject) => {\n      const canvas = document.createElement('canvas');\n      const ctx = canvas.getContext('2d');\n      const img = new Image();\n      \n      img.onload = () => {\n        // Calculate new dimensions (max 1600px)\n        const maxDimension = 1600;\n        let { width, height } = img;\n        \n        if (width > height) {\n          if (width > maxDimension) {\n            height = (height * maxDimension) / width;\n            width = maxDimension;\n          }\n        } else {\n          if (height > maxDimension) {\n            width = (width * maxDimension) / height;\n            height = maxDimension;\n          }\n        }\n        \n        canvas.width = width;\n        canvas.height = height;\n        \n        // Draw and compress\n        ctx?.drawImage(img, 0, 0, width, height);\n        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);\n        resolve(compressedDataUrl);\n      };\n      \n      img.onerror = () => reject(new Error('Failed to load image'));\n      img.src = URL.createObjectURL(file);\n    });\n  };\n  \n  // Handle photo upload\n  const handlePhotoUpload = async (files: FileList | null) => {\n    if (!files) return;\n    \n    const newPhotos: { dataUrl: string; caption: string }[] = [];\n    const maxPhotos = 4;\n    const maxFileSize = 1.5 * 1024 * 1024; // 1.5MB per file\n    \n    for (let i = 0; i < Math.min(files.length, maxPhotos - activityPhotos.length); i++) {\n      const file = files[i];\n      \n      // Validate file type\n      if (!file.type.startsWith('image/')) {\n        toast({\n          title: \"File Tidak Valid\",\n          description: `${file.name} bukan file gambar`,\n          variant: \"destructive\",\n        });\n        continue;\n      }\n      \n      try {\n        const compressedDataUrl = await compressImage(file);\n        \n        // Check compressed file size (approximate byte length from base64)\n        const base64String = compressedDataUrl.split(',')[1];\n        const compressedSize = (base64String.length * 3) / 4; // Approximate bytes\n        \n        if (compressedSize > maxFileSize) {\n          toast({\n            title: \"File Terlalu Besar Setelah Kompresi\",\n            description: `${file.name} masih lebih dari 1.5MB setelah dikompres`,\n            variant: \"destructive\",\n          });\n          continue;\n        }\n        \n        newPhotos.push({ dataUrl: compressedDataUrl, caption: '' });\n      } catch (error) {\n        toast({\n          title: \"Error Kompresi\",\n          description: `Gagal memproses ${file.name}`,\n          variant: \"destructive\",\n        });\n      }\n    }\n    \n    if (newPhotos.length > 0) {\n      setActivityPhotos(prev => [...prev, ...newPhotos]);\n      toast({\n        title: \"Foto Berhasil Diupload\",\n        description: `${newPhotos.length} foto ditambahkan`,\n      });\n    }\n  };\n  \n  // Remove photo\n  const removePhoto = (index: number) => {\n    setActivityPhotos(prev => prev.filter((_, i) => i !== index));\n  };\n  \n  // Update photo caption\n  const updateCaption = (index: number, caption: string) => {\n    setActivityPhotos(prev => prev.map((photo, i) => \n      i === index ? { ...photo, caption } : photo\n    ));\n  };\n\n  // Real-time data refresh listener\n  useEffect(() => {\n    let intervalId: NodeJS.Timeout;\n    \n    // Enhanced auto-refresh for reports when roster data changes\n    const startAutoRefresh = () => {\n      intervalId = setInterval(async () => {\n        console.log(\"ðŸ”„ Auto-refreshing report data...\");\n        const { queryClient } = await import(\"@/lib/queryClient\");\n        \n        // Force refresh all report-related data\n        queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/attendance\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/roster\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/leave\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/leave-roster-monitoring\"] });\n      }, 30000); // Every 30 seconds\n    };\n\n    startAutoRefresh();\n\n    return () => {\n      if (intervalId) {\n        clearInterval(intervalId);\n      }\n    };\n  }, []);\n\n  // Check for roster updates\n  const { data: updateStatus } = useQuery({\n    queryKey: [\"/api/report-update-status\"],\n    refetchInterval: 30000,\n  });\n\n  const handleExport = () => {\n    setIsExporting(true);\n    exportReport().finally(() => setIsExporting(false));\n  };\n\n  // Auto-refresh queries every 30 seconds for real-time report updates\n  const { data: employees = [] } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n    refetchInterval: 30000, // 30 seconds\n    refetchIntervalInBackground: true,\n  });\n\n  const { data: attendance = [] } = useQuery<AttendanceRecord[]>({\n    queryKey: [\"/api/attendance\", startDate],\n    queryFn: async () => {\n      const response = await fetch(`/api/attendance?date=${startDate}`);\n      if (!response.ok) throw new Error('Failed to fetch attendance');\n      return response.json();\n    },\n    enabled: reportType === \"attendance\",\n    refetchInterval: 30000, // 30 seconds\n    refetchIntervalInBackground: true,\n  });\n\n  const { data: leaveRequests = [] } = useQuery<LeaveRequest[]>({\n    queryKey: [\"/api/leave\"],\n    enabled: reportType === \"leave\",\n    refetchInterval: 30000, // 30 seconds\n  });\n\n  const { data: roster = [] } = useQuery<RosterSchedule[]>({\n    queryKey: [\"/api/roster\", startDate],\n    queryFn: async () => {\n      const response = await fetch(`/api/roster?date=${startDate}`);\n      if (!response.ok) throw new Error('Failed to fetch roster');\n      return response.json();\n    },\n    enabled: reportType === \"attendance\",\n    refetchInterval: 30000, // 30 seconds\n    refetchIntervalInBackground: true,\n  });\n\n  const exportReport = async () => {\n    if (!startDate || !endDate) {\n      toast({\n        title: \"Error\",\n        description: \"Silakan pilih periode tanggal\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      if (reportType === \"attendance\") {\n        if (!employees || employees.length === 0) {\n          toast({\n            title: \"Error\",\n            description: \"Data karyawan tidak tersedia\",\n            variant: \"destructive\",\n          });\n          return;\n        }\n\n        // Force refresh data before generating report to ensure latest attendance data\n        const { queryClient } = await import(\"@/lib/queryClient\");\n        \n        console.log(\"Refreshing data before generating report...\");\n        \n        // Force refresh all data\n        await queryClient.refetchQueries({ queryKey: [\"/api/attendance\"] });\n        await queryClient.refetchQueries({ queryKey: [\"/api/roster\"] });\n        await queryClient.refetchQueries({ queryKey: [\"/api/employees\"] });\n        \n        // Get fresh data directly from server including leave roster monitoring and employees\n        const [freshAttendance, freshRoster, freshLeaveMonitoring, freshEmployees] = await Promise.all([\n          fetch(`/api/attendance?date=${startDate}`).then(res => res.json()),\n          fetch(`/api/roster?date=${startDate}`).then(res => res.json()),\n          fetch(`/api/leave-roster-monitoring`).then(res => res.json()),\n          fetch(`/api/employees`).then(res => res.json())\n        ]);\n\n        console.log(\"Fresh attendance data:\", freshAttendance);\n        console.log(\"Fresh roster data:\", freshRoster);\n        console.log(\"Fresh employees data (for updated nomor lambung):\", freshEmployees.filter((e: any) => e.nomorLambung !== 'SPARE').slice(0, 3));\n\n        const filteredAttendance = freshAttendance.filter((record: any) => {\n          return record.date >= startDate && record.date <= endDate;\n        });\n\n        // Validate required report information for PDF (both landscape and portrait)\n        if (format === \"pdf\" || format === \"pdf-portrait\") {\n          const requiredFields = [];\n          if (!reportInfo.namaPengawas.trim()) requiredFields.push(\"Nama Pengawas\");\n          if (!reportInfo.waktu.trim()) requiredFields.push(\"Waktu\");\n          if (!reportInfo.shift.trim()) requiredFields.push(\"Shift\");\n          if (!reportInfo.tempat.trim()) requiredFields.push(\"Tempat\");\n          if (!reportInfo.diperiksaOleh.trim()) requiredFields.push(\"Diperiksa Oleh\");\n          \n          if (requiredFields.length > 0) {\n            toast({\n              title: \"Form Tidak Lengkap\",\n              description: `Mohon isi field berikut: ${requiredFields.join(\", \")}`,\n              variant: \"destructive\",\n            });\n            return;\n          }\n\n          // Convert signature file to base64 jika ada\n          let processedReportInfo = { ...reportInfo };\n          if (reportInfo.tandaTangan && reportInfo.tandaTangan instanceof File) {\n            try {\n              const base64 = await new Promise<string>((resolve, reject) => {\n                const reader = new FileReader();\n                reader.onload = () => {\n                  const result = reader.result as string;\n                  // Remove data URL prefix (data:image/jpeg;base64,)\n                  const base64String = result.split(',')[1];\n                  resolve(`data:image/jpeg;base64,${base64String}`);\n                };\n                reader.onerror = reject;\n                reader.readAsDataURL(reportInfo.tandaTangan as File);\n              });\n              processedReportInfo.tandaTangan = base64;\n            } catch (error) {\n              console.error('Error converting signature to base64:', error);\n              // Keep original if conversion fails\n            }\n          }\n\n          await generateAttendancePDF({\n            employees: freshEmployees, // Use fresh employee data to show updated nomor lambung\n            attendance: filteredAttendance,\n            roster: freshRoster,\n            leaveMonitoring: freshLeaveMonitoring,\n            startDate,\n            endDate,\n            reportType: \"attendance\",\n            shiftFilter,\n            reportInfo: processedReportInfo, // Use processed reportInfo with base64 signature\n            orientation: format === \"pdf-portrait\" ? \"portrait\" : \"landscape\", // Professional orientation\n            activityPhotos: activityPhotos.length > 0 ? activityPhotos : undefined // Include activity photos\n          });\n          \n          const orientationText = format === \"pdf-portrait\" ? \"A4 Portrait\" : \"Landscape\";\n          toast({\n            title: \"Berhasil\",\n            description: `Laporan PDF ${orientationText} berhasil diunduh`,\n          });\n        } else {\n          exportAttendanceToCSV(filteredAttendance, freshEmployees); // Use fresh employee data\n          \n          toast({\n            title: \"Berhasil\",\n            description: \"Laporan CSV berhasil diunduh\",\n          });\n        }\n      } else if (reportType === \"leave\") {\n        // Get fresh employees for leave reports too\n        const freshEmployees = await fetch(`/api/employees`).then(res => res.json());\n        \n        if (format === \"csv\") {\n          exportLeaveToCSV(leaveRequests, freshEmployees); // Use fresh employee data\n          \n          toast({\n            title: \"Berhasil\",\n            description: \"Laporan cuti CSV berhasil diunduh\",\n          });\n        } else {\n          toast({\n            title: \"Info\",\n            description: \"Laporan cuti dalam format PDF belum tersedia\",\n          });\n        }\n      } else if (reportType === \"summary\") {\n        // Get fresh employees for summary reports too\n        const freshEmployees = await fetch(`/api/employees`).then(res => res.json());\n        \n        if (format === \"csv\") {\n          exportEmployeesToCSV(freshEmployees); // Use fresh employee data\n          \n          toast({\n            title: \"Berhasil\",\n            description: \"Laporan ringkasan CSV berhasil diunduh\",\n          });\n        } else {\n          toast({\n            title: \"Info\",\n            description: \"Laporan ringkasan dalam format PDF belum tersedia\",\n          });\n        }\n      }\n    } catch (error) {\n      console.error('Export error:', error);\n      toast({\n        title: \"Error\",\n        description: `Gagal mengunduh laporan: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Calculate statistics\n  const totalAttendance = attendance.length;\n  const presentCount = attendance.filter(r => r.status === 'present').length;\n  const attendanceRate = totalAttendance > 0 ? Math.round((presentCount / totalAttendance) * 100) : 0;\n  const totalLeave = leaveRequests.filter(r => r.status === 'approved').length;\n  const pendingLeave = leaveRequests.filter(r => r.status === 'pending').length;\n\n  return (\n    <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n      {/* Export Options */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Export Laporan</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div>\n            <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n              Periode\n            </Label>\n            <div className=\"grid grid-cols-2 gap-2\">\n              <Input\n                type=\"date\"\n                value={startDate}\n                onChange={(e) => setStartDate(e.target.value)}\n                data-testid=\"report-start-date\"\n              />\n              <Input\n                type=\"date\"\n                value={endDate}\n                onChange={(e) => setEndDate(e.target.value)}\n                data-testid=\"report-end-date\"\n              />\n            </div>\n          </div>\n          \n          <div>\n            <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n              Jenis Laporan\n            </Label>\n            <Select value={reportType} onValueChange={setReportType}>\n              <SelectTrigger data-testid=\"report-type-select\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"attendance\">Laporan Absensi</SelectItem>\n                <SelectItem value=\"leave\">Laporan Cuti</SelectItem>\n                <SelectItem value=\"summary\">Laporan Ringkasan</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {reportType === \"attendance\" && (\n            <div>\n              <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                Filter Shift\n              </Label>\n              <Select value={shiftFilter} onValueChange={setShiftFilter}>\n                <SelectTrigger data-testid=\"shift-filter-select\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Semua Shift</SelectItem>\n                  <SelectItem value=\"Shift 1\">Shift 1 saja</SelectItem>\n                  <SelectItem value=\"Shift 2\">Shift 2 saja</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          )}\n\n          {/* Report Information Form */}\n          <div className=\"space-y-4 p-4 border rounded-lg bg-gray-50 dark:bg-gray-800\">\n            <h4 className=\"font-medium text-gray-900 dark:text-white\">Informasi Laporan</h4>\n            \n            <div>\n              <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n                Perusahaan\n              </Label>\n              <Input\n                value={reportInfo.perusahaan}\n                onChange={(e) => setReportInfo(prev => ({...prev, perusahaan: e.target.value}))}\n                placeholder=\"Nama perusahaan\"\n                data-testid=\"input-perusahaan\"\n              />\n            </div>\n\n            <div>\n              <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n                Nama Pengawas\n              </Label>\n              <Input\n                value={reportInfo.namaPengawas}\n                onChange={(e) => setReportInfo(prev => ({...prev, namaPengawas: e.target.value}))}\n                placeholder=\"Nama pengawas\"\n                data-testid=\"input-nama-pengawas\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-2\">\n              <div>\n                <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n                  Waktu\n                </Label>\n                <Input\n                  value={reportInfo.waktu}\n                  onChange={(e) => setReportInfo(prev => ({...prev, waktu: e.target.value}))}\n                  placeholder=\"17:00 - 18:30\"\n                  data-testid=\"input-waktu\"\n                />\n              </div>\n              <div>\n                <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n                  Shift\n                </Label>\n                <Select value={reportInfo.shift} onValueChange={(value) => setReportInfo(prev => ({...prev, shift: value}))}>\n                  <SelectTrigger data-testid=\"select-shift\">\n                    <SelectValue placeholder=\"Pilih Shift\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"Shift 1\">Shift 1</SelectItem>\n                    <SelectItem value=\"Shift 2\">Shift 2</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <div>\n              <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n                Tempat\n              </Label>\n              <Input\n                value={reportInfo.tempat}\n                onChange={(e) => setReportInfo(prev => ({...prev, tempat: e.target.value}))}\n                placeholder=\"Titik Kumpul Workshop GECL\"\n                data-testid=\"input-tempat\"\n              />\n            </div>\n\n            <div>\n              <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n                Diperiksa Oleh\n              </Label>\n              <Input\n                value={reportInfo.diperiksaOleh}\n                onChange={(e) => setReportInfo(prev => ({...prev, diperiksaOleh: e.target.value}))}\n                placeholder=\"Nama pengawas pool\"\n                data-testid=\"input-diperiksa-oleh\"\n              />\n            </div>\n\n            <div>\n              <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n                Catatan\n              </Label>\n              <Input\n                value={reportInfo.catatan || \"\"}\n                onChange={(e) => setReportInfo(prev => ({...prev, catatan: e.target.value}))}\n                placeholder=\"Catatan tambahan (opsional)\"\n                data-testid=\"input-catatan\"\n              />\n            </div>\n\n            <div>\n              <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">\n                Upload Tanda Tangan\n              </Label>\n              <Input\n                type=\"file\"\n                accept=\"image/*\"\n                onChange={(e) => {\n                  const file = e.target.files?.[0] || null;\n                  setReportInfo(prev => ({...prev, tandaTangan: file}));\n                }}\n                data-testid=\"input-tanda-tangan\"\n              />\n              {reportInfo.tandaTangan && (\n                <p className=\"text-xs text-green-600 dark:text-green-400 mt-1\">\n                  File dipilih: {typeof reportInfo.tandaTangan === 'string' ? 'Signature uploaded' : reportInfo.tandaTangan.name}\n                </p>\n              )}\n            </div>\n          </div>\n          \n          {/* Activity Photos Upload */}\n          <div>\n            <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center\">\n              <Camera className=\"w-4 h-4 mr-2\" />\n              Foto Kegiatan (Opsional - Maks 4 foto)\n            </Label>\n            <div className=\"space-y-3\">\n              {/* Upload Button */}\n              <div>\n                <Input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  multiple\n                  onChange={(e) => handlePhotoUpload(e.target.files)}\n                  className=\"hidden\"\n                  id=\"activity-photos-input\"\n                  data-testid=\"input-photos\"\n                  disabled={activityPhotos.length >= 4}\n                />\n                <label\n                  htmlFor=\"activity-photos-input\"\n                  className={`flex items-center justify-center w-full p-4 border-2 border-dashed rounded-lg cursor-pointer transition-colors ${\n                    activityPhotos.length >= 4 \n                      ? 'border-gray-300 bg-gray-100 cursor-not-allowed text-gray-500'\n                      : 'border-blue-300 hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 text-blue-600 dark:text-blue-400'\n                  }`}\n                >\n                  <Upload className=\"w-5 h-5 mr-2\" />\n                  {activityPhotos.length >= 4 \n                    ? 'Maksimal 4 foto tercapai'\n                    : `Pilih foto (${activityPhotos.length}/4)`\n                  }\n                </label>\n              </div>\n              \n              {/* Photo Preview Grid */}\n              {activityPhotos.length > 0 && (\n                <div className=\"grid grid-cols-2 gap-3\">\n                  {activityPhotos.map((photo, index) => (\n                    <div\n                      key={index}\n                      className=\"relative group\"\n                      data-testid={`photo-preview-${index}`}\n                    >\n                      <div className=\"aspect-square rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700\">\n                        <img\n                          src={photo.dataUrl}\n                          alt={`Foto kegiatan ${index + 1}`}\n                          className=\"w-full h-full object-cover\"\n                          data-testid={`img-photo-preview-${index}`}\n                        />\n                      </div>\n                      \n                      {/* Remove button */}\n                      <button\n                        onClick={() => removePhoto(index)}\n                        className=\"absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity\"\n                        data-testid={`button-remove-photo-${index}`}\n                      >\n                        <X className=\"w-3 h-3\" />\n                      </button>\n                      \n                      {/* Caption input */}\n                      <div className=\"mt-1\">\n                        <Input\n                          type=\"text\"\n                          placeholder=\"Keterangan foto (opsional)\"\n                          value={photo.caption}\n                          onChange={(e) => updateCaption(index, e.target.value)}\n                          className=\"text-xs\"\n                          data-testid={`input-caption-${index}`}\n                        />\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n              \n              {activityPhotos.length > 0 && (\n                <p className=\"text-xs text-gray-600 dark:text-gray-400\">\n                  Foto akan ditampilkan di halaman terakhir laporan PDF dalam format 2x2\n                </p>\n              )}\n            </div>\n          </div>\n          \n          <div>\n            <Label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n              Format & Orientasi\n            </Label>\n            <RadioGroup value={format} onValueChange={setFormat} className=\"space-y-2\">\n              <div className=\"flex items-center space-x-2\">\n                <RadioGroupItem value=\"pdf\" id=\"format-pdf\" data-testid=\"format-pdf\" />\n                <Label htmlFor=\"format-pdf\" className=\"text-sm text-gray-700 dark:text-gray-300\">\n                  PDF Landscape (ReportLab Style)\n                </Label>\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                <RadioGroupItem value=\"pdf-portrait\" id=\"format-pdf-portrait\" data-testid=\"format-pdf-portrait\" />\n                <Label htmlFor=\"format-pdf-portrait\" className=\"text-sm text-gray-700 dark:text-gray-300\">\n                  PDF A4 Portrait (Professional)\n                </Label>\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                <RadioGroupItem value=\"csv\" id=\"format-csv\" data-testid=\"format-csv\" />\n                <Label htmlFor=\"format-csv\" className=\"text-sm text-gray-700 dark:text-gray-300\">\n                  CSV\n                </Label>\n              </div>\n            </RadioGroup>\n          </div>\n          \n          <Button \n            onClick={handleExport} \n            className=\"w-full bg-green-600 hover:bg-green-700\"\n            data-testid=\"download-report-button\"\n            disabled={!startDate || !endDate || isExporting}\n          >\n            <Download className=\"w-4 h-4 mr-2\" />\n            {isExporting ? \"Mengunduh...\" : \"Download Laporan\"}\n          </Button>\n        </CardContent>\n      </Card>\n      \n      {/* Report Summary */}\n      <Card className=\"lg:col-span-2\">\n        <CardHeader>\n          <CardTitle>Ringkasan Laporan</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {/* Summary Stats */}\n          <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6\">\n            <div className=\"text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\" data-testid=\"stats-attendance-rate\">\n              <TrendingUp className=\"w-6 h-6 mx-auto mb-2 text-blue-600 dark:text-blue-400\" />\n              <p className=\"text-xl font-semibold text-gray-900 dark:text-white\">{attendanceRate}%</p>\n              <p className=\"text-xs text-gray-600 dark:text-gray-400\">Tingkat Kehadiran</p>\n            </div>\n            <div className=\"text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\" data-testid=\"stats-total-attendance\">\n              <Calendar className=\"w-6 h-6 mx-auto mb-2 text-green-600 dark:text-green-400\" />\n              <p className=\"text-xl font-semibold text-gray-900 dark:text-white\">{totalAttendance}</p>\n              <p className=\"text-xs text-gray-600 dark:text-gray-400\">Total Absensi</p>\n            </div>\n            <div className=\"text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\" data-testid=\"stats-total-employees\">\n              <Users className=\"w-6 h-6 mx-auto mb-2 text-purple-600 dark:text-purple-400\" />\n              <p className=\"text-xl font-semibold text-gray-900 dark:text-white\">{employees.length}</p>\n              <p className=\"text-xs text-gray-600 dark:text-gray-400\">Total Karyawan</p>\n            </div>\n            <div className=\"text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\" data-testid=\"stats-total-leave\">\n              <FileText className=\"w-6 h-6 mx-auto mb-2 text-yellow-600 dark:text-yellow-400\" />\n              <p className=\"text-xl font-semibold text-gray-900 dark:text-white\">{totalLeave}</p>\n              <p className=\"text-xs text-gray-600 dark:text-gray-400\">Total Cuti</p>\n            </div>\n          </div>\n          \n          {/* Recent Reports */}\n          <div>\n            <h4 className=\"font-medium text-gray-900 dark:text-white mb-3\">Laporan Terbaru</h4>\n            <div className=\"space-y-3\">\n              {[\n                {\n                  title: \"Laporan Absensi Bulan Ini\",\n                  description: \"Dibuat hari ini\",\n                  type: \"attendance\",\n                  icon: Calendar\n                },\n                {\n                  title: \"Laporan Cuti Q4 2024\",\n                  description: \"Dibuat 2 hari yang lalu\",\n                  type: \"leave\",\n                  icon: FileText\n                },\n                {\n                  title: \"Laporan Ringkasan Karyawan\",\n                  description: \"Dibuat 1 minggu yang lalu\",\n                  type: \"summary\",\n                  icon: Users\n                }\n              ].map((report, index) => (\n                <div \n                  key={index} \n                  className=\"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg\"\n                  data-testid={`recent-report-${report.type}`}\n                >\n                  <div className=\"flex items-center\">\n                    <report.icon className=\"w-5 h-5 text-gray-600 dark:text-gray-400 mr-3\" />\n                    <div>\n                      <p className=\"text-sm font-medium text-gray-900 dark:text-white\">{report.title}</p>\n                      <p className=\"text-xs text-gray-500 dark:text-gray-400\">{report.description}</p>\n                    </div>\n                  </div>\n                  <Button \n                    variant=\"ghost\" \n                    size=\"sm\"\n                    className=\"text-primary-600 hover:text-primary-700\"\n                    data-testid={`download-recent-${report.type}`}\n                  >\n                    <Download className=\"w-4 h-4 mr-1\" />\n                    Download\n                  </Button>\n                </div>\n              ))}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":31386,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/pages/leave-backup.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ObjectUploader } from \"@/components/ObjectUploader\";\nimport type { UploadResult } from \"@uppy/core\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertLeaveRequestSchema } from \"@shared/schema\";\nimport type { Employee, LeaveRequest, InsertLeaveRequest } from \"@shared/schema\";\nimport { CalendarDays, Clock, CheckCircle, XCircle, Eye, User, Phone } from \"lucide-react\";\nimport { z } from \"zod\";\n\nconst formSchema = insertLeaveRequestSchema.omit({ employeeName: true });\n\nexport default function Leave() {\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n  const [uploadedAttachmentPath, setUploadedAttachmentPath] = useState<string>(\"\");\n  const [isUploading, setIsUploading] = useState(false);\n  const { toast } = useToast();\n\n  const { data: employees = [] } = useQuery<Employee[]>({\n    queryKey: [\"/api/employees\"],\n  });\n\n  const { data: leaveRequests = [], isLoading } = useQuery<LeaveRequest[]>({\n    queryKey: [\"/api/leave\"],\n  });\n\n  const form = useForm<z.infer<typeof formSchema>>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      employeeId: \"\",\n      phoneNumber: \"\",\n      startDate: \"\",\n      endDate: \"\",\n      leaveType: \"\",\n      reason: \"\",\n      status: \"pending\",\n    },\n  });\n\n  // Auto-fill nomor WhatsApp berdasarkan employee selection\n  const selectedEmployeeId = form.watch(\"employeeId\");\n  useEffect(() => {\n    if (selectedEmployeeId && employees.length > 0) {\n      const selectedEmployee = employees.find(emp => emp.id === selectedEmployeeId);\n      if (selectedEmployee) {\n        form.setValue(\"phoneNumber\", selectedEmployee.phone || \"\");\n      }\n    }\n  }, [selectedEmployeeId, employees, form]);\n\n  const createMutation = useMutation({\n    mutationFn: (data: InsertLeaveRequest) => apiRequest(\"/api/leave\", \"POST\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave\"] });\n      form.reset();\n      setUploadedAttachmentPath(\"\");\n      setIsUploading(false);\n      toast({\n        title: \"Berhasil\",\n        description: \"Pengajuan cuti berhasil dibuat\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal membuat pengajuan cuti\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: ({ id, status }: { id: string; status: string }) =>\n      apiRequest(`/api/leave/${id}`, \"PUT\", { status }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/leave\"] });\n      toast({\n        title: \"Berhasil\",\n        description: \"Status cuti berhasil diperbarui\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Gagal memperbarui status cuti\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = async (values: z.infer<typeof formSchema>) => {\n    // Find the selected employee to get their name\n    const selectedEmployee = employees.find(emp => emp.id === values.employeeId);\n    if (!selectedEmployee) {\n      toast({\n        title: \"Error\",\n        description: \"Karyawan tidak ditemukan\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Add attachment path and employee name\n    const submitData = {\n      ...values,\n      employeeName: selectedEmployee.name,\n      attachmentPath: uploadedAttachmentPath || undefined\n    };\n    createMutation.mutate(submitData);\n  };\n\n  const handleGetUploadParameters = async () => {\n    try {\n      setIsUploading(true);\n      const response = await apiRequest(\"/api/objects/upload\", \"POST\");\n      \n      const data = response;\n      console.log('Upload parameters response:', data);\n      return {\n        method: 'PUT' as const,\n        url: data.uploadURL,\n      };\n    } catch (error) {\n      setIsUploading(false);\n      console.error('Error getting upload parameters:', error);\n      toast({\n        title: \"Error\", \n        description: error instanceof Error ? error.message : \"Layanan upload tidak tersedia saat ini\",\n        variant: \"destructive\",\n      });\n      throw error;\n    }\n  };\n\n  const handleUploadComplete = async (result: UploadResult<Record<string, unknown>, Record<string, unknown>>) => {\n    setIsUploading(false);\n    if (result.successful && result.successful.length > 0) {\n      const uploadURL = result.successful[0].uploadURL;\n      if (uploadURL) {\n        // Send the upload URL to server to normalize and set ACL\n        try {\n          const normalizeResponse = await apiRequest(\"/api/objects/normalize\", \"POST\", {\n            uploadURL: uploadURL\n          });\n          const normalizeData = normalizeResponse;\n          const normalizedPath = normalizeData.objectPath;\n          setUploadedAttachmentPath(normalizedPath);\n          toast({\n            title: \"Berhasil\",\n            description: \"File PDF berhasil diupload\",\n          });\n        } catch (normalizeError) {\n          console.error(\"Error normalizing path:\", normalizeError);\n          // Fallback to direct URL if normalize fails\n          setUploadedAttachmentPath(uploadURL);\n          toast({\n            title: \"Berhasil\",\n            description: \"File PDF berhasil diupload\",\n          });\n        }\n      }\n    } else if (result.failed && result.failed.length > 0) {\n      toast({\n        title: \"Error\",\n        description: \"Gagal mengupload file PDF\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const getEmployeeName = (employeeId: string) => {\n    return employees.find(emp => emp.id === employeeId)?.name || 'Unknown';\n  };\n\n  const getLeaveTypeLabel = (type: string) => {\n    const types: { [key: string]: string } = {\n      'annual': 'Cuti Tahunan',\n      'sick': 'Cuti Sakit',\n      'personal': 'Cuti Pribadi',\n      'maternity': 'Cuti Melahirkan'\n    };\n    return types[type] || type;\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'approved':\n        return <Badge className=\"status-present\">Disetujui</Badge>;\n      case 'rejected':\n        return <Badge className=\"status-absent\">Ditolak</Badge>;\n      default:\n        return <Badge className=\"status-pending\">Menunggu</Badge>;\n    }\n  };\n\n  const calculateDays = (startDate: string, endDate: string) => {\n    const start = new Date(startDate);\n    const end = new Date(endDate);\n    const diffTime = Math.abs(end.getTime() - start.getTime());\n    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;\n  };\n\n  const convertToProxyPath = (attachmentPath: string): string => {\n    if (!attachmentPath || !attachmentPath.startsWith(\"https://storage.googleapis.com/\")) {\n      return attachmentPath;\n    }\n    \n    // Extract the object ID from the Google Storage URL\n    const url = new URL(attachmentPath);\n    const pathname = url.pathname;\n    \n    // Find the uploads path\n    const uploadsIndex = pathname.indexOf(\"/.private/uploads/\");\n    if (uploadsIndex !== -1) {\n      const objectId = pathname.substring(uploadsIndex + \"/.private/uploads/\".length);\n      return `/objects/uploads/${objectId}`;\n    }\n    \n    return attachmentPath;\n  };\n\n  const filteredLeaveRequests = leaveRequests.filter(request => \n    statusFilter === \"all\" || request.status === statusFilter\n  );\n\n  const handleApprove = (id: string) => {\n    updateStatusMutation.mutate({ id, status: 'approved' });\n  };\n\n  const handleReject = (id: string) => {\n    updateStatusMutation.mutate({ id, status: 'rejected' });\n  };\n\n  return (\n    <div className=\"container mx-auto p-4 space-y-4\">\n      <div className=\"flex items-center justify-between mb-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900 dark:text-white\">Manajemen Cuti</h1>\n          <p className=\"text-sm text-gray-600 dark:text-gray-400\">Kelola permohonan cuti karyawan</p>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 xl:grid-cols-4 gap-4\">\n        {/* Compact Leave Form */}\n        <Card className=\"xl:col-span-1\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-lg\">Ajukan Cuti</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-3\">\n              <FormField\n                control={form.control}\n                name=\"employeeId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-sm\">Karyawan</FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger className=\"h-9\" data-testid=\"leave-employee-select\">\n                          <SelectValue placeholder=\"-- Pilih Karyawan --\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {employees.map((employee) => (\n                          <SelectItem key={employee.id} value={employee.id}>\n                            {employee.id} - {employee.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"phoneNumber\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-sm\">Nomor WhatsApp</FormLabel>\n                    <FormControl>\n                      <Input \n                        {...field}\n                        className=\"h-9 bg-gray-50 dark:bg-gray-800\"\n                        placeholder=\"Nomor akan terisi otomatis\"\n                        readOnly\n                        data-testid=\"leave-phone-number\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              \n              <FormField\n                control={form.control}\n                name=\"startDate\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-sm\">Tanggal Mulai</FormLabel>\n                    <FormControl>\n                      <Input \n                        type=\"date\" \n                        {...field} \n                        className=\"h-9\"\n                        data-testid=\"leave-start-date-input\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              \n              <FormField\n                control={form.control}\n                name=\"endDate\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-sm\">Tanggal Selesai</FormLabel>\n                    <FormControl>\n                      <Input \n                        type=\"date\" \n                        {...field} \n                        className=\"h-9\"\n                        data-testid=\"leave-end-date-input\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              \n              <FormField\n                control={form.control}\n                name=\"leaveType\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-sm\">Jenis Cuti</FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger className=\"h-9\" data-testid=\"leave-type-select\">\n                          <SelectValue placeholder=\"-- Pilih Jenis Cuti --\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"annual\">Cuti Tahunan</SelectItem>\n                        <SelectItem value=\"sick\">Cuti Sakit</SelectItem>\n                        <SelectItem value=\"personal\">Cuti Pribadi</SelectItem>\n                        <SelectItem value=\"maternity\">Cuti Melahirkan</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              \n              <FormField\n                control={form.control}\n                name=\"reason\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-sm\">Keterangan</FormLabel>\n                    <FormControl>\n                      <Textarea \n                        rows={2} \n                        className=\"resize-none\"\n                        placeholder=\"Keterangan cuti...\" \n                        {...field}\n                        value={field.value || \"\"} \n                        data-testid=\"leave-reason-textarea\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              {/* Compact File Upload */}\n              <div className=\"space-y-2\">\n                <label className=\"text-xs font-medium text-gray-600 dark:text-gray-400\">Lampiran (Opsional)</label>\n                <ObjectUploader\n                  maxNumberOfFiles={1}\n                  maxFileSize={10485760}\n\n                  onGetUploadParameters={handleGetUploadParameters}\n                  onComplete={handleUploadComplete}\n                  buttonClassName=\"w-full h-8 text-xs\"\n                >\n                  ðŸ“Ž Upload PDF\n                </ObjectUploader>\n                {uploadedAttachmentPath && (\n                  <p className=\"text-xs text-green-600 dark:text-green-400\">âœ“ File uploaded</p>\n                )}\n                {isUploading && (\n                  <p className=\"text-xs text-blue-600 dark:text-blue-400\">Uploading...</p>\n                )}\n              </div>\n              \n              <Button \n                type=\"submit\" \n                className=\"w-full h-9\"\n                disabled={createMutation.isPending}\n                data-testid=\"submit-leave-button\"\n              >\n                {createMutation.isPending ? \"Mengajukan...\" : \"Ajukan Cuti\"}\n              </Button>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n      \n      {/* Compact Leave List */}\n      <Card className=\"xl:col-span-3\">\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-lg\">Daftar Cuti</CardTitle>\n            <Select value={statusFilter} onValueChange={setStatusFilter}>\n              <SelectTrigger className=\"w-36 h-9\" data-testid=\"leave-status-filter\">\n                <SelectValue placeholder=\"Semua Status\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Semua Status</SelectItem>\n                <SelectItem value=\"pending\">Menunggu</SelectItem>\n                <SelectItem value=\"approved\">Disetujui</SelectItem>\n                <SelectItem value=\"rejected\">Ditolak</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </CardHeader>\n        \n        <CardContent className=\"p-3\">\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full table-auto text-sm\">\n              <thead>\n                <tr className=\"border-b border-gray-200 dark:border-gray-700\">\n                  <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Karyawan</th>\n                  <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Tanggal</th>\n                  <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Jenis</th>\n                  <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Durasi</th>\n                  <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Lampiran</th>\n                  <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Status</th>\n                  <th className=\"text-left py-2 px-2 font-medium text-gray-900 dark:text-white text-xs\">Aksi</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-gray-200 dark:divide-gray-700\">\n                {isLoading ? (\n                  <tr>\n                    <td colSpan={7} className=\"py-4 text-center text-gray-500 dark:text-gray-400 text-sm\">\n                      Loading...\n                    </td>\n                  </tr>\n                ) : filteredLeaveRequests.length === 0 ? (\n                  <tr>\n                    <td colSpan={7} className=\"py-4 text-center text-gray-500 dark:text-gray-400 text-sm\">\n                      Tidak ada data cuti\n                    </td>\n                  </tr>\n                ) : (\n                  filteredLeaveRequests.map((request) => (\n                    <tr key={request.id} data-testid={`leave-row-${request.id}`}>\n                      <td className=\"py-2 px-2 text-xs text-gray-900 dark:text-white\">\n                        <div className=\"font-medium\">{getEmployeeName(request.employeeId)}</div>\n                      </td>\n                      <td className=\"py-2 px-2 text-xs text-gray-900 dark:text-white\">\n                        <div>{new Date(request.startDate).toLocaleDateString('id-ID')}</div>\n                        <div className=\"text-gray-500\">-</div>\n                        <div>{new Date(request.endDate).toLocaleDateString('id-ID')}</div>\n                      </td>\n                      <td className=\"py-2 px-2 text-xs text-gray-900 dark:text-white\">\n                        {getLeaveTypeLabel(request.leaveType)}\n                      </td>\n                      <td className=\"py-2 px-2 text-xs text-gray-900 dark:text-white text-center\">\n                        <span className=\"font-medium\">{calculateDays(request.startDate, request.endDate)}</span> hari\n                      </td>\n                      <td className=\"py-2 px-2 text-xs text-center\">\n                        {request.attachmentPath ? (\n                          <a \n                            href={convertToProxyPath(request.attachmentPath)} \n                            target=\"_blank\" \n                            rel=\"noopener noreferrer\"\n                            className=\"text-red-600 hover:text-red-700 dark:text-red-400 text-xs\"\n                            title=\"Lihat lampiran PDF\"\n                          >\n                            ðŸ“Ž\n                          </a>\n                        ) : (\n                          <span className=\"text-gray-400 dark:text-gray-500\">-</span>\n                        )}\n                      </td>\n                      <td className=\"py-2 px-2\">\n                        {getStatusBadge(request.status)}\n                      </td>\n                      <td className=\"py-2 px-2\">\n                        {request.status === 'pending' ? (\n                          <div className=\"flex flex-col space-y-1\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => handleApprove(request.id)}\n                              disabled={updateStatusMutation.isPending}\n                              className=\"text-green-600 hover:text-green-700 h-7 text-xs\"\n                              data-testid={`approve-leave-${request.id}`}\n                            >\n                              <CheckCircle className=\"w-3 h-3 mr-1\" />\n                              Setujui\n                            </Button>\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => handleReject(request.id)}\n                              disabled={updateStatusMutation.isPending}\n                              className=\"text-red-600 hover:text-red-700 h-7 text-xs\"\n                              data-testid={`reject-leave-${request.id}`}\n                            >\n                              <XCircle className=\"w-3 h-3 mr-1\" />\n                              Tolak\n                            </Button>\n                          </div>\n                        ) : (\n                          <Dialog>\n                            <DialogTrigger asChild>\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                className=\"text-blue-600 hover:text-blue-700 h-7 text-xs\"\n                                data-testid={`detail-leave-${request.id}`}\n                              >\n                                <Eye className=\"w-3 h-3 mr-1\" />\n                                Detail\n                              </Button>\n                            </DialogTrigger>\n                            <DialogContent className=\"max-w-md\">\n                              <DialogHeader>\n                                <DialogTitle>Detail Pengajuan Cuti</DialogTitle>\n                              </DialogHeader>\n                              <div className=\"space-y-4\">\n                                <div className=\"flex items-center space-x-2\">\n                                  <User className=\"w-4 h-4 text-gray-500\" />\n                                  <div>\n                                    <p className=\"font-medium\">{request.employeeName || getEmployeeName(request.employeeId)}</p>\n                                    <p className=\"text-sm text-gray-500\">{request.employeeId}</p>\n                                  </div>\n                                </div>\n                                \n                                {request.phoneNumber && (\n                                  <div className=\"flex items-center space-x-2\">\n                                    <Phone className=\"w-4 h-4 text-gray-500\" />\n                                    <p className=\"text-sm\">{request.phoneNumber}</p>\n                                  </div>\n                                )}\n                                \n                                <div className=\"flex items-center space-x-2\">\n                                  <CalendarDays className=\"w-4 h-4 text-gray-500\" />\n                                  <div>\n                                    <p className=\"text-sm\">\n                                      {new Date(request.startDate).toLocaleDateString('id-ID', {\n                                        weekday: 'long',\n                                        year: 'numeric',\n                                        month: 'long',\n                                        day: 'numeric'\n                                      })}\n                                    </p>\n                                    <p className=\"text-sm\">s/d</p>\n                                    <p className=\"text-sm\">\n                                      {new Date(request.endDate).toLocaleDateString('id-ID', {\n                                        weekday: 'long',\n                                        year: 'numeric',\n                                        month: 'long',\n                                        day: 'numeric'\n                                      })}\n                                    </p>\n                                  </div>\n                                </div>\n                                \n                                <div className=\"flex items-center space-x-2\">\n                                  <Clock className=\"w-4 h-4 text-gray-500\" />\n                                  <div>\n                                    <p className=\"text-sm font-medium\">{getLeaveTypeLabel(request.leaveType)}</p>\n                                    <p className=\"text-sm text-gray-500\">\n                                      Durasi: {calculateDays(request.startDate, request.endDate)} hari\n                                    </p>\n                                  </div>\n                                </div>\n                                \n                                {request.reason && (\n                                  <div>\n                                    <p className=\"font-medium text-sm mb-1\">Keterangan:</p>\n                                    <p className=\"text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg\">\n                                      {request.reason}\n                                    </p>\n                                  </div>\n                                )}\n\n                                {request.attachmentPath && (\n                                  <div>\n                                    <p className=\"font-medium text-sm mb-2\">Lampiran Dokumen:</p>\n                                    <a \n                                      href={convertToProxyPath(request.attachmentPath)} \n                                      target=\"_blank\" \n                                      rel=\"noopener noreferrer\"\n                                      className=\"flex items-center space-x-2 text-red-600 hover:text-red-700 dark:text-red-400 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                                    >\n                                      <span>ðŸ“Ž</span>\n                                      <span className=\"text-sm\">Lihat File PDF</span>\n                                    </a>\n                                  </div>\n                                )}\n                                \n                                <div className=\"flex items-center justify-between pt-4 border-t\">\n                                  <span className=\"text-sm text-gray-500\">Status:</span>\n                                  {getStatusBadge(request.status)}\n                                </div>\n                                \n                                {request.status === 'pending' && (\n                                  <div className=\"flex space-x-2 pt-2\">\n                                    <Button\n                                      size=\"sm\"\n                                      onClick={() => handleApprove(request.id)}\n                                      disabled={updateStatusMutation.isPending}\n                                      className=\"flex-1 bg-green-600 hover:bg-green-700\"\n                                    >\n                                      <CheckCircle className=\"w-4 h-4 mr-1\" />\n                                      Setujui\n                                    </Button>\n                                    <Button\n                                      size=\"sm\"\n                                      variant=\"destructive\"\n                                      onClick={() => handleReject(request.id)}\n                                      disabled={updateStatusMutation.isPending}\n                                      className=\"flex-1\"\n                                    >\n                                      <XCircle className=\"w-4 h-4 mr-1\" />\n                                      Tolak\n                                    </Button>\n                                  </div>\n                                )}\n                              </div>\n                            </DialogContent>\n                          </Dialog>\n                        )}\n                      </td>\n                    </tr>\n                  ))\n                )}\n              </tbody>\n            </table>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":28808,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":1901,"size_tokens":null},"client/src/components/qr/qr-scanner.tsx":{"content":"import { useState, useRef, useCallback, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { validateQRData } from \"@/lib/crypto-utils\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { determineShiftByTime, getCurrentShift } from \"@/lib/shift-utils\";\nimport { Camera, CameraOff, CheckCircle, User, Clock, XCircle, Moon, Heart, Activity, Calendar, Truck } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport jsQR from \"jsqr\";\n\ninterface ScanResult {\n  employeeId: string;\n  name: string;\n  nomorLambung?: string;\n  isSpareOrigin?: boolean;\n  scanTime: string;\n  roster?: any; // Add roster data for nomor lambung update\n  status?: 'validated' | 'processing' | 'success' | 'error';\n  errorMessage?: string;\n}\n\ninterface AttendanceFormData {\n  jamTidur: string;\n  fitToWork: string;\n  nomorLambung?: string;\n}\n\ninterface RecentActivity {\n  id: string;\n  employeeId: string;\n  employeeName: string;\n  time: string;\n  jamTidur: string;\n  fitToWork: string;\n  status: string;\n  createdAt: string;\n  workingDays: number;\n}\n\n\nexport function QRScanner() {\n  const [isScanning, setIsScanning] = useState(false);\n  const [scanResult, setScanResult] = useState<ScanResult | null>(null);\n  const [stream, setStream] = useState<MediaStream | null>(null);\n  const [attendanceForm, setAttendanceForm] = useState<AttendanceFormData>({\n    jamTidur: '',\n    fitToWork: '',\n    nomorLambung: ''\n  });\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [lastScanTime, setLastScanTime] = useState<number>(0);\n  const [showEditNomorLambungDialog, setShowEditNomorLambungDialog] = useState(false);\n  const [newNomorLambung, setNewNomorLambung] = useState('');\n  const [editingRoster, setEditingRoster] = useState<{\n    id: string;\n    actualNomorLambung: string | null;\n    plannedNomorLambung: string | null;\n    employeeId: string;\n    date: string;\n  } | null>(null); // Persist roster snapshot saat dialog dibuka (architect: full snapshot prevents undefined values)\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const scanningRef = useRef(false);\n  const { toast } = useToast();\n\n  // Query untuk mengambil aktivitas terbaru\n  const today = new Date().toISOString().split('T')[0];\n  const { data: recentActivities, refetch: refetchActivities } = useQuery<RecentActivity[]>({\n    queryKey: [\"/api/dashboard/recent-activities\", today],\n    queryFn: async () => {\n      const response = await fetch(`/api/dashboard/recent-activities?date=${today}`, {\n        cache: 'no-cache',\n        headers: { 'Cache-Control': 'no-cache' }\n      });\n      if (!response.ok) throw new Error('Failed to fetch activities');\n      return response.json();\n    },\n    staleTime: 0,\n    refetchOnWindowFocus: true,\n    refetchInterval: 30000, // Auto-refresh setiap 30 detik\n  });\n\n  // Listen untuk perubahan roster data dan clear scan result jika ada\n  useEffect(() => {\n    const handleRosterChange = () => {\n      if (scanResult) {\n        setScanResult(null);\n        toast({\n          title: \"Data Roster Berubah\",\n          description: \"Silakan scan QR code lagi untuk mendapatkan data roster terbaru\",\n          variant: \"default\",\n        });\n      }\n    };\n\n    // Subscribe to roster query changes\n    const unsubscribe = queryClient.getQueryCache().subscribe((event) => {\n      if (event.type === 'updated' && \n          event.query.queryKey[0] === '/api/roster' &&\n          scanResult) {\n        handleRosterChange();\n      }\n    });\n\n    return () => unsubscribe();\n  }, [scanResult, toast]);\n\n\n  const startScanning = async () => {\n    try {\n      // Reset states for fresh start\n      setIsProcessing(false);\n      setLastScanTime(0);\n      \n      const mediaStream = await navigator.mediaDevices.getUserMedia({\n        video: { \n          facingMode: 'environment',\n          width: { ideal: 1280 },\n          height: { ideal: 720 }\n        }\n      });\n      \n      setStream(mediaStream);\n      setIsScanning(true);\n      scanningRef.current = true;\n      setScanResult(null);\n      setAttendanceForm({ jamTidur: '', fitToWork: '', nomorLambung: '' });\n      \n      if (videoRef.current) {\n        videoRef.current.srcObject = mediaStream;\n        videoRef.current.play();\n        // Start scanning after video is ready\n        videoRef.current.onloadedmetadata = () => {\n          console.log(\"Camera ready, starting QR detection...\");\n          requestAnimationFrame(scanQRCode);\n        };\n      }\n    } catch (error) {\n      console.error(\"Camera error:\", error);\n      toast({\n        title: \"Error Kamera\",\n        description: \"Gagal mengakses kamera. Pastikan browser memiliki izin kamera dan reload halaman.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const stopScanning = () => {\n    scanningRef.current = false;\n    setIsScanning(false);\n    \n    if (stream) {\n      stream.getTracks().forEach(track => track.stop());\n      setStream(null);\n    }\n    \n    if (videoRef.current) {\n      videoRef.current.srcObject = null;\n    }\n  };\n\n  const scanQRCode = useCallback(() => {\n    if (!scanningRef.current || !videoRef.current || !canvasRef.current) {\n      return;\n    }\n\n    const video = videoRef.current;\n    const canvas = canvasRef.current;\n    const context = canvas.getContext('2d');\n    \n    if (!context || video.readyState !== video.HAVE_ENOUGH_DATA) {\n      if (scanningRef.current) {\n        requestAnimationFrame(scanQRCode); // Only continue if still scanning\n      }\n      return;\n    }\n\n    // Optimize canvas size for faster processing\n    const maxWidth = 480; // Reduced for faster processing\n    const maxHeight = 360;\n    const videoAspectRatio = video.videoWidth / video.videoHeight;\n    \n    let canvasWidth = Math.min(video.videoWidth, maxWidth);\n    let canvasHeight = canvasWidth / videoAspectRatio;\n    \n    if (canvasHeight > maxHeight) {\n      canvasHeight = maxHeight;\n      canvasWidth = canvasHeight * videoAspectRatio;\n    }\n    \n    canvas.width = canvasWidth;\n    canvas.height = canvasHeight;\n    context.drawImage(video, 0, 0, canvasWidth, canvasHeight);\n    \n    const imageData = context.getImageData(0, 0, canvasWidth, canvasHeight);\n    const code = jsQR(imageData.data, imageData.width, imageData.height, {\n      inversionAttempts: \"attemptBoth\", // Try both modes for better detection\n    });\n    \n    if (code) {\n      // Debounce QR code detection to prevent multiple scans (reduced to 500ms)\n      const now = Date.now();\n      if (now - lastScanTime < 500) { // 500ms cooldown for responsiveness\n        requestAnimationFrame(scanQRCode);\n        return;\n      }\n      setLastScanTime(now);\n      \n      console.log(\"ðŸ” RAW QR Code detected:\", code.data);\n      console.log(\"ðŸ” QR Code length:\", code.data?.length || 0);\n      console.log(\"ðŸ” QR Code type:\", typeof code.data);\n      \n      // Check for empty or whitespace data\n      if (!code.data || code.data.trim() === '') {\n        console.log(\"âš ï¸ Empty QR data detected, continuing scan...\");\n        requestAnimationFrame(scanQRCode);\n        return;\n      }\n      \n      console.log(\"ðŸ” QR Code first 200 chars:\", code.data.substring(0, 200));\n      \n      // Check if this is a Driver View URL format first\n      // Format: https://domain.com/driver-view?nik=C-025660\n      let employeeIdFromUrl: string | null = null;\n      if (code.data.includes('/driver-view?nik=') || code.data.includes('?nik=')) {\n        try {\n          const url = new URL(code.data);\n          const nik = url.searchParams.get('nik');\n          if (nik) {\n            employeeIdFromUrl = nik;\n            console.log(\"ðŸ” Driver View QR detected, NIK:\", nik);\n          }\n        } catch (e) {\n          // Not a valid URL, continue with token-based validation\n          console.log(\"âš ï¸ URL parsing failed, trying token-based validation\");\n        }\n      }\n\n      // Process based on QR type\n      if (employeeIdFromUrl) {\n        // Stop scanning first\n        stopScanning();\n        // Process Driver View QR code (no token validation needed)\n        console.log(\"Processing Driver View QR for attendance:\", employeeIdFromUrl);\n        validateDriverViewQR(employeeIdFromUrl);\n      } else {\n        // Try token-based QR validation\n        const qrData = validateQRData(code.data);\n        console.log(\"ðŸ” Validated QR Data:\", qrData);\n        if (qrData) {\n          // Stop scanning first\n          stopScanning();\n          \n          // Process attendance QR code\n          console.log(\"Processing QR for attendance:\", qrData);\n          validateAndProcess(qrData.id, qrData.token);\n        } else {\n          console.log(\"QR validation failed for data:\", code.data);\n          // Don't show toast for every invalid scan, just continue scanning\n          // Only show once every 3 seconds to avoid spam\n          const lastToastTime = localStorage.getItem('lastInvalidQRToast');\n          if (!lastToastTime || now - parseInt(lastToastTime) > 3000) {\n            toast({\n              title: \"QR Code Tidak Valid\",\n              description: \"âŒ Pastikan QR Code dari sistem resmi\",\n              variant: \"destructive\",\n            });\n            localStorage.setItem('lastInvalidQRToast', now.toString());\n          }\n        }\n      }\n    }\n    \n    // Continue scanning if still active\n    if (scanningRef.current && !isProcessing) {\n      requestAnimationFrame(scanQRCode);\n    }\n  }, [toast]);\n\n  const validateDriverViewQR = async (employeeId: string) => {\n    // Prevent multiple simultaneous validations\n    if (isProcessing) return;\n    \n    try {\n      setIsProcessing(true);\n      const result = await apiRequest(\"/api/attendance/validate-employee\", \"POST\", {\n        employeeId\n      });\n      \n      if (result.valid) {\n        const currentTime = new Date().toLocaleTimeString('id-ID', {\n          hour: '2-digit',\n          minute: '2-digit'\n        });\n        \n        // Always display roster time and shift if available\n        let displayTime;\n        if (result.roster) {\n          displayTime = `${result.roster.startTime} - ${result.roster.endTime} (${result.roster.shift})`;\n        } else {\n          // Fallback to current time with detected shift\n          const shift = determineShiftByTime(currentTime);\n          displayTime = `${currentTime} (${shift})`;\n        }\n        \n        const employeeData = {\n          employeeId: result.employee.id,\n          name: result.employee.name,\n          nomorLambung: result.employee.nomorLambung,\n          isSpareOrigin: result.employee.isSpareOrigin || false,\n          scanTime: displayTime,\n          roster: result.roster,\n          status: 'processing' as const\n        };\n        \n        setScanResult({ ...employeeData, status: 'validated' });\n        stopScanning(); // Stop scanning after successful validation\n        \n        // Show time validation warning if any\n        if (result.timeValidation?.warning) {\n          toast({\n            title: \"QR Code Valid - Peringatan Waktu\",\n            description: result.timeValidation.warning,\n            variant: \"destructive\",\n          });\n        } else if (result.roster) {\n          toast({\n            title: \"Driver View QR Valid\",\n            description: `âœ… Data valid untuk ${result.employee.name}. Shift: ${result.roster.shift}. Silakan isi data absensi.`,\n          });\n        } else {\n          toast({\n            title: \"Driver View QR Valid - Peringatan\",\n            description: `âš ï¸ Data valid untuk ${result.employee.name}, tetapi tidak ada roster hari ini. Silakan hubungi admin.`,\n            variant: \"destructive\",\n          });\n        }\n      }\n    } catch (error) {\n      toast({\n        title: \"Validasi Gagal\",\n        description: \"âŒ Data karyawan tidak valid atau tidak terdaftar\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const validateAndProcess = async (employeeId: string, token: string) => {\n    // Prevent multiple simultaneous validations\n    if (isProcessing) return;\n    \n    try {\n      setIsProcessing(true);\n      const result = await apiRequest(\"/api/qr/validate\", \"POST\", {\n        employeeId,\n        token\n      });\n      \n      if (result.valid) {\n        const currentTime = new Date().toLocaleTimeString('id-ID', {\n          hour: '2-digit',\n          minute: '2-digit'\n        });\n        \n        // Always display roster time and shift if available\n        let displayTime;\n        if (result.roster) {\n          displayTime = `${result.roster.startTime} - ${result.roster.endTime} (${result.roster.shift})`;\n        } else {\n          // Fallback to current time with detected shift\n          const shift = determineShiftByTime(currentTime);\n          displayTime = `${currentTime} (${shift})`;\n        }\n        \n        const employeeData = {\n          employeeId: result.employee.id,\n          name: result.employee.name,\n          nomorLambung: result.employee.nomorLambung,\n          isSpareOrigin: result.employee.isSpareOrigin || false,\n          scanTime: displayTime,\n          roster: result.roster,\n          status: 'processing' as const\n        };\n        \n        setScanResult({ ...employeeData, status: 'validated' });\n        stopScanning(); // Stop scanning after successful validation\n        \n        // Show time validation warning if any\n        if (result.timeValidation?.warning) {\n          toast({\n            title: \"QR Code Valid - Peringatan Waktu\",\n            description: result.timeValidation.warning,\n            variant: \"destructive\",\n          });\n        } else if (result.roster) {\n          toast({\n            title: \"QR Code Valid\",\n            description: `âœ… QR Code valid untuk ${result.employee.name}. Shift: ${result.roster.shift}. Silakan isi data absensi.`,\n          });\n        } else {\n          toast({\n            title: \"QR Code Valid - Peringatan\",\n            description: `âš ï¸ QR Code valid untuk ${result.employee.name}, tetapi tidak ada roster hari ini. Silakan hubungi admin.`,\n            variant: \"destructive\",\n          });\n        }\n      }\n    } catch (error) {\n      toast({\n        title: \"Validasi Gagal\",\n        description: \"âŒ QR Code tidak valid atau karyawan tidak terdaftar\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const proceedAfterAttendance = () => {\n    // Reset form and clear scan result after 3 seconds\n    setTimeout(() => {\n      setScanResult(null);\n      setAttendanceForm({ jamTidur: '', fitToWork: '', nomorLambung: '' });\n      // Restart scanning for next QR\n      if (videoRef.current && !scanningRef.current) {\n        startScanning();\n      }\n    }, 3000);\n  };\n\n  const updateNomorLambung = async () => {\n    // ARCHITECT FIX: Use persistent editingRoster instead of volatile scanResult\n    if (!editingRoster?.id) {\n      toast({\n        title: \"Data Roster Tidak Ditemukan\",\n        description: \"Silakan refresh halaman dan coba lagi. Jika masalah berlanjut, hubungi administrator.\",\n        variant: \"destructive\",\n      });\n      setShowEditNomorLambungDialog(false);\n      setEditingRoster(null); // Clear roster snapshot\n      proceedAfterAttendance();\n      return;\n    }\n\n    if (!newNomorLambung || newNomorLambung.trim() === '') {\n      toast({\n        title: \"Nomor Lambung Kosong\",\n        description: \"Silakan isi nomor lambung atau klik 'Lewati' untuk melanjutkan tanpa update.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    try {\n      setIsProcessing(true);\n      // Use editingRoster.id (persisted snapshot) instead of scanResult.roster.id\n      await apiRequest(`/api/roster/${editingRoster.id}/update-nomor-lambung`, \"PATCH\", {\n        actualNomorLambung: newNomorLambung\n      });\n\n      toast({\n        title: \"Berhasil\",\n        description: `Nomor lambung berhasil diupdate menjadi ${newNomorLambung}`,\n      });\n\n      // Invalidate roster cache\n      queryClient.invalidateQueries({ queryKey: [\"/api/roster\"] });\n      \n      setShowEditNomorLambungDialog(false);\n      setEditingRoster(null); // Clear roster snapshot after success\n      proceedAfterAttendance();\n    } catch (error: any) {\n      toast({\n        title: \"Gagal Update\",\n        description: error.message || \"Gagal mengupdate nomor lambung. Silakan coba lagi.\",\n        variant: \"destructive\",\n      });\n      // ARCHITECT FIX: Keep editingRoster populated so user can retry (don't clear on error)\n      // Only clear when dialog definitively closed (skip button or success)\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const skipNomorLambungEdit = () => {\n    setShowEditNomorLambungDialog(false);\n    setEditingRoster(null); // Clear roster snapshot when skipping\n    proceedAfterAttendance();\n  };\n\n  const processAttendance = async () => {\n    if (!scanResult || !attendanceForm.jamTidur || !attendanceForm.fitToWork || \n        (scanResult.nomorLambung === 'SPARE' && !attendanceForm.nomorLambung)) {\n      toast({\n        title: \"Data Tidak Lengkap\",\n        description: scanResult?.nomorLambung === 'SPARE' \n          ? \"Silakan isi jam tidur, status fit to work, dan nomor lambung baru\"\n          : \"Silakan isi jam tidur dan status fit to work\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsProcessing(true);\n    setScanResult(prev => prev ? { ...prev, status: 'processing' } : null);\n    try {\n      const now = new Date();\n      const today = now.toISOString().split('T')[0];\n      // Format waktu konsisten HH:MM:SS untuk database (menggunakan waktu lokal sistem)\n      const currentTime = now.toTimeString().split(' ')[0]; // Menggunakan format HH:MM:SS yang konsisten\n\n      console.log(\"Processing attendance for:\", scanResult.name);\n\n      const attendanceData: any = {\n        employeeId: scanResult.employeeId,\n        date: today,\n        time: currentTime,\n        jamTidur: attendanceForm.jamTidur,\n        fitToWork: attendanceForm.fitToWork,\n        status: \"present\"\n      };\n      \n      // Jika nomor lambung SPARE, sertakan nomor lambung baru\n      if (scanResult.nomorLambung === 'SPARE' && attendanceForm.nomorLambung) {\n        attendanceData.nomorLambungBaru = attendanceForm.nomorLambung;\n      }\n\n      const response = await fetch(\"/api/attendance\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(attendanceData)\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({ message: \"Unknown error\" }));\n        throw new Error(errorData.message || `HTTP ${response.status}`);\n      }\n\n      // Update status to success and reset processing\n      setScanResult(prev => {\n        const updated = prev ? { ...prev, status: 'success' as const } : null;\n        console.log(\"ðŸ“¦ Attendance success - scanResult roster:\", updated?.roster);\n        return updated;\n      });\n      setIsProcessing(false); // Reset processing state immediately\n      \n      toast({\n        title: \"Absensi Berhasil\",\n        description: `âœ… Absensi berhasil dicatat untuk ${scanResult.name}`,\n      });\n\n      // Show edit nomor lambung dialog if roster exists (optional edit)\n      // ARCHITECT FIX: Persist roster snapshot and stop scanning to prevent race conditions\n      if (scanResult.roster?.id) {\n        console.log(\"âœ… Roster found, showing edit dialog. Roster ID:\", scanResult.roster.id);\n        \n        // Persist full roster snapshot (prevents loss if scanResult changes)\n        setEditingRoster({\n          id: scanResult.roster.id,\n          actualNomorLambung: scanResult.roster.actualNomorLambung,\n          plannedNomorLambung: scanResult.roster.plannedNomorLambung,\n          employeeId: scanResult.roster.employeeId,\n          date: scanResult.roster.date,\n        });\n        \n        const currentNomorLambung = scanResult.roster.actualNomorLambung || scanResult.roster.plannedNomorLambung || scanResult.nomorLambung || '';\n        setNewNomorLambung(currentNomorLambung);\n        \n        // Stop scanning while dialog is open (prevent concurrent scans)\n        stopScanning();\n        \n        setShowEditNomorLambungDialog(true);\n      } else {\n        console.log(\"âš ï¸ No roster found, skipping edit dialog\");\n        // If no roster, proceed with normal flow\n        proceedAfterAttendance();\n      }\n\n      // Faster cache invalidation - do it in background\n      Promise.all([\n        queryClient.invalidateQueries({ queryKey: [\"/api/attendance\"] }),\n        queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] }),\n        queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/attendance-details\"] }),\n        queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/recent-activities\"] }),\n        queryClient.invalidateQueries({ queryKey: [\"/api/roster\"] }),\n        queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] }), // Invalidate employees untuk nomor lambung update\n        refetchActivities() // Refresh recent activities immediately\n      ]).catch(console.error); // Don't block UI for cache updates\n\n      // Force refetch roster dengan delay untuk memastikan data employee sudah terupdate\n      if (attendanceForm.nomorLambung) {\n        console.log(`ðŸ”„ Force refetching roster after nomor lambung update for ${scanResult.name}`);\n        queryClient.invalidateQueries({ queryKey: [\"/api/roster\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/employees\"] });\n      }\n      \n    } catch (error: any) {\n      console.error(\"Auto attendance error:\", error);\n      // Immediately reset processing state on error\n      setIsProcessing(false);\n      \n      let errorMessage = \"Gagal memproses absensi\";\n      let errorTitle = \"Error\";\n      \n      const errorMsg = error?.message || String(error);\n      \n      if (errorMsg) {\n        const message = errorMsg.toLowerCase();\n        \n        if (message.includes(\"sudah melakukan absensi\")) {\n          errorTitle = \"Sudah Absen Hari Ini\";\n          errorMessage = `${scanResult.name} sudah melakukan absensi pada hari ini`;\n        } else if (message.includes(\"tidak dijadwalkan\")) {\n          errorTitle = \"Tidak Dijadwalkan\";\n          errorMessage = `${scanResult.name} tidak dijadwalkan bekerja hari ini`;\n        } else if (message.includes(\"tidak ditemukan\")) {\n          errorTitle = \"Karyawan Tidak Ditemukan\";\n          errorMessage = `Data karyawan ${scanResult.name} tidak ditemukan`;\n        } else if (message.includes(\"tidak sesuai dengan jadwal shift\") || message.includes(\"absensi ditolak\") || message.includes(\"diluar jam kerja\") || message.includes(\"tidak sesuai shift\")) {\n          errorTitle = \"âŒ ABSENSI DITOLAK\";\n          errorMessage = errorMsg; // Use the full detailed message from server\n        } else if (message.includes(\"shift yang berbeda\")) {\n          errorTitle = \"Shift Tidak Sesuai\";\n          errorMessage = `Waktu check-in tidak sesuai dengan shift yang dijadwalkan untuk ${scanResult.name}`;\n        } else {\n          errorTitle = \"Gagal Memproses\";\n          errorMessage = errorMsg;\n        }\n      }\n      \n      // Update status to error with message\n      setScanResult(prev => prev ? { ...prev, status: 'error', errorMessage } : null);\n      \n      toast({\n        title: errorTitle,\n        description: `âŒ ${errorMessage}`,\n        variant: \"destructive\",\n      });\n      \n      // Immediately reset processing state to unblock UI\n      setIsProcessing(false);\n      \n      // Clear scan result after error to allow retry\n      setTimeout(() => {\n        setScanResult(null);\n        // Resume scanning after error\n        if (videoRef.current && !scanningRef.current) {\n          startScanning();\n        }\n      }, 2000);\n    }\n  };\n\n\n\n  const currentShift = getCurrentShift();\n  const currentTime = new Date().toLocaleTimeString('id-ID', {\n    hour: '2-digit',\n    minute: '2-digit'\n  });\n\n  return (\n    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n      {/* Camera Scanner */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Scan QR Code</CardTitle>\n          <div className=\"text-sm text-gray-600 dark:text-gray-400\">\n            Waktu sekarang: {currentTime} â€¢ {currentShift}\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"relative\">\n            <video \n              ref={videoRef}\n              className=\"w-full h-64 bg-gray-100 dark:bg-gray-700 rounded-lg object-cover\"\n              autoPlay\n              muted\n              playsInline\n              data-testid=\"scanner-video\"\n            />\n            <canvas ref={canvasRef} className=\"hidden\" />\n            \n            {isScanning && (\n              <div className=\"absolute inset-0 border-2 border-primary-500 rounded-lg opacity-50 pointer-events-none\">\n                <div className=\"absolute top-4 left-4 w-6 h-6 border-t-4 border-l-4 border-primary-500\"></div>\n                <div className=\"absolute top-4 right-4 w-6 h-6 border-t-4 border-r-4 border-primary-500\"></div>\n                <div className=\"absolute bottom-4 left-4 w-6 h-6 border-b-4 border-l-4 border-primary-500\"></div>\n                <div className=\"absolute bottom-4 right-4 w-6 h-6 border-b-4 border-r-4 border-primary-500\"></div>\n              </div>\n            )}\n          </div>\n          \n          <div className=\"flex space-x-2\">\n            <Button \n              onClick={startScanning} \n              disabled={isScanning || isProcessing}\n              className=\"flex-1\"\n              data-testid=\"start-scanner-button\"\n            >\n              <Camera className=\"w-4 h-4 mr-2\" />\n              {isScanning ? \"Scanning...\" : isProcessing ? \"Memproses...\" : \"Mulai Scan\"}\n            </Button>\n            <Button \n              onClick={stopScanning} \n              disabled={!isScanning}\n              variant=\"destructive\"\n              className=\"flex-1\"\n              data-testid=\"stop-scanner-button\"\n            >\n              <CameraOff className=\"w-4 h-4 mr-2\" />\n              Stop Scan\n            </Button>\n          </div>\n          \n          {isScanning && !isProcessing && (\n            <div className=\"text-sm text-center text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 p-2 rounded\">\n              ðŸ“± Arahkan kamera ke QR Code untuk melakukan scan\n              <div className=\"text-xs mt-1 text-blue-500\">\n                âš ï¸ Absensi hanya diizinkan pada jam kerja: Shift 1 (04:00-10:00) â€¢ Shift 2 (16:00-22:00)\n              </div>\n            </div>\n          )}\n          \n          {isProcessing && (\n            <div className=\"text-sm text-center text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/30 p-2 rounded\">\n              â³ Memvalidasi QR Code...\n            </div>\n          )}\n        </CardContent>\n      </Card>\n      \n      {/* Scan Result */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Hasil Scan</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {!scanResult ? (\n            <div className=\"text-center py-8\" data-testid=\"scan-placeholder\">\n              <div className=\"w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4\">\n                <Camera className=\"w-8 h-8 text-gray-400\" />\n              </div>\n              <p className=\"text-gray-500 dark:text-gray-400\">Siap untuk scan QR Code</p>\n            </div>\n          ) : (\n            <div className=\"space-y-4\" data-testid=\"scan-result\">\n              <div className={`p-4 border rounded-lg ${\n                scanResult.status === 'processing' \n                  ? 'bg-blue-50 dark:bg-blue-900 border-blue-200 dark:border-blue-700'\n                  : scanResult.status === 'success'\n                  ? 'bg-green-50 dark:bg-green-900 border-green-200 dark:border-green-700'\n                  : scanResult.status === 'error'\n                  ? 'bg-red-50 dark:bg-red-900 border-red-200 dark:border-red-700'\n                  : 'bg-green-50 dark:bg-green-900 border-green-200 dark:border-green-700'\n              }`}>\n                <div className=\"flex items-center\">\n                  {scanResult.status === 'processing' ? (\n                    <>\n                      <div className=\"w-5 h-5 mr-2 animate-spin rounded-full border-2 border-blue-300 border-t-blue-600\"></div>\n                      <span className=\"text-blue-800 dark:text-blue-200 font-medium\">Memproses Absensi...</span>\n                    </>\n                  ) : scanResult.status === 'success' ? (\n                    <>\n                      <CheckCircle className=\"w-5 h-5 text-green-600 dark:text-green-300 mr-2\" />\n                      <span className=\"text-green-800 dark:text-green-200 font-medium\">Absensi Berhasil</span>\n                    </>\n                  ) : scanResult.status === 'error' ? (\n                    <>\n                      <XCircle className=\"w-5 h-5 text-red-600 dark:text-red-300 mr-2\" />\n                      <span className=\"text-red-800 dark:text-red-200 font-medium\">Gagal Memproses</span>\n                    </>\n                  ) : (\n                    <>\n                      <CheckCircle className=\"w-5 h-5 text-green-600 dark:text-green-300 mr-2\" />\n                      <span className=\"text-green-800 dark:text-green-200 font-medium\">QR Code Valid</span>\n                    </>\n                  )}\n                </div>\n                {scanResult.status === 'error' && scanResult.errorMessage && (\n                  <div className=\"mt-2\">\n                    <p className=\"text-sm text-red-600 dark:text-red-300\">{scanResult.errorMessage}</p>\n                  </div>\n                )}\n              </div>\n              \n              <div className=\"space-y-3\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">\n                    <User className=\"w-4 h-4 inline mr-1\" />\n                    ID Karyawan\n                  </label>\n                  <p className=\"text-lg font-semibold text-gray-900 dark:text-white\" data-testid=\"scanned-employee-id\">\n                    {scanResult.employeeId}\n                  </p>\n                </div>\n                \n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">Nama</label>\n                  <p className=\"text-lg font-semibold text-gray-900 dark:text-white\" data-testid=\"scanned-employee-name\">\n                    {scanResult.name}\n                  </p>\n                </div>\n                \n                {scanResult.nomorLambung && (\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">Nomor Lambung</label>\n                    <p className=\"text-lg font-semibold text-gray-900 dark:text-white\" data-testid=\"scanned-nomor-lambung\">\n{scanResult.isSpareOrigin && scanResult.nomorLambung !== \"SPARE\" ? \n                        `SPARE ${scanResult.nomorLambung}` : (scanResult.nomorLambung || '-')\n                      }\n                    </p>\n                  </div>\n                )}\n                \n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">\n                    <Clock className=\"w-4 h-4 inline mr-1\" />\n                    Waktu & Shift\n                  </label>\n                  <p className=\"text-lg font-semibold text-gray-900 dark:text-white\" data-testid=\"scan-time\">\n                    {scanResult.scanTime}\n                  </p>\n                </div>\n              </div>\n              \n              {/* Form pengisian jam tidur dan fit to work - tampil setelah QR valid */}\n              {scanResult.status === 'validated' && (\n                <div className=\"space-y-4 border-t pt-4\">\n                  <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white\">\n                    Form Absensi\n                  </h3>\n                  \n                  <div className=\"grid grid-cols-1 gap-4\">\n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                        Jam Tidur <span className=\"text-red-500\">*</span>\n                      </label>\n                      <select\n                        value={attendanceForm.jamTidur}\n                        onChange={(e) => setAttendanceForm(prev => ({ ...prev, jamTidur: e.target.value }))}\n                        className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\n                        data-testid=\"jam-tidur-select\"\n                        required\n                      >\n                        <option value=\"\">Pilih jam tidur</option>\n                        <option value=\"4\">4</option>\n                        <option value=\"5\">5</option>\n                        <option value=\"6\">6</option>\n                        <option value=\"7\">7</option>\n                        <option value=\"8\">8</option>\n                        <option value=\"8+\">8+</option>\n                      </select>\n                    </div>\n                    \n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                        Status Fit To Work <span className=\"text-red-500\">*</span>\n                      </label>\n                      <select\n                        value={attendanceForm.fitToWork}\n                        onChange={(e) => setAttendanceForm(prev => ({ ...prev, fitToWork: e.target.value }))}\n                        className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\n                        data-testid=\"fit-to-work-select\"\n                        required\n                      >\n                        <option value=\"\">Pilih status</option>\n                        <option value=\"Fit To Work\">Fit To Work</option>\n                        <option value=\"Unfit To Work\">Unfit To Work</option>\n                      </select>\n                    </div>\n                    \n                    {/* Field Nomor Lambung - hanya tampil jika nomor lambung adalah SPARE */}\n                    {scanResult.nomorLambung === 'SPARE' && (\n                      <div>\n                        <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                          Nomor Lambung Baru <span className=\"text-red-500\">*</span>\n                        </label>\n                        <Input\n                          type=\"text\"\n                          value={attendanceForm.nomorLambung || ''}\n                          onChange={(e) => setAttendanceForm(prev => ({ ...prev, nomorLambung: e.target.value }))}\n                          placeholder=\"Masukkan nomor lambung baru\"\n                          className=\"w-full\"\n                          data-testid=\"nomor-lambung-input\"\n                          required={scanResult.nomorLambung === 'SPARE'}\n                        />\n                      </div>\n                    )}\n                  </div>\n                  \n                  <Button \n                    onClick={processAttendance}\n                    disabled={\n                      !attendanceForm.jamTidur || \n                      !attendanceForm.fitToWork || \n                      isProcessing ||\n                      (scanResult.nomorLambung === 'SPARE' && !attendanceForm.nomorLambung)\n                    }\n                    className=\"w-full\"\n                    data-testid=\"process-attendance-button\"\n                  >\n                    {isProcessing ? (\n                      <>\n                        <div className=\"w-4 h-4 mr-2 animate-spin rounded-full border-2 border-white border-t-transparent\"></div>\n                        Memproses...\n                      </>\n                    ) : (\n                      'Proses Absensi'\n                    )}\n                  </Button>\n                </div>\n              )}\n              \n              {/* Show action buttons based on status */}\n              {(scanResult.status === 'success' || scanResult.status === 'error') && (\n                <Button \n                  onClick={() => {\n                    setScanResult(null);\n                    setAttendanceForm({ jamTidur: '', fitToWork: '', nomorLambung: '' });\n                  }} \n                  className=\"w-full\"\n                  variant={scanResult.status === 'error' ? 'destructive' : 'default'}\n                  data-testid=\"scan-again-button\"\n                >\n                  {scanResult.status === 'error' ? 'Coba Lagi' : 'Scan Lagi'}\n                </Button>\n              )}\n              \n              {scanResult.status === 'processing' && (\n                <div className=\"text-center py-2\">\n                  <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                    Sedang memproses absensi, harap tunggu...\n                  </p>\n                </div>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Recent Activities Card */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center\">\n            <Activity className=\"w-5 h-5 mr-2\" />\n            Aktivitas Absensi Terbaru\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {recentActivities?.length === 0 ? (\n            <div className=\"text-center py-8\" data-testid=\"no-activities\">\n              <div className=\"w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4\">\n                <Activity className=\"w-8 h-8 text-gray-400\" />\n              </div>\n              <p className=\"text-gray-500 dark:text-gray-400\">Belum ada aktivitas absensi hari ini</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3\" data-testid=\"recent-activities-list\">\n              {recentActivities?.slice(0, 5).map((activity) => (\n                <div \n                  key={activity.id} \n                  className=\"flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg border\"\n                  data-testid={`activity-${activity.employeeId}`}\n                >\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center space-x-2\">\n                      <div className=\"w-2 h-2 bg-green-500 rounded-full\"></div>\n                      <span className=\"font-medium text-sm text-gray-900 dark:text-white\">\n                        {activity.employeeName}\n                      </span>\n                      <span className=\"text-xs text-gray-500 dark:text-gray-400\">\n                        ({activity.employeeId})\n                      </span>\n                    </div>\n                    <div className=\"flex items-center space-x-3 mt-1 text-xs text-gray-600 dark:text-gray-300\">\n                      <span className=\"flex items-center\">\n                        <Clock className=\"w-3 h-3 mr-1\" />\n                        {activity.time}\n                      </span>\n                      <span className=\"flex items-center\">\n                        <Moon className=\"w-3 h-3 mr-1\" />\n                        {activity.jamTidur} jam\n                      </span>\n                      <span className=\"flex items-center\">\n                        <Heart className=\"w-3 h-3 mr-1\" />\n                        {activity.fitToWork}\n                      </span>\n                      <span className=\"flex items-center\">\n                        <Calendar className=\"w-3 h-3 mr-1\" />\n                        Hari ke-{activity.workingDays}\n                      </span>\n                    </div>\n                  </div>\n                  <div className=\"flex flex-col items-end\">\n                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${\n                      activity.status === 'present' \n                        ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'\n                        : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'\n                    }`}>\n                      {activity.status === 'present' ? 'Hadir' : activity.status}\n                    </span>\n                    <span className=\"text-xs text-gray-500 dark:text-gray-400 mt-1\">\n                      {new Date(activity.createdAt).toLocaleTimeString('id-ID', {\n                        hour: '2-digit',\n                        minute: '2-digit'\n                      })}\n                    </span>\n                  </div>\n                </div>\n              ))}\n              \n              {recentActivities && recentActivities.length > 5 && (\n                <div className=\"text-center pt-2\">\n                  <p className=\"text-sm text-gray-500 dark:text-gray-400\">\n                    Menampilkan 5 dari {recentActivities.length} aktivitas hari ini\n                  </p>\n                </div>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Edit Nomor Lambung Dialog - Optional after check-in */}\n      <Dialog open={showEditNomorLambungDialog} onOpenChange={setShowEditNomorLambungDialog}>\n        <DialogContent data-testid=\"edit-nomor-lambung-dialog\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center\">\n              <Truck className=\"w-5 h-5 mr-2\" />\n              Update Nomor Lambung\n            </DialogTitle>\n            <DialogDescription>\n              Ada perubahan nomor lambung hari ini? Update di sini (opsional)\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"nomor-lambung-edit\">Nomor Lambung Saat Ini:</Label>\n              <Input\n                id=\"nomor-lambung-edit\"\n                data-testid=\"input-nomor-lambung-edit\"\n                value={newNomorLambung}\n                onChange={(e) => setNewNomorLambung(e.target.value)}\n                placeholder=\"Contoh: DT-001\"\n                disabled={isProcessing}\n              />\n            </div>\n            \n            <div className=\"text-sm text-gray-600 dark:text-gray-400\">\n              ðŸ’¡ <strong>Catatan:</strong> Perubahan nomor lambung hanya untuk hari ini dan akan tercatat di roster & laporan PDF.\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={skipNomorLambungEdit}\n              disabled={isProcessing}\n              data-testid=\"button-skip-nomor-lambung\"\n            >\n              Lewati\n            </Button>\n            <Button\n              onClick={updateNomorLambung}\n              disabled={isProcessing || !newNomorLambung}\n              data-testid=\"button-update-nomor-lambung\"\n            >\n              {isProcessing ? \"Menyimpan...\" : \"Update\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n    </div>\n  );\n}\n","path":null,"size_bytes":43844,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/pages/qr-generator.tsx":{"content":"import { QRGenerator } from \"@/components/qr/qr-generator\";\n\nexport default function QRGeneratorPage() {\n  return <QRGenerator />;\n}\n","path":null,"size_bytes":133,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport express from \"express\";\nimport { createServer, type Server } from \"http\";\nimport multer from 'multer';\nimport fs from 'fs';\nimport path from 'path';\nimport bcrypt from 'bcrypt';\n\nimport { storage } from \"./storage\";\nimport { ObjectStorageService, ObjectNotFoundError } from \"./objectStorage\";\nimport { setupAuth } from \"./replitAuth\";\nimport { \n  insertEmployeeSchema, \n  insertAttendanceSchema, \n  insertRosterSchema, \n  insertLeaveRequestSchema,\n  insertQrTokenSchema,\n  insertMeetingSchema,\n  insertMeetingAttendanceSchema,\n  insertManualAttendanceSchema,\n  insertSimperMonitoringSchema,\n  insertSidakFatigueSessionSchema,\n  insertSidakFatigueRecordSchema,\n  insertSidakFatigueObserverSchema,\n  insertSidakRosterSessionSchema,\n  insertSidakRosterRecordSchema,\n  insertSidakRosterObserverSchema,\n  insertAnnouncementSchema,\n  insertNewsSchema,\n  insertPushSubscriptionSchema,\n  loginSchema,\n  resetPasswordSchema\n} from \"@shared/schema\";\nimport { PushNotificationService } from \"./push-notification\";\nimport { createUserWithRole, Role, Permission, ROLE_PERMISSIONS, getRoleFromPosition } from \"@shared/rbac\";\n\n// Report cache invalidation and update notification system\nlet lastRosterUpdate = new Date();\n\nasync function triggerReportUpdate() {\n  console.log(\"ðŸ”„ Roster data changed - triggering report updates\");\n  \n  // Update the last roster change timestamp\n  lastRosterUpdate = new Date();\n  \n  // Could implement various notification methods:\n  // 1. WebSocket broadcast to all connected report clients\n  // 2. Cache invalidation for TanStack Query\n  // 3. Database triggers for real-time updates\n  // 4. Email notifications to managers\n  \n  console.log(`ðŸ“Š Report update triggered at ${lastRosterUpdate.toISOString()}`);\n}\n\n// Utility function to determine shift based on time\nfunction determineShiftByTime(time: string): string {\n  const [hours, minutes] = time.split(':').map(Number);\n  const totalMinutes = hours * 60 + minutes;\n  \n  // UPDATED CRITERIA:\n  // Shift 1: 04:00-10:00 (240-600 menit)\n  // Shift 2: 16:00-22:00 (960-1320 menit)\n  \n  if (totalMinutes >= 960 && totalMinutes <= 1320) {\n    return \"Shift 2\";\n  } else if (totalMinutes >= 240 && totalMinutes <= 600) {\n    return \"Shift 1\";\n  } else {\n    return \"Shift 1\"; // Default to Shift 1 for other times\n  }\n}\n\n// Strict shift time validation based on actual roster schedule\n// Fungsi validasi waktu berdasarkan pola shift standar operasional\nfunction isValidRosterTime(currentTime: string, startTime: string, endTime: string): boolean {\n  // Tidak menggunakan startTime dan endTime dari roster untuk sementara\n  // Karena data roster bisa inconsistent\n  return true; // Temporary - akan menggunakan shift-based validation\n}\n\n// STRICT: Fungsi validasi waktu berdasarkan nama shift - TIDAK BOLEH ABSENSI DILUAR JAM KERJA\nfunction isValidShiftTimeByName(currentTime: string, shiftName: string): boolean {\n  const [hours, minutes] = currentTime.split(':').map(Number);\n  const totalMinutes = hours * 60 + minutes;\n  \n  // Normalize shift name to handle both formats: \"Shift 1\", \"SHIFT 1\"\n  const normalizedShift = shiftName.toUpperCase();\n  \n  if (normalizedShift === \"SHIFT 1\") {\n    // Shift 1: UPDATED CRITERIA - Hanya boleh scan dari 04:00 sampai 10:00\n    return totalMinutes >= 240 && totalMinutes <= 600;\n  } else if (normalizedShift === \"SHIFT 2\") {\n    // Shift 2: UPDATED CRITERIA - Hanya boleh scan dari 16:00 sampai 22:00\n    return totalMinutes >= 960 && totalMinutes <= 1320;\n  }\n  // CRITICAL: Diluar shift yang ditentukan = TIDAK BOLEH ABSENSI\n  return false;\n}\n\n// Function to get shift time range for error messages\nfunction getShiftTimeRange(shiftName: string): { start: string; end: string } {\n  // Normalize shift name to handle both formats: \"Shift 1\", \"SHIFT 1\"\n  const normalizedShift = shiftName.toUpperCase();\n  \n  if (normalizedShift === \"SHIFT 1\") {\n    return { start: \"04:00\", end: \"10:00\" };\n  } else if (normalizedShift === \"SHIFT 2\") {\n    return { start: \"16:00\", end: \"22:00\" };\n  }\n  return { start: \"00:00\", end: \"23:59\" };\n}\n\n// Function to check if time is completely outside all shift windows\nfunction isCompletelyOutsideShiftTimes(currentTime: string): boolean {\n  const [hours, minutes] = currentTime.split(':').map(Number);\n  const totalMinutes = hours * 60 + minutes;\n  \n  // Check if time falls within any shift window - UPDATED CRITERIA\n  const isInShift1Window = totalMinutes >= 240 && totalMinutes <= 600; // 04:00-10:00\n  const isInShift2Window = totalMinutes >= 960 && totalMinutes <= 1320; // 16:00-22:00\n  \n  return !isInShift1Window && !isInShift2Window;\n}\n\n// Fungsi lama untuk backward compatibility (tidak digunakan lagi)\nfunction isValidShiftTime(currentTime: string, scheduledShift: string): boolean {\n  const [hours, minutes] = currentTime.split(':').map(Number);\n  const totalMinutes = hours * 60 + minutes;\n  \n  if (scheduledShift === \"Shift 1\") {\n    // Shift 1: Hanya boleh scan antara jam 06:00:00 sampai 16:00:00 (360-960 minutes)\n    return totalMinutes >= 360 && totalMinutes < 960;\n  } else if (scheduledShift === \"Shift 2\") {\n    // Shift 2: Hanya boleh scan antara jam 16:30:00 sampai 20:00:00 (990-1200 minutes)\n    return totalMinutes >= 990 && totalMinutes < 1200;\n  }\n  \n  return false;\n}\n\n// AGGRESSIVE CACHING STRATEGY for Performance Optimization\nconst employeeCache = new Map<string, { data: any; timestamp: number }>();\nconst allEmployeesCache = new Map<string, { data: any; timestamp: number }>();\nconst rosterCache = new Map<string, { data: any; timestamp: number }>();\nconst leaveMonitoringCache = new Map<string, { data: any; timestamp: number }>();\n\nconst CACHE_TTL = 5 * 60 * 1000; // 5 minutes for employee data\nconst ALL_EMPLOYEES_TTL = 10 * 60 * 1000; // 10 minutes for all employees (changes less frequently)\nconst ROSTER_TTL = 3 * 60 * 1000; // 3 minutes for roster data\nconst LEAVE_MONITORING_TTL = 5 * 60 * 1000; // 5 minutes for leave monitoring\n\nfunction getCachedEmployee(employeeId: string) {\n  const cached = employeeCache.get(employeeId);\n  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n    return cached.data;\n  }\n  return null;\n}\n\nfunction setCachedEmployee(employeeId: string, data: any) {\n  employeeCache.set(employeeId, { data, timestamp: Date.now() });\n}\n\nfunction clearCachedEmployee(employeeId: string) {\n  employeeCache.delete(employeeId);\n}\n\n// Cache for all employees (used frequently in roster enrichment)\nfunction getCachedAllEmployees() {\n  const cached = allEmployeesCache.get('all');\n  if (cached && Date.now() - cached.timestamp < ALL_EMPLOYEES_TTL) {\n    console.log('ðŸ“¦ Using cached all employees data');\n    return cached.data;\n  }\n  return null;\n}\n\nfunction setCachedAllEmployees(data: any) {\n  allEmployeesCache.set('all', { data, timestamp: Date.now() });\n  console.log(`ðŸ“¦ Cached ${data.length} employees for ${ALL_EMPLOYEES_TTL/1000}s`);\n}\n\n// Cache for roster data by date\nfunction getCachedRoster(date: string) {\n  const cached = rosterCache.get(date);\n  if (cached && Date.now() - cached.timestamp < ROSTER_TTL) {\n    console.log(`ðŸ“¦ Using cached roster data for ${date}`);\n    return cached.data;\n  }\n  return null;\n}\n\nfunction setCachedRoster(date: string, data: any) {\n  rosterCache.set(date, { data, timestamp: Date.now() });\n  console.log(`ðŸ“¦ Cached ${data.length} roster entries for ${date}`);\n}\n\n// Cache for leave monitoring data\nfunction getCachedLeaveMonitoring() {\n  const cached = leaveMonitoringCache.get('all');\n  if (cached && Date.now() - cached.timestamp < LEAVE_MONITORING_TTL) {\n    console.log('ðŸ“¦ Using cached leave monitoring data');\n    return cached.data;\n  }\n  return null;\n}\n\nfunction setCachedLeaveMonitoring(data: any) {\n  leaveMonitoringCache.set('all', { data, timestamp: Date.now() });\n  console.log(`ðŸ“¦ Cached ${data.length} leave monitoring records`);\n}\n\n// Clear all caches (useful for data updates)\nfunction clearAllCaches() {\n  employeeCache.clear();\n  allEmployeesCache.clear();\n  rosterCache.clear();\n  leaveMonitoringCache.clear();\n  console.log('ðŸ§¹ All caches cleared');\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  \n  // Health check endpoint for debugging\n  app.get(\"/api/health\", async (req, res) => {\n    const buildTime = \"2024-12-01T10:02:00Z\";\n    const checks = {\n      status: \"ok\",\n      buildTime,\n      version: \"1.0.1\",\n      environment: process.env.NODE_ENV || \"unknown\",\n      databaseUrl: !!process.env.DATABASE_URL,\n      timestamp: new Date().toISOString(),\n      databaseConnection: \"unknown\"\n    };\n    \n    try {\n      // Test database connection\n      const testResult = await storage.getEmployee(\"TEST-HEALTH-CHECK\");\n      checks.databaseConnection = \"connected\";\n    } catch (error: any) {\n      checks.databaseConnection = \"error: \" + (error?.message || \"unknown\");\n      checks.status = \"degraded\";\n    }\n    \n    res.json(checks);\n  });\n  \n  // Setup session middleware for authentication\n  await setupAuth(app);\n\n  // ============================================\n  // AUTHENTICATION ROUTES\n  // ============================================\n  \n  // Login endpoint\n  app.post(\"/api/auth/login\", async (req, res) => {\n    try {\n      console.log(\"ðŸ” Login attempt - Content-Type:\", req.headers['content-type']);\n      console.log(\"ðŸ” Login attempt - Request body:\", JSON.stringify(req.body));\n      console.log(\"ðŸ” Login attempt - Body type:\", typeof req.body);\n      \n      // Check if body is empty or undefined\n      if (!req.body || Object.keys(req.body).length === 0) {\n        console.error(\"ðŸ” Login error: Empty request body\");\n        return res.status(400).json({ \n          message: \"Request body kosong. Pastikan Content-Type: application/json\" \n        });\n      }\n      \n      // Validate request body\n      const parseResult = loginSchema.safeParse(req.body);\n      if (!parseResult.success) {\n        console.error(\"ðŸ” Login validation error:\", parseResult.error.errors);\n        return res.status(400).json({ \n          message: \"Format data tidak valid: \" + parseResult.error.errors.map(e => e.message).join(\", \")\n        });\n      }\n      \n      const { nik, password } = parseResult.data;\n      console.log(\"ðŸ” Looking up user with NIK:\", nik);\n      \n      // Get auth user from database\n      let authUser;\n      try {\n        console.log(\"ðŸ” Attempting database lookup for NIK:\", nik);\n        console.log(\"ðŸ” DATABASE_URL exists:\", !!process.env.DATABASE_URL);\n        authUser = await storage.getAuthUserByNik(nik);\n        console.log(\"ðŸ” Auth user lookup result:\", authUser ? \"found\" : \"not found\");\n      } catch (dbError: any) {\n        console.error(\"ðŸ” Database error looking up auth user:\", dbError?.message || dbError);\n        console.error(\"ðŸ” Full error:\", JSON.stringify(dbError, Object.getOwnPropertyNames(dbError)));\n        return res.status(500).json({ \n          message: \"Gagal mengakses database: \" + (dbError?.message || \"Unknown error\"),\n          errorType: dbError?.name || \"Unknown\"\n        });\n      }\n      \n      if (!authUser) {\n        console.log(\"ðŸ” Login failed - NIK not found:\", nik);\n        return res.status(401).json({ message: \"NIK atau password salah\" });\n      }\n      \n      // Verify password\n      let isValidPassword;\n      try {\n        console.log(\"ðŸ” Comparing password...\");\n        isValidPassword = await bcrypt.compare(password, authUser.hashedPassword);\n        console.log(\"ðŸ” Password comparison result:\", isValidPassword);\n      } catch (bcryptError: any) {\n        console.error(\"ðŸ” bcrypt error:\", bcryptError?.message || bcryptError);\n        return res.status(500).json({ message: \"Gagal memverifikasi password\" });\n      }\n      \n      if (!isValidPassword) {\n        console.log(\"ðŸ” Login failed - Invalid password for NIK:\", nik);\n        return res.status(401).json({ message: \"NIK atau password salah\" });\n      }\n      \n      // Get employee data for session and response\n      let employee;\n      try {\n        employee = await storage.getEmployee(nik);\n        console.log(\"ðŸ” Employee lookup result:\", employee ? \"found\" : \"not found\");\n      } catch (empError: any) {\n        console.error(\"ðŸ” Database error looking up employee:\", empError?.message || empError);\n        return res.status(500).json({ message: \"Gagal mengakses data karyawan\" });\n      }\n      \n      if (!employee) {\n        console.log(\"ðŸ” Login failed - Employee not found:\", nik);\n        return res.status(404).json({ message: \"Data karyawan tidak ditemukan\" });\n      }\n      \n      // Create user with role and permissions based on position\n      const userWithRole = createUserWithRole(employee.id, employee.name, employee.position || null);\n      \n      // Create session with role info - with explicit save\n      try {\n        (req.session as any).user = userWithRole;\n        \n        // Explicitly save session to handle any database errors\n        await new Promise<void>((resolve, reject) => {\n          req.session.save((err) => {\n            if (err) {\n              console.error(\"ðŸ” Session save error:\", err);\n              reject(err);\n            } else {\n              console.log(\"ðŸ” Session saved successfully\");\n              resolve();\n            }\n          });\n        });\n      } catch (sessionError: any) {\n        console.error(\"ðŸ” Session error:\", sessionError?.message || sessionError);\n        return res.status(500).json({ message: \"Gagal menyimpan session: \" + (sessionError?.message || \"Unknown\") });\n      }\n      \n      console.log(\"ðŸ” Login success for:\", nik);\n      return res.json({\n        message: \"Login berhasil\",\n        user: userWithRole,\n      });\n    } catch (error: any) {\n      console.error(\"ðŸ” Unhandled login error:\", error?.message || error);\n      console.error(\"ðŸ” Error stack:\", error?.stack);\n      return res.status(500).json({ message: \"Terjadi kesalahan server: \" + (error?.message || \"Unknown\") });\n    }\n  });\n\n  // Logout endpoint\n  app.post(\"/api/auth/logout\", (req, res) => {\n    req.session.destroy((err) => {\n      if (err) {\n        console.error(\"Logout error:\", err);\n        return res.status(500).json({ message: \"Logout gagal\" });\n      }\n      res.clearCookie('connect.sid');\n      res.json({ message: \"Logout berhasil\" });\n    });\n  });\n\n  // Get current session\n  app.get(\"/api/auth/session\", (req, res) => {\n    const user = (req.session as any).user;\n    if (user) {\n      // Ensure user has role and permissions (for existing sessions)\n      if (!user.role || !user.permissions) {\n        const userWithRole = createUserWithRole(user.nik, user.name, user.position || null);\n        (req.session as any).user = userWithRole;\n        res.json({ authenticated: true, user: userWithRole });\n      } else {\n        res.json({ authenticated: true, user });\n      }\n    } else {\n      res.json({ authenticated: false, user: null });\n    }\n  });\n\n  // Reset password endpoint\n  app.post(\"/api/auth/reset-password\", async (req, res) => {\n    try {\n      // Check if user is logged in\n      const sessionUser = (req.session as any).user;\n      if (!sessionUser) {\n        return res.status(401).json({ message: \"Silakan login terlebih dahulu\" });\n      }\n      \n      const { oldPassword, newPassword } = resetPasswordSchema.parse(req.body);\n      const nik = sessionUser.nik;\n      \n      // Get auth user\n      const authUser = await storage.getAuthUserByNik(nik);\n      if (!authUser) {\n        return res.status(404).json({ message: \"User tidak ditemukan\" });\n      }\n      \n      // Verify old password\n      const isValidOldPassword = await bcrypt.compare(oldPassword, authUser.hashedPassword);\n      if (!isValidOldPassword) {\n        return res.status(401).json({ message: \"Password lama salah\" });\n      }\n      \n      // Hash new password and update\n      const hashedNewPassword = await bcrypt.hash(newPassword, 10);\n      await storage.updateAuthUserPassword(nik, hashedNewPassword);\n      \n      res.json({ message: \"Password berhasil diubah\" });\n    } catch (error) {\n      console.error(\"Reset password error:\", error);\n      res.status(400).json({ message: \"Invalid reset password request\" });\n    }\n  });\n\n  // Employee routes - OPTIMIZED WITH CACHING\n  app.get(\"/api/employees\", async (req, res) => {\n    try {\n      // Check cache first for massive performance improvement\n      let employees = getCachedAllEmployees();\n      \n      if (!employees) {\n        console.log('ðŸ”„ Fetching all employees from database...');\n        employees = await storage.getAllEmployees();\n        setCachedAllEmployees(employees);\n      }\n      \n      res.json(employees);\n    } catch (error) {\n      console.error('âŒ Error fetching employees:', error);\n      res.status(500).json({ message: \"Failed to fetch employees\" });\n    }\n  });\n\n  app.get(\"/api/employees/:id\", async (req, res) => {\n    try {\n      const employee = await storage.getEmployee(req.params.id);\n      if (!employee) {\n        return res.status(404).json({ message: \"Karyawan tidak ditemukan\" });\n      }\n      res.json(employee);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch employee\" });\n    }\n  });\n\n  app.post(\"/api/employees\", async (req, res) => {\n    // Store ID for error messages (outside try block for catch block access)\n    let employeeIdForMsg = req.body?.id;\n    \n    try {\n      const validatedData = insertEmployeeSchema.parse(req.body);\n      employeeIdForMsg = validatedData.id; // Update with validated ID\n      \n      // Clear employee caches since we're adding new data\n      clearAllCaches();\n      \n      // Generate QR Code token for the employee\n      const secretKey = process.env.QR_SECRET_KEY || 'AttendanceQR2024';\n      const tokenData = `${validatedData.id || ''}${secretKey}Attend`;\n      const qrToken = Buffer.from(tokenData).toString('base64').slice(0, 16)\n        .replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, ''); // Make URL-safe\n      // Create URL yang mengarah ke aplikasi untuk QR Code\n      const baseUrl = process.env.REPLIT_DOMAINS \n        ? `https://${process.env.REPLIT_DOMAINS.split(',')[0]}`\n        : 'http://localhost:5000';\n      \n      // Create JSON format for internal app QR scanner (original format)\n      const qrPayload = {\n        id: validatedData.id,\n        token: qrToken\n      };\n      const qrData = JSON.stringify(qrPayload);\n      const employeeWithQR = {\n        ...validatedData,\n        qrCode: qrData // JSON format untuk sistem internal\n      };\n      \n      const employee = await storage.createEmployee(employeeWithQR);\n      \n      // Also create QR token record\n      await storage.createQrToken({\n        employeeId: employee.id,\n        token: qrToken,\n        isActive: true\n      });\n      \n      // Automatically create auth user with default password for new employee\n      const defaultPassword = \"12345678\";\n      const hashedDefaultPassword = await bcrypt.hash(defaultPassword, 10);\n      await storage.createAuthUser(employee.id, hashedDefaultPassword);\n      console.log(`âœ… Created auth user for new employee: ${employee.id} with default password`);\n      \n      res.status(201).json(employee);\n    } catch (error) {\n      console.error('Error creating employee:', error);\n      \n      // Check for duplicate key error\n      if (error && typeof error === 'object' && 'code' in error && error.code === '23505') {\n        const detail = 'detail' in error ? String(error.detail) : '';\n        if (detail.includes('id')) {\n          return res.status(400).json({ \n            message: `ID Karyawan ${employeeIdForMsg || 'tersebut'} sudah digunakan. Silakan gunakan ID yang berbeda.` \n          });\n        }\n      }\n      \n      res.status(400).json({ message: \"Data karyawan tidak valid\" });\n    }\n  });\n\n  app.put(\"/api/employees/:id\", async (req, res) => {\n    try {\n      console.log(`Updating employee ${req.params.id} with data:`, req.body);\n      \n      // Validate request data\n      const validatedData = insertEmployeeSchema.partial().parse(req.body);\n      console.log('Validated data:', validatedData);\n      \n      // Update employee in database\n      const employee = await storage.updateEmployee(req.params.id, validatedData);\n      \n      // Clear employee caches immediately after update (even if employee is null)\n      // This ensures cache coherence in all cases\n      clearAllCaches();\n      console.log('ðŸ§¹ Caches cleared after employee update');\n      console.log('Update result:', employee);\n      \n      if (!employee) {\n        console.log('Employee not found');\n        return res.status(404).json({ message: \"Karyawan tidak ditemukan\" });\n      }\n      \n      // Ensure response object is valid\n      if (typeof res.json !== 'function') {\n        console.error('res.json is not a function - response object corrupted');\n        return res.status(500).send('Internal server error');\n      }\n      \n      console.log('Sending successful response');\n      res.json(employee);\n    } catch (error) {\n      console.error('Error updating employee:', error);\n      \n      // Check if response object is still valid\n      if (typeof res.json === 'function') {\n        res.status(400).json({ \n          message: \"Invalid employee data\",\n          error: error instanceof Error ? error.message : 'Unknown error'\n        });\n      } else {\n        console.error('Cannot send error response - res.json not available');\n        res.status(500).send('Internal server error');\n      }\n    }\n  });\n\n  app.delete(\"/api/employees/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteEmployee(req.params.id);\n      \n      // Clear employee caches immediately after delete attempt\n      // This ensures cache coherence even if employee wasn't found\n      clearAllCaches();\n      console.log('ðŸ§¹ Caches cleared after employee deletion');\n      \n      if (!deleted) {\n        return res.status(404).json({ message: \"Karyawan tidak ditemukan\" });\n      }\n      \n      res.status(204).send();\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete employee\" });\n    }\n  });\n\n  // Delete all employees\n  app.delete(\"/api/employees\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteAllEmployees();\n      if (deleted) {\n        res.json({ message: \"Semua data karyawan berhasil dihapus\" });\n      } else {\n        res.status(500).json({ message: \"Gagal menghapus data karyawan\" });\n      }\n    } catch (error) {\n      console.error(\"Error deleting all employees:\", error);\n      res.status(500).json({ message: \"Failed to delete all employees\" });\n    }\n  });\n\n  // Bulk upload employees\n  app.post(\"/api/employees/bulk\", async (req, res) => {\n    try {\n      const { employees: employeeData } = req.body;\n      \n      if (!Array.isArray(employeeData)) {\n        return res.status(400).json({ message: \"Invalid employee data format\" });\n      }\n\n      const results = [];\n      const secretKey = process.env.QR_SECRET_KEY || 'AttendanceQR2024';\n      \n      for (const emp of employeeData) {\n        try {\n          // Validate each employee data\n          const validatedEmployee = insertEmployeeSchema.parse(emp);\n          \n          // Generate QR Code token for each employee\n          const tokenData = `${validatedEmployee.id || ''}${secretKey}Attend`;\n          const qrToken = Buffer.from(tokenData).toString('base64').slice(0, 16);\n          const qrData = JSON.stringify({ id: validatedEmployee.id, token: qrToken });\n          \n          // Add QR Code to employee data (as JSON for consistency)  \n          const employeeWithQR = {\n            ...validatedEmployee,\n            qrCode: qrData\n          };\n          \n          const employee = await storage.createEmployee(employeeWithQR);\n          \n          // Also create QR token record\n          await storage.createQrToken({\n            employeeId: employee.id,\n            token: qrToken,\n            isActive: true\n          });\n          \n          results.push(employee);\n        } catch (validationError) {\n          console.error(\"Validation error for employee:\", emp, validationError);\n          // Skip invalid entries but continue processing\n        }\n      }\n\n      // Clear employee caches since we've added new data\n      clearAllCaches();\n\n      res.json({ \n        message: `Successfully uploaded ${results.length} employees with QR codes`,\n        employees: results\n      });\n    } catch (error) {\n      console.error(\"Error bulk uploading employees:\", error);\n      res.status(500).json({ message: \"Failed to upload employees\" });\n    }\n  });\n\n  // Attendance routes\n  app.get(\"/api/attendance\", async (req, res) => {\n    try {\n      const date = req.query.date as string;\n      console.log(`Fetching attendance records for date: ${date || 'all'}`);\n      const attendance = await storage.getAllAttendance(date);\n      console.log(`Found ${attendance.length} attendance records`);\n      res.json(attendance);\n    } catch (error) {\n      console.error('Error fetching attendance records:', error);\n      res.status(500).json({ message: \"Failed to fetch attendance records\" });\n    }\n  });\n\n  app.get(\"/api/attendance/employee/:employeeId\", async (req, res) => {\n    try {\n      const date = req.query.date as string;\n      const attendance = await storage.getAttendanceByEmployee(req.params.employeeId, date);\n      res.json(attendance);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch employee attendance\" });\n    }\n  });\n\n  app.post(\"/api/attendance\", async (req, res) => {\n    try {\n      const validatedData = insertAttendanceSchema.parse(req.body);\n      \n      // Use cache for employee data, parallel queries for the rest\n      let employee = getCachedEmployee(validatedData.employeeId);\n      \n      if (!employee) {\n        // Employee not cached, fetch with parallel queries\n        const [employeeData, existingAttendance, roster, leaveRequests] = await Promise.all([\n          storage.getEmployee(validatedData.employeeId),\n          storage.getAttendanceByEmployee(validatedData.employeeId, validatedData.date),\n          storage.getRosterByDate(validatedData.date),\n          storage.getLeaveByEmployee(validatedData.employeeId)\n        ]);\n        employee = employeeData;\n        if (employee) setCachedEmployee(validatedData.employeeId, employee);\n        var attendance = existingAttendance;\n        var rosterData = roster;\n        var leaves = leaveRequests;\n      } else {\n        // Employee cached, only fetch other data\n        const [existingAttendance, roster, leaveRequests] = await Promise.all([\n          storage.getAttendanceByEmployee(validatedData.employeeId, validatedData.date),\n          storage.getRosterByDate(validatedData.date),\n          storage.getLeaveByEmployee(validatedData.employeeId)\n        ]);\n        var attendance = existingAttendance;\n        var rosterData = roster;\n        var leaves = leaveRequests;\n      }\n      \n      if (!employee) {\n        return res.status(404).json({ message: \"Karyawan tidak ditemukan\" });\n      }\n\n      if (attendance.length > 0) {\n        return res.status(400).json({ message: \"Karyawan sudah melakukan absensi hari ini\" });\n      }\n\n      const scheduledEmployee = rosterData.find(r => r.employeeId === validatedData.employeeId);\n      if (!scheduledEmployee) {\n        return res.status(400).json({ message: \"Karyawan tidak dijadwalkan untuk hari ini\" });\n      }\n\n      // Validasi status roster berdasarkan kolom \"Shift\"\n      if (scheduledEmployee.shift === \"CUTI\") {\n        return res.status(400).json({ \n          message: \"Absensi ditolak. Status Anda CUTI sesuai roster.\",\n          rosterStatus: \"CUTI\",\n          employeeId: validatedData.employeeId,\n          date: validatedData.date\n        });\n      }\n\n      if (scheduledEmployee.shift === \"OVERSHIFT\") {\n        return res.status(400).json({ \n          message: \"Absensi ditolak. Status Anda OVERSHIFT sesuai roster.\",\n          rosterStatus: \"OVERSHIFT\", \n          employeeId: validatedData.employeeId,\n          date: validatedData.date\n        });\n      }\n\n      // Hanya terima absensi untuk Shift 1 dan Shift 2\n      if (scheduledEmployee.shift !== \"SHIFT 1\" && scheduledEmployee.shift !== \"SHIFT 2\") {\n        return res.status(400).json({ \n          message: `Absensi ditolak. Status roster tidak valid: ${scheduledEmployee.shift}. Hanya Shift 1 dan Shift 2 yang dapat melakukan absensi.`,\n          rosterStatus: scheduledEmployee.shift,\n          employeeId: validatedData.employeeId,\n          date: validatedData.date\n        });\n      }\n      \n      const leaveRequests = leaves;\n      const approvedLeave = leaveRequests.find(leave => \n        leave.status === 'approved' &&\n        validatedData.date >= leave.startDate &&\n        validatedData.date <= leave.endDate\n      );\n\n      if (approvedLeave) {\n        return res.status(400).json({ \n          message: \"Scan ditolak: karyawan sedang cuti\",\n          leaveDetails: {\n            type: approvedLeave.leaveType,\n            startDate: approvedLeave.startDate,\n            endDate: approvedLeave.endDate\n          }\n        });\n      }\n\n      // Get current time for precise shift validation (menggunakan waktu Indonesia WIB/WITA)\n      const now = new Date();\n      // Convert to Indonesia timezone (WITA UTC+8)\n      const indonesiaOffset = 8 * 60; // 8 hours in minutes\n      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);\n      const indonesiaTime = new Date(utc + (indonesiaOffset * 60000));\n      const currentTime = `${indonesiaTime.getHours().toString().padStart(2, '0')}:${indonesiaTime.getMinutes().toString().padStart(2, '0')}`;\n      \n      console.log(`Validating shift for ${validatedData.employeeId}: Current time ${currentTime}, Scheduled ${scheduledEmployee.shift} (${scheduledEmployee.startTime} - ${scheduledEmployee.endTime})`);\n      \n      // Strict shift validation based on shift name (more reliable than roster times)\n      const isValidTiming = isValidShiftTimeByName(currentTime, scheduledEmployee.shift);\n      \n      console.log(`Shift validation result: ${isValidTiming}`);\n      \n      if (!isValidTiming) {\n        const timeRange = getShiftTimeRange(scheduledEmployee.shift);\n        const isCompletelyOutside = isCompletelyOutsideShiftTimes(currentTime);\n        \n        let errorMessage;\n        if (isCompletelyOutside) {\n          errorMessage = `âŒ ABSENSI DITOLAK - Diluar jam kerja! Waktu sekarang: ${currentTime}. Jam kerja: Shift 1 (05:00-15:30) atau Shift 2 (16:00-20:00)`;\n        } else {\n          errorMessage = `âŒ ABSENSI DITOLAK - Tidak sesuai shift! Anda dijadwalkan ${scheduledEmployee.shift} (${timeRange.start}-${timeRange.end}). Waktu sekarang: ${currentTime}`;\n        }\n        \n        return res.status(400).json({ \n          message: errorMessage,\n          currentTime: currentTime,\n          scheduledShift: scheduledEmployee.shift,\n          allowedTimeRange: `${timeRange.start} - ${timeRange.end}`,\n          errorType: isCompletelyOutside ? 'OUTSIDE_WORK_HOURS' : 'WRONG_SHIFT_TIME'\n        });\n      }\n\n      // Update nomor lambung jika ada field nomorLambungBaru\n      if (req.body.nomorLambungBaru) {\n        try {\n          // Get current employee data to check if they were originally SPARE\n          const currentEmployee = await storage.getEmployee(validatedData.employeeId);\n          const updateData: any = {\n            nomorLambung: req.body.nomorLambungBaru\n          };\n          \n          // If employee currently has nomor lambung \"SPARE\", mark them as spare origin\n          if (currentEmployee && currentEmployee.nomorLambung === \"SPARE\") {\n            updateData.isSpareOrigin = true;\n            console.log(`Setting isSpareOrigin=true for employee ${validatedData.employeeId} (originally SPARE)`);\n          }\n          \n          await storage.updateEmployee(validatedData.employeeId, updateData);\n          \n          // CRITICAL: Clear ALL employee caches since roster uses getAllEmployees\n          clearCachedEmployee(validatedData.employeeId);\n          allEmployeesCache.clear(); // Clear the all employees cache\n          rosterCache.clear(); // Clear roster cache to force refresh\n          \n          console.log(`Updated nomor lambung for employee ${validatedData.employeeId} to: ${req.body.nomorLambungBaru}`);\n          console.log(`ðŸ§¹ Cleared all employee and roster caches to show updated nomor lambung`);\n        } catch (updateError) {\n          console.error('Error updating employee nomor lambung:', updateError);\n          // Continue with attendance creation even if update fails\n        }\n      }\n\n      const record = await storage.createAttendanceRecord(validatedData);\n      res.status(201).json(record);\n    } catch (error) {\n      res.status(400).json({ message: \"Invalid attendance data\" });\n    }\n  });\n\n  // Roster routes - OPTIMIZED FOR PERFORMANCE\n  app.get(\"/api/roster\", async (req, res) => {\n    try {\n      const date = req.query.date as string;\n      const employeeId = req.query.employeeId as string;\n      \n      // Jika ada employeeId, ambil semua roster untuk employee tersebut\n      if (employeeId) {\n        const employeeRoster = await storage.getRosterByEmployee(employeeId);\n        const leaveMonitoring = await storage.getAllLeaveRosterMonitoring();\n        \n        // OPTIMIZED: Create Map for O(1) lookup instead of O(n) find\n        const leaveMonitoringMap = new Map(\n          leaveMonitoring.map(leave => [leave.nik, leave])\n        );\n        \n        // Enrich roster dengan data leave monitoring (hari kerja)\n        const enrichedRoster = employeeRoster.map(schedule => {\n          const leaveRecord = leaveMonitoringMap.get(schedule.employeeId);\n          \n          return {\n            ...schedule,\n            workDays: leaveRecord?.monitoringDays || null // Monitoring hari dari leave roster\n          };\n        });\n        \n        return res.json(enrichedRoster);\n      }\n      \n      // Jika tidak ada employeeId, maka wajib ada date parameter\n      if (!date) {\n        return res.status(400).json({ message: \"Date parameter is required\" });\n      }\n      \n      console.time(\"ðŸ“Š Roster API Performance\");\n      console.log(`ðŸ”„ Fetching roster data for date: ${date}`);\n      \n      // OPTIMIZED: Use cached data when available + parallel fetch\n      const cachedRoster = getCachedRoster(date);\n      const cachedEmployees = getCachedAllEmployees();\n      const cachedLeaveMonitoring = getCachedLeaveMonitoring();\n      \n      const promises = [];\n      \n      // Only fetch what's not in cache\n      if (cachedRoster) {\n        promises.push(Promise.resolve(cachedRoster));\n      } else {\n        promises.push(storage.getRosterByDate(date));\n      }\n      \n      // Always fetch attendance (changes frequently)\n      promises.push(storage.getAllAttendance(date));\n      \n      if (cachedLeaveMonitoring) {\n        promises.push(Promise.resolve(cachedLeaveMonitoring));\n      } else {\n        promises.push(storage.getAllLeaveRosterMonitoring());\n      }\n      \n      if (cachedEmployees) {\n        promises.push(Promise.resolve(cachedEmployees));\n      } else {\n        promises.push(storage.getAllEmployees());\n      }\n      \n      const [roster, attendance, leaveMonitoring, allEmployees] = await Promise.all(promises);\n      \n      // Cache the data we just fetched\n      if (!cachedRoster) setCachedRoster(date, roster);\n      if (!cachedLeaveMonitoring) setCachedLeaveMonitoring(leaveMonitoring);\n      if (!cachedEmployees) setCachedAllEmployees(allEmployees);\n      \n      console.log(`ðŸ“‹ Fetched ${roster.length} roster entries, ${attendance.length} attendance records`);\n      \n      // OPTIMIZED: Create Maps for O(1) lookups instead of O(n) finds\n      const attendanceMap = new Map(\n        attendance.map(att => [att.employeeId, att])\n      );\n      const leaveMonitoringMap = new Map(\n        leaveMonitoring.map(leave => [leave.nik, leave])\n      );\n      const employeesMap = new Map(\n        allEmployees.map(emp => [emp.id, emp])\n      );\n      \n      console.log(\"ðŸš€ Starting roster enrichment with Map lookups\");\n      \n      // OPTIMIZED: O(1) map lookups instead of O(n) find operations\n      const enrichedRoster = roster.map(schedule => {\n        const attendanceRecord = attendanceMap.get(schedule.employeeId);\n        const leaveRecord = leaveMonitoringMap.get(schedule.employeeId);\n        const employee = employeesMap.get(schedule.employeeId);\n        \n        return {\n          ...schedule,\n          employee: employee, // Add complete employee data\n          hasAttended: !!attendanceRecord,\n          attendanceTime: attendanceRecord?.time || null,\n          actualJamTidur: attendanceRecord?.jamTidur || schedule.jamTidur,\n          actualFitToWork: attendanceRecord?.fitToWork || schedule.fitToWork,\n          attendanceStatus: attendanceRecord ? \"present\" : \"absent\",\n          workDays: leaveRecord?.monitoringDays || null // Monitoring hari dari leave roster\n        };\n      });\n      \n      console.timeEnd(\"ðŸ“Š Roster API Performance\");\n      console.log(`âœ… Roster enrichment completed: ${enrichedRoster.length} entries`);\n      \n      res.json(enrichedRoster);\n    } catch (error) {\n      console.error(\"âŒ Roster API Error:\", error);\n      res.status(500).json({ message: \"Failed to fetch roster\" });\n    }\n  });\n\n  app.get(\"/api/roster/employee/:employeeId\", async (req, res) => {\n    try {\n      const roster = await storage.getRosterByEmployee(req.params.employeeId);\n      res.json(roster);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch employee roster\" });\n    }\n  });\n\n  // Monthly roster endpoint - untuk kalender bulanan\n  app.get(\"/api/roster/monthly\", async (req, res) => {\n    try {\n      const year = req.query.year as string;\n      const month = req.query.month as string;\n      const employeeId = req.query.employeeId as string; // Server-side filtering parameter\n      \n      if (!year || !month) {\n        return res.status(400).json({ message: \"Year and month parameters are required\" });\n      }\n      \n      // Dapatkan first dan last date dari bulan tersebut\n      const firstDay = `${year}-${month.padStart(2, '0')}-01`;\n      const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();\n      const lastDayStr = `${year}-${month.padStart(2, '0')}-${lastDay.toString().padStart(2, '0')}`;\n      \n      console.log(`ðŸ—“ï¸ Fetching monthly roster for ${year}-${month} (${firstDay} to ${lastDayStr})${employeeId ? ` for employee ${employeeId}` : ''}`);\n      \n      // Fetch roster untuk bulan tersebut\n      let roster = await storage.getRosterByDateRange(firstDay, lastDayStr);\n      \n      // SERVER-SIDE FILTERING: Filter by employeeId jika parameter diberikan (SECURITY & EFFICIENCY)\n      if (employeeId) {\n        roster = roster.filter(schedule => schedule.employeeId === employeeId);\n        console.log(`ðŸ”’ Filtered to ${roster.length} entries for employee ${employeeId}`);\n      }\n      \n      const allEmployees = await storage.getAllEmployees();\n      const attendance = await storage.getAllAttendanceByDateRange(firstDay, lastDayStr);\n      \n      // Create Maps untuk O(1) lookup\n      const employeesMap = new Map(allEmployees.map(emp => [emp.id, emp]));\n      const attendanceMap = new Map();\n      \n      // Group attendance by date dan employeeId\n      attendance.forEach(att => {\n        const key = `${att.date}-${att.employeeId}`;\n        attendanceMap.set(key, att);\n      });\n      \n      // Enrich roster dengan employee data dan attendance\n      const enrichedRoster = roster.map(schedule => {\n        const employee = employeesMap.get(schedule.employeeId);\n        const attendanceKey = `${schedule.date}-${schedule.employeeId}`;\n        const attendanceRecord = attendanceMap.get(attendanceKey);\n        \n        return {\n          ...schedule,\n          employee: employee,\n          hasAttended: !!attendanceRecord,\n          attendanceTime: attendanceRecord?.time || null,\n          actualJamTidur: attendanceRecord?.jamTidur || schedule.jamTidur,\n          actualFitToWork: attendanceRecord?.fitToWork || schedule.fitToWork,\n          attendanceStatus: attendanceRecord ? \"present\" : \"absent\"\n        };\n      });\n      \n      console.log(`âœ… Monthly roster fetched: ${enrichedRoster.length} entries`);\n      res.json(enrichedRoster);\n    } catch (error) {\n      console.error(\"âŒ Monthly Roster API Error:\", error);\n      res.status(500).json({ message: \"Failed to fetch monthly roster\" });\n    }\n  });\n\n  app.post(\"/api/roster\", async (req, res) => {\n    try {\n      const validatedData = insertRosterSchema.parse(req.body);\n      \n      // Clear roster cache since we're adding new data\n      rosterCache.clear();\n      \n      // Check if employee exists\n      const employee = await storage.getEmployee(validatedData.employeeId);\n      if (!employee) {\n        return res.status(404).json({ message: \"Karyawan tidak ditemukan\" });\n      }\n\n      const schedule = await storage.createRosterSchedule(validatedData);\n      \n      // Trigger report cache invalidation\n      await triggerReportUpdate();\n      \n      res.status(201).json(schedule);\n    } catch (error) {\n      res.status(400).json({ message: \"Invalid roster data\" });\n    }\n  });\n\n  app.post(\"/api/roster/bulk\", async (req, res) => {\n    try {\n      const { rosters } = req.body;\n      if (!Array.isArray(rosters)) {\n        return res.status(400).json({ message: \"Rosters must be an array\" });\n      }\n\n      console.log(`Starting bulk upload of ${rosters.length} entries`);\n      \n      // Debug: Log 5 data pertama yang diterima server\n      console.log('=== SERVER RECEIVED DATA ===');\n      rosters.slice(0, 5).forEach((roster, index) => {\n        console.log(`${index + 1}. NIK: ${roster.employeeId}, Date: ${roster.date}, Shift: ${roster.shift}`);\n        console.log(`    Jam Tidur: \"${roster.jamTidur}\", Hari Kerja: \"${roster.hariKerja}\", Fit To Work: \"${roster.fitToWork}\"`);\n      });\n\n      const validatedRosters = [];\n      const errors = [];\n      const batchSize = 200; // Increase batch size significantly\n\n      // Pre-load all employees to avoid repeated database queries\n      const allEmployees = await storage.getAllEmployees();\n      const employeeMap = new Map(allEmployees.map(emp => [emp.id, emp]));\n\n      // Process in larger batches for better performance\n      for (let batchStart = 0; batchStart < rosters.length; batchStart += batchSize) {\n        const batch = rosters.slice(batchStart, batchStart + batchSize);\n        \n        // Validate batch without logging each entry\n        for (let i = 0; i < batch.length; i++) {\n          const globalIndex = batchStart + i;\n          try {\n            const rawData = batch[i]; // Keep raw data for employee creation\n            const validatedData = insertRosterSchema.parse(batch[i]);\n            \n            \n            // Check if employee exists in pre-loaded map\n            const existingEmployee = employeeMap.get(validatedData.employeeId);\n            const employeeName = rawData.employeeName || rawData.name || `Employee ${validatedData.employeeId}`;\n            const nomorLambung = rawData.nomorLambung || rawData.nomor_lambung || null;\n            \n            if (!existingEmployee) {\n              // Create new employee using data from Excel upload\n              try {\n                const newEmployee = await storage.createEmployee({\n                  id: validatedData.employeeId,\n                  name: employeeName,\n                  nomorLambung: nomorLambung,\n                  phone: '+628123456789',\n                  status: 'active'\n                });\n                employeeMap.set(validatedData.employeeId, newEmployee);\n                \n                // Log employee creation with nomor lambung\n                console.log(`Created employee: ${validatedData.employeeId} - ${employeeName} (${nomorLambung || 'No Nomor Lambung'})`);\n              } catch (createError) {\n                errors.push(`Baris ${globalIndex + 1}: Gagal membuat karyawan`);\n                continue;\n              }\n            } else {\n              // Update existing employee with nomor lambung if provided and different\n              if (nomorLambung && existingEmployee.nomorLambung !== nomorLambung) {\n                try {\n                  await storage.updateEmployee(validatedData.employeeId, {\n                    nomorLambung: nomorLambung\n                  });\n                  // Update the map with new data\n                  employeeMap.set(validatedData.employeeId, {\n                    ...existingEmployee,\n                    nomorLambung: nomorLambung\n                  });\n                  console.log(`Updated employee nomor lambung: ${validatedData.employeeId} - ${nomorLambung}`);\n                } catch (updateError) {\n                  console.log(`Failed to update nomor lambung for ${validatedData.employeeId}`);\n                }\n              }\n            }\n\n            validatedRosters.push(validatedData);\n          } catch (error) {\n            errors.push(`Baris ${globalIndex + 1}: Data tidak valid`);\n          }\n        }\n\n        // Only log progress every 2000 rows\n        if ((batchStart + batchSize) % 2000 === 0 || batchStart + batchSize >= rosters.length) {\n          console.log(`Validated ${Math.min(batchStart + batchSize, rosters.length)} / ${rosters.length}`);\n        }\n      }\n\n      if (errors.length > 0 && errors.length === rosters.length) {\n        return res.status(400).json({ \n          message: \"Semua data tidak valid\", \n          errors: errors.slice(0, 5)\n        });\n      }\n\n      console.log(`Creating ${validatedRosters.length} schedules...`);\n\n      // Create schedules in larger batches without individual logging\n      const createdSchedules = [];\n      for (let i = 0; i < validatedRosters.length; i += batchSize) {\n        const batch = validatedRosters.slice(i, i + batchSize);\n        \n        // Process batch without individual logging\n        const batchPromises = batch.map(async (rosterData) => {\n          try {\n            return await storage.createRosterSchedule(rosterData);\n          } catch (error) {\n            return null; // Skip duplicates\n          }\n        });\n\n        const batchResults = await Promise.all(batchPromises);\n        createdSchedules.push(...batchResults.filter(result => result !== null));\n\n        // Minimal progress logging\n        if ((i + batchSize) % 2000 === 0 || i + batchSize >= validatedRosters.length) {\n          console.log(`Created ${createdSchedules.length} schedules so far`);\n        }\n      }\n\n      // Trigger cache invalidation\n      await triggerReportUpdate();\n      \n      console.log(`Completed: ${createdSchedules.length} created`);\n      \n      // Debug: Verifikasi beberapa data yang tersimpan di database\n      if (createdSchedules.length > 0) {\n        console.log('=== DATABASE SAVED DATA ===');\n        const sampleSaved = createdSchedules.slice(0, 5);\n        sampleSaved.forEach((saved, index) => {\n          console.log(`${index + 1}. NIK: ${saved.employeeId}, Date: ${saved.date}, Shift: ${saved.shift}, Hari Kerja: ${saved.hariKerja}`);\n        });\n      }\n      \n      res.status(201).json({\n        message: `${createdSchedules.length} roster berhasil ditambahkan`,\n        created: createdSchedules.length,\n        total: rosters.length,\n        errors: errors.length > 0 ? errors.slice(0, 3) : undefined\n      });\n    } catch (error) {\n      console.error('Bulk upload error:', error);\n      res.status(500).json({ message: \"Failed to bulk create roster\" });\n    }\n  });\n\n  // Update employee schedule for a specific month\n  app.post(\"/api/roster/update-employee-schedule\", async (req, res) => {\n    try {\n      const { employeeId, month, rosters } = req.body;\n\n      // Validate input\n      if (!employeeId || !month || !Array.isArray(rosters)) {\n        return res.status(400).json({ \n          message: \"Data tidak lengkap. Diperlukan: employeeId, month (YYYY-MM), dan rosters array\" \n        });\n      }\n\n      // Validate month format (YYYY-MM)\n      const monthRegex = /^\\d{4}-\\d{2}$/;\n      if (!monthRegex.test(month)) {\n        return res.status(400).json({ \n          message: \"Format bulan tidak valid. Gunakan format YYYY-MM (contoh: 2025-10)\" \n        });\n      }\n\n      // Get employee to validate\n      const employee = await storage.getEmployee(employeeId);\n      if (!employee) {\n        return res.status(404).json({ \n          message: `Karyawan dengan ID ${employeeId} tidak ditemukan` \n        });\n      }\n\n      // Validate all rosters are for the same employee\n      const invalidRosters = rosters.filter(r => r.employeeId !== employeeId);\n      if (invalidRosters.length > 0) {\n        return res.status(400).json({ \n          message: `Excel harus berisi jadwal untuk ${employee.name} (${employeeId}) saja. Ditemukan ${invalidRosters.length} baris dengan NIK berbeda.` \n        });\n      }\n\n      // Validate rosters data\n      const validatedRosters = [];\n      for (const roster of rosters) {\n        try {\n          const validatedData = insertRosterSchema.parse(roster);\n          \n          // Check if date is in the specified month\n          if (!validatedData.date.startsWith(month)) {\n            return res.status(400).json({ \n              message: `Tanggal ${validatedData.date} tidak berada di bulan ${month}` \n            });\n          }\n          \n          validatedRosters.push(validatedData);\n        } catch (error) {\n          return res.status(400).json({ \n            message: `Data roster tidak valid untuk tanggal ${roster.date}` \n          });\n        }\n      }\n\n      // CRITICAL: Check for empty rosters to prevent data loss\n      if (validatedRosters.length === 0) {\n        return res.status(400).json({\n          message: `Tidak ada jadwal valid ditemukan di Excel. Tidak ada perubahan yang dilakukan untuk menghindari penghapusan data.`\n        });\n      }\n\n      console.log(`ðŸ”„ Updating schedule for ${employee.name} (${employeeId}) in ${month}`);\n      console.log(`ðŸ“… Total ${validatedRosters.length} jadwal akan di-update`);\n\n      const startDate = `${month}-01`;\n      const year = parseInt(month.split('-')[0]);\n      const monthNum = parseInt(month.split('-')[1]);\n      const lastDay = new Date(year, monthNum, 0).getDate();\n      const endDate = `${month}-${String(lastDay).padStart(2, '0')}`;\n\n      // Step 1: INSERT new rosters FIRST (before deleting old ones)\n      const createdSchedules = [];\n      const insertErrors: string[] = [];\n      \n      for (const rosterData of validatedRosters) {\n        try {\n          const created = await storage.createRosterSchedule(rosterData);\n          createdSchedules.push(created);\n        } catch (error) {\n          const errorMsg = `Gagal insert roster untuk tanggal ${rosterData.date}: ${error instanceof Error ? error.message : 'Unknown error'}`;\n          console.error(errorMsg);\n          insertErrors.push(errorMsg);\n        }\n      }\n\n      // CRITICAL: Only proceed with deletion if ALL insertions succeeded\n      if (insertErrors.length > 0) {\n        // Rollback: delete the newly created schedules\n        console.log(`âŒ Rollback: Deleting ${createdSchedules.length} partially inserted schedules`);\n        for (const schedule of createdSchedules) {\n          try {\n            await storage.deleteRosterSchedule(schedule.id);\n          } catch (rollbackError) {\n            console.error(`Error during rollback for schedule ${schedule.id}:`, rollbackError);\n          }\n        }\n        \n        return res.status(500).json({\n          message: `Gagal update jadwal: ${insertErrors.length} dari ${validatedRosters.length} jadwal gagal disimpan. Tidak ada perubahan dilakukan.`,\n          errors: insertErrors.slice(0, 5) // Show first 5 errors\n        });\n      }\n\n      // Step 2: Delete old rosters ONLY after successful insertion\n      const allRosters = await storage.getRosterByDateRange(startDate, endDate);\n      const rostersToDelete = allRosters.filter((r: any) => r.employeeId === employeeId);\n\n      console.log(`ðŸ—‘ï¸ Deleting ${rostersToDelete.length} existing rosters for ${month}`);\n      \n      for (const roster of rostersToDelete) {\n        await storage.deleteRosterSchedule(roster.id);\n      }\n\n      console.log(`âœ… Successfully updated ${createdSchedules.length} rosters for ${month}`);\n\n      // Trigger cache invalidation\n      clearAllCaches();\n      await triggerReportUpdate();\n\n      const monthNames = [\n        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',\n        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'\n      ];\n      const monthName = monthNames[monthNum - 1];\n\n      res.json({\n        message: `Berhasil update ${createdSchedules.length} jadwal untuk ${employee.name} di ${monthName} ${year}`,\n        employee: {\n          id: employee.id,\n          name: employee.name\n        },\n        month: month,\n        deleted: rostersToDelete.length,\n        created: createdSchedules.length,\n        rosters: createdSchedules\n      });\n    } catch (error) {\n      console.error('Update employee schedule error:', error);\n      res.status(500).json({ \n        message: \"Gagal update jadwal karyawan\",\n        error: error instanceof Error ? error.message : 'Unknown error'\n      });\n    }\n  });\n\n  app.put(\"/api/roster/:id\", async (req, res) => {\n    try {\n      const validatedData = insertRosterSchema.partial().parse(req.body);\n      \n      // Auto-update startTime dan endTime jika shift berubah\n      if (validatedData.shift) {\n        if (validatedData.shift === \"Shift 1\") {\n          validatedData.startTime = \"06:00\";\n          validatedData.endTime = \"16:00\";\n        } else if (validatedData.shift === \"Shift 2\") {\n          validatedData.startTime = \"16:30\";\n          validatedData.endTime = \"20:00\";\n        }\n      }\n      \n      const schedule = await storage.updateRosterSchedule(req.params.id, validatedData);\n      if (!schedule) {\n        return res.status(404).json({ message: \"Roster tidak ditemukan\" });\n      }\n\n      // Trigger report cache invalidation\n      await triggerReportUpdate();\n      \n      res.json(schedule);\n    } catch (error) {\n      res.status(400).json({ message: \"Invalid roster data\" });\n    }\n  });\n\n  // PATCH endpoint for updating nomor lambung (today only)\n  app.patch(\"/api/roster/:id/update-nomor-lambung\", async (req, res) => {\n    try {\n      const { actualNomorLambung } = req.body;\n      \n      if (!actualNomorLambung || typeof actualNomorLambung !== 'string') {\n        return res.status(400).json({ message: \"actualNomorLambung harus diisi\" });\n      }\n\n      // Get the roster schedule\n      const schedule = await storage.getRosterSchedule(req.params.id);\n      if (!schedule) {\n        return res.status(404).json({ message: \"Roster tidak ditemukan\" });\n      }\n\n      // Validate it's today's date only\n      const today = new Date().toISOString().split('T')[0];\n      if (schedule.date !== today) {\n        return res.status(403).json({ \n          message: \"Hanya bisa update nomor lambung untuk hari ini saja\",\n          rosterDate: schedule.date,\n          today: today\n        });\n      }\n\n      // Update only actualNomorLambung\n      const updatedSchedule = await storage.updateRosterSchedule(req.params.id, {\n        actualNomorLambung\n      });\n\n      if (!updatedSchedule) {\n        return res.status(404).json({ message: \"Gagal update nomor lambung\" });\n      }\n\n      // CRITICAL: Invalidate roster cache for this date so UI gets fresh data\n      rosterCache.delete(schedule.date);\n      allEmployeesCache.clear(); // Clear employee cache as nomor lambung is part of enrichment\n      console.log(`ðŸ§¹ Cleared roster cache for ${schedule.date} after nomor lambung update`);\n      \n      // Trigger report cache invalidation\n      await triggerReportUpdate();\n      \n      res.json({\n        message: \"Nomor lambung berhasil diupdate\",\n        schedule: updatedSchedule\n      });\n    } catch (error) {\n      console.error(\"Error updating nomor lambung:\", error);\n      res.status(500).json({ message: \"Gagal update nomor lambung\" });\n    }\n  });\n\n  // Delete all roster data - must come BEFORE the :id route to avoid conflict\n  app.delete(\"/api/roster/delete-all\", async (req, res) => {\n    try {\n      await storage.deleteAllRosterSchedules();\n      \n      // Trigger report cache invalidation\n      await triggerReportUpdate();\n      \n      res.json({ message: \"Semua data roster berhasil dihapus\" });\n    } catch (error) {\n      console.error(\"Error deleting all roster data:\", error);\n      res.status(500).json({ message: \"Gagal menghapus semua data roster\" });\n    }\n  });\n\n  app.delete(\"/api/roster/:id\", async (req, res) => {\n    try {\n      const deleted = await storage.deleteRosterSchedule(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ message: \"Roster tidak ditemukan\" });\n      }\n\n      // Trigger report cache invalidation\n      await triggerReportUpdate();\n      \n      res.status(200).json({ message: \"Roster berhasil dihapus\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete roster\" });\n    }\n  });\n\n\n  // Leave routes\n  app.get(\"/api/leave\", async (req, res) => {\n    try {\n      const leaves = await storage.getAllLeaveRequests();\n      res.json(leaves);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch leave requests\" });\n    }\n  });\n\n  app.get(\"/api/leave/employee/:employeeId\", async (req, res) => {\n    try {\n      const leaves = await storage.getLeaveByEmployee(req.params.employeeId);\n      res.json(leaves);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch employee leave requests\" });\n    }\n  });\n\n  app.post(\"/api/leave\", async (req, res) => {\n    try {\n      const validatedData = insertLeaveRequestSchema.parse(req.body);\n      \n      // Check if employee exists\n      const employee = await storage.getEmployee(validatedData.employeeId);\n      if (!employee) {\n        return res.status(404).json({ message: \"Karyawan tidak ditemukan\" });\n      }\n\n      const request = await storage.createLeaveRequest(validatedData);\n      res.status(201).json(request);\n    } catch (error) {\n      res.status(400).json({ message: \"Invalid leave request data\" });\n    }\n  });\n\n  app.put(\"/api/leave/:id\", async (req, res) => {\n    try {\n      const validatedData = insertLeaveRequestSchema.partial().parse(req.body);\n      const request = await storage.updateLeaveRequest(req.params.id, validatedData);\n      if (!request) {\n        return res.status(404).json({ message: \"Leave request not found\" });\n      }\n      res.json(request);\n    } catch (error) {\n      res.status(400).json({ message: \"Invalid leave request data\" });\n    }\n  });\n\n  app.delete(\"/api/leave/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteLeaveRequest(req.params.id);\n      if (!success) {\n        return res.status(404).json({ message: \"Leave request not found\" });\n      }\n      res.json({ message: \"Leave request deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting leave request:\", error);\n      res.status(500).json({ message: \"Failed to delete leave request\" });\n    }\n  });\n\n  // Get pending leave requests from monitoring (status \"Menunggu Cuti\")\n  app.get(\"/api/leave/pending-from-monitoring\", async (req, res) => {\n    try {\n      const pendingFromMonitoring = await storage.getLeaveRosterMonitoringByStatus(\"Menunggu Cuti\");\n      \n      // Get employee data to fill missing information\n      const employees = await storage.getEmployees();\n      \n      // Transform monitoring data to leave request format\n      const pendingRequests = pendingFromMonitoring.map(monitoring => {\n        const employee = employees.find(emp => emp.id === monitoring.nik);\n        return {\n          id: `monitoring-${monitoring.id}`,\n          employeeId: monitoring.nik,\n          employeeName: monitoring.name,\n          phoneNumber: employee?.phone || \"\",\n          startDate: monitoring.nextLeaveDate || \"\",\n          endDate: \"\", // To be calculated\n          leaveType: monitoring.leaveOption === \"70\" ? \"Cuti Tahunan\" : \"Cuti Khusus\",\n          reason: `Cuti otomatis berdasarkan monitoring ${monitoring.leaveOption} hari kerja`,\n          attachmentPath: null,\n          status: \"monitoring-pending\",\n          monitoringId: monitoring.id,\n          investorGroup: monitoring.investorGroup,\n          lastLeaveDate: monitoring.lastLeaveDate,\n          monitoringDays: monitoring.monitoringDays,\n          month: monitoring.month\n        };\n      });\n      \n      res.json(pendingRequests);\n    } catch (error) {\n      console.error('Error fetching pending from monitoring:', error);\n      res.status(500).json({ message: \"Failed to fetch pending leave requests from monitoring\" });\n    }\n  });\n\n  // Process leave request from monitoring\n  app.post(\"/api/leave/process-from-monitoring\", async (req, res) => {\n    try {\n      const { monitoringId, employeeId, employeeName, phoneNumber, startDate, endDate, leaveType, reason, attachmentPath, action } = req.body;\n      \n      if (action === \"approve\") {\n        // Create actual leave request\n        const leaveRequest = await storage.createLeaveRequest({\n          employeeId,\n          employeeName,\n          phoneNumber,\n          startDate,\n          endDate,\n          leaveType,\n          reason,\n          attachmentPath,\n          status: \"approved\"\n        });\n        \n        // Update monitoring status to \"Sedang Cuti\"\n        await storage.updateLeaveRosterMonitoring(monitoringId, {\n          status: \"Sedang Cuti\"\n        });\n        \n        res.json({ message: \"Leave request approved and processed\", leaveRequest });\n      } else if (action === \"reject\") {\n        // Update monitoring status back to \"Aktif\"\n        await storage.updateLeaveRosterMonitoring(monitoringId, {\n          status: \"Aktif\"\n        });\n        \n        res.json({ message: \"Leave request rejected\" });\n      } else {\n        res.status(400).json({ message: \"Invalid action\" });\n      }\n    } catch (error) {\n      console.error('Error processing leave from monitoring:', error);\n      res.status(500).json({ message: \"Failed to process leave request\" });\n    }\n  });\n\n  // QR Token routes\n  app.post(\"/api/qr/generate\", async (req, res) => {\n    try {\n      const { employeeId } = req.body;\n      if (!employeeId) {\n        return res.status(400).json({ message: \"Employee ID is required\" });\n      }\n\n      // Check if employee exists\n      const employee = await storage.getEmployee(employeeId);\n      if (!employee) {\n        return res.status(404).json({ message: \"Karyawan tidak ditemukan\" });\n      }\n\n      // Check if employee already has an active QR token\n      const existingTokens = await storage.getQrTokensByEmployee(employeeId);\n      const activeToken = existingTokens.find(t => t.isActive);\n      \n      let token;\n      // Always regenerate token to ensure URL-safe format\n      // (Remove this after all tokens are migrated)\n      if (false && activeToken) {\n        // Use existing active token (disabled temporarily for migration)\n        token = activeToken.token;\n      } else {\n        // Generate consistent token based on employee ID only\n        const secretKey = process.env.QR_SECRET_KEY || 'AttendanceQR2024';\n        const tokenData = `${employeeId}${secretKey}Attend`;\n        token = Buffer.from(tokenData).toString('base64').slice(0, 16)\n          .replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, ''); // Make URL-safe\n\n        // Create new token\n        await storage.createQrToken({\n          employeeId,\n          token,\n          isActive: true\n        });\n      }\n\n      // Create URL yang mengarah ke aplikasi untuk QR Code\n      const baseUrl = process.env.REPLIT_DOMAINS \n        ? `https://${process.env.REPLIT_DOMAINS.split(',')[0]}`\n        : 'http://localhost:5000';\n      \n      // Create JSON format for internal app QR scanner (original format)\n      const qrPayload = {\n        id: employeeId,\n        token: token\n      };\n      const qrData = JSON.stringify(qrPayload);\n\n      res.json({\n        employeeId,\n        token,\n        qrData: qrData // JSON format untuk sistem scan QR internal\n      });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to generate QR token\" });\n    }\n  });\n\n  // Simple QR redirect endpoint for mobile scanner compatibility\n  app.get(\"/qr/:employeeId\", async (req, res) => {\n    try {\n      const { employeeId } = req.params;\n      \n      // Log for debugging mobile scanner access\n      console.log(`ðŸ“± QR Scanner access: ${employeeId} from ${req.get('User-Agent')}`);\n      \n      // Check if employee exists\n      const employee = await storage.getEmployee(employeeId);\n      if (!employee) {\n        return res.status(404).send(`\n          <html>\n            <head><title>Karyawan Tidak Ditemukan</title></head>\n            <body style=\"font-family: Arial; text-align: center; padding: 50px;\">\n              <h2>âŒ Karyawan Tidak Ditemukan</h2>\n              <p>NIK: ${employeeId}</p>\n            </body>\n          </html>\n        `);\n      }\n\n      // Redirect to driver view with NIK parameter\n      const redirectUrl = `/driver-view?nik=${employeeId}`;\n      \n      // Use HTML meta refresh for better mobile compatibility\n      res.send(`\n        <html>\n          <head>\n            <title>Redirect ke Driver View</title>\n            <meta http-equiv=\"refresh\" content=\"0; url=${redirectUrl}\">\n            <script>\n              // Fallback JavaScript redirect\n              setTimeout(() => {\n                window.location.href = '${redirectUrl}';\n              }, 100);\n            </script>\n          </head>\n          <body style=\"font-family: Arial; text-align: center; padding: 50px;\">\n            <h2>ðŸ”„ Mengarahkan...</h2>\n            <p>Membuka data karyawan: ${employee.name}</p>\n            <p>Jika tidak dialihkan otomatis, <a href=\"${redirectUrl}\">klik di sini</a></p>\n          </body>\n        </html>\n      `);\n    } catch (error) {\n      console.error('âŒ Error in QR redirect:', error);\n      res.status(500).send(`\n        <html>\n          <head><title>Error</title></head>\n          <body style=\"font-family: Arial; text-align: center; padding: 50px;\">\n            <h2>âŒ Terjadi Kesalahan</h2>\n            <p>Silahkan coba lagi</p>\n          </body>\n        </html>\n      `);\n    }\n  });\n\n  app.post(\"/api/qr/validate\", async (req, res) => {\n    try {\n      const { employeeId, token } = req.body;\n      if (!employeeId || !token) {\n        return res.status(400).json({ message: \"Employee ID and token are required\" });\n      }\n\n      // Check cache first for faster response\n      const today = new Date().toISOString().split('T')[0];\n      let employee = getCachedEmployee(employeeId);\n      \n      if (!employee) {\n        // Parallel execution for faster response + enhanced employee lookup\n        console.log(`Regular QR Scan - Looking for employee ID: \"${employeeId}\" (type: ${typeof employeeId})`);\n        \n        const [employeeData, todayRoster] = await Promise.all([\n          storage.getEmployee(employeeId),\n          storage.getRosterByDate(today)\n        ]);\n        employee = employeeData;\n        \n        // If employee not found by direct lookup, try alternative methods\n        if (!employee) {\n          console.log(`Employee \"${employeeId}\" not found in direct lookup, trying alternatives...`);\n          \n          const allEmployees = await storage.getAllEmployees();\n          console.log(`Total employees in system: ${allEmployees.length}`);\n          \n          // Try to find by trimmed ID or fuzzy match\n          const foundEmployee = allEmployees.find(emp => \n            emp.id === employeeId || \n            emp.id === employeeId.trim() ||\n            emp.id.toLowerCase() === employeeId.toLowerCase() ||\n            emp.name.toLowerCase().includes(employeeId.toLowerCase())\n          );\n          \n          if (foundEmployee) {\n            console.log(`Found employee by alternative lookup: ${foundEmployee.id} - ${foundEmployee.name}`);\n            employee = foundEmployee;\n          } else {\n            console.log(`Employee \"${employeeId}\" not found in ${allEmployees.length} total employees`);\n            console.log('Sample employee IDs:', allEmployees.slice(0, 5).map(emp => `\"${emp.id}\"`));\n          }\n        }\n        \n        if (employee) setCachedEmployee(employeeId, employee);\n        var roster = todayRoster;\n      } else {\n        // Employee found in cache, only fetch roster\n        var roster = await storage.getRosterByDate(today);\n      }\n      \n      const todayRoster = roster;\n\n      if (!employee) {\n        return res.status(404).json({ \n          message: \"Karyawan tidak ditemukan\",\n          debug: {\n            searchedId: employeeId,\n            idType: typeof employeeId\n          }\n        });\n      }\n      \n      console.log(`Regular QR validation - Found employee: ${employee.id} - ${employee.name}`);\n\n      // Validate token using QR tokens table (more reliable)\n      const qrTokens = await storage.getQrTokensByEmployee(employeeId);\n      const validToken = qrTokens.find(t => t.token === token && t.isActive);\n\n      if (!validToken) {\n        return res.status(400).json({ message: \"Token QR tidak valid atau sudah tidak aktif\" });\n      }\n\n      const employeeRoster = todayRoster.find(r => r.employeeId === employeeId);\n\n      // Add time validation warning for better UX\n      let timeValidation = null;\n      if (employeeRoster) {\n        const now = new Date();\n        // Convert to Indonesia timezone (WITA UTC+8)\n        const indonesiaOffset = 8 * 60; // 8 hours in minutes\n        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);\n        const indonesiaTime = new Date(utc + (indonesiaOffset * 60000));\n        const currentTime = `${indonesiaTime.getHours().toString().padStart(2, '0')}:${indonesiaTime.getMinutes().toString().padStart(2, '0')}`;\n        const isValidTiming = isValidShiftTimeByName(currentTime, employeeRoster.shift);\n        const timeRange = getShiftTimeRange(employeeRoster.shift);\n        const isCompletelyOutside = isCompletelyOutsideShiftTimes(currentTime);\n        \n        let warning = null;\n        if (!isValidTiming) {\n          if (isCompletelyOutside) {\n            warning = `âš ï¸ PERINGATAN: Saat ini diluar jam kerja (${currentTime}). Absensi hanya diizinkan pada Shift 1 (04:00-10:00) atau Shift 2 (16:00-22:00)`;\n          } else {\n            warning = `âš ï¸ PERINGATAN: Waktu sekarang (${currentTime}) tidak sesuai dengan shift Anda (${employeeRoster.shift}: ${timeRange.start}-${timeRange.end})`;\n          }\n        }\n        \n        timeValidation = {\n          currentTime: currentTime,\n          isValidTiming: isValidTiming,\n          warning: warning\n        };\n      }\n\n      res.json({ \n        valid: true, \n        employee,\n        roster: employeeRoster || null,\n        timeValidation: timeValidation,\n        message: \"QR token is valid\" \n      });\n    } catch (error) {\n      console.error(\"QR validation error:\", error);\n      res.status(500).json({ message: \"Failed to validate QR token\" });\n    }\n  });\n\n  // Attendance validation for Driver View QR codes (no token required)\n  app.post(\"/api/attendance/validate-employee\", async (req, res) => {\n    try {\n      const { employeeId } = req.body;\n      if (!employeeId) {\n        return res.status(400).json({ message: \"Employee ID is required\" });\n      }\n\n      console.log(`Driver View QR Scan - Looking for employee ID: \"${employeeId}\"`);\n\n      // Check cache first for faster response\n      const today = new Date().toISOString().split('T')[0];\n      let employee = getCachedEmployee(employeeId);\n      \n      if (!employee) {\n        // Parallel execution for faster response\n        const [employeeData, todayRoster] = await Promise.all([\n          storage.getEmployee(employeeId),\n          storage.getRosterByDate(today)\n        ]);\n        employee = employeeData;\n        \n        // If employee not found by direct lookup, try alternative methods\n        if (!employee) {\n          console.log(`Employee \"${employeeId}\" not found in direct lookup, trying alternatives...`);\n          \n          const allEmployees = await storage.getAllEmployees();\n          const foundEmployee = allEmployees.find(emp => \n            emp.id === employeeId || \n            emp.id === employeeId.trim() ||\n            emp.id.toLowerCase() === employeeId.toLowerCase()\n          );\n          \n          if (foundEmployee) {\n            console.log(`Found employee by alternative lookup: ${foundEmployee.id} - ${foundEmployee.name}`);\n            employee = foundEmployee;\n          }\n        }\n        \n        if (employee) setCachedEmployee(employeeId, employee);\n        var roster = todayRoster;\n      } else {\n        var roster = await storage.getRosterByDate(today);\n      }\n\n      if (!employee) {\n        return res.status(404).json({ \n          message: \"Karyawan tidak ditemukan\",\n          debug: { searchedId: employeeId }\n        });\n      }\n      \n      console.log(`Driver View validation - Found employee: ${employee.id} - ${employee.name}`);\n\n      const employeeRoster = roster.find((r: any) => r.employeeId === employeeId);\n\n      // Time validation (same as token-based validation)\n      let timeValidation = null;\n      if (employeeRoster) {\n        const now = new Date();\n        const indonesiaOffset = 8 * 60;\n        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);\n        const indonesiaTime = new Date(utc + (indonesiaOffset * 60000));\n        const currentTime = `${indonesiaTime.getHours().toString().padStart(2, '0')}:${indonesiaTime.getMinutes().toString().padStart(2, '0')}`;\n        const isValidTiming = isValidShiftTimeByName(currentTime, employeeRoster.shift);\n        const timeRange = getShiftTimeRange(employeeRoster.shift);\n        const isCompletelyOutside = isCompletelyOutsideShiftTimes(currentTime);\n        \n        let warning = null;\n        if (!isValidTiming) {\n          if (isCompletelyOutside) {\n            warning = `âš ï¸ PERINGATAN: Saat ini diluar jam kerja (${currentTime}). Absensi hanya diizinkan pada Shift 1 (04:00-10:00) atau Shift 2 (16:00-22:00)`;\n          } else {\n            warning = `âš ï¸ PERINGATAN: Waktu sekarang (${currentTime}) tidak sesuai dengan shift Anda (${employeeRoster.shift}: ${timeRange.start}-${timeRange.end})`;\n          }\n        }\n        \n        timeValidation = {\n          currentTime: currentTime,\n          isValidTiming: isValidTiming,\n          warning: warning\n        };\n      }\n\n      res.json({ \n        valid: true, \n        employee,\n        roster: employeeRoster || null,\n        timeValidation: timeValidation,\n        message: \"Employee validated (Driver View QR)\",\n        source: \"driver-view\" // Log source for analytics\n      });\n    } catch (error) {\n      console.error(\"Driver View validation error:\", error);\n      res.status(500).json({ message: \"Failed to validate employee\" });\n    }\n  });\n\n  // Sidak Observer QR validation - simplified for observer data extraction\n  app.post(\"/api/qr/observer\", async (req, res) => {\n    try {\n      const { employeeId, token } = req.body;\n      if (!employeeId || !token) {\n        return res.status(400).json({ message: \"Employee ID and token are required\" });\n      }\n\n      // Get employee data\n      let employee = getCachedEmployee(employeeId);\n      if (!employee) {\n        employee = await storage.getEmployee(employeeId);\n        if (employee) setCachedEmployee(employeeId, employee);\n      }\n\n      if (!employee) {\n        return res.status(404).json({ message: \"Karyawan tidak ditemukan\" });\n      }\n\n      // Validate token using QR tokens table\n      const qrTokens = await storage.getQrTokensByEmployee(employeeId);\n      const validToken = qrTokens.find(t => t.token === token && t.isActive);\n\n      if (!validToken) {\n        return res.status(400).json({ message: \"Token QR tidak valid atau sudah tidak aktif\" });\n      }\n\n      // Return observer data (minimal fields needed for Sidak forms)\n      res.json({\n        valid: true,\n        observer: {\n          nama: employee.name,\n          nik: employee.id, // Employee ID is used as NIK (Employee schema doesn't have dedicated nik field)\n          perusahaan: employee.investorGroup || \"PT.GECL\",\n          jabatan: employee.position || \"Karyawan\"\n        },\n        message: \"QR token valid untuk observer\"\n      });\n    } catch (error) {\n      console.error(\"Observer QR validation error:\", error);\n      res.status(500).json({ message: \"Failed to validate observer QR token\" });\n    }\n  });\n\n  // Dashboard stats with optional date filter (query param or path param)\n  app.get(\"/api/dashboard/stats/:date?\", async (req, res) => {\n    try {\n      const date = req.params.date || (req.query.date as string) || new Date().toISOString().split('T')[0];\n      \n      const [employees, dateAttendance, dateRoster, leaveRequests] = await Promise.all([\n        storage.getAllEmployees(),\n        storage.getAllAttendance(date),\n        storage.getRosterByDate(date),\n        storage.getAllLeaveRequests()\n      ]);\n\n      const activeLeavesOnDate = leaveRequests.filter(leave => \n        leave.status === 'approved' && \n        leave.startDate <= date && \n        leave.endDate >= date\n      );\n\n      const stats = {\n        totalEmployees: employees.length,\n        scheduledToday: dateRoster.length,\n        presentToday: dateAttendance.length,\n        absentToday: dateRoster.length - dateAttendance.length,\n        onLeaveToday: activeLeavesOnDate.length,\n        pendingLeaveRequests: leaveRequests.filter(leave => leave.status === 'pending').length\n      };\n\n      res.json(stats);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch dashboard stats\" });\n    }\n  });\n\n  // Report update status endpoint\n  app.get(\"/api/report-update-status\", async (req, res) => {\n    try {\n      res.json({\n        lastRosterUpdate: lastRosterUpdate.toISOString(),\n        message: \"Roster data auto-sync active\",\n        timestamp: new Date().toISOString()\n      });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to get update status\" });\n    }\n  });\n\n  // Recent attendance activities (query param or path param)\n  app.get(\"/api/dashboard/recent-activities/:date?\", async (req, res) => {\n    try {\n      const date = req.params.date || (req.query.date as string) || new Date().toISOString().split('T')[0];\n      \n      const [attendance, employees] = await Promise.all([\n        storage.getAllAttendance(date),\n        storage.getAllEmployees()\n      ]);\n\n      // Get recent activities (latest 10 attendance records)\n      const recentActivities = await Promise.all(\n        attendance\n          .sort((a, b) => new Date(b.createdAt || b.date).getTime() - new Date(a.createdAt || a.date).getTime())\n          .slice(0, 10)\n          .map(async (record) => {\n            const employee = employees.find(emp => emp.id === record.employeeId);\n            \n            // Ambil data hari kerja langsung dari kolom monitoring yang sudah ada\n            let workingDays = 0;\n            try {\n              if (employee?.id) {\n                const allMonitoring = await storage.getAllLeaveRosterMonitoring();\n                const monitoring = allMonitoring.find(m => m.nik === employee.id); // NIK sama dengan employee ID\n                \n                if (monitoring) {\n                  // Langsung ambil dari kolom monitoringDays yang sudah ada\n                  workingDays = monitoring.monitoringDays || 0;\n                }\n              }\n            } catch (error) {\n              console.error(\"Error getting working days from monitoring data:\", error);\n              workingDays = 0;\n            }\n            \n            return {\n              id: record.id,\n              employeeId: record.employeeId,\n              employeeName: employee?.name || 'Unknown',\n              time: record.time,\n              jamTidur: record.jamTidur,\n              fitToWork: record.fitToWork,\n              status: record.status,\n              createdAt: record.createdAt,\n              workingDays: workingDays\n            };\n          })\n      );\n\n      res.json(recentActivities);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch recent activities\" });\n    }\n  });\n\n  // Driver Evaluation from SIDAK Fatigue data\n  app.get(\"/api/evaluasi-driver\", async (req, res) => {\n    try {\n      const month = req.query.month as string; // Format: YYYY-MM\n      const status = req.query.status as string; // \"semua\" | \"sudah\" | \"belum\"\n\n      if (!month) {\n        return res.status(400).json({ message: \"Month parameter is required (format: YYYY-MM)\" });\n      }\n\n      // Get all employees and SIDAK Fatigue sessions\n      const [allEmployees, allSessions] = await Promise.all([\n        storage.getAllEmployees(),\n        storage.getAllSidakFatigueSessions()\n      ]);\n\n      // Filter to get DRIVERS ONLY (position = \"driver\")\n      const driversOnly = allEmployees.filter(emp => \n        emp.position?.toLowerCase() === \"driver\"\n      );\n\n      // Filter sessions by month\n      const monthSessions = allSessions.filter(session => session.tanggal.startsWith(month));\n\n      // Get all records for filtered sessions using batched storage method (avoids connection limit)\n      const sessionIds = monthSessions.map(s => s.id);\n      const allRecords = await storage.getSidakFatigueRecordsBySessionIds(sessionIds);\n\n      // Count SIDAK per employee (by NIK)\n      const sidakCountByNik = allRecords.reduce((acc, record) => {\n        acc[record.nik] = (acc[record.nik] || 0) + 1;\n        return acc;\n      }, {} as Record<string, number>);\n\n      // Build evaluation data for DRIVERS ONLY (BEFORE status filtering)\n      const allEvaluationData = driversOnly.map(employee => ({\n        id: employee.id,\n        nama: employee.name,\n        nik: employee.id, // Using ID as NIK\n        totalSidak: sidakCountByNik[employee.id] || 0,\n        status: (sidakCountByNik[employee.id] || 0) > 0 ? \"Sudah SIDAK\" : \"Belum SIDAK\"\n      }));\n\n      // Calculate summary stats from DRIVERS ONLY (UNFILTERED by status)\n      const totalDrivers = driversOnly.length;\n      const sudahSidak = allEvaluationData.filter(emp => emp.totalSidak > 0).length;\n      const belumSidak = totalDrivers - sudahSidak;\n      const totalSidakKeseluruhan = allRecords.length;\n\n      // Apply status filter AFTER computing summary\n      let filteredEvaluationData = allEvaluationData;\n      if (status === \"sudah\") {\n        filteredEvaluationData = allEvaluationData.filter(emp => emp.totalSidak > 0);\n      } else if (status === \"belum\") {\n        filteredEvaluationData = allEvaluationData.filter(emp => emp.totalSidak === 0);\n      }\n\n      res.json({\n        summary: {\n          totalDrivers,\n          sudahSidak,\n          belumSidak,\n          totalSidakKeseluruhan\n        },\n        drivers: filteredEvaluationData,\n        month\n      });\n    } catch (error) {\n      console.error(\"Error fetching evaluasi driver:\", error);\n      res.status(500).json({ message: \"Failed to fetch driver evaluation\" });\n    }\n  });\n\n\n\n\n\n\n\n\n  // WhatsApp Leave Monitoring endpoints\n  app.get(\"/api/leave-monitoring/upcoming\", async (req, res) => {\n    try {\n      const { LeaveMonitoringService } = await import('./leaveMonitoringService');\n      const monitoringService = new LeaveMonitoringService(storage as any);\n      const upcomingLeaves = await monitoringService.checkUpcomingLeaves();\n      res.json(upcomingLeaves);\n    } catch (error) {\n      console.error(\"Error fetching upcoming leaves:\", error);\n      res.status(500).json({ error: \"Failed to fetch upcoming leaves\" });\n    }\n  });\n\n  app.post(\"/api/leave-monitoring/send-reminders\", async (req, res) => {\n    try {\n      const { LeaveMonitoringService } = await import('./leaveMonitoringService');\n      const monitoringService = new LeaveMonitoringService(storage as any);\n      const result = await monitoringService.sendLeaveReminders();\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error sending reminders:\", error);\n      res.status(500).json({ error: \"Failed to send reminders\" });\n    }\n  });\n\n  app.get(\"/api/leave-monitoring/history\", async (req, res) => {\n    try {\n      const { LeaveMonitoringService } = await import('./leaveMonitoringService');\n      const monitoringService = new LeaveMonitoringService(storage as any);\n      const history = await monitoringService.getLeaveReminderHistory();\n      res.json(history);\n    } catch (error) {\n      console.error(\"Error fetching reminder history:\", error);\n      res.status(500).json({ error: \"Failed to fetch reminder history\" });\n    }\n  });\n\n  // Leave balance endpoints\n  app.get(\"/api/leave-balances\", async (req, res) => {\n    try {\n      const balances = await storage.getLeaveBalances();\n      res.json(balances);\n    } catch (error) {\n      console.error(\"Error fetching leave balances:\", error);\n      res.status(500).json({ error: \"Failed to fetch leave balances\" });\n    }\n  });\n\n  app.get(\"/api/leave-balances/:employeeId\", async (req, res) => {\n    try {\n      const { employeeId } = req.params;\n      const year = req.query.year ? parseInt(req.query.year as string) : new Date().getFullYear();\n      const balance = await storage.getLeaveBalanceByEmployee(employeeId, year);\n      res.json(balance);\n    } catch (error) {\n      console.error(\"Error fetching employee leave balance:\", error);\n      res.status(500).json({ error: \"Failed to fetch employee leave balance\" });\n    }\n  });\n\n  // Leave history endpoints\n  app.get(\"/api/leave-history\", async (req, res) => {\n    try {\n      const history = await storage.getLeaveHistory();\n      res.json(history);\n    } catch (error) {\n      console.error(\"Error fetching leave history:\", error);\n      res.status(500).json({ error: \"Failed to fetch leave history\" });\n    }\n  });\n\n  app.get(\"/api/leave-history/:employeeId\", async (req, res) => {\n    try {\n      const { employeeId } = req.params;\n      const history = await storage.getLeaveHistoryByEmployee(employeeId);\n      res.json(history);\n    } catch (error) {\n      console.error(\"Error fetching employee leave history:\", error);\n      res.status(500).json({ error: \"Failed to fetch employee leave history\" });\n    }\n  });\n\n  // Bulk upload leave roster\n  app.post(\"/api/leave-roster/bulk-upload\", async (req, res) => {\n    try {\n      const { leaveData } = req.body;\n      \n      if (!Array.isArray(leaveData)) {\n        return res.status(400).json({ error: \"Invalid data format\" });\n      }\n\n      const result = await storage.bulkUploadLeaveRoster(leaveData);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error bulk uploading leave roster:\", error);\n      res.status(500).json({ error: \"Failed to upload leave roster\" });\n    }\n  });\n\n  // Download template for leave roster upload\n  app.get(\"/api/leave-roster/template\", async (req, res) => {\n    try {\n      const templateData = [\n        [\"NIK\", \"Jenis Cuti\", \"Tanggal Mulai\", \"Tanggal Selesai\", \"Total Hari\"],\n        [\"C-015227\", \"Cuti Tahunan\", \"2025-08-25\", \"2025-08-27\", \"3\"],\n        [\"C-030015\", \"Cuti Sakit\", \"2025-08-28\", \"2025-08-29\", \"2\"],\n        [\"C-045123\", \"Cuti Melahirkan\", \"2025-09-01\", \"2025-11-01\", \"61\"],\n        [\"\", \"\", \"\", \"\", \"\"],\n        [\"Format tanggal: YYYY-MM-DD (contoh: 2025-08-25)\", \"\", \"\", \"\", \"\"],\n        [\"Jenis cuti: Cuti Tahunan, Cuti Sakit, Cuti Melahirkan, dll\", \"\", \"\", \"\", \"\"]\n      ];\n\n      const csvContent = templateData.map(row => row.join(',')).join('\\n');\n      \n      res.setHeader('Content-Type', 'text/csv');\n      res.setHeader('Content-Disposition', 'attachment; filename=\"template-roster-cuti.csv\"');\n      res.send(csvContent);\n    } catch (error) {\n      console.error(\"Error generating template:\", error);\n      res.status(500).json({ error: \"Failed to generate template\" });\n    }\n  });\n\n  // Dashboard Evaluasi Cuti API endpoints\n  app.get(\"/api/leave-analytics/overview\", async (req, res) => {\n    try {\n      const employees = await storage.getAllEmployees();\n      const leaveRequests = await storage.getAllLeaveRequests();\n      const leaveBalances = await storage.getLeaveBalances();\n      \n      // Statistik umum\n      const totalEmployees = employees.length;\n      const totalLeaveRequests = leaveRequests.length;\n      const pendingRequests = leaveRequests.filter(req => req.status === 'pending').length;\n      const approvedRequests = leaveRequests.filter(req => req.status === 'approved').length;\n      const totalLeaveDaysTaken = leaveBalances.reduce((sum, balance) => sum + balance.usedDays, 0);\n      \n      // Karyawan dengan cuti paling banyak\n      const topLeaveEmployees = leaveBalances\n        .sort((a, b) => b.usedDays - a.usedDays)\n        .slice(0, 5)\n        .map(balance => {\n          const employee = employees.find(emp => emp.id === balance.employeeId);\n          return {\n            employeeId: balance.employeeId,\n            employeeName: employee?.name || 'Unknown',\n            usedDays: balance.usedDays,\n            remainingDays: balance.remainingDays,\n            percentage: Math.round((balance.usedDays / balance.totalDays) * 100)\n          };\n        });\n\n      // Tren cuti per bulan (6 bulan terakhir)\n      const sixMonthsAgo = new Date();\n      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);\n      \n      const monthlyLeaveData = [];\n      for (let i = 5; i >= 0; i--) {\n        const date = new Date();\n        date.setMonth(date.getMonth() - i);\n        const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\n        \n        const monthRequests = leaveRequests.filter(req => {\n          return req.startDate.startsWith(monthYear);\n        });\n        \n        monthlyLeaveData.push({\n          month: date.toLocaleDateString('id-ID', { month: 'short' }),\n          requests: monthRequests.length,\n          totalDays: monthRequests.reduce((sum, req) => {\n            const start = new Date(req.startDate);\n            const end = new Date(req.endDate);\n            return sum + Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24)) + 1;\n          }, 0)\n        });\n      }\n\n      // Distribusi jenis cuti\n      const leaveTypeDistribution = leaveRequests.reduce((acc, req) => {\n        acc[req.leaveType] = (acc[req.leaveType] || 0) + 1;\n        return acc;\n      }, {} as Record<string, number>);\n\n      res.json({\n        overview: {\n          totalEmployees,\n          totalLeaveRequests,\n          pendingRequests,\n          approvedRequests,\n          totalLeaveDaysTaken,\n          averageLeaveDays: totalEmployees > 0 ? Math.round(totalLeaveDaysTaken / totalEmployees) : 0\n        },\n        topLeaveEmployees,\n        monthlyLeaveData,\n        leaveTypeDistribution\n      });\n    } catch (error) {\n      console.error(\"Error fetching leave analytics overview:\", error);\n      res.status(500).json({ message: \"Failed to fetch leave analytics\" });\n    }\n  });\n\n  app.get(\"/api/leave-analytics/department\", async (req, res) => {\n    try {\n      const employees = await storage.getAllEmployees();\n      const leaveBalances = await storage.getLeaveBalances();\n      \n      // Grup by department\n      const departmentStats = employees.reduce((acc, employee) => {\n        const dept = employee.department || 'Unknown';\n        if (!acc[dept]) {\n          acc[dept] = {\n            department: dept,\n            totalEmployees: 0,\n            totalLeaveDays: 0,\n            averageLeaveDays: 0,\n            employees: []\n          };\n        }\n        \n        const balance = leaveBalances.find(b => b.employeeId === employee.id);\n        const usedDays = balance?.usedDays || 0;\n        \n        acc[dept].totalEmployees++;\n        acc[dept].totalLeaveDays += usedDays;\n        acc[dept].employees.push({\n          nik: employee.id,\n          name: employee.name,\n          position: employee.position,\n          usedDays,\n          remainingDays: balance?.remainingDays || 0\n        });\n        \n        return acc;\n      }, {} as Record<string, any>);\n\n      // Calculate averages\n      Object.values(departmentStats).forEach((dept: any) => {\n        dept.averageLeaveDays = dept.totalEmployees > 0 \n          ? Math.round(dept.totalLeaveDays / dept.totalEmployees) \n          : 0;\n      });\n\n      res.json(Object.values(departmentStats));\n    } catch (error) {\n      console.error(\"Error fetching department analytics:\", error);\n      res.status(500).json({ message: \"Failed to fetch department analytics\" });\n    }\n  });\n\n\n\n  // Object storage routes for file uploads\n  app.get(\"/objects/:objectPath(*)\", async (req, res) => {\n    const objectStorageService = new ObjectStorageService();\n    try {\n      const objectFile = await objectStorageService.getObjectEntityFile(\n        req.path,\n      );\n      objectStorageService.downloadObject(objectFile, res);\n    } catch (error) {\n      console.error(\"Error accessing object:\", error);\n      if (error instanceof ObjectNotFoundError) {\n        return res.sendStatus(404);\n      }\n      return res.sendStatus(500);\n    }\n  });\n\n  app.post(\"/api/objects/upload\", async (req, res) => {\n    try {\n      const objectStorageService = new ObjectStorageService();\n      const uploadURL = await objectStorageService.getObjectEntityUploadURL();\n      res.json({ uploadURL });\n    } catch (error) {\n      console.error(\"Object storage not configured:\", error);\n      res.status(503).json({ \n        error: \"Object storage not configured\",\n        message: \"File upload is temporarily unavailable. Please contact administrator.\"\n      });\n    }\n  });\n\n  // Endpoint untuk normalize upload URL\n  app.post(\"/api/objects/normalize\", async (req, res) => {\n    try {\n      const { uploadURL } = req.body;\n      if (!uploadURL) {\n        return res.status(400).json({ error: \"uploadURL is required\" });\n      }\n\n      const objectStorageService = new ObjectStorageService();\n      const objectPath = objectStorageService.normalizeObjectEntityPath(uploadURL);\n      \n      res.json({ objectPath });\n    } catch (error) {\n      console.error(\"Error normalizing object path:\", error);\n      res.status(500).json({ error: \"Internal server error\" });\n    }\n  });\n\n\n\n  // Leave Roster Monitoring routes\n  app.get(\"/api/leave-roster-monitoring\", async (req, res) => {\n    try {\n      const monitoring = await storage.getAllLeaveRosterMonitoring();\n      res.json(monitoring);\n    } catch (error) {\n      console.error(\"Error fetching leave roster monitoring:\", error);\n      res.status(500).json({ message: \"Failed to fetch leave roster monitoring\" });\n    }\n  });\n\n  app.get(\"/api/leave-roster-monitoring/:id\", async (req, res) => {\n    try {\n      const monitoring = await storage.getLeaveRosterMonitoring(req.params.id);\n      if (!monitoring) {\n        return res.status(404).json({ message: \"Monitoring data not found\" });\n      }\n      res.json(monitoring);\n    } catch (error) {\n      console.error(\"Error fetching leave roster monitoring:\", error);\n      res.status(500).json({ message: \"Failed to fetch leave roster monitoring\" });\n    }\n  });\n\n  app.post(\"/api/leave-roster-monitoring\", async (req, res) => {\n    try {\n      const monitoring = await storage.createLeaveRosterMonitoring(req.body);\n      res.status(201).json(monitoring);\n    } catch (error) {\n      console.error(\"Error creating leave roster monitoring:\", error);\n      res.status(500).json({ message: \"Failed to create leave roster monitoring\" });\n    }\n  });\n\n  app.put(\"/api/leave-roster-monitoring/:id\", async (req, res) => {\n    try {\n      const monitoring = await storage.updateLeaveRosterMonitoring(req.params.id, req.body);\n      if (!monitoring) {\n        return res.status(404).json({ message: \"Monitoring data not found\" });\n      }\n      res.json(monitoring);\n    } catch (error) {\n      console.error(\"Error updating leave roster monitoring:\", error);\n      res.status(500).json({ message: \"Failed to update leave roster monitoring\" });\n    }\n  });\n\n  // Delete all route must come BEFORE the :id route to avoid conflict\n  app.delete(\"/api/leave-roster-monitoring/delete-all\", async (req, res) => {\n    try {\n      await storage.deleteAllLeaveRosterMonitoring();\n      res.json({ message: \"All leave roster monitoring data deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting all leave roster monitoring data:\", error);\n      res.status(500).json({ message: \"Failed to delete all leave roster monitoring data\" });\n    }\n  });\n\n  // Clear all leave roster monitoring data (must be before :id route)\n  app.delete(\"/api/leave-roster-monitoring/clear-all\", async (req, res) => {\n    try {\n      await storage.deleteAllLeaveRosterMonitoring();\n      res.json({ \n        success: true,\n        message: \"Semua data roster monitoring berhasil dihapus\"\n      });\n    } catch (error) {\n      console.error(\"Error clearing leave roster monitoring data:\", error);\n      res.status(500).json({ \n        error: \"Failed to clear data\", \n        details: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  });\n\n  app.delete(\"/api/leave-roster-monitoring/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteLeaveRosterMonitoring(req.params.id);\n      if (!success) {\n        return res.status(404).json({ message: \"Monitoring data not found\" });\n      }\n      res.json({ message: \"Leave roster monitoring deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting leave roster monitoring:\", error);\n      res.status(500).json({ message: \"Failed to delete leave roster monitoring\" });\n    }\n  });\n\n  app.post(\"/api/leave-roster-monitoring/update-status\", async (req, res) => {\n    try {\n      await storage.updateLeaveRosterStatus();\n      res.json({ message: \"Status updated successfully\" });\n    } catch (error) {\n      console.error(\"Error updating leave roster status:\", error);\n      res.status(500).json({ message: \"Failed to update leave roster status\" });\n    }\n  });\n\n  // Excel upload endpoint for leave roster monitoring\n  app.post(\"/api/leave-roster-monitoring/upload-excel\", async (req, res) => {\n    try {\n      const multer = (await import('multer')).default;\n      const XLSX = (await import('xlsx'));\n      \n      // Setup multer for memory storage\n      const upload = multer({ storage: multer.memoryStorage() });\n      \n      // Handle file upload\n      upload.single('file')(req as any, res, async (err: any) => {\n        if (err) {\n          console.error(\"Multer error:\", err);\n          return res.status(400).json({ error: \"File upload error\", details: err.message });\n        }\n\n        const file = (req as any).file;\n        if (!file) {\n          console.error(\"No file received in request\");\n          return res.status(400).json({ error: \"No file uploaded\" });\n        }\n\n        console.log(\"File received:\", file.originalname, \"Size:\", file.size);\n\n        try {\n          const workbook = XLSX.read(file.buffer, { type: 'buffer' });\n          const worksheet = workbook.Sheets[workbook.SheetNames[0]];\n          const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });\n\n          console.log(\"Excel data parsed:\", data.length, \"rows\");\n\n          // Skip header row\n          const rows = data.slice(1) as any[][];\n          \n          let successCount = 0;\n          const errors: string[] = [];\n\n          for (let i = 0; i < rows.length; i++) {\n            const row = rows[i];\n            console.log(`Processing row ${i + 2}:`, row);\n            console.log(`Row length: ${row.length}`);\n            \n            if (!row || row.length < 2) {\n              console.log(`Row ${i + 2}: Skipping empty row`);\n              continue;\n            }\n            \n            // Skip rows with empty or invalid data\n            const hasValidData = row.some(cell => \n              cell !== null && \n              cell !== undefined && \n              cell !== '' && \n              cell !== '#N/A' && \n              cell.toString().trim() !== ''\n            );\n            \n            if (!hasValidData) {\n              console.log(`Row ${i + 2}: Skipping row with no valid data`);\n              continue;\n            }\n\n            // Format data sesuai Excel file: NIK, Nama, Nomor Lambung, Bulan, Tanggal Terakhir Cuti, Pilihan Cuti, OnSite, Investor Group\n            // Handle various Excel column formats by checking length\n            let nik, name, nomorLambung, monthOrBulan, lastLeaveDateSerial, leaveOption, onSiteData, investorGroupData;\n            \n            if (row.length >= 8) {\n              [nik, name, nomorLambung, monthOrBulan, lastLeaveDateSerial, leaveOption, onSiteData, investorGroupData] = row;\n            } else if (row.length >= 7) {\n              [nik, name, nomorLambung, monthOrBulan, lastLeaveDateSerial, leaveOption, onSiteData] = row;\n            } else if (row.length >= 6) {\n              [nik, name, nomorLambung, monthOrBulan, lastLeaveDateSerial, leaveOption] = row;\n            } else if (row.length >= 5) {\n              [nik, name, nomorLambung, monthOrBulan, lastLeaveDateSerial] = row;\n            } else if (row.length >= 4) {\n              [nik, name, nomorLambung, monthOrBulan] = row;\n            } else if (row.length >= 3) {\n              [nik, name, nomorLambung] = row;\n            } else {\n              [nik, name] = row;\n            }\n            \n            console.log(`Parsed values - NIK: ${nik}, Name: ${name}, NomorLambung: ${nomorLambung}, Month: ${monthOrBulan}, LastLeaveDate: ${lastLeaveDateSerial}, LeaveOption: ${leaveOption}, OnSite: ${onSiteData}, InvestorGroup: ${investorGroupData}`);\n            \n            try {\n              \n              // Validate required fields\n              if (!nik || !name || nik.toString().trim() === '' || name.toString().trim() === '') {\n                console.log(`Row ${i + 2}: Skipping row with empty NIK or Name - NIK: \"${nik}\", Name: \"${name}\"`);\n                continue;\n              }\n              \n              // Skip rows with #N/A values\n              if (nik.toString().includes('#N/A') || name.toString().includes('#N/A')) {\n                console.log(`Row ${i + 2}: Skipping row with #N/A values`);\n                continue;\n              }\n\n              // Convert various month formats to YYYY-MM format\n              const currentMonth = new Date().toISOString().slice(0, 7); // \"YYYY-MM\"\n              let finalMonth = currentMonth; // Default to current month\n              \n              // Calculate monitoring days and next leave date\n              let monitoringDays = 0;\n              let nextLeaveDate = \"\";\n              let finalLastLeaveDate = \"\";\n              let finalStatus = \"Aktif\";\n              let finalLeaveOption = \"70\";\n              let finalOnSite = \"\";\n              \n              if (monthOrBulan) {\n                const monthStr = monthOrBulan.toString().toLowerCase().trim();\n                const currentYear = new Date().getFullYear();\n                \n                // Handle Excel serial date numbers (40000+)\n                if (!isNaN(Number(monthStr)) && Number(monthStr) > 40000 && Number(monthStr) < 50000) {\n                  // Convert Excel serial to date, then extract month using correct formula\n                  const excelDate = Number(monthStr);\n                  const excelEpoch = new Date(1900, 0, 1); // January 1, 1900\n                  const daysSinceEpoch = excelDate - 1; // Excel day 1 = Jan 1, 1900\n                  const jsDate = new Date(excelEpoch.getTime() + (daysSinceEpoch * 24 * 60 * 60 * 1000));\n                  if (!isNaN(jsDate.getTime())) {\n                    const year = jsDate.getFullYear();\n                    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');\n                    finalMonth = `${year}-${month}`;\n                    console.log(`Row ${i + 2}: Converted Excel serial \"${monthStr}\" to month \"${finalMonth}\"`);\n                  } else {\n                    console.log(`Row ${i + 2}: Invalid Excel serial \"${monthStr}\", using current month`);\n                    finalMonth = currentMonth;\n                  }\n                }\n                // Handle date formats: dd/mm/yyyy, dd-mm-yyyy, mm/yyyy, etc.\n                else if (/^\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4}$/.test(monthStr)) {\n                  // Format: dd/mm/yyyy or dd-mm-yyyy\n                  const dateParts = monthStr.split(/[\\/\\-]/);\n                  const day = parseInt(dateParts[0]);\n                  const month = parseInt(dateParts[1]);\n                  const year = parseInt(dateParts[2]);\n                  \n                  if (month >= 1 && month <= 12 && year >= 2020 && year <= 2030) {\n                    finalMonth = `${year}-${month.toString().padStart(2, '0')}`;\n                    console.log(`Row ${i + 2}: Converted date \"${monthStr}\" to month \"${finalMonth}\"`);\n                  } else {\n                    console.log(`Row ${i + 2}: Invalid date \"${monthStr}\", using current month`);\n                    finalMonth = currentMonth;\n                  }\n                } \n                // Handle mm/yyyy or mm-yyyy format\n                else if (/^\\d{1,2}[\\/\\-]\\d{4}$/.test(monthStr)) {\n                  const dateParts = monthStr.split(/[\\/\\-]/);\n                  const month = parseInt(dateParts[0]);\n                  const year = parseInt(dateParts[1]);\n                  \n                  if (month >= 1 && month <= 12 && year >= 2020 && year <= 2030) {\n                    finalMonth = `${year}-${month.toString().padStart(2, '0')}`;\n                    console.log(`Row ${i + 2}: Converted month/year \"${monthStr}\" to \"${finalMonth}\"`);\n                  } else {\n                    console.log(`Row ${i + 2}: Invalid month/year \"${monthStr}\", using current month`);\n                    finalMonth = currentMonth;\n                  }\n                }\n                // Convert Indonesian month names to YYYY-MM format\n                else {\n                  const monthMap: { [key: string]: string } = {\n                    'januari': `${currentYear}-01`,\n                    'january': `${currentYear}-01`,\n                    'februari': `${currentYear}-02`, \n                    'february': `${currentYear}-02`,\n                    'maret': `${currentYear}-03`,\n                    'march': `${currentYear}-03`,\n                    'april': `${currentYear}-04`,\n                    'mei': `${currentYear}-05`,\n                    'may': `${currentYear}-05`,\n                    'juni': `${currentYear}-06`,\n                    'june': `${currentYear}-06`,\n                    'juli': `${currentYear}-07`,\n                    'july': `${currentYear}-07`,\n                    'agustus': `${currentYear}-08`,\n                    'august': `${currentYear}-08`,\n                    'september': `${currentYear}-09`,\n                    'oktober': `${currentYear}-10`,\n                    'october': `${currentYear}-10`,\n                    'november': `${currentYear}-11`,\n                    'desember': `${currentYear}-12`,\n                    'december': `${currentYear}-12`\n                  };\n                  \n                  if (monthMap[monthStr]) {\n                    finalMonth = monthMap[monthStr];\n                    console.log(`Row ${i + 2}: Converted month name \"${monthStr}\" to \"${finalMonth}\"`);\n                  } else if (/^\\d{4}-\\d{2}$/.test(monthStr)) {\n                    // Already in YYYY-MM format\n                    finalMonth = monthStr;\n                    console.log(`Row ${i + 2}: Month already in correct format \"${finalMonth}\"`);\n                  } else {\n                    console.log(`Row ${i + 2}: Format bulan tidak dikenali \"${monthStr}\", menggunakan bulan sekarang`);\n                    finalMonth = currentMonth;\n                  }\n                }\n              }\n\n              // Use investor group from Excel, default to \"Default Group\" if not provided\n              let investorGroup = \"Default Group\";\n              if (investorGroupData && \n                  investorGroupData.toString().trim() && \n                  !investorGroupData.toString().includes('#N/A') &&\n                  investorGroupData.toString().trim() !== '') {\n                investorGroup = investorGroupData.toString().trim();\n              }\n\n              // Validate leave option atau default ke 70\n              if (leaveOption && (leaveOption.toString() === \"70\" || leaveOption.toString() === \"35\")) {\n                finalLeaveOption = leaveOption.toString();\n              } else if (leaveOption && leaveOption.toString().trim() !== \"\") {\n                console.log(`Row ${i + 2}: Invalid leave option \"${leaveOption}\", using default 70`);\n                // Don't add error, just use default\n              }\n\n              if (lastLeaveDateSerial) {\n                console.log(`[${nik}] Processing lastLeaveDateSerial: ${lastLeaveDateSerial}, type: ${typeof lastLeaveDateSerial}`);\n                try {\n                  // Handle berbagai format tanggal\n                  let lastDate = null;\n                  \n                  // Cek apakah Excel serial number (harus > 40000 untuk tahun 2000+)\n                  if (typeof lastLeaveDateSerial === 'number' && lastLeaveDateSerial > 40000) {\n                    // Excel date serial number conversion yang lebih akurat\n                    // Excel menghitung dari 1 Januari 1900, tapi ada bug leap year di 1900\n                    // Formula yang benar: (serial - 25569) * 86400 * 1000 + Date(1970,0,1)\n                    // Atau menggunakan epoch Excel yang tepat\n                    const excelEpoch = new Date(1899, 11, 30); // 30 Desember 1899\n                    const daysSinceEpoch = Math.floor(lastLeaveDateSerial);\n                    lastDate = new Date(excelEpoch.getTime() + (daysSinceEpoch * 24 * 60 * 60 * 1000));\n                    console.log(`[${nik}] Excel serial ${lastLeaveDateSerial} converted to ${lastDate.toISOString().split('T')[0]}`);\n                  } else if (typeof lastLeaveDateSerial === 'number' && lastLeaveDateSerial > 1000) {\n                    // Kemungkinan format lain atau tanggal yang lebih lama\n                    console.log(`[${nik}] Warning: Excel serial ${lastLeaveDateSerial} seems old, trying conversion`);\n                    const excelEpoch = new Date(1899, 11, 30);\n                    const daysSinceEpoch = Math.floor(lastLeaveDateSerial);\n                    lastDate = new Date(excelEpoch.getTime() + (daysSinceEpoch * 24 * 60 * 60 * 1000));\n                    console.log(`[${nik}] Old Excel serial ${lastLeaveDateSerial} converted to ${lastDate.toISOString().split('T')[0]}`);\n                  } else {\n                    const dateStr = lastLeaveDateSerial.toString().trim();\n                    console.log(`[${nik}] Parsing date string: \"${dateStr}\"`);\n                    \n                    // Format 1: dd/mm/yyyy atau dd-mm-yyyy (prioritas utama untuk format Indonesia)\n                    if (/^\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4}$/.test(dateStr)) {\n                      const parts = dateStr.split(/[\\/\\-]/);\n                      const dayNum = parseInt(parts[0]);\n                      const monthNum = parseInt(parts[1]);\n                      const yearNum = parseInt(parts[2]);\n                      \n                      console.log(`[${nik}] Parsing DD/MM/YYYY: day=${dayNum}, month=${monthNum}, year=${yearNum}`);\n                      \n                      // Validate date values - expanded year range for 2025\n                      if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12 && yearNum >= 2020 && yearNum <= 2030) {\n                        lastDate = new Date(yearNum, monthNum - 1, dayNum);\n                        console.log(`[${nik}] DD/MM/YYYY format \"${dateStr}\" converted to ${lastDate.toISOString().split('T')[0]}`);\n                      } else {\n                        console.log(`[${nik}] Invalid DD/MM/YYYY values: day=${dayNum}, month=${monthNum}, year=${yearNum}`);\n                      }\n                    }\n                    // Format 2: yyyy/mm/dd atau yyyy-mm-dd\n                    else if (/^\\d{4}[\\/\\-]\\d{1,2}[\\/\\-]\\d{1,2}$/.test(dateStr)) {\n                      const [year, month, day] = dateStr.split(/[\\/\\-]/);\n                      const dayNum = parseInt(day);\n                      const monthNum = parseInt(month);\n                      const yearNum = parseInt(year);\n                      \n                      if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12 && yearNum >= 2020 && yearNum <= 2030) {\n                        lastDate = new Date(yearNum, monthNum - 1, dayNum);\n                        console.log(`[${nik}] YYYY/MM/DD format \"${dateStr}\" converted to ${lastDate.toISOString().split('T')[0]}`);\n                      }\n                    }\n                    // Format 3: Jika parsing DD/MM/YYYY gagal, coba MM/DD/YYYY (American format)\n                    else if (/^\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4}$/.test(dateStr) && !lastDate) {\n                      const parts = dateStr.split(/[\\/\\-]/);\n                      // Deteksi American format jika part pertama > 12 (pasti month)\n                      if (parseInt(parts[0]) > 12) {\n                        console.log(`[${nik}] Detected American format (first part > 12)`);\n                        // Ini pasti MM/DD/YYYY\n                        const monthNum = parseInt(parts[0]);\n                        const dayNum = parseInt(parts[1]); \n                        const yearNum = parseInt(parts[2]);\n                        \n                        if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12 && yearNum >= 2020 && yearNum <= 2030) {\n                          lastDate = new Date(yearNum, monthNum - 1, dayNum);\n                          console.log(`[${nik}] MM/DD/YYYY format \"${dateStr}\" converted to ${lastDate.toISOString().split('T')[0]}`);\n                        }\n                      } else if (parseInt(parts[1]) > 12) {\n                        console.log(`[${nik}] Detected DD/MM/YYYY format (second part > 12)`);\n                        // Ini pasti DD/MM/YYYY, tapi belum berhasil di atas, coba lagi\n                        const dayNum = parseInt(parts[0]);\n                        const monthNum = parseInt(parts[1]);\n                        const yearNum = parseInt(parts[2]);\n                        \n                        if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12 && yearNum >= 2020 && yearNum <= 2030) {\n                          lastDate = new Date(yearNum, monthNum - 1, dayNum);\n                          console.log(`[${nik}] DD/MM/YYYY format (retry) \"${dateStr}\" converted to ${lastDate.toISOString().split('T')[0]}`);\n                        }\n                      }\n                    }\n                    // Format 4: Tanggal text (15 Januari 2024, dll)\n                    else {\n                      // Try parsing as ISO date or natural language\n                      const tempDate = new Date(dateStr);\n                      if (!isNaN(tempDate.getTime()) && tempDate.getFullYear() >= 2020 && tempDate.getFullYear() <= 2030) {\n                        lastDate = tempDate;\n                        console.log(`[${nik}] Text format \"${dateStr}\" converted to ${lastDate.toISOString().split('T')[0]}`);\n                      } else {\n                        console.log(`[${nik}] Unable to parse date: \"${dateStr}\"`);\n                      }\n                    }\n                  }\n                  \n                  // Validasi final dan perhitungan\n                  if (lastDate && !isNaN(lastDate.getTime())) {\n                    finalLastLeaveDate = lastDate.toISOString().split('T')[0];\n                    const today = new Date();\n                    today.setHours(0, 0, 0, 0); // Reset to start of day for accurate comparison\n                    lastDate.setHours(0, 0, 0, 0); // Reset to start of day\n                    \n                    // Rumus baru: Terakhir Cuti - Today \n                    monitoringDays = Math.floor((lastDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n                    \n                    const workDaysThreshold = finalLeaveOption === \"70\" ? 70 : 35;\n                    const nextDate = new Date(lastDate);\n                    nextDate.setDate(lastDate.getDate() + workDaysThreshold);\n                    nextLeaveDate = nextDate.toISOString().split('T')[0];\n\n                    // Status berdasarkan rumus baru: Terakhir Cuti - Today\n                    console.log(`[${nik}] SUCCESS: Parsed date ${finalLastLeaveDate}, monitoringDays: ${monitoringDays} (${monitoringDays > 0 ? 'hari lagi' : monitoringDays < 0 ? 'sudah lewat' : 'hari ini'})`);\n                    \n                    // Aturan status baru:\n                    if (monitoringDays <= 10 && monitoringDays >= 0) {\n                      finalStatus = \"Menunggu Cuti\";\n                    } else if (monitoringDays > 10) {\n                      finalStatus = \"Aktif\";\n                    } else if (monitoringDays < 0) {\n                      finalStatus = \"Cuti Selesai\";\n                    }\n                  } else {\n                    // Tanggal tidak bisa diparsing\n                    console.log(`[${nik}] ERROR: Failed to parse date \"${lastLeaveDateSerial}\"`);\n                    // Set to current date as fallback instead of error\n                    const today = new Date();\n                    finalLastLeaveDate = today.toISOString().split('T')[0];\n                    monitoringDays = 0;\n                    console.log(`[${nik}] Using current date as fallback: ${finalLastLeaveDate}`);\n                    errors.push(`Row ${i + 2}: Format tanggal tidak valid \"${lastLeaveDateSerial}\", menggunakan tanggal hari ini sebagai fallback`);\n                  }\n                } catch (dateError) {\n                  console.error(`[${nik}] Date parsing error:`, dateError);\n                  errors.push(`Row ${i + 2}: Error parsing tanggal \"${lastLeaveDateSerial}\": ${dateError instanceof Error ? dateError.message : String(dateError)}`);\n                }\n              }\n\n              console.log(\"Creating monitoring entry for:\", nik, name);\n              console.log(\"Data to insert:\", {\n                nik: nik?.toString(),\n                name: name?.toString(),\n                nomorLambung: nomorLambung?.toString() || null,\n                month: finalMonth,\n                investorGroup,\n                lastLeaveDate: finalLastLeaveDate || null,\n                leaveOption: finalLeaveOption,\n                monitoringDays,\n                nextLeaveDate: nextLeaveDate || null,\n                status: finalStatus,\n                onSite: finalOnSite || null\n              });\n              \n              // Create leave roster monitoring entry - convert Excel serial to date format if needed\n              if (onSiteData) {\n                const onSiteStr = onSiteData.toString().trim();\n                // Check if it's a number (Excel serial date)\n                if (!isNaN(Number(onSiteStr)) && Number(onSiteStr) > 40000) {\n                  // Convert Excel serial to date format using correct formula\n                  const excelEpoch = new Date(1900, 0, 1);\n                  const daysSinceEpoch = Number(onSiteStr) - 1; // Fixed conversion\n                  const parsedDate = new Date(excelEpoch.getTime() + (daysSinceEpoch * 24 * 60 * 60 * 1000));\n                  finalOnSite = parsedDate.toLocaleDateString('id-ID', {\n                    day: '2-digit',\n                    month: '2-digit', \n                    year: 'numeric'\n                  });\n                } else {\n                  // Use as text (Ya/Tidak/etc)\n                  finalOnSite = onSiteStr;\n                }\n              }\n              await storage.createLeaveRosterMonitoring({\n                nik: nik.toString(),\n                name: name.toString(),\n                nomorLambung: nomorLambung?.toString() || null,\n                month: finalMonth,\n                investorGroup: investorGroup,\n                lastLeaveDate: finalLastLeaveDate || null,\n                leaveOption: finalLeaveOption,\n                monitoringDays,\n                nextLeaveDate: nextLeaveDate || null,\n                status: finalStatus,\n                onSite: finalOnSite || null\n              });\n\n              successCount++;\n              console.log(`Successfully created entry for ${nik} - ${name}`);\n              \n            } catch (error) {\n              console.error(`âŒ Error processing row ${i + 2}:`, error);\n              console.error(\"ðŸ“‹ Row data:\", row);\n              console.error(\"ðŸ” Parsed data:\", { \n                nik, \n                name, \n                lastLeaveDateSerial, \n                leaveOption, \n                monthOrBulan, \n                onSiteData\n              });\n              \n              // Specific error handling\n              if (error instanceof Error) {\n                console.error(\"ðŸ’¥ Error message:\", error.message);\n                console.error(\"ðŸ“š Error stack:\", error.stack);\n                \n                // Check if it's a database constraint error\n                if (error.message.includes('unique') || error.message.includes('constraint')) {\n                  console.error(\"ðŸš¨ Database constraint violation detected\");\n                  errors.push(`Row ${i + 2}: Data duplikat - ${nik} untuk bulan sudah ada`);\n                } else if (error.message.includes('validation') || error.message.includes('required')) {\n                  console.error(\"âš ï¸ Validation error detected\");\n                  errors.push(`Row ${i + 2}: Validation error - ${error.message}`);\n                } else if (error.message.includes('null') || error.message.includes('NOT NULL')) {\n                  console.error(\"ðŸ” NULL constraint violation detected\");\n                  errors.push(`Row ${i + 2}: Field yang wajib kosong - periksa NIK, Nama, atau data lainnya`);\n                } else {\n                  errors.push(`Row ${i + 2}: ${error.message}`);\n                }\n              } else {\n                errors.push(`Row ${i + 2}: Unknown error`);\n              }\n              \n              console.log(`âŒ Failed to create entry for ${nik || 'unknown'} - ${name || 'unknown'}`);\n            }\n          }\n\n          console.log(`Upload completed: ${successCount} success, ${errors.length} errors`);\n\n          res.json({\n            success: successCount,\n            errors,\n            message: `${successCount} data berhasil diupload${errors.length > 0 ? `, ${errors.length} error` : ''}`\n          });\n\n        } catch (error) {\n          console.error(\"Error processing Excel file:\", error);\n          res.status(500).json({ error: \"Failed to process Excel file\", details: error instanceof Error ? error.message : 'Unknown error' });\n        }\n      });\n\n    } catch (error) {\n      console.error(\"Error in Excel upload:\", error);\n      res.status(500).json({ error: \"Failed to upload Excel file\", details: error instanceof Error ? error.message : 'Unknown error' });\n    }\n  });\n\n  // Meeting API routes\n  app.get(\"/api/meetings\", async (req, res) => {\n    try {\n      const meetings = await storage.getAllMeetings();\n      res.json(meetings);\n    } catch (error) {\n      console.error(\"Error fetching meetings:\", error);\n      res.status(500).json({ error: \"Failed to fetch meetings\" });\n    }\n  });\n\n  app.get(\"/api/meetings/date/:date\", async (req, res) => {\n    try {\n      const { date } = req.params;\n      const meetings = await storage.getMeetingsByDate(date);\n      res.json(meetings);\n    } catch (error) {\n      console.error(\"Error fetching meetings by date:\", error);\n      res.status(500).json({ error: \"Failed to fetch meetings by date\" });\n    }\n  });\n\n  app.post(\"/api/meetings\", async (req, res) => {\n    try {\n      const validatedData = insertMeetingSchema.parse(req.body);\n      const meeting = await storage.createMeeting(validatedData);\n      res.json(meeting);\n    } catch (error) {\n      console.error(\"Error creating meeting:\", error);\n      res.status(500).json({ error: \"Failed to create meeting\" });\n    }\n  });\n\n  app.get(\"/api/meetings/by-token/:token\", async (req, res) => {\n    try {\n      const { token } = req.params;\n      const meeting = await storage.getMeetingByQrToken(token);\n      if (!meeting) {\n        return res.status(404).json({ error: \"Meeting not found\" });\n      }\n      res.json(meeting);\n    } catch (error) {\n      console.error(\"Error fetching meeting by token:\", error);\n      res.status(500).json({ error: \"Failed to fetch meeting\" });\n    }\n  });\n\n  app.get(\"/api/meetings/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const meeting = await storage.getMeeting(id);\n      if (!meeting) {\n        return res.status(404).json({ error: \"Meeting not found\" });\n      }\n      res.json(meeting);\n    } catch (error) {\n      console.error(\"Error fetching meeting:\", error);\n      res.status(500).json({ error: \"Failed to fetch meeting\" });\n    }\n  });\n\n  app.put(\"/api/meetings/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertMeetingSchema.parse(req.body);\n      const meeting = await storage.updateMeeting(id, validatedData);\n      if (!meeting) {\n        return res.status(404).json({ error: \"Meeting not found\" });\n      }\n      res.json(meeting);\n    } catch (error) {\n      console.error(\"Error updating meeting:\", error);\n      res.status(500).json({ error: \"Failed to update meeting\" });\n    }\n  });\n\n  app.delete(\"/api/meetings/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteMeeting(id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Meeting not found\" });\n      }\n      res.json({ message: \"Meeting deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting meeting:\", error);\n      res.status(500).json({ error: \"Failed to delete meeting\" });\n    }\n  });\n\n  // Upload photos for meeting (max 4)\n  const meetingPhotoUpload = multer({\n    storage: multer.diskStorage({\n      destination: function (req, file, cb) {\n        const uploadDir = path.join(process.cwd(), 'uploads', 'meetings');\n        if (!fs.existsSync(uploadDir)) {\n          fs.mkdirSync(uploadDir, { recursive: true });\n        }\n        cb(null, uploadDir);\n      },\n      filename: function (req, file, cb) {\n        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n        cb(null, 'meeting-' + uniqueSuffix + path.extname(file.originalname));\n      }\n    }),\n    limits: { fileSize: 5 * 1024 * 1024 }, // 5MB max\n    fileFilter: function (req, file, cb) {\n      const allowedTypes = /jpeg|jpg|png/;\n      const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());\n      const mimetype = allowedTypes.test(file.mimetype);\n      if (mimetype && extname) {\n        return cb(null, true);\n      }\n      cb(new Error('Only .png, .jpg and .jpeg format allowed!'));\n    }\n  });\n\n  app.post(\"/api/meetings/:id/upload-photos\", meetingPhotoUpload.array('photos', 4), async (req, res) => {\n    try {\n      const { id } = req.params;\n      const files = req.files as Express.Multer.File[];\n      \n      if (!files || files.length === 0) {\n        return res.status(400).json({ error: \"No files uploaded\" });\n      }\n\n      const meeting = await storage.getMeeting(id);\n      if (!meeting) {\n        // Clean up uploaded files\n        files.forEach(file => fs.unlinkSync(file.path));\n        return res.status(404).json({ error: \"Meeting not found\" });\n      }\n\n      // Get relative paths for storage\n      const photoPaths = files.map(file => `/uploads/meetings/${path.basename(file.path)}`);\n      \n      // Merge with existing photos (max 4 total)\n      const existingPhotos = meeting.meetingPhotos || [];\n      const allPhotos = [...existingPhotos, ...photoPaths].slice(0, 4);\n      \n      // Update meeting with photos\n      const updatedMeeting = await storage.updateMeeting(id, {\n        ...meeting,\n        meetingPhotos: allPhotos\n      });\n\n      res.json({\n        message: \"Photos uploaded successfully\",\n        photos: allPhotos,\n        meeting: updatedMeeting\n      });\n    } catch (error) {\n      console.error(\"Error uploading meeting photos:\", error);\n      // Clean up files on error\n      if (req.files) {\n        (req.files as Express.Multer.File[]).forEach(file => {\n          if (fs.existsSync(file.path)) fs.unlinkSync(file.path);\n        });\n      }\n      res.status(500).json({ error: \"Failed to upload photos\" });\n    }\n  });\n\n  // Delete a specific photo from meeting\n  app.delete(\"/api/meetings/:id/photos/:photoIndex\", async (req, res) => {\n    try {\n      const { id, photoIndex } = req.params;\n      const index = parseInt(photoIndex);\n\n      const meeting = await storage.getMeeting(id);\n      if (!meeting) {\n        return res.status(404).json({ error: \"Meeting not found\" });\n      }\n\n      const photos = meeting.meetingPhotos || [];\n      if (index < 0 || index >= photos.length) {\n        return res.status(400).json({ error: \"Invalid photo index\" });\n      }\n\n      // Delete physical file\n      const photoPath = photos[index];\n      const fullPath = path.join(process.cwd(), photoPath);\n      if (fs.existsSync(fullPath)) {\n        fs.unlinkSync(fullPath);\n      }\n\n      // Remove from array\n      const updatedPhotos = photos.filter((_, i) => i !== index);\n      \n      // Update meeting\n      const updatedMeeting = await storage.updateMeeting(id, {\n        ...meeting,\n        meetingPhotos: updatedPhotos\n      });\n\n      res.json({\n        message: \"Photo deleted successfully\",\n        photos: updatedPhotos,\n        meeting: updatedMeeting\n      });\n    } catch (error) {\n      console.error(\"Error deleting meeting photo:\", error);\n      res.status(500).json({ error: \"Failed to delete photo\" });\n    }\n  });\n\n  // Manual attendance entry for meetings - for investors and korlap\n  app.post(\"/api/meetings/:id/manual-attendance\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      // Validate request data with manual attendance schema\n      const validatedData = insertManualAttendanceSchema.parse(req.body);\n      \n      // Check if meeting exists\n      const meeting = await storage.getMeeting(id);\n      if (!meeting) {\n        return res.status(404).json({ error: \"Meeting not found\" });\n      }\n      \n      // Get current time for attendance\n      const now = new Date();\n      const indonesiaTime = new Date(now.getTime() + (8 * 60 * 60 * 1000)); // WITA (+8)\n      const currentDate = indonesiaTime.toISOString().split('T')[0];\n      const currentTime = `${indonesiaTime.getHours().toString().padStart(2, '0')}:${indonesiaTime.getMinutes().toString().padStart(2, '0')}:${indonesiaTime.getSeconds().toString().padStart(2, '0')}`;\n      \n      // Create manual attendance record\n      const attendanceData = {\n        ...validatedData,\n        meetingId: id,\n        scanDate: currentDate,\n        scanTime: currentTime,\n        attendanceType: \"manual_entry\" as const\n      };\n      \n      const attendance = await storage.createMeetingAttendance(attendanceData);\n      \n      res.status(201).json({\n        message: \"Manual attendance recorded successfully\",\n        attendance,\n        attendeeInfo: {\n          name: validatedData.manualName,\n          position: validatedData.manualPosition,\n          department: validatedData.manualDepartment,\n          type: \"Manual Entry\"\n        }\n      });\n    } catch (error) {\n      console.error(\"Error recording manual attendance:\", error);\n      if (error instanceof Error && error.message.includes('duplicate')) {\n        res.status(400).json({ error: \"Attendance already recorded for this meeting\" });\n      } else {\n        res.status(500).json({ error: \"Failed to record manual attendance\" });\n      }\n    }\n  });\n\n  // Get unique investor groups from employee data\n  app.get(\"/api/investor-groups\", async (req, res) => {\n    try {\n      // Check cache first for performance\n      let employees = getCachedAllEmployees();\n      \n      if (!employees) {\n        console.log('ðŸ”„ Fetching all employees for investor groups...');\n        employees = await storage.getAllEmployees();\n        setCachedAllEmployees(employees);\n      }\n      \n      // Extract unique investor groups, filter out null/undefined/empty values\n      const investorGroups = [...new Set(\n        employees\n          .map(emp => emp.investorGroup)\n          .filter(group => group && group.trim() !== '')\n      )].sort();\n      \n      console.log(`ðŸ“Š Found ${investorGroups.length} unique investor groups`);\n      \n      res.json({\n        investorGroups,\n        total: investorGroups.length\n      });\n    } catch (error) {\n      console.error(\"Error fetching investor groups:\", error);\n      res.status(500).json({ error: \"Failed to fetch investor groups\" });\n    }\n  });\n\n  // Meeting QR code validation and attendance recording\n  app.post(\"/api/meetings/qr-scan\", async (req, res) => {\n    try {\n      const { qrToken, employeeId } = req.body;\n      \n      if (!qrToken || !employeeId) {\n        return res.status(400).json({ error: \"QR token and employee ID are required\" });\n      }\n\n      // Find meeting by QR token\n      const meeting = await storage.getMeetingByQrToken(qrToken);\n      if (!meeting) {\n        return res.status(404).json({ error: \"Meeting not found or invalid QR code\" });\n      }\n\n      // Check if employee exists - with detailed logging for debugging\n      console.log(`Meeting QR Scan - Looking for employee ID: \"${employeeId}\" (type: ${typeof employeeId})`);\n      \n      let employee = await storage.getEmployee(employeeId);\n      if (!employee) {\n        // Try alternative lookup methods\n        console.log(`Employee \"${employeeId}\" not found, trying alternative lookups...`);\n        \n        // Try searching by name or NIK\n        const allEmployees = await storage.getAllEmployees();\n        console.log(`Total employees in system: ${allEmployees.length}`);\n        \n        // Log first few employee IDs for comparison\n        console.log('Sample employee IDs:', allEmployees.slice(0, 5).map(emp => `\"${emp.id}\"`));\n        \n        // Try to find by trimmed ID or exact match\n        const foundEmployee = allEmployees.find(emp => \n          emp.id === employeeId || \n          emp.id === employeeId.trim() ||\n          emp.id.toLowerCase() === employeeId.toLowerCase() ||\n          emp.name.toLowerCase().includes(employeeId.toLowerCase())\n        );\n        \n        if (foundEmployee) {\n          console.log(`Found employee by alternative lookup: ${foundEmployee.id} - ${foundEmployee.name}`);\n          // Use the found employee\n          employee = foundEmployee;\n        } else {\n          console.log(`Employee \"${employeeId}\" not found in ${allEmployees.length} total employees`);\n          return res.status(404).json({ \n            error: \"Employee not found\",\n            debug: {\n              searchedId: employeeId,\n              idType: typeof employeeId,\n              totalEmployees: allEmployees.length,\n              sampleIds: allEmployees.slice(0, 3).map(emp => emp.id)\n            }\n          });\n        }\n      }\n      \n      console.log(`Meeting attendance - Found employee: ${employee.id} - ${employee.name}`);\n\n      // Check if employee already attended this meeting TODAY\n      const today = new Date().toISOString().split('T')[0];\n      const existingAttendance = await storage.checkMeetingAttendance(meeting.id, employeeId);\n      \n      console.log(`Checking existing attendance for ${employee.name}:`, {\n        exists: !!existingAttendance,\n        scanDate: existingAttendance?.scanDate,\n        scanTime: existingAttendance?.scanTime,\n        today: today\n      });\n      \n      if (existingAttendance && existingAttendance.scanDate === today) {\n        // Allow re-attendance if more than 15 minutes has passed (proper meeting window)\n        const now = new Date();\n        // Convert to Indonesia time for proper comparison\n        const indonesiaTime = new Date(now.getTime() + (8 * 60 * 60 * 1000)); // WITA (+8)\n        const currentTime = indonesiaTime.getHours() * 60 + indonesiaTime.getMinutes(); // minutes since midnight\n        const [hours, minutes, seconds] = existingAttendance.scanTime.split(':').map(Number);\n        const lastScanTime = hours * 60 + minutes;\n        const timeDifference = currentTime - lastScanTime;\n        \n        console.log(`Time check for ${employee.name}:`, {\n          currentTime: `${indonesiaTime.getHours().toString().padStart(2, '0')}:${indonesiaTime.getMinutes().toString().padStart(2, '0')} WITA`,\n          lastScanTime: existingAttendance.scanTime,\n          timeDifferenceMinutes: timeDifference\n        });\n        \n        if (timeDifference < 15) {\n          const waitMinutes = 15 - timeDifference;\n          return res.status(400).json({ \n            error: \"Already attended\", \n            message: `${employee.name} sudah melakukan scan QR untuk meeting ini pada ${existingAttendance.scanTime} WITA. Silakan tunggu ${waitMinutes} menit lagi untuk scan ulang.`,\n            lastScanTime: `${existingAttendance.scanTime} WITA`,\n            waitTime: `${waitMinutes} menit lagi`,\n            currentTime: `${indonesiaTime.getHours().toString().padStart(2, '0')}:${indonesiaTime.getMinutes().toString().padStart(2, '0')} WITA`\n          });\n        } else {\n          console.log(`Allowing re-attendance for ${employee.name} - more than 15 minutes has passed (${timeDifference} minutes)`);\n          // Delete previous attendance record to allow new one\n          try {\n            const deleted = await storage.deleteMeetingAttendance(existingAttendance.id);\n            console.log(`Previous attendance deletion result: ${deleted}`);\n          } catch (error) {\n            console.error(`Error deleting previous attendance:`, error);\n          }\n        }\n      }\n\n      // Record attendance with proper timezone handling\n      const now = new Date();\n      // Convert to Indonesia time (WIB/WITA) - UTC+7/+8\n      const indonesiaTime = new Date(now.getTime() + (8 * 60 * 60 * 1000)); // WITA (+8)\n      const scanTime = indonesiaTime.toTimeString().split(' ')[0]; // HH:MM:SS\n      const scanDate = indonesiaTime.toISOString().split('T')[0]; // YYYY-MM-DD\n      const currentTime = `${indonesiaTime.getHours().toString().padStart(2, '0')}:${indonesiaTime.getMinutes().toString().padStart(2, '0')}`;\n      \n      console.log(`Meeting attendance recorded at ${currentTime} WITA for ${employee.name}`);\n\n      const attendance = await storage.createMeetingAttendance({\n        meetingId: meeting.id,\n        employeeId,\n        scanTime,\n        scanDate,\n        deviceInfo: req.headers['user-agent'] || 'Unknown device'\n      });\n\n      res.json({\n        success: true,\n        message: `âœ… ${employee.name} berhasil absen untuk meeting: ${meeting.title} pada ${currentTime} WITA`,\n        attendance,\n        meeting,\n        employee,\n        scanTime: `${currentTime} WITA`,\n        isReAttendance: !!existingAttendance\n      });\n    } catch (error) {\n      console.error(\"Error recording meeting attendance:\", error);\n      res.status(500).json({ error: \"Failed to record meeting attendance\" });\n    }\n  });\n\n  // Get meeting attendance\n  app.get(\"/api/meetings/:id/attendance\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const meeting = await storage.getMeeting(id);\n      if (!meeting) {\n        return res.status(404).json({ error: \"Meeting not found\" });\n      }\n\n      const attendance = await storage.getMeetingAttendance(id);\n      console.log(`ðŸ“‹ Fetched ${attendance.length} attendance records for meeting ${id}`);\n      \n      const attendanceWithEmployees = await Promise.all(\n        attendance.map(async (att) => {\n          // Handle null employeeId for manual entries (investor/korlap)\n          const employee = att.employeeId ? await storage.getEmployee(att.employeeId) : null;\n          return {\n            ...att,\n            employee\n          };\n        })\n      );\n\n      console.log(`âœ… Processed ${attendanceWithEmployees.length} attendance records with employee data`);\n\n      res.json({\n        meeting,\n        attendance: attendanceWithEmployees,\n        totalAttendees: attendance.length\n      });\n    } catch (error) {\n      console.error(\"Error fetching meeting attendance:\", error);\n      res.status(500).json({ error: \"Failed to fetch meeting attendance\" });\n    }\n  });\n\n  // Update semua QR Code ke format URL\n  app.post(\"/api/qr/update-all\", async (req, res) => {\n    try {\n      console.log('Starting QR code update process...');\n      const employees = await storage.getAllEmployees();\n      console.log(`Found ${employees.length} employees to update`);\n      \n      const baseUrl = process.env.REPLIT_DOMAINS \n        ? `https://${process.env.REPLIT_DOMAINS.split(',')[0]}`\n        : 'http://localhost:5000';\n      \n      console.log(`Using base URL: ${baseUrl}`);\n      \n      let updatedCount = 0;\n      const errors: string[] = [];\n      \n      // Process employees in batches to avoid memory issues\n      const BATCH_SIZE = 10;\n      for (let i = 0; i < employees.length; i += BATCH_SIZE) {\n        const batch = employees.slice(i, i + BATCH_SIZE);\n        console.log(`Processing batch ${Math.floor(i/BATCH_SIZE) + 1}/${Math.ceil(employees.length/BATCH_SIZE)}`);\n        \n        for (const employee of batch) {\n          try {\n            // Generate new QR URL format\n            const secretKey = process.env.QR_SECRET_KEY || 'AttendanceQR2024';\n            const tokenData = `${employee.id}${secretKey}Attend`;\n            const qrToken = Buffer.from(tokenData).toString('base64').slice(0, 16);\n            const qrUrl = `${baseUrl}/qr-redirect?data=${encodeURIComponent(JSON.stringify({ id: employee.id, token: qrToken }))}`;\n            \n            // Update employee with new QR URL\n            await storage.updateEmployee(employee.id, { qrCode: qrUrl });\n            updatedCount++;\n            console.log(`Updated QR for employee ${employee.id} - ${employee.name}`);\n          } catch (error) {\n            console.error(`Failed to update employee ${employee.id}:`, error);\n            errors.push(`${employee.id}: ${error}`);\n          }\n        }\n      }\n      \n      console.log(`Update complete. Updated: ${updatedCount}, Errors: ${errors.length}`);\n      \n      res.json({ \n        message: `Berhasil update ${updatedCount} QR Code ke format URL`,\n        updatedCount,\n        errors: errors.length > 0 ? errors : undefined\n      });\n    } catch (error) {\n      console.error('Update QR codes error:', error);\n      res.status(500).json({ \n        message: \"Failed to update QR codes\", \n        error: error instanceof Error ? error.message : String(error)\n      });\n    }\n  });\n\n  // Compact QR endpoint untuk mobile camera scanning\n  app.get(\"/q/:token\", async (req, res) => {\n    try {\n      const token = req.params.token;\n      \n      if (!token) {\n        return res.status(400).send(`\n          <html>\n            <head>\n              <title>QR Code Invalid</title>\n              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n            </head>\n            <body>\n              <div style=\"text-align:center; padding:20px; font-family:Arial;\">\n                <h2>QR Code Invalid</h2>\n                <p>Token QR code tidak valid</p>\n              </div>\n            </body>\n          </html>\n        `);\n      }\n\n      // Find employee by token using QR token table (more efficient)\n      let employee = null;\n      try {\n        // Try to find the token in QR tokens table first\n        const allEmployees = await storage.getAllEmployees();\n        for (const emp of allEmployees) {\n          try {\n            const employeeTokens = await storage.getQrTokensByEmployee(emp.id);\n            const matchingToken = employeeTokens.find(t => t.token === token && t.isActive);\n            if (matchingToken) {\n              employee = emp;\n              break;\n            }\n          } catch {\n            // Continue if getQrTokensByEmployee fails for this employee\n            continue;\n          }\n        }\n        \n        // Fallback to QR code string matching for backward compatibility\n        if (!employee) {\n          employee = allEmployees.find(emp => {\n            try {\n              if (emp.qrCode) {\n                // Check if qrCode contains this token (either in URL or JSON format)\n                return emp.qrCode.includes(token);\n              }\n              return false;\n            } catch {\n              return false;\n            }\n          });\n        }\n      } catch (error) {\n        console.error('Error finding employee by token:', error);\n        return res.status(500).send(`\n          <html>\n            <head>\n              <title>Server Error</title>\n              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n            </head>\n            <body>\n              <div style=\"text-align:center; padding:20px; font-family:Arial;\">\n                <h2>Server Error</h2>\n                <p>Error saat mencari karyawan</p>\n              </div>\n            </body>\n          </html>\n        `);\n      }\n\n      if (!employee) {\n        return res.status(404).send(`\n          <html>\n            <head>\n              <title>Employee Not Found</title>\n              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n            </head>\n            <body>\n              <div style=\"text-align:center; padding:20px; font-family:Arial;\">\n                <h2>Employee Not Found</h2>\n                <p>Token QR code tidak ditemukan</p>\n              </div>\n            </body>\n          </html>\n        `);\n      }\n\n      // Detect mobile and redirect appropriately\n      const userAgent = req.headers['user-agent'] || '';\n      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);\n      \n      if (isMobile) {\n        return res.redirect(`/mobile-driver?nik=${employee.id}`);\n      } else {\n        return res.redirect(`/driver-view?nik=${employee.id}`);\n      }\n    } catch (error) {\n      console.error('Compact QR redirect error:', error);\n      return res.status(500).send(`\n        <html>\n          <head>\n            <title>Server Error</title>\n            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n          </head>\n          <body>\n            <div style=\"text-align:center; padding:20px; font-family:Arial;\">\n              <h2>Server Error</h2>\n              <p>Terjadi kesalahan sistem</p>\n            </div>\n          </body>\n        </html>\n      `);\n    }\n  });\n\n  // QR Redirect endpoint untuk handle scan dari luar aplikasi\n  app.get(\"/qr-redirect\", async (req, res) => {\n    try {\n      const data = req.query.data as string;\n      \n      if (!data) {\n        return res.status(400).send(`\n          <html>\n            <head>\n              <title>QR Code Invalid</title>\n              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n            </head>\n            <body>\n              <div style=\"text-align:center; padding:20px; font-family:Arial;\">\n                <h2>QR Code Invalid</h2>\n                <p>Data QR code tidak valid</p>\n              </div>\n            </body>\n          </html>\n        `);\n      }\n\n      // Parse QR data\n      let qrData;\n      try {\n        qrData = JSON.parse(decodeURIComponent(data));\n      } catch (parseError) {\n        // If JSON parsing fails, try to parse as URL for backward compatibility\n        try {\n          const url = new URL(decodeURIComponent(data));\n          const token = url.searchParams.get('token');\n          if (url.pathname.includes('/meeting-scanner') && token) {\n            return res.redirect(`/meeting-scanner?token=${token}`);\n          }\n        } catch (urlError) {\n          // Neither JSON nor URL, return error\n          return res.status(400).send(`\n            <html>\n              <head>\n                <title>QR Code Invalid</title>\n                <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n              </head>\n              <body>\n                <div style=\"text-align:center; padding:20px; font-family:Arial;\">\n                  <h2>QR Code Invalid</h2>\n                  <p>Format QR code tidak dapat diparse</p>\n                </div>\n              </body>\n            </html>\n          `);\n        }\n      }\n      \n      // Check if this is a meeting QR code\n      if (qrData.type === \"meeting\" && qrData.token) {\n        // Redirect to meeting scanner with the meeting token\n        return res.redirect(`/workspace/meeting-scanner?token=${qrData.token}`);\n      }\n\n      const { id: employeeId, token } = qrData;\n      \n      // Validate required fields for regular attendance QR codes\n      if (!employeeId || !token) {\n        return res.status(400).send(`\n          <html>\n            <head>\n              <title>QR Code Invalid</title>\n              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n            </head>\n            <body>\n              <div style=\"text-align:center; padding:20px; font-family:Arial;\">\n                <h2>QR Code Invalid</h2>\n                <p>QR code tidak memiliki ID atau token yang valid</p>\n              </div>\n            </body>\n          </html>\n        `);\n      }\n\n      // Validate employee exists\n      const employee = await storage.getEmployee(employeeId);\n      if (!employee) {\n        return res.status(404).send(`\n          <html>\n            <head>\n              <title>Karyawan Tidak Ditemukan</title>\n              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n            </head>\n            <body>\n              <div style=\"text-align:center; padding:20px; font-family:Arial;\">\n                <h2>Karyawan Tidak Ditemukan</h2>\n                <p>Data karyawan dengan ID ${employeeId} tidak ditemukan</p>\n              </div>\n            </body>\n          </html>\n        `);\n      }\n\n      // Deteksi device\n      const userAgent = req.headers['user-agent'] || '';\n      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);\n\n      if (isMobile) {\n        // Redirect ke mobile driver view untuk scan dari handphone\n        return res.redirect(`/mobile-driver?nik=${employeeId}`);\n      } else {\n        // Redirect ke desktop driver view untuk scan dari desktop  \n        return res.redirect(`/driver-view`);\n      }\n\n    } catch (error) {\n      console.error('QR Redirect error:', error);\n      return res.status(500).send(`\n        <html>\n          <head>\n            <title>Error</title>\n            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n          </head>\n          <body>\n            <div style=\"text-align:center; padding:20px; font-family:Arial;\">\n              <h2>Terjadi Kesalahan</h2>\n              <p>Gagal memproses QR code. Silakan coba lagi.</p>\n            </div>\n          </body>\n        </html>\n      `);\n    }\n  });\n\n  // PDF Upload endpoint\n  const storage_upload = multer({\n    storage: multer.diskStorage({\n      destination: function (req, file, cb) {\n        const uploadDir = path.join(process.cwd(), 'uploads', 'pdf');\n        \n        // Create directory if it doesn't exist\n        if (!fs.existsSync(uploadDir)) {\n          fs.mkdirSync(uploadDir, { recursive: true });\n        }\n        \n        cb(null, uploadDir);\n      },\n      filename: function (req, file, cb) {\n        // Generate unique filename with timestamp\n        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n        cb(null, 'form-' + uniqueSuffix + '.pdf');\n      }\n    }),\n    fileFilter: function (req, file, cb) {\n      // Only allow PDF files\n      if (file.mimetype === 'application/pdf') {\n        cb(null, true);\n      } else {\n        cb(new Error('Hanya file PDF yang diperbolehkan'));\n      }\n    },\n    limits: {\n      fileSize: 5 * 1024 * 1024 // 5MB limit\n    }\n  });\n\n  app.post('/api/upload-pdf', storage_upload.single('pdf'), (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: 'Tidak ada file yang diupload' });\n      }\n\n      res.json({\n        success: true,\n        fileName: req.file.filename,\n        filePath: req.file.path,\n        originalName: req.file.originalname,\n        size: req.file.size\n      });\n    } catch (error) {\n      console.error('Error uploading PDF:', error);\n      res.status(500).json({ error: 'Gagal upload PDF' });\n    }\n  });\n\n  // File download endpoint\n  app.get('/api/files/download/:filename', (req, res) => {\n    try {\n      const filename = req.params.filename;\n      \n      // Sanitize filename to prevent path traversal\n      const sanitizedFilename = path.basename(filename);\n      const filePath = path.join(process.cwd(), 'uploads', 'pdf', sanitizedFilename);\n\n      // Check if file exists\n      if (!fs.existsSync(filePath)) {\n        return res.status(404).json({ error: 'File tidak ditemukan' });\n      }\n\n      // Set appropriate headers for PDF\n      res.setHeader('Content-Type', 'application/pdf');\n      res.setHeader('Content-Disposition', `inline; filename=\"${sanitizedFilename}\"`);\n      res.setHeader('Cache-Control', 'public, max-age=3600');\n      \n      // Add headers to allow iframe embedding and prevent Chrome blocking\n      res.setHeader('X-Frame-Options', 'SAMEORIGIN');\n      res.setHeader('Content-Security-Policy', \"frame-ancestors 'self'\");\n      res.setHeader('X-Content-Type-Options', 'nosniff');\n      \n      // Stream the file\n      const fileStream = fs.createReadStream(filePath);\n      \n      fileStream.on('error', (error: any) => {\n        console.error('Error streaming PDF file:', error);\n        if (!res.headersSent) {\n          res.status(500).json({ error: 'Error membaca file PDF' });\n        }\n      });\n      \n      fileStream.pipe(res);\n    } catch (error) {\n      console.error('Error in PDF download endpoint:', error);\n      res.status(500).json({ error: 'Internal server error' });\n    }\n  });\n\n  // One-time endpoint to update existing SPARE employees\n  app.post(\"/api/admin/update-spare-origin\", async (req, res) => {\n    try {\n      const employees = await storage.getAllEmployees();\n      let updateCount = 0;\n      \n      for (const employee of employees) {\n        if (employee.nomorLambung === \"SPARE\" && !employee.isSpareOrigin) {\n          await storage.updateEmployee(employee.id, { isSpareOrigin: true });\n          updateCount++;\n        }\n      }\n      \n      res.json({ \n        success: true, \n        message: `Updated ${updateCount} SPARE employees`,\n        updatedCount: updateCount \n      });\n    } catch (error) {\n      console.error(\"Failed to update SPARE employees:\", error);\n      res.status(500).json({ \n        success: false, \n        message: \"Failed to update employees\" \n      });\n    }\n  });\n\n  // Manual fix for SYAHRANI KAI\n  app.post(\"/api/admin/fix-syahrani\", async (req, res) => {\n    try {\n      await storage.updateEmployee(\"C-005079\", { isSpareOrigin: true });\n      // Clear cache to force fresh data\n      clearCachedEmployee(\"C-005079\");\n      res.json({ success: true, message: \"SYAHRANI KAI fixed\" });\n    } catch (error) {\n      res.status(500).json({ success: false, message: \"Failed to fix\" });\n    }\n  });\n\n  // SIMPER Monitoring routes\n  app.get(\"/api/simper-monitoring\", async (req, res) => {\n    try {\n      const simperData = await storage.getAllSimperMonitoring();\n      \n      // Process and validate dates before sending to frontend\n      const processedData = simperData.map(simper => {\n        const validateAndFormatDate = (dateString: string | null) => {\n          if (!dateString) return null;\n          \n          try {\n            // Try to parse the date\n            const date = new Date(dateString);\n            \n            // Check if it's a valid date\n            if (isNaN(date.getTime())) {\n              return null;\n            }\n            \n            // Return in YYYY-MM-DD format\n            return date.toISOString().split('T')[0];\n          } catch {\n            return null;\n          }\n        };\n\n        return {\n          ...simper,\n          simperBibExpiredDate: validateAndFormatDate(simper.simperBibExpiredDate),\n          simperTiaExpiredDate: validateAndFormatDate(simper.simperTiaExpiredDate)\n        };\n      });\n      \n      res.json(processedData);\n    } catch (error) {\n      console.error('Error fetching SIMPER data:', error);\n      res.status(500).json({ message: \"Failed to fetch SIMPER monitoring data\" });\n    }\n  });\n\n  // SIMPER Analytics endpoint - MUST come before :id route!\n  app.get(\"/api/simper-monitoring/analytics\", async (req, res) => {\n    try {\n      const allSimperData = await storage.getAllSimperMonitoring();\n      \n      if (allSimperData.length === 0) {\n        return res.status(404).json({ message: \"Data SIMPER tidak ditemukan\" });\n      }\n      \n      const today = new Date();\n      \n      // Calculate monitoring days and status for each SIMPER record\n      const processedData = allSimperData.map(simper => {\n        const processBIB = (expiredDate: string | null) => {\n          if (!expiredDate) return { days: null, status: 'Tidak Ada Data' };\n          \n          const expired = new Date(expiredDate);\n          const diffTime = expired.getTime() - today.getTime();\n          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n          \n          if (diffDays < 0) return { days: diffDays, status: 'Segera Perpanjang' };\n          if (diffDays < 7) return { days: diffDays, status: 'Mendekati Perpanjangan' };\n          if (diffDays < 30) return { days: diffDays, status: 'Menuju Perpanjangan' };\n          return { days: diffDays, status: 'Aktif' };\n        };\n\n        const bibStatus = processBIB(simper.simperBibExpiredDate);\n        const tiaStatus = processBIB(simper.simperTiaExpiredDate);\n\n        return {\n          ...simper,\n          bibMonitoringDays: bibStatus.days,\n          bibStatus: bibStatus.status,\n          tiaMonitoringDays: tiaStatus.days,\n          tiaStatus: tiaStatus.status\n        };\n      });\n\n      // Calculate statistics\n      const totalKaryawan = processedData.length;\n      \n      const bibStats = {\n        segera: processedData.filter(s => s.bibStatus === 'Segera Perpanjang').length,\n        mendekati: processedData.filter(s => s.bibStatus === 'Mendekati Perpanjangan').length,\n        menuju: processedData.filter(s => s.bibStatus === 'Menuju Perpanjangan').length,\n        aktif: processedData.filter(s => s.bibStatus === 'Aktif').length\n      };\n\n      const tiaStats = {\n        segera: processedData.filter(s => s.tiaStatus === 'Segera Perpanjang').length,\n        mendekati: processedData.filter(s => s.tiaStatus === 'Mendekati Perpanjangan').length,\n        menuju: processedData.filter(s => s.tiaStatus === 'Menuju Perpanjangan').length,\n        aktif: processedData.filter(s => s.tiaStatus === 'Aktif').length\n      };\n\n      // Get critical list (expired or expiring soon)\n      const criticalList = processedData\n        .filter(s => \n          (s.bibMonitoringDays !== null && s.bibMonitoringDays < 30) ||\n          (s.tiaMonitoringDays !== null && s.tiaMonitoringDays < 30)\n        )\n        .sort((a, b) => {\n          const aMinDays = Math.min(a.bibMonitoringDays || 999, a.tiaMonitoringDays || 999);\n          const bMinDays = Math.min(b.bibMonitoringDays || 999, b.tiaMonitoringDays || 999);\n          return aMinDays - bMinDays;\n        })\n        .slice(0, 10);\n\n      res.json({\n        totalKaryawan,\n        bibStats,\n        tiaStats,\n        criticalList,\n        processedData\n      });\n    } catch (error) {\n      console.error('Error fetching SIMPER analytics:', error);\n      res.status(500).json({ message: \"Failed to fetch SIMPER analytics\" });\n    }\n  });\n\n  app.get(\"/api/simper-monitoring/:id\", async (req, res) => {\n    try {\n      const simper = await storage.getSimperMonitoring(req.params.id);\n      if (!simper) {\n        return res.status(404).json({ message: \"Data SIMPER tidak ditemukan\" });\n      }\n      \n      // Validate and format dates\n      const validateAndFormatDate = (dateString: string | null) => {\n        if (!dateString) return null;\n        try {\n          const date = new Date(dateString);\n          if (isNaN(date.getTime())) return null;\n          return date.toISOString().split('T')[0];\n        } catch {\n          return null;\n        }\n      };\n\n      const processedSimper = {\n        ...simper,\n        simperBibExpiredDate: validateAndFormatDate(simper.simperBibExpiredDate),\n        simperTiaExpiredDate: validateAndFormatDate(simper.simperTiaExpiredDate)\n      };\n      \n      res.json(processedSimper);\n    } catch (error) {\n      console.error('Error fetching SIMPER:', error);\n      res.status(500).json({ message: \"Failed to fetch SIMPER data\" });\n    }\n  });\n\n  app.get(\"/api/simper-monitoring/nik/:nik\", async (req, res) => {\n    try {\n      const simper = await storage.getSimperMonitoringByNik(req.params.nik);\n      if (!simper) {\n        return res.status(404).json({ message: \"Data SIMPER tidak ditemukan untuk NIK tersebut\" });\n      }\n\n      // Validate and format dates\n      const validateAndFormatDate = (dateString: string | null) => {\n        if (!dateString) return null;\n        try {\n          const date = new Date(dateString);\n          if (isNaN(date.getTime())) return null;\n          return date.toISOString().split('T')[0];\n        } catch {\n          return null;\n        }\n      };\n\n      const processedSimper = {\n        ...simper,\n        simperBibExpiredDate: validateAndFormatDate(simper.simperBibExpiredDate),\n        simperTiaExpiredDate: validateAndFormatDate(simper.simperTiaExpiredDate)\n      };\n      \n      res.json(processedSimper);\n    } catch (error) {\n      console.error('Error fetching SIMPER by NIK:', error);\n      res.status(500).json({ message: \"Failed to fetch SIMPER data by NIK\" });\n    }\n  });\n\n  app.post(\"/api/simper-monitoring\", async (req, res) => {\n    try {\n      const validatedData = insertSimperMonitoringSchema.parse(req.body);\n      \n      // Check if NIK already exists\n      const existingSimper = await storage.getSimperMonitoringByNik(validatedData.nik);\n      if (existingSimper) {\n        return res.status(409).json({ message: \"Data SIMPER untuk NIK ini sudah ada\" });\n      }\n\n      const simper = await storage.createSimperMonitoring(validatedData);\n      res.status(201).json(simper);\n    } catch (error) {\n      console.error('Error creating SIMPER:', error);\n      res.status(400).json({ message: \"Invalid SIMPER data\" });\n    }\n  });\n\n  app.put(\"/api/simper-monitoring/:id\", async (req, res) => {\n    try {\n      const validatedData = insertSimperMonitoringSchema.partial().parse(req.body);\n      const updatedSimper = await storage.updateSimperMonitoring(req.params.id, validatedData);\n      \n      if (!updatedSimper) {\n        return res.status(404).json({ message: \"Data SIMPER tidak ditemukan\" });\n      }\n      \n      res.json(updatedSimper);\n    } catch (error) {\n      console.error('Error updating SIMPER:', error);\n      res.status(400).json({ message: \"Invalid SIMPER data\" });\n    }\n  });\n\n  app.delete(\"/api/simper-monitoring/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteSimperMonitoring(req.params.id);\n      if (!success) {\n        return res.status(404).json({ message: \"Data SIMPER tidak ditemukan\" });\n      }\n      res.json({ message: \"Data SIMPER berhasil dihapus\" });\n    } catch (error) {\n      console.error('Error deleting SIMPER:', error);\n      res.status(500).json({ message: \"Failed to delete SIMPER data\" });\n    }\n  });\n\n  app.delete(\"/api/simper-monitoring\", async (req, res) => {\n    try {\n      await storage.deleteAllSimperMonitoring();\n      res.json({ message: \"Semua data SIMPER berhasil dihapus\" });\n    } catch (error) {\n      console.error('Error deleting all SIMPER data:', error);\n      res.status(500).json({ message: \"Failed to delete all SIMPER data\" });\n    }\n  });\n\n  // Send SIMPER expired notification email manually (for testing)\n  app.post(\"/api/simper-monitoring/send-notification\", async (req, res) => {\n    try {\n      const { simperNotificationService } = await import('./services/simperNotificationService');\n      const result = await simperNotificationService.checkAndNotifySimperExpired();\n      \n      if (result.sent) {\n        res.json({ \n          success: true, \n          message: `Email notifikasi berhasil dikirim dengan ${result.count} karyawan yang SIMPER-nya expired/akan expired`\n        });\n      } else if (result.count === 0) {\n        res.json({ \n          success: true, \n          message: \"Tidak ada SIMPER yang expired atau akan expired dalam 30 hari\"\n        });\n      } else {\n        res.status(500).json({ \n          success: false, \n          message: \"Gagal mengirim email. Pastikan kredensial Gmail sudah dikonfigurasi.\"\n        });\n      }\n    } catch (error) {\n      console.error('Error sending SIMPER notification:', error);\n      res.status(500).json({ message: \"Failed to send SIMPER notification\" });\n    }\n  });\n\n  // Helper function to convert Excel serial date to JavaScript Date\n  const excelSerialDateToJSDate = (serial: any) => {\n    if (!serial || serial === 'N/A' || serial === '' || serial === null || serial === undefined) {\n      return null;\n    }\n    \n    // Handle Date objects directly (Excel with cellDates: true might return Date objects)\n    if (serial instanceof Date) {\n      return serial.toISOString().split('T')[0];\n    }\n    \n    // If it's already a string date, try to parse it\n    if (typeof serial === 'string') {\n      const dateStr = serial.trim();\n      \n      // PRIORITAS UTAMA: Format Indonesia dd-mm-yyyy\n      if (/^\\d{1,2}-\\d{1,2}-\\d{4}$/.test(dateStr)) {\n        const [day, month, year] = dateStr.split('-');\n        const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));\n        if (!isNaN(date.getTime())) {\n          return date.toISOString().split('T')[0];\n        }\n      }\n      \n      // PRIORITAS KEDUA: Format Indonesia dd/mm/yyyy\n      if (/^\\d{1,2}\\/\\d{1,2}\\/\\d{4}$/.test(dateStr)) {\n        const [day, month, year] = dateStr.split('/');\n        const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));\n        if (!isNaN(date.getTime())) {\n          return date.toISOString().split('T')[0];\n        }\n      }\n      \n      // Format ISO yyyy-mm-dd (untuk compatibility)\n      if (/^\\d{4}-\\d{1,2}-\\d{1,2}$/.test(dateStr)) {\n        const date = new Date(dateStr);\n        if (!isNaN(date.getTime())) {\n          return date.toISOString().split('T')[0];\n        }\n      }\n      \n      // Fallback: general date parsing\n      const isoDate = new Date(dateStr);\n      if (!isNaN(isoDate.getTime())) {\n        return isoDate.toISOString().split('T')[0];\n      }\n    }\n    \n    // If it's a number, treat it as Excel serial date\n    if (typeof serial === 'number' && serial > 0) {\n      // Excel serial date starts from January 1, 1900\n      // Excel incorrectly treats 1900 as a leap year, so we need to adjust\n      const excelEpoch = new Date(1899, 11, 30); // December 30, 1899\n      const jsDate = new Date(excelEpoch.getTime() + (serial * 24 * 60 * 60 * 1000));\n      \n      if (!isNaN(jsDate.getTime())) {\n        return jsDate.toISOString().split('T')[0];\n      }\n    }\n    \n    return null;\n  };\n\n  // SIMPER Excel upload configuration\n  const excelUpload = multer({\n    storage: multer.memoryStorage(),\n    fileFilter: function (req, file, cb) {\n      // Only allow Excel files\n      if (file.mimetype === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || \n          file.mimetype === 'application/vnd.ms-excel') {\n        cb(null, true);\n      } else {\n        cb(new Error('Hanya file Excel (.xlsx/.xls) yang diperbolehkan'));\n      }\n    },\n    limits: {\n      fileSize: 10 * 1024 * 1024 // 10MB limit\n    }\n  });\n\n  // SIMPER bulk upload Excel\n  app.post(\"/api/simper-monitoring/upload-excel\", excelUpload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"File Excel tidak ditemukan\" });\n      }\n\n      const XLSX = await import('xlsx');\n      \n      // Try reading with different options to handle various Excel formats\n      console.log(`ðŸ“„ Reading Excel file with size: ${req.file.buffer.length} bytes`);\n      const workbook = XLSX.read(req.file.buffer, { \n        type: 'buffer', \n        cellDates: true,\n        cellNF: false,\n        cellText: false\n      });\n      \n      console.log(`ðŸ“Š Excel workbook contains ${workbook.SheetNames.length} sheets:`, workbook.SheetNames);\n      \n      const sheetName = workbook.SheetNames[0];\n      const worksheet = workbook.Sheets[sheetName];\n      \n      // Get range info\n      const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1');\n      console.log(`ðŸ“ Worksheet range: ${range.s.r + 1} to ${range.e.r + 1} rows, ${range.s.c + 1} to ${range.e.c + 1} columns`);\n      \n      // Convert to JSON with both raw and formatted data\n      const data = XLSX.utils.sheet_to_json(worksheet, { \n        raw: false,\n        dateNF: 'dd-mm-yyyy'\n      });\n      \n      console.log(`ðŸ“‹ Raw Excel data (first row):`, data[0] || 'No data found');\n\n      console.log(`ðŸ”„ Processing SIMPER Excel with ${data.length} rows`);\n      console.log('ðŸ“‹ Excel columns found:', Object.keys(data[0] || {}));\n      console.log('ðŸ“… Template Excel Format: dd-mm-yyyy (contoh: 15-12-2025)');\n\n      const simperData = data.map((row: any, index: number) => {\n        // Enhanced column mapping with more variations\n        const employeeName = row['Nama Karyawan'] || row['Nama'] || row['nama'] || row['NAMA KARYAWAN'] || row['NAMA'] || '';\n        const nik = row['NIK'] || row['nik'] || row['No. Identitas'] || row['No Identitas'] || '';\n        \n        // Multiple column name variations for SIMPER dates\n        const bibDate = row['Tanggal SIMPER BIB Mati'] || row['SIMPER BIB'] || row['Tanggal BIB'] || \n                       row['BIB Expired'] || row['BIB Mati'] || row['SIMPER BIB Expired'] || \n                       row['simper_bib'] || row['bib_date'] || '';\n                       \n        const tiaDate = row['Tanggal SIMPER TIA Mati'] || row['SIMPER TIA'] || row['Tanggal TIA'] || \n                       row['TIA Expired'] || row['TIA Mati'] || row['SIMPER TIA Expired'] || \n                       row['simper_tia'] || row['tia_date'] || '';\n\n        const processedBibDate = excelSerialDateToJSDate(bibDate);\n        const processedTiaDate = excelSerialDateToJSDate(tiaDate);\n\n        return {\n          employeeName: employeeName.trim(),\n          nik: nik.trim(),\n          simperBibExpiredDate: processedBibDate || undefined,\n          simperTiaExpiredDate: processedTiaDate || undefined\n        };\n      });\n\n      const result = await storage.bulkUploadSimperData(simperData);\n      \n      console.log(`âœ… SIMPER upload completed: ${result.success} success, ${result.errors.length} errors`);\n      if (result.errors.length > 0) {\n        console.log('âŒ Upload errors:', result.errors);\n      }\n      \n      res.json({\n        message: `Upload berhasil: ${result.success} data berhasil diproses`,\n        success: result.success,\n        errors: result.errors\n      });\n\n      // Clean up uploaded file\n      if (req.file.path) {\n        fs.unlinkSync(req.file.path);\n      }\n    } catch (error) {\n      console.error('Error uploading SIMPER Excel:', error);\n      res.status(500).json({ message: \"Gagal mengupload file Excel SIMPER\" });\n    }\n  });\n\n  // ============================================\n  // SIDAK FATIGUE ROUTES (PUBLIC ACCESS - NO AUTH)\n  // ============================================\n\n  // Create new Sidak Fatigue session\n  app.post(\"/api/sidak-fatigue\", async (req, res) => {\n    try {\n      const validatedData = insertSidakFatigueSessionSchema.parse(req.body);\n      \n      // Get logged-in user's NIK to track who created this SIDAK\n      const sessionUser = (req.session as any).user;\n      const createdBy = sessionUser?.nik || null;\n      \n      const session = await storage.createSidakFatigueSession({\n        ...validatedData,\n        createdBy\n      });\n      res.json(session);\n    } catch (error: any) {\n      console.error(\"Error creating Sidak Fatigue session:\", error);\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Data tidak valid\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Gagal membuat sesi Sidak Fatigue\" });\n    }\n  });\n\n  // Get all Sidak Fatigue sessions (filtered by user role)\n  app.get(\"/api/sidak-fatigue\", async (req, res) => {\n    try {\n      let sessions = await storage.getAllSidakFatigueSessions();\n      \n      // Filter by createdBy based on user role\n      // ADMIN can see all, others only see their own\n      const sessionUser = (req.session as any).user;\n      if (sessionUser && sessionUser.role !== 'ADMIN') {\n        sessions = sessions.filter(s => s.createdBy === sessionUser.nik);\n      }\n      \n      // Add computed totalSampel (actual count from records) to each session\n      const sessionsWithCounts = await Promise.all(\n        sessions.map(async (session) => {\n          const records = await storage.getSidakFatigueRecords(session.id);\n          return {\n            ...session,\n            totalSampel: records.length // Override with actual count\n          };\n        })\n      );\n      \n      res.json(sessionsWithCounts);\n    } catch (error) {\n      console.error(\"Error fetching Sidak Fatigue sessions:\", error);\n      res.status(500).json({ message: \"Gagal mengambil data sesi Sidak Fatigue\" });\n    }\n  });\n\n  // Get single Sidak Fatigue session with records and observers\n  app.get(\"/api/sidak-fatigue/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      const [session, records, observers] = await Promise.all([\n        storage.getSidakFatigueSession(id),\n        storage.getSidakFatigueRecords(id),\n        storage.getSidakFatigueObservers(id)\n      ]);\n\n      if (!session) {\n        return res.status(404).json({ message: \"Sesi Sidak Fatigue tidak ditemukan\" });\n      }\n\n      res.json({\n        ...session,\n        records,\n        observers\n      });\n    } catch (error) {\n      console.error(\"Error fetching Sidak Fatigue session:\", error);\n      res.status(500).json({ message: \"Gagal mengambil detail sesi Sidak Fatigue\" });\n    }\n  });\n\n  // Add employee record to Sidak Fatigue session\n  app.post(\"/api/sidak-fatigue/:id/records\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertSidakFatigueRecordSchema.parse({\n        ...req.body,\n        sessionId: id\n      });\n\n      const record = await storage.createSidakFatigueRecord(validatedData);\n      res.json(record);\n    } catch (error: any) {\n      console.error(\"Error adding Sidak Fatigue record:\", error);\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Data tidak valid\", errors: error.errors });\n      }\n      // Check for max limit error\n      if (error.message?.includes('Maksimal 20 karyawan')) {\n        return res.status(422).json({ message: error.message });\n      }\n      res.status(500).json({ message: \"Gagal menambahkan data karyawan\" });\n    }\n  });\n\n  // Add observer to Sidak Fatigue session\n  app.post(\"/api/sidak-fatigue/:id/observers\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertSidakFatigueObserverSchema.parse({\n        ...req.body,\n        sessionId: id\n      });\n\n      const observer = await storage.createSidakFatigueObserver(validatedData);\n      res.json(observer);\n    } catch (error: any) {\n      console.error(\"Error adding Sidak Fatigue observer:\", error);\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Data tidak valid\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Gagal menambahkan observer\" });\n    }\n  });\n\n  // Delete Sidak Fatigue session (cascades to records & observers)\n  app.delete(\"/api/sidak-fatigue/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteSidakFatigueSession(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ message: \"Sesi Sidak Fatigue tidak ditemukan\" });\n      }\n\n      res.json({ message: \"Sesi Sidak Fatigue berhasil dihapus\" });\n    } catch (error) {\n      console.error(\"Error deleting Sidak Fatigue session:\", error);\n      res.status(500).json({ message: \"Gagal menghapus sesi Sidak Fatigue\" });\n    }\n  });\n\n  // ============================================\n  // SIDAK ROSTER ROUTES (PUBLIC ACCESS - NO AUTH)\n  // ============================================\n\n  // Lookup roster data for employee on specific date (for auto-fill in SIDAK Roster)\n  app.get(\"/api/roster-lookup/:employeeId/:date\", async (req, res) => {\n    try {\n      const { employeeId, date } = req.params;\n      const { currentShift } = req.query; // Get current shift from query parameter\n      \n      // Get roster schedule for this employee on this date\n      const rosterSchedule = await storage.getRosterByEmployeeAndDate(employeeId, date);\n      \n      if (!rosterSchedule) {\n        // Employee not scheduled to work on this date\n        return res.json({\n          isScheduled: false,\n          rosterSesuai: false,\n          keterangan: \"Tidak Terjadwal\",\n          nomorLambung: \"\",\n          shift: \"\",\n          shiftMismatch: false\n        });\n      }\n      \n      // Validate shift if currentShift parameter is provided\n      if (currentShift) {\n        const scheduledShift = rosterSchedule.shift || \"\";\n        \n        // Normalize shift strings for comparison (e.g., \"SHIFT 1\" vs \"Shift 1\")\n        const normalizedScheduledShift = scheduledShift.toUpperCase().trim();\n        const normalizedCurrentShift = currentShift.toString().toUpperCase().trim();\n        \n        if (normalizedScheduledShift !== normalizedCurrentShift) {\n          // Shift mismatch - employee scheduled for different shift\n          return res.json({\n            isScheduled: true,\n            shiftMismatch: true,\n            scheduledShift: scheduledShift,\n            currentShift: currentShift,\n            message: `Driver terjadwal di ${scheduledShift} tetapi inspeksi dilakukan di ${currentShift}`,\n            rosterSesuai: false,\n            keterangan: \"\",\n            nomorLambung: \"\",\n            shift: scheduledShift\n          });\n        }\n      }\n      \n      // Get \"Hari Kerja Ke-X\" from roster.hariKerja column\n      const hariKerja = rosterSchedule.hariKerja || \"1\";\n      \n      res.json({\n        isScheduled: true,\n        rosterSesuai: true, // Employee is scheduled and shift matches\n        keterangan: `Hari Kerja Ke-${hariKerja}`,\n        nomorLambung: rosterSchedule.plannedNomorLambung || rosterSchedule.actualNomorLambung || \"\",\n        shift: rosterSchedule.shift || \"\",\n        shiftMismatch: false\n      });\n      \n    } catch (error) {\n      console.error(\"Error looking up roster:\", error);\n      res.status(500).json({ message: \"Gagal mencari data roster\" });\n    }\n  });\n\n  // Create new Sidak Roster session\n  app.post(\"/api/sidak-roster\", async (req, res) => {\n    try {\n      const validatedData = insertSidakRosterSessionSchema.parse(req.body);\n      \n      // Get logged-in user's NIK to track who created this SIDAK\n      const sessionUser = (req.session as any).user;\n      const createdBy = sessionUser?.nik || null;\n      \n      const session = await storage.createSidakRosterSession({\n        ...validatedData,\n        createdBy\n      });\n      res.json(session);\n    } catch (error: any) {\n      console.error(\"Error creating Sidak Roster session:\", error);\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Data tidak valid\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Gagal membuat sesi Sidak Roster\" });\n    }\n  });\n\n  // Get all Sidak Roster sessions (filtered by user role)\n  app.get(\"/api/sidak-roster\", async (req, res) => {\n    try {\n      let sessions = await storage.getAllSidakRosterSessions();\n      \n      // Filter by createdBy based on user role\n      // ADMIN can see all, others only see their own\n      const sessionUser = (req.session as any).user;\n      if (sessionUser && sessionUser.role !== 'ADMIN') {\n        sessions = sessions.filter(s => s.createdBy === sessionUser.nik);\n      }\n      \n      // Add computed totalSampel (actual count from records) to each session\n      const sessionsWithCounts = await Promise.all(\n        sessions.map(async (session) => {\n          const records = await storage.getSidakRosterRecords(session.id);\n          return {\n            ...session,\n            totalSampel: records.length // Override with actual count\n          };\n        })\n      );\n      \n      res.json(sessionsWithCounts);\n    } catch (error) {\n      console.error(\"Error fetching Sidak Roster sessions:\", error);\n      res.status(500).json({ message: \"Gagal mengambil data sesi Sidak Roster\" });\n    }\n  });\n\n  // Get single Sidak Roster session with records and observers\n  app.get(\"/api/sidak-roster/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      const [session, records, observers] = await Promise.all([\n        storage.getSidakRosterSession(id),\n        storage.getSidakRosterRecords(id),\n        storage.getSidakRosterObservers(id)\n      ]);\n\n      if (!session) {\n        return res.status(404).json({ message: \"Sesi Sidak Roster tidak ditemukan\" });\n      }\n\n      res.json({\n        ...session,\n        records,\n        observers\n      });\n    } catch (error) {\n      console.error(\"Error fetching Sidak Roster session:\", error);\n      res.status(500).json({ message: \"Gagal mengambil detail sesi Sidak Roster\" });\n    }\n  });\n\n  // Add employee record to Sidak Roster session\n  app.post(\"/api/sidak-roster/:id/records\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertSidakRosterRecordSchema.parse({\n        ...req.body,\n        sessionId: id\n      });\n\n      const record = await storage.createSidakRosterRecord(validatedData);\n      res.json(record);\n    } catch (error: any) {\n      console.error(\"Error adding Sidak Roster record:\", error);\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Data tidak valid\", errors: error.errors });\n      }\n      // Check for max limit error\n      if (error.message?.includes('Maksimal 15 karyawan')) {\n        return res.status(422).json({ message: error.message });\n      }\n      res.status(500).json({ message: \"Gagal menambahkan data karyawan\" });\n    }\n  });\n\n  // Add observer to Sidak Roster session\n  app.post(\"/api/sidak-roster/:id/observers\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertSidakRosterObserverSchema.parse({\n        ...req.body,\n        sessionId: id\n      });\n\n      const observer = await storage.createSidakRosterObserver(validatedData);\n      res.json(observer);\n    } catch (error: any) {\n      console.error(\"Error adding Sidak Roster observer:\", error);\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Data tidak valid\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Gagal menambahkan observer\" });\n    }\n  });\n\n  // Delete Sidak Roster session (cascades to records & observers)\n  app.delete(\"/api/sidak-roster/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteSidakRosterSession(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ message: \"Sesi Sidak Roster tidak ditemukan\" });\n      }\n\n      res.json({ message: \"Sesi Sidak Roster berhasil dihapus\" });\n    } catch (error) {\n      console.error(\"Error deleting Sidak Roster session:\", error);\n      res.status(500).json({ message: \"Gagal menghapus sesi Sidak Roster\" });\n    }\n  });\n\n\n  // ==================== ANNOUNCEMENT SYSTEM API ====================\n  \n  // Get all announcements (admin)\n  app.get(\"/api/announcements\", async (req, res) => {\n    try {\n      const announcements = await storage.getAllAnnouncements();\n      res.json(announcements);\n    } catch (error) {\n      console.error(\"Error fetching announcements:\", error);\n      res.status(500).json({ message: \"Gagal mengambil pengumuman\" });\n    }\n  });\n\n  // Get active announcements (for drivers)\n  app.get(\"/api/announcements/active\", async (req, res) => {\n    try {\n      const announcements = await storage.getActiveAnnouncements();\n      res.json(announcements);\n    } catch (error) {\n      console.error(\"Error fetching active announcements:\", error);\n      res.status(500).json({ message: \"Gagal mengambil pengumuman aktif\" });\n    }\n  });\n\n  // Get active announcements with read status for a specific employee\n  app.get(\"/api/announcements/active-with-status/:employeeId\", async (req, res) => {\n    try {\n      const { employeeId } = req.params;\n      const announcements = await storage.getActiveAnnouncements();\n      \n      // Check read status for each announcement\n      const announcementsWithStatus = await Promise.all(\n        announcements.map(async (announcement) => {\n          const isRead = await storage.hasReadAnnouncement(announcement.id, employeeId);\n          return {\n            ...announcement,\n            isRead\n          };\n        })\n      );\n      \n      res.json(announcementsWithStatus);\n    } catch (error) {\n      console.error(\"Error fetching active announcements with status:\", error);\n      res.status(500).json({ message: \"Gagal mengambil pengumuman aktif\" });\n    }\n  });\n\n  // Get unread count for employee\n  app.get(\"/api/announcements/unread-count/:employeeId\", async (req, res) => {\n    try {\n      const { employeeId } = req.params;\n      const count = await storage.getUnreadAnnouncementsCount(employeeId);\n      res.json({ count });\n    } catch (error) {\n      console.error(\"Error fetching unread count:\", error);\n      res.status(500).json({ message: \"Gagal mengambil jumlah belum dibaca\" });\n    }\n  });\n\n  // Get single announcement\n  app.get(\"/api/announcements/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const announcement = await storage.getAnnouncement(id);\n      \n      if (!announcement) {\n        return res.status(404).json({ message: \"Pengumuman tidak ditemukan\" });\n      }\n      \n      res.json(announcement);\n    } catch (error) {\n      console.error(\"Error fetching announcement:\", error);\n      res.status(500).json({ message: \"Gagal mengambil pengumuman\" });\n    }\n  });\n\n  // Create announcement (admin only)\n  app.post(\"/api/announcements\", async (req, res) => {\n    try {\n      const validatedData = insertAnnouncementSchema.parse(req.body);\n      const announcement = await storage.createAnnouncement(validatedData);\n      res.json(announcement);\n    } catch (error: any) {\n      console.error(\"Error creating announcement:\", error);\n      if (error.name === 'ZodError') {\n        return res.status(400).json({ message: \"Data tidak valid\", errors: error.errors });\n      }\n      res.status(500).json({ message: \"Gagal membuat pengumuman\" });\n    }\n  });\n\n  // Update announcement (admin only)\n  app.patch(\"/api/announcements/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const announcement = await storage.updateAnnouncement(id, req.body);\n      \n      if (!announcement) {\n        return res.status(404).json({ message: \"Pengumuman tidak ditemukan\" });\n      }\n      \n      res.json(announcement);\n    } catch (error) {\n      console.error(\"Error updating announcement:\", error);\n      res.status(500).json({ message: \"Gagal mengupdate pengumuman\" });\n    }\n  });\n\n  // Delete announcement (admin only)\n  app.delete(\"/api/announcements/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteAnnouncement(id);\n      \n      if (!deleted) {\n        return res.status(404).json({ message: \"Pengumuman tidak ditemukan\" });\n      }\n      \n      res.json({ message: \"Pengumuman berhasil dihapus\" });\n    } catch (error) {\n      console.error(\"Error deleting announcement:\", error);\n      res.status(500).json({ message: \"Gagal menghapus pengumuman\" });\n    }\n  });\n\n  // Upload announcement image\n  const announcementImageUpload = multer({\n    storage: multer.diskStorage({\n      destination: function (req, file, cb) {\n        const uploadDir = path.join(process.cwd(), 'uploads', 'announcements');\n        if (!fs.existsSync(uploadDir)) {\n          fs.mkdirSync(uploadDir, { recursive: true });\n        }\n        cb(null, uploadDir);\n      },\n      filename: function (req, file, cb) {\n        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n        cb(null, 'announcement-' + uniqueSuffix + path.extname(file.originalname));\n      }\n    }),\n    limits: { fileSize: 5 * 1024 * 1024 },\n    fileFilter: function (req, file, cb) {\n      const allowedTypes = /jpeg|jpg|png|gif/;\n      const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());\n      const mimetype = allowedTypes.test(file.mimetype);\n      if (mimetype && extname) {\n        return cb(null, true);\n      }\n      cb(new Error('Only .png, .jpg, .jpeg and .gif format allowed!'));\n    }\n  });\n\n  app.post(\"/api/announcements/upload-image\", announcementImageUpload.single('image'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"Tidak ada file yang diupload\" });\n      }\n\n      const imageUrl = `/uploads/announcements/${path.basename(req.file.path)}`;\n      res.json({ url: imageUrl, fileName: path.basename(req.file.path) });\n    } catch (error) {\n      console.error(\"Error uploading announcement image:\", error);\n      if (req.file && fs.existsSync(req.file.path)) {\n        fs.unlinkSync(req.file.path);\n      }\n      res.status(500).json({ message: \"Gagal mengupload gambar\" });\n    }\n  });\n\n  // Get read statistics for an announcement\n  app.get(\"/api/announcements/:id/reads\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const reads = await storage.getAnnouncementReads(id);\n      res.json(reads);\n    } catch (error) {\n      console.error(\"Error fetching announcement reads:\", error);\n      res.status(500).json({ message: \"Gagal mengambil data pembaca\" });\n    }\n  });\n\n  // Mark announcement as read\n  app.post(\"/api/announcements/:id/read\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { employeeId, employeeName } = req.body;\n      \n      if (!employeeId || !employeeName) {\n        return res.status(400).json({ message: \"employeeId dan employeeName diperlukan\" });\n      }\n\n      const read = await storage.markAnnouncementAsRead(id, employeeId, employeeName);\n      res.json(read);\n    } catch (error) {\n      console.error(\"Error marking announcement as read:\", error);\n      res.status(500).json({ message: \"Gagal mencatat pengumuman dibaca\" });\n    }\n  });\n\n  // Check if employee has read an announcement\n  app.get(\"/api/announcements/:id/has-read/:employeeId\", async (req, res) => {\n    try {\n      const { id, employeeId } = req.params;\n      const hasRead = await storage.hasReadAnnouncement(id, employeeId);\n      res.json({ hasRead });\n    } catch (error) {\n      console.error(\"Error checking read status:\", error);\n      res.status(500).json({ message: \"Gagal memeriksa status baca\" });\n    }\n  });\n\n  // =====================================================\n  // DOCUMENT MANAGEMENT ROUTES\n  // =====================================================\n  \n  // Configure multer for PDF document uploads\n  const documentUpload = multer({\n    storage: multer.diskStorage({\n      destination: function (req, file, cb) {\n        const uploadDir = path.join(process.cwd(), 'uploads', 'documents');\n        if (!fs.existsSync(uploadDir)) {\n          fs.mkdirSync(uploadDir, { recursive: true });\n        }\n        cb(null, uploadDir);\n      },\n      filename: function (req, file, cb) {\n        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n        const ext = path.extname(file.originalname);\n        cb(null, 'doc-' + uniqueSuffix + ext);\n      }\n    }),\n    fileFilter: (req, file, cb) => {\n      if (file.mimetype === 'application/pdf') {\n        cb(null, true);\n      } else {\n        cb(null, false);\n      }\n    },\n    limits: {\n      fileSize: 50 * 1024 * 1024 // Max 50MB\n    }\n  });\n\n  // Get all documents\n  app.get(\"/api/documents\", async (req, res) => {\n    try {\n      const docs = await storage.getAllDocuments();\n      res.json(docs);\n    } catch (error) {\n      console.error(\"Error fetching documents:\", error);\n      res.status(500).json({ message: \"Gagal mengambil data dokumen\" });\n    }\n  });\n\n  // Get active documents only\n  app.get(\"/api/documents/active\", async (req, res) => {\n    try {\n      const docs = await storage.getActiveDocuments();\n      res.json(docs);\n    } catch (error) {\n      console.error(\"Error fetching active documents:\", error);\n      res.status(500).json({ message: \"Gagal mengambil data dokumen aktif\" });\n    }\n  });\n\n  // Get documents by category\n  app.get(\"/api/documents/category/:category\", async (req, res) => {\n    try {\n      const { category } = req.params;\n      const docs = await storage.getDocumentsByCategory(decodeURIComponent(category));\n      res.json(docs);\n    } catch (error) {\n      console.error(\"Error fetching documents by category:\", error);\n      res.status(500).json({ message: \"Gagal mengambil data dokumen per kategori\" });\n    }\n  });\n\n  // Get single document\n  app.get(\"/api/documents/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const doc = await storage.getDocument(id);\n      if (!doc) {\n        return res.status(404).json({ message: \"Dokumen tidak ditemukan\" });\n      }\n      res.json(doc);\n    } catch (error) {\n      console.error(\"Error fetching document:\", error);\n      res.status(500).json({ message: \"Gagal mengambil data dokumen\" });\n    }\n  });\n\n  // Upload and create document (Admin only)\n  app.post(\"/api/documents\", documentUpload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"File PDF diperlukan\" });\n      }\n\n      const { title, category, uploadedBy, uploadedByName } = req.body;\n\n      if (!title || !category || !uploadedBy || !uploadedByName) {\n        // Delete uploaded file if validation fails\n        fs.unlinkSync(req.file.path);\n        return res.status(400).json({ message: \"Title, category, uploadedBy, dan uploadedByName diperlukan\" });\n      }\n\n      const doc = await storage.createDocument({\n        title,\n        category,\n        fileName: req.file.originalname,\n        filePath: `/uploads/documents/${req.file.filename}`,\n        fileSize: req.file.size,\n        uploadedBy,\n        uploadedByName,\n        isActive: true\n      });\n\n      res.status(201).json(doc);\n    } catch (error) {\n      console.error(\"Error creating document:\", error);\n      res.status(500).json({ message: \"Gagal membuat dokumen\" });\n    }\n  });\n\n  // Update document metadata\n  app.patch(\"/api/documents/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const updateData = req.body;\n      \n      const doc = await storage.updateDocument(id, updateData);\n      if (!doc) {\n        return res.status(404).json({ message: \"Dokumen tidak ditemukan\" });\n      }\n      res.json(doc);\n    } catch (error) {\n      console.error(\"Error updating document:\", error);\n      res.status(500).json({ message: \"Gagal memperbarui dokumen\" });\n    }\n  });\n\n  // Delete document (Admin only)\n  app.delete(\"/api/documents/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      // Get document first to delete the file\n      const doc = await storage.getDocument(id);\n      if (doc && doc.filePath) {\n        const fullPath = path.join(process.cwd(), doc.filePath);\n        if (fs.existsSync(fullPath)) {\n          fs.unlinkSync(fullPath);\n        }\n      }\n      \n      const deleted = await storage.deleteDocument(id);\n      if (!deleted) {\n        return res.status(404).json({ message: \"Dokumen tidak ditemukan\" });\n      }\n      res.json({ message: \"Dokumen berhasil dihapus\" });\n    } catch (error) {\n      console.error(\"Error deleting document:\", error);\n      res.status(500).json({ message: \"Gagal menghapus dokumen\" });\n    }\n  });\n\n  // Serve uploaded documents\n  app.use('/uploads/documents', express.static(path.join(process.cwd(), 'uploads', 'documents')));\n  app.use('/uploads/news', express.static(path.join(process.cwd(), 'uploads', 'news')));\n\n  // ================== NEWS API ==================\n  \n  // Upload news image\n  const newsImageUpload = multer({\n    storage: multer.diskStorage({\n      destination: function (req, file, cb) {\n        const uploadDir = path.join(process.cwd(), 'uploads', 'news');\n        if (!fs.existsSync(uploadDir)) {\n          fs.mkdirSync(uploadDir, { recursive: true });\n        }\n        cb(null, uploadDir);\n      },\n      filename: function (req, file, cb) {\n        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n        cb(null, 'news-' + uniqueSuffix + path.extname(file.originalname));\n      }\n    }),\n    limits: { fileSize: 5 * 1024 * 1024 },\n    fileFilter: function (req, file, cb) {\n      const allowedTypes = /jpeg|jpg|png|gif/;\n      const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());\n      const mimetype = allowedTypes.test(file.mimetype);\n      if (mimetype && extname) {\n        return cb(null, true);\n      }\n      cb(new Error('Only .png, .jpg, .jpeg and .gif format allowed!'));\n    }\n  });\n\n  app.post(\"/api/news/upload-image\", newsImageUpload.single('image'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"Tidak ada file yang diupload\" });\n      }\n\n      const imageUrl = `/uploads/news/${path.basename(req.file.path)}`;\n      res.json({ url: imageUrl, fileName: path.basename(req.file.path) });\n    } catch (error) {\n      console.error(\"Error uploading news image:\", error);\n      if (req.file && fs.existsSync(req.file.path)) {\n        fs.unlinkSync(req.file.path);\n      }\n      res.status(500).json({ message: \"Gagal mengupload gambar\" });\n    }\n  });\n\n  // Get all news (for admin)\n  app.get(\"/api/news\", async (req, res) => {\n    try {\n      const allNews = await storage.getAllNews();\n      res.json(allNews);\n    } catch (error) {\n      console.error(\"Error fetching news:\", error);\n      res.status(500).json({ message: \"Gagal mengambil berita\" });\n    }\n  });\n\n  // Get active news (for all users)\n  app.get(\"/api/news/active\", async (req, res) => {\n    try {\n      const activeNews = await storage.getActiveNews();\n      res.json(activeNews);\n    } catch (error) {\n      console.error(\"Error fetching active news:\", error);\n      res.status(500).json({ message: \"Gagal mengambil berita aktif\" });\n    }\n  });\n\n  // Get single news\n  app.get(\"/api/news/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const newsItem = await storage.getNews(id);\n      if (!newsItem) {\n        return res.status(404).json({ message: \"Berita tidak ditemukan\" });\n      }\n      res.json(newsItem);\n    } catch (error) {\n      console.error(\"Error fetching news:\", error);\n      res.status(500).json({ message: \"Gagal mengambil berita\" });\n    }\n  });\n\n  // Create news (Admin only)\n  app.post(\"/api/news\", async (req, res) => {\n    try {\n      const validatedData = insertNewsSchema.parse(req.body);\n      const newsItem = await storage.createNews(validatedData);\n      \n      // Send push notification for important news\n      if (validatedData.isImportant) {\n        try {\n          const subscriptions = await storage.getActivePushSubscriptions();\n          const pushService = new PushNotificationService();\n          \n          for (const sub of subscriptions) {\n            try {\n              await pushService.sendNotification(\n                {\n                  endpoint: sub.endpoint,\n                  keys: { p256dh: sub.p256dh, auth: sub.auth }\n                },\n                {\n                  title: \"Berita Penting\",\n                  body: validatedData.title,\n                  icon: \"/icons/icon-192x192.png\",\n                  badge: \"/icons/icon-72x72.png\",\n                  data: { url: \"/workspace/news-feed\", newsId: newsItem.id }\n                }\n              );\n            } catch (pushError) {\n              console.error(\"Error sending push to subscription:\", sub.id, pushError);\n            }\n          }\n        } catch (pushError) {\n          console.error(\"Error sending news push notifications:\", pushError);\n        }\n      }\n      \n      res.status(201).json(newsItem);\n    } catch (error) {\n      console.error(\"Error creating news:\", error);\n      res.status(500).json({ message: \"Gagal membuat berita\" });\n    }\n  });\n\n  // Update news (Admin only)\n  app.patch(\"/api/news/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const updateData = req.body;\n      \n      const newsItem = await storage.updateNews(id, updateData);\n      if (!newsItem) {\n        return res.status(404).json({ message: \"Berita tidak ditemukan\" });\n      }\n      res.json(newsItem);\n    } catch (error) {\n      console.error(\"Error updating news:\", error);\n      res.status(500).json({ message: \"Gagal memperbarui berita\" });\n    }\n  });\n\n  // Delete news (Admin only)\n  app.delete(\"/api/news/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteNews(id);\n      if (!deleted) {\n        return res.status(404).json({ message: \"Berita tidak ditemukan\" });\n      }\n      res.json({ message: \"Berita berhasil dihapus\" });\n    } catch (error) {\n      console.error(\"Error deleting news:\", error);\n      res.status(500).json({ message: \"Gagal menghapus berita\" });\n    }\n  });\n\n  // ================== PUSH SUBSCRIPTION API ==================\n  \n  // Get VAPID public key\n  app.get(\"/api/push/vapid-public-key\", async (req, res) => {\n    try {\n      const publicKey = process.env.VAPID_PUBLIC_KEY;\n      if (!publicKey) {\n        return res.status(500).json({ message: \"VAPID public key not configured\" });\n      }\n      res.json({ publicKey });\n    } catch (error) {\n      console.error(\"Error getting VAPID public key:\", error);\n      res.status(500).json({ message: \"Gagal mengambil VAPID public key\" });\n    }\n  });\n\n  // Subscribe to push notifications\n  app.post(\"/api/push/subscribe\", async (req, res) => {\n    try {\n      const { employeeId, subscription } = req.body;\n      \n      if (!employeeId || !subscription || !subscription.endpoint || !subscription.keys) {\n        return res.status(400).json({ message: \"Data subscription tidak lengkap\" });\n      }\n\n      // Check if subscription already exists\n      const existingSubscriptions = await storage.getPushSubscriptionsByEmployee(employeeId);\n      const existingSub = existingSubscriptions.find(s => s.endpoint === subscription.endpoint);\n      \n      if (existingSub) {\n        // Update existing subscription\n        const updated = await storage.updatePushSubscription(existingSub.id, {\n          p256dh: subscription.keys.p256dh,\n          auth: subscription.keys.auth,\n          isActive: true\n        });\n        return res.json({ message: \"Subscription updated\", subscription: updated });\n      }\n\n      // Create new subscription\n      const newSubscription = await storage.createPushSubscription({\n        employeeId,\n        endpoint: subscription.endpoint,\n        p256dh: subscription.keys.p256dh,\n        auth: subscription.keys.auth,\n        isActive: true\n      });\n\n      res.status(201).json({ message: \"Subscribed successfully\", subscription: newSubscription });\n    } catch (error) {\n      console.error(\"Error subscribing to push:\", error);\n      res.status(500).json({ message: \"Gagal subscribe push notification\" });\n    }\n  });\n\n  // Unsubscribe from push notifications\n  app.post(\"/api/push/unsubscribe\", async (req, res) => {\n    try {\n      const { endpoint } = req.body;\n      \n      if (!endpoint) {\n        return res.status(400).json({ message: \"Endpoint diperlukan\" });\n      }\n\n      const deleted = await storage.deletePushSubscriptionByEndpoint(endpoint);\n      if (!deleted) {\n        return res.status(404).json({ message: \"Subscription tidak ditemukan\" });\n      }\n      \n      res.json({ message: \"Unsubscribed successfully\" });\n    } catch (error) {\n      console.error(\"Error unsubscribing from push:\", error);\n      res.status(500).json({ message: \"Gagal unsubscribe push notification\" });\n    }\n  });\n\n  // Test push notification (Admin only)\n  app.post(\"/api/push/test\", async (req, res) => {\n    try {\n      const { employeeId, title, body } = req.body;\n      \n      if (!employeeId) {\n        return res.status(400).json({ message: \"Employee ID diperlukan\" });\n      }\n\n      const subscriptions = await storage.getPushSubscriptionsByEmployee(employeeId);\n      if (subscriptions.length === 0) {\n        return res.status(404).json({ message: \"Tidak ada subscription untuk employee ini\" });\n      }\n\n      const pushService = new PushNotificationService();\n      let successCount = 0;\n      let failCount = 0;\n\n      for (const sub of subscriptions) {\n        try {\n          await pushService.sendNotification(\n            {\n              endpoint: sub.endpoint,\n              keys: { p256dh: sub.p256dh, auth: sub.auth }\n            },\n            {\n              title: title || \"Test Notification\",\n              body: body || \"Ini adalah test push notification\",\n              icon: \"/icons/icon-192x192.png\",\n              badge: \"/icons/icon-72x72.png\",\n              data: { url: \"/\" }\n            }\n          );\n          successCount++;\n        } catch (pushError) {\n          console.error(\"Error sending test push:\", pushError);\n          failCount++;\n        }\n      }\n\n      res.json({ \n        message: `Push notification sent`, \n        success: successCount, \n        failed: failCount \n      });\n    } catch (error) {\n      console.error(\"Error sending test push:\", error);\n      res.status(500).json({ message: \"Gagal mengirim test push notification\" });\n    }\n  });\n\n  // Send push to all subscribed users (Admin only)\n  app.post(\"/api/push/broadcast\", async (req, res) => {\n    try {\n      const { title, body, url } = req.body;\n      \n      if (!title || !body) {\n        return res.status(400).json({ message: \"Title dan body diperlukan\" });\n      }\n\n      const subscriptions = await storage.getActivePushSubscriptions();\n      if (subscriptions.length === 0) {\n        return res.status(404).json({ message: \"Tidak ada subscriber aktif\" });\n      }\n\n      const pushService = new PushNotificationService();\n      let successCount = 0;\n      let failCount = 0;\n\n      for (const sub of subscriptions) {\n        try {\n          await pushService.sendNotification(\n            {\n              endpoint: sub.endpoint,\n              keys: { p256dh: sub.p256dh, auth: sub.auth }\n            },\n            {\n              title,\n              body,\n              icon: \"/icons/icon-192x192.png\",\n              badge: \"/icons/icon-72x72.png\",\n              data: { url: url || \"/\" }\n            }\n          );\n          successCount++;\n        } catch (pushError) {\n          console.error(\"Error sending broadcast push:\", pushError);\n          failCount++;\n          \n          // Deactivate failed subscriptions\n          if (sub.id) {\n            try {\n              await storage.updatePushSubscription(sub.id, { isActive: false });\n            } catch (updateError) {\n              console.error(\"Error deactivating subscription:\", updateError);\n            }\n          }\n        }\n      }\n\n      res.json({ \n        message: `Broadcast sent to ${subscriptions.length} subscribers`, \n        success: successCount, \n        failed: failCount \n      });\n    } catch (error) {\n      console.error(\"Error broadcasting push:\", error);\n      res.status(500).json({ message: \"Gagal mengirim broadcast push notification\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","path":null,"size_bytes":208878,"size_tokens":null},"client/src/components/qr/mobile-qr-redirect.tsx":{"content":"import { useEffect } from 'react';\nimport { validateQRData } from \"@/lib/crypto-utils\";\n\ninterface MobileQRRedirectProps {\n  onQRDetected?: (employeeId: string) => void;\n}\n\nexport function MobileQRRedirect({ onQRDetected }: MobileQRRedirectProps) {\n  useEffect(() => {\n    // Deteksi apakah diakses dari mobile\n    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;\n    \n    if (!isMobile) return;\n\n    // Cek URL parameters untuk QR scan result\n    const urlParams = new URLSearchParams(window.location.search);\n    const qrResult = urlParams.get('qr');\n    \n    if (qrResult) {\n      try {\n        const qrData = validateQRData(qrResult);\n        if (qrData && qrData.id) {\n          // Redirect ke mobile driver view\n          window.location.href = `/mobile-driver?nik=${qrData.id}`;\n        }\n      } catch (error) {\n        console.error('Invalid QR format:', error);\n      }\n    }\n  }, []);\n\n  return null; // This is a utility component that doesn't render anything\n}","path":null,"size_bytes":1061,"size_tokens":null},"client/src/components/workspace.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { useState, useEffect } from \"react\";\nimport { Sidebar } from \"@/components/layout/sidebar\";\nimport { Header } from \"@/components/layout/header\";\nimport { LoadingScreen } from \"@/components/ui/loading-screen\";\nimport { PermissionGuard } from \"@/components/PermissionGuard\";\nimport { Permission } from \"@shared/rbac\";\n\nimport Dashboard from \"@/pages/dashboard\";\nimport QRGenerator from \"@/pages/qr-generator\";\nimport Scanner from \"@/pages/scanner\";\nimport Employees from \"@/pages/employees\";\nimport Roster from \"@/pages/roster\";\nimport Leave from \"@/pages/leave\";\nimport LeaveRosterMonitoring from \"@/pages/leave-roster-monitoring\";\nimport SimperMonitoring from \"@/pages/simper-monitoring\";\nimport Reports from \"@/pages/reports\";\nimport Meetings from \"@/pages/meetings\";\nimport MeetingScanner from \"@/pages/meeting-scanner\";\nimport DriverView from \"@/pages/driver-view\";\nimport MobileDriverView from \"@/pages/mobile-driver-view\";\nimport EmployeePersonalData from \"@/pages/employee-personal-data\";\nimport SidakDashboard from \"@/pages/sidak\";\nimport SidakFatigueForm from \"@/pages/sidak-fatigue-form\";\nimport SidakRosterForm from \"@/pages/sidak-roster-form\";\nimport SidakFatigueHistory from \"@/pages/sidak-fatigue-history\";\nimport SidakRosterHistory from \"@/pages/sidak-roster-history\";\nimport EvaluasiDriver from \"@/pages/evaluasi-driver\";\nimport Announcements from \"@/pages/announcements\";\nimport News from \"@/pages/news\";\nimport NewsFeed from \"@/pages/news-feed\";\nimport Documents from \"@/pages/documents\";\nimport NotFound from \"@/pages/not-found\";\nimport { NotificationPrompt } from \"@/components/NotificationPrompt\";\nimport { WorkspaceHome } from \"@/components/WorkspaceHome\";\n\nconst workspaceRoutes = [\n  { path: \"/workspace\", component: WorkspaceHome, title: \"Beranda\" },\n  { path: \"/workspace/dashboard\", component: Dashboard, title: \"Dashboard Karyawan PT.GECL\" },\n  { path: \"/workspace/qr-generator\", component: QRGenerator, title: \"Generate QR Code\" },\n  { path: \"/workspace/scanner\", component: Scanner, title: \"Scan QR Code\" },\n  { path: \"/workspace/employees\", component: Employees, title: \"Data Karyawan\" },\n  { path: \"/workspace/roster\", component: Roster, title: \"Roster Kerja\" },\n  { path: \"/workspace/leave\", component: Leave, title: \"Manajemen Cuti\" },\n  { path: \"/workspace/leave-roster-monitoring\", component: LeaveRosterMonitoring, title: \"Monitoring Roster Cuti\" },\n  { path: \"/workspace/simper-monitoring\", component: SimperMonitoring, title: \"Monitoring SIMPER Karyawan\" },\n  { path: \"/workspace/reports\", component: Reports, title: \"Laporan\" },\n  { path: \"/workspace/meetings\", component: Meetings, title: \"Meeting Management\" },\n  { path: \"/workspace/meeting-scanner\", component: MeetingScanner, title: \"Scan QR Meeting\" },\n  { path: \"/workspace/sidak\", component: SidakDashboard, title: \"SIDAK - Inspeksi Data Karyawan\" },\n  { path: \"/workspace/sidak/fatigue/new\", component: SidakFatigueForm, title: \"Form Sidak Fatigue\" },\n  { path: \"/workspace/sidak/roster/new\", component: SidakRosterForm, title: \"Form Sidak Roster\" },\n  { path: \"/workspace/sidak/fatigue/history\", component: SidakFatigueHistory, title: \"Riwayat Sidak Fatigue\" },\n  { path: \"/workspace/sidak/roster/history\", component: SidakRosterHistory, title: \"Riwayat Sidak Roster\" },\n  { path: \"/workspace/evaluasi-driver\", component: EvaluasiDriver, title: \"Evaluasi Driver SIDAK Fatigue\" },\n  { path: \"/workspace/announcements\", component: Announcements, title: \"Kelola Pengumuman\" },\n  { path: \"/workspace/news\", component: News, title: \"Kelola Berita\" },\n  { path: \"/workspace/news-feed\", component: NewsFeed, title: \"Berita Perusahaan\" },\n  { path: \"/workspace/documents\", component: Documents, title: \"Dokumen Perusahaan\" },\n  { path: \"/workspace/documents/kebijakan-kplh\", component: Documents, title: \"Dokumen - Kebijakan KPLH\" },\n  { path: \"/workspace/documents/dept-hse\", component: Documents, title: \"Dokumen - Dept HSE\" },\n  { path: \"/workspace/documents/dept-opr\", component: Documents, title: \"Dokumen - Dept Opr\" },\n  { path: \"/workspace/documents/dept-plant\", component: Documents, title: \"Dokumen - Dept Plant\" },\n  { path: \"/workspace/documents/spdk\", component: Documents, title: \"Dokumen - SPDK\" },\n  { path: \"/workspace/documents/zero-harm\", component: Documents, title: \"Dokumen - Zero Harm\" },\n  { path: \"/workspace/documents/critical-control-card\", component: Documents, title: \"Dokumen - Critical Control Card\" },\n  { path: \"/workspace/documents/golden-rule\", component: Documents, title: \"Dokumen - Golden Rule\" },\n  { path: \"/workspace/driver-view\", component: DriverView, title: \"Driver View - Data Karyawan\" },\n  { path: \"/workspace/mobile-driver\", component: MobileDriverView, title: \"Driver Mobile View\" },\n  { path: \"/workspace/employee-personal\", component: EmployeePersonalData, title: \"Data Pribadi Karyawan\" },\n];\n\nexport function Workspace() {\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n\n  const getCurrentTitle = () => {\n    const currentPath = window.location.pathname;\n    const route = workspaceRoutes.find(r => r.path === currentPath);\n    return route?.title || \"AttendanceQR Workspace\";\n  };\n\n  // Show loading screen when entering workspace\n  useEffect(() => {\n    // Reset loading state when component mounts (when navigating to workspace)\n    setIsLoading(true);\n    \n    const timer = setTimeout(() => {\n      setIsLoading(false);\n    }, 2000); // Reduced loading time untuk better UX\n\n    return () => clearTimeout(timer);\n  }, []);\n\n  return (\n    <div className=\"relative\">\n      {/* Loading Screen dengan conditional rendering yang lebih aman */}\n      {isLoading && (\n        <LoadingScreen \n          isLoading={isLoading} \n          onComplete={() => setIsLoading(false)}\n        />\n      )}\n      \n      {/* Notification Prompt - muncul setelah loading selesai */}\n      {!isLoading && <NotificationPrompt />}\n      \n      {/* Workspace Content - selalu render tapi invisible saat loading */}\n      <div \n        className={`h-screen flex bg-gray-50 dark:bg-gray-900 transition-opacity duration-300 ${\n          isLoading ? 'opacity-0 pointer-events-none' : 'opacity-100 pointer-events-auto'\n        }`}\n      >\n        <Sidebar isOpen={sidebarOpen} onClose={() => setSidebarOpen(false)} />\n        \n        <div className=\"flex-1 flex flex-col overflow-hidden lg:ml-0\">\n          <Header \n            title={getCurrentTitle()} \n            onMenuClick={() => setSidebarOpen(true)} \n          />\n          \n          <main className=\"flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 dark:bg-gray-900 p-3 sm:p-4 lg:p-6\">\n            <Switch>\n              <Route path=\"/workspace\" component={WorkspaceHome} />\n              <Route path=\"/workspace/dashboard\" component={Dashboard} />\n              <Route path=\"/workspace/qr-generator\">\n                <PermissionGuard requiredPermissions={[Permission.VIEW_QR, Permission.GENERATE_QR]} requireAll={true}>\n                  <QRGenerator />\n                </PermissionGuard>\n              </Route>\n              <Route path=\"/workspace/scanner\">\n                <PermissionGuard requiredPermissions={[Permission.SCAN_QR]}>\n                  <Scanner />\n                </PermissionGuard>\n              </Route>\n              <Route path=\"/workspace/employees\" component={Employees} />\n              <Route path=\"/workspace/roster\" component={Roster} />\n              <Route path=\"/workspace/leave\" component={Leave} />\n              <Route path=\"/workspace/leave-roster-monitoring\" component={LeaveRosterMonitoring} />\n              <Route path=\"/workspace/simper-monitoring\" component={SimperMonitoring} />\n              <Route path=\"/workspace/reports\" component={Reports} />\n              <Route path=\"/workspace/meetings\">\n                <PermissionGuard requiredPermissions={[Permission.VIEW_MEETING]}>\n                  <Meetings />\n                </PermissionGuard>\n              </Route>\n              <Route path=\"/workspace/meeting-scanner\">\n                <PermissionGuard requiredPermissions={[Permission.VIEW_MEETING, Permission.SCAN_QR]} requireAll={true}>\n                  <MeetingScanner />\n                </PermissionGuard>\n              </Route>\n              <Route path=\"/workspace/sidak\" component={SidakDashboard} />\n              <Route path=\"/workspace/sidak/fatigue/new\" component={SidakFatigueForm} />\n              <Route path=\"/workspace/sidak/roster/new\" component={SidakRosterForm} />\n              <Route path=\"/workspace/sidak/fatigue/history\" component={SidakFatigueHistory} />\n              <Route path=\"/workspace/sidak/roster/history\" component={SidakRosterHistory} />\n              <Route path=\"/workspace/evaluasi-driver\" component={EvaluasiDriver} />\n              <Route path=\"/workspace/announcements\">\n                <PermissionGuard requiredPermissions={[Permission.MANAGE_EMPLOYEES]}>\n                  <Announcements />\n                </PermissionGuard>\n              </Route>\n              <Route path=\"/workspace/news\">\n                <PermissionGuard requiredPermissions={[Permission.MANAGE_EMPLOYEES]}>\n                  <News />\n                </PermissionGuard>\n              </Route>\n              <Route path=\"/workspace/news-feed\" component={NewsFeed} />\n              <Route path=\"/workspace/documents\" component={Documents} />\n              <Route path=\"/workspace/documents/:category\" component={Documents} />\n              <Route path=\"/workspace/driver-view\" component={DriverView} />\n              <Route path=\"/workspace/mobile-driver\" component={MobileDriverView} />\n              <Route path=\"/workspace/employee-personal\" component={EmployeePersonalData} />\n              <Route component={Dashboard} />\n            </Switch>\n          </main>\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":9870,"size_tokens":null},"client/src/lib/authUtils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}","path":null,"size_bytes":115,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"server/cronJobs.ts":{"content":"import * as cron from 'node-cron';\nimport { storage } from './storage';\nimport { LeaveMonitoringService } from './leaveMonitoringService';\nimport { simperNotificationService } from './services/simperNotificationService';\nimport { emailService } from './services/emailService';\n\nexport function initializeCronJobs() {\n  const monitoringService = new LeaveMonitoringService(storage as any);\n\n  // Run every day at 9:00 AM to check for leave reminders\n  cron.schedule('0 9 * * *', async () => {\n    console.log('Running daily leave reminder check...');\n    try {\n      const result = await monitoringService.sendLeaveReminders();\n      console.log(`Leave reminders completed: ${result.sent} sent, ${result.failed} failed`);\n    } catch (error) {\n      console.error('Error in daily leave reminder job:', error);\n    }\n  }, {\n    timezone: \"Asia/Jakarta\"\n  });\n\n  // Optional: Run every Monday at 8:00 AM for weekly summary\n  cron.schedule('0 8 * * 1', async () => {\n    console.log('Running weekly leave monitoring summary...');\n    try {\n      const upcomingLeaves = await monitoringService.checkUpcomingLeaves();\n      console.log(`Weekly summary: ${upcomingLeaves.length} upcoming leave reminders to send`);\n    } catch (error) {\n      console.error('Error in weekly summary job:', error);\n    }\n  }, {\n    timezone: \"Asia/Jakarta\"\n  });\n\n  // Run every day at 7:00 AM WITA to check for SIMPER expired/expiring\n  cron.schedule('0 7 * * *', async () => {\n    console.log('ðŸ“§ Running daily SIMPER expiry notification check...');\n    try {\n      const result = await simperNotificationService.checkAndNotifySimperExpired();\n      if (result.sent) {\n        console.log(`âœ… SIMPER notification sent: ${result.count} employees with expired/expiring SIMPER`);\n      } else if (result.count === 0) {\n        console.log('âœ… No SIMPER expired or expiring soon');\n      } else {\n        console.log('âš ï¸ Failed to send SIMPER notification email');\n      }\n    } catch (error) {\n      console.error('âŒ Error in SIMPER notification job:', error);\n    }\n  }, {\n    timezone: \"Asia/Makassar\"\n  });\n\n  console.log('Cron jobs initialized for leave monitoring');\n  if (emailService.isConfigured()) {\n    console.log('ðŸ“§ SIMPER notification email service: ACTIVE (daily at 7:00 AM WITA)');\n  } else {\n    console.log('âš ï¸ SIMPER notification email service: INACTIVE (credentials not configured)');\n  }\n}","path":null,"size_bytes":2400,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/hooks/useAutoSave.ts":{"content":"import { useEffect, useRef, useState } from 'react';\nimport { UseFormReturn } from 'react-hook-form';\n\nexport interface AutoSaveOptions {\n  key: string;\n  form: UseFormReturn<any>;\n  delay?: number; // Auto save delay in milliseconds\n  exclude?: string[]; // Fields to exclude from auto save\n}\n\nexport function useAutoSave({ key, form, delay = 2000, exclude = [] }: AutoSaveOptions) {\n  const [saveStatus, setSaveStatus] = useState<'idle' | 'saving' | 'saved'>('idle');\n  const timeoutRef = useRef<NodeJS.Timeout>();\n  const isRestoringRef = useRef(false);\n\n  // Save draft to localStorage\n  const saveDraft = () => {\n    if (isRestoringRef.current) return;\n    \n    const values = form.getValues();\n    const filteredValues = Object.fromEntries(\n      Object.entries(values).filter(([fieldKey]) => !exclude.includes(fieldKey))\n    );\n    \n    localStorage.setItem(`draft_${key}`, JSON.stringify({\n      data: filteredValues,\n      timestamp: Date.now()\n    }));\n    \n    setSaveStatus('saved');\n    setTimeout(() => setSaveStatus('idle'), 1000);\n  };\n\n  // Load draft from localStorage\n  const loadDraft = () => {\n    try {\n      const saved = localStorage.getItem(`draft_${key}`);\n      if (!saved) return null;\n      \n      const { data, timestamp } = JSON.parse(saved);\n      \n      // Only restore if draft is less than 24 hours old\n      const maxAge = 24 * 60 * 60 * 1000; // 24 hours\n      if (Date.now() - timestamp > maxAge) {\n        clearDraft();\n        return null;\n      }\n      \n      return data;\n    } catch (error) {\n      console.error('Error loading draft:', error);\n      return null;\n    }\n  };\n\n  // Clear draft from localStorage\n  const clearDraft = () => {\n    localStorage.removeItem(`draft_${key}`);\n    setSaveStatus('idle');\n  };\n\n  // Restore draft on component mount\n  useEffect(() => {\n    const draft = loadDraft();\n    if (draft) {\n      isRestoringRef.current = true;\n      form.reset(draft);\n      setTimeout(() => {\n        isRestoringRef.current = false;\n      }, 100);\n    }\n  }, []);\n\n  // Auto save on form changes\n  useEffect(() => {\n    const subscription = form.watch(() => {\n      if (isRestoringRef.current) return;\n      \n      setSaveStatus('saving');\n      \n      // Clear previous timeout\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n      }\n      \n      // Set new timeout for auto save\n      timeoutRef.current = setTimeout(saveDraft, delay);\n    });\n\n    return () => {\n      subscription.unsubscribe();\n      if (timeoutRef.current) {\n        clearTimeout(timeoutRef.current);\n      }\n    };\n  }, [delay]);\n\n  // Check if draft exists\n  const hasDraft = () => {\n    const saved = localStorage.getItem(`draft_${key}`);\n    return !!saved;\n  };\n\n  return {\n    saveStatus,\n    saveDraft,\n    loadDraft,\n    clearDraft,\n    hasDraft\n  };\n}","path":null,"size_bytes":2820,"size_tokens":null},"client/src/lib/qr-utils.ts":{"content":"import QRCode from 'qrcode';\n\nexport async function generateQRCodeCanvas(\n  data: string,\n  canvas: HTMLCanvasElement,\n  options?: any\n): Promise<void> {\n  const defaultOptions = {\n    width: 256,\n    margin: 2,\n    color: {\n      dark: '#000000',\n      light: '#FFFFFF'\n    },\n    ...options\n  };\n\n  try {\n    await QRCode.toCanvas(canvas, data, defaultOptions);\n    console.log('QR Code generated successfully');\n  } catch (error) {\n    console.error('Error generating QR code:', error);\n    throw error;\n  }\n}\n\nexport async function generateQRCodeDataURL(\n  data: string,\n  options?: any\n): Promise<string> {\n  const defaultOptions = {\n    width: 256,\n    margin: 2,\n    color: {\n      dark: '#000000',\n      light: '#FFFFFF'\n    },\n    ...options\n  };\n\n  return await QRCode.toDataURL(data, defaultOptions);\n}\n\nexport function downloadQRCode(canvas: HTMLCanvasElement, filename: string): void {\n  const link = document.createElement('a');\n  link.download = filename;\n  link.href = canvas.toDataURL();\n  link.click();\n}\n\nexport function printQRCode(canvas: HTMLCanvasElement, employeeData: { id: string; name: string }): void {\n  const dataUrl = canvas.toDataURL();\n  const printWindow = window.open('', '_blank');\n  \n  if (printWindow) {\n    printWindow.document.write(`\n      <html>\n        <head>\n          <title>Print QR Code</title>\n          <style>\n            body { text-align: center; padding: 20px; font-family: Arial, sans-serif; }\n            img { max-width: 300px; border: 1px solid #ccc; }\n            .info { margin: 20px 0; }\n          </style>\n        </head>\n        <body>\n          <h2>QR Code Absensi</h2>\n          <div class=\"info\">\n            <p><strong>ID:</strong> ${employeeData.id}</p>\n            <p><strong>Nama:</strong> ${employeeData.name}</p>\n          </div>\n          <img src=\"${dataUrl}\" alt=\"QR Code\">\n        </body>\n      </html>\n    `);\n    printWindow.document.close();\n    printWindow.print();\n  }\n}\n","path":null,"size_bytes":1951,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":971,"size_tokens":null},"client/src/components/ui/stats-card.tsx":{"content":"import { cn } from \"@/lib/utils\";\n\ninterface StatsCardProps {\n  title: string;\n  value: string | number;\n  icon: React.ReactNode;\n  iconColor: string;\n  className?: string;\n}\n\nexport function StatsCard({ title, value, icon, iconColor, className }: StatsCardProps) {\n  return (\n    <div className={cn(\"stats-card\", className)} data-testid={`stats-card-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n      <div className=\"flex items-center\">\n        <div className={cn(\"stats-icon\", iconColor)}>\n          {icon}\n        </div>\n        <div className=\"ml-4\">\n          <p className=\"text-sm font-medium text-gray-600 dark:text-gray-400\">{title}</p>\n          <p className=\"text-2xl font-semibold text-gray-900 dark:text-white\" data-testid={`stats-value-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n            {value}\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":879,"size_tokens":null},"client/src/components/ObjectUploader.tsx":{"content":"import { useState } from \"react\";\nimport type { ReactNode } from \"react\";\nimport Uppy from \"@uppy/core\";\nimport { DashboardModal } from \"@uppy/react\";\nimport \"@uppy/core/dist/style.min.css\";\nimport \"@uppy/dashboard/dist/style.min.css\";\nimport AwsS3 from \"@uppy/aws-s3\";\nimport type { UploadResult } from \"@uppy/core\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface ObjectUploaderProps {\n  maxNumberOfFiles?: number;\n  maxFileSize?: number;\n  onGetUploadParameters: () => Promise<{\n    method: \"PUT\";\n    url: string;\n  }>;\n  onComplete?: (\n    result: UploadResult<Record<string, unknown>, Record<string, unknown>>\n  ) => void;\n  buttonClassName?: string;\n  children: ReactNode;\n}\n\n/**\n * A file upload component that renders as a button and provides a modal interface for\n * file management.\n * \n * Features:\n * - Renders as a customizable button that opens a file upload modal\n * - Provides a modal interface for:\n *   - File selection\n *   - File preview\n *   - Upload progress tracking\n *   - Upload status display\n * \n * The component uses Uppy under the hood to handle all file upload functionality.\n * All file management features are automatically handled by the Uppy dashboard modal.\n * \n * @param props - Component props\n * @param props.maxNumberOfFiles - Maximum number of files allowed to be uploaded\n *   (default: 1)\n * @param props.maxFileSize - Maximum file size in bytes (default: 10MB)\n * @param props.onGetUploadParameters - Function to get upload parameters (method and URL).\n *   Typically used to fetch a presigned URL from the backend server for direct-to-S3\n *   uploads.\n * @param props.onComplete - Callback function called when upload is complete. Typically\n *   used to make post-upload API calls to update server state and set object ACL\n *   policies.\n * @param props.buttonClassName - Optional CSS class name for the button\n * @param props.children - Content to be rendered inside the button\n */\nexport function ObjectUploader({\n  maxNumberOfFiles = 1,\n  maxFileSize = 10485760, // 10MB default\n  onGetUploadParameters,\n  onComplete,\n  buttonClassName,\n  children,\n}: ObjectUploaderProps) {\n  const [showModal, setShowModal] = useState(false);\n  const [uppy] = useState(() =>\n    new Uppy({\n      restrictions: {\n        maxNumberOfFiles,\n        maxFileSize,\n      },\n      autoProceed: false,\n    })\n      .use(AwsS3, {\n        shouldUseMultipart: false,\n        getUploadParameters: onGetUploadParameters,\n      })\n      .on(\"complete\", (result) => {\n        onComplete?.(result);\n      })\n  );\n\n  return (\n    <div>\n      <Button onClick={() => setShowModal(true)} className={buttonClassName}>\n        {children}\n      </Button>\n\n      <DashboardModal\n        uppy={uppy}\n        open={showModal}\n        onRequestClose={() => setShowModal(false)}\n        proudlyDisplayPoweredByUppy={false}\n      />\n    </div>\n  );\n}","path":null,"size_bytes":2866,"size_tokens":null},"client/src/pages/employee-personal-data.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Calendar, User, Clock, Heart, ArrowLeft, TrendingUp, AlertCircle } from \"lucide-react\";\nimport { format, addDays } from \"date-fns\";\nimport { id as localeId } from \"date-fns/locale\";\nimport type { Employee, RosterSchedule, LeaveRequest, LeaveRosterMonitoring } from \"@shared/schema\";\n\ninterface EmployeePersonalDataProps {\n  employeeId: string;\n}\n\nexport default function EmployeePersonalData() {\n  const [employeeId, setEmployeeId] = useState<string>(\"\");\n\n  useEffect(() => {\n    // Get employee ID from URL params\n    const urlParams = new URLSearchParams(window.location.search);\n    const id = urlParams.get('employeeId');\n    if (id) {\n      setEmployeeId(id);\n    }\n  }, []);\n\n  const { data: allEmployees, isLoading: employeeLoading } = useQuery({\n    queryKey: [\"/api/employees\"],\n    enabled: !!employeeId,\n  });\n\n  const { data: rosterData, isLoading: rosterLoading } = useQuery({\n    queryKey: [\"/api/roster\", employeeId],\n    queryFn: () => fetch(`/api/roster?employeeId=${employeeId}`).then(res => res.json()),\n    enabled: !!employeeId,\n  });\n\n  const { data: leaveData, isLoading: leaveLoading } = useQuery({\n    queryKey: [\"/api/leave\"],\n    enabled: !!employeeId,\n  });\n\n  const { data: leaveMonitoringData, isLoading: monitoringLoading } = useQuery({\n    queryKey: [\"/api/leave-roster-monitoring\"],\n    enabled: !!employeeId,\n  });\n\n  const employee = Array.isArray(allEmployees) ? allEmployees.find((emp: Employee) => emp.id === employeeId) : undefined;\n\n  if (!employeeId) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center\">\n              <p className=\"text-gray-500\">Loading employee data...</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (employeeLoading) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600 mx-auto mb-4\"></div>\n              <p className=\"text-gray-500\">Memuat data karyawan...</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (!employee) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center\">\n              <p className=\"text-red-500\">Data karyawan tidak ditemukan</p>\n              <Button \n                onClick={() => window.location.href = '/'}\n                className=\"mt-4\"\n                variant=\"outline\"\n              >\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                Kembali\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // Filter roster data for this employee\n  const employeeRoster = Array.isArray(rosterData) ? rosterData.filter((roster: RosterSchedule) => \n    roster.employeeId === employeeId\n  ) : [];\n\n  // Filter leave data for this employee\n  const employeeLeave = Array.isArray(leaveData) ? leaveData.filter((leave: LeaveRequest) => \n    leave.employeeId === employeeId\n  ) : [];\n\n  // Filter monitoring data for this employee\n  const employeeMonitoring = Array.isArray(leaveMonitoringData) ? leaveMonitoringData.find((monitoring: LeaveRosterMonitoring) => \n    monitoring.nik === employeeId\n  ) : undefined;\n\n  // Calculate working days from roster - count the number of roster entries\n  const calculateWorkingDays = () => {\n    return employeeRoster.length;\n  };\n\n  const totalWorkingDays = calculateWorkingDays();\n\n  // Get status color for monitoring status\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"Aktif\": return \"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400\";\n      case \"Menunggu Cuti\": return \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400\";\n      case \"Sedang Cuti\": return \"bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400\";\n      case \"Selesai Cuti\": return \"bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400\";\n      default: return \"bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400\";\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 p-3 md:p-6\">\n      <div className=\"max-w-md mx-auto md:max-w-4xl space-y-4 md:space-y-6\">\n        {/* Mobile Header with Employee Info */}\n        <Card className=\"border-0 shadow-lg bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm\">\n          <CardHeader className=\"pb-4\">\n            <div className=\"flex items-start justify-between\">\n              <div className=\"flex items-center space-x-3 md:space-x-4\">\n                <div className=\"bg-gradient-to-r from-red-500 to-pink-500 p-3 rounded-full shadow-lg\">\n                  <User className=\"w-6 h-6 md:w-8 md:h-8 text-white\" />\n                </div>\n                <div>\n                  <CardTitle className=\"text-lg md:text-xl font-bold text-gray-900 dark:text-white\">{employee.name}</CardTitle>\n                  <p className=\"text-sm text-gray-600 dark:text-gray-400\">NIK: {employee.id}</p>\n                  <div className=\"flex flex-wrap gap-1 md:gap-2 mt-2\">\n                    <Badge variant=\"outline\" className=\"text-xs\">{employee.position}</Badge>\n                    <Badge variant=\"outline\" className=\"text-xs\">{employee.department}</Badge>\n                  </div>\n                </div>\n              </div>\n              <Button \n                onClick={() => window.location.href = '/'}\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"shrink-0\"\n              >\n                <ArrowLeft className=\"w-4 h-4\" />\n                <span className=\"hidden md:inline ml-2\">Kembali</span>\n              </Button>\n            </div>\n          </CardHeader>\n        </Card>\n\n        {/* Stats Cards */}\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4\">\n          <Card className=\"border-0 shadow-md bg-gradient-to-r from-blue-500 to-blue-600 text-white\">\n            <CardContent className=\"p-4 md:pt-6\">\n              <div className=\"flex items-center space-x-2\">\n                <Calendar className=\"w-4 h-4 md:w-5 md:h-5\" />\n                <div>\n                  <p className=\"text-xs md:text-sm opacity-90\">Total Hari Kerja</p>\n                  <p className=\"text-lg md:text-2xl font-bold\">{totalWorkingDays}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card className=\"border-0 shadow-md bg-gradient-to-r from-green-500 to-green-600 text-white\">\n            <CardContent className=\"p-4 md:pt-6\">\n              <div className=\"flex items-center space-x-2\">\n                <Clock className=\"w-4 h-4 md:w-5 md:h-5\" />\n                <div>\n                  <p className=\"text-xs md:text-sm opacity-90\">Jadwal Roster</p>\n                  <p className=\"text-lg md:text-2xl font-bold\">{employeeRoster.length}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card className=\"border-0 shadow-md bg-gradient-to-r from-red-500 to-red-600 text-white\">\n            <CardContent className=\"p-4 md:pt-6\">\n              <div className=\"flex items-center space-x-2\">\n                <Heart className=\"w-4 h-4 md:w-5 md:h-5\" />\n                <div>\n                  <p className=\"text-xs md:text-sm opacity-90\">Pengajuan Cuti</p>\n                  <p className=\"text-lg md:text-2xl font-bold\">{employeeLeave.length}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Monitoring Cuti Card */}\n          <Card className=\"border-0 shadow-md bg-gradient-to-r from-purple-500 to-purple-600 text-white\">\n            <CardContent className=\"p-4 md:pt-6\">\n              <div className=\"flex items-center space-x-2\">\n                <TrendingUp className=\"w-4 h-4 md:w-5 md:h-5\" />\n                <div>\n                  <p className=\"text-xs md:text-sm opacity-90\">Monitoring Hari</p>\n                  <p className=\"text-lg md:text-2xl font-bold\">\n                    {employeeMonitoring?.monitoringDays || 0}\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Monitoring Cuti Detail Card */}\n        {employeeMonitoring && (\n          <Card className=\"border-0 shadow-lg bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm\">\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-lg flex items-center space-x-2\">\n                <AlertCircle className=\"w-5 h-5 text-purple-600\" />\n                <span>Monitoring Cuti</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div className=\"bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg\">\n                  <p className=\"text-xs text-gray-600 dark:text-gray-400 mb-1\">Cuti Terakhir</p>\n                  <p className=\"font-semibold text-sm\">\n                    {employeeMonitoring.lastLeaveDate \n                      ? format(new Date(employeeMonitoring.lastLeaveDate), \"dd MMM yyyy\", { locale: localeId })\n                      : \"Belum Ada\"}\n                  </p>\n                </div>\n                \n                <div className=\"bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg\">\n                  <p className=\"text-xs text-gray-600 dark:text-gray-400 mb-1\">Cuti Berikutnya</p>\n                  <p className=\"font-semibold text-sm\">\n                    {employeeMonitoring.nextLeaveDate \n                      ? format(new Date(employeeMonitoring.nextLeaveDate), \"dd MMM yyyy\", { locale: localeId })\n                      : \"Belum Terjadwal\"}\n                  </p>\n                </div>\n                \n                <div className=\"bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg\">\n                  <p className=\"text-xs text-gray-600 dark:text-gray-400 mb-1\">Status</p>\n                  <Badge className={`text-xs ${getStatusColor(employeeMonitoring.status)}`}>\n                    {employeeMonitoring.status}\n                  </Badge>\n                </div>\n              </div>\n              \n              <div className=\"bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg\">\n                <p className=\"text-xs text-blue-800 dark:text-blue-300 mb-1\">\n                  Opsi Cuti: {employeeMonitoring.leaveOption} hari kerja\n                </p>\n                <div className=\"w-full bg-blue-200 dark:bg-blue-800 rounded-full h-2\">\n                  <div \n                    className=\"bg-blue-600 h-2 rounded-full transition-all duration-300\"\n                    style={{ \n                      width: `${Math.min((employeeMonitoring.monitoringDays / parseInt(employeeMonitoring.leaveOption)) * 100, 100)}%` \n                    }}\n                  />\n                </div>\n                <p className=\"text-xs text-blue-700 dark:text-blue-300 mt-1\">\n                  {employeeMonitoring.monitoringDays} / {employeeMonitoring.leaveOption} hari\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Detailed Data Tabs */}\n        <Card className=\"border-0 shadow-lg bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm\">\n          <CardHeader>\n            <CardTitle className=\"text-lg font-bold\">Detail Data Pribadi</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Tabs defaultValue=\"roster\" className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-2 h-12 bg-gray-100 dark:bg-gray-700\">\n                <TabsTrigger value=\"roster\" className=\"data-[state=active]:bg-red-500 data-[state=active]:text-white\">\n                  Data Roster\n                </TabsTrigger>\n                <TabsTrigger value=\"leave\" className=\"data-[state=active]:bg-red-500 data-[state=active]:text-white\">\n                  Data Cuti\n                </TabsTrigger>\n              </TabsList>\n              \n              <TabsContent value=\"roster\" className=\"mt-6\">\n                {rosterLoading ? (\n                  <div className=\"text-center py-8\">\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600 mx-auto mb-4\"></div>\n                    <p className=\"text-gray-500\">Memuat data roster...</p>\n                  </div>\n                ) : employeeRoster.length === 0 ? (\n                  <div className=\"text-center py-12\">\n                    <Calendar className=\"w-12 h-12 text-gray-400 mx-auto mb-4\" />\n                    <p className=\"text-gray-500 text-lg\">Belum ada jadwal roster</p>\n                    <p className=\"text-gray-400 text-sm\">Data roster akan muncul setelah dijadwalkan</p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {employeeRoster.map((roster: RosterSchedule) => (\n                      <Card key={roster.id} className=\"border-0 shadow-md hover:shadow-lg transition-shadow duration-200 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20\">\n                        <CardContent className=\"p-4\">\n                          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0\">\n                            <div>\n                              <p className=\"font-semibold text-gray-900 dark:text-white\">\n                                {format(new Date(roster.date), \"dd MMMM yyyy\", { locale: localeId })}\n                              </p>\n                              <div className=\"flex items-center space-x-3 text-sm text-gray-600 dark:text-gray-400 mt-1\">\n                                <span className=\"bg-white dark:bg-gray-700 px-2 py-1 rounded-full text-xs\">\n                                  {roster.shift}\n                                </span>\n                                <span className=\"bg-white dark:bg-gray-700 px-2 py-1 rounded-full text-xs\">\n                                  {roster.status}\n                                </span>\n                              </div>\n                            </div>\n                            <Badge \n                              variant={roster.shift === 'Shift 1' ? 'default' : 'secondary'}\n                              className=\"shrink-0\"\n                            >\n                              {roster.shift}\n                            </Badge>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                )}\n              </TabsContent>\n              \n              <TabsContent value=\"leave\" className=\"mt-6\">\n                {leaveLoading ? (\n                  <div className=\"text-center py-8\">\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-red-600 mx-auto mb-4\"></div>\n                    <p className=\"text-gray-500\">Memuat data cuti...</p>\n                  </div>\n                ) : employeeLeave.length === 0 ? (\n                  <div className=\"text-center py-12\">\n                    <Heart className=\"w-12 h-12 text-gray-400 mx-auto mb-4\" />\n                    <p className=\"text-gray-500 text-lg\">Belum ada pengajuan cuti</p>\n                    <p className=\"text-gray-400 text-sm\">Riwayat cuti akan muncul setelah mengajukan</p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {employeeLeave.map((leave: LeaveRequest) => (\n                      <Card key={leave.id} className=\"border-0 shadow-md hover:shadow-lg transition-shadow duration-200 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20\">\n                        <CardContent className=\"p-4\">\n                          <div className=\"space-y-3\">\n                            <div className=\"flex items-center justify-between\">\n                              <p className=\"font-semibold text-gray-900 dark:text-white\">{leave.leaveType}</p>\n                              <Badge \n                                variant={\n                                  leave.status === 'approved' ? 'default' :\n                                  leave.status === 'rejected' ? 'destructive' : 'secondary'\n                                }\n                                className=\"shrink-0\"\n                              >\n                                {leave.status === 'approved' ? 'Disetujui' :\n                                 leave.status === 'rejected' ? 'Ditolak' : 'Pending'}\n                              </Badge>\n                            </div>\n                            <div className=\"bg-white dark:bg-gray-700 p-3 rounded-lg\">\n                              <p className=\"text-sm text-gray-600 dark:text-gray-400 mb-1\">\n                                ðŸ“… {format(new Date(leave.startDate), \"dd MMM yyyy\", { locale: localeId })} - {format(new Date(leave.endDate), \"dd MMM yyyy\", { locale: localeId })}\n                              </p>\n                              {leave.reason && (\n                                <p className=\"text-sm text-gray-700 dark:text-gray-300\">\n                                  ðŸ’­ {leave.reason}\n                                </p>\n                              )}\n                            </div>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                )}\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n\n        {/* Developer Info Footer */}\n        <Card className=\"border-0 shadow-lg bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20\">\n          <CardContent className=\"p-4 text-center\">\n            <div className=\"space-y-2\">\n              <p className=\"text-xs font-medium text-gray-700 dark:text-gray-300\">\n                ðŸ’» Sistem Dibuat Oleh\n              </p>\n              <p className=\"text-sm font-bold text-blue-700 dark:text-blue-400\">\n                Bagus Andyka Firmansyah\n              </p>\n              <p className=\"text-xs text-gray-600 dark:text-gray-400\">\n                HSE Data Evaluator GECL\n              </p>\n              <div className=\"w-16 h-0.5 bg-blue-500 mx-auto rounded-full\"></div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":19316,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/pages/simper-monitoring.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertSimperMonitoringSchema } from \"@shared/schema\";\nimport type { SimperMonitoring, InsertSimperMonitoring } from \"@shared/schema\";\nimport { Plus, Search, Edit, Trash2, Upload, AlertCircle, Download, Eye, Calendar, Clock, Users } from \"lucide-react\";\nimport { z } from \"zod\";\nimport * as XLSX from \"xlsx\";\nimport { Bar } from \"react-chartjs-2\";\nimport {\n  Chart as ChartJS,\n  CategoryScale,\n  LinearScale,\n  BarElement,\n  Title,\n  Tooltip,\n  Legend,\n  Filler,\n} from \"chart.js\";\n\nChartJS.register(\n  CategoryScale,\n  LinearScale,\n  BarElement,\n  Title,\n  Tooltip,\n  Legend,\n  Filler\n);\n\nconst formSchema = insertSimperMonitoringSchema.extend({\n  id: z.string().optional(),\n});\n\ninterface SimperAnalytics {\n  totalKaryawan: number;\n  bibStats: {\n    segera: number;\n    mendekati: number;\n    menuju: number;\n    aktif: number;\n  };\n  tiaStats: {\n    segera: number;\n    mendekati: number;\n    menuju: number;\n    aktif: number;\n  };\n  criticalList: any[];\n  processedData: any[];\n}\n\nexport default function SimperMonitoring() {\n  const [currentTime, setCurrentTime] = useState(new Date());\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n  const [isUploadDialogOpen, setIsUploadDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [selectedSimper, setSelectedSimper] = useState<SimperMonitoring | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const { toast } = useToast();\n\n  // Real-time clock update\n  useEffect(() => {\n    const timer = setInterval(() => {\n      setCurrentTime(new Date());\n    }, 1000);\n    return () => clearInterval(timer);\n  }, []);\n\n  // Fetch SIMPER data\n  const { data: simperData = [], isLoading } = useQuery({\n    queryKey: [\"/api/simper-monitoring\"],\n    refetchInterval: 30000,\n  });\n\n  // Fetch analytics data\n  const { data: analytics } = useQuery<SimperAnalytics>({\n    queryKey: [\"/api/simper-monitoring/analytics\"],\n    refetchInterval: 30000,\n  });\n\n  // Form for create/edit SIMPER\n  const form = useForm<z.infer<typeof formSchema>>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      employeeName: \"\",\n      nik: \"\",\n      simperBibExpiredDate: \"\",\n      simperTiaExpiredDate: \"\",\n    },\n  });\n\n  // Create/Update SIMPER mutation\n  const createMutation = useMutation({\n    mutationFn: async (data: InsertSimperMonitoring) => {\n      const response = await fetch(\"/api/simper-monitoring\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to create SIMPER\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/simper-monitoring\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/simper-monitoring/analytics\"] });\n      setIsEditDialogOpen(false);\n      form.reset();\n      toast({\n        title: \"Berhasil\",\n        description: \"Data SIMPER berhasil disimpan\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Gagal menyimpan data SIMPER\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertSimperMonitoring> }) => {\n      const response = await fetch(`/api/simper-monitoring/${id}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to update SIMPER\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/simper-monitoring\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/simper-monitoring/analytics\"] });\n      setIsEditDialogOpen(false);\n      setSelectedSimper(null);\n      form.reset();\n      toast({\n        title: \"Berhasil\",\n        description: \"Data SIMPER berhasil diperbarui\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Gagal memperbarui data SIMPER\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete SIMPER mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/simper-monitoring/${id}`, {\n        method: \"DELETE\",\n      });\n      if (!response.ok) throw new Error(\"Failed to delete SIMPER\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/simper-monitoring\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/simper-monitoring/analytics\"] });\n      toast({\n        title: \"Berhasil\",\n        description: \"Data SIMPER berhasil dihapus\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Gagal menghapus data SIMPER\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete all SIMPER mutation\n  const deleteAllMutation = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(\"/api/simper-monitoring\", {\n        method: \"DELETE\",\n      });\n      if (!response.ok) throw new Error(\"Failed to delete all SIMPER\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/simper-monitoring\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/simper-monitoring/analytics\"] });\n      toast({\n        title: \"Berhasil\",\n        description: \"Semua data SIMPER berhasil dihapus\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\", \n        description: error.message || \"Gagal menghapus semua data SIMPER\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Excel upload mutation\n  const uploadMutation = useMutation({\n    mutationFn: (file: File) => {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      return fetch(\"/api/simper-monitoring/upload-excel\", {\n        method: \"POST\",\n        body: formData,\n      }).then(res => res.json());\n    },\n    onSuccess: (result) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/simper-monitoring\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/simper-monitoring/analytics\"] });\n      setIsUploadDialogOpen(false);\n      toast({\n        title: \"Upload Berhasil\",\n        description: `${result.success} data berhasil diproses. ${result.errors?.length || 0} error.`,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error Upload\",\n        description: error.message || \"Gagal mengupload file Excel\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Format date to dd-mm-yyyy\n  const formatDateToDDMMYYYY = (dateString: string | null | undefined) => {\n    if (!dateString || dateString === null || dateString === undefined || dateString === '' || dateString === 'N/A') {\n      return \"-\";\n    }\n    \n    try {\n      const date = new Date(dateString);\n      // Check if date is valid\n      if (isNaN(date.getTime())) {\n        return \"-\";\n      }\n      \n      const day = String(date.getDate()).padStart(2, '0');\n      const month = String(date.getMonth() + 1).padStart(2, '0');\n      const year = date.getFullYear();\n      return `${day}-${month}-${year}`;\n    } catch {\n      return \"-\";\n    }\n  };\n\n  // Get monitoring days and status\n  const getMonitoringStatus = (expiredDate: string | null | undefined) => {\n    if (!expiredDate || expiredDate === null || expiredDate === undefined || expiredDate === '' || expiredDate === 'N/A') {\n      return { days: null, status: \"Tidak Ada Data\", variant: \"outline\" as const, customStyle: \"\" };\n    }\n    \n    const date = new Date(expiredDate);\n    // Check if date is valid\n    if (isNaN(date.getTime())) {\n      return { days: null, status: \"Tidak Ada Data\", variant: \"outline\" as const, customStyle: \"\" };\n    }\n    \n    const expired = date;\n    const today = new Date();\n    const diffTime = expired.getTime() - today.getTime();\n    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n    \n    if (diffDays < 0) return { days: diffDays, status: \"Segera Perpanjang\", variant: \"destructive\" as const, customStyle: \"bg-red-600 text-white hover:bg-red-700\" };\n    if (diffDays < 7) return { days: diffDays, status: \"Mendekati Perpanjangan\", variant: \"secondary\" as const, customStyle: \"bg-yellow-400 text-black hover:bg-yellow-500\" };\n    if (diffDays < 30) return { days: diffDays, status: \"Menuju Perpanjangan\", variant: \"secondary\" as const, customStyle: \"bg-orange-500 text-white hover:bg-orange-600\" };\n    return { days: diffDays, status: \"Aktif\", variant: \"secondary\" as const, customStyle: \"bg-green-500 text-white hover:bg-green-600\" };\n  };\n\n  // Filter data based on search and status filter\n  const filteredData = (simperData as SimperMonitoring[]).filter((item: SimperMonitoring) => {\n    const matchesSearch = \n      item.employeeName.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      item.nik.toLowerCase().includes(searchTerm.toLowerCase());\n    \n    if (!matchesSearch) return false;\n    \n    if (statusFilter === \"all\") return true;\n    \n    const bibStatus = getMonitoringStatus(item.simperBibExpiredDate);\n    const tiaStatus = getMonitoringStatus(item.simperTiaExpiredDate);\n    \n    if (statusFilter === \"bib\") return bibStatus.status !== \"Tidak Ada Data\";\n    if (statusFilter === \"tia\") return tiaStatus.status !== \"Tidak Ada Data\";\n    \n    return true;\n  });\n\n  const handleSubmit = (data: z.infer<typeof formSchema>) => {\n    if (selectedSimper) {\n      updateMutation.mutate({ id: selectedSimper.id, data });\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const handleEdit = (simper: SimperMonitoring) => {\n    setSelectedSimper(simper);\n    form.reset({\n      employeeName: simper.employeeName,\n      nik: simper.nik,\n      simperBibExpiredDate: simper.simperBibExpiredDate || \"\",\n      simperTiaExpiredDate: simper.simperTiaExpiredDate || \"\",\n    });\n    setIsEditDialogOpen(true);\n  };\n\n  const handleDelete = (id: string) => {\n    if (confirm(\"Apakah Anda yakin ingin menghapus data SIMPER ini?\")) {\n      deleteMutation.mutate(id);\n    }\n  };\n\n  const handleDeleteAll = () => {\n    if (confirm(\"Apakah Anda yakin ingin menghapus SEMUA data SIMPER? Tindakan ini tidak dapat dibatalkan!\")) {\n      deleteAllMutation.mutate();\n    }\n  };\n\n  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file) {\n      uploadMutation.mutate(file);\n    }\n  };\n\n  const downloadTemplate = () => {\n    const templateData = [\n      {\n        \"Nama Karyawan\": \"Contoh Nama\",\n        \"NIK\": \"C-000000\",\n        \"Tanggal SIMPER BIB Mati\": \"2024-12-31\",\n        \"Tanggal SIMPER TIA Mati\": \"2024-12-31\"\n      }\n    ];\n    \n    const ws = XLSX.utils.json_to_sheet(templateData);\n    const wb = XLSX.utils.book_new();\n    XLSX.utils.book_append_sheet(wb, ws, \"Template SIMPER\");\n    XLSX.writeFile(wb, \"Template_SIMPER_Monitoring.xlsx\");\n  };\n\n  // Chart data for analytics\n  const chartData = analytics ? {\n    labels: ['Segera Perpanjang', 'Mendekati Perpanjangan', 'Menuju Perpanjangan', 'Aktif'],\n    datasets: [\n      {\n        label: 'SIMPER BIB',\n        data: [analytics.bibStats.segera, analytics.bibStats.mendekati, analytics.bibStats.menuju, analytics.bibStats.aktif],\n        backgroundColor: '#E53935',\n        borderColor: '#C62828',\n        borderWidth: 1,\n      },\n      {\n        label: 'SIMPER TIA',\n        data: [analytics.tiaStats.segera, analytics.tiaStats.mendekati, analytics.tiaStats.menuju, analytics.tiaStats.aktif],\n        backgroundColor: '#1E88E5',\n        borderColor: '#1565C0',\n        borderWidth: 1,\n      }\n    ]\n  } : null;\n\n  const chartOptions = {\n    responsive: true,\n    plugins: {\n      legend: {\n        position: 'top' as const,\n      },\n      title: {\n        display: true,\n        text: 'Status SIMPER BIB vs TIA'\n      },\n    },\n    scales: {\n      y: {\n        beginAtZero: true,\n      },\n    },\n  };\n\n  return (\n    <div className=\"space-y-4 sm:space-y-6 p-3 sm:p-6\">\n      {/* Header */}\n      <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3\">\n        <h1 className=\"text-2xl sm:text-4xl font-bold text-[#E53935]\">\n          Monitoring SIMPER Karyawan\n        </h1>\n        <div className=\"text-left sm:text-right\">\n          <p className=\"text-sm sm:text-lg font-semibold text-gray-900 dark:text-white\">\n            {currentTime.toLocaleDateString('id-ID', {\n              weekday: 'long',\n              year: 'numeric',\n              month: 'long',\n              day: 'numeric'\n            })}\n          </p>\n          <p className=\"text-xs sm:text-sm text-gray-500 dark:text-gray-400\">\n            {currentTime.toLocaleTimeString('id-ID')}\n          </p>\n        </div>\n      </div>\n\n      {/* Dashboard Statistics */}\n      {analytics && (\n        <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-6\">\n          {/* Total Karyawan */}\n          <Card className=\"rounded-2xl shadow-lg hover:shadow-xl transition-shadow\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium text-gray-600\">Total Karyawan</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex items-center\">\n                <Users className=\"h-8 w-8 text-gray-600 mr-2\" />\n                <span className=\"text-2xl font-bold\">{analytics.totalKaryawan}</span>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* BIB Statistics */}\n          <Card className=\"rounded-2xl shadow-lg hover:shadow-xl transition-shadow bg-gradient-to-br from-red-50 to-red-100\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium text-red-700\">SIMPER BIB</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-xs text-red-600\">Segera Perpanjang:</span>\n                <Badge className=\"text-xs bg-red-600 text-white hover:bg-red-700\">{analytics.bibStats.segera}</Badge>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-xs text-red-600\">Mendekati:</span>\n                <Badge className=\"text-xs bg-yellow-400 text-black hover:bg-yellow-500\">{analytics.bibStats.mendekati}</Badge>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-xs text-red-600\">Menuju:</span>\n                <Badge className=\"text-xs bg-orange-500 text-white hover:bg-orange-600\">{analytics.bibStats.menuju}</Badge>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-xs text-red-600\">Aktif:</span>\n                <Badge className=\"text-xs bg-green-500 text-white hover:bg-green-600\">{analytics.bibStats.aktif}</Badge>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* TIA Statistics */}\n          <Card className=\"rounded-2xl shadow-lg hover:shadow-xl transition-shadow bg-gradient-to-br from-blue-50 to-blue-100\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium text-blue-700\">SIMPER TIA</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              <div className=\"flex justify-between\">\n                <span className=\"text-xs text-blue-600\">Segera Perpanjang:</span>\n                <Badge className=\"text-xs bg-red-600 text-white hover:bg-red-700\">{analytics.tiaStats.segera}</Badge>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-xs text-blue-600\">Mendekati:</span>\n                <Badge className=\"text-xs bg-yellow-400 text-black hover:bg-yellow-500\">{analytics.tiaStats.mendekati}</Badge>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-xs text-blue-600\">Menuju:</span>\n                <Badge className=\"text-xs bg-orange-500 text-white hover:bg-orange-600\">{analytics.tiaStats.menuju}</Badge>\n              </div>\n              <div className=\"flex justify-between\">\n                <span className=\"text-xs text-blue-600\">Aktif:</span>\n                <Badge className=\"text-xs bg-green-500 text-white hover:bg-green-600\">{analytics.tiaStats.aktif}</Badge>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Critical List Card */}\n          <Card className=\"rounded-2xl shadow-lg hover:shadow-xl transition-shadow bg-gradient-to-br from-yellow-50 to-yellow-100\">\n            <CardHeader className=\"pb-2\">\n              <CardTitle className=\"text-sm font-medium text-yellow-700\">Daftar Kritis</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-1\">\n                {analytics.criticalList.slice(0, 3).map((item, index) => (\n                  <div key={index} className=\"text-xs\">\n                    <span className=\"font-semibold\">{item.employeeName}</span>\n                    <div className=\"text-gray-600\">{item.nik}</div>\n                  </div>\n                ))}\n                {analytics.criticalList.length > 3 && (\n                  <div className=\"text-xs text-gray-500\">\n                    +{analytics.criticalList.length - 3} lainnya\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Chart */}\n      {chartData && (\n        <Card className=\"rounded-2xl shadow-lg\">\n          <CardHeader>\n            <CardTitle>Grafik Status SIMPER</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"h-96\">\n              <Bar data={chartData} options={chartOptions} />\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Control Panel */}\n      <Card className=\"rounded-2xl shadow-lg\">\n        <CardHeader>\n          <CardTitle>Kelola Data SIMPER</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* Action Buttons */}\n          <div className=\"flex flex-wrap gap-4\">\n            <Dialog open={isUploadDialogOpen} onOpenChange={setIsUploadDialogOpen}>\n              <DialogTrigger asChild>\n                <Button className=\"bg-[#E53935] hover:bg-[#C62828]\" data-testid=\"button-upload-excel\">\n                  <Upload className=\"w-4 h-4 mr-2\" />\n                  Upload Excel\n                </Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Upload Data SIMPER dari Excel</DialogTitle>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <Button \n                    onClick={downloadTemplate} \n                    variant=\"outline\"\n                    data-testid=\"button-download-template\"\n                  >\n                    <Download className=\"w-4 h-4 mr-2\" />\n                    Download Template\n                  </Button>\n                  <Input\n                    type=\"file\"\n                    accept=\".xlsx,.xls\"\n                    ref={fileInputRef}\n                    onChange={handleFileUpload}\n                    data-testid=\"input-excel-file\"\n                  />\n                  <p className=\"text-sm text-gray-600\">\n                    Upload file Excel dengan kolom: Nama Karyawan, NIK, Tanggal SIMPER BIB Mati, Tanggal SIMPER TIA Mati\n                  </p>\n                </div>\n              </DialogContent>\n            </Dialog>\n\n            <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n              <DialogTrigger asChild>\n                <Button variant=\"outline\" data-testid=\"button-add-simper\">\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Tambah Data\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-md\">\n                <DialogHeader>\n                  <DialogTitle>\n                    {selectedSimper ? \"Edit Data SIMPER\" : \"Tambah Data SIMPER\"}\n                  </DialogTitle>\n                </DialogHeader>\n                <Form {...form}>\n                  <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"employeeName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Nama Karyawan</FormLabel>\n                          <FormControl>\n                            <Input {...field} data-testid=\"input-employee-name\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"nik\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>NIK</FormLabel>\n                          <FormControl>\n                            <Input {...field} data-testid=\"input-nik\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"simperBibExpiredDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Tanggal SIMPER BIB Mati</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} value={field.value || \"\"} data-testid=\"input-bib-expired\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={form.control}\n                      name=\"simperTiaExpiredDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Tanggal SIMPER TIA Mati</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} value={field.value || \"\"} data-testid=\"input-tia-expired\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <div className=\"flex justify-end space-x-2\">\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        onClick={() => {\n                          setIsEditDialogOpen(false);\n                          setSelectedSimper(null);\n                          form.reset();\n                        }}\n                      >\n                        Batal\n                      </Button>\n                      <Button\n                        type=\"submit\"\n                        className=\"bg-[#E53935] hover:bg-[#C62828]\"\n                        disabled={createMutation.isPending || updateMutation.isPending}\n                        data-testid=\"button-save-simper\"\n                      >\n                        {selectedSimper ? \"Update\" : \"Simpan\"}\n                      </Button>\n                    </div>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n\n            <Button \n              onClick={handleDeleteAll} \n              variant=\"destructive\"\n              data-testid=\"button-delete-all\"\n            >\n              <Trash2 className=\"w-4 h-4 mr-2\" />\n              Hapus Semua Data\n            </Button>\n          </div>\n\n          {/* Search and Filter */}\n          <div className=\"flex flex-wrap gap-4\">\n            <div className=\"relative flex-1 min-w-64\">\n              <Search className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\n              <Input\n                placeholder=\"Cari nama karyawan atau NIK...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search\"\n              />\n            </div>\n            <Select value={statusFilter} onValueChange={setStatusFilter}>\n              <SelectTrigger className=\"w-48\" data-testid=\"select-status-filter\">\n                <SelectValue placeholder=\"Filter Status\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Semua Status</SelectItem>\n                <SelectItem value=\"bib\">SIMPER BIB</SelectItem>\n                <SelectItem value=\"tia\">SIMPER TIA</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Data Table */}\n      <Card className=\"rounded-2xl shadow-lg\">\n        <CardHeader>\n          <CardTitle>Tabel Monitoring SIMPER</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8\">Loading...</div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Nama Karyawan</TableHead>\n                    <TableHead>NIK</TableHead>\n                    <TableHead>Tanggal SIMPER BIB Mati</TableHead>\n                    <TableHead>Monitoring Hari BIB</TableHead>\n                    <TableHead>Status SIMPER BIB</TableHead>\n                    <TableHead>Tanggal SIMPER TIA Mati</TableHead>\n                    <TableHead>Monitoring Hari TIA</TableHead>\n                    <TableHead>Status SIMPER TIA</TableHead>\n                    <TableHead>Aksi</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredData.map((simper: SimperMonitoring) => {\n                    const bibStatus = getMonitoringStatus(simper.simperBibExpiredDate);\n                    const tiaStatus = getMonitoringStatus(simper.simperTiaExpiredDate);\n                    \n                    return (\n                      <TableRow key={simper.id} className=\"hover:bg-[#F5F5F5] transition-colors\">\n                        <TableCell className=\"font-medium\">{simper.employeeName}</TableCell>\n                        <TableCell>{simper.nik}</TableCell>\n                        <TableCell>\n                          {formatDateToDDMMYYYY(simper.simperBibExpiredDate)}\n                        </TableCell>\n                        <TableCell>\n                          {bibStatus.days !== null ? `${bibStatus.days} hari` : \"-\"}\n                        </TableCell>\n                        <TableCell>\n                          <Badge className={bibStatus.customStyle || \"bg-gray-200 text-gray-800\"}>\n                            {bibStatus.status}\n                          </Badge>\n                        </TableCell>\n                        <TableCell>\n                          {formatDateToDDMMYYYY(simper.simperTiaExpiredDate)}\n                        </TableCell>\n                        <TableCell>\n                          {tiaStatus.days !== null ? `${tiaStatus.days} hari` : \"-\"}\n                        </TableCell>\n                        <TableCell>\n                          <Badge className={tiaStatus.customStyle || \"bg-gray-200 text-gray-800\"}>\n                            {tiaStatus.status}\n                          </Badge>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex space-x-2\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => handleEdit(simper)}\n                              data-testid={`button-edit-${simper.id}`}\n                            >\n                              <Edit className=\"w-4 h-4\" />\n                            </Button>\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => handleDelete(simper.id)}\n                              data-testid={`button-delete-${simper.id}`}\n                            >\n                              <Trash2 className=\"w-4 h-4\" />\n                            </Button>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    );\n                  })}\n                </TableBody>\n              </Table>\n              {filteredData.length === 0 && (\n                <div className=\"text-center py-8 text-gray-500\">\n                  Tidak ada data SIMPER yang ditemukan\n                </div>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Critical List Table */}\n      {analytics && analytics.criticalList.length > 0 && (\n        <Card className=\"rounded-2xl shadow-lg border-yellow-200\">\n          <CardHeader className=\"bg-yellow-50\">\n            <CardTitle className=\"text-yellow-800 flex items-center\">\n              <AlertCircle className=\"w-5 h-5 mr-2\" />\n              Daftar SIMPER Kritis (10 Terdekat)\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"p-0\">\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Nama Karyawan</TableHead>\n                    <TableHead>NIK</TableHead>\n                    <TableHead>BIB Status</TableHead>\n                    <TableHead>TIA Status</TableHead>\n                    <TableHead>Hari Tersisa</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {analytics.criticalList.map((item, index) => (\n                    <TableRow key={index}>\n                      <TableCell className=\"font-medium\">{item.employeeName}</TableCell>\n                      <TableCell>{item.nik}</TableCell>\n                      <TableCell>\n                        <Badge variant={item.bibStatus === 'Segera Perpanjang' ? 'destructive' : 'secondary'}>\n                          {item.bibStatus}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={item.tiaStatus === 'Segera Perpanjang' ? 'destructive' : 'secondary'}>\n                          {item.tiaStatus}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <span className={`font-semibold ${\n                          Math.min(item.bibMonitoringDays || 999, item.tiaMonitoringDays || 999) < 0 \n                            ? 'text-red-600' \n                            : Math.min(item.bibMonitoringDays || 999, item.tiaMonitoringDays || 999) < 7\n                              ? 'text-yellow-600'\n                              : 'text-orange-600'\n                        }`}>\n                          {Math.min(item.bibMonitoringDays || 999, item.tiaMonitoringDays || 999)} hari\n                        </span>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":32902,"size_tokens":null},"client/src/components/PDFViewer.tsx":{"content":"import React, { useState } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { FileText, ExternalLink, X } from 'lucide-react';\n\ninterface PDFViewerProps {\n  pdfPath: string;\n  title?: string;\n  trigger?: React.ReactNode;\n}\n\nexport function PDFViewer({ pdfPath, title = \"Preview PDF\", trigger }: PDFViewerProps) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [loadError, setLoadError] = useState(false);\n\n  const handleOpenExternal = () => {\n    window.open(pdfPath, '_blank', 'noopener,noreferrer');\n  };\n\n  const handleIframeError = () => {\n    console.error('Error loading PDF in iframe:', pdfPath);\n    setLoadError(true);\n  };\n\n  const handleIframeLoad = () => {\n    // Check if iframe content is blocked by detecting Chrome's block message\n    setLoadError(false);\n    \n    // Small delay to detect if Chrome blocks the content\n    setTimeout(() => {\n      try {\n        const iframe = document.querySelector('[data-testid=\"pdf-iframe\"]') as HTMLIFrameElement;\n        if (iframe && iframe.contentDocument) {\n          const content = iframe.contentDocument.body?.textContent || '';\n          if (content.includes('blocked') || content.includes('This page has been blocked')) {\n            setLoadError(true);\n          }\n        }\n      } catch (e) {\n        // If we can't access iframe content due to CORS, it might be loaded successfully\n        // or blocked - we'll rely on user feedback\n      }\n    }, 1000);\n  };\n\n  const defaultTrigger = (\n    <Button\n      variant=\"outline\"\n      size=\"sm\"\n      className=\"flex items-center space-x-2\"\n      data-testid=\"pdf-viewer-trigger\"\n    >\n      <FileText className=\"w-4 h-4\" />\n      <span>Preview PDF</span>\n    </Button>\n  );\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        {trigger || defaultTrigger}\n      </DialogTrigger>\n      <DialogContent className=\"max-w-4xl h-[80vh] flex flex-col\">\n        <DialogHeader className=\"flex-shrink-0\">\n          <div className=\"flex items-center justify-between\">\n            <DialogTitle>{title}</DialogTitle>\n            <div className=\"flex items-center space-x-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleOpenExternal}\n                className=\"flex items-center space-x-1\"\n                data-testid=\"pdf-external-link\"\n              >\n                <ExternalLink className=\"w-4 h-4\" />\n                <span className=\"text-xs\">Buka di Tab Baru</span>\n              </Button>\n            </div>\n          </div>\n        </DialogHeader>\n        \n        <div className=\"flex-1 min-h-0 border rounded-lg overflow-hidden bg-gray-100\">\n          {loadError ? (\n            <div className=\"w-full h-full flex flex-col items-center justify-center text-gray-600 p-4\">\n              <FileText className=\"w-12 h-12 mb-4 text-gray-400\" />\n              <p className=\"text-sm mb-2 text-center\">Browser memblokir preview PDF</p>\n              <p className=\"text-xs text-gray-500 mb-4 text-center\">\n                Chrome mungkin memblokir tampilan PDF dalam preview ini\n              </p>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleOpenExternal}\n                className=\"flex items-center gap-2\"\n              >\n                <ExternalLink className=\"w-4 h-4\" />\n                Buka di Tab Baru\n              </Button>\n            </div>\n          ) : (\n            <iframe\n              src={`${pdfPath}#toolbar=1&navpanes=1&scrollbar=1&view=FitH`}\n              className=\"w-full h-full border-0\"\n              title={title}\n              data-testid=\"pdf-iframe\"\n              onError={handleIframeError}\n              onLoad={handleIframeLoad}\n            />\n          )}\n        </div>\n        \n        <div className=\"flex-shrink-0 text-xs text-gray-500 text-center pt-2\">\n          ðŸ’¡ Tip: Jika PDF tidak tampil, klik \"Buka di Tab Baru\" atau pastikan browser mendukung preview PDF\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}","path":null,"size_bytes":4184,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"server/storage.ts":{"content":"import { \n  type Employee, \n  type InsertEmployee, \n  type AttendanceRecord, \n  type InsertAttendanceRecord,\n  type RosterSchedule,\n  type InsertRosterSchedule,\n  type LeaveRequest,\n  type InsertLeaveRequest,\n  type QrToken,\n  type InsertQrToken,\n  type LeaveReminder,\n  type InsertLeaveReminder,\n  type LeaveBalance,\n  type InsertLeaveBalance,\n  type LeaveHistory,\n  type InsertLeaveHistory,\n  type LeaveRosterMonitoring,\n  type InsertLeaveRosterMonitoring,\n  type Meeting,\n  type InsertMeeting,\n  type MeetingAttendance,\n  type InsertMeetingAttendance,\n  type SimperMonitoring,\n  type InsertSimperMonitoring,\n  type SidakFatigueSession,\n  type InsertSidakFatigueSession,\n  type SidakFatigueRecord,\n  type InsertSidakFatigueRecord,\n  type SidakFatigueObserver,\n  type InsertSidakFatigueObserver,\n  type SidakRosterSession,\n  type InsertSidakRosterSession,\n  type SidakRosterRecord,\n  type InsertSidakRosterRecord,\n  type SidakRosterObserver,\n  type InsertSidakRosterObserver,\n  type Announcement,\n  type InsertAnnouncement,\n  type AnnouncementRead,\n  type InsertAnnouncementRead,\n  type Document,\n  type InsertDocument,\n  type News,\n  type InsertNews,\n  type PushSubscription,\n  type InsertPushSubscription,\n  type User,\n  type UpsertUser,\n  users,\n  authUsers,\n  employees,\n  attendanceRecords,\n  rosterSchedules,\n  leaveRequests,\n  qrTokens,\n  leaveReminders,\n  leaveBalances,\n  leaveHistory,\n  leaveRosterMonitoring,\n  meetings,\n  meetingAttendance,\n  simperMonitoring,\n  sidakFatigueSessions,\n  sidakFatigueRecords,\n  sidakFatigueObservers,\n  sidakRosterSessions,\n  sidakRosterRecords,\n  sidakRosterObservers,\n  announcements,\n  announcementReads,\n  documents,\n  news,\n  pushSubscriptions\n} from \"@shared/schema\";\nimport { randomUUID } from \"crypto\";\nimport { drizzle } from \"drizzle-orm/neon-http\";\nimport { neon } from \"@neondatabase/serverless\";\nimport { eq, and, inArray } from \"drizzle-orm\";\nimport { sql as drizzleSql } from \"drizzle-orm\";\nimport { db } from \"./db\";\n\nexport interface IStorage {\n  // User operations (required for Replit Auth)\n  getUser(id: string): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n\n  // Auth operations (NIK-based authentication)\n  createAuthUser(nik: string, hashedPassword: string): Promise<void>;\n  getAuthUserByNik(nik: string): Promise<{ nik: string; hashedPassword: string } | undefined>;\n  updateAuthUserPassword(nik: string, hashedPassword: string): Promise<void>;\n\n  // Employee methods\n  getEmployee(id: string): Promise<Employee | undefined>;\n  getAllEmployees(): Promise<Employee[]>;\n  getEmployees(): Promise<Employee[]>; // Alias for compatibility\n  createEmployee(employee: InsertEmployee): Promise<Employee>;\n  updateEmployee(id: string, employee: Partial<InsertEmployee>): Promise<Employee | undefined>;\n  deleteEmployee(id: string): Promise<boolean>;\n  deleteAllEmployees(): Promise<boolean>;\n\n  // Attendance methods\n  getAttendanceRecord(id: string): Promise<AttendanceRecord | undefined>;\n  getAttendanceByEmployee(employeeId: string, date?: string): Promise<AttendanceRecord[]>;\n  getAllAttendance(date?: string): Promise<AttendanceRecord[]>;\n  getAllAttendanceByDateRange(startDate: string, endDate: string): Promise<AttendanceRecord[]>;\n  createAttendanceRecord(record: InsertAttendanceRecord): Promise<AttendanceRecord>;\n  \n  // Roster methods\n  getRosterSchedule(id: string): Promise<RosterSchedule | undefined>;\n  getRosterByDate(date: string): Promise<RosterSchedule[]>;\n  getRosterByDateRange(startDate: string, endDate: string): Promise<RosterSchedule[]>;\n  getRosterByEmployee(employeeId: string): Promise<RosterSchedule[]>;\n  getRosterByEmployeeAndDate(employeeId: string, date: string): Promise<RosterSchedule | undefined>;\n  createRosterSchedule(schedule: InsertRosterSchedule): Promise<RosterSchedule>;\n  updateRosterSchedule(id: string, schedule: Partial<InsertRosterSchedule>): Promise<RosterSchedule | undefined>;\n  deleteRosterSchedule(id: string): Promise<boolean>;\n  deleteAllRosterSchedules(): Promise<void>;\n  \n  // Leave methods\n  getLeaveRequest(id: string): Promise<LeaveRequest | undefined>;\n  getLeaveByEmployee(employeeId: string): Promise<LeaveRequest[]>;\n  getAllLeaveRequests(): Promise<LeaveRequest[]>;\n  getLeaveRequests(): Promise<LeaveRequest[]>; // Alias for compatibility\n  createLeaveRequest(request: InsertLeaveRequest): Promise<LeaveRequest>;\n  updateLeaveRequest(id: string, request: Partial<InsertLeaveRequest>): Promise<LeaveRequest | undefined>;\n  deleteLeaveRequest(id: string): Promise<boolean>;\n  \n  // QR Token methods\n  getQrToken(employeeId: string): Promise<QrToken | undefined>;\n  getQrTokensByEmployee(employeeId: string): Promise<QrToken[]>;\n  createQrToken(token: InsertQrToken): Promise<QrToken>;\n  validateQrToken(employeeId: string, token: string): Promise<boolean>;\n\n  // Leave Reminder methods\n  getLeaveReminder(leaveRequestId: string, reminderType: string): Promise<LeaveReminder | undefined>;\n  getLeaveReminders(): Promise<LeaveReminder[]>;\n  saveLeaveReminder(reminder: InsertLeaveReminder): Promise<LeaveReminder>;\n\n  // Leave Balance methods\n  getLeaveBalances(): Promise<LeaveBalance[]>;\n  getLeaveBalanceByEmployee(employeeId: string, year?: number): Promise<LeaveBalance | undefined>;\n  createLeaveBalance(balance: InsertLeaveBalance): Promise<LeaveBalance>;\n  updateLeaveBalance(id: string, balance: Partial<InsertLeaveBalance>): Promise<LeaveBalance | undefined>;\n  calculateLeaveEligibility(employeeId: string): Promise<{ eligible: boolean; daysEarned: number; nextEligibleDate: string | null }>;\n\n  // Leave History methods\n  getLeaveHistory(): Promise<LeaveHistory[]>;\n  getLeaveHistoryByEmployee(employeeId: string): Promise<LeaveHistory[]>;\n  createLeaveHistory(history: InsertLeaveHistory): Promise<LeaveHistory>;\n\n  // Bulk upload methods\n  bulkUploadLeaveRoster(data: Array<{ nik: string; leaveType: string; startDate: string; endDate: string; totalDays: number }>): Promise<{ success: number; errors: string[] }>;\n\n  // Leave Roster Monitoring methods\n  getLeaveRosterMonitoring(id: string): Promise<LeaveRosterMonitoring | undefined>;\n  getLeaveRosterMonitoringByNik(nik: string): Promise<LeaveRosterMonitoring | undefined>;\n  getAllLeaveRosterMonitoring(): Promise<LeaveRosterMonitoring[]>;\n  createLeaveRosterMonitoring(monitoring: InsertLeaveRosterMonitoring): Promise<LeaveRosterMonitoring>;\n  updateLeaveRosterMonitoring(id: string, monitoring: Partial<InsertLeaveRosterMonitoring>): Promise<LeaveRosterMonitoring | undefined>;\n  deleteLeaveRosterMonitoring(id: string): Promise<boolean>;\n  deleteAllLeaveRosterMonitoring(): Promise<void>;\n  updateLeaveRosterStatus(): Promise<void>; // Update status berdasarkan tanggal\n  \n\n  // Meeting methods\n  getMeeting(id: string): Promise<Meeting | undefined>;\n  getAllMeetings(): Promise<Meeting[]>;\n  getMeetingsByDate(date: string): Promise<Meeting[]>;\n  createMeeting(meeting: InsertMeeting): Promise<Meeting>;\n  updateMeeting(id: string, meeting: Partial<InsertMeeting>): Promise<Meeting | undefined>;\n  deleteMeeting(id: string): Promise<boolean>;\n  getMeetingByQrToken(qrToken: string): Promise<Meeting | undefined>;\n\n  // Meeting attendance methods\n  getMeetingAttendance(meetingId: string): Promise<MeetingAttendance[]>;\n  createMeetingAttendance(attendance: InsertMeetingAttendance): Promise<MeetingAttendance>;\n  checkMeetingAttendance(meetingId: string, employeeId: string): Promise<MeetingAttendance | undefined>;\n  deleteMeetingAttendance(attendanceId: string): Promise<boolean>;\n\n  // SIMPER Monitoring methods\n  getSimperMonitoring(id: string): Promise<SimperMonitoring | undefined>;\n  getSimperMonitoringByNik(nik: string): Promise<SimperMonitoring | undefined>;\n  getAllSimperMonitoring(): Promise<SimperMonitoring[]>;\n  createSimperMonitoring(simper: InsertSimperMonitoring): Promise<SimperMonitoring>;\n  updateSimperMonitoring(id: string, simper: Partial<InsertSimperMonitoring>): Promise<SimperMonitoring | undefined>;\n  deleteSimperMonitoring(id: string): Promise<boolean>;\n  deleteAllSimperMonitoring(): Promise<void>;\n  bulkUploadSimperData(data: Array<{ employeeName: string; nik: string; simperBibExpiredDate?: string; simperTiaExpiredDate?: string }>): Promise<{ success: number; errors: string[] }>;\n\n  // Sidak Fatigue methods\n  getSidakFatigueSession(id: string): Promise<SidakFatigueSession | undefined>;\n  getAllSidakFatigueSessions(): Promise<SidakFatigueSession[]>;\n  createSidakFatigueSession(session: InsertSidakFatigueSession): Promise<SidakFatigueSession>;\n  deleteSidakFatigueSession(id: string): Promise<boolean>;\n  getSidakFatigueRecords(sessionId: string): Promise<SidakFatigueRecord[]>;\n  getSidakFatigueRecordsBySessionIds(sessionIds: string[]): Promise<SidakFatigueRecord[]>;\n  createSidakFatigueRecord(record: InsertSidakFatigueRecord): Promise<SidakFatigueRecord>;\n  getSidakFatigueObservers(sessionId: string): Promise<SidakFatigueObserver[]>;\n  createSidakFatigueObserver(observer: InsertSidakFatigueObserver): Promise<SidakFatigueObserver>;\n\n  // Sidak Roster methods\n  getSidakRosterSession(id: string): Promise<SidakRosterSession | undefined>;\n  getAllSidakRosterSessions(): Promise<SidakRosterSession[]>;\n  createSidakRosterSession(session: InsertSidakRosterSession): Promise<SidakRosterSession>;\n  deleteSidakRosterSession(id: string): Promise<boolean>;\n  getSidakRosterRecords(sessionId: string): Promise<SidakRosterRecord[]>;\n  createSidakRosterRecord(record: InsertSidakRosterRecord): Promise<SidakRosterRecord>;\n  getSidakRosterObservers(sessionId: string): Promise<SidakRosterObserver[]>;\n  createSidakRosterObserver(observer: InsertSidakRosterObserver): Promise<SidakRosterObserver>;\n\n  // Announcement methods\n  getAnnouncement(id: string): Promise<Announcement | undefined>;\n  getAllAnnouncements(): Promise<Announcement[]>;\n  getActiveAnnouncements(): Promise<Announcement[]>;\n  createAnnouncement(announcement: InsertAnnouncement): Promise<Announcement>;\n  updateAnnouncement(id: string, announcement: Partial<InsertAnnouncement>): Promise<Announcement | undefined>;\n  deleteAnnouncement(id: string): Promise<boolean>;\n  \n  // Announcement read tracking methods\n  getAnnouncementReads(announcementId: string): Promise<AnnouncementRead[]>;\n  markAnnouncementAsRead(announcementId: string, employeeId: string, employeeName: string): Promise<AnnouncementRead>;\n  getUnreadAnnouncementsCount(employeeId: string): Promise<number>;\n  hasReadAnnouncement(announcementId: string, employeeId: string): Promise<boolean>;\n  \n  // Document methods\n  getDocument(id: string): Promise<Document | undefined>;\n  getAllDocuments(): Promise<Document[]>;\n  getDocumentsByCategory(category: string): Promise<Document[]>;\n  getActiveDocuments(): Promise<Document[]>;\n  createDocument(document: InsertDocument): Promise<Document>;\n  updateDocument(id: string, document: Partial<InsertDocument>): Promise<Document | undefined>;\n  deleteDocument(id: string): Promise<boolean>;\n  \n  // News methods\n  getNews(id: string): Promise<News | undefined>;\n  getAllNews(): Promise<News[]>;\n  getActiveNews(): Promise<News[]>;\n  createNews(news: InsertNews): Promise<News>;\n  updateNews(id: string, news: Partial<InsertNews>): Promise<News | undefined>;\n  deleteNews(id: string): Promise<boolean>;\n  \n  // Push subscription methods\n  getPushSubscription(id: string): Promise<PushSubscription | undefined>;\n  getPushSubscriptionsByEmployee(employeeId: string): Promise<PushSubscription[]>;\n  getActivePushSubscriptions(): Promise<PushSubscription[]>;\n  createPushSubscription(subscription: InsertPushSubscription): Promise<PushSubscription>;\n  updatePushSubscription(id: string, subscription: Partial<InsertPushSubscription>): Promise<PushSubscription | undefined>;\n  deletePushSubscription(id: string): Promise<boolean>;\n  deletePushSubscriptionByEndpoint(endpoint: string): Promise<boolean>;\n}\n\nexport class MemStorage implements IStorage {\n  private users: Map<string, User>;\n  private employees: Map<string, Employee>;\n  private attendanceRecords: Map<string, AttendanceRecord>;\n  private rosterSchedules: Map<string, RosterSchedule>;\n  private leaveRequests: Map<string, LeaveRequest>;\n  private qrTokens: Map<string, QrToken>;\n  private leaveBalances: Map<string, LeaveBalance>;\n  private leaveHistory: Map<string, LeaveHistory>;\n  private leaveRosterMonitoring: Map<string, LeaveRosterMonitoring>;\n  private leaveReminders: Map<string, LeaveReminder>;\n  private simperMonitoring: Map<string, SimperMonitoring>;\n  private meetings: Map<string, Meeting>;\n  private meetingAttendance: Map<string, MeetingAttendance>;\n\n  constructor() {\n    this.users = new Map();\n    this.employees = new Map();\n    this.attendanceRecords = new Map();\n    this.rosterSchedules = new Map();\n    this.leaveRequests = new Map();\n    this.qrTokens = new Map();\n    this.leaveBalances = new Map();\n    this.leaveHistory = new Map();\n    this.leaveRosterMonitoring = new Map();\n    this.leaveReminders = new Map();\n    this.simperMonitoring = new Map();\n    this.meetings = new Map();\n    this.meetingAttendance = new Map();\n    \n    // Initialize with sample data\n    this.initializeSampleData();\n  }\n\n  private initializeSampleData() {\n    // No sample employees - user will add their own data\n    // (keeping empty for user to populate with real data)\n\n    // No sample roster - user will add their own data through Excel upload or manual entry\n\n    // No sample attendance - will be created through QR scan attendance system\n\n    // No sample leave requests - will be created by employees as needed\n  }\n\n  // User operations (required for Replit Auth)\n  async getUser(id: string): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const user: User = {\n      id: userData.id || randomUUID(),\n      email: userData.email || null,\n      firstName: userData.firstName || null,\n      lastName: userData.lastName || null,\n      profileImageUrl: userData.profileImageUrl || null,\n      createdAt: userData.createdAt || new Date(),\n      updatedAt: new Date(),\n    };\n    this.users.set(user.id, user);\n    return user;\n  }\n\n  // Auth operations (not implemented in MemStorage)\n  async createAuthUser(nik: string, hashedPassword: string): Promise<void> {\n    throw new Error(\"Auth not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n\n  async getAuthUserByNik(nik: string): Promise<{ nik: string; hashedPassword: string } | undefined> {\n    throw new Error(\"Auth not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n\n  async updateAuthUserPassword(nik: string, hashedPassword: string): Promise<void> {\n    throw new Error(\"Auth not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n\n  // Employee methods\n  async getEmployee(id: string): Promise<Employee | undefined> {\n    return this.employees.get(id);\n  }\n\n  async getAllEmployees(): Promise<Employee[]> {\n    return Array.from(this.employees.values());\n  }\n\n  async getEmployees(): Promise<Employee[]> {\n    return this.getAllEmployees();\n  }\n\n  private generateNextNIK(): string {\n    const existingEmployees = Array.from(this.employees.values());\n    const existingNumbers = existingEmployees\n      .map(emp => {\n        const match = emp.id.match(/^C-(\\d{5})$/);\n        return match ? parseInt(match[1]) : 0;\n      })\n      .filter(num => num > 0);\n    \n    const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;\n    const nextNumber = maxNumber + 1;\n    return `C-${nextNumber.toString().padStart(5, '0')}`;\n  }\n  \n  // Removed generateNextNomorLambung as it's no longer needed\n\n  async createEmployee(insertEmployee: InsertEmployee): Promise<Employee> {\n    // Generate NIK automatically if not provided\n    const id = insertEmployee.id || this.generateNextNIK();\n    \n    const employee: Employee = { \n      ...insertEmployee,\n      id,\n      position: insertEmployee.position || null,\n      nomorLambung: insertEmployee.nomorLambung || null,\n      department: insertEmployee.department || null,\n      investorGroup: insertEmployee.investorGroup || null,\n      qrCode: insertEmployee.qrCode || null, // Add QR Code field\n      status: insertEmployee.status || \"active\",\n      isSpareOrigin: insertEmployee.nomorLambung === \"SPARE\" ? true : (insertEmployee.isSpareOrigin || false), // Track SPARE origin\n      createdAt: new Date() \n    };\n    this.employees.set(employee.id, employee);\n    return employee;\n  }\n\n  async updateEmployee(id: string, updateData: Partial<InsertEmployee>): Promise<Employee | undefined> {\n    const existing = this.employees.get(id);\n    if (!existing) return undefined;\n    \n    // Preserve isSpareOrigin if employee was originally SPARE\n    let isSpareOrigin = existing.isSpareOrigin;\n    if (existing.nomorLambung === \"SPARE\" && updateData.nomorLambung && updateData.nomorLambung !== \"SPARE\") {\n      isSpareOrigin = true; // Mark as SPARE origin when updating from SPARE to new nomor lambung\n    }\n    \n    const updated = { ...existing, ...updateData, isSpareOrigin };\n    this.employees.set(id, updated);\n    return updated;\n  }\n\n  async deleteEmployee(id: string): Promise<boolean> {\n    return this.employees.delete(id);\n  }\n\n  async deleteAllEmployees(): Promise<boolean> {\n    this.employees.clear();\n    // Also clear related data when deleting all employees\n    this.attendanceRecords.clear();\n    this.rosterSchedules.clear();\n    this.qrTokens.clear();\n    return true;\n  }\n\n  // Attendance methods\n  async getAttendanceRecord(id: string): Promise<AttendanceRecord | undefined> {\n    return this.attendanceRecords.get(id);\n  }\n\n  async getAttendanceByEmployee(employeeId: string, date?: string): Promise<AttendanceRecord[]> {\n    return Array.from(this.attendanceRecords.values()).filter(record => \n      record.employeeId === employeeId && (!date || record.date === date)\n    );\n  }\n\n  async getAllAttendance(date?: string): Promise<AttendanceRecord[]> {\n    const records = Array.from(this.attendanceRecords.values());\n    return date ? records.filter(record => record.date === date) : records;\n  }\n\n  async getAllAttendanceByDateRange(startDate: string, endDate: string): Promise<AttendanceRecord[]> {\n    const records = Array.from(this.attendanceRecords.values());\n    return records.filter(record => record.date >= startDate && record.date <= endDate);\n  }\n\n  async createAttendanceRecord(insertRecord: InsertAttendanceRecord): Promise<AttendanceRecord> {\n    const record: AttendanceRecord = {\n      id: randomUUID(),\n      ...insertRecord,\n      jamTidur: insertRecord.jamTidur || null,\n      fitToWork: insertRecord.fitToWork || null,\n      status: insertRecord.status || \"present\",\n      createdAt: new Date()\n    };\n    this.attendanceRecords.set(record.id, record);\n    return record;\n  }\n\n  // Roster methods\n  async getRosterSchedule(id: string): Promise<RosterSchedule | undefined> {\n    return this.rosterSchedules.get(id);\n  }\n\n  async getRosterByDate(date: string): Promise<RosterSchedule[]> {\n    console.log(`Filtering roster schedules for date: ${date}`);\n    const filtered = Array.from(this.rosterSchedules.values()).filter(schedule => schedule.date === date);\n    console.log(`Found ${filtered.length} schedules for date ${date}`);\n    return filtered;\n  }\n\n  async getRosterByEmployee(employeeId: string): Promise<RosterSchedule[]> {\n    return Array.from(this.rosterSchedules.values()).filter(schedule => schedule.employeeId === employeeId);\n  }\n\n  async getRosterByEmployeeAndDate(employeeId: string, date: string): Promise<RosterSchedule | undefined> {\n    return Array.from(this.rosterSchedules.values()).find(schedule => \n      schedule.employeeId === employeeId && schedule.date === date\n    );\n  }\n\n  async getRosterByDateRange(startDate: string, endDate: string): Promise<RosterSchedule[]> {\n    return Array.from(this.rosterSchedules.values()).filter(schedule => \n      schedule.date >= startDate && schedule.date <= endDate\n    );\n  }\n\n  async createRosterSchedule(insertSchedule: InsertRosterSchedule): Promise<RosterSchedule> {\n    // Get employee to populate plannedNomorLambung if not provided\n    const employee = await this.getEmployee(insertSchedule.employeeId);\n    const plannedNomorLambung = insertSchedule.plannedNomorLambung ?? employee?.nomorLambung ?? null;\n    const actualNomorLambung = insertSchedule.actualNomorLambung ?? plannedNomorLambung;\n    \n    const schedule: RosterSchedule = {\n      id: randomUUID(),\n      ...insertSchedule,\n      jamTidur: insertSchedule.jamTidur ?? null,\n      hariKerja: insertSchedule.hariKerja ?? null,\n      plannedNomorLambung,\n      actualNomorLambung,\n      fitToWork: insertSchedule.fitToWork || \"Fit To Work\",\n      status: insertSchedule.status || \"scheduled\"\n    };\n    this.rosterSchedules.set(schedule.id, schedule);\n    return schedule;\n  }\n\n  async updateRosterSchedule(id: string, updateData: Partial<InsertRosterSchedule>): Promise<RosterSchedule | undefined> {\n    const existing = this.rosterSchedules.get(id);\n    if (!existing) return undefined;\n    \n    const updated = { ...existing, ...updateData };\n    this.rosterSchedules.set(id, updated);\n    return updated;\n  }\n\n  async deleteRosterSchedule(id: string): Promise<boolean> {\n    return this.rosterSchedules.delete(id);\n  }\n\n  async deleteAllRosterSchedules(): Promise<void> {\n    this.rosterSchedules.clear();\n  }\n\n  // Leave methods\n  async getLeaveRequest(id: string): Promise<LeaveRequest | undefined> {\n    return this.leaveRequests.get(id);\n  }\n\n  async getLeaveByEmployee(employeeId: string): Promise<LeaveRequest[]> {\n    return Array.from(this.leaveRequests.values()).filter(request => request.employeeId === employeeId);\n  }\n\n  async getAllLeaveRequests(): Promise<LeaveRequest[]> {\n    return Array.from(this.leaveRequests.values());\n  }\n\n  async getLeaveRequests(): Promise<LeaveRequest[]> {\n    return this.getAllLeaveRequests();\n  }\n\n  async createLeaveRequest(insertRequest: InsertLeaveRequest): Promise<LeaveRequest> {\n    const request: LeaveRequest = {\n      id: randomUUID(),\n      ...insertRequest,\n      reason: insertRequest.reason ?? null, // Ensure reason is string | null, not undefined\n      attachmentPath: insertRequest.attachmentPath ?? null, // Ensure attachmentPath is string | null, not undefined\n      actionAttachmentPath: insertRequest.actionAttachmentPath ?? null, // Fix actionAttachmentPath\n      status: insertRequest.status || \"pending\",\n      createdAt: new Date()\n    };\n    this.leaveRequests.set(request.id, request);\n    return request;\n  }\n\n  async updateLeaveRequest(id: string, updateData: Partial<InsertLeaveRequest>): Promise<LeaveRequest | undefined> {\n    const existing = this.leaveRequests.get(id);\n    if (!existing) return undefined;\n    \n    const updated = { ...existing, ...updateData };\n    this.leaveRequests.set(id, updated);\n    return updated;\n  }\n\n  async deleteLeaveRequest(id: string): Promise<boolean> {\n    return this.leaveRequests.delete(id);\n  }\n\n  // QR Token methods\n  async getQrToken(employeeId: string): Promise<QrToken | undefined> {\n    return Array.from(this.qrTokens.values()).find(token => \n      token.employeeId === employeeId && token.isActive\n    );\n  }\n\n  async getQrTokensByEmployee(employeeId: string): Promise<QrToken[]> {\n    return Array.from(this.qrTokens.values()).filter(token => \n      token.employeeId === employeeId\n    );\n  }\n\n  async createQrToken(insertToken: InsertQrToken): Promise<QrToken> {\n    // Deactivate existing tokens for this employee\n    Array.from(this.qrTokens.values())\n      .filter(token => token.employeeId === insertToken.employeeId)\n      .forEach(token => {\n        token.isActive = false;\n        this.qrTokens.set(token.id, token);\n      });\n\n    const token: QrToken = {\n      id: randomUUID(),\n      ...insertToken,\n      isActive: insertToken.isActive !== undefined ? insertToken.isActive : true,\n      createdAt: new Date()\n    };\n    this.qrTokens.set(token.id, token);\n    return token;\n  }\n\n  async validateQrToken(employeeId: string, token: string): Promise<boolean> {\n    const qrToken = await this.getQrToken(employeeId);\n    return qrToken ? qrToken.token === token && qrToken.isActive : false;\n  }\n\n\n  // Stub implementations for MemStorage (not used in production)\n  async getLeaveReminder(leaveRequestId: string, reminderType: string): Promise<LeaveReminder | undefined> {\n    return undefined;\n  }\n\n  async getLeaveReminders(): Promise<LeaveReminder[]> {\n    return [];\n  }\n\n  async saveLeaveReminder(reminder: InsertLeaveReminder): Promise<LeaveReminder> {\n    const leaveReminder: LeaveReminder = {\n      ...reminder,\n      createdAt: new Date()\n    };\n    return leaveReminder;\n  }\n\n  async getLeaveBalances(): Promise<LeaveBalance[]> {\n    return [];\n  }\n\n  async getLeaveBalanceByEmployee(employeeId: string, year?: number): Promise<LeaveBalance | undefined> {\n    return undefined;\n  }\n\n  async createLeaveBalance(balance: InsertLeaveBalance): Promise<LeaveBalance> {\n    const leaveBalance: LeaveBalance = {\n      id: randomUUID(),\n      ...balance,\n      status: balance.status ?? 'active',\n      totalDays: balance.totalDays ?? 0,\n      usedDays: balance.usedDays ?? 0,\n      remainingDays: balance.remainingDays ?? 0,\n      workingDaysCompleted: balance.workingDaysCompleted ?? 0,\n      lastWorkDate: balance.lastWorkDate ?? null,\n      lastLeaveDate: balance.lastLeaveDate ?? null,\n      nextLeaveEligible: balance.nextLeaveEligible ?? null,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    return leaveBalance;\n  }\n\n  async updateLeaveBalance(id: string, balance: Partial<InsertLeaveBalance>): Promise<LeaveBalance | undefined> {\n    return undefined;\n  }\n\n  async calculateLeaveEligibility(employeeId: string): Promise<{ eligible: boolean; daysEarned: number; nextEligibleDate: string | null }> {\n    return { eligible: false, daysEarned: 0, nextEligibleDate: null };\n  }\n\n  async getLeaveHistory(): Promise<LeaveHistory[]> {\n    return [];\n  }\n\n  async getLeaveHistoryByEmployee(employeeId: string): Promise<LeaveHistory[]> {\n    return [];\n  }\n\n  async createLeaveHistory(history: InsertLeaveHistory): Promise<LeaveHistory> {\n    const leaveHistory: LeaveHistory = {\n      id: randomUUID(),\n      ...history,\n      leaveRequestId: history.leaveRequestId ?? null,\n      remarks: history.remarks ?? null,\n      createdAt: new Date()\n    };\n    return leaveHistory;\n  }\n\n  async bulkUploadLeaveRoster(data: Array<{ nik: string; leaveType: string; startDate: string; endDate: string; totalDays: number }>): Promise<{ success: number; errors: string[] }> {\n    return { success: 0, errors: [\"MemStorage does not support bulk operations\"] };\n  }\n\n  // Leave Roster Monitoring methods for MemStorage\n  async getLeaveRosterMonitoring(id: string): Promise<LeaveRosterMonitoring | undefined> {\n    return undefined;\n  }\n\n  async getLeaveRosterMonitoringByNik(nik: string): Promise<LeaveRosterMonitoring | undefined> {\n    return undefined;\n  }\n\n  async getAllLeaveRosterMonitoring(): Promise<LeaveRosterMonitoring[]> {\n    return [];\n  }\n\n  async createLeaveRosterMonitoring(monitoring: InsertLeaveRosterMonitoring): Promise<LeaveRosterMonitoring> {\n    const leaveRosterMonitoring: LeaveRosterMonitoring = {\n      id: randomUUID(),\n      ...monitoring,\n      nomorLambung: monitoring.nomorLambung ?? null,\n      lastLeaveDate: monitoring.lastLeaveDate ?? null,\n      nextLeaveDate: monitoring.nextLeaveDate ?? null,\n      onSite: monitoring.onSite ?? null,\n      status: monitoring.status || \"Aktif\",\n      monitoringDays: monitoring.monitoringDays || 0,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.leaveRosterMonitoring.set(leaveRosterMonitoring.id, leaveRosterMonitoring);\n    return leaveRosterMonitoring;\n  }\n\n  async updateLeaveRosterMonitoring(id: string, monitoring: Partial<InsertLeaveRosterMonitoring>): Promise<LeaveRosterMonitoring | undefined> {\n    return undefined;\n  }\n\n  async deleteLeaveRosterMonitoring(id: string): Promise<boolean> {\n    return false;\n  }\n\n  async deleteAllLeaveRosterMonitoring(): Promise<void> {\n    // No-op in memory storage - would clear leave roster monitoring data if implemented\n  }\n\n  async updateLeaveRosterStatus(): Promise<void> {\n    // No-op in memory storage\n  }\n\n  // SIMPER Monitoring methods implementation\n  async getSimperMonitoring(id: string): Promise<SimperMonitoring | undefined> {\n    return this.simperMonitoring.get(id);\n  }\n\n  async getSimperMonitoringByNik(nik: string): Promise<SimperMonitoring | undefined> {\n    return Array.from(this.simperMonitoring.values()).find(simper => simper.nik === nik);\n  }\n\n  async getAllSimperMonitoring(): Promise<SimperMonitoring[]> {\n    return Array.from(this.simperMonitoring.values());\n  }\n\n  async createSimperMonitoring(simperData: InsertSimperMonitoring): Promise<SimperMonitoring> {\n    const simper: SimperMonitoring = {\n      id: randomUUID(),\n      ...simperData,\n      simperBibExpiredDate: simperData.simperBibExpiredDate ?? null,\n      simperTiaExpiredDate: simperData.simperTiaExpiredDate ?? null,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.simperMonitoring.set(simper.id, simper);\n    return simper;\n  }\n\n  async updateSimperMonitoring(id: string, simperData: Partial<InsertSimperMonitoring>): Promise<SimperMonitoring | undefined> {\n    const existing = this.simperMonitoring.get(id);\n    if (existing) {\n      const updated: SimperMonitoring = {\n        ...existing,\n        ...simperData,\n        updatedAt: new Date()\n      };\n      this.simperMonitoring.set(id, updated);\n      return updated;\n    }\n    return undefined;\n  }\n\n  async deleteSimperMonitoring(id: string): Promise<boolean> {\n    return this.simperMonitoring.delete(id);\n  }\n\n  async deleteAllSimperMonitoring(): Promise<void> {\n    this.simperMonitoring.clear();\n  }\n\n  async bulkUploadSimperData(data: Array<{ employeeName: string; nik: string; simperBibExpiredDate?: string; simperTiaExpiredDate?: string }>): Promise<{ success: number; errors: string[] }> {\n    const errors: string[] = [];\n    let success = 0;\n\n    for (const item of data) {\n      try {\n        if (!item.employeeName || !item.nik) {\n          errors.push(`Data tidak lengkap untuk NIK: ${item.nik || 'kosong'}`);\n          continue;\n        }\n\n        // Check if NIK already exists\n        const existing = await this.getSimperMonitoringByNik(item.nik);\n        if (existing) {\n          // Update existing record\n          await this.updateSimperMonitoring(existing.id, {\n            employeeName: item.employeeName,\n            simperBibExpiredDate: item.simperBibExpiredDate || null,\n            simperTiaExpiredDate: item.simperTiaExpiredDate || null\n          });\n        } else {\n          // Create new record\n          await this.createSimperMonitoring({\n            employeeName: item.employeeName,\n            nik: item.nik,\n            simperBibExpiredDate: item.simperBibExpiredDate || null,\n            simperTiaExpiredDate: item.simperTiaExpiredDate || null\n          });\n        }\n        success++;\n      } catch (error) {\n        errors.push(`Error untuk NIK ${item.nik}: ${error}`);\n      }\n    }\n\n    return { success, errors };\n  }\n\n  // Meeting methods implementation for MemStorage\n  async getMeeting(id: string): Promise<Meeting | undefined> {\n    return this.meetings.get(id);\n  }\n\n  async getAllMeetings(): Promise<Meeting[]> {\n    return Array.from(this.meetings.values());\n  }\n\n  async getMeetingsByDate(date: string): Promise<Meeting[]> {\n    return Array.from(this.meetings.values()).filter(meeting => meeting.date === date);\n  }\n\n  async createMeeting(insertMeeting: InsertMeeting): Promise<Meeting> {\n    // Generate unique QR token for the meeting\n    const qrToken = randomUUID().replace(/-/g, '').substring(0, 12);\n    const meeting: Meeting = {\n      id: randomUUID(),\n      ...insertMeeting,\n      status: insertMeeting.status || \"scheduled\",\n      description: insertMeeting.description ?? null,\n      meetingPhotos: insertMeeting.meetingPhotos ?? null,\n      qrToken,\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n    this.meetings.set(meeting.id, meeting);\n    return meeting;\n  }\n\n  async updateMeeting(id: string, updateData: Partial<InsertMeeting>): Promise<Meeting | undefined> {\n    const existing = this.meetings.get(id);\n    if (!existing) return undefined;\n    \n    const updated = { \n      ...existing, \n      ...updateData, \n      updatedAt: new Date() \n    };\n    this.meetings.set(id, updated);\n    return updated;\n  }\n\n  async deleteMeeting(id: string): Promise<boolean> {\n    return this.meetings.delete(id);\n  }\n\n  async getMeetingByQrToken(qrToken: string): Promise<Meeting | undefined> {\n    return Array.from(this.meetings.values()).find(meeting => meeting.qrToken === qrToken);\n  }\n\n  // Meeting attendance methods implementation for MemStorage\n  async getMeetingAttendance(meetingId: string): Promise<MeetingAttendance[]> {\n    return Array.from(this.meetingAttendance.values()).filter(attendance => attendance.meetingId === meetingId);\n  }\n\n  async createMeetingAttendance(insertAttendance: InsertMeetingAttendance): Promise<MeetingAttendance> {\n    const attendance: MeetingAttendance = {\n      id: randomUUID(),\n      ...insertAttendance,\n      employeeId: insertAttendance.employeeId ?? null,\n      deviceInfo: insertAttendance.deviceInfo ?? null,\n      attendanceType: insertAttendance.attendanceType || \"qr_scan\",\n      manualName: insertAttendance.manualName ?? null,\n      manualPosition: insertAttendance.manualPosition ?? null,\n      manualDepartment: insertAttendance.manualDepartment ?? null,\n      createdAt: new Date()\n    };\n    this.meetingAttendance.set(attendance.id, attendance);\n    return attendance;\n  }\n\n  async checkMeetingAttendance(meetingId: string, employeeId: string): Promise<MeetingAttendance | undefined> {\n    return Array.from(this.meetingAttendance.values()).find(attendance => \n      attendance.meetingId === meetingId && attendance.employeeId === employeeId\n    );\n  }\n\n  async deleteMeetingAttendance(attendanceId: string): Promise<boolean> {\n    return this.meetingAttendance.delete(attendanceId);\n  }\n\n  // Sidak Fatigue methods - Not implemented in MemStorage (use DrizzleStorage)\n  async getSidakFatigueSession(id: string): Promise<SidakFatigueSession | undefined> {\n    throw new Error(\"Sidak Fatigue not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getAllSidakFatigueSessions(): Promise<SidakFatigueSession[]> {\n    throw new Error(\"Sidak Fatigue not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async createSidakFatigueSession(session: InsertSidakFatigueSession): Promise<SidakFatigueSession> {\n    throw new Error(\"Sidak Fatigue not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async deleteSidakFatigueSession(id: string): Promise<boolean> {\n    throw new Error(\"Sidak Fatigue not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getSidakFatigueRecords(sessionId: string): Promise<SidakFatigueRecord[]> {\n    throw new Error(\"Sidak Fatigue not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getSidakFatigueRecordsBySessionIds(sessionIds: string[]): Promise<SidakFatigueRecord[]> {\n    throw new Error(\"Sidak Fatigue not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async createSidakFatigueRecord(record: InsertSidakFatigueRecord): Promise<SidakFatigueRecord> {\n    throw new Error(\"Sidak Fatigue not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getSidakFatigueObservers(sessionId: string): Promise<SidakFatigueObserver[]> {\n    throw new Error(\"Sidak Fatigue not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async createSidakFatigueObserver(observer: InsertSidakFatigueObserver): Promise<SidakFatigueObserver> {\n    throw new Error(\"Sidak Fatigue not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n\n  // Sidak Roster methods - Not implemented in MemStorage (use DrizzleStorage)\n  async getSidakRosterSession(id: string): Promise<SidakRosterSession | undefined> {\n    throw new Error(\"Sidak Roster not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getAllSidakRosterSessions(): Promise<SidakRosterSession[]> {\n    throw new Error(\"Sidak Roster not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async createSidakRosterSession(session: InsertSidakRosterSession): Promise<SidakRosterSession> {\n    throw new Error(\"Sidak Roster not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async deleteSidakRosterSession(id: string): Promise<boolean> {\n    throw new Error(\"Sidak Roster not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getSidakRosterRecords(sessionId: string): Promise<SidakRosterRecord[]> {\n    throw new Error(\"Sidak Roster not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async createSidakRosterRecord(record: InsertSidakRosterRecord): Promise<SidakRosterRecord> {\n    throw new Error(\"Sidak Roster not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getSidakRosterObservers(sessionId: string): Promise<SidakRosterObserver[]> {\n    throw new Error(\"Sidak Roster not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async createSidakRosterObserver(observer: InsertSidakRosterObserver): Promise<SidakRosterObserver> {\n    throw new Error(\"Sidak Roster not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n\n  // Announcement methods - Not implemented in MemStorage (use DrizzleStorage)\n  async getAnnouncement(id: string): Promise<Announcement | undefined> {\n    throw new Error(\"Announcements not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getAllAnnouncements(): Promise<Announcement[]> {\n    throw new Error(\"Announcements not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getActiveAnnouncements(): Promise<Announcement[]> {\n    throw new Error(\"Announcements not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async createAnnouncement(announcement: InsertAnnouncement): Promise<Announcement> {\n    throw new Error(\"Announcements not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async updateAnnouncement(id: string, announcement: Partial<InsertAnnouncement>): Promise<Announcement | undefined> {\n    throw new Error(\"Announcements not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async deleteAnnouncement(id: string): Promise<boolean> {\n    throw new Error(\"Announcements not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getAnnouncementReads(announcementId: string): Promise<AnnouncementRead[]> {\n    throw new Error(\"Announcements not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async markAnnouncementAsRead(announcementId: string, employeeId: string, employeeName: string): Promise<AnnouncementRead> {\n    throw new Error(\"Announcements not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getUnreadAnnouncementsCount(employeeId: string): Promise<number> {\n    throw new Error(\"Announcements not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async hasReadAnnouncement(announcementId: string, employeeId: string): Promise<boolean> {\n    throw new Error(\"Announcements not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  \n  // Document methods - Not implemented in MemStorage (use DrizzleStorage)\n  async getDocument(id: string): Promise<Document | undefined> {\n    throw new Error(\"Documents not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getAllDocuments(): Promise<Document[]> {\n    throw new Error(\"Documents not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getDocumentsByCategory(category: string): Promise<Document[]> {\n    throw new Error(\"Documents not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async getActiveDocuments(): Promise<Document[]> {\n    throw new Error(\"Documents not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async createDocument(document: InsertDocument): Promise<Document> {\n    throw new Error(\"Documents not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async updateDocument(id: string, document: Partial<InsertDocument>): Promise<Document | undefined> {\n    throw new Error(\"Documents not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n  async deleteDocument(id: string): Promise<boolean> {\n    throw new Error(\"Documents not implemented in MemStorage. Use DrizzleStorage.\");\n  }\n}\n\n// DrizzleStorage implementation using PostgreSQL\nexport class DrizzleStorage implements IStorage {\n  private db;\n\n  constructor() {\n    if (!process.env.DATABASE_URL) {\n      throw new Error(\"DATABASE_URL environment variable is not set\");\n    }\n    try {\n      const sql = neon(process.env.DATABASE_URL);\n      this.db = drizzle(sql);\n      console.log(\"âœ… Database connection initialized successfully\");\n    } catch (error: any) {\n      console.error(\"âŒ Failed to initialize database:\", error?.message || error);\n      throw error;\n    }\n  }\n\n  // User operations implementation (required for Replit Auth)\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await this.db\n      .select()\n      .from(users)\n      .where(eq(users.id, id));\n    return user;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await this.db\n      .insert(users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n\n  // Auth operations implementation (NIK-based authentication)\n  async createAuthUser(nik: string, hashedPassword: string): Promise<void> {\n    await this.db\n      .insert(authUsers)\n      .values({ nik, hashedPassword });\n  }\n\n  async getAuthUserByNik(nik: string): Promise<{ nik: string; hashedPassword: string } | undefined> {\n    try {\n      const [authUser] = await this.db\n        .select({\n          nik: authUsers.nik,\n          hashedPassword: authUsers.hashedPassword,\n        })\n        .from(authUsers)\n        .where(eq(authUsers.nik, nik));\n      return authUser;\n    } catch (error: any) {\n      console.error(\"âŒ Database error in getAuthUserByNik:\", error?.message || error);\n      throw error;\n    }\n  }\n\n  async updateAuthUserPassword(nik: string, hashedPassword: string): Promise<void> {\n    await this.db\n      .update(authUsers)\n      .set({ hashedPassword, updatedAt: new Date() })\n      .where(eq(authUsers.nik, nik));\n  }\n\n  // Employee methods\n  async getEmployee(id: string): Promise<Employee | undefined> {\n    const result = await this.db.select().from(employees).where(eq(employees.id, id));\n    return result[0];\n  }\n\n  async getAllEmployees(): Promise<Employee[]> {\n    return await this.db.select().from(employees);\n  }\n\n  async getEmployees(): Promise<Employee[]> {\n    return this.getAllEmployees();\n  }\n\n  async createEmployee(insertEmployee: InsertEmployee): Promise<Employee> {\n    const result = await this.db.insert(employees).values(insertEmployee).returning();\n    return result[0];\n  }\n\n  async updateEmployee(id: string, updateData: Partial<InsertEmployee>): Promise<Employee | undefined> {\n    const result = await this.db.update(employees).set(updateData).where(eq(employees.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteEmployee(id: string): Promise<boolean> {\n    const result = await this.db.delete(employees).where(eq(employees.id, id));\n    return true;\n  }\n\n  async deleteAllEmployees(): Promise<boolean> {\n    await this.db.delete(employees);\n    return true;\n  }\n\n  // Attendance methods\n  async getAttendanceRecord(id: string): Promise<AttendanceRecord | undefined> {\n    const result = await this.db.select().from(attendanceRecords).where(eq(attendanceRecords.id, id));\n    return result[0];\n  }\n\n  async getAttendanceByEmployee(employeeId: string, date?: string): Promise<AttendanceRecord[]> {\n    if (date) {\n      return await this.db.select().from(attendanceRecords)\n        .where(and(eq(attendanceRecords.employeeId, employeeId), eq(attendanceRecords.date, date)));\n    }\n    return await this.db.select().from(attendanceRecords).where(eq(attendanceRecords.employeeId, employeeId));\n  }\n\n  async getAllAttendance(date?: string): Promise<AttendanceRecord[]> {\n    if (date) {\n      return await this.db.select().from(attendanceRecords).where(eq(attendanceRecords.date, date));\n    }\n    return await this.db.select().from(attendanceRecords);\n  }\n\n  async getAllAttendanceByDateRange(startDate: string, endDate: string): Promise<AttendanceRecord[]> {\n    return await this.db.select().from(attendanceRecords)\n      .where(\n        and(\n          drizzleSql`${attendanceRecords.date} >= ${startDate}`,\n          drizzleSql`${attendanceRecords.date} <= ${endDate}`\n        )\n      );\n  }\n\n  async createAttendanceRecord(record: InsertAttendanceRecord): Promise<AttendanceRecord> {\n    const result = await this.db.insert(attendanceRecords).values(record).returning();\n    return result[0];\n  }\n\n  // Roster methods\n  async getRosterSchedule(id: string): Promise<RosterSchedule | undefined> {\n    const result = await this.db.select().from(rosterSchedules).where(eq(rosterSchedules.id, id));\n    return result[0];\n  }\n\n  async getRosterByDate(date: string): Promise<RosterSchedule[]> {\n    return await this.db.select().from(rosterSchedules).where(eq(rosterSchedules.date, date));\n  }\n\n  async getRosterByEmployee(employeeId: string): Promise<RosterSchedule[]> {\n    return await this.db.select().from(rosterSchedules).where(eq(rosterSchedules.employeeId, employeeId));\n  }\n\n  async getRosterByEmployeeAndDate(employeeId: string, date: string): Promise<RosterSchedule | undefined> {\n    const result = await this.db.select().from(rosterSchedules)\n      .where(and(\n        eq(rosterSchedules.employeeId, employeeId),\n        eq(rosterSchedules.date, date)\n      ));\n    return result[0];\n  }\n\n  async getRosterByDateRange(startDate: string, endDate: string): Promise<RosterSchedule[]> {\n    return await this.db.select().from(rosterSchedules)\n      .where(\n        and(\n          drizzleSql`${rosterSchedules.date} >= ${startDate}`,\n          drizzleSql`${rosterSchedules.date} <= ${endDate}`\n        )\n      );\n  }\n\n  async createRosterSchedule(insertSchedule: InsertRosterSchedule): Promise<RosterSchedule> {\n    // Get employee to populate plannedNomorLambung if not provided\n    const employee = await this.getEmployee(insertSchedule.employeeId);\n    const plannedNomorLambung = insertSchedule.plannedNomorLambung ?? employee?.nomorLambung ?? null;\n    const actualNomorLambung = insertSchedule.actualNomorLambung ?? plannedNomorLambung;\n    \n    const scheduleToInsert = {\n      ...insertSchedule,\n      plannedNomorLambung,\n      actualNomorLambung,\n    };\n    \n    const result = await this.db.insert(rosterSchedules).values(scheduleToInsert).returning();\n    return result[0];\n  }\n\n  async updateRosterSchedule(id: string, updateData: Partial<InsertRosterSchedule>): Promise<RosterSchedule | undefined> {\n    const result = await this.db.update(rosterSchedules).set(updateData).where(eq(rosterSchedules.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteRosterSchedule(id: string): Promise<boolean> {\n    await this.db.delete(rosterSchedules).where(eq(rosterSchedules.id, id));\n    return true;\n  }\n\n  async deleteAllRosterSchedules(): Promise<void> {\n    await this.db.delete(rosterSchedules);\n  }\n\n  // Leave methods\n  async getLeaveRequest(id: string): Promise<LeaveRequest | undefined> {\n    const result = await this.db.select().from(leaveRequests).where(eq(leaveRequests.id, id));\n    return result[0];\n  }\n\n  async getLeaveByEmployee(employeeId: string): Promise<LeaveRequest[]> {\n    return await this.db.select().from(leaveRequests).where(eq(leaveRequests.employeeId, employeeId));\n  }\n\n  async getAllLeaveRequests(): Promise<LeaveRequest[]> {\n    return await this.db.select().from(leaveRequests);\n  }\n\n  async createLeaveRequest(request: InsertLeaveRequest): Promise<LeaveRequest> {\n    const result = await this.db.insert(leaveRequests).values(request).returning();\n    return result[0];\n  }\n\n  async updateLeaveRequest(id: string, updateData: Partial<InsertLeaveRequest>): Promise<LeaveRequest | undefined> {\n    const result = await this.db.update(leaveRequests).set(updateData).where(eq(leaveRequests.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteLeaveRequest(id: string): Promise<boolean> {\n    const result = await this.db.delete(leaveRequests).where(eq(leaveRequests.id, id)).returning();\n    return result.length > 0;\n  }\n\n  // QR Token methods\n  async getQrToken(employeeId: string): Promise<QrToken | undefined> {\n    const result = await this.db.select().from(qrTokens)\n      .where(and(eq(qrTokens.employeeId, employeeId), eq(qrTokens.isActive, true)));\n    return result[0];\n  }\n\n  async getQrTokensByEmployee(employeeId: string): Promise<QrToken[]> {\n    return await this.db.select().from(qrTokens).where(eq(qrTokens.employeeId, employeeId));\n  }\n\n  async createQrToken(insertToken: InsertQrToken): Promise<QrToken> {\n    // Deactivate existing tokens for this employee\n    await this.db.update(qrTokens)\n      .set({ isActive: false })\n      .where(eq(qrTokens.employeeId, insertToken.employeeId));\n\n    const result = await this.db.insert(qrTokens).values(insertToken).returning();\n    return result[0];\n  }\n\n  async validateQrToken(employeeId: string, token: string): Promise<boolean> {\n    const qrToken = await this.getQrToken(employeeId);\n    return qrToken ? qrToken.token === token && qrToken.isActive : false;\n  }\n\n  // Compatibility methods\n  async getLeaveRequests(): Promise<LeaveRequest[]> {\n    return this.getAllLeaveRequests();\n  }\n\n  // Leave Reminder methods\n  async getLeaveReminder(leaveRequestId: string, reminderType: string): Promise<LeaveReminder | undefined> {\n    const reminderId = `${leaveRequestId}_${reminderType}`;\n    const result = await this.db.select().from(leaveReminders).where(eq(leaveReminders.id, reminderId));\n    return result[0];\n  }\n\n  async getLeaveReminders(): Promise<LeaveReminder[]> {\n    return await this.db.select().from(leaveReminders);\n  }\n\n  async saveLeaveReminder(reminder: InsertLeaveReminder): Promise<LeaveReminder> {\n    const result = await this.db.insert(leaveReminders).values(reminder).returning();\n    return result[0];\n  }\n\n  // Leave Balance methods\n  async getLeaveBalances(): Promise<LeaveBalance[]> {\n    return await this.db.select().from(leaveBalances);\n  }\n\n  async getLeaveBalanceByEmployee(employeeId: string, year?: number): Promise<LeaveBalance | undefined> {\n    const currentYear = year || new Date().getFullYear();\n    const result = await this.db.select().from(leaveBalances)\n      .where(and(eq(leaveBalances.employeeId, employeeId), eq(leaveBalances.year, currentYear)));\n    return result[0];\n  }\n\n  async createLeaveBalance(balance: InsertLeaveBalance): Promise<LeaveBalance> {\n    const result = await this.db.insert(leaveBalances).values(balance).returning();\n    return result[0];\n  }\n\n  async updateLeaveBalance(id: string, balance: Partial<InsertLeaveBalance>): Promise<LeaveBalance | undefined> {\n    const result = await this.db.update(leaveBalances).set(balance).where(eq(leaveBalances.id, id)).returning();\n    return result[0];\n  }\n\n  async calculateLeaveEligibility(employeeId: string): Promise<{ eligible: boolean; daysEarned: number; nextEligibleDate: string | null }> {\n    // Implementasi perhitungan cuti berdasarkan kebijakan perusahaan\n    // 70 hari kerja = 14 hari cuti, 35 hari kerja = 7 hari cuti\n    \n    const currentYear = new Date().getFullYear();\n    const balance = await this.getLeaveBalanceByEmployee(employeeId, currentYear);\n    \n    if (!balance) {\n      return { eligible: false, daysEarned: 0, nextEligibleDate: null };\n    }\n\n    const workingDays = balance.workingDaysCompleted;\n    let daysEarned = 0;\n    \n    // Hitung cuti berdasarkan hari kerja\n    if (workingDays >= 70) {\n      daysEarned = Math.floor(workingDays / 70) * 14;\n      const remainder = workingDays % 70;\n      if (remainder >= 35) {\n        daysEarned += 7;\n      }\n    } else if (workingDays >= 35) {\n      daysEarned = 7;\n    }\n\n    const nextEligibleWorkDays = workingDays < 35 ? 35 : (Math.floor(workingDays / 35) + 1) * 35;\n    const daysUntilEligible = nextEligibleWorkDays - workingDays;\n    \n    const nextEligibleDate = new Date();\n    nextEligibleDate.setDate(nextEligibleDate.getDate() + daysUntilEligible);\n\n    return {\n      eligible: daysEarned > balance.usedDays,\n      daysEarned,\n      nextEligibleDate: daysUntilEligible > 0 ? nextEligibleDate.toISOString().split('T')[0] : null\n    };\n  }\n\n  // Leave History methods\n  async getLeaveHistory(): Promise<LeaveHistory[]> {\n    return await this.db.select().from(leaveHistory);\n  }\n\n  async getLeaveHistoryByEmployee(employeeId: string): Promise<LeaveHistory[]> {\n    return await this.db.select().from(leaveHistory).where(eq(leaveHistory.employeeId, employeeId));\n  }\n\n  async createLeaveHistory(history: InsertLeaveHistory): Promise<LeaveHistory> {\n    const result = await this.db.insert(leaveHistory).values(history).returning();\n    return result[0];\n  }\n\n  // Bulk upload methods\n  async bulkUploadLeaveRoster(data: Array<{ nik: string; leaveType: string; startDate: string; endDate: string; totalDays: number }>): Promise<{ success: number; errors: string[] }> {\n    const errors: string[] = [];\n    let successCount = 0;\n\n    try {\n      // Batch fetch all employees at once to avoid N+1 queries\n      const allEmployees = await this.getAllEmployees();\n      const employeeMap = new Map(allEmployees.map(emp => [emp.id, emp]));\n\n      // Batch fetch all existing leave balances\n      const currentYear = new Date().getFullYear();\n      const allBalances = await db.select().from(leaveBalances).where(eq(leaveBalances.year, currentYear));\n      const balanceMap = new Map(allBalances.map(balance => [balance.employeeId, balance]));\n\n      // Prepare data for bulk operations\n      const validItems: Array<{\n        item: typeof data[0];\n        employee: any;\n        rowIndex: number;\n      }> = [];\n\n      // Pre-validate all data\n      for (let i = 0; i < data.length; i++) {\n        const item = data[i];\n        \n        // Validasi employee exists\n        const employee = employeeMap.get(item.nik);\n        if (!employee) {\n          errors.push(`Baris ${i + 1}: Karyawan dengan NIK ${item.nik} tidak ditemukan`);\n          continue;\n        }\n\n        // Validasi format tanggal\n        const startDate = new Date(item.startDate);\n        const endDate = new Date(item.endDate);\n        \n        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {\n          errors.push(`Baris ${i + 1}: Format tanggal tidak valid`);\n          continue;\n        }\n\n        if (startDate > endDate) {\n          errors.push(`Baris ${i + 1}: Tanggal mulai tidak boleh lebih besar dari tanggal selesai`);\n          continue;\n        }\n\n        validItems.push({ item, employee, rowIndex: i + 1 });\n      }\n\n      // Process items in smaller batches for better performance\n      const BATCH_SIZE = 50;\n      const batches = [];\n      for (let i = 0; i < validItems.length; i += BATCH_SIZE) {\n        batches.push(validItems.slice(i, i + BATCH_SIZE));\n      }\n\n      for (const batch of batches) {\n        // Create leave requests for this batch\n        const leaveRequests = await Promise.all(\n          batch.map(({ item, employee }) =>\n            this.createLeaveRequest({\n              employeeId: item.nik,\n              employeeName: employee.name,\n              phoneNumber: employee.phone,\n              startDate: item.startDate,\n              endDate: item.endDate,\n              leaveType: item.leaveType,\n              reason: 'Bulk upload roster cuti',\n              status: 'approved'\n            })\n          )\n        );\n\n        // Process balances and histories for this batch\n        const batchOperations: Array<Promise<any>> = [];\n\n        for (let i = 0; i < batch.length; i++) {\n          const { item } = batch[i];\n          const leaveRequest = leaveRequests[i];\n\n          let balance = balanceMap.get(item.nik);\n          let balanceBeforeLeave = 14;\n          let balanceAfterLeave = 14 - item.totalDays;\n\n          if (!balance) {\n            const newBalance = this.createLeaveBalance({\n              employeeId: item.nik,\n              year: currentYear,\n              totalDays: 14,\n              usedDays: item.totalDays,\n              remainingDays: 14 - item.totalDays,\n              workingDaysCompleted: 70,\n              lastLeaveDate: item.endDate\n            });\n            batchOperations.push(newBalance);\n          } else {\n            balanceBeforeLeave = balance.remainingDays;\n            balanceAfterLeave = balance.remainingDays - item.totalDays;\n            \n            const updateBalance = this.updateLeaveBalance(balance.id, {\n              usedDays: balance.usedDays + item.totalDays,\n              remainingDays: balance.remainingDays - item.totalDays,\n              lastLeaveDate: item.endDate\n            });\n            batchOperations.push(updateBalance);\n          }\n\n          // Create leave history\n          const historyCreation = this.createLeaveHistory({\n            employeeId: item.nik,\n            leaveRequestId: leaveRequest.id,\n            leaveType: item.leaveType,\n            startDate: item.startDate,\n            endDate: item.endDate,\n            totalDays: item.totalDays,\n            balanceBeforeLeave,\n            balanceAfterLeave,\n            status: 'taken'\n          });\n          batchOperations.push(historyCreation);\n        }\n\n        // Execute batch operations\n        await Promise.all(batchOperations);\n      }\n\n      successCount = validItems.length;\n\n    } catch (error) {\n      console.error('Error in bulk upload:', error);\n      errors.push(`Error sistem: ${error instanceof Error ? error.message : 'Error tidak diketahui'}`);\n    }\n\n    return { success: successCount, errors };\n  }\n\n\n  // Leave Roster Monitoring methods implementation\n  async getLeaveRosterMonitoring(id: string): Promise<LeaveRosterMonitoring | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(leaveRosterMonitoring)\n      .where(eq(leaveRosterMonitoring.id, id));\n    return result;\n  }\n\n  async getLeaveRosterMonitoringByNik(nik: string): Promise<LeaveRosterMonitoring | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(leaveRosterMonitoring)\n      .where(eq(leaveRosterMonitoring.nik, nik));\n    return result;\n  }\n\n  async getAllLeaveRosterMonitoring(): Promise<LeaveRosterMonitoring[]> {\n    return await this.db\n      .select()\n      .from(leaveRosterMonitoring)\n      .orderBy(drizzleSql`created_at DESC`);\n  }\n\n  async getLeaveRosterMonitoringByStatus(status: string): Promise<LeaveRosterMonitoring[]> {\n    return await this.db\n      .select()\n      .from(leaveRosterMonitoring)\n      .where(eq(leaveRosterMonitoring.status, status))\n      .orderBy(drizzleSql`created_at DESC`);\n  }\n\n  async createLeaveRosterMonitoring(monitoring: InsertLeaveRosterMonitoring): Promise<LeaveRosterMonitoring> {\n    const [result] = await this.db\n      .insert(leaveRosterMonitoring)\n      .values(monitoring)\n      .returning();\n    return result;\n  }\n\n  async updateLeaveRosterMonitoring(id: string, monitoring: Partial<InsertLeaveRosterMonitoring>): Promise<LeaveRosterMonitoring | undefined> {\n    const [result] = await this.db\n      .update(leaveRosterMonitoring)\n      .set({ ...monitoring, updatedAt: drizzleSql`now()` })\n      .where(eq(leaveRosterMonitoring.id, id))\n      .returning();\n    return result;\n  }\n\n  async deleteLeaveRosterMonitoring(id: string): Promise<boolean> {\n    const result = await this.db\n      .delete(leaveRosterMonitoring)\n      .where(eq(leaveRosterMonitoring.id, id));\n    return result.rowCount > 0;\n  }\n\n  async deleteAllLeaveRosterMonitoring(): Promise<void> {\n    await this.db.delete(leaveRosterMonitoring);\n  }\n\n  async updateLeaveRosterStatus(): Promise<void> {\n    const today = new Date().toISOString().split('T')[0];\n    const allMonitoring = await this.getAllLeaveRosterMonitoring();\n\n    for (const monitoring of allMonitoring) {\n      let newStatus = monitoring.status;\n      \n      // RUMUS BARU: Terakhir Cuti - Today\n      let monitoringDays = 0;\n      if (monitoring.lastLeaveDate) {\n        const lastLeaveDate = new Date(monitoring.lastLeaveDate);\n        const todayDate = new Date(today);\n        // Rumus baru: Terakhir Cuti - Today\n        const diffTime = lastLeaveDate.getTime() - todayDate.getTime();\n        monitoringDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));\n        \n        console.log(`[${monitoring.nik}] monitoringDays: ${monitoringDays} (${monitoringDays > 0 ? 'hari lagi' : monitoringDays < 0 ? 'sudah lewat' : 'hari ini'}), lastLeave=${monitoring.lastLeaveDate}`);\n      }\n\n      // Status berdasarkan rumus baru: Terakhir Cuti - Today\n      console.log(`[${monitoring.nik}] Status check - monitoring days: ${monitoringDays}, current status: ${monitoring.status}`);\n      \n      // Aturan status baru:\n      if (monitoringDays <= 10 && monitoringDays >= 0) {\n        newStatus = \"Menunggu Cuti\";\n        console.log(`[${monitoring.nik}] Set to Menunggu Cuti - ${monitoringDays} hari lagi menuju cuti`);\n      } else if (monitoringDays > 10) {\n        newStatus = \"Aktif\";\n        console.log(`[${monitoring.nik}] Set to Aktif - masih ${monitoringDays} hari lagi`);\n      } else if (monitoringDays < 0) {\n        newStatus = \"Cuti Selesai\";\n        console.log(`[${monitoring.nik}] Set to Cuti Selesai - sudah lewat ${Math.abs(monitoringDays)} hari`);\n      }\n\n      await this.updateLeaveRosterMonitoring(monitoring.id, {\n        status: newStatus,\n        monitoringDays\n      });\n    }\n  }\n\n  // Meeting methods implementation\n  async getMeeting(id: string): Promise<Meeting | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(meetings)\n      .where(eq(meetings.id, id));\n    return result;\n  }\n\n  async getAllMeetings(): Promise<Meeting[]> {\n    return await this.db\n      .select()\n      .from(meetings)\n      .orderBy(drizzleSql`created_at DESC`);\n  }\n\n  async getMeetingsByDate(date: string): Promise<Meeting[]> {\n    return await this.db\n      .select()\n      .from(meetings)\n      .where(eq(meetings.date, date))\n      .orderBy(drizzleSql`start_time ASC`);\n  }\n\n  async createMeeting(meeting: InsertMeeting): Promise<Meeting> {\n    // Generate unique QR token for the meeting\n    const qrToken = randomUUID().replace(/-/g, '').substring(0, 12);\n    const meetingWithToken = { ...meeting, qrToken };\n    \n    const [result] = await this.db\n      .insert(meetings)\n      .values(meetingWithToken)\n      .returning();\n    return result;\n  }\n\n  async updateMeeting(id: string, meeting: Partial<InsertMeeting>): Promise<Meeting | undefined> {\n    const [result] = await this.db\n      .update(meetings)\n      .set({ ...meeting, updatedAt: drizzleSql`now()` })\n      .where(eq(meetings.id, id))\n      .returning();\n    return result;\n  }\n\n  async deleteMeeting(id: string): Promise<boolean> {\n    const result = await this.db\n      .delete(meetings)\n      .where(eq(meetings.id, id));\n    return result.rowCount > 0;\n  }\n\n  async getMeetingByQrToken(qrToken: string): Promise<Meeting | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(meetings)\n      .where(eq(meetings.qrToken, qrToken));\n    return result;\n  }\n\n  // Meeting attendance methods implementation\n  async getMeetingAttendance(meetingId: string): Promise<MeetingAttendance[]> {\n    return await this.db\n      .select()\n      .from(meetingAttendance)\n      .where(eq(meetingAttendance.meetingId, meetingId))\n      .orderBy(drizzleSql`created_at ASC`);\n  }\n\n  async createMeetingAttendance(attendance: InsertMeetingAttendance): Promise<MeetingAttendance> {\n    const [result] = await this.db\n      .insert(meetingAttendance)\n      .values(attendance)\n      .returning();\n    return result;\n  }\n\n  async checkMeetingAttendance(meetingId: string, employeeId: string): Promise<MeetingAttendance | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(meetingAttendance)\n      .where(and(\n        eq(meetingAttendance.meetingId, meetingId),\n        eq(meetingAttendance.employeeId, employeeId)\n      ));\n    return result;\n  }\n\n  async deleteMeetingAttendance(attendanceId: string): Promise<boolean> {\n    const result = await this.db\n      .delete(meetingAttendance)\n      .where(eq(meetingAttendance.id, attendanceId));\n    return result.rowCount > 0;\n  }\n\n  // SIMPER Monitoring methods implementation for DrizzleStorage\n  async getSimperMonitoring(id: string): Promise<SimperMonitoring | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(simperMonitoring)\n      .where(eq(simperMonitoring.id, id));\n    return result;\n  }\n\n  async getSimperMonitoringByNik(nik: string): Promise<SimperMonitoring | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(simperMonitoring)\n      .where(eq(simperMonitoring.nik, nik));\n    return result;\n  }\n\n  async getAllSimperMonitoring(): Promise<SimperMonitoring[]> {\n    return await this.db\n      .select()\n      .from(simperMonitoring)\n      .orderBy(drizzleSql`created_at DESC`);\n  }\n\n  async createSimperMonitoring(simperData: InsertSimperMonitoring): Promise<SimperMonitoring> {\n    const [result] = await this.db\n      .insert(simperMonitoring)\n      .values(simperData)\n      .returning();\n    return result;\n  }\n\n  async updateSimperMonitoring(id: string, simperData: Partial<InsertSimperMonitoring>): Promise<SimperMonitoring | undefined> {\n    const [result] = await this.db\n      .update(simperMonitoring)\n      .set({\n        ...simperData,\n        updatedAt: new Date()\n      })\n      .where(eq(simperMonitoring.id, id))\n      .returning();\n    return result;\n  }\n\n  async deleteSimperMonitoring(id: string): Promise<boolean> {\n    const result = await this.db\n      .delete(simperMonitoring)\n      .where(eq(simperMonitoring.id, id));\n    return result.rowCount > 0;\n  }\n\n  async deleteAllSimperMonitoring(): Promise<void> {\n    await this.db.delete(simperMonitoring);\n  }\n\n  async bulkUploadSimperData(data: Array<{ employeeName: string; nik: string; simperBibExpiredDate?: string; simperTiaExpiredDate?: string }>): Promise<{ success: number; errors: string[] }> {\n    const errors: string[] = [];\n    let success = 0;\n\n    console.log(`ðŸ“¤ Starting bulk upload of ${data.length} SIMPER records`);\n\n    for (let index = 0; index < data.length; index++) {\n      const item = data[index];\n      try {\n        if (!item.employeeName || !item.nik) {\n          const error = `Data tidak lengkap untuk baris ${index + 1} - Name: \"${item.employeeName}\", NIK: \"${item.nik}\"`;\n          errors.push(error);\n          console.log(`âŒ ${error}`);\n          continue;\n        }\n\n        // Trim and validate data\n        const cleanName = item.employeeName.trim();\n        const cleanNik = item.nik.trim();\n\n        if (!cleanName || !cleanNik) {\n          const error = `Data kosong setelah trim untuk baris ${index + 1}`;\n          errors.push(error);\n          console.log(`âŒ ${error}`);\n          continue;\n        }\n\n        // Check if NIK already exists\n        const existing = await this.getSimperMonitoringByNik(cleanNik);\n        \n        const simperData = {\n          employeeName: cleanName,\n          simperBibExpiredDate: item.simperBibExpiredDate || null,\n          simperTiaExpiredDate: item.simperTiaExpiredDate || null\n        };\n\n        if (existing) {\n          // Update existing record\n          console.log(`ðŸ”„ Updating existing SIMPER for ${cleanName} (${cleanNik})`);\n          await this.updateSimperMonitoring(existing.id, simperData);\n        } else {\n          // Create new record\n          console.log(`âž• Creating new SIMPER for ${cleanName} (${cleanNik})`);\n          await this.createSimperMonitoring({\n            ...simperData,\n            nik: cleanNik\n          });\n        }\n        \n        success++;\n        console.log(`âœ… Processed ${cleanName} (${cleanNik}) - BIB: ${item.simperBibExpiredDate || 'Kosong'}, TIA: ${item.simperTiaExpiredDate || 'Kosong'}`);\n        \n      } catch (error) {\n        const errorMsg = `Error untuk NIK ${item.nik} (baris ${index + 1}): ${error}`;\n        errors.push(errorMsg);\n        console.error(`âŒ ${errorMsg}`);\n      }\n    }\n\n    console.log(`ðŸ“Š Bulk upload completed: ${success} success, ${errors.length} errors`);\n    return { success, errors };\n  }\n\n  // ============================================\n  // SIDAK FATIGUE METHODS\n  // ============================================\n\n  async getSidakFatigueSession(id: string): Promise<SidakFatigueSession | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(sidakFatigueSessions)\n      .where(eq(sidakFatigueSessions.id, id));\n    return result;\n  }\n\n  async getAllSidakFatigueSessions(): Promise<SidakFatigueSession[]> {\n    return await this.db\n      .select()\n      .from(sidakFatigueSessions)\n      .orderBy(drizzleSql`created_at DESC`);\n  }\n\n  async createSidakFatigueSession(sessionData: InsertSidakFatigueSession): Promise<SidakFatigueSession> {\n    const [result] = await this.db\n      .insert(sidakFatigueSessions)\n      .values(sessionData)\n      .returning();\n    return result;\n  }\n\n  async deleteSidakFatigueSession(id: string): Promise<boolean> {\n    const result = await this.db\n      .delete(sidakFatigueSessions)\n      .where(eq(sidakFatigueSessions.id, id));\n    return result.rowCount > 0;\n  }\n\n  async getSidakFatigueRecords(sessionId: string): Promise<SidakFatigueRecord[]> {\n    return await this.db\n      .select()\n      .from(sidakFatigueRecords)\n      .where(eq(sidakFatigueRecords.sessionId, sessionId))\n      .orderBy(drizzleSql`created_at ASC`);\n  }\n\n  async getSidakFatigueRecordsBySessionIds(sessionIds: string[]): Promise<SidakFatigueRecord[]> {\n    if (sessionIds.length === 0) {\n      return [];\n    }\n    return await this.db\n      .select()\n      .from(sidakFatigueRecords)\n      .where(inArray(sidakFatigueRecords.sessionId, sessionIds))\n      .orderBy(drizzleSql`created_at ASC`);\n  }\n\n  async createSidakFatigueRecord(recordData: InsertSidakFatigueRecord): Promise<SidakFatigueRecord> {\n    // Retry-based optimistic locking pattern (neon-http driver doesn't support transactions)\n    // Unique constraint on (sessionId, ordinal) prevents duplicates\n    // Note: totalSampel is calculated on-demand from COUNT(*) to avoid partial-update issues\n    const MAX_RETRIES = 3;\n    let lastError: any;\n    \n    for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {\n      try {\n        // Get next ordinal (MAX + 1)\n        const maxOrdinalResult = await this.db\n          .select({ max: drizzleSql<number>`COALESCE(MAX(ordinal), 0)` })\n          .from(sidakFatigueRecords)\n          .where(eq(sidakFatigueRecords.sessionId, recordData.sessionId));\n        \n        const nextOrdinal = (maxOrdinalResult[0]?.max || 0) + 1;\n        \n        // Check limit before insert\n        if (nextOrdinal > 20) {\n          throw new Error('Maksimal 20 karyawan per Sidak Fatigue session');\n        }\n\n        // Insert with ordinal - unique constraint catches race conditions\n        const [result] = await this.db\n          .insert(sidakFatigueRecords)\n          .values({ ...recordData, ordinal: nextOrdinal })\n          .returning();\n\n        return result;\n      } catch (error: any) {\n        lastError = error;\n        \n        // Retry on unique constraint violation (concurrent insert to same ordinal)\n        if (error?.code === '23505' && attempt < MAX_RETRIES - 1) {\n          // Wait briefly before retry (exponential backoff)\n          await new Promise(resolve => setTimeout(resolve, 50 * Math.pow(2, attempt)));\n          continue;\n        }\n        \n        // If max limit reached or other error, throw\n        if (error?.code === '23505') {\n          throw new Error('Maksimal 20 karyawan per Sidak Fatigue session (concurrent limit reached)');\n        }\n        throw error;\n      }\n    }\n    \n    // If all retries exhausted\n    throw new Error(`Gagal menambahkan karyawan setelah ${MAX_RETRIES} percobaan: ${lastError?.message || 'Unknown error'}`);\n  }\n\n  async getSidakFatigueObservers(sessionId: string): Promise<SidakFatigueObserver[]> {\n    return await this.db\n      .select()\n      .from(sidakFatigueObservers)\n      .where(eq(sidakFatigueObservers.sessionId, sessionId))\n      .orderBy(drizzleSql`created_at ASC`);\n  }\n\n  async createSidakFatigueObserver(observerData: InsertSidakFatigueObserver): Promise<SidakFatigueObserver> {\n    const [result] = await this.db\n      .insert(sidakFatigueObservers)\n      .values(observerData)\n      .returning();\n    return result;\n  }\n\n  // ============================================\n  // SIDAK ROSTER METHODS\n  // ============================================\n\n  async getSidakRosterSession(id: string): Promise<SidakRosterSession | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(sidakRosterSessions)\n      .where(eq(sidakRosterSessions.id, id));\n    return result;\n  }\n\n  async getAllSidakRosterSessions(): Promise<SidakRosterSession[]> {\n    return await this.db\n      .select()\n      .from(sidakRosterSessions)\n      .orderBy(drizzleSql`created_at DESC`);\n  }\n\n  async createSidakRosterSession(sessionData: InsertSidakRosterSession): Promise<SidakRosterSession> {\n    const [result] = await this.db\n      .insert(sidakRosterSessions)\n      .values(sessionData)\n      .returning();\n    return result;\n  }\n\n  async deleteSidakRosterSession(id: string): Promise<boolean> {\n    const result = await this.db\n      .delete(sidakRosterSessions)\n      .where(eq(sidakRosterSessions.id, id));\n    return result.rowCount > 0;\n  }\n\n  async getSidakRosterRecords(sessionId: string): Promise<SidakRosterRecord[]> {\n    return await this.db\n      .select()\n      .from(sidakRosterRecords)\n      .where(eq(sidakRosterRecords.sessionId, sessionId))\n      .orderBy(drizzleSql`created_at ASC`);\n  }\n\n  async createSidakRosterRecord(recordData: InsertSidakRosterRecord): Promise<SidakRosterRecord> {\n    // Retry-based optimistic locking pattern (neon-http driver doesn't support transactions)\n    // Unique constraint on (sessionId, ordinal) prevents duplicates\n    // Note: totalSampel is calculated on-demand from COUNT(*) to avoid partial-update issues\n    const MAX_RETRIES = 3;\n    let lastError: any;\n    \n    for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {\n      try {\n        // Get next ordinal (MAX + 1)\n        const maxOrdinalResult = await this.db\n          .select({ max: drizzleSql<number>`COALESCE(MAX(ordinal), 0)` })\n          .from(sidakRosterRecords)\n          .where(eq(sidakRosterRecords.sessionId, recordData.sessionId));\n        \n        const nextOrdinal = (maxOrdinalResult[0]?.max || 0) + 1;\n        \n        // Check limit before insert\n        if (nextOrdinal > 15) {\n          throw new Error('Maksimal 15 karyawan per Sidak Roster session');\n        }\n\n        // Insert with ordinal - unique constraint catches race conditions\n        const [result] = await this.db\n          .insert(sidakRosterRecords)\n          .values({ ...recordData, ordinal: nextOrdinal })\n          .returning();\n\n        return result;\n      } catch (error: any) {\n        lastError = error;\n        \n        // Retry on unique constraint violation (concurrent insert to same ordinal)\n        if (error?.code === '23505' && attempt < MAX_RETRIES - 1) {\n          // Wait briefly before retry (exponential backoff)\n          await new Promise(resolve => setTimeout(resolve, 50 * Math.pow(2, attempt)));\n          continue;\n        }\n        \n        // If max limit reached or other error, throw\n        if (error?.code === '23505') {\n          throw new Error('Maksimal 15 karyawan per Sidak Roster session (concurrent limit reached)');\n        }\n        throw error;\n      }\n    }\n    \n    // If all retries exhausted\n    throw new Error(`Gagal menambahkan karyawan setelah ${MAX_RETRIES} percobaan: ${lastError?.message || 'Unknown error'}`);\n  }\n\n  async getSidakRosterObservers(sessionId: string): Promise<SidakRosterObserver[]> {\n    return await this.db\n      .select()\n      .from(sidakRosterObservers)\n      .where(eq(sidakRosterObservers.sessionId, sessionId))\n      .orderBy(drizzleSql`created_at ASC`);\n  }\n\n  async createSidakRosterObserver(observerData: InsertSidakRosterObserver): Promise<SidakRosterObserver> {\n    const [result] = await this.db\n      .insert(sidakRosterObservers)\n      .values(observerData)\n      .returning();\n    return result;\n  }\n\n  // Announcement methods\n  async getAnnouncement(id: string): Promise<Announcement | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(announcements)\n      .where(eq(announcements.id, id));\n    return result;\n  }\n\n  async getAllAnnouncements(): Promise<Announcement[]> {\n    return await this.db\n      .select()\n      .from(announcements)\n      .orderBy(drizzleSql`created_at DESC`);\n  }\n\n  async getActiveAnnouncements(): Promise<Announcement[]> {\n    return await this.db\n      .select()\n      .from(announcements)\n      .where(eq(announcements.isActive, true))\n      .orderBy(drizzleSql`created_at DESC`);\n  }\n\n  async createAnnouncement(announcementData: InsertAnnouncement): Promise<Announcement> {\n    const [result] = await this.db\n      .insert(announcements)\n      .values(announcementData)\n      .returning();\n    return result;\n  }\n\n  async updateAnnouncement(id: string, announcementData: Partial<InsertAnnouncement>): Promise<Announcement | undefined> {\n    const [result] = await this.db\n      .update(announcements)\n      .set(announcementData)\n      .where(eq(announcements.id, id))\n      .returning();\n    return result;\n  }\n\n  async deleteAnnouncement(id: string): Promise<boolean> {\n    const result = await this.db\n      .delete(announcements)\n      .where(eq(announcements.id, id));\n    return true;\n  }\n\n  async getAnnouncementReads(announcementId: string): Promise<(AnnouncementRead & { employeePosition?: string | null })[]> {\n    const reads = await this.db\n      .select({\n        id: announcementReads.id,\n        announcementId: announcementReads.announcementId,\n        employeeId: announcementReads.employeeId,\n        employeeName: announcementReads.employeeName,\n        readAt: announcementReads.readAt,\n        employeePosition: employees.position,\n      })\n      .from(announcementReads)\n      .leftJoin(employees, eq(announcementReads.employeeId, employees.id))\n      .where(eq(announcementReads.announcementId, announcementId))\n      .orderBy(drizzleSql`${announcementReads.readAt} DESC`);\n    return reads;\n  }\n\n  async markAnnouncementAsRead(announcementId: string, employeeId: string, employeeName: string): Promise<AnnouncementRead> {\n    // Use upsert to handle duplicate reads gracefully\n    const [result] = await this.db\n      .insert(announcementReads)\n      .values({ announcementId, employeeId, employeeName })\n      .onConflictDoNothing()\n      .returning();\n    \n    // If conflict (already read), fetch the existing record\n    if (!result) {\n      const [existing] = await this.db\n        .select()\n        .from(announcementReads)\n        .where(and(\n          eq(announcementReads.announcementId, announcementId),\n          eq(announcementReads.employeeId, employeeId)\n        ));\n      return existing;\n    }\n    return result;\n  }\n\n  async getUnreadAnnouncementsCount(employeeId: string): Promise<number> {\n    // Get active announcements that the employee hasn't read\n    const activeAnnouncements = await this.getActiveAnnouncements();\n    const readAnnouncements = await this.db\n      .select({ announcementId: announcementReads.announcementId })\n      .from(announcementReads)\n      .where(eq(announcementReads.employeeId, employeeId));\n    \n    const readIds = new Set(readAnnouncements.map(r => r.announcementId));\n    const unreadCount = activeAnnouncements.filter(a => !readIds.has(a.id)).length;\n    return unreadCount;\n  }\n\n  async hasReadAnnouncement(announcementId: string, employeeId: string): Promise<boolean> {\n    const [result] = await this.db\n      .select()\n      .from(announcementReads)\n      .where(and(\n        eq(announcementReads.announcementId, announcementId),\n        eq(announcementReads.employeeId, employeeId)\n      ));\n    return !!result;\n  }\n\n  // Document methods\n  async getDocument(id: string): Promise<Document | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(documents)\n      .where(eq(documents.id, id));\n    return result;\n  }\n\n  async getAllDocuments(): Promise<Document[]> {\n    return await this.db\n      .select()\n      .from(documents)\n      .orderBy(documents.createdAt);\n  }\n\n  async getDocumentsByCategory(category: string): Promise<Document[]> {\n    return await this.db\n      .select()\n      .from(documents)\n      .where(and(eq(documents.category, category), eq(documents.isActive, true)))\n      .orderBy(documents.createdAt);\n  }\n\n  async getActiveDocuments(): Promise<Document[]> {\n    return await this.db\n      .select()\n      .from(documents)\n      .where(eq(documents.isActive, true))\n      .orderBy(documents.createdAt);\n  }\n\n  async createDocument(document: InsertDocument): Promise<Document> {\n    const [result] = await this.db\n      .insert(documents)\n      .values(document)\n      .returning();\n    return result;\n  }\n\n  async updateDocument(id: string, document: Partial<InsertDocument>): Promise<Document | undefined> {\n    const [result] = await this.db\n      .update(documents)\n      .set({ ...document, updatedAt: new Date() })\n      .where(eq(documents.id, id))\n      .returning();\n    return result;\n  }\n\n  async deleteDocument(id: string): Promise<boolean> {\n    const result = await this.db\n      .delete(documents)\n      .where(eq(documents.id, id))\n      .returning();\n    return result.length > 0;\n  }\n\n  // News methods\n  async getNews(id: string): Promise<News | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(news)\n      .where(eq(news.id, id));\n    return result;\n  }\n\n  async getAllNews(): Promise<News[]> {\n    return await this.db\n      .select()\n      .from(news)\n      .orderBy(news.createdAt);\n  }\n\n  async getActiveNews(): Promise<News[]> {\n    return await this.db\n      .select()\n      .from(news)\n      .where(eq(news.isActive, true))\n      .orderBy(news.createdAt);\n  }\n\n  async createNews(newsItem: InsertNews): Promise<News> {\n    const [result] = await this.db\n      .insert(news)\n      .values(newsItem)\n      .returning();\n    return result;\n  }\n\n  async updateNews(id: string, newsItem: Partial<InsertNews>): Promise<News | undefined> {\n    const [result] = await this.db\n      .update(news)\n      .set({ ...newsItem, updatedAt: new Date() })\n      .where(eq(news.id, id))\n      .returning();\n    return result;\n  }\n\n  async deleteNews(id: string): Promise<boolean> {\n    const result = await this.db\n      .delete(news)\n      .where(eq(news.id, id))\n      .returning();\n    return result.length > 0;\n  }\n\n  // Push subscription methods\n  async getPushSubscription(id: string): Promise<PushSubscription | undefined> {\n    const [result] = await this.db\n      .select()\n      .from(pushSubscriptions)\n      .where(eq(pushSubscriptions.id, id));\n    return result;\n  }\n\n  async getPushSubscriptionsByEmployee(employeeId: string): Promise<PushSubscription[]> {\n    return await this.db\n      .select()\n      .from(pushSubscriptions)\n      .where(eq(pushSubscriptions.employeeId, employeeId));\n  }\n\n  async getActivePushSubscriptions(): Promise<PushSubscription[]> {\n    return await this.db\n      .select()\n      .from(pushSubscriptions)\n      .where(eq(pushSubscriptions.isActive, true));\n  }\n\n  async createPushSubscription(subscription: InsertPushSubscription): Promise<PushSubscription> {\n    const [result] = await this.db\n      .insert(pushSubscriptions)\n      .values(subscription)\n      .returning();\n    return result;\n  }\n\n  async updatePushSubscription(id: string, subscription: Partial<InsertPushSubscription>): Promise<PushSubscription | undefined> {\n    const [result] = await this.db\n      .update(pushSubscriptions)\n      .set(subscription)\n      .where(eq(pushSubscriptions.id, id))\n      .returning();\n    return result;\n  }\n\n  async deletePushSubscription(id: string): Promise<boolean> {\n    const result = await this.db\n      .delete(pushSubscriptions)\n      .where(eq(pushSubscriptions.id, id))\n      .returning();\n    return result.length > 0;\n  }\n\n  async deletePushSubscriptionByEndpoint(endpoint: string): Promise<boolean> {\n    const result = await this.db\n      .delete(pushSubscriptions)\n      .where(eq(pushSubscriptions.endpoint, endpoint))\n      .returning();\n    return result.length > 0;\n  }\n}\n\n// Use DrizzleStorage for PostgreSQL database\nexport const storage = new DrizzleStorage();\n","path":null,"size_bytes":84888,"size_tokens":null},"client/src/components/sidak/signature-pad.tsx":{"content":"import { useRef, useEffect, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Eraser, RotateCcw, Check } from \"lucide-react\";\n\ninterface SignaturePadProps {\n  onSave: (dataUrl: string) => void;\n  onClear?: () => void;\n  disabled?: boolean;\n  title?: string;\n}\n\nexport function SignaturePad({ onSave, onClear, disabled = false, title = \"Tanda Tangan Digital\" }: SignaturePadProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [isDrawing, setIsDrawing] = useState(false);\n  const [hasSignature, setHasSignature] = useState(false);\n  const [context, setContext] = useState<CanvasRenderingContext2D | null>(null);\n\n  useEffect(() => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    // Set canvas size based on container\n    const resizeCanvas = () => {\n      const rect = canvas.getBoundingClientRect();\n      canvas.width = rect.width * window.devicePixelRatio;\n      canvas.height = rect.height * window.devicePixelRatio;\n      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);\n      \n      // Canvas settings\n      ctx.strokeStyle = '#000000';\n      ctx.lineWidth = 2;\n      ctx.lineCap = 'round';\n      ctx.lineJoin = 'round';\n    };\n\n    resizeCanvas();\n    setContext(ctx);\n\n    window.addEventListener('resize', resizeCanvas);\n    return () => window.removeEventListener('resize', resizeCanvas);\n  }, []);\n\n  const startDrawing = (e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\n    if (disabled || !context) return;\n    \n    setIsDrawing(true);\n    const pos = getPosition(e);\n    context.beginPath();\n    context.moveTo(pos.x, pos.y);\n  };\n\n  const draw = (e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\n    if (!isDrawing || !context) return;\n    \n    e.preventDefault();\n    const pos = getPosition(e);\n    context.lineTo(pos.x, pos.y);\n    context.stroke();\n    setHasSignature(true);\n  };\n\n  const stopDrawing = () => {\n    if (!context) return;\n    setIsDrawing(false);\n    context.closePath();\n  };\n\n  const getPosition = (e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {\n    const canvas = canvasRef.current;\n    if (!canvas) return { x: 0, y: 0 };\n\n    const rect = canvas.getBoundingClientRect();\n    const scaleX = canvas.width / (rect.width * window.devicePixelRatio);\n    const scaleY = canvas.height / (rect.height * window.devicePixelRatio);\n\n    if ('touches' in e) {\n      // Touch event\n      const touch = e.touches[0];\n      return {\n        x: (touch.clientX - rect.left) * scaleX,\n        y: (touch.clientY - rect.top) * scaleY\n      };\n    } else {\n      // Mouse event\n      return {\n        x: (e.clientX - rect.left) * scaleX,\n        y: (e.clientY - rect.top) * scaleY\n      };\n    }\n  };\n\n  const clearSignature = () => {\n    const canvas = canvasRef.current;\n    if (!canvas || !context) return;\n\n    context.clearRect(0, 0, canvas.width, canvas.height);\n    setHasSignature(false);\n    if (onClear) onClear();\n  };\n\n  const saveSignature = () => {\n    const canvas = canvasRef.current;\n    if (!canvas || !hasSignature) return;\n\n    // Convert to data URL (base64 PNG)\n    const dataUrl = canvas.toDataURL('image/png');\n    onSave(dataUrl);\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-lg\">{title}</CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"relative border-2 border-dashed border-gray-300 rounded-lg bg-white\">\n          <canvas\n            ref={canvasRef}\n            className=\"w-full touch-none cursor-crosshair\"\n            style={{ height: '200px' }}\n            onMouseDown={startDrawing}\n            onMouseMove={draw}\n            onMouseUp={stopDrawing}\n            onMouseLeave={stopDrawing}\n            onTouchStart={startDrawing}\n            onTouchMove={draw}\n            onTouchEnd={stopDrawing}\n            data-testid=\"signature-canvas\"\n          />\n          {!hasSignature && (\n            <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none\">\n              <p className=\"text-gray-400 text-sm\">Tanda tangan di sini</p>\n            </div>\n          )}\n        </div>\n\n        <div className=\"flex flex-wrap gap-2\">\n          <Button\n            onClick={clearSignature}\n            variant=\"outline\"\n            disabled={!hasSignature || disabled}\n            className=\"flex-1 min-w-[80px] h-10\"\n            data-testid=\"button-clear-signature\"\n          >\n            <Eraser className=\"w-4 h-4 mr-1 sm:mr-2 flex-shrink-0\" />\n            <span className=\"truncate\">Hapus</span>\n          </Button>\n          <Button\n            onClick={clearSignature}\n            variant=\"outline\"\n            disabled={!hasSignature || disabled}\n            className=\"flex-1 min-w-[80px] h-10\"\n            data-testid=\"button-reset-signature\"\n          >\n            <RotateCcw className=\"w-4 h-4 mr-1 sm:mr-2 flex-shrink-0\" />\n            <span className=\"truncate\">Ulangi</span>\n          </Button>\n          <Button\n            onClick={saveSignature}\n            disabled={!hasSignature || disabled}\n            className=\"flex-1 min-w-[80px] h-10\"\n            data-testid=\"button-save-signature\"\n          >\n            <Check className=\"w-4 h-4 mr-1 sm:mr-2 flex-shrink-0\" />\n            <span className=\"truncate\">Simpan</span>\n          </Button>\n        </div>\n\n        <p className=\"text-xs text-gray-500 text-center\">\n          Gunakan jari atau stylus untuk membuat tanda tangan\n        </p>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":5744,"size_tokens":null},"client/src/pages/sidak.tsx":{"content":"import { Link } from \"wouter\";\nimport { ClipboardCheck, Activity, ClipboardList } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\n\nexport default function SidakDashboard() {\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800\">\n      <div className=\"container max-w-4xl mx-auto p-4 space-y-6\">\n        <div className=\"text-center pt-6 pb-2\">\n          <div className=\"flex items-center justify-center gap-3 mb-3\">\n            <ClipboardCheck className=\"h-10 w-10 text-primary\" />\n            <h1 className=\"text-3xl md:text-4xl font-bold text-gray-900 dark:text-white\">\n              SIDAK\n            </h1>\n          </div>\n          <p className=\"text-gray-600 dark:text-gray-400 text-sm md:text-base\">\n            Sistem Inspeksi Data Karyawan\n          </p>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <Link href=\"/workspace/sidak/fatigue/new\" data-testid=\"link-sidak-fatigue\">\n            <Card className=\"cursor-pointer hover:shadow-xl transition-all duration-300 border-2 hover:border-blue-500 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-950 dark:to-blue-900 h-full\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3 mb-2\">\n                  <div className=\"p-3 bg-blue-500 rounded-xl\">\n                    <Activity className=\"h-8 w-8 text-white\" />\n                  </div>\n                  <CardTitle className=\"text-2xl font-bold text-blue-900 dark:text-blue-100\">\n                    Sidak Fatigue\n                  </CardTitle>\n                </div>\n                <CardDescription className=\"text-sm text-blue-800 dark:text-blue-200\">\n                  Pemeriksaan Kelelahan Karyawan\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-start gap-2 text-sm text-blue-700 dark:text-blue-300\">\n                    <span className=\"font-semibold min-w-[100px]\">Form:</span>\n                    <span className=\"text-xs\">BIB-HSE-ES-F-3.02-16</span>\n                  </div>\n                  <div className=\"flex items-start gap-2 text-sm text-blue-700 dark:text-blue-300\">\n                    <span className=\"font-semibold min-w-[100px]\">Max Sampel:</span>\n                    <span>20 karyawan</span>\n                  </div>\n                  <div className=\"flex items-start gap-2 text-sm text-blue-700 dark:text-blue-300\">\n                    <span className=\"font-semibold min-w-[100px]\">Pemeriksaan:</span>\n                    <span className=\"text-xs\">Jam tidur, konsumsi obat, masalah pribadi, respon, konsentrasi, kesehatan</span>\n                  </div>\n                </div>\n                <Button \n                  className=\"w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold text-lg h-14\"\n                  data-testid=\"button-start-fatigue\"\n                >\n                  Mulai Sidak Fatigue\n                </Button>\n              </CardContent>\n            </Card>\n          </Link>\n\n          <Link href=\"/workspace/sidak/roster/new\" data-testid=\"link-sidak-roster\">\n            <Card className=\"cursor-pointer hover:shadow-xl transition-all duration-300 border-2 hover:border-purple-500 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-950 dark:to-purple-900 h-full\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3 mb-2\">\n                  <div className=\"p-3 bg-purple-500 rounded-xl\">\n                    <ClipboardList className=\"h-8 w-8 text-white\" />\n                  </div>\n                  <CardTitle className=\"text-2xl font-bold text-purple-900 dark:text-purple-100\">\n                    Sidak Roster\n                  </CardTitle>\n                </div>\n                <CardDescription className=\"text-sm text-purple-800 dark:text-purple-200\">\n                  Pemeriksaan Kesesuaian Roster\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-start gap-2 text-sm text-purple-700 dark:text-purple-300\">\n                    <span className=\"font-semibold min-w-[100px]\">Form:</span>\n                    <span className=\"text-xs\">BIB-HSE-PPO-F</span>\n                  </div>\n                  <div className=\"flex items-start gap-2 text-sm text-purple-700 dark:text-purple-300\">\n                    <span className=\"font-semibold min-w-[100px]\">Max Sampel:</span>\n                    <span>15 karyawan</span>\n                  </div>\n                  <div className=\"flex items-start gap-2 text-sm text-purple-700 dark:text-purple-300\">\n                    <span className=\"font-semibold min-w-[100px]\">Pemeriksaan:</span>\n                    <span className=\"text-xs\">Kesesuaian roster dengan jadwal kerja</span>\n                  </div>\n                </div>\n                <Button \n                  className=\"w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-semibold text-lg h-14\"\n                  data-testid=\"button-start-roster\"\n                >\n                  Mulai Sidak Roster\n                </Button>\n              </CardContent>\n            </Card>\n          </Link>\n        </div>\n\n        <Card className=\"border-2 border-gray-200 dark:border-gray-700\">\n          <CardHeader>\n            <CardTitle className=\"text-lg font-semibold text-gray-900 dark:text-white\">\n              Riwayat Sidak\n            </CardTitle>\n            <CardDescription className=\"text-sm\">\n              Lihat history dan hasil inspeksi sebelumnya\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <Link href=\"/workspace/sidak/fatigue/history\" data-testid=\"link-fatigue-history\">\n              <Button variant=\"outline\" className=\"w-full justify-start h-12 text-base\">\n                <Activity className=\"h-5 w-5 mr-3 text-blue-500\" />\n                <span className=\"font-medium\">Riwayat Sidak Fatigue</span>\n              </Button>\n            </Link>\n            <Link href=\"/workspace/sidak/roster/history\" data-testid=\"link-roster-history\">\n              <Button variant=\"outline\" className=\"w-full justify-start h-12 text-base\">\n                <ClipboardList className=\"h-5 w-5 mr-3 text-purple-500\" />\n                <span className=\"font-medium\">Riwayat Sidak Roster</span>\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n\n        <div className=\"bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-200 dark:border-yellow-800 rounded-lg p-4 text-sm text-yellow-800 dark:text-yellow-200\">\n          <div className=\"flex gap-3\">\n            <div className=\"flex-shrink-0 mt-0.5\">\n              <span className=\"text-lg\">â„¹ï¸</span>\n            </div>\n            <div className=\"space-y-1\">\n              <p className=\"font-semibold\">Catatan Penting:</p>\n              <ul className=\"list-disc list-inside space-y-1 text-xs\">\n                <li>Tidak perlu login untuk menggunakan sistem SIDAK</li>\n                <li>Scan QR karyawan untuk mengisi data observer</li>\n                <li>Tanda tangan digital diperlukan untuk validasi</li>\n                <li>Download PDF hasil inspeksi setelah selesai</li>\n              </ul>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":7608,"size_tokens":null},"client/src/pages/sidak-fatigue-form.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Activity, Check, X, ArrowLeft, ArrowRight, Save, Camera, Users, Pen, UserPlus } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation, useQueryClient, useQuery } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { SidakObserverScanner } from \"@/components/sidak/sidak-observer-scanner\";\nimport { SidakEmployeeScanner } from \"@/components/sidak/sidak-employee-scanner\";\nimport { SignaturePad } from \"@/components/sidak/signature-pad\";\nimport { DraftRecoveryDialog } from \"@/components/sidak/draft-recovery-dialog\";\nimport { useSidakDraft } from \"@/hooks/use-sidak-draft\";\nimport type { Employee } from \"@shared/schema\";\n\ninterface EmployeeRecord {\n  employeeId?: string;\n  nama: string;\n  nik: string;\n  jabatan: string;\n  nomorLambung: string;\n  jamTidur: number;\n  konsumiObat: boolean | null;\n  masalahPribadi: boolean | null;\n  pemeriksaanRespon: boolean | null;\n  pemeriksaanKonsentrasi: boolean | null;\n  pemeriksaanKesehatan: boolean | null;\n  karyawanSiapBekerja: boolean | null;\n  fitUntukBekerja: boolean | null;\n  istirahatDanMonitor: boolean | null;\n  istirahatLebihdariSatuJam: boolean | null;\n  tidakBolehBekerja: boolean | null;\n  employeeSignature?: string; // Base64 encoded signature image\n}\n\ninterface Observer {\n  nama: string;\n  nik: string;\n  perusahaan: string;\n  jabatan: string;\n  signatureDataUrl: string;\n}\n\ninterface FatigueDraftData {\n  step: number;\n  sessionId: string | null;\n  headerData: {\n    tanggal: string;\n    shift: string;\n    waktuMulai: string;\n    waktuSelesai: string;\n    lokasi: string;\n    area: string;\n    departemen: string;\n  };\n  employees: EmployeeRecord[];\n  currentEmployee: EmployeeRecord;\n  observers: Observer[];\n  isLoadedFromQr: boolean;\n}\n\nconst initialDraftData: FatigueDraftData = {\n  step: 1,\n  sessionId: null,\n  headerData: {\n    tanggal: new Date().toISOString().split('T')[0],\n    shift: \"Shift 1\",\n    waktuMulai: \"\",\n    waktuSelesai: \"\",\n    lokasi: \"\",\n    area: \"\",\n    departemen: \"\"\n  },\n  employees: [],\n  currentEmployee: {\n    nama: \"\",\n    nik: \"\",\n    jabatan: \"\",\n    nomorLambung: \"\",\n    jamTidur: 0,\n    konsumiObat: null,\n    masalahPribadi: null,\n    pemeriksaanRespon: null,\n    pemeriksaanKonsentrasi: null,\n    pemeriksaanKesehatan: null,\n    karyawanSiapBekerja: null,\n    fitUntukBekerja: null,\n    istirahatDanMonitor: null,\n    istirahatLebihdariSatuJam: null,\n    tidakBolehBekerja: null\n  },\n  observers: [],\n  isLoadedFromQr: false\n};\n\nexport default function SidakFatigueForm() {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const {\n    saveDraft,\n    clearDraft,\n    restoreDraft,\n    ignoreDraft,\n    showRecoveryDialog,\n    draftTimestamp\n  } = useSidakDraft<FatigueDraftData>({\n    key: \"fatigue\",\n    initialData: initialDraftData,\n    debounceMs: 1500\n  });\n  \n  const [step, setStep] = useState(1);\n  const [sessionId, setSessionId] = useState<string | null>(null);\n  \n  const [headerData, setHeaderData] = useState({\n    tanggal: new Date().toISOString().split('T')[0],\n    shift: \"Shift 1\",\n    waktuMulai: \"\",\n    waktuSelesai: \"\",\n    lokasi: \"\",\n    area: \"\",\n    departemen: \"\"\n  });\n  \n  const [employees, setEmployees] = useState<EmployeeRecord[]>([]);\n  const [currentEmployee, setCurrentEmployee] = useState<EmployeeRecord>({\n    nama: \"\",\n    nik: \"\",\n    jabatan: \"\",\n    nomorLambung: \"\",\n    jamTidur: 0,\n    konsumiObat: null,\n    masalahPribadi: null,\n    pemeriksaanRespon: null,\n    pemeriksaanKonsentrasi: null,\n    pemeriksaanKesehatan: null,\n    karyawanSiapBekerja: null,\n    fitUntukBekerja: null,\n    istirahatDanMonitor: null,\n    istirahatLebihdariSatuJam: null,\n    tidakBolehBekerja: null\n  });\n  \n  const [observers, setObservers] = useState<Observer[]>([]);\n  const [showScanner, setShowScanner] = useState(false);\n  const [showEmployeeScanner, setShowEmployeeScanner] = useState(false);\n  const [isLoadedFromQr, setIsLoadedFromQr] = useState(false);\n  \n  // Manual observer input state\n  const [manualObserver, setManualObserver] = useState({\n    nama: \"\",\n    perusahaan: \"\",\n    signatureDataUrl: \"\"\n  });\n\n  // Auto-save effect - save current form state to draft\n  useEffect(() => {\n    saveDraft({\n      step,\n      sessionId,\n      headerData,\n      employees,\n      currentEmployee,\n      observers,\n      isLoadedFromQr\n    });\n  }, [step, sessionId, headerData, employees, currentEmployee, observers, isLoadedFromQr, saveDraft]);\n\n  // Handle draft restoration\n  const handleRestoreDraft = async () => {\n    const restoredData = restoreDraft();\n    if (restoredData) {\n      setHeaderData(restoredData.headerData);\n      setEmployees(restoredData.employees);\n      setCurrentEmployee(restoredData.currentEmployee);\n      setObservers(restoredData.observers);\n      setIsLoadedFromQr(restoredData.isLoadedFromQr);\n      \n      // If the draft was from before sessionId was saved, create a new session\n      if (!restoredData.sessionId && restoredData.step > 1) {\n        try {\n          const response = await apiRequest(\"/api/sidak-fatigue\", \"POST\", restoredData.headerData);\n          setSessionId(response.id);\n          setStep(restoredData.step);\n          toast({\n            title: \"Draft Dipulihkan\",\n            description: \"Data SIDAK sebelumnya berhasil dipulihkan dan sesi baru dibuat\",\n          });\n        } catch (error: any) {\n          toast({\n            title: \"Error\",\n            description: \"Gagal membuat sesi baru. Silakan mulai dari awal.\",\n            variant: \"destructive\",\n          });\n          // Reset to step 1 if session creation fails\n          setStep(1);\n          return;\n        }\n      } else {\n        setSessionId(restoredData.sessionId);\n        setStep(restoredData.step);\n        toast({\n          title: \"Draft Dipulihkan\",\n          description: \"Data SIDAK sebelumnya berhasil dipulihkan\",\n        });\n      }\n    }\n  };\n\n  const handleEmployeeScanned = (employee: Employee) => {\n    setCurrentEmployee({\n      ...currentEmployee,\n      employeeId: employee.id,\n      nama: employee.name,\n      nik: employee.id, // Employee ID is used as NIK\n      jabatan: employee.position || \"\",\n      nomorLambung: employee.nomorLambung || \"\"\n    });\n    \n    setIsLoadedFromQr(true); // Lock fields after QR scan\n    \n    toast({\n      title: \"Data Dimuat\",\n      description: `Data karyawan ${employee.name} berhasil dimuat dari QR Code`,\n    });\n  };\n\n  const createSessionMutation = useMutation({\n    mutationFn: async (data: typeof headerData) => {\n      const response = await apiRequest(\"/api/sidak-fatigue\", \"POST\", data);\n      return response;\n    },\n    onSuccess: (data) => {\n      setSessionId(data.id);\n      toast({\n        title: \"Sesi dibuat\",\n        description: \"Sesi Sidak Fatigue berhasil dibuat\",\n      });\n      setStep(2);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Gagal membuat sesi\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const addEmployeeMutation = useMutation({\n    mutationFn: async (employee: EmployeeRecord) => {\n      if (!sessionId) throw new Error(\"Session ID not found\");\n      // Convert null to boolean before sending to API\n      const employeeData = {\n        ...employee,\n        konsumiObat: employee.konsumiObat ?? false,\n        masalahPribadi: employee.masalahPribadi ?? false,\n        pemeriksaanRespon: employee.pemeriksaanRespon ?? false,\n        pemeriksaanKonsentrasi: employee.pemeriksaanKonsentrasi ?? false,\n        pemeriksaanKesehatan: employee.pemeriksaanKesehatan ?? false,\n        karyawanSiapBekerja: employee.karyawanSiapBekerja ?? false,\n        fitUntukBekerja: employee.fitUntukBekerja ?? false,\n        istirahatDanMonitor: employee.istirahatDanMonitor ?? false,\n        istirahatLebihdariSatuJam: employee.istirahatLebihdariSatuJam ?? false,\n        tidakBolehBekerja: employee.tidakBolehBekerja ?? false,\n        employeeSignature: employee.employeeSignature\n      };\n      const response = await apiRequest(`/api/sidak-fatigue/${sessionId}/records`, \"POST\", employeeData);\n      return response;\n    },\n    onSuccess: () => {\n      setEmployees(prev => {\n        const updatedEmployees = [...prev, currentEmployee];\n        toast({\n          title: \"Karyawan ditambahkan\",\n          description: `Karyawan ${updatedEmployees.length}/10 berhasil disimpan`,\n        });\n        return updatedEmployees;\n      });\n      setCurrentEmployee({\n        nama: \"\",\n        nik: \"\",\n        jabatan: \"\",\n        nomorLambung: \"\",\n        jamTidur: 0,\n        konsumiObat: null,\n        masalahPribadi: null,\n        pemeriksaanRespon: null,\n        pemeriksaanKonsentrasi: null,\n        pemeriksaanKesehatan: null,\n        karyawanSiapBekerja: null,\n        fitUntukBekerja: null,\n        istirahatDanMonitor: null,\n        istirahatLebihdariSatuJam: null,\n        tidakBolehBekerja: null,\n        employeeSignature: undefined\n      });\n      setIsLoadedFromQr(false); // Reset lock for next employee\n    },\n    onError: (error: any) => {\n      if (error.message?.includes('Maksimal 20')) {\n        toast({\n          title: \"Batas maksimal tercapai\",\n          description: \"Maksimal 20 karyawan untuk Sidak Fatigue\",\n          variant: \"destructive\",\n        });\n      } else {\n        toast({\n          title: \"Error\",\n          description: error.message || \"Gagal menambahkan karyawan\",\n          variant: \"destructive\",\n        });\n      }\n    }\n  });\n\n  const handleStep1Submit = () => {\n    if (!headerData.waktuMulai || !headerData.waktuSelesai || !headerData.lokasi) {\n      toast({\n        title: \"Data tidak lengkap\",\n        description: \"Mohon lengkapi semua field yang wajib\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createSessionMutation.mutate(headerData);\n  };\n\n  const handleSaveEmployee = () => {\n    // Validate QR scan is required\n    if (!isLoadedFromQr) {\n      toast({\n        title: \"Scan QR Code Wajib\",\n        description: \"Mohon scan QR karyawan terlebih dahulu untuk mengisi data Nama, NIK, dan Jabatan\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (!currentEmployee.nama || !currentEmployee.nik || !currentEmployee.jabatan) {\n      toast({\n        title: \"Data tidak lengkap\",\n        description: \"Mohon lengkapi nama, NIK, dan jabatan karyawan\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    // Validate all boolean fields are explicitly set\n    const booleanFields = [\n      { key: 'konsumiObat', label: 'Ada konsumsi obat' },\n      { key: 'masalahPribadi', label: 'Ada masalah pribadi' },\n      { key: 'pemeriksaanRespon', label: 'Pemeriksaan respon' },\n      { key: 'pemeriksaanKonsentrasi', label: 'Pemeriksaan konsentrasi' },\n      { key: 'pemeriksaanKesehatan', label: 'Pemeriksaan kesehatan' },\n      { key: 'karyawanSiapBekerja', label: 'Karyawan siap bekerja' },\n      { key: 'fitUntukBekerja', label: 'Fit untuk bekerja' },\n      { key: 'istirahatDanMonitor', label: 'Istirahat sebentar dan monitor' },\n      { key: 'istirahatLebihdariSatuJam', label: 'Pekerja diistirahatkan >1jam' },\n      { key: 'tidakBolehBekerja', label: 'Tidak diijinkan bekerja' }\n    ];\n    \n    const unsetFields = booleanFields.filter(field => currentEmployee[field.key as keyof EmployeeRecord] === null);\n    \n    if (unsetFields.length > 0) {\n      toast({\n        title: \"Pemeriksaan belum lengkap\",\n        description: `Mohon pilih Ya/Tidak untuk: ${unsetFields.map(f => f.label).join(', ')}`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    addEmployeeMutation.mutate(currentEmployee);\n  };\n\n  const handleFinishEmployees = () => {\n    if (employees.length === 0) {\n      toast({\n        title: \"Belum ada karyawan\",\n        description: \"Tambahkan minimal 1 karyawan\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setStep(3);\n  };\n\n  const addObserverMutation = useMutation({\n    mutationFn: async (observer: Observer) => {\n      if (!sessionId) throw new Error(\"Session ID not found\");\n      const response = await apiRequest(`/api/sidak-fatigue/${sessionId}/observers`, \"POST\", observer);\n      return response;\n    },\n    onSuccess: (_data, variables) => {\n      // Only update state after successful backend save\n      setObservers(prev => [...prev, variables]);\n      toast({\n        title: \"Observer ditambahkan\",\n        description: `Observer ${variables.nama} berhasil disimpan`,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Gagal menyimpan observer\",\n        description: error.message || \"Silakan coba lagi\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleAddManualObserver = () => {\n    // Validate manual input\n    if (!manualObserver.nama || !manualObserver.perusahaan) {\n      toast({\n        title: \"Data tidak lengkap\",\n        description: \"Mohon lengkapi nama dan perusahaan observer\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!manualObserver.signatureDataUrl) {\n      toast({\n        title: \"Tanda tangan diperlukan\",\n        description: \"Mohon tanda tangani terlebih dahulu\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Create observer with manual input\n    const newObserver: Observer = {\n      nama: manualObserver.nama,\n      nik: `OBS-${Date.now()}`, // Generate unique NIK for manual observer\n      jabatan: \"Observer\",\n      perusahaan: manualObserver.perusahaan,\n      signatureDataUrl: manualObserver.signatureDataUrl\n    };\n\n    // Save to backend (state updated in onSuccess)\n    addObserverMutation.mutate(newObserver);\n    \n    // Reset manual observer form\n    setManualObserver({\n      nama: \"\",\n      perusahaan: \"\",\n      signatureDataUrl: \"\"\n    });\n  };\n\n  const progress = (step / 4) * 100;\n  const maxEmployees = 20;\n  const canAddMore = employees.length < maxEmployees;\n\n  return (\n    <>\n      <DraftRecoveryDialog\n        open={showRecoveryDialog}\n        onRestore={handleRestoreDraft}\n        onDiscard={ignoreDraft}\n        timestamp={draftTimestamp}\n        formType=\"fatigue\"\n      />\n      \n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-950 dark:to-blue-900 p-4\">\n        <div className=\"container max-w-4xl mx-auto space-y-4\">\n          <div className=\"flex items-center gap-3 mb-6\">\n          <Button\n            variant=\"outline\"\n            size=\"icon\"\n            onClick={() => navigate(\"/workspace/sidak\")}\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <div className=\"flex-1\">\n            <h1 className=\"text-2xl md:text-3xl font-bold text-blue-900 dark:text-blue-100 flex items-center gap-2\">\n              <Activity className=\"h-8 w-8\" />\n              Sidak Fatigue\n            </h1>\n            <p className=\"text-sm text-blue-700 dark:text-blue-300\">Form BIB-HSE-ES-F-3.02-16</p>\n          </div>\n        </div>\n\n        <div className=\"space-y-2\">\n          <div className=\"flex justify-between text-sm font-medium text-blue-900 dark:text-blue-100\">\n            <span>Step {step} of 4</span>\n            <span>{Math.round(progress)}%</span>\n          </div>\n          <Progress value={progress} className=\"h-3\" />\n          <div className=\"flex justify-between text-xs text-blue-700 dark:text-blue-300\">\n            <span>Header</span>\n            <span>Karyawan</span>\n            <span>Observer</span>\n            <span>Selesai</span>\n          </div>\n        </div>\n\n        {step === 1 && (\n          <Card>\n            <CardHeader>\n              <CardTitle>Step 1: Informasi Header</CardTitle>\n              <CardDescription>Isi informasi dasar sidak fatigue</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"tanggal\">Tanggal <span className=\"text-red-500\">*</span></Label>\n                  <Input\n                    id=\"tanggal\"\n                    type=\"date\"\n                    value={headerData.tanggal}\n                    onChange={(e) => setHeaderData({ ...headerData, tanggal: e.target.value })}\n                    data-testid=\"input-tanggal\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"shift\">Shift <span className=\"text-red-500\">*</span></Label>\n                  <Select\n                    value={headerData.shift}\n                    onValueChange={(value) => setHeaderData({ ...headerData, shift: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-shift\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"Shift 1\">Shift 1</SelectItem>\n                      <SelectItem value=\"Shift 2\">Shift 2</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"waktuMulai\">Waktu Mulai <span className=\"text-red-500\">*</span></Label>\n                  <Input\n                    id=\"waktuMulai\"\n                    type=\"time\"\n                    value={headerData.waktuMulai}\n                    onChange={(e) => setHeaderData({ ...headerData, waktuMulai: e.target.value })}\n                    data-testid=\"input-waktu-mulai\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"waktuSelesai\">Waktu Selesai <span className=\"text-red-500\">*</span></Label>\n                  <Input\n                    id=\"waktuSelesai\"\n                    type=\"time\"\n                    value={headerData.waktuSelesai}\n                    onChange={(e) => setHeaderData({ ...headerData, waktuSelesai: e.target.value })}\n                    data-testid=\"input-waktu-selesai\"\n                  />\n                </div>\n              </div>\n\n              <div>\n                <Label htmlFor=\"lokasi\">Lokasi <span className=\"text-red-500\">*</span></Label>\n                <Input\n                  id=\"lokasi\"\n                  value={headerData.lokasi}\n                  onChange={(e) => setHeaderData({ ...headerData, lokasi: e.target.value })}\n                  placeholder=\"Contoh: Workshop A\"\n                  data-testid=\"input-lokasi\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"area\">Area</Label>\n                <Input\n                  id=\"area\"\n                  value={headerData.area}\n                  onChange={(e) => setHeaderData({ ...headerData, area: e.target.value })}\n                  placeholder=\"Contoh: Area Produksi\"\n                  data-testid=\"input-area\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"departemen\">Departemen</Label>\n                <Input\n                  id=\"departemen\"\n                  value={headerData.departemen}\n                  onChange={(e) => setHeaderData({ ...headerData, departemen: e.target.value })}\n                  placeholder=\"Contoh: Operasional\"\n                  data-testid=\"input-departemen\"\n                />\n              </div>\n\n              <Button\n                onClick={handleStep1Submit}\n                className=\"w-full h-14 text-lg\"\n                disabled={createSessionMutation.isPending}\n                data-testid=\"button-next-step\"\n              >\n                {createSessionMutation.isPending ? \"Membuat Sesi...\" : \"Lanjut ke Step 2\"}\n                <ArrowRight className=\"ml-2 h-5 w-5\" />\n              </Button>\n            </CardContent>\n          </Card>\n        )}\n\n        {step === 2 && (\n          <div className=\"space-y-4\">\n            <Card className=\"bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300\">\n              <CardContent className=\"pt-6\">\n                <div className=\"text-center\">\n                  <p className=\"text-3xl font-bold text-blue-900 dark:text-blue-100\">\n                    {employees.length} / {maxEmployees}\n                  </p>\n                  <p className=\"text-sm text-blue-700 dark:text-blue-300\">Karyawan Tercatat</p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Step 2: Data Karyawan #{employees.length + 1}</CardTitle>\n                <CardDescription>Isi data pemeriksaan karyawan secara sequential</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setShowEmployeeScanner(true)}\n                  className=\"w-full h-14 text-lg border-2 border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20\"\n                  data-testid=\"button-scan-employee-qr\"\n                >\n                  <Camera className=\"mr-2 h-5 w-5\" />\n                  Scan QR Karyawan untuk Isi Otomatis\n                </Button>\n\n                <Separator />\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"nama\">Nama Karyawan <span className=\"text-red-500\">*</span></Label>\n                    <Input\n                      id=\"nama\"\n                      value={currentEmployee.nama}\n                      readOnly\n                      placeholder={isLoadedFromQr ? \"\" : \"Scan QR untuk mengisi\"}\n                      className=\"bg-gray-100 dark:bg-gray-800 cursor-not-allowed\"\n                      data-testid=\"input-emp-nama\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"nik\">NIK <span className=\"text-red-500\">*</span></Label>\n                    <Input\n                      id=\"nik\"\n                      value={currentEmployee.nik}\n                      readOnly\n                      placeholder={isLoadedFromQr ? \"\" : \"Scan QR untuk mengisi\"}\n                      className=\"bg-gray-100 dark:bg-gray-800 cursor-not-allowed\"\n                      data-testid=\"input-emp-nik\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"jabatan\">Jabatan <span className=\"text-red-500\">*</span></Label>\n                    <Input\n                      id=\"jabatan\"\n                      value={currentEmployee.jabatan}\n                      readOnly\n                      placeholder={isLoadedFromQr ? \"\" : \"Scan QR untuk mengisi\"}\n                      className=\"bg-gray-100 dark:bg-gray-800 cursor-not-allowed\"\n                      data-testid=\"input-emp-jabatan\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"nomorLambung\">Nomor Lambung</Label>\n                    <Input\n                      id=\"nomorLambung\"\n                      value={currentEmployee.nomorLambung}\n                      onChange={(e) => setCurrentEmployee({ ...currentEmployee, nomorLambung: e.target.value })}\n                      placeholder=\"No. Lambung (opsional)\"\n                      data-testid=\"input-emp-nomor-lambung\"\n                    />\n                  </div>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"jamTidur\">Jam Tidur (dalam jam)</Label>\n                  <Input\n                    id=\"jamTidur\"\n                    type=\"number\"\n                    min=\"0\"\n                    max=\"24\"\n                    value={currentEmployee.jamTidur}\n                    onChange={(e) => setCurrentEmployee({ ...currentEmployee, jamTidur: parseInt(e.target.value) || 0 })}\n                    placeholder=\"Contoh: 7\"\n                    className=\"text-2xl font-bold text-center h-16\"\n                    data-testid=\"input-emp-jam-tidur\"\n                  />\n                </div>\n\n                <Separator className=\"my-6\" />\n\n                <div className=\"space-y-4\">\n                  <h3 className=\"font-semibold text-lg\">Pemeriksaan Ya/Tidak</h3>\n                  \n                  {[\n                    { key: 'konsumiObat', label: 'Ada konsumsi obat' },\n                    { key: 'masalahPribadi', label: 'Ada masalah pribadi' },\n                    { key: 'pemeriksaanRespon', label: 'Pemeriksaan respon' },\n                    { key: 'pemeriksaanKonsentrasi', label: 'Pemeriksaan konsentrasi' },\n                    { key: 'pemeriksaanKesehatan', label: 'Pemeriksaan kesehatan' },\n                    { key: 'karyawanSiapBekerja', label: 'Karyawan siap bekerja' },\n                    { key: 'fitUntukBekerja', label: 'Fit untuk bekerja' },\n                    { key: 'istirahatDanMonitor', label: 'Istirahat sebentar dan monitor' },\n                    { key: 'istirahatLebihdariSatuJam', label: 'Pekerja diistirahatkan >1jam' },\n                    { key: 'tidakBolehBekerja', label: 'Tidak diijinkan bekerja' }\n                  ].map((field) => (\n                    <div key={field.key} className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between p-3 sm:p-4 border rounded-lg bg-gray-50 dark:bg-gray-800 gap-2 sm:gap-4\">\n                      <Label htmlFor={field.key} className=\"font-medium text-sm sm:text-base\">{field.label}</Label>\n                      <div className=\"flex gap-2 flex-shrink-0\">\n                        <Button\n                          type=\"button\"\n                          variant={currentEmployee[field.key as keyof EmployeeRecord] === true ? \"default\" : \"outline\"}\n                          onClick={() => setCurrentEmployee({ ...currentEmployee, [field.key]: true })}\n                          className=\"flex-1 sm:flex-none w-auto sm:w-20 h-10 sm:h-12 text-sm\"\n                          data-testid={`button-${field.key}-ya`}\n                        >\n                          <Check className=\"h-4 w-4 sm:h-5 sm:w-5 mr-1\" />\n                          Ya\n                        </Button>\n                        <Button\n                          type=\"button\"\n                          variant={currentEmployee[field.key as keyof EmployeeRecord] === false ? \"destructive\" : \"outline\"}\n                          onClick={() => setCurrentEmployee({ ...currentEmployee, [field.key]: false })}\n                          className=\"flex-1 sm:flex-none w-auto sm:w-20 h-10 sm:h-12 text-sm\"\n                          data-testid={`button-${field.key}-tidak`}\n                        >\n                          <X className=\"h-4 w-4 sm:h-5 sm:w-5 mr-1\" />\n                          Tidak\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n\n                <Separator className=\"my-6\" />\n\n                {/* Employee Signature */}\n                <div className=\"space-y-3\">\n                  <h3 className=\"font-semibold text-lg flex items-center gap-2\">\n                    <Pen className=\"h-5 w-5\" />\n                    Tanda Tangan Pekerja <span className=\"text-red-500\">*</span>\n                  </h3>\n                  <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                    Pekerja harus menandatangani untuk konfirmasi hasil pemeriksaan\n                  </p>\n                  <SignaturePad\n                    onSave={(signatureDataUrl) => {\n                      setCurrentEmployee({\n                        ...currentEmployee,\n                        employeeSignature: signatureDataUrl\n                      });\n                    }}\n                    data-testid=\"signature-pad-employee\"\n                  />\n                  {currentEmployee.employeeSignature && (\n                    <Card className=\"bg-green-50 dark:bg-green-900/20 border-green-300\">\n                      <CardContent className=\"pt-4\">\n                        <div className=\"flex items-center gap-2 text-green-700 dark:text-green-300\">\n                          <Check className=\"h-5 w-5\" />\n                          <span className=\"font-medium\">Tanda tangan tersimpan</span>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  )}\n                </div>\n\n                <div className=\"flex flex-col gap-2\">\n                  <Button\n                    onClick={handleSaveEmployee}\n                    disabled={!canAddMore || addEmployeeMutation.isPending || !currentEmployee.employeeSignature}\n                    className=\"w-full h-12 text-sm sm:text-base\"\n                    data-testid=\"button-save-continue\"\n                  >\n                    <Save className=\"mr-2 h-4 w-4 flex-shrink-0\" />\n                    {addEmployeeMutation.isPending ? \"Menyimpan...\" : \"Simpan & Lanjut\"}\n                  </Button>\n                  <Button\n                    onClick={handleFinishEmployees}\n                    variant=\"outline\"\n                    className=\"w-full h-12 text-sm sm:text-base\"\n                    data-testid=\"button-finish-employees\"\n                  >\n                    Selesai ({employees.length} karyawan)\n                    <ArrowRight className=\"ml-2 h-4 w-4 flex-shrink-0\" />\n                  </Button>\n                </div>\n\n                {!canAddMore && (\n                  <div className=\"bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-300 rounded-lg p-4 text-center\">\n                    <p className=\"font-semibold text-yellow-800 dark:text-yellow-200\">\n                      Batas maksimal 10 karyawan tercapai\n                    </p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        )}\n\n        {step === 3 && (\n          <Card>\n            <CardHeader>\n              <CardTitle>Step 3: Observer & Tanda Tangan</CardTitle>\n              <CardDescription>Scan QR Observer dan tambahkan tanda tangan digital</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              {/* Observer List */}\n              {observers.length > 0 && (\n                <div className=\"space-y-3\">\n                  <h3 className=\"font-semibold flex items-center gap-2\">\n                    <Users className=\"h-5 w-5\" />\n                    Observer Terdaftar ({observers.length})\n                  </h3>\n                  {observers.map((obs, idx) => (\n                    <Card key={idx} className=\"bg-green-50 dark:bg-green-900/20 border-green-300\">\n                      <CardContent className=\"pt-4\">\n                        <div className=\"flex items-start gap-3\">\n                          <div className=\"flex-1\">\n                            <p className=\"font-semibold\">{obs.nama}</p>\n                            <p className=\"text-sm text-gray-600 dark:text-gray-400\">NIK: {obs.nik}</p>\n                            <p className=\"text-sm text-gray-600 dark:text-gray-400\">{obs.jabatan} - {obs.perusahaan}</p>\n                          </div>\n                          <div className=\"flex-shrink-0\">\n                            {obs.signatureDataUrl && (\n                              <div className=\"w-20 h-12 border rounded bg-white\">\n                                <img src={obs.signatureDataUrl} alt=\"Signature\" className=\"w-full h-full object-contain\" />\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              )}\n\n              {/* Add Observer - Manual Input */}\n              <div className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"observer-nama\">Nama Pemantau <span className=\"text-red-500\">*</span></Label>\n                    <Input\n                      id=\"observer-nama\"\n                      value={manualObserver.nama}\n                      onChange={(e) => setManualObserver({ ...manualObserver, nama: e.target.value })}\n                      placeholder=\"Nama lengkap pemantau\"\n                      data-testid=\"input-observer-nama\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"observer-perusahaan\">Perusahaan <span className=\"text-red-500\">*</span></Label>\n                    <Input\n                      id=\"observer-perusahaan\"\n                      value={manualObserver.perusahaan}\n                      onChange={(e) => setManualObserver({ ...manualObserver, perusahaan: e.target.value })}\n                      placeholder=\"Nama perusahaan\"\n                      data-testid=\"input-observer-perusahaan\"\n                    />\n                  </div>\n                </div>\n                \n                <div>\n                  <SignaturePad\n                    onSave={(signatureDataUrl) => setManualObserver({ ...manualObserver, signatureDataUrl })}\n                    disabled={addObserverMutation.isPending}\n                    title=\"Tanda Tangan Pemantau\"\n                  />\n                </div>\n                \n                <Button\n                  onClick={handleAddManualObserver}\n                  size=\"lg\"\n                  className=\"w-full h-12\"\n                  disabled={!manualObserver.nama || !manualObserver.perusahaan || !manualObserver.signatureDataUrl || addObserverMutation.isPending}\n                  data-testid=\"button-add-observer\"\n                >\n                  <UserPlus className=\"mr-2 h-5 w-5\" />\n                  Tambah Observer\n                </Button>\n              </div>\n\n              {/* Navigation */}\n              <Separator />\n              <Button\n                onClick={() => setStep(4)}\n                className=\"w-full h-14 text-lg\"\n                disabled={observers.length === 0}\n                data-testid=\"button-next-preview\"\n              >\n                Lanjut ke Preview ({observers.length} observer)\n                <ArrowRight className=\"ml-2 h-5 w-5\" />\n              </Button>\n\n              {observers.length === 0 && (\n                <p className=\"text-sm text-center text-gray-500\">\n                  Tambahkan minimal 1 observer untuk melanjutkan\n                </p>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Employee Scanner for Step 2 - Karyawan data input */}\n        {showEmployeeScanner && (\n          <SidakEmployeeScanner\n            isOpen={showEmployeeScanner}\n            onClose={() => setShowEmployeeScanner(false)}\n            onEmployeeScanned={handleEmployeeScanned}\n          />\n        )}\n\n        {step === 4 && (\n          <Card>\n            <CardHeader>\n              <CardTitle>Step 4: Preview & Simpan</CardTitle>\n              <CardDescription>Review data sebelum menyimpan</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <h3 className=\"font-semibold\">Header Info:</h3>\n                <div className=\"text-sm space-y-1\">\n                  <p>Tanggal: {headerData.tanggal}</p>\n                  <p>Shift: {headerData.shift}</p>\n                  <p>Waktu: {headerData.waktuMulai} - {headerData.waktuSelesai}</p>\n                  <p>Lokasi: {headerData.lokasi}</p>\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-2\">\n                <h3 className=\"font-semibold\">Total Karyawan: {employees.length}</h3>\n              </div>\n\n              <div className=\"flex gap-3\">\n                <Button\n                  onClick={() => {\n                    clearDraft();\n                    navigate(\"/workspace/sidak\");\n                  }}\n                  className=\"flex-1 h-14 text-lg\"\n                  data-testid=\"button-finish\"\n                >\n                  <Check className=\"mr-2 h-5 w-5\" />\n                  Selesai\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n        </div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":36902,"size_tokens":null},"client/src/components/sidak/sidak-observer-scanner.tsx":{"content":"import { useState, useRef, useCallback, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Camera, CameraOff, X } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { validateQRData } from \"@/lib/crypto-utils\";\nimport jsQR from \"jsqr\";\n\ninterface ObserverData {\n  nama: string;\n  nik: string;\n  perusahaan: string;\n  jabatan: string;\n}\n\ninterface SidakObserverScannerProps {\n  onScanSuccess: (observer: ObserverData) => void;\n  onCancel: () => void;\n  autoStart?: boolean;\n}\n\nexport function SidakObserverScanner({ onScanSuccess, onCancel, autoStart = true }: SidakObserverScannerProps) {\n  const [isScanning, setIsScanning] = useState(false);\n  const [stream, setStream] = useState<MediaStream | null>(null);\n  const [lastScanTime, setLastScanTime] = useState<number>(0);\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const scanningRef = useRef(false);\n  const { toast } = useToast();\n\n  const startScanning = async () => {\n    try {\n      setLastScanTime(0);\n      \n      const mediaStream = await navigator.mediaDevices.getUserMedia({\n        video: { \n          facingMode: 'environment',\n          width: { ideal: 1280 },\n          height: { ideal: 720 }\n        }\n      });\n      \n      setStream(mediaStream);\n      setIsScanning(true);\n      scanningRef.current = true;\n      \n      if (videoRef.current) {\n        videoRef.current.srcObject = mediaStream;\n        videoRef.current.play();\n        videoRef.current.onloadedmetadata = () => {\n          console.log(\"ðŸ“· Camera ready for observer QR scan\");\n          requestAnimationFrame(scanQRCode);\n        };\n      }\n    } catch (error) {\n      console.error(\"Camera error:\", error);\n      toast({\n        title: \"Error Kamera\",\n        description: \"Gagal mengakses kamera. Pastikan browser memiliki izin kamera.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const stopScanning = () => {\n    scanningRef.current = false;\n    setIsScanning(false);\n    \n    if (stream) {\n      stream.getTracks().forEach(track => track.stop());\n      setStream(null);\n    }\n    \n    if (videoRef.current) {\n      videoRef.current.srcObject = null;\n    }\n  };\n\n  const scanQRCode = useCallback(() => {\n    if (!scanningRef.current || !videoRef.current || !canvasRef.current) {\n      return;\n    }\n\n    const video = videoRef.current;\n    const canvas = canvasRef.current;\n    const context = canvas.getContext('2d');\n    \n    if (!context || video.readyState !== video.HAVE_ENOUGH_DATA) {\n      if (scanningRef.current) {\n        requestAnimationFrame(scanQRCode);\n      }\n      return;\n    }\n\n    const maxWidth = 480;\n    const maxHeight = 360;\n    const videoAspectRatio = video.videoWidth / video.videoHeight;\n    \n    let canvasWidth = Math.min(video.videoWidth, maxWidth);\n    let canvasHeight = canvasWidth / videoAspectRatio;\n    \n    if (canvasHeight > maxHeight) {\n      canvasHeight = maxHeight;\n      canvasWidth = canvasHeight * videoAspectRatio;\n    }\n    \n    canvas.width = canvasWidth;\n    canvas.height = canvasHeight;\n    context.drawImage(video, 0, 0, canvasWidth, canvasHeight);\n    \n    const imageData = context.getImageData(0, 0, canvasWidth, canvasHeight);\n    const code = jsQR(imageData.data, imageData.width, imageData.height, {\n      inversionAttempts: \"attemptBoth\",\n    });\n    \n    if (code) {\n      const now = Date.now();\n      if (now - lastScanTime < 500) {\n        requestAnimationFrame(scanQRCode);\n        return;\n      }\n      setLastScanTime(now);\n      \n      console.log(\"ðŸ” Observer QR detected:\", code.data);\n      \n      if (!code.data || code.data.trim() === '') {\n        requestAnimationFrame(scanQRCode);\n        return;\n      }\n      \n      const qrData = validateQRData(code.data);\n      if (qrData) {\n        stopScanning();\n        validateObserver(qrData.id, qrData.token);\n      } else {\n        const lastToastTime = localStorage.getItem('lastInvalidQRToast');\n        if (!lastToastTime || now - parseInt(lastToastTime) > 3000) {\n          toast({\n            title: \"QR Code Tidak Valid\",\n            description: \"Pastikan QR Code dari sistem resmi\",\n            variant: \"destructive\",\n          });\n          localStorage.setItem('lastInvalidQRToast', now.toString());\n        }\n      }\n    }\n    \n    if (scanningRef.current) {\n      requestAnimationFrame(scanQRCode);\n    }\n  }, [toast, lastScanTime]);\n\n  const validateObserver = async (employeeId: string, token: string) => {\n    try {\n      const response = await fetch(\"/api/qr/observer\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ employeeId, token })\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({ message: \"Unknown error\" }));\n        throw new Error(errorData.message || \"Failed to validate observer\");\n      }\n\n      const result = await response.json();\n      \n      if (result.valid && result.observer) {\n        toast({\n          title: \"QR Code Valid\",\n          description: `Observer: ${result.observer.nama}`,\n        });\n        onScanSuccess(result.observer);\n      } else {\n        throw new Error(\"Invalid observer data\");\n      }\n    } catch (error: any) {\n      console.error(\"Observer validation error:\", error);\n      toast({\n        title: \"Validasi Gagal\",\n        description: error.message || \"QR Code tidak valid atau karyawan tidak terdaftar\",\n        variant: \"destructive\",\n      });\n      // Resume scanning after error\n      if (!scanningRef.current) {\n        startScanning();\n      }\n    }\n  };\n\n  // Auto-start if enabled\n  useEffect(() => {\n    if (autoStart) {\n      startScanning();\n    }\n    return () => {\n      stopScanning();\n    };\n  }, []);\n\n  return (\n    <div className=\"fixed inset-0 bg-black/90 z-50 flex flex-col\">\n      {/* Header */}\n      <div className=\"bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 flex items-center justify-between\">\n        <h2 className=\"text-lg font-bold\">Scan QR Observer</h2>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => {\n            stopScanning();\n            onCancel();\n          }}\n          className=\"text-white hover:bg-white/20\"\n          data-testid=\"button-close-scanner\"\n        >\n          <X className=\"h-6 w-6\" />\n        </Button>\n      </div>\n\n      {/* Camera View */}\n      <div className=\"flex-1 flex flex-col items-center justify-center p-4\">\n        <div className=\"relative w-full max-w-lg\">\n          <video \n            ref={videoRef}\n            className=\"w-full h-auto bg-gray-900 rounded-lg\"\n            autoPlay\n            muted\n            playsInline\n            data-testid=\"scanner-video\"\n          />\n          <canvas ref={canvasRef} className=\"hidden\" />\n          \n          {isScanning && (\n            <div className=\"absolute inset-0 border-4 border-blue-500 rounded-lg opacity-50 pointer-events-none\">\n              <div className=\"absolute top-4 left-4 w-8 h-8 border-t-4 border-l-4 border-blue-500\"></div>\n              <div className=\"absolute top-4 right-4 w-8 h-8 border-t-4 border-r-4 border-blue-500\"></div>\n              <div className=\"absolute bottom-4 left-4 w-8 h-8 border-b-4 border-l-4 border-blue-500\"></div>\n              <div className=\"absolute bottom-4 right-4 w-8 h-8 border-b-4 border-r-4 border-blue-500\"></div>\n            </div>\n          )}\n        </div>\n\n        <div className=\"mt-6 text-center text-white space-y-3\">\n          <p className=\"text-lg\">ðŸ“± Arahkan kamera ke QR Code karyawan</p>\n          <p className=\"text-sm text-gray-300\">QR Code akan otomatis terdeteksi</p>\n        </div>\n\n        {/* Controls */}\n        <div className=\"mt-6 flex gap-3\">\n          {!isScanning ? (\n            <Button \n              onClick={startScanning}\n              size=\"lg\"\n              className=\"w-40\"\n              data-testid=\"button-start-scan\"\n            >\n              <Camera className=\"w-5 h-5 mr-2\" />\n              Mulai Scan\n            </Button>\n          ) : (\n            <Button \n              onClick={stopScanning}\n              variant=\"destructive\"\n              size=\"lg\"\n              className=\"w-40\"\n              data-testid=\"button-stop-scan\"\n            >\n              <CameraOff className=\"w-5 h-5 mr-2\" />\n              Stop Scan\n            </Button>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":8463,"size_tokens":null},"client/src/pages/sidak-roster-form.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { ClipboardList, Check, X, ArrowLeft, ArrowRight, Save, Camera, Users, UserPlus } from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation, useQueryClient, useQuery } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { SidakEmployeeScanner } from \"@/components/sidak/sidak-employee-scanner\";\nimport { SignaturePad } from \"@/components/sidak/signature-pad\";\nimport { DraftRecoveryDialog } from \"@/components/sidak/draft-recovery-dialog\";\nimport { useSidakDraft } from \"@/hooks/use-sidak-draft\";\nimport type { Employee } from \"@shared/schema\";\n\ninterface EmployeeRecord {\n  employeeId?: string;\n  nama: string;\n  nik: string;\n  nomorLambung: string;\n  rosterSesuai: boolean | null;\n  keterangan: string;\n}\n\ninterface Observer {\n  nama: string;\n  nik: string;\n  perusahaan: string;\n  jabatan: string;\n  signatureDataUrl: string;\n}\n\ninterface RosterDraftData {\n  step: number;\n  sessionId: string | null;\n  headerData: {\n    tanggalPelaksanaan: string;\n    jamPelaksanaan: string;\n    shift: string;\n    perusahaan: string;\n    departemen: string;\n    lokasi: string;\n  };\n  employees: EmployeeRecord[];\n  currentEmployee: EmployeeRecord;\n  observers: Observer[];\n  isLoadedFromQr: boolean;\n}\n\nconst initialRosterDraftData: RosterDraftData = {\n  step: 1,\n  sessionId: null,\n  headerData: {\n    tanggalPelaksanaan: new Date().toISOString().split('T')[0],\n    jamPelaksanaan: \"\",\n    shift: \"Shift 1\",\n    perusahaan: \"\",\n    departemen: \"\",\n    lokasi: \"\"\n  },\n  employees: [],\n  currentEmployee: {\n    nama: \"\",\n    nik: \"\",\n    nomorLambung: \"\",\n    rosterSesuai: null,\n    keterangan: \"\"\n  },\n  observers: [],\n  isLoadedFromQr: false\n};\n\n// Helper function to detect current shift based on system time\nfunction getCurrentShift(): string {\n  const now = new Date();\n  const hour = now.getHours();\n  \n  // SHIFT 1: 06:00 - 18:00\n  // SHIFT 2: 18:00 - 06:00\n  if (hour >= 6 && hour < 18) {\n    return \"SHIFT 1\";\n  } else {\n    return \"SHIFT 2\";\n  }\n}\n\nexport default function SidakRosterForm() {\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const {\n    saveDraft,\n    clearDraft,\n    restoreDraft,\n    ignoreDraft,\n    showRecoveryDialog,\n    draftTimestamp\n  } = useSidakDraft<RosterDraftData>({\n    key: \"roster\",\n    initialData: initialRosterDraftData,\n    debounceMs: 1500\n  });\n  \n  const [step, setStep] = useState(1);\n  const [sessionId, setSessionId] = useState<string | null>(null);\n  \n  const [headerData, setHeaderData] = useState({\n    tanggalPelaksanaan: new Date().toISOString().split('T')[0],\n    jamPelaksanaan: \"\",\n    shift: \"Shift 1\",\n    perusahaan: \"\",\n    departemen: \"\",\n    lokasi: \"\"\n  });\n  \n  const [employees, setEmployees] = useState<EmployeeRecord[]>([]);\n  const [currentEmployee, setCurrentEmployee] = useState<EmployeeRecord>({\n    nama: \"\",\n    nik: \"\",\n    nomorLambung: \"\",\n    rosterSesuai: null,\n    keterangan: \"\"\n  });\n  \n  const [observers, setObservers] = useState<Observer[]>([]);\n  const [showEmployeeScanner, setShowEmployeeScanner] = useState(false);\n  const [isLoadedFromQr, setIsLoadedFromQr] = useState(false); // Track if data loaded from QR\n  const [isLookingUpRoster, setIsLookingUpRoster] = useState(false); // Loading state for roster lookup\n  \n  // Manual observer input state (replacing dropdown and QR scanner)\n  const [manualObserver, setManualObserver] = useState({\n    nama: \"\",\n    nik: \"\",\n    perusahaan: \"\",\n    jabatan: \"\",\n    signatureDataUrl: \"\"\n  });\n\n  // Auto-save effect - save current form state to draft\n  useEffect(() => {\n    saveDraft({\n      step,\n      sessionId,\n      headerData,\n      employees,\n      currentEmployee,\n      observers,\n      isLoadedFromQr\n    });\n  }, [step, sessionId, headerData, employees, currentEmployee, observers, isLoadedFromQr, saveDraft]);\n\n  // Handle draft restoration\n  const handleRestoreDraft = async () => {\n    const restoredData = restoreDraft();\n    if (restoredData) {\n      setHeaderData(restoredData.headerData);\n      setEmployees(restoredData.employees);\n      setCurrentEmployee(restoredData.currentEmployee);\n      setObservers(restoredData.observers);\n      setIsLoadedFromQr(restoredData.isLoadedFromQr);\n      \n      // If the draft was from before sessionId was saved, create a new session\n      if (!restoredData.sessionId && restoredData.step > 1) {\n        try {\n          const response = await apiRequest(\"/api/sidak-roster\", \"POST\", restoredData.headerData);\n          setSessionId(response.id);\n          setStep(restoredData.step);\n          toast({\n            title: \"Draft Dipulihkan\",\n            description: \"Data SIDAK Roster sebelumnya berhasil dipulihkan dan sesi baru dibuat\",\n          });\n        } catch (error: any) {\n          toast({\n            title: \"Error\",\n            description: \"Gagal membuat sesi baru. Silakan mulai dari awal.\",\n            variant: \"destructive\",\n          });\n          // Reset to step 1 if session creation fails\n          setStep(1);\n          return;\n        }\n      } else {\n        setSessionId(restoredData.sessionId);\n        setStep(restoredData.step);\n        toast({\n          title: \"Draft Dipulihkan\",\n          description: \"Data SIDAK Roster sebelumnya berhasil dipulihkan\",\n        });\n      }\n    }\n  };\n\n  const handleEmployeeScanned = async (employee: Employee) => {\n    try {\n      // Check for duplicate employee\n      if (employees.some(emp => emp.employeeId === employee.id)) {\n        toast({\n          title: \"Karyawan Duplikat\",\n          description: `${employee.name} sudah ditambahkan sebelumnya`,\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      setIsLookingUpRoster(true);\n\n      // Detect current shift based on system time\n      const currentShift = getCurrentShift();\n\n      // Call roster lookup API to auto-fill roster data with shift validation\n      const rosterLookupUrl = `/api/roster-lookup/${employee.id}/${headerData.tanggalPelaksanaan}?currentShift=${encodeURIComponent(currentShift)}`;\n      const rosterResponse = await fetch(rosterLookupUrl);\n      \n      if (!rosterResponse.ok) {\n        const errorData = await rosterResponse.json();\n        throw new Error(errorData.message || 'Gagal mengambil data roster');\n      }\n      \n      const rosterData = await rosterResponse.json();\n      \n      // Check if shift validation failed\n      if (rosterData.shiftMismatch) {\n        toast({\n          title: \"Shift Tidak Sesuai\",\n          description: rosterData.message || `Driver terjadwal di ${rosterData.scheduledShift} tetapi inspeksi dilakukan di ${currentShift}`,\n          variant: \"destructive\",\n        });\n        return;\n      }\n      \n      // Auto-fill all fields\n      setCurrentEmployee({\n        employeeId: employee.id,\n        nama: employee.name,\n        nik: employee.id, // Employee ID is used as NIK\n        nomorLambung: rosterData.nomorLambung || employee.nomorLambung || \"\",\n        rosterSesuai: rosterData.rosterSesuai,\n        keterangan: rosterData.keterangan\n      });\n      \n      setIsLoadedFromQr(true); // Lock all fields except Nomor Lambung\n      \n      toast({\n        title: \"Data Dimuat\",\n        description: `Data karyawan ${employee.name} berhasil dimuat dari QR Code`,\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Gagal memuat data karyawan\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLookingUpRoster(false);\n    }\n  };\n\n  const createSessionMutation = useMutation({\n    mutationFn: async (data: typeof headerData) => {\n      const response = await apiRequest(\"/api/sidak-roster\", \"POST\", data);\n      return response;\n    },\n    onSuccess: (data) => {\n      setSessionId(data.id);\n      toast({\n        title: \"Sesi dibuat\",\n        description: \"Sesi Sidak Roster berhasil dibuat\",\n      });\n      setStep(2);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Gagal membuat sesi\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const addEmployeeMutation = useMutation({\n    mutationFn: async (employee: EmployeeRecord) => {\n      if (!sessionId) throw new Error(\"Session ID not found\");\n      const response = await apiRequest(`/api/sidak-roster/${sessionId}/records`, \"POST\", {\n        ...employee,\n        rosterSesuai: employee.rosterSesuai ?? false\n      });\n      return response;\n    },\n    onSuccess: (data) => {\n      // Use API response (backend-normalized data) instead of request payload\n      setEmployees(prev => [...prev, data]);\n      setCurrentEmployee({\n        nama: \"\",\n        nik: \"\",\n        nomorLambung: \"\",\n        rosterSesuai: null,\n        keterangan: \"\"\n      });\n      setIsLoadedFromQr(false); // Reset locked state for next employee\n      setShowEmployeeScanner(false); // Close scanner\n      toast({\n        title: \"Karyawan ditambahkan\",\n        description: `Karyawan berhasil disimpan`,\n      });\n    },\n    onError: (error: any) => {\n      if (error.message?.includes('Maksimal 15')) {\n        toast({\n          title: \"Batas maksimal tercapai\",\n          description: \"Maksimal 15 karyawan untuk Sidak Roster\",\n          variant: \"destructive\",\n        });\n      } else {\n        toast({\n          title: \"Error\",\n          description: error.message || \"Gagal menambahkan karyawan\",\n          variant: \"destructive\",\n        });\n      }\n    }\n  });\n\n  const handleStep1Submit = () => {\n    if (!headerData.jamPelaksanaan || !headerData.perusahaan || !headerData.lokasi) {\n      toast({\n        title: \"Data tidak lengkap\",\n        description: \"Mohon lengkapi semua field yang wajib\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createSessionMutation.mutate(headerData);\n  };\n\n  const handleSaveEmployee = () => {\n    if (!isLoadedFromQr) {\n      toast({\n        title: \"Scan QR Required\",\n        description: \"Silakan scan QR Code karyawan terlebih dahulu\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    if (!currentEmployee.nama || !currentEmployee.nik) {\n      toast({\n        title: \"Data tidak lengkap\",\n        description: \"Data karyawan tidak valid\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    addEmployeeMutation.mutate(currentEmployee);\n  };\n\n  const handleFinishEmployees = () => {\n    if (employees.length === 0) {\n      toast({\n        title: \"Belum ada karyawan\",\n        description: \"Tambahkan minimal 1 karyawan\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setStep(3);\n  };\n\n  const addObserverMutation = useMutation({\n    mutationFn: async (observer: Observer) => {\n      if (!sessionId) throw new Error(\"Session ID not found\");\n      const response = await apiRequest(`/api/sidak-roster/${sessionId}/observers`, \"POST\", observer);\n      return response;\n    },\n    onSuccess: (data) => {\n      // Use API response (backend-normalized data) instead of request payload\n      setObservers(prev => [...prev, data]);\n      \n      // Reset manual form after successful save\n      setManualObserver({\n        nama: \"\",\n        nik: \"\",\n        perusahaan: \"\",\n        jabatan: \"\",\n        signatureDataUrl: \"\"\n      });\n      \n      toast({\n        title: \"Observer ditambahkan\",\n        description: `Observer berhasil disimpan`,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Gagal menyimpan observer\",\n        description: error.message || \"Silakan coba lagi\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleAddManualObserver = () => {\n    // Validate manual input fields\n    if (!manualObserver.nama || !manualObserver.nik || !manualObserver.perusahaan || !manualObserver.jabatan) {\n      toast({\n        title: \"Data tidak lengkap\",\n        description: \"Mohon lengkapi semua field observer (Nama, NIK, Perusahaan, Jabatan)\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Validate signature\n    if (!manualObserver.signatureDataUrl) {\n      toast({\n        title: \"Tanda tangan diperlukan\",\n        description: \"Mohon tambahkan tanda tangan observer\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Check duplicate observer by NIK\n    if (observers.some(obs => obs.nik === manualObserver.nik)) {\n      toast({\n        title: \"Observer sudah ditambahkan\",\n        description: `Observer dengan NIK ${manualObserver.nik} sudah ada dalam daftar`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Create complete observer object\n    const completeObserver: Observer = {\n      nama: manualObserver.nama,\n      nik: manualObserver.nik,\n      perusahaan: manualObserver.perusahaan,\n      jabatan: manualObserver.jabatan,\n      signatureDataUrl: manualObserver.signatureDataUrl\n    };\n\n    // Save to backend (state updated in onSuccess, form reset in onSuccess)\n    addObserverMutation.mutate(completeObserver);\n  };\n\n\n  const progress = (step / 4) * 100;\n  const maxEmployees = 15;\n  const canAddMore = employees.length < maxEmployees;\n\n  return (\n    <>\n      <DraftRecoveryDialog\n        open={showRecoveryDialog}\n        onRestore={handleRestoreDraft}\n        onDiscard={ignoreDraft}\n        timestamp={draftTimestamp}\n        formType=\"roster\"\n      />\n      \n      <div className=\"min-h-screen bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-950 dark:to-purple-900 p-4\">\n        <div className=\"container max-w-4xl mx-auto space-y-4\">\n          <div className=\"flex items-center gap-3 mb-6\">\n            <Button\n              variant=\"outline\"\n              size=\"icon\"\n              onClick={() => navigate(\"/workspace/sidak\")}\n              data-testid=\"button-back\"\n            >\n              <ArrowLeft className=\"h-5 w-5\" />\n            </Button>\n          <div className=\"flex-1\">\n            <h1 className=\"text-2xl md:text-3xl font-bold text-purple-900 dark:text-purple-100 flex items-center gap-2\">\n              <ClipboardList className=\"h-8 w-8\" />\n              Sidak Roster\n            </h1>\n            <p className=\"text-sm text-purple-700 dark:text-purple-300\">Form BIB-HSE-PPO-F</p>\n          </div>\n        </div>\n\n        <div className=\"space-y-2\">\n          <div className=\"flex justify-between text-sm font-medium text-purple-900 dark:text-purple-100\">\n            <span>Step {step} of 4</span>\n            <span>{Math.round(progress)}%</span>\n          </div>\n          <Progress value={progress} className=\"h-3\" />\n          <div className=\"flex justify-between text-xs text-purple-700 dark:text-purple-300\">\n            <span>Header</span>\n            <span>Karyawan</span>\n            <span>Observer</span>\n            <span>Selesai</span>\n          </div>\n        </div>\n\n        {step === 1 && (\n          <Card>\n            <CardHeader>\n              <CardTitle>Step 1: Informasi Header</CardTitle>\n              <CardDescription>Isi informasi dasar sidak roster</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"tanggalPelaksanaan\">Tanggal Pelaksanaan <span className=\"text-red-500\">*</span></Label>\n                  <Input\n                    id=\"tanggalPelaksanaan\"\n                    type=\"date\"\n                    value={headerData.tanggalPelaksanaan}\n                    onChange={(e) => setHeaderData({ ...headerData, tanggalPelaksanaan: e.target.value })}\n                    data-testid=\"input-tanggal\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"jamPelaksanaan\">Jam Pelaksanaan <span className=\"text-red-500\">*</span></Label>\n                  <Input\n                    id=\"jamPelaksanaan\"\n                    type=\"time\"\n                    value={headerData.jamPelaksanaan}\n                    onChange={(e) => setHeaderData({ ...headerData, jamPelaksanaan: e.target.value })}\n                    data-testid=\"input-jam\"\n                  />\n                </div>\n              </div>\n\n              <div>\n                <Label htmlFor=\"shift\">Shift <span className=\"text-red-500\">*</span></Label>\n                <Select\n                  value={headerData.shift}\n                  onValueChange={(value) => setHeaderData({ ...headerData, shift: value })}\n                >\n                  <SelectTrigger data-testid=\"select-shift\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"Shift 1\">Shift 1</SelectItem>\n                    <SelectItem value=\"Shift 2\">Shift 2</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <Label htmlFor=\"perusahaan\">Perusahaan <span className=\"text-red-500\">*</span></Label>\n                <Input\n                  id=\"perusahaan\"\n                  value={headerData.perusahaan}\n                  onChange={(e) => setHeaderData({ ...headerData, perusahaan: e.target.value })}\n                  placeholder=\"Nama perusahaan\"\n                  data-testid=\"input-perusahaan\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"departemen\">Departemen</Label>\n                <Input\n                  id=\"departemen\"\n                  value={headerData.departemen}\n                  onChange={(e) => setHeaderData({ ...headerData, departemen: e.target.value })}\n                  placeholder=\"Contoh: Operasional\"\n                  data-testid=\"input-departemen\"\n                />\n              </div>\n\n              <div>\n                <Label htmlFor=\"lokasi\">Lokasi <span className=\"text-red-500\">*</span></Label>\n                <Input\n                  id=\"lokasi\"\n                  value={headerData.lokasi}\n                  onChange={(e) => setHeaderData({ ...headerData, lokasi: e.target.value })}\n                  placeholder=\"Contoh: Area Produksi\"\n                  data-testid=\"input-lokasi\"\n                />\n              </div>\n\n              <Button\n                onClick={handleStep1Submit}\n                className=\"w-full h-14 text-lg\"\n                disabled={createSessionMutation.isPending}\n                data-testid=\"button-next-step\"\n              >\n                {createSessionMutation.isPending ? \"Membuat Sesi...\" : \"Lanjut ke Step 2\"}\n                <ArrowRight className=\"ml-2 h-5 w-5\" />\n              </Button>\n            </CardContent>\n          </Card>\n        )}\n\n        {step === 2 && (\n          <div className=\"space-y-4\">\n            <Card className=\"bg-purple-50 dark:bg-purple-900/20 border-2 border-purple-300\">\n              <CardContent className=\"pt-6\">\n                <div className=\"text-center\">\n                  <p className=\"text-3xl font-bold text-purple-900 dark:text-purple-100\">\n                    {employees.length} / {maxEmployees}\n                  </p>\n                  <p className=\"text-sm text-purple-700 dark:text-purple-300\">Karyawan Tercatat</p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Step 2: Data Karyawan #{employees.length + 1}</CardTitle>\n                <CardDescription>Isi data pemeriksaan kesesuaian roster</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                {!isLoadedFromQr ? (\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setShowEmployeeScanner(true)}\n                    className=\"w-full h-14 text-lg border-2 border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20\"\n                    data-testid=\"button-scan-employee-qr\"\n                    disabled={isLookingUpRoster}\n                  >\n                    <Camera className=\"mr-2 h-5 w-5\" />\n                    {isLookingUpRoster ? \"Memuat Data...\" : \"Scan QR Karyawan untuk Isi Otomatis\"}\n                  </Button>\n                ) : (\n                  <>\n                    <div className=\"bg-green-50 dark:bg-green-900/20 border-2 border-green-300 rounded-lg p-4 text-center\">\n                      <p className=\"font-semibold text-green-800 dark:text-green-200\">\n                        âœ“ Data dimuat dari QR Code - Hanya Nomor Lambung yang dapat diedit\n                      </p>\n                    </div>\n\n                    <Separator />\n\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      <div>\n                        <Label>Nama Karyawan <span className=\"text-red-500\">*</span></Label>\n                        <div className=\"p-3 bg-gray-100 dark:bg-gray-800 rounded border-2 border-gray-300 dark:border-gray-600\" data-testid=\"display-emp-nama\">\n                          <p className=\"font-medium\">{currentEmployee.nama}</p>\n                        </div>\n                      </div>\n                      <div>\n                        <Label>NIK <span className=\"text-red-500\">*</span></Label>\n                        <div className=\"p-3 bg-gray-100 dark:bg-gray-800 rounded border-2 border-gray-300 dark:border-gray-600\" data-testid=\"display-emp-nik\">\n                          <p className=\"font-medium\">{currentEmployee.nik}</p>\n                        </div>\n                      </div>\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"nomorLambung\">Nomor Lambung (Dapat Diedit)</Label>\n                      <Input\n                        id=\"nomorLambung\"\n                        value={currentEmployee.nomorLambung}\n                        onChange={(e) => setCurrentEmployee({ ...currentEmployee, nomorLambung: e.target.value })}\n                        placeholder=\"No. Lambung\"\n                        data-testid=\"input-emp-nomor-lambung\"\n                        className=\"border-2 border-purple-400\"\n                      />\n                    </div>\n\n                    <Separator className=\"my-6\" />\n\n                    <div className=\"space-y-4\">\n                      <h3 className=\"font-semibold text-lg\">Roster Sesuai? (Otomatis dari sistem)</h3>\n                      \n                      <div className=\"flex items-center justify-center p-6 border-2 rounded-lg bg-gray-50 dark:bg-gray-800\">\n                        <div className=\"flex items-center gap-3\">\n                          {currentEmployee.rosterSesuai ? (\n                            <div className=\"flex items-center gap-2 text-green-600 dark:text-green-400\" data-testid=\"display-roster-ya\">\n                              <Check className=\"h-8 w-8\" />\n                              <span className=\"text-2xl font-bold\">YA</span>\n                            </div>\n                          ) : (\n                            <div className=\"flex items-center gap-2 text-red-600 dark:text-red-400\" data-testid=\"display-roster-tidak\">\n                              <X className=\"h-8 w-8\" />\n                              <span className=\"text-2xl font-bold\">TIDAK</span>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n\n                    <div>\n                      <Label>Keterangan (Otomatis dari sistem)</Label>\n                      <div className=\"p-3 bg-gray-100 dark:bg-gray-800 rounded border-2 border-gray-300 dark:border-gray-600 min-h-[100px]\" data-testid=\"display-emp-keterangan\">\n                        <p className=\"font-medium\">{currentEmployee.keterangan || \"-\"}</p>\n                      </div>\n                    </div>\n                  </>\n                )}\n\n                <div className=\"flex flex-col gap-2\">\n                  <Button\n                    onClick={handleSaveEmployee}\n                    disabled={!canAddMore || addEmployeeMutation.isPending}\n                    className=\"w-full h-12 text-sm sm:text-base\"\n                    data-testid=\"button-save-continue\"\n                  >\n                    <Save className=\"mr-2 h-4 w-4 flex-shrink-0\" />\n                    {addEmployeeMutation.isPending ? \"Menyimpan...\" : \"Simpan & Lanjut\"}\n                  </Button>\n                  <Button\n                    onClick={handleFinishEmployees}\n                    variant=\"outline\"\n                    className=\"w-full h-12 text-sm sm:text-base\"\n                    data-testid=\"button-finish-employees\"\n                  >\n                    Selesai ({employees.length} karyawan)\n                    <ArrowRight className=\"ml-2 h-4 w-4 flex-shrink-0\" />\n                  </Button>\n                </div>\n\n                {!canAddMore && (\n                  <div className=\"bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-300 rounded-lg p-4 text-center\">\n                    <p className=\"font-semibold text-yellow-800 dark:text-yellow-200\">\n                      Batas maksimal 15 karyawan tercapai\n                    </p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        )}\n\n        {step === 3 && (\n          <Card>\n            <CardHeader>\n              <CardTitle>Step 3: Observer & Tanda Tangan</CardTitle>\n              <CardDescription>Scan QR Observer dan tambahkan tanda tangan digital</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              {observers.length > 0 && (\n                <div className=\"space-y-3\">\n                  <h3 className=\"font-semibold flex items-center gap-2\">\n                    <Users className=\"h-5 w-5\" />\n                    Observer Terdaftar ({observers.length})\n                  </h3>\n                  {observers.map((obs, idx) => (\n                    <Card key={idx} className=\"bg-green-50 dark:bg-green-900/20 border-green-300\">\n                      <CardContent className=\"pt-4\">\n                        <div className=\"flex items-start gap-3\">\n                          <div className=\"flex-1\">\n                            <p className=\"font-semibold\">{obs.nama}</p>\n                            <p className=\"text-sm text-gray-600 dark:text-gray-400\">NIK: {obs.nik}</p>\n                            <p className=\"text-sm text-gray-600 dark:text-gray-400\">{obs.jabatan} - {obs.perusahaan}</p>\n                          </div>\n                          <div className=\"flex-shrink-0\">\n                            {obs.signatureDataUrl && (\n                              <div className=\"w-20 h-12 border rounded bg-white\">\n                                <img src={obs.signatureDataUrl} alt=\"Signature\" className=\"w-full h-full object-contain\" />\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              )}\n\n              {/* Add Observer - Manual Input */}\n              <div className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"observer-nama\">Nama Observer <span className=\"text-red-500\">*</span></Label>\n                    <Input\n                      id=\"observer-nama\"\n                      value={manualObserver.nama}\n                      onChange={(e) => setManualObserver({ ...manualObserver, nama: e.target.value })}\n                      placeholder=\"Nama lengkap observer\"\n                      data-testid=\"input-observer-nama\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"observer-nik\">NIK <span className=\"text-red-500\">*</span></Label>\n                    <Input\n                      id=\"observer-nik\"\n                      value={manualObserver.nik}\n                      onChange={(e) => setManualObserver({ ...manualObserver, nik: e.target.value })}\n                      placeholder=\"NIK observer\"\n                      data-testid=\"input-observer-nik\"\n                    />\n                  </div>\n                </div>\n                \n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"observer-perusahaan\">Perusahaan <span className=\"text-red-500\">*</span></Label>\n                    <Input\n                      id=\"observer-perusahaan\"\n                      value={manualObserver.perusahaan}\n                      onChange={(e) => setManualObserver({ ...manualObserver, perusahaan: e.target.value })}\n                      placeholder=\"Nama perusahaan\"\n                      data-testid=\"input-observer-perusahaan\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"observer-jabatan\">Jabatan <span className=\"text-red-500\">*</span></Label>\n                    <Input\n                      id=\"observer-jabatan\"\n                      value={manualObserver.jabatan}\n                      onChange={(e) => setManualObserver({ ...manualObserver, jabatan: e.target.value })}\n                      placeholder=\"Jabatan observer\"\n                      data-testid=\"input-observer-jabatan\"\n                    />\n                  </div>\n                </div>\n                \n                <div>\n                  <SignaturePad\n                    onSave={(signatureDataUrl) => setManualObserver({ ...manualObserver, signatureDataUrl })}\n                    disabled={addObserverMutation.isPending}\n                    title=\"Tanda Tangan Observer\"\n                  />\n                </div>\n                \n                <Button\n                  onClick={handleAddManualObserver}\n                  size=\"lg\"\n                  className=\"w-full h-12\"\n                  disabled={!manualObserver.nama || !manualObserver.nik || !manualObserver.perusahaan || !manualObserver.jabatan || !manualObserver.signatureDataUrl || addObserverMutation.isPending}\n                  data-testid=\"button-add-observer\"\n                >\n                  <UserPlus className=\"mr-2 h-5 w-5\" />\n                  Tambah Observer\n                </Button>\n              </div>\n\n              <Separator />\n              <Button\n                onClick={() => setStep(4)}\n                className=\"w-full h-14 text-lg\"\n                disabled={observers.length === 0}\n                data-testid=\"button-next-preview\"\n              >\n                Lanjut ke Preview ({observers.length} observer)\n                <ArrowRight className=\"ml-2 h-5 w-5\" />\n              </Button>\n\n              {observers.length === 0 && (\n                <p className=\"text-sm text-center text-gray-500\">\n                  Tambahkan minimal 1 observer untuk melanjutkan\n                </p>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Employee Scanner for Step 2 - Karyawan data input */}\n        {showEmployeeScanner && (\n          <SidakEmployeeScanner\n            isOpen={showEmployeeScanner}\n            onClose={() => setShowEmployeeScanner(false)}\n            onEmployeeScanned={handleEmployeeScanned}\n          />\n        )}\n\n        {step === 4 && (\n          <Card>\n            <CardHeader>\n              <CardTitle>Step 4: Preview & Simpan</CardTitle>\n              <CardDescription>Review data sebelum menyimpan</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <h3 className=\"font-semibold\">Header Info:</h3>\n                <div className=\"text-sm space-y-1\">\n                  <p>Tanggal: {headerData.tanggalPelaksanaan}</p>\n                  <p>Jam: {headerData.jamPelaksanaan}</p>\n                  <p>Shift: {headerData.shift}</p>\n                  <p>Perusahaan: {headerData.perusahaan}</p>\n                  <p>Lokasi: {headerData.lokasi}</p>\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-2\">\n                <h3 className=\"font-semibold\">Total Karyawan: {employees.length}</h3>\n              </div>\n\n              <div className=\"flex gap-3\">\n                <Button\n                  onClick={() => {\n                    clearDraft();\n                    navigate(\"/workspace/sidak\");\n                  }}\n                  className=\"flex-1 h-14 text-lg\"\n                  data-testid=\"button-finish\"\n                >\n                  <Check className=\"mr-2 h-5 w-5\" />\n                  Selesai\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n        </div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":33390,"size_tokens":null},"client/src/lib/sidak-pdf-utils.ts":{"content":"import jsPDF from 'jspdf';\nimport autoTable from 'jspdf-autotable';\nimport type { \n  SidakFatigueSession, \n  SidakFatigueRecord, \n  SidakFatigueObserver,\n  SidakRosterSession,\n  SidakRosterRecord,\n  SidakRosterObserver\n} from '@shared/schema';\n\n// ============================================\n// SIDAK FATIGUE PDF GENERATOR\n// Form: BIB-HSE-ES-F-3.02-16\n// ============================================\n\ninterface SidakFatigueData {\n  session: SidakFatigueSession;\n  records: SidakFatigueRecord[];\n  observers: SidakFatigueObserver[];\n}\n\nexport async function generateSidakFatiguePdf(data: SidakFatigueData): Promise<jsPDF> {\n  const pdf = new jsPDF('landscape', 'mm', 'a4');\n  const pageWidth = pdf.internal.pageSize.width;\n  const pageHeight = pdf.internal.pageSize.height;\n  const margin = 10;\n  const EMPLOYEES_PER_PAGE = 10;\n\n  // Pre-load logo image once for reuse\n  let logoImg: HTMLImageElement | null = null;\n  try {\n    logoImg = await new Promise<HTMLImageElement>((resolve, reject) => {\n      const img = new Image();\n      img.onload = () => resolve(img);\n      img.onerror = () => reject(new Error('Failed to load logo'));\n      img.src = '/assets/logo.png';\n    });\n  } catch (error) {\n    console.error('Logo loading failed, will use text fallback:', error);\n  }\n\n  // Helper function to draw header and info section (reused for each page)\n  const drawHeaderAndInfo = (yStart: number): number => {\n    let yPosition = yStart;\n\n    // ==================== HEADER ====================\n    if (logoImg) {\n      const logoWidth = 45;\n      const logoHeight = 10;\n      pdf.addImage(logoImg, 'PNG', margin, yPosition, logoWidth, logoHeight);\n    } else {\n      pdf.setFont('helvetica', 'bold');\n      pdf.setFontSize(11);\n      pdf.setTextColor(0, 0, 139);\n      pdf.text('PT BORNEO INDOBARA', margin, yPosition + 6);\n    }\n    \n    // Form code at top right\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(9);\n    pdf.setTextColor(0, 0, 0);\n    pdf.text('BIB â€“ HSE â€“ ES â€“ F â€“ 3.02 â€“ 16', pageWidth - margin, yPosition + 4, { align: 'right' });\n    \n    yPosition += 12;\n    \n    // Main title with gray background\n    const titleYStart = yPosition;\n    pdf.setFillColor(220, 220, 220);\n    pdf.rect(margin, titleYStart, pageWidth - (margin * 2), 8, 'F');\n    \n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(14);\n    pdf.setTextColor(0, 0, 0);\n    pdf.text('OBSERVASI PENGECEKAN KELELAHAN', pageWidth / 2, titleYStart + 5.5, { align: 'center' });\n    \n    yPosition += 10;\n    \n    // Subtitle\n    pdf.setFontSize(8);\n    pdf.setFont('helvetica', 'normal');\n    pdf.text('Formulir ini digunakan sebagai catatan hasil pengecekan kelelahan yang dilaksanakan di PT Borneo Indobara', pageWidth / 2, yPosition + 2, { align: 'center' });\n    \n    yPosition += 4;\n\n    // ==================== INFO SECTION TABLE ====================\n    const infoTableData = [\n      ['Tanggal / Shift', `${data.session.tanggal} / ${data.session.shift}`, 'Lokasi', data.session.lokasi],\n      ['Waktu', `${data.session.waktuMulai} sampai ${data.session.waktuSelesai}`, 'Total Sampel', data.records.length.toString()],\n      ['Area / Departemen', `${data.session.area} / ${data.session.departemen}`, '', '']\n    ];\n    \n    autoTable(pdf, {\n      startY: yPosition,\n      body: infoTableData,\n      theme: 'grid',\n      tableWidth: pageWidth - (margin * 2),\n      styles: {\n        fontSize: 8,\n        cellPadding: 1.5,\n        lineWidth: 0.2,\n        lineColor: [0, 0, 0],\n        textColor: [0, 0, 0],\n        valign: 'middle',\n      },\n      columnStyles: {\n        0: { cellWidth: 40, fontStyle: 'bold', fillColor: [220, 220, 220], halign: 'left' },\n        1: { cellWidth: (pageWidth - (margin * 2)) / 2 - 40, halign: 'left' },\n        2: { cellWidth: 40, fontStyle: 'bold', fillColor: [220, 220, 220], halign: 'left' },\n        3: { cellWidth: (pageWidth - (margin * 2)) / 2 - 40, halign: 'left' },\n      },\n      margin: { left: margin, right: margin },\n    });\n    \n    return (pdf as any).lastAutoTable.finalY + 2;\n  };\n\n  // Helper function to draw employee table for a chunk of records\n  const drawEmployeeTable = (records: SidakFatigueRecord[], startIndex: number, yStart: number): number => {\n    const tableHeaders = [\n      ['No', 'Nama / NIK', 'Jabatan', 'No.\\nLambung', \n       'Jam tidur\\nkaryawan\\nsebelum\\nbekerja\\n(jam)', 'Jam\\nMonitoring',\n       'Ada\\nkonsumsi\\nobat', 'Ada\\nmasalah\\npribadi', 'Pemeriksaan\\nrespon\\nkaryawan', \n       'Pemeriksaan\\nkonsentrasi\\nkaryawan', 'Pemeriksaan\\nkesehatan\\nkaryawan', \n       'Karyawan\\nsiap untuk\\nbekerja', 'Fit Untuk\\nBekerja',\n       'Tanda\\nTangan\\nPekerja',\n       'Istirahat\\nSebentar\\ndan\\nDimonitor\\nkembali', \n       'Pekerja\\ndiistirahatkan\\n(> 1 Jam) -\\nKonseling',\n       'Tidak\\nDiijinkan\\nuntuk\\nKembali\\nBekerja\\n(Konseling)']\n    ];\n\n    const tableData = records.map((record, index) => [\n      (startIndex + index + 1).toString(),\n      `${record.nama}\\n${record.nik}`,\n      record.jabatan,\n      record.nomorLambung || '-',\n      record.jamTidur.toString(),\n      '-',\n      record.konsumiObat ? '\\u2713' : 'X',\n      record.masalahPribadi ? '\\u2713' : 'X',\n      record.pemeriksaanRespon ? '\\u2713' : 'X',\n      record.pemeriksaanKonsentrasi ? '\\u2713' : 'X',\n      record.pemeriksaanKesehatan ? '\\u2713' : 'X',\n      record.karyawanSiapBekerja ? '\\u2713' : 'X',\n      record.fitUntukBekerja ? '\\u2713' : 'X',\n      '',\n      record.istirahatDanMonitor ? '\\u2713' : 'X',\n      record.istirahatLebihdariSatuJam ? '\\u2713' : 'X',\n      record.tidakBolehBekerja ? '\\u2713' : 'X',\n    ]);\n\n    const availableWidth = pageWidth - (margin * 2);\n    \n    autoTable(pdf, {\n      startY: yStart,\n      head: tableHeaders,\n      body: tableData,\n      theme: 'grid',\n      tableWidth: availableWidth,\n      styles: {\n        fontSize: 5.5,\n        cellPadding: 0.5,\n        halign: 'center',\n        valign: 'middle',\n        lineWidth: 0.1,\n        lineColor: [0, 0, 0],\n        minCellHeight: 6.5,\n      },\n      headStyles: {\n        fillColor: [220, 220, 220],\n        textColor: [0, 0, 0],\n        fontStyle: 'bold',\n        halign: 'center',\n        valign: 'middle',\n        lineWidth: 0.2,\n        fontSize: 5.5,\n        cellPadding: 0.5,\n      },\n      columnStyles: {\n        0: { cellWidth: 8 },\n        1: { cellWidth: 40, halign: 'left', fontSize: 5.5 },\n        2: { cellWidth: 30, halign: 'left' },\n        3: { cellWidth: 18 },\n        4: { cellWidth: 14 },\n        5: { cellWidth: 14 },\n        6: { cellWidth: 14 },\n        7: { cellWidth: 14 },\n        8: { cellWidth: 14 },\n        9: { cellWidth: 14 },\n        10: { cellWidth: 14 },\n        11: { cellWidth: 14 },\n        12: { cellWidth: 14 },\n        13: { cellWidth: 18 },\n        14: { cellWidth: 14 },\n        15: { cellWidth: 14 },\n        16: { cellWidth: 9 },\n      },\n      margin: { left: margin, right: margin },\n      didDrawCell: (cellData) => {\n        if (cellData.column.index === 13 && cellData.section === 'body') {\n          const record = records[cellData.row.index];\n          if (record && record.employeeSignature) {\n            try {\n              const imgWidth = 18;\n              const imgHeight = 10;\n              const xPos = cellData.cell.x + (cellData.cell.width - imgWidth) / 2;\n              const yPos = cellData.cell.y + (cellData.cell.height - imgHeight) / 2;\n              pdf.addImage(record.employeeSignature, 'PNG', xPos, yPos, imgWidth, imgHeight);\n            } catch (error) {\n              console.error('Error drawing employee signature:', error);\n            }\n          }\n        }\n        \n        const booleanColumns = [6, 7, 8, 9, 10, 11, 12, 14, 15, 16];\n        if (booleanColumns.includes(cellData.column.index) && cellData.section === 'body') {\n          const cellText = cellData.cell.text[0];\n          if (cellText === '\\u2713' || cellText === 'âœ“') {\n            const x = cellData.cell.x + cellData.cell.width / 2;\n            const y = cellData.cell.y + cellData.cell.height / 2;\n            const size = 1.8;\n            \n            pdf.setLineWidth(0.3);\n            pdf.setDrawColor(0, 0, 0);\n            \n            pdf.line(x - size, y, x - size/3, y + size);\n            pdf.line(x - size/3, y + size, x + size, y - size);\n          }\n        }\n      }\n    });\n\n    return (pdf as any).lastAutoTable.finalY + 1.5;\n  };\n\n  // Helper function to draw observer signatures\n  const drawObserverSignatures = (yStart: number): number => {\n    const observerTableData = [\n      [\n        '1.', data.observers[0]?.nama || '', data.observers[0]?.perusahaan || '', '',\n        '4.', data.observers[3]?.nama || '', data.observers[3]?.perusahaan || '', ''\n      ],\n      [\n        '2.', data.observers[1]?.nama || '', data.observers[1]?.perusahaan || '', '',\n        '5.', data.observers[4]?.nama || '', data.observers[4]?.perusahaan || '', ''\n      ],\n      [\n        '3.', data.observers[2]?.nama || '', data.observers[2]?.perusahaan || '', '',\n        '6.', data.observers[5]?.nama || '', data.observers[5]?.perusahaan || '', ''\n      ]\n    ];\n\n    autoTable(pdf, {\n      startY: yStart,\n      head: [[\n        'No', 'Nama Pemantau', 'Perusahaan', 'Tanda Tangan',\n        'No', 'Nama Pemantau', 'Perusahaan', 'Tanda Tangan'\n      ]],\n      body: observerTableData,\n      theme: 'grid',\n      tableWidth: pageWidth - (margin * 2),\n      styles: {\n        fontSize: 6.5,\n        cellPadding: 0.8,\n        halign: 'left',\n        valign: 'middle',\n        minCellHeight: 8,\n        lineWidth: 0.2,\n        lineColor: [0, 0, 0],\n      },\n      headStyles: {\n        fillColor: [220, 220, 220],\n        textColor: [0, 0, 0],\n        fontStyle: 'bold',\n        halign: 'center',\n        valign: 'middle',\n        cellPadding: 0.8,\n        minCellHeight: 8,\n        lineWidth: 0.3,\n        lineColor: [0, 0, 0],\n      },\n      columnStyles: {\n        0: { cellWidth: 11, halign: 'center' },\n        1: { cellWidth: 69, halign: 'left' },\n        2: { cellWidth: 32, halign: 'left' },\n        3: { cellWidth: 26, halign: 'center' },\n        4: { cellWidth: 11, halign: 'center' },\n        5: { cellWidth: 69, halign: 'left' },\n        6: { cellWidth: 32, halign: 'left' },\n        7: { cellWidth: 26, halign: 'center' },\n      },\n      didDrawCell: (cellData) => {\n        if ((cellData.column.index === 3 || cellData.column.index === 7) && cellData.section === 'body') {\n          const rowIndex = cellData.row.index;\n          const observerIndex = cellData.column.index === 3 ? rowIndex : rowIndex + 3;\n          const observer = data.observers[observerIndex];\n          \n          if (observer?.signatureDataUrl) {\n            try {\n              const format = observer.signatureDataUrl.includes('image/png') ? 'PNG' : 'JPEG';\n              const cellX = cellData.cell.x;\n              const cellY = cellData.cell.y;\n              const cellWidth = cellData.cell.width;\n              const cellHeight = cellData.cell.height;\n              \n              pdf.addImage(\n                observer.signatureDataUrl,\n                format,\n                cellX + 1,\n                cellY + 1,\n                cellWidth - 2,\n                cellHeight - 2,\n                undefined,\n                'FAST'\n              );\n            } catch (error) {\n              console.error('Error adding signature image:', error);\n            }\n          }\n        }\n      },\n      margin: { left: margin, right: margin },\n    });\n\n    return (pdf as any).lastAutoTable.finalY;\n  };\n\n  // Helper function to draw footer\n  const drawFooter = (pageNum: number, totalPages: number) => {\n    pdf.setFont('helvetica', 'normal');\n    pdf.setFontSize(8);\n    pdf.text('Mei 2022/R1', margin, pageHeight - 10);\n    pdf.text(`Page ${pageNum} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });\n  };\n\n  // Split records into chunks of EMPLOYEES_PER_PAGE\n  const chunks: SidakFatigueRecord[][] = [];\n  for (let i = 0; i < data.records.length; i += EMPLOYEES_PER_PAGE) {\n    chunks.push(data.records.slice(i, i + EMPLOYEES_PER_PAGE));\n  }\n\n  // If no records, create a single page with empty table\n  if (chunks.length === 0) {\n    chunks.push([]);\n  }\n\n  const totalPages = chunks.length;\n\n  // Generate pages\n  for (let pageIndex = 0; pageIndex < chunks.length; pageIndex++) {\n    if (pageIndex > 0) {\n      pdf.addPage();\n    }\n\n    let yPosition = margin;\n    \n    // Draw header and info section\n    yPosition = drawHeaderAndInfo(yPosition);\n    \n    // Draw employee table for this chunk\n    const startIndex = pageIndex * EMPLOYEES_PER_PAGE;\n    yPosition = drawEmployeeTable(chunks[pageIndex], startIndex, yPosition);\n    \n    // Add observer signatures on every page (identical format)\n    drawObserverSignatures(yPosition);\n    \n    // Draw footer with page numbers\n    drawFooter(pageIndex + 1, totalPages);\n  }\n\n  return pdf;\n}\n\n// ============================================\n// JPG EXPORT FOR SIDAK FATIGUE\n// Using PDF.js with bundled worker (Vite-compatible approach)\n// ============================================\nexport async function downloadSidakFatigueAsJpg(data: SidakFatigueData, filename: string): Promise<void> {\n  // Guard against server-side execution (SSR/Node.js)\n  if (typeof window === 'undefined' || typeof document === 'undefined') {\n    throw new Error('JPG download can only be executed in browser environment');\n  }\n  \n  try {\n    // Import PDF.js from legacy build (better Vite compatibility)\n    const pdfjsLib = await import('pdfjs-dist/legacy/build/pdf');\n    \n    // Import bundled worker as URL (Vite will handle this properly)\n    const workerSrc = await import('pdfjs-dist/legacy/build/pdf.worker.min.mjs?url');\n    \n    // Configure PDF.js to use bundled worker\n    pdfjsLib.GlobalWorkerOptions.workerSrc = workerSrc.default;\n    \n    // Generate the PDF\n    const pdf = await generateSidakFatiguePdf(data);\n    \n    // Get PDF as array buffer\n    const pdfArrayBuffer = pdf.output('arraybuffer');\n    \n    // Load PDF with PDF.js\n    const loadingTask = pdfjsLib.getDocument({ data: pdfArrayBuffer });\n    const pdfDocument = await loadingTask.promise;\n    \n    const totalPages = pdfDocument.numPages;\n    const scale = 2.5;\n\n    // Helper function to download a single page as JPG\n    const downloadPage = async (pageNum: number): Promise<void> => {\n      const page = await pdfDocument.getPage(pageNum);\n      const viewport = page.getViewport({ scale });\n      \n      const canvas = document.createElement('canvas');\n      const context = canvas.getContext('2d');\n      \n      if (!context) {\n        throw new Error('Could not get canvas context');\n      }\n      \n      canvas.width = viewport.width;\n      canvas.height = viewport.height;\n      \n      context.fillStyle = '#ffffff';\n      context.fillRect(0, 0, canvas.width, canvas.height);\n      \n      const renderContext = {\n        canvasContext: context,\n        viewport: viewport,\n      };\n      \n      await page.render(renderContext).promise;\n      \n      return new Promise((resolve, reject) => {\n        canvas.toBlob(\n          (blob) => {\n            if (!blob) {\n              reject(new Error('Failed to create JPG blob'));\n              return;\n            }\n            \n            // Create filename with page number if multiple pages\n            const pageFilename = totalPages > 1 \n              ? filename.replace('.jpg', `_Page${pageNum}.jpg`).replace('.jpeg', `_Page${pageNum}.jpeg`)\n              : filename;\n            \n            const url = URL.createObjectURL(blob);\n            const link = document.createElement('a');\n            link.href = url;\n            link.download = pageFilename;\n            document.body.appendChild(link);\n            link.click();\n            document.body.removeChild(link);\n            URL.revokeObjectURL(url);\n            \n            resolve();\n          },\n          'image/jpeg',\n          0.95\n        );\n      });\n    };\n\n    // Download all pages sequentially with a small delay between downloads\n    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {\n      await downloadPage(pageNum);\n      // Small delay between downloads to ensure browser handles them properly\n      if (pageNum < totalPages) {\n        await new Promise(resolve => setTimeout(resolve, 500));\n      }\n    }\n  } catch (error) {\n    throw new Error(`Failed to generate JPG: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\n// ============================================\n// SIDAK ROSTER PDF GENERATOR\n// Form: BIB-HSE-PPO-F\n// ============================================\n\ninterface SidakRosterData {\n  session: SidakRosterSession;\n  records: SidakRosterRecord[];\n  observers: SidakRosterObserver[];\n}\n\nexport async function generateSidakRosterPdf(data: SidakRosterData): Promise<jsPDF> {\n  // Changed to landscape A4 (297mm x 210mm) to match template\n  const pdf = new jsPDF('landscape', 'mm', 'a4');\n  const pageWidth = pdf.internal.pageSize.width; // 297mm\n  const pageHeight = pdf.internal.pageSize.height; // 210mm\n  const margin = 10;\n  let yPosition = margin;\n\n  // ==================== HEADER WITH LOGO ====================\n  // Load and add company logo (async)\n  try {\n    const logoImg = await new Promise<HTMLImageElement>((resolve, reject) => {\n      const img = new Image();\n      img.onload = () => resolve(img);\n      img.onerror = reject;\n      img.src = '/assets/logo.png';\n    });\n    \n    // Add logo to top-left corner with proper dimensions\n    pdf.addImage(logoImg, 'PNG', margin, margin, 45, 10);\n  } catch (error) {\n    // Fallback to text logo if image fails\n    pdf.setFont('helvetica', 'bold');\n    pdf.setFontSize(10);\n    pdf.setTextColor(0, 0, 0);\n    pdf.text('PT BORNEO INDOBARA', margin, yPosition + 6);\n  }\n\n  // Form code on top-right\n  pdf.setFont('helvetica', 'normal');\n  pdf.setFontSize(9);\n  pdf.setTextColor(0, 0, 0);\n  pdf.text('BIB â€“ HSE â€“ PPO â€“ F â€“ xxx - xx', pageWidth - margin, yPosition + 4, { align: 'right' });\n  \n  yPosition += 12; // Space after logo for proper layout\n  \n  // Main title with gray background\n  const titleYStart = yPosition;\n  pdf.setFillColor(220, 220, 220); // Gray background\n  pdf.rect(margin, titleYStart, pageWidth - (margin * 2), 8, 'F');\n  \n  pdf.setFont('helvetica', 'bold');\n  pdf.setFontSize(14);\n  pdf.setTextColor(0, 0, 0);\n  pdf.text('SIDAK ROSTER/ GILIR KERJA', pageWidth / 2, titleYStart + 5.5, { align: 'center' });\n  \n  yPosition += 10;\n  \n  // Subtitle - center aligned italic\n  pdf.setFontSize(8);\n  pdf.setFont('helvetica', 'italic');\n  pdf.text('Membandingkan antara data absensi karyawan dengan plan roster', pageWidth / 2, yPosition + 2, { align: 'center' });\n  \n  yPosition += 4; // Reduced spacing before info table\n\n  // ==================== INFO SECTION (2-column layout) ====================\n  // Left column: Tanggal, Jam, Shift\n  // Right column: Perusahaan, Departemen, Lokasi\n  const infoTableData = [\n    ['Tanggal Pelaksanaan', data.session.tanggalPelaksanaan || '', 'Perusahaan', data.session.perusahaan || ''],\n    ['Jam Pelaksanaan', data.session.jamPelaksanaan || '', 'Departemen', data.session.departemen || ''],\n    ['Shift', data.session.shift || '', 'Lokasi', data.session.lokasi || '']\n  ];\n  \n  autoTable(pdf, {\n    startY: yPosition,\n    body: infoTableData,\n    theme: 'grid',\n    tableWidth: pageWidth - (margin * 2),\n    styles: {\n      fontSize: 8,\n      cellPadding: 1.5,\n      lineWidth: 0.2,\n      lineColor: [0, 0, 0],\n      textColor: [0, 0, 0],\n      valign: 'middle',\n    },\n    columnStyles: {\n      0: { cellWidth: 50, fontStyle: 'bold', fillColor: [255, 255, 255], halign: 'left' },\n      1: { cellWidth: (pageWidth - (margin * 2)) / 2 - 50, halign: 'left' },\n      2: { cellWidth: 50, fontStyle: 'bold', fillColor: [255, 255, 255], halign: 'left' },\n      3: { cellWidth: (pageWidth - (margin * 2)) / 2 - 50, halign: 'left' },\n    },\n    margin: { left: margin, right: margin },\n  });\n\n  yPosition = (pdf as any).lastAutoTable.finalY + 2; // Reduced gap\n\n  // ==================== EMPLOYEE ROSTER COMPLIANCE TABLE ====================\n  // Template columns: NO | Nama-NIK | No lambung | Apakah roster driver sudah sesuai (Ya/Tidak split) | Keterangan\n  const tableHeaders = [\n    [\n      { content: 'NO', rowSpan: 2 },\n      { content: 'Nama-NIK\\n(contoh : Gede â€“ C-024955)', rowSpan: 2 },\n      { content: 'No lambung\\n(contoh : RBT 4023)', rowSpan: 2 },\n      { content: 'Apakah roster driver sudah sesuai', colSpan: 2 },\n      { content: 'Keterangan', rowSpan: 2 }\n    ],\n    ['Ya', 'Tidak']\n  ];\n\n  const tableData = data.records.map((record, index) => [\n    (index + 1).toString(),\n    `${record.nama}\\n${record.nik}`,\n    record.nomorLambung || '-',\n    record.rosterSesuai ? '\\u2713' : '', // Ya column\n    record.rosterSesuai ? '' : '\\u2713', // Tidak column\n    record.keterangan || '',\n  ]);\n\n  // Calculate exact available width for table\n  const availableWidth = pageWidth - (margin * 2); // 277mm\n  \n  autoTable(pdf, {\n    startY: yPosition,\n    head: tableHeaders,\n    body: tableData,\n    theme: 'grid',\n    tableWidth: availableWidth,\n    styles: {\n      fontSize: 6,\n      cellPadding: 0.5,\n      halign: 'center',\n      valign: 'middle',\n      lineWidth: 0.1,\n      lineColor: [0, 0, 0],\n      minCellHeight: 6.5, // Increased row height for better readability (like Fatigue)\n    },\n    headStyles: {\n      fillColor: [220, 220, 220], // Gray background like template\n      textColor: [0, 0, 0],\n      fontStyle: 'bold',\n      halign: 'center',\n      valign: 'middle',\n      lineWidth: 0.2,\n      fontSize: 6,\n      cellPadding: 0.5,\n    },\n    columnStyles: {\n      // Total = 277mm, now with 6 columns (Ya/Tidak split)\n      0: { cellWidth: 12 }, // NO\n      1: { cellWidth: 75, halign: 'left', fontSize: 5.5 }, // Nama-NIK (wider for combined field)\n      2: { cellWidth: 30 }, // No lambung\n      3: { cellWidth: 45 }, // Ya column (half of previous 90mm)\n      4: { cellWidth: 45 }, // Tidak column (half of previous 90mm)\n      5: { cellWidth: 70, halign: 'left' }, // Keterangan\n    },\n    margin: { left: margin, right: margin },\n    didDrawCell: (cellData) => {\n      // Draw checkmark manually for Ya column (3) and Tidak column (4)\n      if ((cellData.column.index === 3 || cellData.column.index === 4) && cellData.section === 'body') {\n        const cellText = cellData.cell.text[0];\n        if (cellText === '\\u2713' || cellText === 'âœ“') {\n          // Draw checkmark manually\n          const x = cellData.cell.x + cellData.cell.width / 2;\n          const y = cellData.cell.y + cellData.cell.height / 2;\n          const size = 1.8;\n          \n          pdf.setLineWidth(0.3);\n          pdf.setDrawColor(0, 0, 0);\n          \n          // First line: bottom-left to middle\n          pdf.line(x - size, y, x - size/3, y + size);\n          // Second line: middle to top-right\n          pdf.line(x - size/3, y + size, x + size, y - size);\n        }\n      }\n    }\n  });\n\n  yPosition = (pdf as any).lastAutoTable.finalY + 1.5; // Reduced gap to observer section\n\n  // ==================== OBSERVER SIGNATURES ====================\n  // Disable new page - always fit on single page\n  // Create table for observers (6 positions in 3 rows x 2 columns)\n  // Row 1: Observer 1 (left) | Observer 4 (right)\n  // Row 2: Observer 2 (left) | Observer 5 (right)\n  // Row 3: Observer 3 (left) | Observer 6 (right)\n  const observerTableData = [\n    [\n      '1.', data.observers[0]?.nama || '', data.observers[0]?.perusahaan || '', '',\n      '4.', data.observers[3]?.nama || '', data.observers[3]?.perusahaan || '', ''\n    ],\n    [\n      '2.', data.observers[1]?.nama || '', data.observers[1]?.perusahaan || '', '',\n      '5.', data.observers[4]?.nama || '', data.observers[4]?.perusahaan || '', ''\n    ],\n    [\n      '3.', data.observers[2]?.nama || '', data.observers[2]?.perusahaan || '', '',\n      '6.', data.observers[5]?.nama || '', data.observers[5]?.perusahaan || '', ''\n    ]\n  ];\n\n  autoTable(pdf, {\n    startY: yPosition,\n    head: [[\n      'NO', 'NAMA', 'PERUSAHAAN', 'TANDA TANGAN',\n      'NO', 'NAMA', 'PERUSAHAAN', 'TANDA TANGAN'\n    ]],\n    body: observerTableData,\n    theme: 'grid',\n    tableWidth: pageWidth - (margin * 2),\n    styles: {\n      fontSize: 6.5,\n      cellPadding: 0.8,\n      halign: 'left',\n      valign: 'middle',\n      minCellHeight: 8, // Reduced observer row height for compact layout (like Fatigue)\n      lineWidth: 0.2,\n      lineColor: [0, 0, 0],\n    },\n    headStyles: {\n      fillColor: [220, 220, 220],\n      textColor: [0, 0, 0],\n      fontStyle: 'bold',\n      halign: 'center',\n      valign: 'middle',\n      cellPadding: 0.8,\n      minCellHeight: 8,\n      lineWidth: 0.3,\n      lineColor: [0, 0, 0],\n    },\n    columnStyles: {\n      0: { cellWidth: 11, halign: 'center' }, // NO (left)\n      1: { cellWidth: 69, halign: 'left' }, // NAMA (left)\n      2: { cellWidth: 32, halign: 'left' }, // JABATAN (left)\n      3: { cellWidth: 26, halign: 'center' }, // TANDA TANGAN (left)\n      4: { cellWidth: 11, halign: 'center' }, // NO (right)\n      5: { cellWidth: 69, halign: 'left' }, // NAMA (right)\n      6: { cellWidth: 32, halign: 'left' }, // JABATAN (right)\n      7: { cellWidth: 26, halign: 'center' }, // TANDA TANGAN (right)\n    },\n    didDrawCell: (cellData) => {\n      // Add signature images to TANDA TANGAN columns (columns 3 and 7)\n      if ((cellData.column.index === 3 || cellData.column.index === 7) && cellData.section === 'body') {\n        const rowIndex = cellData.row.index; // 0, 1, or 2\n        // Column 3 = left observer (0, 1, 2), Column 7 = right observer (3, 4, 5)\n        const observerIndex = cellData.column.index === 3 ? rowIndex : rowIndex + 3;\n        const observer = data.observers[observerIndex];\n        \n        if (observer?.signatureDataUrl) {\n          try {\n            const format = observer.signatureDataUrl.includes('image/png') ? 'PNG' : 'JPEG';\n            const cellX = cellData.cell.x;\n            const cellY = cellData.cell.y;\n            const cellWidth = cellData.cell.width;\n            const cellHeight = cellData.cell.height;\n            \n            pdf.addImage(\n              observer.signatureDataUrl,\n              format,\n              cellX + 1,\n              cellY + 1,\n              cellWidth - 2,\n              cellHeight - 2,\n              undefined,\n              'FAST'\n            );\n          } catch (error) {\n            console.error('Error adding signature image:', error);\n          }\n        }\n      }\n    },\n    margin: { left: margin, right: margin },\n  });\n\n  // Add page footer with date and page number\n  const finalY = (pdf as any).lastAutoTable.finalY;\n  pdf.setFont('helvetica', 'normal');\n  pdf.setFontSize(8);\n  pdf.text('Januari 2020/R0', margin, pageHeight - 5);\n  pdf.text('Page 1 of 1', pageWidth - margin, pageHeight - 5, { align: 'right' });\n\n  return pdf;\n}\n\n// ============================================\n// JPG EXPORT FOR SIDAK ROSTER\n// Using PDF.js with bundled worker (same approach as Fatigue)\n// ============================================\nexport async function downloadSidakRosterAsJpg(data: SidakRosterData, filename: string): Promise<void> {\n  // Guard against server-side execution (SSR/Node.js)\n  if (typeof window === 'undefined' || typeof document === 'undefined') {\n    throw new Error('JPG download can only be executed in browser environment');\n  }\n  \n  try {\n    // Import PDF.js from legacy build (better Vite compatibility)\n    const pdfjsLib = await import('pdfjs-dist/legacy/build/pdf');\n    \n    // Import bundled worker as URL (Vite will handle this properly)\n    // Note: Using .mjs extension as that's what's available in legacy build\n    const workerSrc = await import('pdfjs-dist/legacy/build/pdf.worker.min.mjs?url');\n    \n    // Configure PDF.js to use bundled worker\n    pdfjsLib.GlobalWorkerOptions.workerSrc = workerSrc.default;\n    \n    // Generate the PDF\n    const pdf = await generateSidakRosterPdf(data);\n    \n    // Get PDF as array buffer\n    const pdfArrayBuffer = pdf.output('arraybuffer');\n    \n    // Load PDF with PDF.js\n    const loadingTask = pdfjsLib.getDocument({ data: pdfArrayBuffer });\n    const pdfDocument = await loadingTask.promise;\n    \n    // Get the first page\n    const page = await pdfDocument.getPage(1);\n    \n    // Set render scale for high quality (2-3x for crisp output)\n    const scale = 2.5;\n    const viewport = page.getViewport({ scale });\n    \n    // Create canvas\n    const canvas = document.createElement('canvas');\n    const context = canvas.getContext('2d');\n    \n    if (!context) {\n      throw new Error('Could not get canvas context');\n    }\n    \n    canvas.width = viewport.width;\n    canvas.height = viewport.height;\n    \n    // Fill white background\n    context.fillStyle = '#ffffff';\n    context.fillRect(0, 0, canvas.width, canvas.height);\n    \n    // Render PDF page to canvas\n    const renderContext = {\n      canvasContext: context,\n      viewport: viewport,\n    };\n    \n    await page.render(renderContext).promise;\n    \n    // Convert canvas to JPG blob\n    return new Promise((resolve, reject) => {\n      canvas.toBlob(\n        (blob) => {\n          if (!blob) {\n            reject(new Error('Failed to create JPG blob'));\n            return;\n          }\n          \n          // Download\n          const url = URL.createObjectURL(blob);\n          const link = document.createElement('a');\n          link.href = url;\n          link.download = filename;\n          document.body.appendChild(link);\n          link.click();\n          document.body.removeChild(link);\n          URL.revokeObjectURL(url);\n          \n          resolve();\n        },\n        'image/jpeg',\n        0.95 // 95% quality\n      );\n    });\n  } catch (error) {\n    throw new Error(`Failed to generate JPG: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n","path":null,"size_bytes":29815,"size_tokens":null},"client/src/pages/sidak-roster-history.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { ClipboardList, Download, Calendar, Clock, MapPin, Building2, ArrowLeft, ChevronDown, FileText, Image } from \"lucide-react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { generateSidakRosterPdf, downloadSidakRosterAsJpg } from \"@/lib/sidak-pdf-utils\";\nimport type { SidakRosterSession, SidakRosterRecord, SidakRosterObserver } from \"@shared/schema\";\nimport { format } from \"date-fns\";\nimport { id } from \"date-fns/locale\";\nimport { useState } from \"react\";\n\ninterface SessionWithDetails extends SidakRosterSession {\n  records?: SidakRosterRecord[];\n  observers?: SidakRosterObserver[];\n}\n\nexport default function SidakRosterHistory() {\n  const { toast } = useToast();\n  const [downloadingId, setDownloadingId] = useState<string | null>(null);\n  const [downloadingJpgId, setDownloadingJpgId] = useState<string | null>(null);\n\n  const { data: sessions, isLoading } = useQuery<SessionWithDetails[]>({\n    queryKey: ['/api/sidak-roster'],\n  });\n\n  const handleDownloadPDF = async (sessionId: string) => {\n    try {\n      setDownloadingId(sessionId);\n      \n      // Fetch full session data with records and observers\n      const response = await fetch(`/api/sidak-roster/${sessionId}`);\n      if (!response.ok) {\n        throw new Error('Gagal mengambil data session');\n      }\n      \n      const sessionData = await response.json();\n      \n      // Generate PDF - sessionData is already the full object with records and observers\n      const pdf = await generateSidakRosterPdf({\n        session: sessionData,\n        records: sessionData.records || [],\n        observers: sessionData.observers || [],\n      });\n      \n      // Download PDF\n      const fileName = `Sidak_Roster_${sessionData.tanggalPelaksanaan}_${sessionData.shift.replace(' ', '_')}.pdf`;\n      pdf.save(fileName);\n      \n      toast({\n        title: \"PDF berhasil diunduh\",\n        description: `File ${fileName} telah tersimpan`,\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Gagal mengunduh PDF\",\n        description: error.message || \"Terjadi kesalahan saat membuat PDF\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setDownloadingId(null);\n    }\n  };\n\n  const handleDownloadJPG = async (sessionId: string) => {\n    try {\n      setDownloadingJpgId(sessionId);\n      \n      // Fetch full session data with records and observers\n      const response = await fetch(`/api/sidak-roster/${sessionId}`);\n      if (!response.ok) {\n        throw new Error('Gagal mengambil data session');\n      }\n      \n      const sessionData = await response.json();\n      \n      // Generate and download JPG\n      const fileName = `Sidak_Roster_${sessionData.tanggalPelaksanaan}_${sessionData.shift.replace(' ', '_')}_${Date.now()}.jpg`;\n      await downloadSidakRosterAsJpg({\n        session: sessionData,\n        records: sessionData.records || [],\n        observers: sessionData.observers || [],\n      }, fileName);\n      \n      toast({\n        title: \"JPG berhasil diunduh\",\n        description: `File ${fileName} telah tersimpan`,\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Gagal mengunduh JPG\",\n        description: error.message || \"Terjadi kesalahan saat membuat JPG\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setDownloadingJpgId(null);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-purple-50 to-purple-100 dark:from-gray-900 dark:to-gray-800\">\n      <div className=\"container max-w-2xl mx-auto p-3 md:p-4 space-y-4\">\n        {/* Header - More compact for mobile */}\n        <div className=\"flex items-center gap-3 pt-2\">\n          <Link href=\"/workspace/sidak\">\n            <Button variant=\"outline\" size=\"icon\" className=\"h-9 w-9\" data-testid=\"button-back-sidak\">\n              <ArrowLeft className=\"h-4 w-4\" />\n            </Button>\n          </Link>\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center gap-2\">\n              <ClipboardList className=\"h-6 w-6 text-purple-600 flex-shrink-0\" />\n              <h1 className=\"text-lg md:text-xl font-bold text-gray-900 dark:text-white truncate\">\n                Riwayat Sidak Roster\n              </h1>\n            </div>\n            <p className=\"text-gray-500 dark:text-gray-400 text-xs mt-0.5\">\n              Form BIB-HSE-PPO-F - Pemeriksaan Kesesuaian Roster\n            </p>\n          </div>\n        </div>\n\n        {isLoading ? (\n          <div className=\"text-center py-12\">\n            <div className=\"animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600 mx-auto\"></div>\n            <p className=\"text-gray-600 dark:text-gray-400 mt-3 text-sm\">Memuat data...</p>\n          </div>\n        ) : !sessions || sessions.length === 0 ? (\n          <Card className=\"text-center py-10\">\n            <CardContent className=\"pt-0\">\n              <ClipboardList className=\"h-12 w-12 text-gray-400 mx-auto mb-3\" />\n              <p className=\"text-gray-600 dark:text-gray-400\">\n                Belum ada riwayat Sidak Roster\n              </p>\n              <Link href=\"/workspace/sidak/roster/new\">\n                <Button className=\"mt-4 bg-purple-600 hover:bg-purple-700\" size=\"sm\" data-testid=\"button-create-new\">\n                  <ClipboardList className=\"h-4 w-4 mr-2\" />\n                  Buat Sidak Baru\n                </Button>\n              </Link>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-3\">\n            {sessions.map((session) => (\n              <Card \n                key={session.id} \n                className=\"overflow-hidden border border-purple-200 dark:border-purple-800 shadow-sm\"\n                data-testid={`card-session-${session.id}`}\n              >\n                <CardContent className=\"p-4\">\n                  {/* Header row with title and badge */}\n                  <div className=\"flex items-start justify-between gap-2 mb-3\">\n                    <h3 className=\"font-semibold text-purple-900 dark:text-purple-100\">\n                      Sidak Roster - {session.shift}\n                    </h3>\n                    <Badge variant=\"outline\" className=\"bg-purple-50 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 text-xs flex-shrink-0\">\n                      {session.totalSampel} Karyawan\n                    </Badge>\n                  </div>\n                  \n                  {/* Date and time - compact */}\n                  <div className=\"flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-600 dark:text-gray-400 mb-3\">\n                    <div className=\"flex items-center gap-1.5\">\n                      <Calendar className=\"h-3.5 w-3.5\" />\n                      <span>{format(new Date(session.tanggalPelaksanaan), 'EEEE, dd MMMM yyyy', { locale: id })}</span>\n                    </div>\n                    <div className=\"flex items-center gap-1.5\">\n                      <Clock className=\"h-3.5 w-3.5\" />\n                      <span>{session.jamPelaksanaan}</span>\n                    </div>\n                  </div>\n                  \n                  {/* Location info - compact grid */}\n                  <div className=\"grid grid-cols-3 gap-2 text-xs mb-3\">\n                    <div>\n                      <div className=\"flex items-center gap-1 text-purple-600 dark:text-purple-400 mb-0.5\">\n                        <MapPin className=\"h-3 w-3\" />\n                        <span className=\"font-medium\">Lokasi</span>\n                      </div>\n                      <p className=\"text-gray-600 dark:text-gray-400 truncate\">{session.lokasi}</p>\n                    </div>\n                    <div>\n                      <div className=\"flex items-center gap-1 text-purple-600 dark:text-purple-400 mb-0.5\">\n                        <Building2 className=\"h-3 w-3\" />\n                        <span className=\"font-medium\">PT</span>\n                      </div>\n                      <p className=\"text-gray-600 dark:text-gray-400 truncate\">{session.perusahaan}</p>\n                    </div>\n                    <div>\n                      <div className=\"flex items-center gap-1 text-purple-600 dark:text-purple-400 mb-0.5\">\n                        <Building2 className=\"h-3 w-3\" />\n                        <span className=\"font-medium\">Dept</span>\n                      </div>\n                      <p className=\"text-gray-600 dark:text-gray-400 truncate\">{session.departemen}</p>\n                    </div>\n                  </div>\n                  \n                  {/* Single download dropdown */}\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button\n                        disabled={downloadingId === session.id || downloadingJpgId === session.id}\n                        className=\"w-full bg-purple-600 hover:bg-purple-700 text-white h-9\"\n                        data-testid={`button-download-${session.id}`}\n                      >\n                        <Download className=\"h-4 w-4 mr-2\" />\n                        {(downloadingId === session.id || downloadingJpgId === session.id) ? 'Mengunduh...' : 'Download'}\n                        <ChevronDown className=\"h-4 w-4 ml-auto\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\" className=\"w-48\">\n                      <DropdownMenuItem onClick={() => handleDownloadPDF(session.id)} data-testid={`button-download-pdf-${session.id}`}>\n                        <FileText className=\"h-4 w-4 mr-2\" />\n                        Download PDF\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => handleDownloadJPG(session.id)} data-testid={`button-download-jpg-${session.id}`}>\n                        <Image className=\"h-4 w-4 mr-2\" />\n                        Download JPG\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10417,"size_tokens":null},"client/src/pages/sidak-fatigue-history.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Activity, Download, Calendar, Clock, MapPin, Building2, ArrowLeft, ChevronDown, FileText, Image } from \"lucide-react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { generateSidakFatiguePdf, downloadSidakFatigueAsJpg } from \"@/lib/sidak-pdf-utils\";\nimport type { SidakFatigueSession, SidakFatigueRecord, SidakFatigueObserver } from \"@shared/schema\";\nimport { format } from \"date-fns\";\nimport { id } from \"date-fns/locale\";\nimport { useState } from \"react\";\n\ninterface SessionWithDetails extends SidakFatigueSession {\n  records?: SidakFatigueRecord[];\n  observers?: SidakFatigueObserver[];\n}\n\nexport default function SidakFatigueHistory() {\n  const { toast } = useToast();\n  const [downloadingId, setDownloadingId] = useState<string | null>(null);\n\n  const { data: sessions, isLoading } = useQuery<SessionWithDetails[]>({\n    queryKey: ['/api/sidak-fatigue'],\n  });\n\n  const handleDownloadPDF = async (sessionId: string) => {\n    try {\n      setDownloadingId(sessionId);\n      \n      // Fetch full session data with records and observers\n      const response = await fetch(`/api/sidak-fatigue/${sessionId}`);\n      if (!response.ok) {\n        throw new Error('Gagal mengambil data session');\n      }\n      \n      const sessionData = await response.json();\n      \n      // Generate PDF - sessionData is already the full object with records and observers\n      const pdf = await generateSidakFatiguePdf({\n        session: sessionData,\n        records: sessionData.records || [],\n        observers: sessionData.observers || [],\n      });\n      \n      // Download PDF\n      const fileName = `Sidak_Fatigue_${sessionData.tanggal}_${sessionData.shift.replace(' ', '_')}.pdf`;\n      pdf.save(fileName);\n      \n      toast({\n        title: \"PDF berhasil diunduh\",\n        description: `File ${fileName} telah tersimpan`,\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Gagal mengunduh PDF\",\n        description: error.message || \"Terjadi kesalahan saat membuat PDF\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setDownloadingId(null);\n    }\n  };\n\n  const handleDownloadJPG = async (sessionId: string) => {\n    try {\n      setDownloadingId(sessionId);\n      \n      // Fetch full session data with records and observers\n      const response = await fetch(`/api/sidak-fatigue/${sessionId}`);\n      if (!response.ok) {\n        throw new Error('Gagal mengambil data session');\n      }\n      \n      const sessionData = await response.json();\n      \n      // Download as JPG - use .jpg extension\n      const fileName = `Sidak_Fatigue_${sessionData.tanggal}_${sessionData.shift.replace(' ', '_')}.jpg`;\n      await downloadSidakFatigueAsJpg({\n        session: sessionData,\n        records: sessionData.records || [],\n        observers: sessionData.observers || [],\n      }, fileName);\n      \n      toast({\n        title: \"JPG berhasil diunduh\",\n        description: `File ${fileName} telah tersimpan`,\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Gagal mengunduh JPG\",\n        description: error.message || \"Terjadi kesalahan saat membuat JPG\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setDownloadingId(null);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 dark:from-gray-900 dark:to-gray-800\">\n      <div className=\"container max-w-2xl mx-auto p-3 md:p-4 space-y-4\">\n        {/* Header - More compact for mobile */}\n        <div className=\"flex items-center gap-3 pt-2\">\n          <Link href=\"/workspace/sidak\">\n            <Button variant=\"outline\" size=\"icon\" className=\"h-9 w-9\" data-testid=\"button-back-sidak\">\n              <ArrowLeft className=\"h-4 w-4\" />\n            </Button>\n          </Link>\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center gap-2\">\n              <Activity className=\"h-6 w-6 text-blue-600 flex-shrink-0\" />\n              <h1 className=\"text-lg md:text-xl font-bold text-gray-900 dark:text-white truncate\">\n                Riwayat Sidak Fatigue\n              </h1>\n            </div>\n            <p className=\"text-gray-500 dark:text-gray-400 text-xs mt-0.5\">\n              Form BIB-HSE-ES-F-3.02-16 - Pemeriksaan Kelelahan Karyawan\n            </p>\n          </div>\n        </div>\n\n        {isLoading ? (\n          <div className=\"text-center py-12\">\n            <div className=\"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto\"></div>\n            <p className=\"text-gray-600 dark:text-gray-400 mt-3 text-sm\">Memuat data...</p>\n          </div>\n        ) : !sessions || sessions.length === 0 ? (\n          <Card className=\"text-center py-10\">\n            <CardContent className=\"pt-0\">\n              <Activity className=\"h-12 w-12 text-gray-400 mx-auto mb-3\" />\n              <p className=\"text-gray-600 dark:text-gray-400\">\n                Belum ada riwayat Sidak Fatigue\n              </p>\n              <Link href=\"/workspace/sidak/fatigue/new\">\n                <Button className=\"mt-4 bg-blue-600 hover:bg-blue-700\" size=\"sm\" data-testid=\"button-create-new\">\n                  <Activity className=\"h-4 w-4 mr-2\" />\n                  Buat Sidak Baru\n                </Button>\n              </Link>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-3\">\n            {sessions.map((session) => (\n              <Card \n                key={session.id} \n                className=\"overflow-hidden border border-blue-200 dark:border-blue-800 shadow-sm\"\n                data-testid={`card-session-${session.id}`}\n              >\n                <CardContent className=\"p-4\">\n                  {/* Header row with title and badge */}\n                  <div className=\"flex items-start justify-between gap-2 mb-3\">\n                    <h3 className=\"font-semibold text-blue-900 dark:text-blue-100\">\n                      Sidak Fatigue - {session.shift}\n                    </h3>\n                    <Badge variant=\"outline\" className=\"bg-blue-50 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs flex-shrink-0\">\n                      {session.totalSampel} Karyawan\n                    </Badge>\n                  </div>\n                  \n                  {/* Date and time - compact */}\n                  <div className=\"flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-600 dark:text-gray-400 mb-3\">\n                    <div className=\"flex items-center gap-1.5\">\n                      <Calendar className=\"h-3.5 w-3.5\" />\n                      <span>{format(new Date(session.tanggal), 'EEEE, dd MMMM yyyy', { locale: id })}</span>\n                    </div>\n                    <div className=\"flex items-center gap-1.5\">\n                      <Clock className=\"h-3.5 w-3.5\" />\n                      <span>{session.waktuMulai} - {session.waktuSelesai}</span>\n                    </div>\n                  </div>\n                  \n                  {/* Location info - compact grid */}\n                  <div className=\"grid grid-cols-3 gap-2 text-xs mb-3\">\n                    <div>\n                      <div className=\"flex items-center gap-1 text-blue-600 dark:text-blue-400 mb-0.5\">\n                        <MapPin className=\"h-3 w-3\" />\n                        <span className=\"font-medium\">Lokasi</span>\n                      </div>\n                      <p className=\"text-gray-600 dark:text-gray-400 truncate\">{session.lokasi}</p>\n                    </div>\n                    <div>\n                      <div className=\"flex items-center gap-1 text-blue-600 dark:text-blue-400 mb-0.5\">\n                        <Building2 className=\"h-3 w-3\" />\n                        <span className=\"font-medium\">Area</span>\n                      </div>\n                      <p className=\"text-gray-600 dark:text-gray-400 truncate\">{session.area}</p>\n                    </div>\n                    <div>\n                      <div className=\"flex items-center gap-1 text-blue-600 dark:text-blue-400 mb-0.5\">\n                        <Building2 className=\"h-3 w-3\" />\n                        <span className=\"font-medium\">Dept</span>\n                      </div>\n                      <p className=\"text-gray-600 dark:text-gray-400 truncate\">{session.departemen}</p>\n                    </div>\n                  </div>\n                  \n                  {/* Single download dropdown */}\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button\n                        disabled={downloadingId === session.id}\n                        className=\"w-full bg-blue-600 hover:bg-blue-700 text-white h-9\"\n                        data-testid={`button-download-${session.id}`}\n                      >\n                        <Download className=\"h-4 w-4 mr-2\" />\n                        {downloadingId === session.id ? 'Mengunduh...' : 'Download'}\n                        <ChevronDown className=\"h-4 w-4 ml-auto\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\" className=\"w-48\">\n                      <DropdownMenuItem onClick={() => handleDownloadPDF(session.id)} data-testid={`button-download-pdf-${session.id}`}>\n                        <FileText className=\"h-4 w-4 mr-2\" />\n                        Download PDF\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => handleDownloadJPG(session.id)} data-testid={`button-download-jpg-${session.id}`}>\n                        <Image className=\"h-4 w-4 mr-2\" />\n                        Download JPG\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10203,"size_tokens":null},"client/src/components/sidak/sidak-employee-scanner.tsx":{"content":"import { useEffect, useRef, useState } from \"react\";\nimport jsQR from \"jsqr\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Camera, X } from \"lucide-react\";\nimport { validateQRData } from \"@/lib/crypto-utils\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Employee } from \"@shared/schema\";\n\ninterface SidakEmployeeScannerProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onEmployeeScanned: (employee: Employee) => void;\n}\n\nexport function SidakEmployeeScanner({ isOpen, onClose, onEmployeeScanned }: SidakEmployeeScannerProps) {\n  const [isScanning, setIsScanning] = useState(false);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const streamRef = useRef<MediaStream | null>(null);\n  const { toast } = useToast();\n\n  const startCamera = async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({\n        video: { facingMode: \"environment\" }\n      });\n\n      if (videoRef.current) {\n        videoRef.current.srcObject = stream;\n        streamRef.current = stream;\n        setIsScanning(true);\n      }\n    } catch (error) {\n      console.error(\"Error accessing camera:\", error);\n      toast({\n        variant: \"destructive\",\n        title: \"Kamera Error\",\n        description: \"Tidak dapat mengakses kamera. Pastikan izin kamera telah diberikan.\",\n      });\n    }\n  };\n\n  const stopCamera = () => {\n    if (streamRef.current) {\n      streamRef.current.getTracks().forEach(track => track.stop());\n      streamRef.current = null;\n    }\n    setIsScanning(false);\n  };\n\n  const scanQR = async () => {\n    if (!videoRef.current || !canvasRef.current || isProcessing) return;\n\n    const video = videoRef.current;\n    const canvas = canvasRef.current;\n    const context = canvas.getContext(\"2d\");\n\n    if (context && video.readyState === video.HAVE_ENOUGH_DATA) {\n      canvas.height = video.videoHeight;\n      canvas.width = video.videoWidth;\n      context.drawImage(video, 0, 0, canvas.width, canvas.height);\n\n      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);\n      const code = jsQR(imageData.data, imageData.width, imageData.height);\n\n      if (code && code.data) {\n        setIsProcessing(true);\n\n        try {\n          let employeeId: string | null = null;\n\n          // Check if this is a Driver View URL format\n          // Format: https://domain.com/driver-view?nik=C-025660\n          if (code.data.includes('/driver-view?nik=') || code.data.includes('?nik=')) {\n            try {\n              const url = new URL(code.data);\n              const nik = url.searchParams.get('nik');\n              if (nik) {\n                employeeId = nik;\n              }\n            } catch (e) {\n              // Not a valid URL, try other format\n            }\n          }\n\n          // If not Driver View URL, try token-based QR format\n          if (!employeeId) {\n            const qrData = validateQRData(code.data);\n            if (qrData && qrData.id) {\n              employeeId = qrData.id;\n            }\n          }\n\n          if (!employeeId) {\n            throw new Error(\"QR Code tidak valid - pastikan ini QR Code karyawan\");\n          }\n\n          // Fetch employee data from backend\n          const employee = await apiRequest(`/api/employees/${employeeId}`, \"GET\") as Employee;\n\n          if (!employee) {\n            throw new Error(\"Data karyawan tidak ditemukan\");\n          }\n\n          // Call the callback with employee data\n          onEmployeeScanned(employee);\n\n          toast({\n            title: \"Berhasil!\",\n            description: `Data karyawan ${employee.name} berhasil dimuat`,\n          });\n\n          // Stop camera and close dialog\n          stopCamera();\n          onClose();\n\n        } catch (error: any) {\n          console.error(\"Error processing QR:\", error);\n          toast({\n            variant: \"destructive\",\n            title: \"Scan Gagal\",\n            description: error.message || \"QR Code tidak valid atau karyawan tidak ditemukan\",\n          });\n        } finally {\n          setIsProcessing(false);\n        }\n      }\n    }\n  };\n\n  // Scanning loop\n  useEffect(() => {\n    if (isScanning && !isProcessing) {\n      const interval = setInterval(scanQR, 300);\n      return () => clearInterval(interval);\n    }\n  }, [isScanning, isProcessing]);\n\n  // Start camera when dialog opens\n  useEffect(() => {\n    if (isOpen) {\n      startCamera();\n    } else {\n      stopCamera();\n    }\n\n    return () => {\n      stopCamera();\n    };\n  }, [isOpen]);\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Camera className=\"h-5 w-5\" />\n            Scan QR Karyawan\n          </DialogTitle>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          <div className=\"relative bg-black rounded-lg overflow-hidden\" style={{ height: \"400px\" }}>\n            <video\n              ref={videoRef}\n              autoPlay\n              playsInline\n              muted\n              className=\"w-full h-full object-cover\"\n            />\n            <canvas ref={canvasRef} className=\"hidden\" />\n\n            {isProcessing && (\n              <div className=\"absolute inset-0 flex items-center justify-center bg-black/50\">\n                <div className=\"text-white text-center\">\n                  <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-2\"></div>\n                  <p>Memproses...</p>\n                </div>\n              </div>\n            )}\n\n            <div className=\"absolute inset-0 border-4 border-blue-500/30 pointer-events-none\">\n              <div className=\"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 border-4 border-blue-500 rounded-lg\"></div>\n            </div>\n          </div>\n\n          <p className=\"text-sm text-center text-muted-foreground\">\n            Arahkan kamera ke QR Code karyawan untuk mengisi data otomatis\n          </p>\n\n          <Button\n            variant=\"outline\"\n            onClick={() => {\n              stopCamera();\n              onClose();\n            }}\n            className=\"w-full\"\n            data-testid=\"button-close-scanner\"\n          >\n            <X className=\"mr-2 h-4 w-4\" />\n            Tutup Scanner\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":6638,"size_tokens":null},"client/src/pages/evaluasi-driver.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { FileDown, Users, CheckCircle, XCircle, ClipboardList, Search } from \"lucide-react\";\nimport { Bar, Pie } from \"react-chartjs-2\";\nimport {\n  Chart as ChartJS,\n  CategoryScale,\n  LinearScale,\n  BarElement,\n  Title,\n  Tooltip,\n  Legend,\n  ArcElement,\n} from 'chart.js';\nimport * as XLSX from 'xlsx';\nimport jsPDF from 'jspdf';\nimport autoTable from 'jspdf-autotable';\n\n// Register Chart.js components\nChartJS.register(\n  CategoryScale,\n  LinearScale,\n  BarElement,\n  Title,\n  Tooltip,\n  Legend,\n  ArcElement\n);\n\ninterface DriverEvaluation {\n  id: string;\n  nama: string;\n  nik: string;\n  totalSidak: number;\n  status: string;\n}\n\ninterface EvaluationData {\n  summary: {\n    totalDrivers: number;\n    sudahSidak: number;\n    belumSidak: number;\n    totalSidakKeseluruhan: number;\n  };\n  drivers: DriverEvaluation[];\n  month: string;\n}\n\nexport default function EvaluasiDriver() {\n  // Get current month in YYYY-MM format\n  const currentDate = new Date();\n  const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;\n  \n  const [selectedMonth, setSelectedMonth] = useState(currentMonth);\n  const [statusFilter, setStatusFilter] = useState(\"semua\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  // Fetch evaluation data\n  const { data, isLoading } = useQuery<EvaluationData>({\n    queryKey: [`/api/evaluasi-driver?month=${selectedMonth}&status=${statusFilter}`],\n  });\n\n  // Filter drivers by search query\n  const filteredDrivers = useMemo(() => {\n    if (!data?.drivers) return [];\n    \n    const query = searchQuery.toLowerCase();\n    return data.drivers.filter(driver => \n      driver.nama.toLowerCase().includes(query) ||\n      driver.nik.toLowerCase().includes(query)\n    );\n  }, [data?.drivers, searchQuery]);\n\n  // Sort drivers by total SIDAK (descending)\n  const sortedDrivers = useMemo(() => {\n    return [...filteredDrivers].sort((a, b) => b.totalSidak - a.totalSidak);\n  }, [filteredDrivers]);\n\n  // Get top 10 drivers for bar chart\n  const top10Drivers = useMemo(() => {\n    return sortedDrivers.slice(0, 10);\n  }, [sortedDrivers]);\n\n  // Bar chart data\n  const barChartData = {\n    labels: top10Drivers.map(d => d.nama),\n    datasets: [\n      {\n        label: 'Total SIDAK Fatigue',\n        data: top10Drivers.map(d => d.totalSidak),\n        backgroundColor: 'rgba(59, 130, 246, 0.7)',\n        borderColor: 'rgba(59, 130, 246, 1)',\n        borderWidth: 1,\n      },\n    ],\n  };\n\n  const barChartOptions = {\n    responsive: true,\n    maintainAspectRatio: false,\n    plugins: {\n      legend: {\n        display: true,\n        position: 'top' as const,\n      },\n      title: {\n        display: true,\n        text: 'Top 10 Driver dengan SIDAK Terbanyak',\n      },\n    },\n    scales: {\n      y: {\n        beginAtZero: true,\n        ticks: {\n          stepSize: 1,\n        },\n      },\n    },\n  };\n\n  // Pie chart data\n  const pieChartData = {\n    labels: ['Sudah SIDAK', 'Belum SIDAK'],\n    datasets: [\n      {\n        data: [data?.summary.sudahSidak || 0, data?.summary.belumSidak || 0],\n        backgroundColor: [\n          'rgba(34, 197, 94, 0.7)',\n          'rgba(239, 68, 68, 0.7)',\n        ],\n        borderColor: [\n          'rgba(34, 197, 94, 1)',\n          'rgba(239, 68, 68, 1)',\n        ],\n        borderWidth: 1,\n      },\n    ],\n  };\n\n  const pieChartOptions = {\n    responsive: true,\n    maintainAspectRatio: false,\n    plugins: {\n      legend: {\n        display: true,\n        position: 'bottom' as const,\n      },\n      title: {\n        display: true,\n        text: 'Status SIDAK Driver',\n      },\n    },\n  };\n\n  // Generate month options (last 12 months)\n  const monthOptions = useMemo(() => {\n    const options = [];\n    const today = new Date();\n    \n    for (let i = 0; i < 12; i++) {\n      const date = new Date(today.getFullYear(), today.getMonth() - i, 1);\n      const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\n      const label = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });\n      options.push({ value, label });\n    }\n    \n    return options;\n  }, []);\n\n  // Export to Excel\n  const exportToExcel = () => {\n    if (!data) return;\n\n    const ws = XLSX.utils.json_to_sheet(\n      sortedDrivers.map((driver, index) => ({\n        No: index + 1,\n        Nama: driver.nama,\n        NIK: driver.nik,\n        'Total SIDAK': driver.totalSidak,\n        Status: driver.status,\n      }))\n    );\n\n    const wb = XLSX.utils.book_new();\n    XLSX.utils.book_append_sheet(wb, ws, 'Evaluasi Driver');\n\n    const monthLabel = monthOptions.find(m => m.value === selectedMonth)?.label || selectedMonth;\n    XLSX.writeFile(wb, `Evaluasi_Driver_${monthLabel}.xlsx`);\n  };\n\n  // Export to PDF\n  const exportToPDF = () => {\n    if (!data) return;\n\n    const doc = new jsPDF();\n    const monthLabel = monthOptions.find(m => m.value === selectedMonth)?.label || selectedMonth;\n\n    // Title\n    doc.setFontSize(16);\n    doc.text('Evaluasi Driver SIDAK Fatigue', 14, 15);\n    \n    doc.setFontSize(12);\n    doc.text(`Periode: ${monthLabel}`, 14, 22);\n\n    // Summary\n    doc.setFontSize(10);\n    doc.text(`Total Driver: ${data.summary.totalDrivers}`, 14, 32);\n    doc.text(`Sudah SIDAK: ${data.summary.sudahSidak}`, 14, 38);\n    doc.text(`Belum SIDAK: ${data.summary.belumSidak}`, 14, 44);\n    doc.text(`Total SIDAK Keseluruhan: ${data.summary.totalSidakKeseluruhan}`, 14, 50);\n\n    // Table\n    autoTable(doc, {\n      startY: 58,\n      head: [['No', 'Nama Driver', 'NIK', 'Total SIDAK', 'Status']],\n      body: sortedDrivers.map((driver, index) => [\n        index + 1,\n        driver.nama,\n        driver.nik,\n        driver.totalSidak,\n        driver.status,\n      ]),\n      styles: { fontSize: 9 },\n      headStyles: { fillColor: [107, 114, 128] },\n    });\n\n    doc.save(`Evaluasi_Driver_${monthLabel}.pdf`);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto p-6\">\n        <div className=\"flex items-center justify-center h-64\">\n          <p className=\"text-gray-500 dark:text-gray-400\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white\">\n            Evaluasi Driver SIDAK Fatigue\n          </h1>\n          <p className=\"text-gray-500 dark:text-gray-400 mt-1\">\n            Monitoring partisipasi driver dalam SIDAK Fatigue per bulan\n          </p>\n        </div>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Filter Data</CardTitle>\n        </CardHeader>\n        <CardContent className=\"flex flex-col sm:flex-row gap-4\">\n          <div className=\"flex-1\">\n            <label className=\"text-sm font-medium mb-2 block\">Periode</label>\n            <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n              <SelectTrigger data-testid=\"select-month\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {monthOptions.map((option) => (\n                  <SelectItem key={option.value} value={option.value}>\n                    {option.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"flex-1\">\n            <label className=\"text-sm font-medium mb-2 block\">Status</label>\n            <Select value={statusFilter} onValueChange={setStatusFilter}>\n              <SelectTrigger data-testid=\"select-status\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"semua\">Semua Driver</SelectItem>\n                <SelectItem value=\"sudah\">Sudah SIDAK</SelectItem>\n                <SelectItem value=\"belum\">Belum SIDAK</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"flex-1\">\n            <label className=\"text-sm font-medium mb-2 block\">Cari</label>\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\n              <Input\n                placeholder=\"Cari nama atau NIK...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search\"\n              />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Summary Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Driver</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-drivers\">\n              {data?.summary.totalDrivers || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Semua driver terdaftar</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Sudah SIDAK</CardTitle>\n            <CheckCircle className=\"h-4 w-4 text-green-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-600\" data-testid=\"text-sudah-sidak\">\n              {data?.summary.sudahSidak || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Driver dengan minimal 1 SIDAK</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Belum SIDAK</CardTitle>\n            <XCircle className=\"h-4 w-4 text-red-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-600\" data-testid=\"text-belum-sidak\">\n              {data?.summary.belumSidak || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Driver belum ada SIDAK</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total SIDAK</CardTitle>\n            <ClipboardList className=\"h-4 w-4 text-blue-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-blue-600\" data-testid=\"text-total-sidak\">\n              {data?.summary.totalSidakKeseluruhan || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Total SIDAK dalam periode ini</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Charts */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Top 10 Driver</CardTitle>\n            <CardDescription>Driver dengan SIDAK Fatigue terbanyak</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"h-[300px]\">\n              <Bar data={barChartData} options={barChartOptions} />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Status SIDAK</CardTitle>\n            <CardDescription>Perbandingan driver sudah vs belum SIDAK</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"h-[300px]\">\n              <Pie data={pieChartData} options={pieChartOptions} />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Table */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle>Daftar Driver</CardTitle>\n              <CardDescription>\n                Total {filteredDrivers.length} driver\n              </CardDescription>\n            </div>\n            <div className=\"flex gap-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={exportToExcel}\n                data-testid=\"button-export-excel\"\n              >\n                <FileDown className=\"mr-2 h-4 w-4\" />\n                Export Excel\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={exportToPDF}\n                data-testid=\"button-export-pdf\"\n              >\n                <FileDown className=\"mr-2 h-4 w-4\" />\n                Export PDF\n              </Button>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"rounded-md border\">\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead className=\"w-16\">No</TableHead>\n                  <TableHead>Nama Driver</TableHead>\n                  <TableHead>NIK</TableHead>\n                  <TableHead className=\"text-center\">Total SIDAK</TableHead>\n                  <TableHead className=\"text-center\">Status</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {sortedDrivers.length === 0 ? (\n                  <TableRow>\n                    <TableCell colSpan={5} className=\"text-center py-8 text-gray-500\">\n                      Tidak ada data driver\n                    </TableCell>\n                  </TableRow>\n                ) : (\n                  sortedDrivers.map((driver, index) => (\n                    <TableRow key={driver.id} data-testid={`row-driver-${driver.id}`}>\n                      <TableCell className=\"font-medium\">{index + 1}</TableCell>\n                      <TableCell data-testid={`text-driver-name-${driver.id}`}>\n                        {driver.nama}\n                      </TableCell>\n                      <TableCell data-testid={`text-driver-nik-${driver.id}`}>\n                        {driver.nik}\n                      </TableCell>\n                      <TableCell className=\"text-center font-semibold\" data-testid={`text-driver-total-${driver.id}`}>\n                        {driver.totalSidak}\n                      </TableCell>\n                      <TableCell className=\"text-center\">\n                        <Badge\n                          variant={driver.totalSidak > 0 ? \"default\" : \"destructive\"}\n                          data-testid={`badge-driver-status-${driver.id}`}\n                        >\n                          {driver.status}\n                        </Badge>\n                      </TableCell>\n                    </TableRow>\n                  ))\n                )}\n              </TableBody>\n            </Table>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":15574,"size_tokens":null},"server/seed-auth.ts":{"content":"import { db } from \"./db\";\nimport { employees, authUsers } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport bcrypt from \"bcrypt\";\n\nconst DEFAULT_PASSWORD = \"12345678\";\nconst SALT_ROUNDS = 10;\n\nasync function seedAuthUsers() {\n  try {\n    console.log(\"ðŸ” Starting auth users seeding...\");\n    \n    const allEmployees = await db.select().from(employees);\n    console.log(`ðŸ“Š Found ${allEmployees.length} employees`);\n    \n    const hashedPassword = await bcrypt.hash(DEFAULT_PASSWORD, SALT_ROUNDS);\n    console.log(`ðŸ”’ Generated hashed password for default: ${DEFAULT_PASSWORD}`);\n    \n    let created = 0;\n    let skipped = 0;\n    \n    for (const employee of allEmployees) {\n      try {\n        const existingAuth = await db.select()\n          .from(authUsers)\n          .where(eq(authUsers.nik, employee.id))\n          .limit(1);\n        \n        if (existingAuth.length > 0) {\n          skipped++;\n          continue;\n        }\n        \n        await db.insert(authUsers).values({\n          nik: employee.id,\n          hashedPassword: hashedPassword,\n        });\n        \n        created++;\n        \n        if (created % 50 === 0) {\n          console.log(`âœ… Created ${created} auth users...`);\n        }\n      } catch (error) {\n        console.error(`âŒ Error creating auth for ${employee.id}:`, error);\n      }\n    }\n    \n    console.log(`\\nðŸŽ‰ Seeding completed!`);\n    console.log(`âœ… Created: ${created} auth users`);\n    console.log(`â­ï¸  Skipped: ${skipped} (already exist)`);\n    console.log(`ðŸ“ Default password: ${DEFAULT_PASSWORD}`);\n    \n  } catch (error) {\n    console.error(\"âŒ Seeding failed:\", error);\n    throw error;\n  } finally {\n    process.exit(0);\n  }\n}\n\nseedAuthUsers();\n","path":null,"size_bytes":1727,"size_tokens":null},"client/src/pages/reset-password.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { KeyRound, Loader2, Eye, EyeOff, ArrowLeft } from \"lucide-react\";\n\nconst resetPasswordFormSchema = z.object({\n  oldPassword: z.string().min(1, \"Password lama wajib diisi\"),\n  newPassword: z.string().min(8, \"Password baru minimal 8 karakter\"),\n  confirmPassword: z.string().min(1, \"Konfirmasi password wajib diisi\"),\n}).refine((data) => data.newPassword === data.confirmPassword, {\n  message: \"Password baru dan konfirmasi tidak cocok\",\n  path: [\"confirmPassword\"],\n});\n\ntype ResetPasswordFormValues = z.infer<typeof resetPasswordFormSchema>;\n\nexport default function ResetPasswordPage() {\n  const [, setLocation] = useLocation();\n  const { resetPassword, user, isAuthenticated } = useAuth();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(false);\n  const [showOldPassword, setShowOldPassword] = useState(false);\n  const [showNewPassword, setShowNewPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n\n  const form = useForm<ResetPasswordFormValues>({\n    resolver: zodResolver(resetPasswordFormSchema),\n    defaultValues: {\n      oldPassword: \"\",\n      newPassword: \"\",\n      confirmPassword: \"\",\n    },\n  });\n\n  // Redirect to login if not authenticated\n  if (!isAuthenticated) {\n    setLocation(\"/login\");\n    return null;\n  }\n\n  async function onSubmit(data: ResetPasswordFormValues) {\n    setIsLoading(true);\n    try {\n      await resetPassword(data.oldPassword, data.newPassword);\n      toast({\n        title: \"Password Berhasil Diubah\",\n        description: \"Password Anda telah diperbarui. Silakan gunakan password baru untuk login berikutnya.\",\n      });\n      form.reset();\n      setTimeout(() => {\n        setLocation(\"/workspace\");\n      }, 1500);\n    } catch (error) {\n      toast({\n        title: \"Gagal Mengubah Password\",\n        description: error instanceof Error ? error.message : \"Terjadi kesalahan saat mengubah password\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gradient-to-br from-purple-50 via-white to-blue-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 p-4\">\n      {/* Animated Background Elements */}\n      <div className=\"absolute inset-0 overflow-hidden pointer-events-none\">\n        <div className=\"absolute top-1/4 right-1/4 w-96 h-96 bg-purple-200/30 dark:bg-purple-500/10 rounded-full blur-3xl animate-pulse\" />\n        <div className=\"absolute bottom-1/4 left-1/4 w-96 h-96 bg-blue-200/30 dark:bg-blue-500/10 rounded-full blur-3xl animate-pulse delay-1000\" />\n      </div>\n\n      {/* Reset Password Card */}\n      <Card className=\"w-full max-w-md relative shadow-2xl border-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl\">\n        <CardHeader className=\"space-y-4 text-center pb-8\">\n          {/* Back Button */}\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => setLocation(\"/workspace\")}\n            className=\"absolute top-4 left-4\"\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Kembali\n          </Button>\n\n          {/* Icon */}\n          <div className=\"mx-auto w-20 h-20 bg-gradient-to-br from-purple-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg transform hover:scale-105 transition-transform\">\n            <KeyRound className=\"w-12 h-12 text-white\" />\n          </div>\n          \n          <div className=\"space-y-2\">\n            <CardTitle className=\"text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent\">\n              Ubah Password\n            </CardTitle>\n            <CardDescription className=\"text-base\">\n              {user ? `Halo, ${user.name}` : \"Perbarui password Anda\"}\n            </CardDescription>\n          </div>\n        </CardHeader>\n\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"oldPassword\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">Password Lama</FormLabel>\n                    <FormControl>\n                      <div className=\"relative\">\n                        <Input\n                          {...field}\n                          type={showOldPassword ? \"text\" : \"password\"}\n                          placeholder=\"Masukkan password lama\"\n                          disabled={isLoading}\n                          className=\"h-12 text-base border-2 focus:border-purple-500 transition-colors pr-12\"\n                          data-testid=\"input-old-password\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => setShowOldPassword(!showOldPassword)}\n                          className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors\"\n                          disabled={isLoading}\n                          data-testid=\"button-toggle-old-password\"\n                        >\n                          {showOldPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n                        </button>\n                      </div>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"newPassword\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">Password Baru</FormLabel>\n                    <FormControl>\n                      <div className=\"relative\">\n                        <Input\n                          {...field}\n                          type={showNewPassword ? \"text\" : \"password\"}\n                          placeholder=\"Minimal 8 karakter\"\n                          disabled={isLoading}\n                          className=\"h-12 text-base border-2 focus:border-purple-500 transition-colors pr-12\"\n                          data-testid=\"input-new-password\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => setShowNewPassword(!showNewPassword)}\n                          className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors\"\n                          disabled={isLoading}\n                          data-testid=\"button-toggle-new-password\"\n                        >\n                          {showNewPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n                        </button>\n                      </div>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"confirmPassword\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">Konfirmasi Password Baru</FormLabel>\n                    <FormControl>\n                      <div className=\"relative\">\n                        <Input\n                          {...field}\n                          type={showConfirmPassword ? \"text\" : \"password\"}\n                          placeholder=\"Ketik ulang password baru\"\n                          disabled={isLoading}\n                          className=\"h-12 text-base border-2 focus:border-purple-500 transition-colors pr-12\"\n                          data-testid=\"input-confirm-password\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                          className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors\"\n                          disabled={isLoading}\n                          data-testid=\"button-toggle-confirm-password\"\n                        >\n                          {showConfirmPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n                        </button>\n                      </div>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <Button\n                type=\"submit\"\n                disabled={isLoading}\n                className=\"w-full h-12 text-base font-semibold bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 shadow-lg hover:shadow-xl transition-all\"\n                data-testid=\"button-submit\"\n              >\n                {isLoading ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n                    Memproses...\n                  </>\n                ) : (\n                  \"Ubah Password\"\n                )}\n              </Button>\n            </form>\n          </Form>\n\n          <div className=\"mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800\">\n            <p className=\"text-sm text-blue-900 dark:text-blue-200 font-medium\">\n              ðŸ’¡ Tips Keamanan Password:\n            </p>\n            <ul className=\"mt-2 text-xs text-blue-800 dark:text-blue-300 space-y-1 list-disc list-inside\">\n              <li>Gunakan minimal 8 karakter</li>\n              <li>Kombinasikan huruf besar, kecil, angka, dan simbol</li>\n              <li>Jangan gunakan informasi pribadi yang mudah ditebak</li>\n              <li>Ganti password secara berkala untuk keamanan optimal</li>\n            </ul>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":10749,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, Eye, EyeOff, QrCode, ArrowLeft } from \"lucide-react\";\nimport geclLogo from \"@assets/WhatsApp Image 2024-11-30 at 13.08.33_1755505069008.jpeg\";\nimport bgImage from \"@assets/Picture1_1765606128281.jpg\";\n\nconst loginFormSchema = z.object({\n  nik: z.string().min(1, \"NIK wajib diisi\"),\n  password: z.string().min(1, \"Password wajib diisi\"),\n});\n\nconst resetPasswordSchema = z.object({\n  nik: z.string().min(1, \"NIK wajib diisi\"),\n  oldPassword: z.string().min(1, \"Password lama wajib diisi\"),\n  newPassword: z.string().min(8, \"Password baru minimal 8 karakter\"),\n  confirmPassword: z.string().min(1, \"Konfirmasi password wajib diisi\"),\n}).refine((data) => data.newPassword === data.confirmPassword, {\n  message: \"Password baru dan konfirmasi tidak cocok\",\n  path: [\"confirmPassword\"],\n});\n\ntype LoginFormValues = z.infer<typeof loginFormSchema>;\ntype ResetPasswordFormValues = z.infer<typeof resetPasswordSchema>;\n\nexport default function LoginPage() {\n  const [, setLocation] = useLocation();\n  const { login, isAuthenticated } = useAuth();\n  const { toast } = useToast();\n  const [isLoading, setIsLoading] = useState(false);\n  const [showPassword, setShowPassword] = useState(false);\n  const [mode, setMode] = useState<'login' | 'reset'>('login');\n  const [isAnimating, setIsAnimating] = useState(false);\n  const [animationDirection, setAnimationDirection] = useState<'toReset' | 'toLogin' | null>(null);\n\n  const loginForm = useForm<LoginFormValues>({\n    resolver: zodResolver(loginFormSchema),\n    defaultValues: {\n      nik: \"\",\n      password: \"\",\n    },\n  });\n\n  const resetForm = useForm<ResetPasswordFormValues>({\n    resolver: zodResolver(resetPasswordSchema),\n    defaultValues: {\n      nik: \"\",\n      oldPassword: \"\",\n      newPassword: \"\",\n      confirmPassword: \"\",\n    },\n  });\n\n  useEffect(() => {\n    if (isAuthenticated && !isLoading) {\n      setLocation(\"/workspace\");\n    }\n  }, [isAuthenticated, isLoading, setLocation]);\n\n  async function onLoginSubmit(data: LoginFormValues) {\n    setIsLoading(true);\n    try {\n      await login(data.nik, data.password);\n      toast({\n        title: \"Login Berhasil\",\n        description: \"Selamat datang kembali!\",\n      });\n      setIsLoading(false);\n    } catch (error) {\n      toast({\n        title: \"Login Gagal\",\n        description: error instanceof Error ? error.message : \"NIK atau password salah\",\n        variant: \"destructive\",\n      });\n      setIsLoading(false);\n    }\n  }\n\n  async function onResetSubmit(data: ResetPasswordFormValues) {\n    setIsLoading(true);\n    try {\n      const response = await fetch(\"/api/auth/reset-password\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          nik: data.nik,\n          oldPassword: data.oldPassword,\n          newPassword: data.newPassword,\n        }),\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.text();\n        throw new Error(error || \"Reset password gagal\");\n      }\n\n      toast({\n        title: \"Password Berhasil Direset\",\n        description: \"Silakan login dengan password baru Anda\",\n      });\n      \n      resetForm.reset();\n      switchToLogin();\n      setIsLoading(false);\n    } catch (error) {\n      toast({\n        title: \"Reset Password Gagal\",\n        description: error instanceof Error ? error.message : \"Terjadi kesalahan\",\n        variant: \"destructive\",\n      });\n      setIsLoading(false);\n    }\n  }\n\n  function switchToReset() {\n    if (isAnimating) return;\n    setIsAnimating(true);\n    setAnimationDirection('toReset');\n    resetForm.reset();\n    setTimeout(() => {\n      setMode('reset');\n      setIsAnimating(false);\n      setAnimationDirection(null);\n    }, 500);\n  }\n\n  function switchToLogin() {\n    if (isAnimating) return;\n    setIsAnimating(true);\n    setAnimationDirection('toLogin');\n    loginForm.reset();\n    setTimeout(() => {\n      setMode('login');\n      setIsAnimating(false);\n      setAnimationDirection(null);\n    }, 500);\n  }\n\n  const getLoginAnimation = () => {\n    if (mode === 'login' && !isAnimating) return 'none';\n    if (animationDirection === 'toReset') return 'slideOutToLeft 0.5s ease-in-out forwards';\n    if (animationDirection === 'toLogin') return 'slideInFromLeft 0.5s ease-in-out forwards';\n    return 'none';\n  };\n\n  const getResetAnimation = () => {\n    if (mode === 'reset' && !isAnimating) return 'none';\n    if (animationDirection === 'toReset') return 'slideInFromRight 0.5s ease-in-out forwards';\n    if (animationDirection === 'toLogin') return 'slideOutToRight 0.5s ease-in-out forwards';\n    return 'none';\n  };\n\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center p-3 sm:p-4 relative bg-gradient-to-br from-gray-50 via-red-50 to-rose-50 lg:bg-gradient-to-br lg:from-gray-50 lg:via-red-50 lg:to-rose-50\">\n      {/* Mobile Background Image */}\n      <div \n        className=\"absolute inset-0 lg:hidden\"\n        style={{ \n          backgroundImage: `url(${bgImage})`,\n          backgroundSize: 'cover',\n          backgroundPosition: 'center',\n          backgroundRepeat: 'no-repeat'\n        }}\n      />\n      {/* Overlay for better readability on mobile */}\n      <div className=\"absolute inset-0 bg-gradient-to-br from-red-600/50 via-red-500/40 to-red-700/50 lg:hidden\" />\n      <div className=\"w-full max-w-5xl max-h-[95vh] bg-white/95 backdrop-blur-sm lg:bg-white rounded-2xl sm:rounded-3xl shadow-2xl overflow-y-auto lg:overflow-hidden relative z-10\">\n        <div className=\"grid lg:grid-cols-2\">\n          {/* Left Panel - Animated Forms */}\n          <div className=\"p-5 sm:p-8 lg:p-12 flex flex-col justify-center relative\">\n            {/* GECL Logo */}\n            <div className=\"flex justify-center mb-6 sm:mb-8\">\n              <div className=\"w-16 h-16 sm:w-24 sm:h-24 rounded-xl sm:rounded-2xl overflow-hidden shadow-lg\">\n                <img \n                  src={geclLogo} \n                  alt=\"GECL Logo\" \n                  className=\"w-full h-full object-cover\"\n                />\n              </div>\n            </div>\n\n            {/* Forms Container - Both forms absolutely positioned for overlapping animations */}\n            <div className=\"relative min-h-[480px] sm:min-h-[500px]\">\n              {/* Login Form - Always in DOM */}\n              <div \n                className=\"w-full absolute top-0 left-0 right-0\"\n                style={{\n                  animation: getLoginAnimation(),\n                  opacity: !isAnimating ? (mode === 'login' ? 1 : 0) : undefined,\n                  transform: !isAnimating ? 'translateX(0)' : undefined,\n                  pointerEvents: mode === 'login' && !isAnimating ? 'auto' : 'none',\n                  zIndex: mode === 'login' ? 2 : 1,\n                }}\n              >\n                <div className=\"text-center mb-5 sm:mb-8\">\n                  <p className=\"font-semibold mb-1 lg:hidden text-[#111827] text-[25px]\">Selamat Datang di OneTalent</p>\n                  <h1 className=\"sm:text-3xl font-bold text-gray-900 mb-2 text-[22px]\">\n                    Masuk\n                  </h1>\n                  <p className=\"text-sm sm:text-base text-gray-600\">\n                    Masukkan NIK dan password untuk melanjutkan\n                  </p>\n                </div>\n\n                <Form {...loginForm}>\n                  <form onSubmit={loginForm.handleSubmit(onLoginSubmit)} className=\"space-y-4 sm:space-y-5\">\n                    <FormField\n                      control={loginForm.control}\n                      name=\"nik\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-sm font-medium text-gray-700\">\n                            NIK\n                          </FormLabel>\n                          <FormControl>\n                            <Input\n                              {...field}\n                              placeholder=\"Masukkan NIK Anda\"\n                              disabled={isLoading}\n                              className=\"h-11 sm:h-12 text-sm sm:text-base border-gray-300 rounded-lg focus:border-red-500 focus:ring-red-500 bg-white\"\n                              data-testid=\"input-nik\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={loginForm.control}\n                      name=\"password\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-sm font-medium text-gray-700\">\n                            Password\n                          </FormLabel>\n                          <FormControl>\n                            <div className=\"relative\">\n                              <Input\n                                {...field}\n                                type={showPassword ? \"text\" : \"password\"}\n                                placeholder=\"Masukkan password Anda\"\n                                disabled={isLoading}\n                                className=\"h-11 sm:h-12 text-sm sm:text-base border-gray-300 rounded-lg focus:border-red-500 focus:ring-red-500 pr-12 bg-white\"\n                                data-testid=\"input-password\"\n                              />\n                              <button\n                                type=\"button\"\n                                onClick={() => setShowPassword(!showPassword)}\n                                className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 transition-colors p-1\"\n                                disabled={isLoading}\n                                data-testid=\"button-toggle-password\"\n                              >\n                                {showPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n                              </button>\n                            </div>\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <Button\n                      type=\"submit\"\n                      disabled={isLoading}\n                      className=\"w-full h-11 sm:h-12 text-sm sm:text-base font-semibold bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-lg shadow-lg hover:shadow-xl transition-all\"\n                      data-testid=\"button-login\"\n                    >\n                      {isLoading ? (\n                        <>\n                          <Loader2 className=\"mr-2 h-4 w-4 sm:h-5 sm:w-5 animate-spin\" />\n                          Memproses...\n                        </>\n                      ) : (\n                        \"Masuk\"\n                      )}\n                    </Button>\n\n                    <div className=\"text-center mt-4\">\n                      <button\n                        type=\"button\"\n                        onClick={switchToReset}\n                        disabled={isAnimating}\n                        className=\"text-sm text-red-600 hover:text-red-700 font-medium hover:underline transition-colors disabled:opacity-50\"\n                        data-testid=\"link-forgot-password\"\n                      >\n                        Lupa Password?\n                      </button>\n                    </div>\n                  </form>\n                </Form>\n              </div>\n\n              {/* Reset Password Form - Always in DOM */}\n              <div \n                className=\"w-full absolute top-0 left-0 right-0\"\n                style={{\n                  animation: getResetAnimation(),\n                  opacity: !isAnimating ? (mode === 'reset' ? 1 : 0) : undefined,\n                  transform: !isAnimating ? 'translateX(0)' : undefined,\n                  pointerEvents: mode === 'reset' && !isAnimating ? 'auto' : 'none',\n                  zIndex: mode === 'reset' ? 2 : 1,\n                }}\n              >\n                <div className=\"text-center mb-3 sm:mb-8\">\n                  <h1 className=\"text-xl sm:text-3xl font-bold text-gray-900 mb-1 sm:mb-2\">\n                    Reset Password\n                  </h1>\n                  <p className=\"text-xs sm:text-base text-gray-600\">\n                    Masukkan NIK dan password lama untuk mereset\n                  </p>\n                </div>\n\n                <Form {...resetForm}>\n                  <form onSubmit={resetForm.handleSubmit(onResetSubmit)} className=\"space-y-3 sm:space-y-4\">\n                    <FormField\n                      control={resetForm.control}\n                      name=\"nik\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-sm font-medium text-gray-700\">\n                            NIK\n                          </FormLabel>\n                          <FormControl>\n                            <Input\n                              {...field}\n                              placeholder=\"Masukkan NIK Anda\"\n                              disabled={isLoading}\n                              className=\"h-10 sm:h-11 text-sm sm:text-base border-gray-300 rounded-lg focus:border-red-500 focus:ring-red-500 bg-white\"\n                              data-testid=\"input-reset-nik\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={resetForm.control}\n                      name=\"oldPassword\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-sm font-medium text-gray-700\">\n                            Password Lama\n                          </FormLabel>\n                          <FormControl>\n                            <Input\n                              {...field}\n                              type=\"password\"\n                              placeholder=\"Password lama Anda\"\n                              disabled={isLoading}\n                              className=\"h-10 sm:h-11 text-sm sm:text-base border-gray-300 rounded-lg focus:border-red-500 focus:ring-red-500 bg-white\"\n                              data-testid=\"input-old-password\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={resetForm.control}\n                      name=\"newPassword\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-sm font-medium text-gray-700\">\n                            Password Baru\n                          </FormLabel>\n                          <FormControl>\n                            <Input\n                              {...field}\n                              type=\"password\"\n                              placeholder=\"Minimal 8 karakter\"\n                              disabled={isLoading}\n                              className=\"h-10 sm:h-11 text-sm sm:text-base border-gray-300 rounded-lg focus:border-red-500 focus:ring-red-500 bg-white\"\n                              data-testid=\"input-new-password\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={resetForm.control}\n                      name=\"confirmPassword\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel className=\"text-sm font-medium text-gray-700\">\n                            Konfirmasi Password Baru\n                          </FormLabel>\n                          <FormControl>\n                            <Input\n                              {...field}\n                              type=\"password\"\n                              placeholder=\"Ulangi password baru\"\n                              disabled={isLoading}\n                              className=\"h-10 sm:h-11 text-sm sm:text-base border-gray-300 rounded-lg focus:border-red-500 focus:ring-red-500 bg-white\"\n                              data-testid=\"input-confirm-password\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <Button\n                      type=\"submit\"\n                      disabled={isLoading}\n                      className=\"w-full h-10 sm:h-12 text-sm sm:text-base font-semibold bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-lg shadow-lg hover:shadow-xl transition-all\"\n                      data-testid=\"button-reset-password\"\n                    >\n                      {isLoading ? (\n                        <>\n                          <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n                          Memproses...\n                        </>\n                      ) : (\n                        \"Reset Password\"\n                      )}\n                    </Button>\n\n                    <div className=\"text-center mt-4\">\n                      <button\n                        type=\"button\"\n                        onClick={switchToLogin}\n                        disabled={isAnimating}\n                        className=\"text-sm text-gray-600 hover:text-gray-800 font-medium hover:underline transition-colors inline-flex items-center gap-1 disabled:opacity-50\"\n                        data-testid=\"link-back-to-login\"\n                      >\n                        <ArrowLeft className=\"w-4 h-4\" />\n                        Kembali ke Login\n                      </button>\n                    </div>\n                  </form>\n                </Form>\n              </div>\n            </div>\n\n            {/* Mobile Credit Footer - Only visible on mobile */}\n            <div className=\"lg:hidden text-center mt-6 pt-4 border-t border-gray-100\">\n              <p className=\"text-xs text-gray-500\">\n                Created by <span className=\"font-medium text-gray-600\">Bagus Andyka Firmansyah</span>\n              </p>\n            </div>\n          </div>\n\n          {/* Right Panel - Static Welcome Section with Background Image */}\n          <div className=\"hidden lg:flex p-12 flex-col justify-center items-center text-white relative overflow-hidden\">\n            {/* Background Image */}\n            <div \n              className=\"absolute inset-0 bg-cover bg-center bg-no-repeat\"\n              style={{ backgroundImage: `url(${bgImage})` }}\n            />\n            {/* Red Overlay for contrast - more transparent to show background */}\n            <div className=\"absolute inset-0 bg-gradient-to-br from-red-600/60 to-red-700/65\" />\n            {/* Decorative Background Elements */}\n            <div className=\"absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl\" />\n            <div className=\"absolute bottom-0 left-0 w-96 h-96 bg-red-700/30 rounded-full blur-3xl\" />\n            \n            {/* Static Content - Never changes */}\n            <div className=\"relative z-10 text-center\">\n              <div className=\"mb-8 flex justify-center\">\n                <div className=\"w-32 h-32 bg-white/20 backdrop-blur-sm rounded-3xl flex items-center justify-center shadow-xl\">\n                  <QrCode className=\"w-20 h-20 text-white\" />\n                </div>\n              </div>\n\n              <h2 className=\"text-4xl font-bold mb-4\">\n                Selamat Datang!\n              </h2>\n              <p className=\"text-xl mb-6 text-red-50 font-semibold\">OneTalent</p>\n              <p className=\"text-base text-red-100 max-w-md leading-relaxed\">Sistem Portal karyawan modern menggunakan teknologi QR Code untuk kemudahan dan keamanan pengelolaan data karyawan.</p>\n            </div>\n            \n            {/* Credit Footer */}\n            <div className=\"absolute bottom-6 left-0 right-0 text-center z-10\">\n              <p className=\"text-sm text-white/70\">\n                Created by <span className=\"font-medium text-white/90\">Bagus Andyka Firmansyah </span>\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":21237,"size_tokens":null},"client/src/lib/auth-context.tsx":{"content":"import { createContext, useContext, useState, useEffect, ReactNode } from 'react';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport { Role, Permission } from '@shared/rbac';\n\ninterface User {\n  nik: string;\n  name: string;\n  position: string | null;\n  role: Role;\n  permissions: Permission[];\n}\n\ninterface AuthContextType {\n  user: User | null;\n  isAuthenticated: boolean;\n  isLoading: boolean;\n  login: (nik: string, password: string) => Promise<void>;\n  logout: () => Promise<void>;\n  resetPassword: (oldPassword: string, newPassword: string) => Promise<void>;\n  hasPermission: (permission: Permission) => boolean;\n  hasAnyPermission: (permissions: Permission[]) => boolean;\n  hasAllPermissions: (permissions: Permission[]) => boolean;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const [user, setUser] = useState<User | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // Check session on mount\n  useEffect(() => {\n    checkSession();\n  }, []);\n\n  async function checkSession() {\n    try {\n      const response = await fetch('/api/auth/session');\n      const data = await response.json();\n      \n      if (data.authenticated && data.user) {\n        setUser(data.user);\n      } else {\n        setUser(null);\n      }\n    } catch (error) {\n      console.error('Session check failed:', error);\n      setUser(null);\n    } finally {\n      setIsLoading(false);\n    }\n  }\n\n  async function login(nik: string, password: string) {\n    const data = await apiRequest('/api/auth/login', 'POST', { nik, password });\n    setUser(data.user);\n    \n    // Invalidate all queries on login to refresh data\n    queryClient.invalidateQueries();\n  }\n\n  async function logout() {\n    await apiRequest('/api/auth/logout', 'POST');\n    setUser(null);\n    \n    // Clear all query cache on logout\n    queryClient.clear();\n  }\n\n  async function resetPassword(oldPassword: string, newPassword: string) {\n    await apiRequest('/api/auth/reset-password', 'POST', { oldPassword, newPassword });\n  }\n\n  function hasPermission(permission: Permission): boolean {\n    if (!user || !user.permissions) return false;\n    return user.permissions.includes(permission);\n  }\n\n  function hasAnyPermission(permissions: Permission[]): boolean {\n    if (!user || !user.permissions || !Array.isArray(user.permissions)) return false;\n    return permissions.some(p => user.permissions.includes(p));\n  }\n\n  function hasAllPermissions(permissions: Permission[]): boolean {\n    if (!user || !user.permissions || !Array.isArray(user.permissions)) return false;\n    return permissions.every(p => user.permissions.includes(p));\n  }\n\n  const value: AuthContextType = {\n    user,\n    isAuthenticated: !!user,\n    isLoading,\n    login,\n    logout,\n    resetPassword,\n    hasPermission,\n    hasAnyPermission,\n    hasAllPermissions,\n  };\n\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":3201,"size_tokens":null},"client/src/components/RootRedirect.tsx":{"content":"import { Redirect } from \"wouter\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { LoadingScreen } from \"@/components/ui/loading-screen\";\n\nexport function RootRedirect() {\n  const { isAuthenticated, isLoading } = useAuth();\n\n  if (isLoading) {\n    return <LoadingScreen isLoading={true} />;\n  }\n\n  return <Redirect to={isAuthenticated ? \"/workspace\" : \"/login\"} />;\n}\n","path":null,"size_bytes":375,"size_tokens":null},"client/src/components/ProtectedRoute.tsx":{"content":"import { Redirect } from \"wouter\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { LoadingScreen } from \"@/components/ui/loading-screen\";\nimport { Permission } from \"@shared/rbac\";\n\ninterface ProtectedRouteProps {\n  children: React.ReactNode;\n  requiredPermissions?: Permission[];\n  requireAll?: boolean;\n  fallbackPath?: string;\n}\n\nexport function ProtectedRoute({ \n  children, \n  requiredPermissions,\n  requireAll = false,\n  fallbackPath = \"/workspace\"\n}: ProtectedRouteProps) {\n  const { isAuthenticated, isLoading, hasPermission, hasAnyPermission, hasAllPermissions } = useAuth();\n\n  if (isLoading) {\n    return <LoadingScreen isLoading={true} />;\n  }\n\n  if (!isAuthenticated) {\n    return <Redirect to=\"/login\" />;\n  }\n\n  if (requiredPermissions && requiredPermissions.length > 0) {\n    const hasAccess = requireAll \n      ? hasAllPermissions(requiredPermissions)\n      : hasAnyPermission(requiredPermissions);\n    \n    if (!hasAccess) {\n      return <Redirect to={fallbackPath} />;\n    }\n  }\n\n  return <>{children}</>;\n}\n","path":null,"size_bytes":1034,"size_tokens":null},"server/middleware/rbac.ts":{"content":"import { Request, Response, NextFunction } from \"express\";\nimport { Role, Permission, ROLE_PERMISSIONS, createUserWithRole } from \"@shared/rbac\";\n\n// Extended request type with user info\ninterface AuthenticatedRequest extends Request {\n  user?: {\n    nik: string;\n    name: string;\n    position: string | null;\n    role: Role;\n    permissions: Permission[];\n  };\n}\n\n// Middleware to check if user is authenticated\nexport function requireAuth(req: Request, res: Response, next: NextFunction) {\n  const user = (req.session as any)?.user;\n  \n  if (!user) {\n    return res.status(401).json({ message: \"Silakan login terlebih dahulu\" });\n  }\n  \n  // Ensure user has role info (for backward compatibility)\n  if (!user.role || !user.permissions) {\n    const userWithRole = createUserWithRole(user.nik, user.name, user.position || null);\n    (req.session as any).user = userWithRole;\n    (req as AuthenticatedRequest).user = userWithRole;\n  } else {\n    (req as AuthenticatedRequest).user = user;\n  }\n  \n  next();\n}\n\n// Middleware to require specific role(s)\nexport function requireRole(...allowedRoles: Role[]) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const user = (req.session as any)?.user;\n    \n    if (!user) {\n      return res.status(401).json({ message: \"Silakan login terlebih dahulu\" });\n    }\n    \n    // Ensure user has role info\n    let userRole = user.role;\n    if (!userRole) {\n      const userWithRole = createUserWithRole(user.nik, user.name, user.position || null);\n      (req.session as any).user = userWithRole;\n      userRole = userWithRole.role;\n    }\n    \n    if (!allowedRoles.includes(userRole)) {\n      return res.status(403).json({ \n        message: \"Anda tidak memiliki akses ke fitur ini\",\n        requiredRoles: allowedRoles,\n        yourRole: userRole\n      });\n    }\n    \n    next();\n  };\n}\n\n// Middleware to require specific permission(s) - user needs at least ONE\nexport function requireAnyPermission(...requiredPermissions: Permission[]) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const user = (req.session as any)?.user;\n    \n    if (!user) {\n      return res.status(401).json({ message: \"Silakan login terlebih dahulu\" });\n    }\n    \n    // Ensure user has permissions\n    let userPermissions = user.permissions;\n    if (!userPermissions) {\n      const userWithRole = createUserWithRole(user.nik, user.name, user.position || null);\n      (req.session as any).user = userWithRole;\n      userPermissions = userWithRole.permissions;\n    }\n    \n    const hasPermission = requiredPermissions.some(p => userPermissions.includes(p));\n    \n    if (!hasPermission) {\n      return res.status(403).json({ \n        message: \"Anda tidak memiliki akses ke fitur ini\",\n        requiredPermissions,\n        yourPermissions: userPermissions\n      });\n    }\n    \n    next();\n  };\n}\n\n// Middleware to require ALL specified permissions\nexport function requireAllPermissions(...requiredPermissions: Permission[]) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const user = (req.session as any)?.user;\n    \n    if (!user) {\n      return res.status(401).json({ message: \"Silakan login terlebih dahulu\" });\n    }\n    \n    // Ensure user has permissions\n    let userPermissions = user.permissions;\n    if (!userPermissions) {\n      const userWithRole = createUserWithRole(user.nik, user.name, user.position || null);\n      (req.session as any).user = userWithRole;\n      userPermissions = userWithRole.permissions;\n    }\n    \n    const hasAllPermissions = requiredPermissions.every(p => userPermissions.includes(p));\n    \n    if (!hasAllPermissions) {\n      return res.status(403).json({ \n        message: \"Anda tidak memiliki akses lengkap ke fitur ini\",\n        requiredPermissions,\n        yourPermissions: userPermissions\n      });\n    }\n    \n    next();\n  };\n}\n\n// Helper to get user role from request\nexport function getUserRole(req: Request): Role | null {\n  const user = (req.session as any)?.user;\n  return user?.role || null;\n}\n\n// Helper to get user permissions from request\nexport function getUserPermissions(req: Request): Permission[] {\n  const user = (req.session as any)?.user;\n  return user?.permissions || [];\n}\n\n// Helper to check if current user has a permission\nexport function userHasPermission(req: Request, permission: Permission): boolean {\n  const permissions = getUserPermissions(req);\n  return permissions.includes(permission);\n}\n","path":null,"size_bytes":4440,"size_tokens":null},"shared/rbac.ts":{"content":"// Role-Based Access Control (RBAC) Configuration\n// This module defines roles, permissions, and position-to-role mappings\n\n// Define available roles\nexport enum Role {\n  ADMIN = \"ADMIN\",\n  SUPERVISOR = \"SUPERVISOR\", \n  BASIC = \"BASIC\"\n}\n\n// Define available permissions\nexport enum Permission {\n  // Dashboard\n  VIEW_DASHBOARD = \"VIEW_DASHBOARD\",\n  \n  // Employee Management\n  VIEW_EMPLOYEES = \"VIEW_EMPLOYEES\",\n  MANAGE_EMPLOYEES = \"MANAGE_EMPLOYEES\",\n  \n  // Attendance\n  VIEW_ATTENDANCE = \"VIEW_ATTENDANCE\",\n  SCAN_QR = \"SCAN_QR\",\n  MANAGE_ATTENDANCE = \"MANAGE_ATTENDANCE\",\n  \n  // Roster\n  VIEW_ROSTER = \"VIEW_ROSTER\",\n  MANAGE_ROSTER = \"MANAGE_ROSTER\",\n  \n  // Leave/Cuti\n  VIEW_LEAVE = \"VIEW_LEAVE\",\n  REQUEST_LEAVE = \"REQUEST_LEAVE\",\n  MANAGE_LEAVE = \"MANAGE_LEAVE\",\n  \n  // SIDAK\n  VIEW_SIDAK = \"VIEW_SIDAK\",\n  CREATE_SIDAK = \"CREATE_SIDAK\",\n  MANAGE_SIDAK = \"MANAGE_SIDAK\",\n  \n  // Meeting\n  VIEW_MEETING = \"VIEW_MEETING\",\n  CREATE_MEETING = \"CREATE_MEETING\",\n  MANAGE_MEETING = \"MANAGE_MEETING\",\n  \n  // Reports\n  VIEW_REPORTS = \"VIEW_REPORTS\",\n  EXPORT_REPORTS = \"EXPORT_REPORTS\",\n  \n  // Evaluasi Driver\n  VIEW_EVALUASI = \"VIEW_EVALUASI\",\n  MANAGE_EVALUASI = \"MANAGE_EVALUASI\",\n  \n  // Driver View (Mobile)\n  VIEW_DRIVER_VIEW = \"VIEW_DRIVER_VIEW\",\n  \n  // QR Code Management\n  VIEW_QR = \"VIEW_QR\",\n  GENERATE_QR = \"GENERATE_QR\",\n  \n  // Documents\n  VIEW_DOCUMENTS = \"VIEW_DOCUMENTS\",\n  MANAGE_DOCUMENTS = \"MANAGE_DOCUMENTS\",\n}\n\n// Role to permissions mapping\nexport const ROLE_PERMISSIONS: Record<Role, Permission[]> = {\n  [Role.ADMIN]: [\n    // Full access to all permissions\n    Permission.VIEW_DASHBOARD,\n    Permission.VIEW_EMPLOYEES,\n    Permission.MANAGE_EMPLOYEES,\n    Permission.VIEW_ATTENDANCE,\n    Permission.SCAN_QR,\n    Permission.MANAGE_ATTENDANCE,\n    Permission.VIEW_ROSTER,\n    Permission.MANAGE_ROSTER,\n    Permission.VIEW_LEAVE,\n    Permission.REQUEST_LEAVE,\n    Permission.MANAGE_LEAVE,\n    Permission.VIEW_SIDAK,\n    Permission.CREATE_SIDAK,\n    Permission.MANAGE_SIDAK,\n    Permission.VIEW_MEETING,\n    Permission.CREATE_MEETING,\n    Permission.MANAGE_MEETING,\n    Permission.VIEW_REPORTS,\n    Permission.EXPORT_REPORTS,\n    Permission.VIEW_EVALUASI,\n    Permission.MANAGE_EVALUASI,\n    Permission.VIEW_DRIVER_VIEW,\n    Permission.VIEW_QR,\n    Permission.GENERATE_QR,\n    Permission.VIEW_DOCUMENTS,\n    Permission.MANAGE_DOCUMENTS,\n  ],\n  \n  [Role.SUPERVISOR]: [\n    // Scan QR, Roster, SIDAK, Laporan, Absensi Meeting\n    Permission.VIEW_DASHBOARD,\n    Permission.VIEW_ATTENDANCE,\n    Permission.SCAN_QR,\n    Permission.VIEW_ROSTER,\n    Permission.VIEW_SIDAK,\n    Permission.CREATE_SIDAK,\n    Permission.VIEW_MEETING,\n    Permission.CREATE_MEETING,\n    Permission.VIEW_REPORTS,\n    Permission.EXPORT_REPORTS,\n    Permission.VIEW_QR,\n    Permission.VIEW_DOCUMENTS,\n  ],\n  \n  [Role.BASIC]: [\n    // Basic access - Driver only sees Driver View and Documents, no Dashboard\n    Permission.VIEW_DRIVER_VIEW,\n    Permission.VIEW_DOCUMENTS,\n  ],\n};\n\n// Position to Role mapping (case-insensitive matching)\n// Positions with ADMIN access (full access)\nconst ADMIN_POSITIONS = [\n  \"hrga group leader\",\n  \"admin hr\",\n  \"data evaluator\",\n  \"hse section head\",\n  \"production section head\",\n  \"maintenance section head\",\n  \"project manager\",\n];\n\n// Positions with SUPERVISOR access\nconst SUPERVISOR_POSITIONS = [\n  \"hse group leader\",\n  \"maintenance group leader\",\n  \"production group leader\",\n];\n\n// Get role from position - STRICT exact matching to prevent privilege escalation\nexport function getRoleFromPosition(position: string | null | undefined): Role {\n  if (!position) return Role.BASIC;\n  \n  const normalizedPosition = position.toLowerCase().trim();\n  \n  // Check if position EXACTLY matches an ADMIN position\n  if (ADMIN_POSITIONS.some(p => normalizedPosition === p)) {\n    return Role.ADMIN;\n  }\n  \n  // Check if position EXACTLY matches a SUPERVISOR position\n  if (SUPERVISOR_POSITIONS.some(p => normalizedPosition === p)) {\n    return Role.SUPERVISOR;\n  }\n  \n  // Default to BASIC for all other positions (including Driver, Operator, etc.)\n  return Role.BASIC;\n}\n\n// Get permissions from position\nexport function getPermissionsFromPosition(position: string | null | undefined): Permission[] {\n  const role = getRoleFromPosition(position);\n  return ROLE_PERMISSIONS[role];\n}\n\n// Check if a role has a specific permission\nexport function hasPermission(role: Role, permission: Permission): boolean {\n  return ROLE_PERMISSIONS[role].includes(permission);\n}\n\n// Check if a position has a specific permission\nexport function positionHasPermission(position: string | null | undefined, permission: Permission): boolean {\n  const role = getRoleFromPosition(position);\n  return hasPermission(role, permission);\n}\n\n// User with role info (for session)\nexport interface UserWithRole {\n  nik: string;\n  name: string;\n  position: string | null;\n  role: Role;\n  permissions: Permission[];\n}\n\n// Create user with role from basic user data\nexport function createUserWithRole(nik: string, name: string, position: string | null): UserWithRole {\n  const role = getRoleFromPosition(position);\n  const permissions = ROLE_PERMISSIONS[role];\n  \n  return {\n    nik,\n    name,\n    position,\n    role,\n    permissions,\n  };\n}\n\n// Menu item visibility based on permissions\nexport interface MenuPermission {\n  path: string;\n  requiredPermissions: Permission[];\n  requireAll?: boolean; // If true, user must have ALL permissions. If false, any one is sufficient\n}\n\n// Define which permissions are needed for each menu/route\nexport const MENU_PERMISSIONS: MenuPermission[] = [\n  { path: \"/workspace\", requiredPermissions: [Permission.VIEW_DASHBOARD] },\n  { path: \"/workspace/dashboard\", requiredPermissions: [Permission.VIEW_DASHBOARD] },\n  { path: \"/workspace/employees\", requiredPermissions: [Permission.VIEW_EMPLOYEES] },\n  { path: \"/workspace/attendance\", requiredPermissions: [Permission.VIEW_ATTENDANCE] },\n  { path: \"/workspace/scan\", requiredPermissions: [Permission.SCAN_QR] },\n  { path: \"/workspace/roster\", requiredPermissions: [Permission.VIEW_ROSTER] },\n  { path: \"/workspace/leave\", requiredPermissions: [Permission.VIEW_LEAVE] },\n  { path: \"/workspace/sidak\", requiredPermissions: [Permission.VIEW_SIDAK] },\n  { path: \"/workspace/meeting\", requiredPermissions: [Permission.VIEW_MEETING] },\n  { path: \"/workspace/reports\", requiredPermissions: [Permission.VIEW_REPORTS] },\n  { path: \"/workspace/evaluasi\", requiredPermissions: [Permission.VIEW_EVALUASI] },\n  { path: \"/workspace/qr\", requiredPermissions: [Permission.VIEW_QR] },\n  { path: \"/driver\", requiredPermissions: [Permission.VIEW_DRIVER_VIEW] },\n];\n\n// Check if user can access a specific path\nexport function canAccessPath(permissions: Permission[], path: string): boolean {\n  const menuPermission = MENU_PERMISSIONS.find(m => path.startsWith(m.path));\n  \n  if (!menuPermission) {\n    // If no permission defined for path, allow access\n    return true;\n  }\n  \n  if (menuPermission.requireAll) {\n    // Must have all required permissions\n    return menuPermission.requiredPermissions.every(p => permissions.includes(p));\n  } else {\n    // Must have at least one of the required permissions\n    return menuPermission.requiredPermissions.some(p => permissions.includes(p));\n  }\n}\n","path":null,"size_bytes":7254,"size_tokens":null},"client/src/components/PermissionGuard.tsx":{"content":"import { useAuth } from \"@/lib/auth-context\";\nimport { Permission } from \"@shared/rbac\";\nimport { ShieldX } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Link } from \"wouter\";\n\ninterface PermissionGuardProps {\n  children: React.ReactNode;\n  requiredPermissions: Permission[];\n  requireAll?: boolean;\n}\n\nexport function PermissionGuard({ \n  children, \n  requiredPermissions,\n  requireAll = false\n}: PermissionGuardProps) {\n  const { hasAnyPermission, hasAllPermissions } = useAuth();\n\n  const hasAccess = requireAll \n    ? hasAllPermissions(requiredPermissions)\n    : hasAnyPermission(requiredPermissions);\n  \n  if (!hasAccess) {\n    return (\n      <div className=\"flex flex-col items-center justify-center min-h-[60vh] p-6 text-center\">\n        <div className=\"w-20 h-20 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center mb-6\">\n          <ShieldX className=\"w-10 h-10 text-red-600 dark:text-red-400\" />\n        </div>\n        <h2 className=\"text-2xl font-bold text-gray-900 dark:text-white mb-2\">\n          Akses Ditolak\n        </h2>\n        <p className=\"text-gray-600 dark:text-gray-400 mb-6 max-w-md\">\n          Anda tidak memiliki izin untuk mengakses halaman ini. Silakan hubungi administrator jika Anda merasa ini adalah kesalahan.\n        </p>\n        <Link href=\"/workspace\">\n          <Button variant=\"outline\" data-testid=\"btn-back-dashboard\">\n            Kembali ke Dashboard\n          </Button>\n        </Link>\n      </div>\n    );\n  }\n\n  return <>{children}</>;\n}\n","path":null,"size_bytes":1536,"size_tokens":null},"server/services/emailService.ts":{"content":"import nodemailer from 'nodemailer';\n\ninterface EmailOptions {\n  to: string;\n  subject: string;\n  html: string;\n  text?: string;\n}\n\nclass EmailService {\n  private transporter: nodemailer.Transporter | null = null;\n\n  constructor() {\n    this.initializeTransporter();\n  }\n\n  private initializeTransporter() {\n    const emailUser = process.env.GMAIL_USER;\n    const emailPass = process.env.GMAIL_APP_PASSWORD;\n\n    if (!emailUser || !emailPass) {\n      console.warn('âš ï¸ Email credentials not configured. Email notifications disabled.');\n      return;\n    }\n\n    // Remove any spaces from app password\n    const cleanPass = emailPass.replace(/\\s/g, '');\n\n    this.transporter = nodemailer.createTransport({\n      service: 'gmail',\n      auth: {\n        user: emailUser,\n        pass: cleanPass,\n      },\n    });\n\n    console.log('âœ… Email service initialized for:', emailUser);\n  }\n\n  async sendEmail(options: EmailOptions): Promise<boolean> {\n    if (!this.transporter) {\n      console.warn('âš ï¸ Email transporter not configured. Skipping email.');\n      return false;\n    }\n\n    try {\n      const info = await this.transporter.sendMail({\n        from: `\"OneTalent GECL\" <${process.env.GMAIL_USER}>`,\n        to: options.to,\n        subject: options.subject,\n        html: options.html,\n        text: options.text,\n      });\n\n      console.log(`âœ… Email sent successfully: ${info.messageId}`);\n      return true;\n    } catch (error) {\n      console.error('âŒ Failed to send email:', error);\n      return false;\n    }\n  }\n\n  isConfigured(): boolean {\n    return this.transporter !== null;\n  }\n}\n\nexport const emailService = new EmailService();\n","path":null,"size_bytes":1651,"size_tokens":null},"server/services/simperNotificationService.ts":{"content":"import { emailService } from './emailService';\nimport { storage } from '../storage';\n\ninterface SimperExpiredData {\n  employeeName: string;\n  nik: string;\n  simperBibExpiredDate: string | null;\n  simperTiaExpiredDate: string | null;\n  bibStatus: 'expired' | 'expiring_soon' | 'ok';\n  tiaStatus: 'expired' | 'expiring_soon' | 'ok';\n  bibDaysRemaining: number | null;\n  tiaDaysRemaining: number | null;\n}\n\nclass SimperNotificationService {\n  private readonly NOTIFICATION_EMAIL = 'gecl.hse@gmail.com';\n  private readonly WARNING_DAYS = 30;\n\n  async checkAndNotifySimperExpired(): Promise<{ sent: boolean; count: number }> {\n    console.log('ðŸ” Checking for expired/expiring SIMPER...');\n\n    try {\n      const simperData = await this.getSimperExpiryData();\n      \n      const expiredOrExpiring = simperData.filter(\n        s => s.bibStatus !== 'ok' || s.tiaStatus !== 'ok'\n      );\n\n      if (expiredOrExpiring.length === 0) {\n        console.log('âœ… No SIMPER expired or expiring soon');\n        return { sent: false, count: 0 };\n      }\n\n      console.log(`âš ï¸ Found ${expiredOrExpiring.length} employees with SIMPER issues`);\n\n      const emailHtml = this.generateEmailHtml(expiredOrExpiring);\n      const emailText = this.generateEmailText(expiredOrExpiring);\n\n      const today = new Date().toLocaleDateString('id-ID', {\n        weekday: 'long',\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric',\n      });\n\n      const sent = await emailService.sendEmail({\n        to: this.NOTIFICATION_EMAIL,\n        subject: `âš ï¸ Notifikasi SIMPER Expired/Akan Expired - ${today}`,\n        html: emailHtml,\n        text: emailText,\n      });\n\n      return { sent, count: expiredOrExpiring.length };\n    } catch (error) {\n      console.error('âŒ Error checking SIMPER expiry:', error);\n      return { sent: false, count: 0 };\n    }\n  }\n\n  private async getSimperExpiryData(): Promise<SimperExpiredData[]> {\n    const allSimper = await storage.getAllSimperMonitoring();\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n\n    return allSimper.map(simper => {\n      const bibExpiry = simper.simperBibExpiredDate ? new Date(simper.simperBibExpiredDate) : null;\n      const tiaExpiry = simper.simperTiaExpiredDate ? new Date(simper.simperTiaExpiredDate) : null;\n\n      let bibDaysRemaining: number | null = null;\n      let tiaDaysRemaining: number | null = null;\n      let bibStatus: 'expired' | 'expiring_soon' | 'ok' = 'ok';\n      let tiaStatus: 'expired' | 'expiring_soon' | 'ok' = 'ok';\n\n      if (bibExpiry) {\n        bibDaysRemaining = Math.ceil((bibExpiry.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n        if (bibDaysRemaining < 0) {\n          bibStatus = 'expired';\n        } else if (bibDaysRemaining <= this.WARNING_DAYS) {\n          bibStatus = 'expiring_soon';\n        }\n      }\n\n      if (tiaExpiry) {\n        tiaDaysRemaining = Math.ceil((tiaExpiry.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n        if (tiaDaysRemaining < 0) {\n          tiaStatus = 'expired';\n        } else if (tiaDaysRemaining <= this.WARNING_DAYS) {\n          tiaStatus = 'expiring_soon';\n        }\n      }\n\n      return {\n        employeeName: simper.employeeName,\n        nik: simper.nik,\n        simperBibExpiredDate: simper.simperBibExpiredDate,\n        simperTiaExpiredDate: simper.simperTiaExpiredDate,\n        bibStatus,\n        tiaStatus,\n        bibDaysRemaining,\n        tiaDaysRemaining,\n      };\n    }).filter(s => s.bibStatus !== 'ok' || s.tiaStatus !== 'ok');\n  }\n\n  private generateEmailHtml(data: SimperExpiredData[]): string {\n    const expiredBib = data.filter(s => s.bibStatus === 'expired');\n    const expiringBib = data.filter(s => s.bibStatus === 'expiring_soon');\n    const expiredTia = data.filter(s => s.tiaStatus === 'expired');\n    const expiringTia = data.filter(s => s.tiaStatus === 'expiring_soon');\n\n    const today = new Date().toLocaleDateString('id-ID', {\n      weekday: 'long',\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n    });\n\n    return `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 800px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; padding: 20px; border-radius: 8px 8px 0 0; }\n    .header h1 { margin: 0; font-size: 24px; }\n    .header p { margin: 5px 0 0; opacity: 0.9; }\n    .content { background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb; }\n    .section { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e5e7eb; }\n    .section-title { font-size: 16px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }\n    .expired { color: #dc2626; }\n    .warning { color: #f59e0b; }\n    table { width: 100%; border-collapse: collapse; font-size: 14px; }\n    th { background: #f3f4f6; padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb; }\n    td { padding: 10px; border-bottom: 1px solid #e5e7eb; }\n    .status-expired { background: #fef2f2; color: #dc2626; padding: 2px 8px; border-radius: 4px; font-weight: bold; }\n    .status-warning { background: #fffbeb; color: #d97706; padding: 2px 8px; border-radius: 4px; font-weight: bold; }\n    .footer { background: #f3f4f6; padding: 15px; text-align: center; font-size: 12px; color: #6b7280; border-radius: 0 0 8px 8px; }\n    .summary { display: flex; gap: 20px; margin-bottom: 15px; }\n    .summary-card { flex: 1; background: white; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb; }\n    .summary-number { font-size: 28px; font-weight: bold; }\n    .summary-label { font-size: 12px; color: #6b7280; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>âš ï¸ Notifikasi SIMPER Expired</h1>\n      <p>${today}</p>\n    </div>\n    \n    <div class=\"content\">\n      <div class=\"summary\">\n        <div class=\"summary-card\">\n          <div class=\"summary-number expired\">${expiredBib.length + expiredTia.length}</div>\n          <div class=\"summary-label\">Sudah Expired</div>\n        </div>\n        <div class=\"summary-card\">\n          <div class=\"summary-number warning\">${expiringBib.length + expiringTia.length}</div>\n          <div class=\"summary-label\">Akan Expired (â‰¤30 hari)</div>\n        </div>\n      </div>\n\n      ${expiredBib.length > 0 ? `\n      <div class=\"section\">\n        <div class=\"section-title expired\">ðŸ”´ SIMPER BIB - SUDAH EXPIRED (${expiredBib.length})</div>\n        <table>\n          <tr><th>Nama</th><th>NIK</th><th>Tanggal Expired</th><th>Status</th></tr>\n          ${expiredBib.map(s => `\n          <tr>\n            <td>${s.employeeName}</td>\n            <td>${s.nik}</td>\n            <td>${s.simperBibExpiredDate}</td>\n            <td><span class=\"status-expired\">Expired ${Math.abs(s.bibDaysRemaining || 0)} hari</span></td>\n          </tr>\n          `).join('')}\n        </table>\n      </div>\n      ` : ''}\n\n      ${expiringBib.length > 0 ? `\n      <div class=\"section\">\n        <div class=\"section-title warning\">ðŸŸ¡ SIMPER BIB - AKAN EXPIRED (${expiringBib.length})</div>\n        <table>\n          <tr><th>Nama</th><th>NIK</th><th>Tanggal Expired</th><th>Sisa Hari</th></tr>\n          ${expiringBib.map(s => `\n          <tr>\n            <td>${s.employeeName}</td>\n            <td>${s.nik}</td>\n            <td>${s.simperBibExpiredDate}</td>\n            <td><span class=\"status-warning\">${s.bibDaysRemaining} hari lagi</span></td>\n          </tr>\n          `).join('')}\n        </table>\n      </div>\n      ` : ''}\n\n      ${expiredTia.length > 0 ? `\n      <div class=\"section\">\n        <div class=\"section-title expired\">ðŸ”´ SIMPER TIA - SUDAH EXPIRED (${expiredTia.length})</div>\n        <table>\n          <tr><th>Nama</th><th>NIK</th><th>Tanggal Expired</th><th>Status</th></tr>\n          ${expiredTia.map(s => `\n          <tr>\n            <td>${s.employeeName}</td>\n            <td>${s.nik}</td>\n            <td>${s.simperTiaExpiredDate}</td>\n            <td><span class=\"status-expired\">Expired ${Math.abs(s.tiaDaysRemaining || 0)} hari</span></td>\n          </tr>\n          `).join('')}\n        </table>\n      </div>\n      ` : ''}\n\n      ${expiringTia.length > 0 ? `\n      <div class=\"section\">\n        <div class=\"section-title warning\">ðŸŸ¡ SIMPER TIA - AKAN EXPIRED (${expiringTia.length})</div>\n        <table>\n          <tr><th>Nama</th><th>NIK</th><th>Tanggal Expired</th><th>Sisa Hari</th></tr>\n          ${expiringTia.map(s => `\n          <tr>\n            <td>${s.employeeName}</td>\n            <td>${s.nik}</td>\n            <td>${s.simperTiaExpiredDate}</td>\n            <td><span class=\"status-warning\">${s.tiaDaysRemaining} hari lagi</span></td>\n          </tr>\n          `).join('')}\n        </table>\n      </div>\n      ` : ''}\n    </div>\n    \n    <div class=\"footer\">\n      <p>Email ini dikirim otomatis oleh sistem OneTalent GECL</p>\n      <p>Silakan update data SIMPER di aplikasi untuk menghentikan notifikasi</p>\n    </div>\n  </div>\n</body>\n</html>\n    `;\n  }\n\n  private generateEmailText(data: SimperExpiredData[]): string {\n    const expiredBib = data.filter(s => s.bibStatus === 'expired');\n    const expiringBib = data.filter(s => s.bibStatus === 'expiring_soon');\n    const expiredTia = data.filter(s => s.tiaStatus === 'expired');\n    const expiringTia = data.filter(s => s.tiaStatus === 'expiring_soon');\n\n    let text = '=== NOTIFIKASI SIMPER EXPIRED ===\\n\\n';\n\n    if (expiredBib.length > 0) {\n      text += 'SIMPER BIB - SUDAH EXPIRED:\\n';\n      expiredBib.forEach(s => {\n        text += `- ${s.employeeName} (${s.nik}) - Expired: ${s.simperBibExpiredDate}\\n`;\n      });\n      text += '\\n';\n    }\n\n    if (expiringBib.length > 0) {\n      text += 'SIMPER BIB - AKAN EXPIRED:\\n';\n      expiringBib.forEach(s => {\n        text += `- ${s.employeeName} (${s.nik}) - Expired: ${s.simperBibExpiredDate} (${s.bibDaysRemaining} hari lagi)\\n`;\n      });\n      text += '\\n';\n    }\n\n    if (expiredTia.length > 0) {\n      text += 'SIMPER TIA - SUDAH EXPIRED:\\n';\n      expiredTia.forEach(s => {\n        text += `- ${s.employeeName} (${s.nik}) - Expired: ${s.simperTiaExpiredDate}\\n`;\n      });\n      text += '\\n';\n    }\n\n    if (expiringTia.length > 0) {\n      text += 'SIMPER TIA - AKAN EXPIRED:\\n';\n      expiringTia.forEach(s => {\n        text += `- ${s.employeeName} (${s.nik}) - Expired: ${s.simperTiaExpiredDate} (${s.tiaDaysRemaining} hari lagi)\\n`;\n      });\n    }\n\n    return text;\n  }\n}\n\nexport const simperNotificationService = new SimperNotificationService();\n","path":null,"size_bytes":10626,"size_tokens":null},"client/src/pages/announcements.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { format } from \"date-fns\";\nimport { \n  Plus, \n  Megaphone, \n  Edit, \n  Trash2, \n  Eye, \n  Users, \n  Image as ImageIcon, \n  Upload, \n  FileDown,\n  Loader2,\n  CheckCircle,\n  Clock,\n  X\n} from \"lucide-react\";\nimport { jsPDF } from \"jspdf\";\nimport autoTable from \"jspdf-autotable\";\n\ninterface Announcement {\n  id: string;\n  title: string;\n  content: string;\n  imageUrls?: string[] | null;\n  isActive: boolean;\n  createdBy: string;\n  createdByName: string;\n  createdAt: string;\n}\n\ninterface AnnouncementRead {\n  id: string;\n  announcementId: string;\n  employeeId: string;\n  employeeName: string;\n  employeePosition?: string | null;\n  readAt: string;\n}\n\nexport default function Announcements() {\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\n  const [isEditOpen, setIsEditOpen] = useState(false);\n  const [isDetailOpen, setIsDetailOpen] = useState(false);\n  const [selectedAnnouncement, setSelectedAnnouncement] = useState<Announcement | null>(null);\n  const [newTitle, setNewTitle] = useState(\"\");\n  const [newContent, setNewContent] = useState(\"\");\n  const [newIsActive, setNewIsActive] = useState(true);\n  const [imageFiles, setImageFiles] = useState<File[]>([]);\n  const [imagePreviews, setImagePreviews] = useState<string[]>([]);\n  const [existingImageUrls, setExistingImageUrls] = useState<string[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n\n  const { data: announcements = [], isLoading } = useQuery<Announcement[]>({\n    queryKey: [\"/api/announcements\"],\n  });\n\n  const { data: announcementReads = [], isLoading: readsLoading } = useQuery<AnnouncementRead[]>({\n    queryKey: [\"/api/announcements\", selectedAnnouncement?.id, \"reads\"],\n    queryFn: async () => {\n      if (!selectedAnnouncement?.id) return [];\n      const response = await fetch(`/api/announcements/${selectedAnnouncement.id}/reads`);\n      if (!response.ok) throw new Error(\"Failed to fetch reads\");\n      return response.json();\n    },\n    enabled: !!selectedAnnouncement?.id && isDetailOpen,\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: { title: string; content: string; imageUrls?: string[]; isActive: boolean; createdBy: string; createdByName: string }) => {\n      return apiRequest(\"/api/announcements\", \"POST\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/announcements\"] });\n      toast({ title: \"Berhasil\", description: \"Pengumuman berhasil dibuat\" });\n      resetForm();\n      setIsCreateOpen(false);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Gagal\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Announcement> }) => {\n      return apiRequest(`/api/announcements/${id}`, \"PATCH\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/announcements\"] });\n      toast({ title: \"Berhasil\", description: \"Pengumuman berhasil diupdate\" });\n      resetForm();\n      setIsEditOpen(false);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Gagal\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(`/api/announcements/${id}`, \"DELETE\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/announcements\"] });\n      toast({ title: \"Berhasil\", description: \"Pengumuman berhasil dihapus\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Gagal\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const resetForm = () => {\n    setNewTitle(\"\");\n    setNewContent(\"\");\n    setNewIsActive(true);\n    setImageFiles([]);\n    setImagePreviews([]);\n    setExistingImageUrls([]);\n    setSelectedAnnouncement(null);\n  };\n\n  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(e.target.files || []);\n    if (files.length === 0) return;\n\n    const newFiles = [...imageFiles, ...files];\n    setImageFiles(newFiles);\n\n    files.forEach(file => {\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setImagePreviews(prev => [...prev, reader.result as string]);\n      };\n      reader.readAsDataURL(file);\n    });\n  };\n\n  const removeImage = (index: number) => {\n    setImageFiles(prev => prev.filter((_, i) => i !== index));\n    setImagePreviews(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const removeExistingImage = (index: number) => {\n    setExistingImageUrls(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const uploadImages = async (): Promise<string[]> => {\n    if (imageFiles.length === 0) return [];\n    \n    setIsUploading(true);\n    try {\n      const uploadedUrls: string[] = [];\n      \n      for (const file of imageFiles) {\n        const formData = new FormData();\n        formData.append(\"image\", file);\n        \n        const response = await fetch(\"/api/announcements/upload-image\", {\n          method: \"POST\",\n          body: formData,\n        });\n        \n        if (!response.ok) throw new Error(\"Failed to upload image\");\n        const data = await response.json();\n        uploadedUrls.push(data.url);\n      }\n      \n      return uploadedUrls;\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  const handleCreate = async () => {\n    if (!newTitle.trim() || !newContent.trim()) {\n      toast({ title: \"Error\", description: \"Judul dan isi pengumuman wajib diisi\", variant: \"destructive\" });\n      return;\n    }\n\n    if (!user?.nik || !user?.name) {\n      toast({ title: \"Error\", description: \"Anda harus login untuk membuat pengumuman\", variant: \"destructive\" });\n      return;\n    }\n\n    let imageUrls: string[] = [];\n    if (imageFiles.length > 0) {\n      imageUrls = await uploadImages();\n    }\n\n    createMutation.mutate({\n      title: newTitle,\n      content: newContent,\n      imageUrls: imageUrls.length > 0 ? imageUrls : undefined,\n      isActive: newIsActive,\n      createdBy: user.nik,\n      createdByName: user.name,\n    });\n  };\n\n  const handleUpdate = async () => {\n    if (!selectedAnnouncement) return;\n\n    let imageUrls = [...existingImageUrls];\n    if (imageFiles.length > 0) {\n      const newUrls = await uploadImages();\n      imageUrls = [...imageUrls, ...newUrls];\n    }\n\n    updateMutation.mutate({\n      id: selectedAnnouncement.id,\n      data: {\n        title: newTitle,\n        content: newContent,\n        imageUrls: imageUrls.length > 0 ? imageUrls : undefined,\n        isActive: newIsActive,\n      },\n    });\n  };\n\n  const openEditDialog = (announcement: Announcement) => {\n    setSelectedAnnouncement(announcement);\n    setNewTitle(announcement.title);\n    setNewContent(announcement.content);\n    setNewIsActive(announcement.isActive);\n    setExistingImageUrls(announcement.imageUrls || []);\n    setImageFiles([]);\n    setImagePreviews([]);\n    setIsEditOpen(true);\n  };\n\n  const openDetailDialog = (announcement: Announcement) => {\n    setSelectedAnnouncement(announcement);\n    setIsDetailOpen(true);\n  };\n\n  const exportReadsToPdf = () => {\n    if (!selectedAnnouncement || announcementReads.length === 0) return;\n\n    const doc = new jsPDF();\n    const pageWidth = doc.internal.pageSize.getWidth();\n    \n    // Header dengan warna merah\n    doc.setFillColor(220, 38, 38);\n    doc.rect(0, 0, pageWidth, 35, 'F');\n    \n    // Judul header\n    doc.setTextColor(255, 255, 255);\n    doc.setFontSize(18);\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.text(\"LAPORAN PEMBACA PENGUMUMAN\", pageWidth / 2, 15, { align: \"center\" });\n    \n    // Sub-judul\n    doc.setFontSize(11);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.text(\"PT. Golden Energi Cemerlang Lestari\", pageWidth / 2, 23, { align: \"center\" });\n    doc.text(`Dicetak: ${format(new Date(), \"dd MMMM yyyy HH:mm\")}`, pageWidth / 2, 30, { align: \"center\" });\n    \n    // Reset warna untuk konten\n    doc.setTextColor(0, 0, 0);\n    \n    // Box informasi pengumuman\n    doc.setFillColor(248, 250, 252);\n    doc.roundedRect(14, 42, pageWidth - 28, 38, 3, 3, 'F');\n    doc.setDrawColor(200, 200, 200);\n    doc.roundedRect(14, 42, pageWidth - 28, 38, 3, 3, 'S');\n    \n    // Konten informasi\n    doc.setFontSize(10);\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.text(\"Judul Pengumuman:\", 20, 52);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.text(selectedAnnouncement.title, 70, 52);\n    \n    doc.setFont(\"helvetica\", \"bold\");\n    doc.text(\"Dibuat Oleh:\", 20, 60);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.text(selectedAnnouncement.createdByName, 70, 60);\n    \n    doc.setFont(\"helvetica\", \"bold\");\n    doc.text(\"Tanggal Dibuat:\", 20, 68);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.text(format(new Date(selectedAnnouncement.createdAt), \"dd MMMM yyyy HH:mm\"), 70, 68);\n    \n    doc.setFont(\"helvetica\", \"bold\");\n    doc.text(\"Total Pembaca:\", 20, 76);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setTextColor(220, 38, 38);\n    doc.text(`${announcementReads.length} orang`, 70, 76);\n    doc.setTextColor(0, 0, 0);\n\n    // Tabel data pembaca\n    const tableData = announcementReads.map((read, index) => [\n      (index + 1).toString(),\n      read.employeeName,\n      read.employeePosition || \"-\",\n      read.employeeId,\n      format(new Date(read.readAt), \"dd MMM yyyy HH:mm\"),\n    ]);\n\n    autoTable(doc, {\n      startY: 88,\n      head: [[\"No\", \"Nama Karyawan\", \"Jabatan\", \"NIK\", \"Waktu Baca\"]],\n      body: tableData,\n      theme: \"striped\",\n      headStyles: { \n        fillColor: [220, 38, 38],\n        textColor: [255, 255, 255],\n        fontStyle: \"bold\",\n        halign: \"center\",\n        fontSize: 10,\n      },\n      bodyStyles: {\n        fontSize: 9,\n        cellPadding: 4,\n      },\n      columnStyles: {\n        0: { halign: \"center\", cellWidth: 12 },\n        1: { cellWidth: 50 },\n        2: { cellWidth: 35 },\n        3: { halign: \"center\", cellWidth: 28 },\n        4: { halign: \"center\", cellWidth: 40 },\n      },\n      alternateRowStyles: {\n        fillColor: [248, 250, 252],\n      },\n      styles: {\n        lineColor: [200, 200, 200],\n        lineWidth: 0.1,\n      },\n      margin: { left: 14, right: 14 },\n    });\n\n    // Footer\n    const finalY = (doc as any).lastAutoTable.finalY + 15;\n    doc.setFontSize(8);\n    doc.setTextColor(128, 128, 128);\n    doc.text(\"Dokumen ini dihasilkan secara otomatis oleh sistem OneTalent - AttendanceQR\", pageWidth / 2, finalY, { align: \"center\" });\n\n    doc.save(`laporan-pembaca-${selectedAnnouncement.title.replace(/[^a-zA-Z0-9]/g, '-').substring(0, 30)}.pdf`);\n    toast({ title: \"Berhasil\", description: \"PDF berhasil diunduh\" });\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-gray-800 dark:text-white flex items-center gap-3\">\n            <Megaphone className=\"h-8 w-8 text-purple-600\" />\n            Kelola Pengumuman\n          </h1>\n          <p className=\"text-gray-600 dark:text-gray-400 mt-1\">\n            Buat dan kelola pengumuman untuk driver\n          </p>\n        </div>\n        <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>\n          <DialogTrigger asChild>\n            <Button className=\"bg-purple-600 hover:bg-purple-700\" data-testid=\"btn-create-announcement\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Buat Pengumuman\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Buat Pengumuman Baru</DialogTitle>\n              <DialogDescription>Isi form berikut untuk membuat pengumuman baru</DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div>\n                <Label htmlFor=\"title\">Judul Pengumuman</Label>\n                <Input\n                  id=\"title\"\n                  value={newTitle}\n                  onChange={(e) => setNewTitle(e.target.value)}\n                  placeholder=\"Masukkan judul pengumuman\"\n                  data-testid=\"input-title\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"content\">Isi Pengumuman</Label>\n                <Textarea\n                  id=\"content\"\n                  value={newContent}\n                  onChange={(e) => setNewContent(e.target.value)}\n                  placeholder=\"Masukkan isi pengumuman\"\n                  rows={5}\n                  data-testid=\"input-content\"\n                />\n              </div>\n              <div>\n                <Label>Gambar (Bisa lebih dari satu)</Label>\n                <div className=\"mt-2 space-y-3\">\n                  <input\n                    type=\"file\"\n                    accept=\"image/*\"\n                    multiple\n                    onChange={handleImageSelect}\n                    className=\"hidden\"\n                    id=\"image-upload\"\n                    data-testid=\"input-image\"\n                  />\n                  <label\n                    htmlFor=\"image-upload\"\n                    className=\"flex items-center justify-center w-full h-24 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors\"\n                  >\n                    <div className=\"text-center\">\n                      <Upload className=\"h-6 w-6 text-gray-400 mx-auto mb-1\" />\n                      <p className=\"text-sm text-gray-500\">Klik untuk upload gambar</p>\n                      <p className=\"text-xs text-gray-400\">Bisa pilih beberapa foto sekaligus</p>\n                    </div>\n                  </label>\n                  \n                  {imagePreviews.length > 0 && (\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      {imagePreviews.map((preview, index) => (\n                        <div key={index} className=\"relative\">\n                          <img \n                            src={preview} \n                            alt={`Preview ${index + 1}`} \n                            className=\"w-full h-20 object-cover rounded-lg\"\n                          />\n                          <button\n                            type=\"button\"\n                            onClick={() => removeImage(index)}\n                            className=\"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600\"\n                          >\n                            <X className=\"h-3 w-3\" />\n                          </button>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"active\">Aktifkan Pengumuman</Label>\n                <Switch\n                  id=\"active\"\n                  checked={newIsActive}\n                  onCheckedChange={setNewIsActive}\n                  data-testid=\"switch-active\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => { resetForm(); setIsCreateOpen(false); }}>\n                Batal\n              </Button>\n              <Button \n                onClick={handleCreate} \n                disabled={createMutation.isPending || isUploading}\n                className=\"bg-purple-600 hover:bg-purple-700\"\n                data-testid=\"btn-submit-create\"\n              >\n                {(createMutation.isPending || isUploading) && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                Buat Pengumuman\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Daftar Pengumuman</CardTitle>\n          <CardDescription>\n            {announcements.length} pengumuman tersedia\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-purple-600\" />\n            </div>\n          ) : announcements.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <Megaphone className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\n              <p className=\"text-gray-500\">Belum ada pengumuman. Buat pengumuman pertama Anda!</p>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Judul</TableHead>\n                  <TableHead>Pembuat</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead>Tanggal Dibuat</TableHead>\n                  <TableHead className=\"text-right\">Aksi</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {announcements.map((announcement) => (\n                  <TableRow key={announcement.id} data-testid={`row-announcement-${announcement.id}`}>\n                    <TableCell>\n                      <div className=\"flex items-center gap-3\">\n                        {announcement.imageUrls && announcement.imageUrls.length > 0 && (\n                          <div className=\"w-10 h-10 rounded overflow-hidden bg-gray-100 flex-shrink-0 relative\">\n                            <img \n                              src={announcement.imageUrls[0]} \n                              alt=\"\" \n                              className=\"w-full h-full object-cover\"\n                              onError={(e) => { (e.target as HTMLImageElement).style.display = 'none'; }}\n                            />\n                            {announcement.imageUrls.length > 1 && (\n                              <div className=\"absolute bottom-0 right-0 bg-black/70 text-white text-xs px-1 rounded-tl\">\n                                +{announcement.imageUrls.length - 1}\n                              </div>\n                            )}\n                          </div>\n                        )}\n                        <div>\n                          <p className=\"font-medium\">{announcement.title}</p>\n                          <p className=\"text-sm text-gray-500 line-clamp-1\">{announcement.content}</p>\n                        </div>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <span className=\"text-sm text-gray-600\">{announcement.createdByName}</span>\n                    </TableCell>\n                    <TableCell>\n                      <Badge className={announcement.isActive ? \"bg-green-500\" : \"bg-gray-400\"}>\n                        {announcement.isActive ? \"Aktif\" : \"Nonaktif\"}\n                      </Badge>\n                    </TableCell>\n                    <TableCell>\n                      {format(new Date(announcement.createdAt), \"dd MMM yyyy HH:mm\")}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex justify-end gap-2\">\n                        <Button \n                          variant=\"outline\" \n                          size=\"sm\"\n                          onClick={() => openDetailDialog(announcement)}\n                          data-testid={`btn-view-${announcement.id}`}\n                        >\n                          <Eye className=\"h-4 w-4 mr-1\" />\n                          Detail\n                        </Button>\n                        <Button \n                          variant=\"outline\" \n                          size=\"sm\"\n                          onClick={() => openEditDialog(announcement)}\n                          data-testid={`btn-edit-${announcement.id}`}\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                        </Button>\n                        <Button \n                          variant=\"destructive\" \n                          size=\"sm\"\n                          onClick={() => {\n                            if (confirm(\"Apakah Anda yakin ingin menghapus pengumuman ini?\")) {\n                              deleteMutation.mutate(announcement.id);\n                            }\n                          }}\n                          data-testid={`btn-delete-${announcement.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={isEditOpen} onOpenChange={setIsEditOpen}>\n        <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Edit Pengumuman</DialogTitle>\n            <DialogDescription>Ubah informasi pengumuman</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"edit-title\">Judul Pengumuman</Label>\n              <Input\n                id=\"edit-title\"\n                value={newTitle}\n                onChange={(e) => setNewTitle(e.target.value)}\n                placeholder=\"Masukkan judul pengumuman\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"edit-content\">Isi Pengumuman</Label>\n              <Textarea\n                id=\"edit-content\"\n                value={newContent}\n                onChange={(e) => setNewContent(e.target.value)}\n                placeholder=\"Masukkan isi pengumuman\"\n                rows={5}\n              />\n            </div>\n            <div>\n              <Label>Gambar</Label>\n              <div className=\"mt-2 space-y-3\">\n                {existingImageUrls.length > 0 && (\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    {existingImageUrls.map((url, index) => (\n                      <div key={`existing-${index}`} className=\"relative\">\n                        <img \n                          src={url} \n                          alt={`Existing ${index + 1}`} \n                          className=\"w-full h-20 object-cover rounded-lg\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => removeExistingImage(index)}\n                          className=\"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600\"\n                        >\n                          <X className=\"h-3 w-3\" />\n                        </button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  multiple\n                  onChange={handleImageSelect}\n                  className=\"hidden\"\n                  id=\"edit-image-upload\"\n                />\n                <label\n                  htmlFor=\"edit-image-upload\"\n                  className=\"flex items-center justify-center w-full h-20 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors\"\n                >\n                  <div className=\"text-center\">\n                    <Upload className=\"h-5 w-5 text-gray-400 mx-auto mb-1\" />\n                    <p className=\"text-xs text-gray-500\">Tambah gambar baru</p>\n                  </div>\n                </label>\n\n                {imagePreviews.length > 0 && (\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    {imagePreviews.map((preview, index) => (\n                      <div key={`new-${index}`} className=\"relative\">\n                        <img \n                          src={preview} \n                          alt={`New ${index + 1}`} \n                          className=\"w-full h-20 object-cover rounded-lg border-2 border-green-500\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => removeImage(index)}\n                          className=\"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600\"\n                        >\n                          <X className=\"h-3 w-3\" />\n                        </button>\n                        <span className=\"absolute bottom-0 left-0 bg-green-500 text-white text-xs px-1 rounded-tr\">\n                          Baru\n                        </span>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"edit-active\">Aktifkan Pengumuman</Label>\n              <Switch\n                id=\"edit-active\"\n                checked={newIsActive}\n                onCheckedChange={setNewIsActive}\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => { resetForm(); setIsEditOpen(false); }}>\n              Batal\n            </Button>\n            <Button \n              onClick={handleUpdate} \n              disabled={updateMutation.isPending || isUploading}\n              className=\"bg-purple-600 hover:bg-purple-700\"\n            >\n              {(updateMutation.isPending || isUploading) && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Simpan Perubahan\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={isDetailOpen} onOpenChange={setIsDetailOpen}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Users className=\"h-5 w-5 text-purple-600\" />\n              Detail Pengumuman & Pembaca\n            </DialogTitle>\n          </DialogHeader>\n          {selectedAnnouncement && (\n            <div className=\"space-y-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-lg\">{selectedAnnouncement.title}</CardTitle>\n                  <CardDescription>\n                    Dibuat oleh: {selectedAnnouncement.createdByName} | {format(new Date(selectedAnnouncement.createdAt), \"dd MMM yyyy HH:mm\")}\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {selectedAnnouncement.imageUrls && selectedAnnouncement.imageUrls.length > 0 && (\n                    <div className=\"mb-4 grid grid-cols-2 gap-2\">\n                      {selectedAnnouncement.imageUrls.map((url, index) => (\n                        <img \n                          key={index}\n                          src={url} \n                          alt={`${selectedAnnouncement.title} - ${index + 1}`}\n                          className=\"w-full max-h-48 object-cover rounded-lg\"\n                        />\n                      ))}\n                    </div>\n                  )}\n                  <p className=\"text-gray-700 dark:text-gray-300 whitespace-pre-wrap\">\n                    {selectedAnnouncement.content}\n                  </p>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <CheckCircle className=\"h-5 w-5 text-green-600\" />\n                      Daftar Pembaca ({announcementReads.length})\n                    </CardTitle>\n                    <CardDescription>Karyawan yang sudah membaca pengumuman ini</CardDescription>\n                  </div>\n                  {announcementReads.length > 0 && (\n                    <Button \n                      variant=\"outline\" \n                      onClick={exportReadsToPdf}\n                      data-testid=\"btn-export-reads\"\n                    >\n                      <FileDown className=\"h-4 w-4 mr-2\" />\n                      Export PDF\n                    </Button>\n                  )}\n                </CardHeader>\n                <CardContent>\n                  {readsLoading ? (\n                    <div className=\"flex items-center justify-center py-8\">\n                      <Loader2 className=\"h-6 w-6 animate-spin text-purple-600\" />\n                    </div>\n                  ) : announcementReads.length === 0 ? (\n                    <div className=\"text-center py-6\">\n                      <Clock className=\"h-10 w-10 text-gray-400 mx-auto mb-2\" />\n                      <p className=\"text-gray-500\">Belum ada yang membaca pengumuman ini</p>\n                    </div>\n                  ) : (\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead className=\"w-12\">No</TableHead>\n                          <TableHead>Nama Karyawan</TableHead>\n                          <TableHead>Jabatan</TableHead>\n                          <TableHead>NIK</TableHead>\n                          <TableHead>Waktu Baca</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {announcementReads.map((read, index) => (\n                          <TableRow key={read.id}>\n                            <TableCell className=\"text-center\">{index + 1}</TableCell>\n                            <TableCell className=\"font-medium\">{read.employeeName}</TableCell>\n                            <TableCell className=\"text-gray-600\">{read.employeePosition || \"-\"}</TableCell>\n                            <TableCell>{read.employeeId}</TableCell>\n                            <TableCell>\n                              {format(new Date(read.readAt), \"dd MMM yyyy HH:mm\")}\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":31304,"size_tokens":null},"client/src/components/ui/bouncing-loader.tsx":{"content":"import { cn } from \"@/lib/utils\";\n\ninterface BouncingLoaderProps {\n  className?: string;\n  size?: \"sm\" | \"md\" | \"lg\";\n  color?: \"purple\" | \"red\" | \"blue\" | \"green\" | \"gray\";\n  text?: string;\n}\n\nexport function BouncingLoader({ \n  className, \n  size = \"md\", \n  color = \"purple\",\n  text \n}: BouncingLoaderProps) {\n  const sizeClasses = {\n    sm: \"w-2 h-2\",\n    md: \"w-3 h-3\",\n    lg: \"w-4 h-4\",\n  };\n\n  const shadowSizeClasses = {\n    sm: \"w-2 h-1\",\n    md: \"w-3 h-1.5\",\n    lg: \"w-4 h-2\",\n  };\n\n  const colorClasses = {\n    purple: \"bg-purple-500\",\n    red: \"bg-red-500\",\n    blue: \"bg-blue-500\",\n    green: \"bg-green-500\",\n    gray: \"bg-gray-500\",\n  };\n\n  const shadowColorClasses = {\n    purple: \"bg-purple-300/50\",\n    red: \"bg-red-300/50\",\n    blue: \"bg-blue-300/50\",\n    green: \"bg-green-300/50\",\n    gray: \"bg-gray-300/50\",\n  };\n\n  return (\n    <div className={cn(\"flex flex-col items-center justify-center gap-4\", className)}>\n      <div className=\"relative flex items-end justify-center gap-2\">\n        {[0, 1, 2].map((index) => (\n          <div key={index} className=\"flex flex-col items-center\">\n            <div\n              className={cn(\n                \"rounded-full animate-bounce-dot\",\n                sizeClasses[size],\n                colorClasses[color]\n              )}\n              style={{\n                animationDelay: `${index * 0.15}s`,\n              }}\n            />\n            <div\n              className={cn(\n                \"rounded-full mt-1 animate-shadow-pulse\",\n                shadowSizeClasses[size],\n                shadowColorClasses[color]\n              )}\n              style={{\n                animationDelay: `${index * 0.15}s`,\n              }}\n            />\n          </div>\n        ))}\n      </div>\n      {text && (\n        <p className=\"text-sm font-medium text-gray-600 dark:text-gray-300 animate-pulse\">\n          {text}\n        </p>\n      )}\n    </div>\n  );\n}\n\nexport function FullPageLoader({ text = \"Memuat...\" }: { text?: string }) {\n  return (\n    <div className=\"fixed inset-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-50\">\n      <BouncingLoader size=\"lg\" color=\"purple\" text={text} />\n    </div>\n  );\n}\n\nexport function CardLoader({ text }: { text?: string }) {\n  return (\n    <div className=\"flex items-center justify-center py-12\">\n      <BouncingLoader size=\"md\" color=\"purple\" text={text} />\n    </div>\n  );\n}\n","path":null,"size_bytes":2417,"size_tokens":null},"server/push-notification.ts":{"content":"import webpush from 'web-push';\nimport { db } from './db';\nimport { pushSubscriptions } from '@shared/schema';\nimport { eq, and } from 'drizzle-orm';\n\nconst VAPID_PUBLIC_KEY = process.env.VAPID_PUBLIC_KEY;\nconst VAPID_PRIVATE_KEY = process.env.VAPID_PRIVATE_KEY;\n\nif (VAPID_PUBLIC_KEY && VAPID_PRIVATE_KEY) {\n  webpush.setVapidDetails(\n    'mailto:onesafe.gecl@gmail.com',\n    VAPID_PUBLIC_KEY,\n    VAPID_PRIVATE_KEY\n  );\n  console.log('âœ… Push notification service initialized');\n} else {\n  console.log('âš ï¸ Push notification service: VAPID keys not configured');\n}\n\nexport interface PushPayload {\n  title: string;\n  body: string;\n  icon?: string;\n  url?: string;\n  type?: 'news' | 'announcement' | 'shift' | 'leave' | 'simper' | 'general';\n  tag?: string;\n}\n\nexport async function sendPushNotification(employeeId: string, payload: PushPayload): Promise<boolean> {\n  if (!VAPID_PUBLIC_KEY || !VAPID_PRIVATE_KEY) {\n    console.log('Push notification skipped: VAPID keys not configured');\n    return false;\n  }\n\n  try {\n    const subscriptions = await db.select()\n      .from(pushSubscriptions)\n      .where(and(\n        eq(pushSubscriptions.employeeId, employeeId),\n        eq(pushSubscriptions.isActive, true)\n      ));\n\n    if (subscriptions.length === 0) {\n      console.log(`No active subscriptions for employee ${employeeId}`);\n      return false;\n    }\n\n    const notificationPayload = JSON.stringify({\n      title: payload.title,\n      body: payload.body,\n      icon: payload.icon || '/icons/icon-192x192.png',\n      url: payload.url || '/',\n      type: payload.type || 'general',\n      tag: payload.tag || `onetalent-${Date.now()}`\n    });\n\n    const results = await Promise.allSettled(\n      subscriptions.map(async (sub) => {\n        try {\n          await webpush.sendNotification(\n            {\n              endpoint: sub.endpoint,\n              keys: {\n                p256dh: sub.p256dh,\n                auth: sub.auth\n              }\n            },\n            notificationPayload\n          );\n          return { success: true, endpoint: sub.endpoint };\n        } catch (error: any) {\n          if (error.statusCode === 410 || error.statusCode === 404) {\n            await db.update(pushSubscriptions)\n              .set({ isActive: false })\n              .where(eq(pushSubscriptions.id, sub.id));\n            console.log(`Subscription expired, marked inactive: ${sub.id}`);\n          }\n          throw error;\n        }\n      })\n    );\n\n    const successCount = results.filter(r => r.status === 'fulfilled').length;\n    console.log(`Push sent to ${successCount}/${subscriptions.length} devices for employee ${employeeId}`);\n    return successCount > 0;\n  } catch (error) {\n    console.error('Error sending push notification:', error);\n    return false;\n  }\n}\n\nexport async function sendPushToAll(payload: PushPayload): Promise<{ sent: number; failed: number }> {\n  if (!VAPID_PUBLIC_KEY || !VAPID_PRIVATE_KEY) {\n    console.log('Push notification skipped: VAPID keys not configured');\n    return { sent: 0, failed: 0 };\n  }\n\n  try {\n    const subscriptions = await db.select()\n      .from(pushSubscriptions)\n      .where(eq(pushSubscriptions.isActive, true));\n\n    if (subscriptions.length === 0) {\n      console.log('No active subscriptions found');\n      return { sent: 0, failed: 0 };\n    }\n\n    const notificationPayload = JSON.stringify({\n      title: payload.title,\n      body: payload.body,\n      icon: payload.icon || '/icons/icon-192x192.png',\n      url: payload.url || '/',\n      type: payload.type || 'general',\n      tag: payload.tag || `onetalent-${Date.now()}`\n    });\n\n    let sent = 0;\n    let failed = 0;\n\n    for (const sub of subscriptions) {\n      try {\n        await webpush.sendNotification(\n          {\n            endpoint: sub.endpoint,\n            keys: {\n              p256dh: sub.p256dh,\n              auth: sub.auth\n            }\n          },\n          notificationPayload\n        );\n        sent++;\n      } catch (error: any) {\n        failed++;\n        if (error.statusCode === 410 || error.statusCode === 404) {\n          await db.update(pushSubscriptions)\n            .set({ isActive: false })\n            .where(eq(pushSubscriptions.id, sub.id));\n        }\n      }\n    }\n\n    console.log(`Push broadcast: ${sent} sent, ${failed} failed`);\n    return { sent, failed };\n  } catch (error) {\n    console.error('Error broadcasting push notification:', error);\n    return { sent: 0, failed: 0 };\n  }\n}\n\nexport async function sendPushToMultiple(employeeIds: string[], payload: PushPayload): Promise<{ sent: number; failed: number }> {\n  let totalSent = 0;\n  let totalFailed = 0;\n\n  for (const employeeId of employeeIds) {\n    const success = await sendPushNotification(employeeId, payload);\n    if (success) {\n      totalSent++;\n    } else {\n      totalFailed++;\n    }\n  }\n\n  return { sent: totalSent, failed: totalFailed };\n}\n\nexport function getVapidPublicKey(): string | undefined {\n  return VAPID_PUBLIC_KEY;\n}\n\nexport class PushNotificationService {\n  async sendNotification(\n    subscription: { endpoint: string; keys: { p256dh: string; auth: string } },\n    payload: { title: string; body: string; icon?: string; badge?: string; data?: any }\n  ): Promise<boolean> {\n    if (!VAPID_PUBLIC_KEY || !VAPID_PRIVATE_KEY) {\n      console.log('Push notification skipped: VAPID keys not configured');\n      return false;\n    }\n\n    try {\n      const notificationPayload = JSON.stringify({\n        title: payload.title,\n        body: payload.body,\n        icon: payload.icon || '/icons/icon-192x192.png',\n        badge: payload.badge || '/icons/icon-72x72.png',\n        data: payload.data || {}\n      });\n\n      await webpush.sendNotification(\n        {\n          endpoint: subscription.endpoint,\n          keys: {\n            p256dh: subscription.keys.p256dh,\n            auth: subscription.keys.auth\n          }\n        },\n        notificationPayload\n      );\n      \n      return true;\n    } catch (error: any) {\n      console.error('Error sending push notification:', error);\n      throw error;\n    }\n  }\n}\n","path":null,"size_bytes":6053,"size_tokens":null},"client/src/pages/documents.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { \n  FileText, \n  Upload, \n  Download, \n  Trash2, \n  Eye,\n  Plus,\n  X,\n  Search,\n  ArrowLeft,\n  ChevronRight,\n  ChevronDown,\n  BarChart3\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  Dialog, \n  DialogContent, \n  DialogHeader, \n  DialogTitle,\n  DialogDescription,\n  DialogFooter\n} from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { \n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue\n} from \"@/components/ui/select\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Permission, Role } from \"@shared/rbac\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { format } from \"date-fns\";\nimport { id } from \"date-fns/locale\";\nimport type { Document, DocumentCategory } from \"@shared/schema\";\nimport { documentCategories } from \"@shared/schema\";\n\nconst categorySlugMap: Record<string, DocumentCategory> = {\n  \"kebijakan-kplh\": \"Kebijakan KPLH\",\n  \"dept-hse\": \"Prosedur - Dept HSE\",\n  \"dept-opr\": \"Prosedur - Dept Opr\",\n  \"dept-plant\": \"Prosedur - Dept Plant\",\n  \"spdk\": \"SPDK\",\n  \"zero-harm\": \"Zero Harm\",\n  \"critical-control-card\": \"Critical Control Card\",\n  \"golden-rule\": \"Golden Rule\",\n};\n\nconst slugFromCategory: Record<string, string> = {\n  \"Kebijakan KPLH\": \"kebijakan-kplh\",\n  \"Prosedur - Dept HSE\": \"dept-hse\",\n  \"Prosedur - Dept Opr\": \"dept-opr\",\n  \"Prosedur - Dept Plant\": \"dept-plant\",\n  \"SPDK\": \"spdk\",\n  \"Zero Harm\": \"zero-harm\",\n  \"Critical Control Card\": \"critical-control-card\",\n  \"Golden Rule\": \"golden-rule\",\n};\n\nconst categoryShortNames: Record<string, string> = {\n  \"Kebijakan KPLH\": \"KPLH\",\n  \"Prosedur - Dept HSE\": \"PPO HSE\",\n  \"Prosedur - Dept Opr\": \"PPO OPR\",\n  \"Prosedur - Dept Plant\": \"PPO PLANT\",\n  \"SPDK\": \"SPDK\",\n  \"Zero Harm\": \"ZERO HARM\",\n  \"Critical Control Card\": \"CCC\",\n  \"Golden Rule\": \"GOLDEN RULE\",\n};\n\nexport default function DocumentsPage() {\n  const { toast } = useToast();\n  const { user, hasPermission } = useAuth();\n  const canManage = hasPermission(Permission.MANAGE_DOCUMENTS);\n  const [, params] = useRoute(\"/workspace/documents/:category\");\n  const [location, setLocation] = useLocation();\n  \n  const getCategoryFromSlug = (slug: string | undefined): string => {\n    if (!slug) return \"\";\n    return categorySlugMap[slug] || \"\";\n  };\n  \n  const [selectedCategory, setSelectedCategory] = useState<string>(() => \n    getCategoryFromSlug(params?.category)\n  );\n  const [uploadDialogOpen, setUploadDialogOpen] = useState(false);\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [deleteAllDialogOpen, setDeleteAllDialogOpen] = useState(false);\n  const [documentToDelete, setDocumentToDelete] = useState<Document | null>(null);\n  const [selectedDocument, setSelectedDocument] = useState<Document | null>(null);\n  const [uploading, setUploading] = useState(false);\n  const [uploadProgress, setUploadProgress] = useState(0);\n  const [currentUploadIndex, setCurrentUploadIndex] = useState(0);\n  const [isDragging, setIsDragging] = useState(false);\n  const [uploadFiles, setUploadFiles] = useState<{ file: File; title: string }[]>([]);\n  const [uploadCategory, setUploadCategory] = useState<DocumentCategory | \"\">(\"\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [showStats, setShowStats] = useState(false);\n  \n  const isAdmin = user?.role === Role.ADMIN;\n  \n  useEffect(() => {\n    const newCategory = getCategoryFromSlug(params?.category);\n    setSelectedCategory(newCategory);\n  }, [params?.category]);\n\n  const { data: documents, isLoading } = useQuery<Document[]>({\n    queryKey: ['/api/documents/active'],\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(`/api/documents/${id}`, 'DELETE');\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/documents/active'] });\n      toast({ title: \"Dokumen berhasil dihapus\" });\n      setDeleteDialogOpen(false);\n      setDocumentToDelete(null);\n      setSelectedDocument(null);\n    },\n    onError: () => {\n      toast({ title: \"Gagal menghapus dokumen\", variant: \"destructive\" });\n    }\n  });\n\n  const deleteAllMutation = useMutation({\n    mutationFn: async (category: string) => {\n      const docsToDelete = documents?.filter(d => d.category === category) || [];\n      for (const doc of docsToDelete) {\n        await apiRequest(`/api/documents/${doc.id}`, 'DELETE');\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/documents/active'] });\n      toast({ title: \"Semua dokumen dalam kategori berhasil dihapus\" });\n      setDeleteAllDialogOpen(false);\n    },\n    onError: () => {\n      toast({ title: \"Gagal menghapus dokumen\", variant: \"destructive\" });\n    }\n  });\n\n  const getTitleFromFilename = (filename: string): string => {\n    return filename.replace(/\\.pdf$/i, '').replace(/[-_]/g, ' ');\n  };\n\n  const handleFilesSelected = (files: FileList | null) => {\n    if (!files) return;\n    const pdfFiles = Array.from(files).filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));\n    if (pdfFiles.length === 0) {\n      toast({ title: \"Hanya file PDF yang diizinkan\", variant: \"destructive\" });\n      return;\n    }\n    const newFiles = pdfFiles.map(file => ({\n      file,\n      title: getTitleFromFilename(file.name)\n    }));\n    setUploadFiles(prev => [...prev, ...newFiles]);\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(true);\n  };\n\n  const handleDragLeave = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(false);\n  };\n\n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(false);\n    handleFilesSelected(e.dataTransfer.files);\n  };\n\n  const removeFile = (index: number) => {\n    setUploadFiles(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const updateFileTitle = (index: number, title: string) => {\n    setUploadFiles(prev => prev.map((f, i) => i === index ? { ...f, title } : f));\n  };\n\n  const handleUpload = async () => {\n    if (uploadFiles.length === 0 || !uploadCategory || !user) {\n      toast({ title: \"Pilih file dan kategori\", variant: \"destructive\" });\n      return;\n    }\n\n    if (uploadFiles.some(f => !f.title.trim())) {\n      toast({ title: \"Semua judul dokumen harus diisi\", variant: \"destructive\" });\n      return;\n    }\n\n    setUploading(true);\n    setUploadProgress(0);\n    setCurrentUploadIndex(0);\n    let successCount = 0;\n    let failCount = 0;\n\n    for (let i = 0; i < uploadFiles.length; i++) {\n      const { file, title } = uploadFiles[i];\n      setCurrentUploadIndex(i + 1);\n      setUploadProgress(Math.round(((i) / uploadFiles.length) * 100));\n      \n      try {\n        const formData = new FormData();\n        formData.append('file', file);\n        formData.append('title', title.trim());\n        formData.append('category', uploadCategory);\n        formData.append('uploadedBy', user.nik);\n        formData.append('uploadedByName', user.name);\n\n        const response = await fetch('/api/documents', {\n          method: 'POST',\n          body: formData\n        });\n\n        if (response.ok) {\n          successCount++;\n        } else {\n          failCount++;\n        }\n      } catch (error) {\n        failCount++;\n      }\n      \n      setUploadProgress(Math.round(((i + 1) / uploadFiles.length) * 100));\n    }\n\n    queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n    queryClient.invalidateQueries({ queryKey: ['/api/documents/active'] });\n    \n    if (failCount === 0) {\n      toast({ title: `${successCount} dokumen berhasil diupload` });\n    } else if (successCount === 0) {\n      toast({ title: `Gagal mengupload ${failCount} dokumen`, variant: \"destructive\" });\n    } else {\n      toast({ title: `${successCount} berhasil, ${failCount} gagal`, variant: \"destructive\" });\n    }\n    \n    setUploadDialogOpen(false);\n    setUploadFiles([]);\n    setUploadCategory(\"\");\n    setUploading(false);\n    setUploadProgress(0);\n    setCurrentUploadIndex(0);\n  };\n\n  const filteredDocuments = selectedCategory \n    ? (documents?.filter(doc => {\n        const matchesCategory = doc.category === selectedCategory;\n        const matchesSearch = !searchQuery || \n          doc.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n          doc.fileName.toLowerCase().includes(searchQuery.toLowerCase());\n        return matchesCategory && matchesSearch;\n      }) || [])\n    : [];\n  \n  const totalDocuments = documents?.length || 0;\n  \n  const categoryStats = documentCategories.map(cat => ({\n    category: cat,\n    count: documents?.filter(d => d.category === cat).length || 0,\n    slug: slugFromCategory[cat]\n  }));\n\n  const formatFileSize = (bytes: number | null) => {\n    if (!bytes) return \"-\";\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n  };\n\n  const handleBack = () => {\n    if (selectedDocument) {\n      setSelectedDocument(null);\n    } else {\n      setLocation(\"/workspace\");\n    }\n  };\n\n  const categoryDocsCount = documents?.filter(d => d.category === selectedCategory).length || 0;\n\n  return (\n    <div className=\"min-h-screen bg-white dark:bg-gray-900\">\n      {/* Red Header */}\n      <div className=\"bg-red-600 text-white\">\n        <div className=\"flex items-center gap-3 p-4\">\n          <button \n            onClick={handleBack}\n            className=\"p-1 hover:bg-red-700 rounded-lg transition-colors\"\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"w-6 h-6\" />\n          </button>\n          <h1 className=\"text-xl font-bold\">\n            {selectedCategory ? categoryShortNames[selectedCategory] || selectedCategory : \"Dokumen\"}\n          </h1>\n          \n          {/* Admin Actions */}\n          {canManage && selectedCategory && (\n            <div className=\"ml-auto flex gap-2\">\n              <button\n                onClick={() => setUploadDialogOpen(true)}\n                className=\"p-2 hover:bg-red-700 rounded-lg transition-colors\"\n                data-testid=\"button-upload-document\"\n              >\n                <Plus className=\"w-5 h-5\" />\n              </button>\n              {isAdmin && filteredDocuments.length > 0 && (\n                <button\n                  onClick={() => setDeleteAllDialogOpen(true)}\n                  className=\"p-2 hover:bg-red-700 rounded-lg transition-colors\"\n                  data-testid=\"button-delete-all\"\n                >\n                  <Trash2 className=\"w-5 h-5\" />\n                </button>\n              )}\n            </div>\n          )}\n        </div>\n        \n        {/* Red Search Bar */}\n        {selectedCategory && (\n          <div className=\"px-4 pb-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-red-300\" />\n              <input\n                type=\"text\"\n                placeholder=\"Search\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"w-full bg-red-500 text-white placeholder-red-200 border-none rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-red-400\"\n                data-testid=\"input-search-document\"\n              />\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Admin Stats Panel */}\n      {isAdmin && selectedCategory && (\n        <div className=\"border-b border-gray-200 dark:border-gray-700\">\n          <button\n            onClick={() => setShowStats(!showStats)}\n            className=\"w-full flex items-center justify-between p-4 text-left hover:bg-gray-50 dark:hover:bg-gray-800\"\n            data-testid=\"button-toggle-stats\"\n          >\n            <div className=\"flex items-center gap-2\">\n              <BarChart3 className=\"w-5 h-5 text-blue-600\" />\n              <span className=\"font-medium text-gray-900 dark:text-white\">Statistik Dokumen</span>\n              <span className=\"text-sm text-gray-500\">({totalDocuments} total)</span>\n            </div>\n            <ChevronDown className={`w-5 h-5 text-gray-400 transition-transform ${showStats ? 'rotate-180' : ''}`} />\n          </button>\n          \n          {showStats && (\n            <div className=\"px-4 pb-4 grid grid-cols-2 md:grid-cols-4 gap-2\">\n              {categoryStats.map(stat => (\n                <button\n                  key={stat.category}\n                  onClick={() => setLocation(`/workspace/documents/${stat.slug}`)}\n                  className={`p-3 rounded-lg text-left transition-colors ${\n                    stat.category === selectedCategory \n                      ? 'bg-red-100 dark:bg-red-900/30 border-2 border-red-500' \n                      : 'bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700'\n                  }`}\n                  data-testid={`stat-${stat.slug}`}\n                >\n                  <div className=\"text-xs text-gray-500 dark:text-gray-400 truncate\">\n                    {categoryShortNames[stat.category] || stat.category}\n                  </div>\n                  <div className=\"text-lg font-bold text-gray-900 dark:text-white\">\n                    {stat.count}\n                  </div>\n                </button>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Document List */}\n      <div className=\"divide-y divide-gray-200 dark:divide-gray-700\">\n        {isLoading ? (\n          <div className=\"text-center py-12\">\n            <div className=\"animate-spin rounded-full h-10 w-10 border-b-2 border-red-600 mx-auto\"></div>\n            <p className=\"text-gray-500 mt-3\">Memuat dokumen...</p>\n          </div>\n        ) : !selectedCategory ? (\n          <div className=\"text-center py-12\">\n            <FileText className=\"w-16 h-16 text-gray-300 mx-auto mb-4\" />\n            <p className=\"text-gray-500\">Pilih kategori dokumen dari menu</p>\n          </div>\n        ) : filteredDocuments.length === 0 ? (\n          <div className=\"text-center py-12\">\n            <FileText className=\"w-16 h-16 text-gray-300 mx-auto mb-4\" />\n            <p className=\"text-gray-500\">\n              {searchQuery ? \"Tidak ada dokumen yang cocok\" : `Belum ada dokumen di kategori ini`}\n            </p>\n          </div>\n        ) : (\n          filteredDocuments.map(doc => (\n            <div\n              key={doc.id}\n              className=\"flex items-center gap-3 p-4 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition-colors\"\n              onClick={() => setSelectedDocument(doc)}\n              data-testid={`list-document-${doc.id}`}\n            >\n              {/* Document Icon */}\n              <div className=\"w-12 h-14 bg-gray-100 dark:bg-gray-800 rounded flex items-center justify-center flex-shrink-0 border border-gray-200 dark:border-gray-700\">\n                <FileText className=\"w-6 h-6 text-gray-400\" />\n              </div>\n              \n              {/* Document Info */}\n              <div className=\"flex-1 min-w-0\">\n                <h3 className=\"font-medium text-gray-900 dark:text-white line-clamp-2\">\n                  {doc.title}\n                </h3>\n                <p className=\"text-sm text-gray-500 dark:text-gray-400 truncate\">\n                  {doc.fileName.replace(/\\.pdf$/i, '')}\n                </p>\n              </div>\n              \n              {/* Chevron */}\n              <ChevronRight className=\"w-5 h-5 text-gray-400 flex-shrink-0\" />\n            </div>\n          ))\n        )}\n      </div>\n\n      {/* Document Detail Dialog */}\n      <Dialog open={!!selectedDocument} onOpenChange={(open) => !open && setSelectedDocument(null)}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <FileText className=\"w-5 h-5 text-red-500\" />\n              Detail Dokumen\n            </DialogTitle>\n          </DialogHeader>\n          \n          {selectedDocument && (\n            <div className=\"space-y-4\">\n              <div>\n                <Label className=\"text-gray-500\">Judul</Label>\n                <p className=\"font-medium text-gray-900 dark:text-white\">{selectedDocument.title}</p>\n              </div>\n              <div>\n                <Label className=\"text-gray-500\">Nama File</Label>\n                <p className=\"text-gray-900 dark:text-white\">{selectedDocument.fileName}</p>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-gray-500\">Tanggal Upload</Label>\n                  <p className=\"text-gray-900 dark:text-white\">\n                    {selectedDocument.createdAt ? format(new Date(selectedDocument.createdAt), 'dd MMM yyyy', { locale: id }) : '-'}\n                  </p>\n                </div>\n                <div>\n                  <Label className=\"text-gray-500\">Ukuran</Label>\n                  <p className=\"text-gray-900 dark:text-white\">{formatFileSize(selectedDocument.fileSize)}</p>\n                </div>\n              </div>\n              <div>\n                <Label className=\"text-gray-500\">Diupload oleh</Label>\n                <p className=\"text-gray-900 dark:text-white\">{selectedDocument.uploadedByName}</p>\n              </div>\n              \n              <div className=\"flex gap-2 pt-4\">\n                <Button\n                  className=\"flex-1 bg-red-600 hover:bg-red-700\"\n                  onClick={() => window.open(selectedDocument.filePath, '_blank')}\n                  data-testid=\"button-view-document\"\n                >\n                  <Eye className=\"w-4 h-4 mr-2\" />\n                  Lihat\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  className=\"flex-1\"\n                  onClick={() => {\n                    const link = document.createElement('a');\n                    link.href = selectedDocument.filePath;\n                    link.download = selectedDocument.fileName;\n                    link.click();\n                  }}\n                  data-testid=\"button-download-document\"\n                >\n                  <Download className=\"w-4 h-4 mr-2\" />\n                  Unduh\n                </Button>\n              </div>\n              \n              {canManage && (\n                <Button\n                  variant=\"destructive\"\n                  className=\"w-full\"\n                  onClick={() => {\n                    setDocumentToDelete(selectedDocument);\n                    setDeleteDialogOpen(true);\n                  }}\n                  data-testid=\"button-delete-document\"\n                >\n                  <Trash2 className=\"w-4 h-4 mr-2\" />\n                  Hapus Dokumen\n                </Button>\n              )}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Upload Dialog */}\n      <Dialog open={uploadDialogOpen} onOpenChange={(open) => {\n        if (!uploading) {\n          setUploadDialogOpen(open);\n          if (!open) {\n            setUploadFiles([]);\n            setUploadCategory(\"\");\n          }\n        }\n      }}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Upload className=\"w-5 h-5\" />\n              Upload Dokumen Baru\n            </DialogTitle>\n            <DialogDescription>\n              Drag & drop file PDF atau klik untuk memilih. Bisa upload banyak file sekaligus.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"category\">Kategori</Label>\n              <Select \n                value={uploadCategory} \n                onValueChange={(value) => setUploadCategory(value as DocumentCategory)}\n                disabled={uploading}\n              >\n                <SelectTrigger data-testid=\"select-document-category\">\n                  <SelectValue placeholder=\"Pilih kategori\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {documentCategories.map(cat => (\n                    <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            {!uploading && (\n              <div className=\"space-y-2\">\n                <Label>File PDF</Label>\n                <div\n                  onDragOver={handleDragOver}\n                  onDragLeave={handleDragLeave}\n                  onDrop={handleDrop}\n                  className={`border-2 border-dashed rounded-lg p-6 text-center transition-all cursor-pointer ${\n                    isDragging \n                      ? \"border-red-500 bg-red-50 dark:bg-red-900/20\" \n                      : \"border-gray-300 dark:border-gray-600 hover:border-red-400\"\n                  }`}\n                  onClick={() => document.getElementById('file-input')?.click()}\n                  data-testid=\"dropzone-document-file\"\n                >\n                  <Upload className={`w-8 h-8 mx-auto mb-2 ${isDragging ? \"text-red-500\" : \"text-gray-400\"}`} />\n                  <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                    {isDragging ? \"Lepaskan file di sini...\" : \"Drag & drop file PDF atau klik untuk memilih\"}\n                  </p>\n                  <p className=\"text-xs text-gray-400 mt-1\">Bisa pilih banyak file</p>\n                  <input\n                    id=\"file-input\"\n                    type=\"file\"\n                    accept=\".pdf\"\n                    multiple\n                    className=\"hidden\"\n                    onChange={(e) => handleFilesSelected(e.target.files)}\n                    data-testid=\"input-document-file\"\n                  />\n                </div>\n              </div>\n            )}\n\n            {/* Progress Bar */}\n            {uploading && (\n              <div className=\"space-y-2\">\n                <div className=\"flex justify-between text-sm\">\n                  <span className=\"text-gray-600 dark:text-gray-400\">\n                    Mengupload file {currentUploadIndex} dari {uploadFiles.length}\n                  </span>\n                  <span className=\"font-medium\">{uploadProgress}%</span>\n                </div>\n                <Progress value={uploadProgress} className=\"h-2\" />\n                <p className=\"text-xs text-gray-500 text-center\">\n                  {uploadFiles[currentUploadIndex - 1]?.title || \"Memproses...\"}\n                </p>\n              </div>\n            )}\n\n            {/* File List */}\n            {uploadFiles.length > 0 && !uploading && (\n              <div className=\"space-y-2 pt-2 border-t border-gray-200 dark:border-gray-700\">\n                <Label>Daftar File ({uploadFiles.length})</Label>\n                <div className=\"max-h-48 overflow-y-auto space-y-2 pr-1\">\n                  {uploadFiles.map((item, index) => (\n                    <div key={index} className=\"flex items-start gap-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700\">\n                      <FileText className=\"w-5 h-5 text-red-500 flex-shrink-0 mt-1.5\" />\n                      <div className=\"flex-1 min-w-0 space-y-1\">\n                        <Input\n                          value={item.title}\n                          onChange={(e) => updateFileTitle(index, e.target.value)}\n                          className=\"h-8 text-sm\"\n                          placeholder=\"Judul dokumen\"\n                          data-testid={`input-file-title-${index}`}\n                        />\n                        <p className=\"text-xs text-gray-400 truncate\">\n                          {item.file.name} ({formatFileSize(item.file.size)})\n                        </p>\n                      </div>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        className=\"h-8 w-8 p-0 text-gray-400 hover:text-red-500 flex-shrink-0\"\n                        onClick={() => removeFile(index)}\n                        data-testid={`button-remove-file-${index}`}\n                      >\n                        <X className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n          \n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => setUploadDialogOpen(false)}\n              disabled={uploading}\n            >\n              Batal\n            </Button>\n            <Button \n              onClick={handleUpload}\n              disabled={uploading || uploadFiles.length === 0 || !uploadCategory}\n              className=\"bg-red-600 hover:bg-red-700\"\n              data-testid=\"button-submit-upload\"\n            >\n              {uploading ? \"Mengupload...\" : `Upload ${uploadFiles.length > 0 ? `(${uploadFiles.length})` : \"\"}`}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\n        <DialogContent className=\"max-w-sm\">\n          <DialogHeader>\n            <DialogTitle>Hapus Dokumen?</DialogTitle>\n            <DialogDescription>\n              Dokumen \"{documentToDelete?.title}\" akan dihapus permanen. Tindakan ini tidak dapat dibatalkan.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => setDeleteDialogOpen(false)}\n            >\n              Batal\n            </Button>\n            <Button \n              variant=\"destructive\"\n              onClick={() => documentToDelete && deleteMutation.mutate(documentToDelete.id)}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"Menghapus...\" : \"Hapus\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete All Confirmation Dialog */}\n      <Dialog open={deleteAllDialogOpen} onOpenChange={setDeleteAllDialogOpen}>\n        <DialogContent className=\"max-w-sm\">\n          <DialogHeader>\n            <DialogTitle>Hapus Semua Dokumen?</DialogTitle>\n            <DialogDescription>\n              Semua {categoryDocsCount} dokumen di kategori \"{selectedCategory}\" akan dihapus permanen. Tindakan ini tidak dapat dibatalkan.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => setDeleteAllDialogOpen(false)}\n            >\n              Batal\n            </Button>\n            <Button \n              variant=\"destructive\"\n              onClick={() => selectedCategory && deleteAllMutation.mutate(selectedCategory)}\n              disabled={deleteAllMutation.isPending}\n              data-testid=\"button-confirm-delete-all\"\n            >\n              {deleteAllMutation.isPending ? \"Menghapus...\" : `Hapus Semua (${categoryDocsCount})`}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":27794,"size_tokens":null},"client/src/hooks/use-sidak-draft.ts":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\n\ninterface UseSidakDraftOptions<T> {\n  key: string;\n  initialData: T;\n  debounceMs?: number;\n  onRestored?: (data: T) => void;\n}\n\ninterface UseSidakDraftReturn<T> {\n  hasDraft: boolean;\n  draftTimestamp: string | null;\n  saveDraft: (data: T) => void;\n  clearDraft: () => void;\n  restoreDraft: () => T | null;\n  ignoreDraft: () => void;\n  showRecoveryDialog: boolean;\n  setShowRecoveryDialog: (show: boolean) => void;\n  getSavedDraft: () => T | null;\n}\n\nexport function useSidakDraft<T>({\n  key,\n  initialData,\n  debounceMs = 1000\n}: UseSidakDraftOptions<T>): UseSidakDraftReturn<T> {\n  const storageKey = `sidak_draft_${key}`;\n  const timestampKey = `sidak_draft_timestamp_${key}`;\n  \n  const [hasDraft, setHasDraft] = useState(false);\n  const [draftTimestamp, setDraftTimestamp] = useState<string | null>(null);\n  const [showRecoveryDialog, setShowRecoveryDialog] = useState(false);\n  const saveTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n\n  useEffect(() => {\n    try {\n      const savedDraft = localStorage.getItem(storageKey);\n      const savedTimestamp = localStorage.getItem(timestampKey);\n      \n      if (savedDraft) {\n        setHasDraft(true);\n        setDraftTimestamp(savedTimestamp);\n        setShowRecoveryDialog(true);\n      }\n    } catch (error) {\n      console.error(\"Error checking draft:\", error);\n    }\n    \n    return () => {\n      if (saveTimeoutRef.current) {\n        clearTimeout(saveTimeoutRef.current);\n      }\n    };\n  }, [storageKey, timestampKey]);\n\n  const saveDraft = useCallback((data: T) => {\n    if (saveTimeoutRef.current) {\n      clearTimeout(saveTimeoutRef.current);\n    }\n    \n    saveTimeoutRef.current = setTimeout(() => {\n      try {\n        const hasData = JSON.stringify(data) !== JSON.stringify(initialData);\n        if (hasData) {\n          localStorage.setItem(storageKey, JSON.stringify(data));\n          localStorage.setItem(timestampKey, new Date().toISOString());\n          setHasDraft(true);\n        }\n      } catch (error) {\n        console.error(\"Error saving draft:\", error);\n      }\n    }, debounceMs);\n  }, [storageKey, timestampKey, debounceMs, initialData]);\n\n  const getSavedDraft = useCallback((): T | null => {\n    try {\n      const savedDraft = localStorage.getItem(storageKey);\n      if (savedDraft) {\n        return JSON.parse(savedDraft) as T;\n      }\n    } catch (error) {\n      console.error(\"Error getting draft:\", error);\n    }\n    return null;\n  }, [storageKey]);\n\n  const clearDraft = useCallback(() => {\n    try {\n      if (saveTimeoutRef.current) {\n        clearTimeout(saveTimeoutRef.current);\n      }\n      localStorage.removeItem(storageKey);\n      localStorage.removeItem(timestampKey);\n      setHasDraft(false);\n      setDraftTimestamp(null);\n    } catch (error) {\n      console.error(\"Error clearing draft:\", error);\n    }\n  }, [storageKey, timestampKey]);\n\n  const restoreDraft = useCallback((): T | null => {\n    try {\n      const savedDraft = localStorage.getItem(storageKey);\n      if (savedDraft) {\n        setShowRecoveryDialog(false);\n        return JSON.parse(savedDraft) as T;\n      }\n    } catch (error) {\n      console.error(\"Error restoring draft:\", error);\n    }\n    setShowRecoveryDialog(false);\n    return null;\n  }, [storageKey]);\n\n  const ignoreDraft = useCallback(() => {\n    clearDraft();\n    setShowRecoveryDialog(false);\n  }, [clearDraft]);\n\n  return {\n    hasDraft,\n    draftTimestamp,\n    saveDraft,\n    clearDraft,\n    restoreDraft,\n    ignoreDraft,\n    showRecoveryDialog,\n    setShowRecoveryDialog,\n    getSavedDraft\n  };\n}\n\nexport function formatDraftTimestamp(isoString: string | null): string {\n  if (!isoString) return \"\";\n  \n  try {\n    const date = new Date(isoString);\n    return date.toLocaleString('id-ID', {\n      day: '2-digit',\n      month: 'short',\n      year: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  } catch {\n    return \"\";\n  }\n}\n","path":null,"size_bytes":3949,"size_tokens":null},"client/public/sw.js":{"content":"const CACHE_NAME = 'onetalent-v1';\nconst urlsToCache = [\n  '/',\n  '/manifest.json'\n];\n\nself.addEventListener('install', (event) => {\n  event.waitUntil(\n    caches.open(CACHE_NAME)\n      .then((cache) => {\n        console.log('Opened cache');\n        return cache.addAll(urlsToCache);\n      })\n      .catch((err) => {\n        console.log('Cache install error:', err);\n      })\n  );\n  self.skipWaiting();\n});\n\nself.addEventListener('activate', (event) => {\n  event.waitUntil(\n    caches.keys().then((cacheNames) => {\n      return Promise.all(\n        cacheNames.map((cacheName) => {\n          if (cacheName !== CACHE_NAME) {\n            return caches.delete(cacheName);\n          }\n        })\n      );\n    })\n  );\n  self.clients.claim();\n});\n\nself.addEventListener('fetch', (event) => {\n  if (event.request.method !== 'GET') return;\n  \n  event.respondWith(\n    fetch(event.request)\n      .then((response) => {\n        if (!response || response.status !== 200 || response.type !== 'basic') {\n          return response;\n        }\n        const responseToCache = response.clone();\n        caches.open(CACHE_NAME)\n          .then((cache) => {\n            cache.put(event.request, responseToCache);\n          });\n        return response;\n      })\n      .catch(() => {\n        return caches.match(event.request);\n      })\n  );\n});\n\nself.addEventListener('push', (event) => {\n  console.log('Push event received:', event);\n  \n  let data = { title: 'OneTalent', body: 'Ada notifikasi baru', icon: '/icons/icon-192x192.png' };\n  \n  if (event.data) {\n    try {\n      data = event.data.json();\n    } catch (e) {\n      data.body = event.data.text();\n    }\n  }\n  \n  const options = {\n    body: data.body || 'Ada notifikasi baru',\n    icon: data.icon || '/icons/icon-192x192.png',\n    badge: '/icons/icon-72x72.png',\n    vibrate: [100, 50, 100],\n    data: {\n      dateOfArrival: Date.now(),\n      url: data.url || '/',\n      type: data.type || 'general'\n    },\n    actions: data.actions || [\n      { action: 'open', title: 'Buka' },\n      { action: 'close', title: 'Tutup' }\n    ],\n    tag: data.tag || 'onetalent-notification',\n    renotify: true\n  };\n  \n  event.waitUntil(\n    self.registration.showNotification(data.title || 'OneTalent', options)\n  );\n});\n\nself.addEventListener('notificationclick', (event) => {\n  console.log('Notification click:', event);\n  event.notification.close();\n  \n  const urlToOpen = event.notification.data?.url || '/';\n  \n  if (event.action === 'close') {\n    return;\n  }\n  \n  event.waitUntil(\n    clients.matchAll({ type: 'window', includeUncontrolled: true })\n      .then((clientList) => {\n        for (const client of clientList) {\n          if (client.url.includes(self.location.origin) && 'focus' in client) {\n            client.navigate(urlToOpen);\n            return client.focus();\n          }\n        }\n        if (clients.openWindow) {\n          return clients.openWindow(urlToOpen);\n        }\n      })\n  );\n});\n\nself.addEventListener('notificationclose', (event) => {\n  console.log('Notification closed:', event);\n});\n","path":null,"size_bytes":3044,"size_tokens":null},"client/src/components/sidak/draft-recovery-dialog.tsx":{"content":"import {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { FileText, RotateCcw, Trash2 } from \"lucide-react\";\nimport { formatDraftTimestamp } from \"@/hooks/use-sidak-draft\";\n\ninterface DraftRecoveryDialogProps {\n  open: boolean;\n  onRestore: () => void;\n  onDiscard: () => void;\n  timestamp: string | null;\n  formType: \"fatigue\" | \"roster\";\n}\n\nexport function DraftRecoveryDialog({\n  open,\n  onRestore,\n  onDiscard,\n  timestamp,\n  formType\n}: DraftRecoveryDialogProps) {\n  const formName = formType === \"fatigue\" ? \"SIDAK Fatigue\" : \"SIDAK Roster\";\n  \n  return (\n    <AlertDialog open={open}>\n      <AlertDialogContent className=\"max-w-md\">\n        <AlertDialogHeader>\n          <AlertDialogTitle className=\"flex items-center gap-2\">\n            <FileText className=\"h-5 w-5 text-blue-600\" />\n            Draft {formName} Ditemukan\n          </AlertDialogTitle>\n          <AlertDialogDescription className=\"text-left space-y-2\">\n            <p>\n              Ada draft {formName} yang belum selesai dari sesi sebelumnya.\n            </p>\n            {timestamp && (\n              <p className=\"text-sm bg-gray-100 dark:bg-gray-800 p-2 rounded\">\n                <strong>Terakhir disimpan:</strong> {formatDraftTimestamp(timestamp)}\n              </p>\n            )}\n            <p className=\"text-sm\">\n              Apakah Anda ingin melanjutkan draft tersebut atau memulai form baru?\n            </p>\n          </AlertDialogDescription>\n        </AlertDialogHeader>\n        <AlertDialogFooter className=\"flex-col sm:flex-row gap-2\">\n          <AlertDialogCancel \n            onClick={onDiscard}\n            className=\"flex items-center gap-2\"\n            data-testid=\"button-discard-draft\"\n          >\n            <Trash2 className=\"h-4 w-4\" />\n            Hapus & Mulai Baru\n          </AlertDialogCancel>\n          <AlertDialogAction \n            onClick={onRestore}\n            className=\"flex items-center gap-2 bg-blue-600 hover:bg-blue-700\"\n            data-testid=\"button-restore-draft\"\n          >\n            <RotateCcw className=\"h-4 w-4\" />\n            Lanjutkan Draft\n          </AlertDialogAction>\n        </AlertDialogFooter>\n      </AlertDialogContent>\n    </AlertDialog>\n  );\n}\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/pages/news.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogDescription } from \"@/components/ui/dialog\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \"@/components/ui/alert-dialog\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { format } from \"date-fns\";\nimport { id } from \"date-fns/locale\";\nimport { Newspaper, Plus, Pencil, Trash2, Eye, EyeOff, Bell, Clock, User, AlertTriangle, Loader2, Search, X, Image, ImagePlus } from \"lucide-react\";\n\ninterface News {\n  id: string;\n  title: string;\n  content: string;\n  imageUrl?: string | null;\n  imageUrls?: string[] | null;\n  isImportant: boolean;\n  createdBy: string;\n  createdByName: string;\n  isActive: boolean;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport default function NewsPage() {\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [editingNews, setEditingNews] = useState<News | null>(null);\n  const [deleteConfirmNews, setDeleteConfirmNews] = useState<News | null>(null);\n  \n  const [formData, setFormData] = useState({\n    title: \"\",\n    content: \"\",\n    imageUrls: [] as string[],\n    isImportant: false,\n    isActive: true,\n  });\n  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);\n  const [imagePreviews, setImagePreviews] = useState<string[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const { data: newsList = [], isLoading } = useQuery<News[]>({\n    queryKey: [\"/api/news\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      return apiRequest(\"/api/news\", \"POST\", {\n        ...data,\n        createdBy: user?.nik || \"\",\n        createdByName: user?.name || \"\",\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/news\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/news/active\"] });\n      setIsCreateDialogOpen(false);\n      resetForm();\n      toast({\n        title: \"Berhasil\",\n        description: \"Berita berhasil dibuat\" + (formData.isImportant ? \" dan notifikasi terkirim\" : \"\"),\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Gagal\",\n        description: error.message || \"Gagal membuat berita\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: { id: string; updates: Partial<typeof formData> }) => {\n      return apiRequest(`/api/news/${data.id}`, \"PATCH\", data.updates);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/news\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/news/active\"] });\n      setEditingNews(null);\n      resetForm();\n      toast({\n        title: \"Berhasil\",\n        description: \"Berita berhasil diperbarui\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Gagal\",\n        description: error.message || \"Gagal memperbarui berita\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(`/api/news/${id}`, \"DELETE\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/news\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/news/active\"] });\n      setDeleteConfirmNews(null);\n      toast({\n        title: \"Berhasil\",\n        description: \"Berita berhasil dihapus\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Gagal\",\n        description: error.message || \"Gagal menghapus berita\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      title: \"\",\n      content: \"\",\n      imageUrls: [],\n      isImportant: false,\n      isActive: true,\n    });\n    setSelectedFiles([]);\n    setImagePreviews([]);\n  };\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(e.target.files || []);\n    \n    for (const file of files) {\n      if (file.size > 5 * 1024 * 1024) {\n        toast({\n          title: \"File terlalu besar\",\n          description: `${file.name} melebihi 5MB`,\n          variant: \"destructive\",\n        });\n        continue;\n      }\n      \n      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];\n      if (!allowedTypes.includes(file.type)) {\n        toast({\n          title: \"Format tidak didukung\",\n          description: `${file.name} bukan format JPG, PNG, atau GIF`,\n          variant: \"destructive\",\n        });\n        continue;\n      }\n      \n      setSelectedFiles(prev => [...prev, file]);\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setImagePreviews(prev => [...prev, reader.result as string]);\n      };\n      reader.readAsDataURL(file);\n    }\n    \n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n  };\n\n  const uploadImages = async (): Promise<string[]> => {\n    if (selectedFiles.length === 0) return formData.imageUrls;\n    \n    setIsUploading(true);\n    const uploadedUrls: string[] = [...formData.imageUrls];\n    \n    try {\n      for (const file of selectedFiles) {\n        const formDataUpload = new FormData();\n        formDataUpload.append('image', file);\n        \n        const response = await fetch('/api/news/upload-image', {\n          method: 'POST',\n          body: formDataUpload,\n        });\n        \n        if (!response.ok) {\n          throw new Error(`Gagal mengupload ${file.name}`);\n        }\n        \n        const result = await response.json();\n        uploadedUrls.push(result.url);\n      }\n      \n      return uploadedUrls;\n    } catch (error) {\n      console.error('Upload error:', error);\n      toast({\n        title: \"Gagal mengupload gambar\",\n        description: \"Silakan coba lagi\",\n        variant: \"destructive\",\n      });\n      return formData.imageUrls;\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  const removeImage = (index: number) => {\n    const existingCount = formData.imageUrls.length;\n    \n    if (index < existingCount) {\n      setFormData({\n        ...formData,\n        imageUrls: formData.imageUrls.filter((_, i) => i !== index)\n      });\n      setImagePreviews(prev => prev.filter((_, i) => i !== index));\n    } else {\n      const newFileIndex = index - existingCount;\n      setSelectedFiles(prev => prev.filter((_, i) => i !== newFileIndex));\n      setImagePreviews(prev => prev.filter((_, i) => i !== index));\n    }\n  };\n\n  const getNewsImages = (news: News): string[] => {\n    if (news.imageUrls && news.imageUrls.length > 0) {\n      return news.imageUrls;\n    }\n    if (news.imageUrl) {\n      return [news.imageUrl];\n    }\n    return [];\n  };\n\n  const openEditDialog = (news: News) => {\n    const images = getNewsImages(news);\n    setFormData({\n      title: news.title,\n      content: news.content,\n      imageUrls: images,\n      isImportant: news.isImportant,\n      isActive: news.isActive,\n    });\n    setSelectedFiles([]);\n    setImagePreviews(images);\n    setEditingNews(news);\n  };\n\n  const handleSubmit = async () => {\n    if (!formData.title.trim() || !formData.content.trim()) {\n      toast({\n        title: \"Validasi Gagal\",\n        description: \"Judul dan konten harus diisi\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const uploadedUrls = await uploadImages();\n    const submitData = { ...formData, imageUrls: uploadedUrls };\n\n    if (editingNews) {\n      updateMutation.mutate({ id: editingNews.id, updates: submitData });\n    } else {\n      createMutation.mutate(submitData);\n    }\n  };\n\n  const filteredNews = newsList.filter(news => \n    news.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    news.content.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  const ImageUploadArea = () => (\n    <div className=\"space-y-2\">\n      <Label>Gambar (Opsional, bisa lebih dari 1)</Label>\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept=\"image/jpeg,image/jpg,image/png,image/gif\"\n        onChange={handleFileSelect}\n        multiple\n        className=\"hidden\"\n        data-testid=\"input-news-images\"\n      />\n      \n      {imagePreviews.length > 0 && (\n        <div className=\"grid grid-cols-3 gap-2 mb-2\">\n          {imagePreviews.map((preview, idx) => (\n            <div key={idx} className=\"relative\">\n              <img\n                src={preview}\n                alt={`Preview ${idx + 1}`}\n                className=\"w-full h-24 object-cover rounded-lg border\"\n              />\n              <Button\n                type=\"button\"\n                variant=\"destructive\"\n                size=\"sm\"\n                className=\"absolute -top-2 -right-2 h-6 w-6 p-0 rounded-full\"\n                onClick={() => removeImage(idx)}\n              >\n                <X className=\"h-3 w-3\" />\n              </Button>\n            </div>\n          ))}\n        </div>\n      )}\n      \n      <div\n        onClick={() => fileInputRef.current?.click()}\n        className=\"border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center cursor-pointer hover:border-blue-500 transition-colors\"\n      >\n        <ImagePlus className=\"h-8 w-8 mx-auto text-gray-400 mb-2\" />\n        <p className=\"text-sm text-gray-500\">Klik untuk tambah gambar</p>\n        <p className=\"text-xs text-gray-400 mt-1\">JPG, PNG, GIF (Maks. 5MB per file)</p>\n      </div>\n    </div>\n  );\n\n  return (\n    <div className=\"p-4 md:p-6 space-y-6\">\n      <Card className=\"shadow-lg border-0 bg-gradient-to-r from-blue-600 to-indigo-600 text-white\">\n        <CardHeader>\n          <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"p-3 bg-white/20 rounded-xl\">\n                <Newspaper className=\"h-8 w-8\" />\n              </div>\n              <div>\n                <CardTitle className=\"text-2xl font-bold\">Manajemen Berita</CardTitle>\n                <CardDescription className=\"text-blue-100\">\n                  Kelola berita dan informasi perusahaan\n                </CardDescription>\n              </div>\n            </div>\n            <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n              <DialogTrigger asChild>\n                <Button \n                  className=\"bg-white text-blue-600 hover:bg-blue-50\"\n                  onClick={() => {\n                    resetForm();\n                    setIsCreateDialogOpen(true);\n                  }}\n                  data-testid=\"button-create-news\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Buat Berita Baru\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-hidden\">\n                <DialogHeader>\n                  <DialogTitle className=\"flex items-center gap-2\">\n                    <Newspaper className=\"h-5 w-5 text-blue-600\" />\n                    Buat Berita Baru\n                  </DialogTitle>\n                  <DialogDescription>\n                    Berita penting akan otomatis mengirim push notification ke semua pengguna yang berlangganan.\n                  </DialogDescription>\n                </DialogHeader>\n                <ScrollArea className=\"max-h-[60vh] pr-4\">\n                  <div className=\"space-y-4 py-4\">\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"title\">Judul Berita</Label>\n                      <Input\n                        id=\"title\"\n                        value={formData.title}\n                        onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                        placeholder=\"Masukkan judul berita\"\n                        data-testid=\"input-news-title\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"content\">Konten</Label>\n                      <Textarea\n                        id=\"content\"\n                        value={formData.content}\n                        onChange={(e) => setFormData({ ...formData, content: e.target.value })}\n                        placeholder=\"Tulis konten berita...\"\n                        rows={6}\n                        data-testid=\"input-news-content\"\n                      />\n                    </div>\n                    <ImageUploadArea />\n                    <div className=\"flex items-center justify-between p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-700\">\n                      <div className=\"flex items-center gap-3\">\n                        <Bell className=\"h-5 w-5 text-amber-600\" />\n                        <div>\n                          <p className=\"font-medium text-amber-800 dark:text-amber-200\">Berita Penting</p>\n                          <p className=\"text-xs text-amber-600 dark:text-amber-400\">\n                            Aktifkan untuk mengirim push notification ke semua pengguna\n                          </p>\n                        </div>\n                      </div>\n                      <Switch\n                        checked={formData.isImportant}\n                        onCheckedChange={(checked) => setFormData({ ...formData, isImportant: checked })}\n                        data-testid=\"switch-news-important\"\n                      />\n                    </div>\n                    <div className=\"flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-lg\">\n                      <div className=\"flex items-center gap-3\">\n                        <Eye className=\"h-5 w-5 text-gray-600\" />\n                        <div>\n                          <p className=\"font-medium\">Status Publikasi</p>\n                          <p className=\"text-xs text-gray-500\">\n                            {formData.isActive ? \"Berita akan terlihat oleh pengguna\" : \"Berita tidak ditampilkan\"}\n                          </p>\n                        </div>\n                      </div>\n                      <Switch\n                        checked={formData.isActive}\n                        onCheckedChange={(checked) => setFormData({ ...formData, isActive: checked })}\n                        data-testid=\"switch-news-active\"\n                      />\n                    </div>\n                  </div>\n                </ScrollArea>\n                <div className=\"flex justify-end gap-2 pt-4 border-t\">\n                  <Button variant=\"outline\" onClick={() => setIsCreateDialogOpen(false)}>\n                    Batal\n                  </Button>\n                  <Button \n                    onClick={handleSubmit} \n                    disabled={createMutation.isPending || isUploading}\n                    data-testid=\"button-submit-news\"\n                  >\n                    {(createMutation.isPending || isUploading) && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                    {isUploading ? \"Mengupload...\" : \"Publikasikan\"}\n                  </Button>\n                </div>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </CardHeader>\n      </Card>\n\n      <Card>\n        <CardHeader className=\"pb-4\">\n          <div className=\"flex flex-col md:flex-row md:items-center gap-4\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400\" />\n              <Input\n                placeholder=\"Cari berita...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search-news\"\n              />\n            </div>\n            <Badge variant=\"secondary\" className=\"self-start md:self-auto\">\n              {filteredNews.length} berita\n            </Badge>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-12\">\n              <Loader2 className=\"h-8 w-8 animate-spin mx-auto text-blue-500\" />\n              <p className=\"text-gray-500 mt-2\">Memuat berita...</p>\n            </div>\n          ) : filteredNews.length > 0 ? (\n            <div className=\"space-y-4\">\n              {filteredNews.map((news) => {\n                const images = getNewsImages(news);\n                return (\n                  <div\n                    key={news.id}\n                    className={`p-4 rounded-lg border transition-all ${\n                      news.isActive \n                        ? \"bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700\" \n                        : \"bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 opacity-60\"\n                    }`}\n                    data-testid={`news-item-${news.id}`}\n                  >\n                    <div className=\"flex flex-col md:flex-row md:items-start gap-4\">\n                      {images.length > 0 && (\n                        <div className=\"flex gap-1 flex-shrink-0\">\n                          {images.slice(0, 3).map((img, idx) => (\n                            <img\n                              key={idx}\n                              src={img}\n                              alt=\"\"\n                              className=\"w-12 h-12 rounded object-cover\"\n                            />\n                          ))}\n                          {images.length > 3 && (\n                            <div className=\"w-12 h-12 rounded bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs font-medium\">\n                              +{images.length - 3}\n                            </div>\n                          )}\n                        </div>\n                      )}\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <h3 className=\"font-semibold text-lg text-gray-900 dark:text-white\">\n                            {news.title}\n                          </h3>\n                          {news.isImportant && (\n                            <Badge className=\"bg-amber-500 text-white\">\n                              <AlertTriangle className=\"h-3 w-3 mr-1\" />\n                              Penting\n                            </Badge>\n                          )}\n                          {!news.isActive && (\n                            <Badge variant=\"secondary\">\n                              <EyeOff className=\"h-3 w-3 mr-1\" />\n                              Draft\n                            </Badge>\n                          )}\n                        </div>\n                        <p className=\"text-gray-600 dark:text-gray-300 mt-2 line-clamp-2\">\n                          {news.content}\n                        </p>\n                        <div className=\"flex items-center gap-4 mt-3 text-sm text-gray-500 dark:text-gray-400\">\n                          <span className=\"flex items-center gap-1\">\n                            <User className=\"h-4 w-4\" />\n                            {news.createdByName}\n                          </span>\n                          <span className=\"flex items-center gap-1\">\n                            <Clock className=\"h-4 w-4\" />\n                            {format(new Date(news.createdAt), \"dd MMM yyyy HH:mm\", { locale: id })}\n                          </span>\n                          {images.length > 0 && (\n                            <span className=\"flex items-center gap-1\">\n                              <Image className=\"h-4 w-4\" />\n                              {images.length} foto\n                            </span>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2 flex-shrink-0\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => openEditDialog(news)}\n                          data-testid={`button-edit-news-${news.id}`}\n                        >\n                          <Pencil className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          className=\"text-red-600 hover:bg-red-50 hover:text-red-700\"\n                          onClick={() => setDeleteConfirmNews(news)}\n                          data-testid={`button-delete-news-${news.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          ) : (\n            <div className=\"text-center py-12\">\n              <Newspaper className=\"h-12 w-12 text-gray-300 mx-auto mb-4\" />\n              <p className=\"text-gray-500\">Belum ada berita</p>\n              <p className=\"text-sm text-gray-400 mt-1\">\n                Klik \"Buat Berita Baru\" untuk menambahkan berita pertama\n              </p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Edit Dialog */}\n      <Dialog open={!!editingNews} onOpenChange={(open) => !open && setEditingNews(null)}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-hidden\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Pencil className=\"h-5 w-5 text-blue-600\" />\n              Edit Berita\n            </DialogTitle>\n            <DialogDescription>\n              Perubahan akan langsung tersimpan.\n            </DialogDescription>\n          </DialogHeader>\n          <ScrollArea className=\"max-h-[60vh] pr-4\">\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-title\">Judul Berita</Label>\n                <Input\n                  id=\"edit-title\"\n                  value={formData.title}\n                  onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                  placeholder=\"Masukkan judul berita\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-content\">Konten</Label>\n                <Textarea\n                  id=\"edit-content\"\n                  value={formData.content}\n                  onChange={(e) => setFormData({ ...formData, content: e.target.value })}\n                  placeholder=\"Tulis konten berita...\"\n                  rows={6}\n                />\n              </div>\n              <ImageUploadArea />\n              <div className=\"flex items-center justify-between p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-700\">\n                <div className=\"flex items-center gap-3\">\n                  <Bell className=\"h-5 w-5 text-amber-600\" />\n                  <div>\n                    <p className=\"font-medium text-amber-800 dark:text-amber-200\">Berita Penting</p>\n                    <p className=\"text-xs text-amber-600 dark:text-amber-400\">\n                      Tandai sebagai berita penting\n                    </p>\n                  </div>\n                </div>\n                <Switch\n                  checked={formData.isImportant}\n                  onCheckedChange={(checked) => setFormData({ ...formData, isImportant: checked })}\n                />\n              </div>\n              <div className=\"flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-lg\">\n                <div className=\"flex items-center gap-3\">\n                  <Eye className=\"h-5 w-5 text-gray-600\" />\n                  <div>\n                    <p className=\"font-medium\">Status Publikasi</p>\n                    <p className=\"text-xs text-gray-500\">\n                      {formData.isActive ? \"Berita akan terlihat oleh pengguna\" : \"Berita tidak ditampilkan\"}\n                    </p>\n                  </div>\n                </div>\n                <Switch\n                  checked={formData.isActive}\n                  onCheckedChange={(checked) => setFormData({ ...formData, isActive: checked })}\n                />\n              </div>\n            </div>\n          </ScrollArea>\n          <div className=\"flex justify-end gap-2 pt-4 border-t\">\n            <Button variant=\"outline\" onClick={() => setEditingNews(null)}>\n              Batal\n            </Button>\n            <Button \n              onClick={handleSubmit} \n              disabled={updateMutation.isPending || isUploading}\n            >\n              {(updateMutation.isPending || isUploading) && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              {isUploading ? \"Mengupload...\" : \"Simpan Perubahan\"}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog open={!!deleteConfirmNews} onOpenChange={(open) => !open && setDeleteConfirmNews(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Hapus Berita?</AlertDialogTitle>\n            <AlertDialogDescription>\n              Anda yakin ingin menghapus berita \"{deleteConfirmNews?.title}\"? \n              Tindakan ini tidak dapat dibatalkan.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Batal</AlertDialogCancel>\n            <AlertDialogAction\n              className=\"bg-red-600 hover:bg-red-700\"\n              onClick={() => deleteConfirmNews && deleteMutation.mutate(deleteConfirmNews.id)}\n            >\n              {deleteMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Hapus\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":26877,"size_tokens":null},"client/src/components/NotificationPrompt.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Bell, BellOff, X } from \"lucide-react\";\nimport { usePushNotification } from \"@/hooks/use-push-notification\";\n\nconst NOTIFICATION_PROMPT_KEY = \"notification_prompt_shown\";\n\nexport function NotificationPrompt() {\n  const [isOpen, setIsOpen] = useState(false);\n  const { \n    isSupported, \n    permission, \n    isSubscribed, \n    isLoading, \n    subscribe \n  } = usePushNotification();\n\n  useEffect(() => {\n    if (!isSupported) return;\n    \n    const hasShownPrompt = localStorage.getItem(NOTIFICATION_PROMPT_KEY);\n    \n    if (!hasShownPrompt && permission === \"default\" && !isSubscribed) {\n      const timer = setTimeout(() => {\n        setIsOpen(true);\n      }, 2000);\n      return () => clearTimeout(timer);\n    }\n  }, [isSupported, permission, isSubscribed]);\n\n  const handleEnableNotifications = async () => {\n    localStorage.setItem(NOTIFICATION_PROMPT_KEY, \"true\");\n    await subscribe();\n    setIsOpen(false);\n  };\n\n  const handleDismiss = () => {\n    localStorage.setItem(NOTIFICATION_PROMPT_KEY, \"true\");\n    setIsOpen(false);\n  };\n\n  if (!isSupported || permission === \"denied\") {\n    return null;\n  }\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <div className=\"flex items-center justify-center mb-4\">\n            <div className=\"w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center\">\n              <Bell className=\"h-8 w-8 text-white\" />\n            </div>\n          </div>\n          <DialogTitle className=\"text-center text-xl\">\n            Aktifkan Notifikasi\n          </DialogTitle>\n          <DialogDescription className=\"text-center\">\n            Dapatkan pemberitahuan langsung untuk berita penting, pengingat shift, dan update status cuti Anda.\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"space-y-4 mt-4\">\n          <div className=\"flex flex-col gap-3\">\n            <div className=\"flex items-start gap-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg\">\n              <Bell className=\"h-5 w-5 text-blue-600 mt-0.5\" />\n              <div>\n                <p className=\"font-medium text-sm text-blue-800 dark:text-blue-200\">Berita Penting</p>\n                <p className=\"text-xs text-blue-600 dark:text-blue-400\">Informasi penting dari perusahaan</p>\n              </div>\n            </div>\n            <div className=\"flex items-start gap-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg\">\n              <Bell className=\"h-5 w-5 text-green-600 mt-0.5\" />\n              <div>\n                <p className=\"font-medium text-sm text-green-800 dark:text-green-200\">Pengingat Shift</p>\n                <p className=\"text-xs text-green-600 dark:text-green-400\">Notifikasi jadwal kerja Anda</p>\n              </div>\n            </div>\n            <div className=\"flex items-start gap-3 p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg\">\n              <Bell className=\"h-5 w-5 text-purple-600 mt-0.5\" />\n              <div>\n                <p className=\"font-medium text-sm text-purple-800 dark:text-purple-200\">Status Cuti</p>\n                <p className=\"text-xs text-purple-600 dark:text-purple-400\">Update persetujuan cuti Anda</p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"flex flex-col gap-2 pt-2\">\n            <Button \n              onClick={handleEnableNotifications} \n              disabled={isLoading}\n              className=\"w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700\"\n              data-testid=\"button-enable-notifications\"\n            >\n              {isLoading ? (\n                \"Mengaktifkan...\"\n              ) : (\n                <>\n                  <Bell className=\"h-4 w-4 mr-2\" />\n                  Aktifkan Notifikasi\n                </>\n              )}\n            </Button>\n            <Button \n              variant=\"ghost\" \n              onClick={handleDismiss}\n              className=\"w-full text-gray-500\"\n              data-testid=\"button-dismiss-notifications\"\n            >\n              <BellOff className=\"h-4 w-4 mr-2\" />\n              Nanti Saja\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":4495,"size_tokens":null},"client/src/hooks/use-push-notification.ts":{"content":"import { useState, useEffect, useCallback } from 'react';\n\ninterface PushSubscriptionState {\n  isSupported: boolean;\n  isSubscribed: boolean;\n  isLoading: boolean;\n  permission: NotificationPermission | 'unsupported';\n  error: string | null;\n}\n\nexport function usePushNotification(employeeId?: string) {\n  const [state, setState] = useState<PushSubscriptionState>({\n    isSupported: false,\n    isSubscribed: false,\n    isLoading: true,\n    permission: 'unsupported',\n    error: null,\n  });\n\n  const checkSubscription = useCallback(async () => {\n    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {\n      setState(prev => ({\n        ...prev,\n        isSupported: false,\n        isLoading: false,\n        permission: 'unsupported',\n      }));\n      return;\n    }\n\n    try {\n      const registration = await navigator.serviceWorker.ready;\n      const subscription = await registration.pushManager.getSubscription();\n      \n      setState(prev => ({\n        ...prev,\n        isSupported: true,\n        isSubscribed: !!subscription,\n        isLoading: false,\n        permission: Notification.permission,\n      }));\n    } catch (error) {\n      console.error('Error checking push subscription:', error);\n      setState(prev => ({\n        ...prev,\n        isSupported: true,\n        isLoading: false,\n        error: 'Gagal memeriksa status notifikasi',\n      }));\n    }\n  }, []);\n\n  useEffect(() => {\n    checkSubscription();\n  }, [checkSubscription]);\n\n  const subscribe = useCallback(async () => {\n    if (!employeeId) {\n      setState(prev => ({ ...prev, error: 'Employee ID diperlukan' }));\n      return false;\n    }\n\n    setState(prev => ({ ...prev, isLoading: true, error: null }));\n\n    try {\n      const permission = await Notification.requestPermission();\n      if (permission !== 'granted') {\n        setState(prev => ({\n          ...prev,\n          isLoading: false,\n          permission,\n          error: 'Izin notifikasi ditolak',\n        }));\n        return false;\n      }\n\n      const vapidResponse = await fetch('/api/push/vapid-public-key');\n      if (!vapidResponse.ok) {\n        throw new Error('Gagal mengambil VAPID key');\n      }\n      const { publicKey } = await vapidResponse.json();\n\n      const registration = await navigator.serviceWorker.ready;\n      \n      const subscription = await registration.pushManager.subscribe({\n        userVisibleOnly: true,\n        applicationServerKey: urlBase64ToUint8Array(publicKey) as BufferSource,\n      });\n\n      const subscribeResponse = await fetch('/api/push/subscribe', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          employeeId,\n          subscription: {\n            endpoint: subscription.endpoint,\n            keys: {\n              p256dh: arrayBufferToBase64(subscription.getKey('p256dh')!),\n              auth: arrayBufferToBase64(subscription.getKey('auth')!),\n            },\n          },\n        }),\n      });\n\n      if (!subscribeResponse.ok) {\n        throw new Error('Gagal menyimpan subscription');\n      }\n\n      setState(prev => ({\n        ...prev,\n        isSubscribed: true,\n        isLoading: false,\n        permission: 'granted',\n      }));\n      return true;\n    } catch (error) {\n      console.error('Error subscribing to push:', error);\n      setState(prev => ({\n        ...prev,\n        isLoading: false,\n        error: error instanceof Error ? error.message : 'Gagal subscribe notifikasi',\n      }));\n      return false;\n    }\n  }, [employeeId]);\n\n  const unsubscribe = useCallback(async () => {\n    setState(prev => ({ ...prev, isLoading: true, error: null }));\n\n    try {\n      const registration = await navigator.serviceWorker.ready;\n      const subscription = await registration.pushManager.getSubscription();\n\n      if (subscription) {\n        await fetch('/api/push/unsubscribe', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ endpoint: subscription.endpoint }),\n        });\n\n        await subscription.unsubscribe();\n      }\n\n      setState(prev => ({\n        ...prev,\n        isSubscribed: false,\n        isLoading: false,\n      }));\n      return true;\n    } catch (error) {\n      console.error('Error unsubscribing from push:', error);\n      setState(prev => ({\n        ...prev,\n        isLoading: false,\n        error: 'Gagal unsubscribe notifikasi',\n      }));\n      return false;\n    }\n  }, []);\n\n  return {\n    ...state,\n    subscribe,\n    unsubscribe,\n    refresh: checkSubscription,\n  };\n}\n\nfunction urlBase64ToUint8Array(base64String: string): Uint8Array {\n  const padding = '='.repeat((4 - (base64String.length % 4)) % 4);\n  const base64 = (base64String + padding)\n    .replace(/-/g, '+')\n    .replace(/_/g, '/');\n\n  const rawData = window.atob(base64);\n  const outputArray = new Uint8Array(rawData.length);\n\n  for (let i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i);\n  }\n  return outputArray;\n}\n\nfunction arrayBufferToBase64(buffer: ArrayBuffer): string {\n  const bytes = new Uint8Array(buffer);\n  let binary = '';\n  for (let i = 0; i < bytes.byteLength; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return window.btoa(binary);\n}\n","path":null,"size_bytes":5244,"size_tokens":null},"client/src/pages/news-feed.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format, differenceInHours } from \"date-fns\";\nimport { id } from \"date-fns/locale\";\nimport { Newspaper, Clock, User, AlertTriangle, Loader2, Megaphone, ChevronRight, X, ImageIcon } from \"lucide-react\";\n\ninterface News {\n  id: string;\n  title: string;\n  content: string;\n  imageUrl?: string | null;\n  imageUrls?: string[] | null;\n  isImportant: boolean;\n  createdBy: string;\n  createdByName: string;\n  isActive: boolean;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport default function NewsFeed() {\n  const { toast } = useToast();\n  const [selectedNews, setSelectedNews] = useState<News | null>(null);\n  const [lastNewsCount, setLastNewsCount] = useState<number>(0);\n  const isFirstLoad = useRef(true);\n\n  const { data: newsList = [], isLoading } = useQuery<News[]>({\n    queryKey: [\"/api/news/active\"],\n    refetchInterval: 30000, // Poll every 30 seconds for new news\n  });\n\n  // Check for new news and show toast\n  useEffect(() => {\n    if (isFirstLoad.current) {\n      setLastNewsCount(newsList.length);\n      isFirstLoad.current = false;\n    } else if (newsList.length > lastNewsCount) {\n      const newCount = newsList.length - lastNewsCount;\n      const latestNews = newsList[0];\n      toast({\n        title: `${newCount} Berita Baru`,\n        description: latestNews.title,\n        duration: 5000,\n      });\n      setLastNewsCount(newsList.length);\n    } else if (newsList.length !== lastNewsCount) {\n      // Sync count when list decreases (deleted/inactivated news)\n      setLastNewsCount(newsList.length);\n    }\n  }, [newsList.length, lastNewsCount, toast, newsList]);\n\n  const isNew = (createdAt: string) => {\n    return differenceInHours(new Date(), new Date(createdAt)) <= 24;\n  };\n\n  const getImages = (news: News): string[] => {\n    if (news.imageUrls && news.imageUrls.length > 0) {\n      return news.imageUrls;\n    }\n    if (news.imageUrl) {\n      return [news.imageUrl];\n    }\n    return [];\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n      <div className=\"max-w-4xl mx-auto p-4 md:p-6 space-y-6\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <div className=\"p-3 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl shadow-lg\">\n            <Newspaper className=\"h-6 w-6 text-white\" />\n          </div>\n          <div>\n            <h1 className=\"text-2xl font-bold text-gray-900 dark:text-white\">Berita Perusahaan</h1>\n            <p className=\"text-sm text-gray-500 dark:text-gray-400\">Informasi terbaru dari PT. GECL</p>\n          </div>\n        </div>\n\n        {isLoading ? (\n          <div className=\"flex flex-col items-center justify-center py-16\">\n            <Loader2 className=\"h-10 w-10 animate-spin text-blue-500 mb-4\" />\n            <p className=\"text-gray-500\">Memuat berita...</p>\n          </div>\n        ) : newsList.length > 0 ? (\n          <Card className=\"overflow-hidden\">\n            <CardContent className=\"p-0\">\n              <div className=\"divide-y divide-gray-100 dark:divide-gray-700\">\n                {newsList.map((news) => {\n                  const images = getImages(news);\n                  return (\n                    <div\n                      key={news.id}\n                      onClick={() => setSelectedNews(news)}\n                      className={`flex items-center gap-3 p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors ${\n                        news.isImportant ? \"bg-amber-50/50 dark:bg-amber-900/10\" : \"\"\n                      }`}\n                      data-testid={`news-item-${news.id}`}\n                    >\n                      {/* Thumbnail or icon */}\n                      <div className=\"flex-shrink-0\">\n                        {images.length > 0 ? (\n                          <div className=\"relative\">\n                            <img\n                              src={images[0]}\n                              alt=\"\"\n                              className=\"w-14 h-14 rounded-lg object-cover\"\n                            />\n                            {images.length > 1 && (\n                              <div className=\"absolute -bottom-1 -right-1 bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center\">\n                                +{images.length - 1}\n                              </div>\n                            )}\n                          </div>\n                        ) : (\n                          <div className=\"w-14 h-14 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center\">\n                            <Newspaper className=\"h-6 w-6 text-gray-400\" />\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Content */}\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2 mb-1\">\n                          {news.isImportant && (\n                            <Badge className=\"bg-amber-500 text-white text-xs px-1.5 py-0\">\n                              <AlertTriangle className=\"h-3 w-3 mr-0.5\" />\n                              Penting\n                            </Badge>\n                          )}\n                          {isNew(news.createdAt) && (\n                            <Badge className=\"bg-green-500 text-white text-xs px-1.5 py-0\">\n                              BARU\n                            </Badge>\n                          )}\n                        </div>\n                        <h3 className=\"font-semibold text-gray-900 dark:text-white truncate\">\n                          {news.title}\n                        </h3>\n                        <div className=\"flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400 mt-1\">\n                          <span className=\"flex items-center gap-1\">\n                            <User className=\"h-3 w-3\" />\n                            {news.createdByName}\n                          </span>\n                          <span className=\"flex items-center gap-1\">\n                            <Clock className=\"h-3 w-3\" />\n                            {format(new Date(news.createdAt), \"dd MMM yyyy HH:mm\", { locale: id })}\n                          </span>\n                        </div>\n                      </div>\n\n                      {/* Arrow */}\n                      <ChevronRight className=\"h-5 w-5 text-gray-400 flex-shrink-0\" />\n                    </div>\n                  );\n                })}\n              </div>\n            </CardContent>\n          </Card>\n        ) : (\n          <Card className=\"border-dashed\">\n            <CardContent className=\"flex flex-col items-center justify-center py-16\">\n              <div className=\"w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4\">\n                <Megaphone className=\"h-8 w-8 text-gray-400\" />\n              </div>\n              <h3 className=\"text-lg font-medium text-gray-900 dark:text-white mb-1\">\n                Belum Ada Berita\n              </h3>\n              <p className=\"text-sm text-gray-500 dark:text-gray-400 text-center max-w-sm\">\n                Belum ada berita yang dipublikasikan. Berita terbaru akan muncul di sini.\n              </p>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {/* News Detail Dialog */}\n      <Dialog open={!!selectedNews} onOpenChange={(open) => !open && setSelectedNews(null)}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-hidden p-0\">\n          <ScrollArea className=\"max-h-[90vh]\">\n            {selectedNews && (\n              <>\n                {/* Images Gallery */}\n                {getImages(selectedNews).length > 0 && (\n                  <div className=\"relative\">\n                    {getImages(selectedNews).length === 1 ? (\n                      <img\n                        src={getImages(selectedNews)[0]}\n                        alt={selectedNews.title}\n                        className=\"w-full h-64 object-cover\"\n                      />\n                    ) : (\n                      <div className=\"grid grid-cols-2 gap-1\">\n                        {getImages(selectedNews).slice(0, 4).map((img, idx) => (\n                          <div key={idx} className=\"relative\">\n                            <img\n                              src={img}\n                              alt={`${selectedNews.title} ${idx + 1}`}\n                              className=\"w-full h-32 object-cover\"\n                            />\n                            {idx === 3 && getImages(selectedNews).length > 4 && (\n                              <div className=\"absolute inset-0 bg-black/50 flex items-center justify-center\">\n                                <span className=\"text-white text-lg font-bold\">\n                                  +{getImages(selectedNews).length - 4}\n                                </span>\n                              </div>\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                )}\n\n                <div className=\"p-6\">\n                  <DialogHeader className=\"mb-4\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      {selectedNews.isImportant && (\n                        <Badge className=\"bg-amber-500 text-white\">\n                          <AlertTriangle className=\"h-3 w-3 mr-1\" />\n                          Penting\n                        </Badge>\n                      )}\n                      {isNew(selectedNews.createdAt) && (\n                        <Badge className=\"bg-green-500 text-white\">\n                          BARU\n                        </Badge>\n                      )}\n                    </div>\n                    <DialogTitle className=\"text-xl font-bold\">\n                      {selectedNews.title}\n                    </DialogTitle>\n                  </DialogHeader>\n\n                  <div className=\"flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400 mb-4 pb-4 border-b\">\n                    <span className=\"flex items-center gap-1\">\n                      <User className=\"h-4 w-4\" />\n                      {selectedNews.createdByName}\n                    </span>\n                    <span className=\"flex items-center gap-1\">\n                      <Clock className=\"h-4 w-4\" />\n                      {format(new Date(selectedNews.createdAt), \"EEEE, dd MMMM yyyy 'pukul' HH:mm\", { locale: id })}\n                    </span>\n                  </div>\n\n                  <div className=\"prose prose-sm dark:prose-invert max-w-none\">\n                    <p className=\"text-gray-700 dark:text-gray-300 whitespace-pre-wrap leading-relaxed\">\n                      {selectedNews.content}\n                    </p>\n                  </div>\n                </div>\n              </>\n            )}\n          </ScrollArea>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":11408,"size_tokens":null},"client/src/components/WorkspaceHome.tsx":{"content":"import { useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Permission } from \"@shared/rbac\";\nimport { Loader2 } from \"lucide-react\";\n\nexport function WorkspaceHome() {\n  const { hasAnyPermission } = useAuth();\n  const [, setLocation] = useLocation();\n  \n  const canViewDashboard = hasAnyPermission([Permission.VIEW_DASHBOARD]);\n  \n  useEffect(() => {\n    if (canViewDashboard) {\n      setLocation(\"/workspace/dashboard\");\n    } else {\n      setLocation(\"/workspace/news-feed\");\n    }\n  }, [canViewDashboard, setLocation]);\n  \n  return (\n    <div className=\"flex items-center justify-center min-h-[50vh]\">\n      <Loader2 className=\"h-8 w-8 animate-spin text-blue-500\" />\n    </div>\n  );\n}\n","path":null,"size_bytes":757,"size_tokens":null}},"version":2}